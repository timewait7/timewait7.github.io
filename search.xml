<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>ç”µå•†åå°ç³»ç»Ÿè®¾è®¡ä¸æŠ€æœ¯æ ˆå®è·µ</title>
      <link href="/post/31cf01ae.html"/>
      <url>/post/31cf01ae.html</url>
      
        <content type="html"><![CDATA[<p>æˆ‘ä»¬è®¾è®¡ä¸€ä¸ªå¤šæ¨¡å—çš„å¾®æœåŠ¡é¡¹ç›®ï¼Œé¡¹ç›®åç§°æš‚å®šä¸ºâ€œDeepBackendPracticeâ€ï¼Œè¯¥é¡¹ç›®å°†æ¶µç›–ç”¨æˆ·ç®¡ç†ã€å•†å“ç®¡ç†ã€è®¢å•ç®¡ç†ã€æœç´¢æœåŠ¡ã€æ¶ˆæ¯é€šçŸ¥ç­‰ä¸šåŠ¡æ¨¡å—ï¼Œå¹¶ä½¿ç”¨ä¸Šè¿°æŠ€æœ¯ç‚¹ã€‚<br>ç”±äºæŠ€æœ¯ç‚¹ä¼—å¤šï¼Œæˆ‘ä»¬å°†åˆ†æ¨¡å—ã€åˆ†æœåŠ¡è¿›è¡Œå®è·µã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªå¤§è‡´çš„ç³»ç»Ÿè®¾è®¡ï¼š</p><ol><li><p>æœåŠ¡åˆ’åˆ†ï¼š</p><ul><li>ç”¨æˆ·æœåŠ¡ï¼ˆUserServiceï¼‰ï¼šå¤„ç†ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€èº«ä»½è®¤è¯ã€æƒé™ç®¡ç†ã€‚</li><li>å•†å“æœåŠ¡ï¼ˆProductServiceï¼‰ï¼šç®¡ç†å•†å“ä¿¡æ¯ã€‚</li><li>è®¢å•æœåŠ¡ï¼ˆOrderServiceï¼‰ï¼šå¤„ç†è®¢å•åˆ›å»ºã€æ”¯ä»˜ã€åº“å­˜æ‰£å‡ç­‰ã€‚</li><li>æœç´¢æœåŠ¡ï¼ˆSearchServiceï¼‰ï¼šåŸºäºESçš„å•†å“æœç´¢ã€‚</li><li>æ¶ˆæ¯æœåŠ¡ï¼ˆMessageServiceï¼‰ï¼šåŸºäºæ¶ˆæ¯é˜Ÿåˆ—çš„æ¶ˆæ¯é€šçŸ¥ï¼Œæ”¯æŒWebSocketæ¨é€ã€‚</li><li>ç½‘å…³æœåŠ¡ï¼ˆGatewayServiceï¼‰ï¼šä½¿ç”¨Spring Cloud Gatewayä½œä¸ºAPIç½‘å…³ã€‚</li><li>æ³¨å†Œä¸­å¿ƒï¼ˆRegistryServiceï¼‰ï¼šä½¿ç”¨Nacosä½œä¸ºæœåŠ¡æ³¨å†Œä¸å‘ç°ä¸­å¿ƒã€‚</li><li>é…ç½®ä¸­å¿ƒï¼ˆConfigServiceï¼‰ï¼šä½¿ç”¨Nacosä½œä¸ºé…ç½®ä¸­å¿ƒã€‚</li><li>ç¼“å­˜å’Œåˆ†å¸ƒå¼é”ï¼šä½¿ç”¨Redisã€‚</li><li>æœåŠ¡ç›‘æ§å’Œè¿ç»´ï¼šä½¿ç”¨Dockerã€K8Séƒ¨ç½²ï¼ŒCI&#x2F;CDæµç¨‹ã€‚</li></ul></li><li><p>æŠ€æœ¯æ ˆï¼š</p><ul><li>å¼€å‘æ¡†æ¶ï¼šSpring Bootã€Spring Cloud Alibaba</li><li>èº«ä»½è®¤è¯ï¼šJWTã€Spring Securityã€OAuth2.0ï¼ˆå¯é€‰ï¼‰</li><li>æ•°æ®åº“ï¼šMySQLï¼ˆä¸»ä»å¤åˆ¶ã€åˆ†åº“åˆ†è¡¨å¯é€‰ï¼‰</li><li>ç¼“å­˜ï¼šRedisï¼ˆç¼“å­˜ã€åˆ†å¸ƒå¼é”ã€åˆ†å¸ƒå¼ä¼šè¯ï¼‰</li><li>æ¶ˆæ¯é˜Ÿåˆ—ï¼šRabbitMQæˆ–Kafka</li><li>æœç´¢ï¼šElasticsearch</li><li>æœåŠ¡è°ƒç”¨ï¼šDubboï¼ˆå¯é€‰ï¼‰ã€Feignï¼ˆé»˜è®¤ï¼‰</li><li>ç½‘å…³ï¼šSpring Cloud Gateway</li><li>æœåŠ¡æ³¨å†Œä¸å‘ç°ï¼šNacos</li><li>é…ç½®ä¸­å¿ƒï¼šNacos</li><li>å®¹å™¨åŒ–ï¼šDocker</li><li>ç¼–æ’ï¼šKubernetes</li><li>CI&#x2F;CDï¼šJenkinsæˆ–GitLab CI</li></ul></li><li><p>é¡¹ç›®ç»“æ„ï¼š</p><ul><li>çˆ¶å·¥ç¨‹ï¼šDeepBackendPracticeï¼ˆç®¡ç†ä¾èµ–ç‰ˆæœ¬ï¼‰</li><li>å­æ¨¡å—ï¼š<ul><li>commonï¼šå…¬å…±æ¨¡å—ï¼ˆå·¥å…·ç±»ã€é€šç”¨é…ç½®ï¼‰</li><li>user-service</li><li>product-service</li><li>order-service</li><li>search-service</li><li>message-service</li><li>gateway-service</li><li>registry-serviceï¼ˆé€šå¸¸Nacosç‹¬ç«‹éƒ¨ç½²ï¼Œè¿™é‡Œå¯ä»¥æ˜¯ä¸€ä¸ªç®€å•çš„Spring BootæœåŠ¡ç”¨äºå¯åŠ¨Nacosï¼Œæˆ–è€…ç›´æ¥ä½¿ç”¨å®˜æ–¹Dockeré•œåƒï¼‰</li><li>config-serviceï¼ˆåŒä¸Šï¼ŒNacoså·²ç»åŒ…å«é…ç½®ä¸­å¿ƒåŠŸèƒ½ï¼‰</li></ul></li></ul></li><li><p>è¯¦ç»†åŠŸèƒ½è®¾è®¡ï¼š</p><p>a. ç”¨æˆ·æœåŠ¡ï¼š<br>- ç”¨æˆ·æ³¨å†Œï¼ˆå¯†ç åŠ å¯†å­˜å‚¨ï¼‰<br>- ç”¨æˆ·ç™»å½•ï¼ˆç”ŸæˆJWTä»¤ç‰Œï¼‰<br>- ç”¨æˆ·ä¿¡æ¯ç®¡ç†ï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰<br>- æƒé™ç®¡ç†ï¼ˆè§’è‰²ã€æƒé™ï¼‰<br>- ä½¿ç”¨Rediså­˜å‚¨ç”¨æˆ·ä¼šè¯ï¼ˆåˆ†å¸ƒå¼ä¼šè¯ï¼‰<br>- ä½¿ç”¨Rediså®ç°åˆ†å¸ƒå¼é”ï¼ˆä¾‹å¦‚åœ¨ç”¨æˆ·æ³¨å†Œæ—¶é˜²æ­¢é‡å¤ç”¨æˆ·åï¼‰</p><p>b. å•†å“æœåŠ¡ï¼š<br>- å•†å“CRUD<br>- å•†å“åº“å­˜ç®¡ç†ï¼ˆä½¿ç”¨Redisç¼“å­˜åº“å­˜ï¼Œé˜²æ­¢è¶…å–ï¼‰<br>- å•†å“å›¾ç‰‡ä¸Šä¼ ï¼ˆä½¿ç”¨IOæµï¼Œæ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼‰</p><p>c. è®¢å•æœåŠ¡ï¼š<br>- åˆ›å»ºè®¢å•ï¼ˆè°ƒç”¨å•†å“æœåŠ¡æ‰£å‡åº“å­˜ï¼Œä½¿ç”¨åˆ†å¸ƒå¼äº‹åŠ¡Seataæˆ–æ¶ˆæ¯é˜Ÿåˆ—ä¿è¯æœ€ç»ˆä¸€è‡´æ€§ï¼‰<br>- è®¢å•æ”¯ä»˜ï¼ˆæ¨¡æ‹Ÿæ”¯ä»˜æµç¨‹ï¼‰<br>- è®¢å•æŸ¥è¯¢<br>- ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å‘é€è®¢å•åˆ›å»ºé€šçŸ¥</p><p>d. æœç´¢æœåŠ¡ï¼š<br>- å•†å“ä¿¡æ¯åŒæ­¥åˆ°ESï¼ˆä½¿ç”¨Logstashæˆ–ç¨‹åºåŒæ­¥ï¼‰<br>- å•†å“æœç´¢ï¼ˆESæŸ¥è¯¢ï¼‰</p><p>e. æ¶ˆæ¯æœåŠ¡ï¼š<br>- å‘é€æ¶ˆæ¯ï¼ˆç«™å†…ä¿¡ã€é‚®ä»¶ã€çŸ­ä¿¡æ¨¡æ‹Ÿï¼‰<br>- WebSocketæ¨é€æ¶ˆæ¯ï¼ˆå‰ç«¯å¯ä»¥å»ºç«‹WebSocketè¿æ¥æ¥æ”¶å®æ—¶æ¶ˆæ¯ï¼‰</p><p>f. ç½‘å…³æœåŠ¡ï¼š<br>- è·¯ç”±è½¬å‘<br>- é‰´æƒï¼ˆæ ¡éªŒJWTï¼‰<br>- é™æµ</p><p>g. æ³¨å†Œä¸­å¿ƒå’Œé…ç½®ä¸­å¿ƒï¼š<br>- ä½¿ç”¨Nacosï¼Œæ‰€æœ‰æœåŠ¡æ³¨å†Œåˆ°Nacosï¼Œå¹¶ä»Nacosè·å–é…ç½®ã€‚</p></li><li><p>æ•°æ®åº“è®¾è®¡ï¼ˆMySQLï¼‰ï¼š</p><ul><li>ç”¨æˆ·è¡¨ï¼ˆuserï¼‰</li><li>å•†å“è¡¨ï¼ˆproductï¼‰</li><li>è®¢å•è¡¨ï¼ˆorderï¼‰</li><li>è®¢å•è¯¦æƒ…è¡¨ï¼ˆorder_detailï¼‰</li><li>ç­‰ç­‰</li></ul></li><li><p>ç¼“å­˜è®¾è®¡ï¼ˆRedisï¼‰ï¼š</p><ul><li>ç”¨æˆ·ä¼šè¯ç¼“å­˜ï¼ˆkey: token, value: ç”¨æˆ·ä¿¡æ¯ï¼‰</li><li>å•†å“åº“å­˜ç¼“å­˜ï¼ˆkey: product_stock_{productId}, value: åº“å­˜æ•°é‡ï¼‰</li><li>åˆ†å¸ƒå¼é”ï¼ˆkey: lock_{ä¸šåŠ¡æ ‡è¯†}, value: éšæœºå€¼ï¼‰</li></ul></li><li><p>æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆRabbitMQ&#x2F;Kafkaï¼‰ï¼š</p><ul><li>è®¢å•åˆ›å»ºæ¶ˆæ¯ï¼ˆè®¢å•æœåŠ¡ç”Ÿäº§ï¼Œæ¶ˆæ¯æœåŠ¡æ¶ˆè´¹ï¼‰</li><li>å•†å“æ›´æ–°æ¶ˆæ¯ï¼ˆå•†å“æœåŠ¡ç”Ÿäº§ï¼Œæœç´¢æœåŠ¡æ¶ˆè´¹ï¼ŒåŒæ­¥åˆ°ESï¼‰</li></ul></li><li><p>æœç´¢ï¼ˆESï¼‰ï¼š</p><ul><li>å•†å“ç´¢å¼•ï¼ˆproduct_indexï¼‰</li></ul></li><li><p>æ–‡ä»¶ä¸Šä¼ ä¸‹è½½ï¼š</p><ul><li>ä½¿ç”¨MinIOæˆ–FastDFSè¿›è¡Œæ–‡ä»¶å­˜å‚¨ï¼Œæˆ–è€…ç›´æ¥ä½¿ç”¨æœ¬åœ°å­˜å‚¨ï¼ˆä¸ºäº†ç®€åŒ–ï¼Œå¯ä»¥å…ˆä½¿ç”¨æœ¬åœ°å­˜å‚¨ï¼Œä½†è¦æ³¨æ„åˆ†å¸ƒå¼éƒ¨ç½²æ—¶çš„æ–‡ä»¶å…±äº«é—®é¢˜ï¼‰</li></ul></li><li><p>ç½‘ç»œç¼–ç¨‹å’ŒWebSocketï¼š</p><ul><li>åœ¨æ¶ˆæ¯æœåŠ¡ä¸­å®ç°WebSocketï¼Œç”¨äºå®æ—¶æ¶ˆæ¯æ¨é€ã€‚</li></ul></li><li><p>æœåŠ¡è¿ç»´ï¼š</p><ul><li>æ¯ä¸ªæœåŠ¡éƒ½ç¼–å†™Dockerfileï¼Œä½¿ç”¨Dockeræ„å»ºé•œåƒã€‚</li><li>ä½¿ç”¨Kubernetesè¿›è¡ŒæœåŠ¡ç¼–æ’ï¼Œç¼–å†™Deploymentå’ŒServiceé…ç½®æ–‡ä»¶ã€‚</li><li>ä½¿ç”¨Jenkinsç¼–å†™CI&#x2F;CDæµæ°´çº¿ï¼Œå®ç°è‡ªåŠ¨åŒ–æ„å»ºã€æµ‹è¯•ã€éƒ¨ç½²ã€‚</li></ul></li></ol><p>ç”±äºè¿™æ˜¯ä¸€ä¸ªåºå¤§çš„é¡¹ç›®ï¼Œæˆ‘ä»¬å°†åˆ†æ­¥éª¤å®ç°ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬æ­å»ºçˆ¶å·¥ç¨‹å’Œå…¬å…±æ¨¡å—ï¼Œç„¶åé€ä¸ªå®ç°æœåŠ¡ã€‚</p><p>æ³¨æ„ï¼šç”±äºç¯‡å¹…é™åˆ¶ï¼Œè¿™é‡Œæ— æ³•ç»™å‡ºæ‰€æœ‰ä»£ç ï¼Œä½†æˆ‘ä¼šç»™å‡ºæ¯ä¸ªæ¨¡å—çš„å…³é”®ä»£ç å’Œé…ç½®ã€‚</p><p>ä¸‹é¢ï¼Œæˆ‘ä»¬ä»çˆ¶å·¥ç¨‹å¼€å§‹ï¼Œé€æ­¥æ„å»ºæ•´ä¸ªé¡¹ç›®ã€‚</p><p>æ­¥éª¤1ï¼šåˆ›å»ºçˆ¶å·¥ç¨‹ï¼ˆDeepBackendPracticeï¼‰<br>æ­¥éª¤2ï¼šåˆ›å»ºå…¬å…±æ¨¡å—ï¼ˆcommonï¼‰<br>æ­¥éª¤3ï¼šåˆ›å»ºç”¨æˆ·æœåŠ¡ï¼ˆuser-serviceï¼‰<br>æ­¥éª¤4ï¼šåˆ›å»ºå•†å“æœåŠ¡ï¼ˆproduct-serviceï¼‰<br>æ­¥éª¤5ï¼šåˆ›å»ºè®¢å•æœåŠ¡ï¼ˆorder-serviceï¼‰<br>æ­¥éª¤6ï¼šåˆ›å»ºæœç´¢æœåŠ¡ï¼ˆsearch-serviceï¼‰<br>æ­¥éª¤7ï¼šåˆ›å»ºæ¶ˆæ¯æœåŠ¡ï¼ˆmessage-serviceï¼‰<br>æ­¥éª¤8ï¼šåˆ›å»ºç½‘å…³æœåŠ¡ï¼ˆgateway-serviceï¼‰<br>æ­¥éª¤9ï¼šéƒ¨ç½²Nacosï¼ˆå¯ä»¥ä½¿ç”¨Docker-composeæˆ–K8Séƒ¨ç½²ï¼Œä¹Ÿå¯ä»¥å•ç‹¬è¿è¡Œï¼‰<br>æ­¥éª¤10ï¼šé…ç½®æ¯ä¸ªæœåŠ¡è¿æ¥Nacosï¼Œå¹¶å®ç°æœåŠ¡æ³¨å†Œä¸å‘ç°ã€‚<br>æ­¥éª¤11ï¼šå®ç°æœåŠ¡é—´çš„è°ƒç”¨ï¼ˆä½¿ç”¨Feignæˆ–Dubboï¼‰ã€‚<br>æ­¥éª¤12ï¼šå®ç°ç½‘å…³è·¯ç”±å’Œé‰´æƒã€‚<br>æ­¥éª¤13ï¼šå®ç°æ–‡ä»¶ä¸Šä¼ ä¸‹è½½ï¼ˆæ–­ç‚¹ç»­ä¼ ï¼‰ã€‚<br>æ­¥éª¤14ï¼šå®ç°WebSocketã€‚<br>æ­¥éª¤15ï¼šç¼–å†™Dockerfileï¼Œæ„å»ºé•œåƒã€‚<br>æ­¥éª¤16ï¼šç¼–å†™K8Sé…ç½®æ–‡ä»¶ï¼Œéƒ¨ç½²æœåŠ¡ã€‚<br>æ­¥éª¤17ï¼šç¼–å†™Jenkinsfileï¼Œå®ç°CI&#x2F;CDã€‚</p><p>ç”±äºè¿™ä¸ªé¡¹ç›®éå¸¸åºå¤§ï¼Œæˆ‘ä»¬åªèƒ½é€æ­¥å®ç°ã€‚è¿™é‡Œæˆ‘å…ˆç»™å‡ºçˆ¶å·¥ç¨‹çš„pom.xmlå’Œé¡¹ç›®ç»“æ„ï¼Œç„¶åé€æ­¥ç»™å‡ºæ¯ä¸ªæ¨¡å—çš„ä»£ç ã€‚</p><p>ç”±äºç¯‡å¹…é™åˆ¶ï¼Œæˆ‘å°†å…ˆç»™å‡ºçˆ¶å·¥ç¨‹å’Œå…¬å…±æ¨¡å—çš„ç¤ºä¾‹ï¼Œç„¶åç»™å‡ºç”¨æˆ·æœåŠ¡çš„å…³é”®ä»£ç ï¼ˆåŒ…æ‹¬èº«ä»½è®¤è¯ã€åˆ†å¸ƒå¼ä¼šè¯ã€åˆ†å¸ƒå¼é”ç­‰ï¼‰ã€‚</p><p>æ³¨æ„ï¼šä»¥ä¸‹ä»£ç ä»…ä¸ºç¤ºä¾‹ï¼Œå®é™…å¼€å‘ä¸­éœ€è¦æ ¹æ®ä¸šåŠ¡è°ƒæ•´ã€‚</p><p>çˆ¶å·¥ç¨‹pom.xml:</p><p>æˆ‘ä¸ºä½ è®¾è®¡ä¸€ä¸ª<strong>ç»¼åˆæ€§ç”µå•†åå°ç®¡ç†ç³»ç»Ÿ</strong>ï¼Œèåˆä½ æåˆ°çš„æ‰€æœ‰æŠ€æœ¯æ ˆã€‚è¿™ä¸ªç³»ç»Ÿå°†æ¶µç›–å•†å“ç®¡ç†ã€è®¢å•å¤„ç†ã€ç”¨æˆ·è®¤è¯ã€å®æ—¶é€šä¿¡ç­‰å¤šä¸ªæ¨¡å—ã€‚</p><h2 id="ğŸ—ï¸-ç³»ç»Ÿæ¶æ„è®¾è®¡"><a href="#ğŸ—ï¸-ç³»ç»Ÿæ¶æ„è®¾è®¡" class="headerlink" title="ğŸ—ï¸ ç³»ç»Ÿæ¶æ„è®¾è®¡"></a>ğŸ—ï¸ ç³»ç»Ÿæ¶æ„è®¾è®¡</h2><h3 id="ç³»ç»Ÿåç§°ï¼šShopHub-å…¨æ ˆç”µå•†å¹³å°"><a href="#ç³»ç»Ÿåç§°ï¼šShopHub-å…¨æ ˆç”µå•†å¹³å°" class="headerlink" title="ç³»ç»Ÿåç§°ï¼šShopHub å…¨æ ˆç”µå•†å¹³å°"></a>ç³»ç»Ÿåç§°ï¼š<strong>ShopHub å…¨æ ˆç”µå•†å¹³å°</strong></h3><h3 id="æŠ€æœ¯æ¶æ„å›¾"><a href="#æŠ€æœ¯æ¶æ„å›¾" class="headerlink" title="æŠ€æœ¯æ¶æ„å›¾"></a>æŠ€æœ¯æ¶æ„å›¾</h3><p>text</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ç”¨æˆ·è¯·æ±‚ â†’ Nginx(è´Ÿè½½å‡è¡¡/é™æ€èµ„æº) â†’ Spring Cloud Gateway(è·¯ç”±/é™æµ)</span><br><span class="line">       â†“</span><br><span class="line">    Nacos(æœåŠ¡æ³¨å†Œä¸­å¿ƒ)</span><br><span class="line">       â†“</span><br><span class="line">  [å¾®æœåŠ¡é›†ç¾¤] â†â†’ Redis(ç¼“å­˜/ä¼šè¯) â†â†’ Elasticsearch(æœç´¢)</span><br><span class="line">       â†“</span><br><span class="line">  Dubbo(RPCè°ƒç”¨) â†â†’ MySQL(ä¸»ä»é›†ç¾¤)</span><br><span class="line">       â†“</span><br><span class="line">RabbitMQ/Kafka(å¼‚æ­¥å¤„ç†) â†â†’ WebSocket(å®æ—¶é€šçŸ¥)</span><br><span class="line">       â†“</span><br><span class="line">    Docker + K8Séƒ¨ç½²</span><br></pre></td></tr></table></figure><h2 id="ğŸ“-é¡¹ç›®æ¨¡å—åˆ’åˆ†"><a href="#ğŸ“-é¡¹ç›®æ¨¡å—åˆ’åˆ†" class="headerlink" title="ğŸ“ é¡¹ç›®æ¨¡å—åˆ’åˆ†"></a>ğŸ“ é¡¹ç›®æ¨¡å—åˆ’åˆ†</h2><h3 id="1-çˆ¶å·¥ç¨‹-shophub-parent"><a href="#1-çˆ¶å·¥ç¨‹-shophub-parent" class="headerlink" title="1. çˆ¶å·¥ç¨‹ (shophub-parent)"></a>1. çˆ¶å·¥ç¨‹ (<code>shophub-parent</code>)</h3><ul><li>Mavenå¤šæ¨¡å—ç®¡ç†</li><li>ç»Ÿä¸€ä¾èµ–ç‰ˆæœ¬æ§åˆ¶</li></ul><h3 id="2-é€šç”¨æ¨¡å—-shophub-common"><a href="#2-é€šç”¨æ¨¡å—-shophub-common" class="headerlink" title="2. é€šç”¨æ¨¡å— (shophub-common)"></a>2. é€šç”¨æ¨¡å— (<code>shophub-common</code>)</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// åŒ…å«ï¼šå·¥å…·ç±»ã€é€šç”¨DTOã€å¼‚å¸¸å¤„ç†ã€å¸¸é‡å®šä¹‰</span><br><span class="line">â”œâ”€â”€ common-core         // æ ¸å¿ƒå·¥å…·</span><br><span class="line">â”œâ”€â”€ common-redis       // Redisé…ç½®å’Œå·¥å…·</span><br><span class="line">â”œâ”€â”€ common-database    // æ•°æ®åº“é…ç½®</span><br><span class="line">â”œâ”€â”€ common-web         // Webé€šç”¨ç»„ä»¶</span><br><span class="line">â”œâ”€â”€ common-security    // å®‰å…¨å·¥å…·</span><br><span class="line">â””â”€â”€ common-mq          // æ¶ˆæ¯é˜Ÿåˆ—å·¥å…·</span><br></pre></td></tr></table></figure><h3 id="3-è®¤è¯æˆæƒä¸­å¿ƒ-shophub-auth"><a href="#3-è®¤è¯æˆæƒä¸­å¿ƒ-shophub-auth" class="headerlink" title="3. è®¤è¯æˆæƒä¸­å¿ƒ (shophub-auth)"></a>3. è®¤è¯æˆæƒä¸­å¿ƒ (<code>shophub-auth</code>)</h3><p><strong>æŠ€æœ¯ç‚¹ï¼šJWTã€OAuth2.0ã€RBACã€åˆ†å¸ƒå¼ä¼šè¯</strong></p><p>sql</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">-- ç”¨æˆ·è¡¨</span><br><span class="line">CREATE TABLE `sys_user` (</span><br><span class="line">  `id` bigint(20) NOT NULL COMMENT &#x27;åˆ†å¸ƒå¼ID&#x27;,</span><br><span class="line">  `username` varchar(50) NOT NULL,</span><br><span class="line">  `password` varchar(200) NOT NULL,</span><br><span class="line">  `email` varchar(100),</span><br><span class="line">  `phone` varchar(20),</span><br><span class="line">  `status` tinyint(1) DEFAULT 1,</span><br><span class="line">  `create_time` datetime DEFAULT CURRENT_TIMESTAMP,</span><br><span class="line">  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_username` (`username`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span><br><span class="line"></span><br><span class="line">-- è§’è‰²æƒé™è¡¨ï¼ˆå¤šå¯¹å¤šå…³ç³»ï¼‰</span><br><span class="line">CREATE TABLE `sys_role` (...);</span><br><span class="line">CREATE TABLE `sys_permission` (...);</span><br><span class="line">CREATE TABLE `sys_user_role` (...);</span><br><span class="line">CREATE TABLE `sys_role_permission` (...);</span><br></pre></td></tr></table></figure><h3 id="4-å•†å“æœåŠ¡-shophub-product"><a href="#4-å•†å“æœåŠ¡-shophub-product" class="headerlink" title="4. å•†å“æœåŠ¡ (shophub-product)"></a>4. å•†å“æœåŠ¡ (<code>shophub-product</code>)</h3><p><strong>æŠ€æœ¯ç‚¹ï¼šMySQLã€Redisç¼“å­˜ã€ESæœç´¢ã€æ–‡ä»¶ä¸Šä¼ </strong></p><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Service</span><br><span class="line">public class ProductServiceImpl implements ProductService &#123;</span><br><span class="line">    </span><br><span class="line">    // 1. ç¼“å­˜ç©¿é€è§£å†³æ–¹æ¡ˆï¼šå¸ƒéš†è¿‡æ»¤å™¨ + ç©ºå€¼ç¼“å­˜</span><br><span class="line">    // 2. ç¼“å­˜å‡»ç©¿è§£å†³æ–¹æ¡ˆï¼šåˆ†å¸ƒå¼é”</span><br><span class="line">    // 3. ç¼“å­˜é›ªå´©è§£å†³æ–¹æ¡ˆï¼šéšæœºè¿‡æœŸæ—¶é—´</span><br><span class="line">    // 4. ESå•†å“æœç´¢</span><br><span class="line">    // 5. å›¾ç‰‡ä¸Šä¼ ï¼ˆåˆ†ç‰‡ä¸Šä¼ ã€æ–­ç‚¹ç»­ä¼ ï¼‰</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-è®¢å•æœåŠ¡-shophub-order"><a href="#5-è®¢å•æœåŠ¡-shophub-order" class="headerlink" title="5. è®¢å•æœåŠ¡ (shophub-order)"></a>5. è®¢å•æœåŠ¡ (<code>shophub-order</code>)</h3><p><strong>æŠ€æœ¯ç‚¹ï¼šåˆ†å¸ƒå¼äº‹åŠ¡ã€åˆ†å¸ƒå¼é”ã€æ¶ˆæ¯é˜Ÿåˆ—</strong></p><p>sql</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">-- è®¢å•è¡¨ï¼ˆåˆ†åº“åˆ†è¡¨ç¤ºä¾‹ï¼‰</span><br><span class="line">CREATE TABLE `order_0` (</span><br><span class="line">  `order_id` varchar(32) NOT NULL COMMENT &#x27;é›ªèŠ±ç®—æ³•ID&#x27;,</span><br><span class="line">  `user_id` bigint(20) NOT NULL,</span><br><span class="line">  `total_amount` decimal(10,2) NOT NULL,</span><br><span class="line">  `status` tinyint(4) NOT NULL COMMENT &#x27;0-å¾…æ”¯ä»˜,1-å·²æ”¯ä»˜,2-å·²å–æ¶ˆ&#x27;,</span><br><span class="line">  `create_time` datetime NOT NULL,</span><br><span class="line">  PRIMARY KEY (`order_id`),</span><br><span class="line">  KEY `idx_user_id` (`user_id`),</span><br><span class="line">  KEY `idx_create_time` (`create_time`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4</span><br><span class="line">PARTITION BY RANGE (YEAR(create_time)) (</span><br><span class="line">    PARTITION p2023 VALUES LESS THAN (2024),</span><br><span class="line">    PARTITION p2024 VALUES LESS THAN (2025)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><h3 id="6-åº“å­˜æœåŠ¡-shophub-inventory"><a href="#6-åº“å­˜æœåŠ¡-shophub-inventory" class="headerlink" title="6. åº“å­˜æœåŠ¡ (shophub-inventory)"></a>6. åº“å­˜æœåŠ¡ (<code>shophub-inventory</code>)</h3><p><strong>æŠ€æœ¯ç‚¹ï¼šé«˜å¹¶å‘ã€åˆ†å¸ƒå¼é”ã€RedisåŸå­æ“ä½œ</strong></p><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@Transactional</span><br><span class="line">public boolean reduceStock(Long productId, Integer quantity) &#123;</span><br><span class="line">    // Redisåˆ†å¸ƒå¼é”ï¼šRedisson</span><br><span class="line">    RLock lock = redissonClient.getLock(&quot;stock_lock:&quot; + productId);</span><br><span class="line">    try &#123;</span><br><span class="line">        lock.lock(10, TimeUnit.SECONDS);</span><br><span class="line">        // Luaè„šæœ¬ä¿è¯åŸå­æ€§</span><br><span class="line">        String script = &quot;if redis.call(&#x27;get&#x27;, KEYS[1]) &gt;= ARGV[1] then &quot; +</span><br><span class="line">                       &quot;return redis.call(&#x27;decrby&#x27;, KEYS[1], ARGV[1]) &quot; +</span><br><span class="line">                       &quot;else return -1 end&quot;;</span><br><span class="line">        Long result = redisTemplate.execute(</span><br><span class="line">            new DefaultRedisScript&lt;&gt;(script, Long.class),</span><br><span class="line">            Collections.singletonList(&quot;stock:&quot; + productId),</span><br><span class="line">            quantity.toString()</span><br><span class="line">        );</span><br><span class="line">        return result != null &amp;&amp; result &gt;= 0;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="7-æ”¯ä»˜æœåŠ¡-shophub-payment"><a href="#7-æ”¯ä»˜æœåŠ¡-shophub-payment" class="headerlink" title="7. æ”¯ä»˜æœåŠ¡ (shophub-payment)"></a>7. æ”¯ä»˜æœåŠ¡ (<code>shophub-payment</code>)</h3><p><strong>æŠ€æœ¯ç‚¹ï¼šç½‘ç»œç¼–ç¨‹ã€WebSocketã€çŠ¶æ€æœº</strong></p><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@ServerEndpoint(&quot;/ws/payment/&#123;orderId&#125;&quot;)</span><br><span class="line">@Component</span><br><span class="line">public class PaymentWebSocket &#123;</span><br><span class="line">    // WebSocketå®æ—¶æ”¯ä»˜çŠ¶æ€æ¨é€</span><br><span class="line">    // ç¬¬ä¸‰æ–¹æ”¯ä»˜æ¥å£è°ƒç”¨ï¼ˆæ¨¡æ‹Ÿï¼‰</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="8-æœç´¢æœåŠ¡-shophub-search"><a href="#8-æœç´¢æœåŠ¡-shophub-search" class="headerlink" title="8. æœç´¢æœåŠ¡ (shophub-search)"></a>8. æœç´¢æœåŠ¡ (<code>shophub-search</code>)</h3><p><strong>æŠ€æœ¯ç‚¹ï¼šElasticsearchã€IKåˆ†è¯ã€èšåˆæŸ¥è¯¢</strong></p><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Repository</span><br><span class="line">public interface ProductSearchRepository extends ElasticsearchRepository&lt;ProductDocument, Long&gt; &#123;</span><br><span class="line">    // å¤æ‚æŸ¥è¯¢ï¼šå¤šæ¡ä»¶ç­›é€‰ã€æ’åºã€åˆ†é¡µã€é«˜äº®</span><br><span class="line">    // èšåˆåˆ†æï¼šé”€é‡ç»Ÿè®¡ã€ä»·æ ¼åˆ†å¸ƒ</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="9-é€šçŸ¥æœåŠ¡-shophub-notification"><a href="#9-é€šçŸ¥æœåŠ¡-shophub-notification" class="headerlink" title="9. é€šçŸ¥æœåŠ¡ (shophub-notification)"></a>9. é€šçŸ¥æœåŠ¡ (<code>shophub-notification</code>)</h3><p><strong>æŠ€æœ¯ç‚¹ï¼šæ¶ˆæ¯é˜Ÿåˆ—ã€é‚®ä»¶&#x2F;SMSå‘é€ã€WebSocketæ¨é€</strong></p><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">@RabbitListener(queues = &quot;order.queue&quot;)</span><br><span class="line">public class OrderMessageConsumer &#123;</span><br><span class="line">    // è®¢å•çŠ¶æ€å˜æ›´é€šçŸ¥</span><br><span class="line">    // ä½¿ç”¨æ­»ä¿¡é˜Ÿåˆ—å¤„ç†å¤±è´¥æ¶ˆæ¯</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="10-ç½‘å…³æœåŠ¡-shophub-gateway"><a href="#10-ç½‘å…³æœåŠ¡-shophub-gateway" class="headerlink" title="10. ç½‘å…³æœåŠ¡ (shophub-gateway)"></a>10. ç½‘å…³æœåŠ¡ (<code>shophub-gateway</code>)</h3><p><strong>æŠ€æœ¯ç‚¹ï¼šSpring Cloud Gatewayã€é™æµã€ç†”æ–­ã€é‰´æƒ</strong></p><p>yaml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">        - id: auth-service</span><br><span class="line">          uri: lb://auth-service</span><br><span class="line">          predicates:</span><br><span class="line">            - Path=/api/auth/**</span><br><span class="line">          filters:</span><br><span class="line">            - StripPrefix=1</span><br><span class="line">            - name: RequestRateLimiter</span><br><span class="line">              args:</span><br><span class="line">                redis-rate-limiter.replenishRate: 10</span><br><span class="line">                redis-rate-limiter.burstCapacity: 20</span><br></pre></td></tr></table></figure><h2 id="ğŸš€-å®è·µåœºæ™¯è®¾è®¡"><a href="#ğŸš€-å®è·µåœºæ™¯è®¾è®¡" class="headerlink" title="ğŸš€ å®è·µåœºæ™¯è®¾è®¡"></a>ğŸš€ å®è·µåœºæ™¯è®¾è®¡</h2><h3 id="åœºæ™¯1ï¼šç§’æ€ç³»ç»Ÿï¼ˆç»¼åˆåº”ç”¨ï¼‰"><a href="#åœºæ™¯1ï¼šç§’æ€ç³»ç»Ÿï¼ˆç»¼åˆåº”ç”¨ï¼‰" class="headerlink" title="åœºæ™¯1ï¼šç§’æ€ç³»ç»Ÿï¼ˆç»¼åˆåº”ç”¨ï¼‰"></a>åœºæ™¯1ï¼šç§’æ€ç³»ç»Ÿï¼ˆç»¼åˆåº”ç”¨ï¼‰</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// æŠ€æœ¯ç‚¹æ•´åˆï¼š</span><br><span class="line">// 1. Nginxè´Ÿè½½å‡è¡¡ + é™æµ</span><br><span class="line">// 2. ç½‘å…³å±‚é™æµ</span><br><span class="line">// 3. Redisé¢„å‡åº“å­˜ + åˆ†å¸ƒå¼é”</span><br><span class="line">// 4. æ¶ˆæ¯é˜Ÿåˆ—å‰Šå³°å¡«è°·</span><br><span class="line">// 5. æ•°æ®åº“æœ€ç»ˆä¸€è‡´æ€§</span><br><span class="line">// 6. WebSocketå®æ—¶é€šçŸ¥ç»“æœ</span><br></pre></td></tr></table></figure><h3 id="åœºæ™¯2ï¼šå®æ—¶èŠå¤©å®¢æœ"><a href="#åœºæ™¯2ï¼šå®æ—¶èŠå¤©å®¢æœ" class="headerlink" title="åœºæ™¯2ï¼šå®æ—¶èŠå¤©å®¢æœ"></a>åœºæ™¯2ï¼šå®æ—¶èŠå¤©å®¢æœ</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// æŠ€æœ¯ç‚¹æ•´åˆï¼š</span><br><span class="line">// 1. WebSocketé•¿è¿æ¥</span><br><span class="line">// 2. Nettyç½‘ç»œç¼–ç¨‹</span><br><span class="line">// 3. Rediså­˜å‚¨åœ¨çº¿çŠ¶æ€</span><br><span class="line">// 4. æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å¤„ç†</span><br><span class="line">// 5. æ¶ˆæ¯æŒä¹…åŒ–åˆ°MySQL</span><br></pre></td></tr></table></figure><h3 id="åœºæ™¯3ï¼šæ–‡ä»¶ç®¡ç†ç³»ç»Ÿ"><a href="#åœºæ™¯3ï¼šæ–‡ä»¶ç®¡ç†ç³»ç»Ÿ" class="headerlink" title="åœºæ™¯3ï¼šæ–‡ä»¶ç®¡ç†ç³»ç»Ÿ"></a>åœºæ™¯3ï¼šæ–‡ä»¶ç®¡ç†ç³»ç»Ÿ</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// æŠ€æœ¯ç‚¹æ•´åˆï¼š</span><br><span class="line">// 1. å¤§æ–‡ä»¶åˆ†ç‰‡ä¸Šä¼ </span><br><span class="line">// 2. æ–­ç‚¹ç»­ä¼ </span><br><span class="line">// 3. æ–‡ä»¶ç§’ä¼ ï¼ˆMD5æ ¡éªŒï¼‰</span><br><span class="line">// 4. åˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨</span><br><span class="line">// 5. CDNåŠ é€Ÿ</span><br></pre></td></tr></table></figure><h2 id="ğŸ³-éƒ¨ç½²æ¶æ„"><a href="#ğŸ³-éƒ¨ç½²æ¶æ„" class="headerlink" title="ğŸ³ éƒ¨ç½²æ¶æ„"></a>ğŸ³ éƒ¨ç½²æ¶æ„</h2><h3 id="Docker-Compose-å¼€å‘ç¯å¢ƒ"><a href="#Docker-Compose-å¼€å‘ç¯å¢ƒ" class="headerlink" title="Docker Compose å¼€å‘ç¯å¢ƒ"></a>Docker Compose å¼€å‘ç¯å¢ƒ</h3><p>yaml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">version: &#x27;3.8&#x27;</span><br><span class="line">services:</span><br><span class="line">  mysql-master:</span><br><span class="line">    image: mysql:8.0</span><br><span class="line">    environment:</span><br><span class="line">      MYSQL_ROOT_PASSWORD: root123</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;3306:3306&quot;</span><br><span class="line">  </span><br><span class="line">  redis:</span><br><span class="line">    image: redis:7-alpine</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;6379:6379&quot;</span><br><span class="line">  </span><br><span class="line">  elasticsearch:</span><br><span class="line">    image: elasticsearch:8.10.0</span><br><span class="line">    environment:</span><br><span class="line">      discovery.type: single-node</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;9200:9200&quot;</span><br><span class="line">  </span><br><span class="line">  nacos:</span><br><span class="line">    image: nacos/nacos-server:latest</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;8848:8848&quot;</span><br></pre></td></tr></table></figure><h3 id="Kubernetes-ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²"><a href="#Kubernetes-ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²" class="headerlink" title="Kubernetes ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²"></a>Kubernetes ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²</h3><p>yaml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: user-service</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: user-service</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: user-service</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: user-service</span><br><span class="line">        image: registry.example.com/shophub-user:latest</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">        env:</span><br><span class="line">        - name: SPRING_PROFILES_ACTIVE</span><br><span class="line">          value: &quot;prod&quot;</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            memory: &quot;512Mi&quot;</span><br><span class="line">            cpu: &quot;250m&quot;</span><br><span class="line">          limits:</span><br><span class="line">            memory: &quot;1Gi&quot;</span><br><span class="line">            cpu: &quot;500m&quot;</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /actuator/health</span><br><span class="line">            port: 8080</span><br></pre></td></tr></table></figure><h2 id="ğŸ”§-CI-CD-æµç¨‹"><a href="#ğŸ”§-CI-CD-æµç¨‹" class="headerlink" title="ğŸ”§ CI&#x2F;CD æµç¨‹"></a>ğŸ”§ CI&#x2F;CD æµç¨‹</h2><p>text</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Git Push â†’ Jenkins/GitLab CI â†’ å•å…ƒæµ‹è¯• â†’ æ„å»ºé•œåƒ â†’ </span><br><span class="line">    â†“</span><br><span class="line">å®‰å…¨æ‰«æ â†’ æ¨é€åˆ°é•œåƒä»“åº“ â†’ éƒ¨ç½²åˆ°K8S â†’ é›†æˆæµ‹è¯• â†’ ç›‘æ§å‘Šè­¦</span><br></pre></td></tr></table></figure><h2 id="ğŸ“-è¡¥å……çš„é‡è¦æŠ€æœ¯ç‚¹"><a href="#ğŸ“-è¡¥å……çš„é‡è¦æŠ€æœ¯ç‚¹" class="headerlink" title="ğŸ“ è¡¥å……çš„é‡è¦æŠ€æœ¯ç‚¹"></a>ğŸ“ è¡¥å……çš„é‡è¦æŠ€æœ¯ç‚¹</h2><ol><li><strong>ç›‘æ§ä½“ç³»</strong><ul><li>Prometheus + Grafana ç›‘æ§</li><li>SkyWalking é“¾è·¯è¿½è¸ª</li><li>ELK æ—¥å¿—æ”¶é›†</li></ul></li><li><strong>å®‰å…¨é˜²æŠ¤</strong><ul><li>æ¥å£é˜²åˆ·</li><li>SQLæ³¨å…¥é˜²æŠ¤</li><li>XSS&#x2F;CSRFé˜²æŠ¤</li><li>æ•°æ®è„±æ•</li></ul></li><li><strong>æ€§èƒ½ä¼˜åŒ–</strong><ul><li>æ•°æ®åº“è¯»å†™åˆ†ç¦»</li><li>åˆ†åº“åˆ†è¡¨ç­–ç•¥</li><li>CDNé™æ€èµ„æºåŠ é€Ÿ</li><li>JVMè°ƒä¼˜</li></ul></li><li><strong>æµ‹è¯•ç­–ç•¥</strong><ul><li>å•å…ƒæµ‹è¯•ï¼ˆJUnit + Mockitoï¼‰</li><li>é›†æˆæµ‹è¯•ï¼ˆTestContainersï¼‰</li><li>å‹åŠ›æµ‹è¯•ï¼ˆJMeterï¼‰</li><li>æ··æ²Œæµ‹è¯•ï¼ˆChaos Engineeringï¼‰</li></ul></li></ol><h2 id="ğŸ“š-å­¦ä¹ è·¯å¾„å»ºè®®"><a href="#ğŸ“š-å­¦ä¹ è·¯å¾„å»ºè®®" class="headerlink" title="ğŸ“š å­¦ä¹ è·¯å¾„å»ºè®®"></a>ğŸ“š å­¦ä¹ è·¯å¾„å»ºè®®</h2><h3 id="ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æ­å»ºï¼ˆ2å‘¨ï¼‰"><a href="#ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æ­å»ºï¼ˆ2å‘¨ï¼‰" class="headerlink" title="ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æ­å»ºï¼ˆ2å‘¨ï¼‰"></a>ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æ­å»ºï¼ˆ2å‘¨ï¼‰</h3><ol><li>æ­å»ºé¡¹ç›®éª¨æ¶ï¼Œé…ç½®å¤šæ¨¡å—</li><li>å®ç°è®¤è¯æˆæƒä¸­å¿ƒ</li><li>é…ç½®MySQL+Redis+ESåŸºç¡€ç¯å¢ƒ</li></ol><h3 id="ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒæœåŠ¡ï¼ˆ3å‘¨ï¼‰"><a href="#ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒæœåŠ¡ï¼ˆ3å‘¨ï¼‰" class="headerlink" title="ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒæœåŠ¡ï¼ˆ3å‘¨ï¼‰"></a>ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒæœåŠ¡ï¼ˆ3å‘¨ï¼‰</h3><ol><li>å•†å“æœåŠ¡ï¼ˆåŒ…å«æ–‡ä»¶ä¸Šä¼ ä¸‹è½½ï¼‰</li><li>è®¢å•æœåŠ¡ï¼ˆåˆ†å¸ƒå¼äº‹åŠ¡ï¼‰</li><li>åº“å­˜æœåŠ¡ï¼ˆé«˜å¹¶å‘å¤„ç†ï¼‰</li></ol><h3 id="ç¬¬ä¸‰é˜¶æ®µï¼šè¿›é˜¶åŠŸèƒ½ï¼ˆ2å‘¨ï¼‰"><a href="#ç¬¬ä¸‰é˜¶æ®µï¼šè¿›é˜¶åŠŸèƒ½ï¼ˆ2å‘¨ï¼‰" class="headerlink" title="ç¬¬ä¸‰é˜¶æ®µï¼šè¿›é˜¶åŠŸèƒ½ï¼ˆ2å‘¨ï¼‰"></a>ç¬¬ä¸‰é˜¶æ®µï¼šè¿›é˜¶åŠŸèƒ½ï¼ˆ2å‘¨ï¼‰</h3><ol><li>æœç´¢æœåŠ¡ï¼ˆESé«˜çº§æŸ¥è¯¢ï¼‰</li><li>ç½‘å…³æœåŠ¡ï¼ˆé™æµç†”æ–­ï¼‰</li><li>RPCè°ƒç”¨ï¼ˆDubboï¼‰</li></ol><h3 id="ç¬¬å››é˜¶æ®µï¼šéƒ¨ç½²è¿ç»´ï¼ˆ2å‘¨ï¼‰"><a href="#ç¬¬å››é˜¶æ®µï¼šéƒ¨ç½²è¿ç»´ï¼ˆ2å‘¨ï¼‰" class="headerlink" title="ç¬¬å››é˜¶æ®µï¼šéƒ¨ç½²è¿ç»´ï¼ˆ2å‘¨ï¼‰"></a>ç¬¬å››é˜¶æ®µï¼šéƒ¨ç½²è¿ç»´ï¼ˆ2å‘¨ï¼‰</h3><ol><li>Dockerå®¹å™¨åŒ–</li><li>K8Sç¼–æ’éƒ¨ç½²</li><li>CI&#x2F;CDæµæ°´çº¿</li></ol><h3 id="ç¬¬äº”é˜¶æ®µï¼šä¼˜åŒ–æ‰©å±•ï¼ˆ1å‘¨ï¼‰"><a href="#ç¬¬äº”é˜¶æ®µï¼šä¼˜åŒ–æ‰©å±•ï¼ˆ1å‘¨ï¼‰" class="headerlink" title="ç¬¬äº”é˜¶æ®µï¼šä¼˜åŒ–æ‰©å±•ï¼ˆ1å‘¨ï¼‰"></a>ç¬¬äº”é˜¶æ®µï¼šä¼˜åŒ–æ‰©å±•ï¼ˆ1å‘¨ï¼‰</h3><ol><li>æ€§èƒ½å‹æµ‹å’Œä¼˜åŒ–</li><li>ç›‘æ§å‘Šè­¦ç³»ç»Ÿ</li><li>å®‰å…¨åŠ å›º</li></ol><h2 id="ğŸ’¡-å®è·µå»ºè®®"><a href="#ğŸ’¡-å®è·µå»ºè®®" class="headerlink" title="ğŸ’¡ å®è·µå»ºè®®"></a>ğŸ’¡ å®è·µå»ºè®®</h2><ol><li><strong>ä»£ç ä»“åº“</strong>ï¼šä¸ºæ¯ä¸ªæŠ€æœ¯ç‚¹å»ºç«‹ç‹¬ç«‹åˆ†æ”¯ï¼Œæ–¹ä¾¿å¯¹æ¯”å­¦ä¹ </li><li><strong>æ–‡æ¡£è®°å½•</strong>ï¼šæ¯ä¸ªæ¨¡å—éƒ½è¦æœ‰è¯¦ç»†çš„READMEå’ŒæŠ€æœ¯æ€»ç»“</li><li><strong>æ¸è¿›å¼å¼€å‘</strong>ï¼šå…ˆå®ç°æ ¸å¿ƒåŠŸèƒ½ï¼Œå†é€æ­¥æ·»åŠ é«˜çº§ç‰¹æ€§</li><li><strong>æµ‹è¯•é©±åŠ¨</strong>ï¼šæ¯ä¸ªåŠŸèƒ½éƒ½è¦ç¼–å†™å¯¹åº”çš„å•å…ƒæµ‹è¯•</li><li><strong>ç›‘æ§æŒ‡æ ‡</strong>ï¼šå…³é”®æ¥å£éƒ½è¦æœ‰æ€§èƒ½æŒ‡æ ‡ç›‘æ§</li></ol><p>è¿™ä¸ªé¡¹ç›®è®¾è®¡è¦†ç›–äº†ä½ æåˆ°çš„æ‰€æœ‰æŠ€æœ¯ç‚¹ï¼Œå¹¶ä¸”å…·æœ‰çœŸå®çš„ä¸šåŠ¡åœºæ™¯ã€‚ä½ å¯ä»¥æŒ‰æ¨¡å—é€æ­¥å®ç°ï¼Œæ¯ä¸ªæ¨¡å—éƒ½èƒ½æ·±å…¥å®è·µç‰¹å®šçš„æŠ€æœ¯æ ˆã€‚é¡¹ç›®å®Œæ•´ä»£ç å¯ä»¥åœ¨GitHubä¸Šåˆ›å»ºä»“åº“ç®¡ç†ï¼Œæˆ‘ä¼šä¸ºä½ æä¾›æ¯ä¸ªæ¨¡å—çš„è¯¦ç»†å®ç°ä»£ç ã€‚</p><p>éœ€è¦æˆ‘ä»å“ªä¸ªæ¨¡å—å¼€å§‹æä¾›è¯¦ç»†ä»£ç å®ç°ï¼Ÿ</p><p>ä½ å¯ä»¥è‡ªå·±å®‰æ’ï¼ŒæŒ‰ç…§åˆç†çš„é¡ºåºä¾æ¬¡å®ç°ä»¥ä¸ŠåŠŸèƒ½</p><p>æˆ‘ä»¬æŒ‰ç…§ä»åŸºç¡€åˆ°é«˜çº§ï¼Œä»æ ¸å¿ƒä¸šåŠ¡åˆ°æ”¯æ’‘æŠ€æœ¯çš„é¡ºåºæ¥å®ç°ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å°†æ­å»ºä¸€ä¸ªå¤šæ¨¡å—çš„Mavené¡¹ç›®ï¼Œç„¶åé€æ­¥å®ç°å„ä¸ªæ¨¡å—ã€‚</p><p>æ­¥éª¤å®‰æ’ï¼š</p><ol><li>åˆ›å»ºçˆ¶å·¥ç¨‹å’Œé€šç”¨æ¨¡å—ï¼ˆcommonï¼‰</li><li>å®ç°è®¤è¯æˆæƒä¸­å¿ƒï¼ˆauthï¼‰</li><li>å®ç°å•†å“æœåŠ¡ï¼ˆproductï¼‰å’Œæœç´¢æœåŠ¡ï¼ˆsearchï¼‰</li><li>å®ç°è®¢å•æœåŠ¡ï¼ˆorderï¼‰ã€åº“å­˜æœåŠ¡ï¼ˆinventoryï¼‰å’Œæ”¯ä»˜æœåŠ¡ï¼ˆpaymentï¼‰</li><li>å®ç°é€šçŸ¥æœåŠ¡ï¼ˆnotificationï¼‰</li><li>å®ç°ç½‘å…³æœåŠ¡ï¼ˆgatewayï¼‰</li><li>æœåŠ¡æ³¨å†Œä¸å‘ç°ï¼ˆä½¿ç”¨Nacosï¼‰</li><li>æœåŠ¡è¿œç¨‹è°ƒç”¨ï¼ˆä½¿ç”¨Dubboï¼‰</li><li>é…ç½®å’Œéƒ¨ç½²ï¼ˆDockerã€K8Sã€CI&#x2F;CDï¼‰</li></ol><p>ç”±äºç¯‡å¹…é™åˆ¶ï¼Œæˆ‘å°†é€æ­¥ç»™å‡ºæ¯ä¸ªéƒ¨åˆ†çš„å…³é”®ä»£ç å’Œé…ç½®ã€‚è¿™é‡Œæˆ‘ä»¬å…ˆä»çˆ¶å·¥ç¨‹å’Œé€šç”¨æ¨¡å—å¼€å§‹ã€‚</p><p>ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºçˆ¶å·¥ç¨‹ï¼ˆshophub-parentï¼‰<br>ç¬¬äºŒæ­¥ï¼šåˆ›å»ºé€šç”¨æ¨¡å—ï¼ˆshophub-commonï¼‰</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¼€å§‹ç¬¬ä¸€æ­¥ã€‚</p><p>æˆ‘å°†æŒ‰ç…§<strong>æ¸è¿›å¼ã€ç”±æµ…å…¥æ·±</strong>çš„é¡ºåºä¸ºä½ å®ç°æ•´ä¸ªç³»ç»Ÿã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†çš„å®ç°è®¡åˆ’ï¼š</p><h2 id="ğŸ“…-ç¬¬ä¸€é˜¶æ®µï¼šé¡¹ç›®åŸºç¡€æ¶æ„æ­å»ºï¼ˆç¬¬1å‘¨ï¼‰"><a href="#ğŸ“…-ç¬¬ä¸€é˜¶æ®µï¼šé¡¹ç›®åŸºç¡€æ¶æ„æ­å»ºï¼ˆç¬¬1å‘¨ï¼‰" class="headerlink" title="ğŸ“… ç¬¬ä¸€é˜¶æ®µï¼šé¡¹ç›®åŸºç¡€æ¶æ„æ­å»ºï¼ˆç¬¬1å‘¨ï¼‰"></a>ğŸ“… ç¬¬ä¸€é˜¶æ®µï¼šé¡¹ç›®åŸºç¡€æ¶æ„æ­å»ºï¼ˆç¬¬1å‘¨ï¼‰</h2><h3 id="ç¬¬1å¤©ï¼šåˆ›å»ºé¡¹ç›®éª¨æ¶å’ŒåŸºç¡€é…ç½®"><a href="#ç¬¬1å¤©ï¼šåˆ›å»ºé¡¹ç›®éª¨æ¶å’ŒåŸºç¡€é…ç½®" class="headerlink" title="ç¬¬1å¤©ï¼šåˆ›å»ºé¡¹ç›®éª¨æ¶å’ŒåŸºç¡€é…ç½®"></a>ç¬¬1å¤©ï¼šåˆ›å»ºé¡¹ç›®éª¨æ¶å’ŒåŸºç¡€é…ç½®</h3><p>xml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 1. çˆ¶å·¥ç¨‹ pom.xml --&gt;</span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;</span><br><span class="line">         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 </span><br><span class="line">         http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;groupId&gt;com.shophub&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;shophub-parent&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.0.0&lt;/version&gt;</span><br><span class="line">    &lt;packaging&gt;pom&lt;/packaging&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;modules&gt;</span><br><span class="line">        &lt;module&gt;shophub-common&lt;/module&gt;</span><br><span class="line">        &lt;module&gt;shophub-auth&lt;/module&gt;</span><br><span class="line">        &lt;module&gt;shophub-gateway&lt;/module&gt;</span><br><span class="line">        &lt;module&gt;shophub-product&lt;/module&gt;</span><br><span class="line">        &lt;module&gt;shophub-order&lt;/module&gt;</span><br><span class="line">        &lt;module&gt;shophub-inventory&lt;/module&gt;</span><br><span class="line">        &lt;module&gt;shophub-search&lt;/module&gt;</span><br><span class="line">        &lt;module&gt;shophub-payment&lt;/module&gt;</span><br><span class="line">        &lt;module&gt;shophub-notification&lt;/module&gt;</span><br><span class="line">    &lt;/modules&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;!-- ç»Ÿä¸€ç‰ˆæœ¬ç®¡ç† --&gt;</span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;java.version&gt;17&lt;/java.version&gt;</span><br><span class="line">        &lt;spring-boot.version&gt;3.1.5&lt;/spring-boot.version&gt;</span><br><span class="line">        &lt;spring-cloud.version&gt;2022.0.4&lt;/spring-cloud.version&gt;</span><br><span class="line">        &lt;mysql.version&gt;8.0.33&lt;/mysql.version&gt;</span><br><span class="line">        &lt;mybatis-plus.version&gt;3.5.3.1&lt;/mybatis-plus.version&gt;</span><br><span class="line">        &lt;redisson.version&gt;3.23.2&lt;/redisson.version&gt;</span><br><span class="line">        &lt;dubbo.version&gt;3.2.7&lt;/dubbo.version&gt;</span><br><span class="line">        &lt;nacos.version&gt;2022.0.0.0&lt;/nacos.version&gt;</span><br><span class="line">    &lt;/properties&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;!-- ä¾èµ–ç®¡ç† --&gt;</span><br><span class="line">    &lt;dependencyManagement&gt;</span><br><span class="line">        &lt;dependencies&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-boot-dependencies&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;$&#123;spring-boot.version&#125;&lt;/version&gt;</span><br><span class="line">                &lt;type&gt;pom&lt;/type&gt;</span><br><span class="line">                &lt;scope&gt;import&lt;/scope&gt;</span><br><span class="line">            &lt;/dependency&gt;</span><br><span class="line">            </span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;$&#123;spring-cloud.version&#125;&lt;/version&gt;</span><br><span class="line">                &lt;type&gt;pom&lt;/type&gt;</span><br><span class="line">                &lt;scope&gt;import&lt;/scope&gt;</span><br><span class="line">            &lt;/dependency&gt;</span><br><span class="line">        &lt;/dependencies&gt;</span><br><span class="line">    &lt;/dependencyManagement&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;!-- å…¬å…±æ’ä»¶é…ç½® --&gt;</span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;$&#123;spring-boot.version&#125;&lt;/version&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;excludes&gt;</span><br><span class="line">                        &lt;exclude&gt;</span><br><span class="line">                            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span><br><span class="line">                            &lt;artifactId&gt;lombok&lt;/artifactId&gt;</span><br><span class="line">                        &lt;/exclude&gt;</span><br><span class="line">                    &lt;/excludes&gt;</span><br><span class="line">                &lt;/configuration&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;3.11.0&lt;/version&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;source&gt;$&#123;java.version&#125;&lt;/source&gt;</span><br><span class="line">                    &lt;target&gt;$&#123;java.version&#125;&lt;/target&gt;</span><br><span class="line">                    &lt;encoding&gt;UTF-8&lt;/encoding&gt;</span><br><span class="line">                &lt;/configuration&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">        &lt;/plugins&gt;</span><br><span class="line">    &lt;/build&gt;</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure><h3 id="ç¬¬2å¤©ï¼šé€šç”¨æ¨¡å—å®ç°ï¼ˆshophub-commonï¼‰"><a href="#ç¬¬2å¤©ï¼šé€šç”¨æ¨¡å—å®ç°ï¼ˆshophub-commonï¼‰" class="headerlink" title="ç¬¬2å¤©ï¼šé€šç”¨æ¨¡å—å®ç°ï¼ˆshophub-commonï¼‰"></a>ç¬¬2å¤©ï¼šé€šç”¨æ¨¡å—å®ç°ï¼ˆshophub-commonï¼‰</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br></pre></td><td class="code"><pre><span class="line">// 1. åŸºç¡€å·¥å…·ç±»</span><br><span class="line">package com.shophub.common.utils;</span><br><span class="line"></span><br><span class="line">import com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line">import com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * é€šç”¨å·¥å…·ç±» - åŒ…å«åå°„ã€JSONè½¬æ¢ç­‰</span><br><span class="line"> */</span><br><span class="line">@Slf4j</span><br><span class="line">public class CommonUtil &#123;</span><br><span class="line">    </span><br><span class="line">    private static final ObjectMapper objectMapper = new ObjectMapper();</span><br><span class="line">    </span><br><span class="line">    static &#123;</span><br><span class="line">        objectMapper.registerModule(new JavaTimeModule());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * ä½¿ç”¨åå°„è·å–å¯¹è±¡å±æ€§</span><br><span class="line">     */</span><br><span class="line">    public static Map&lt;String, Object&gt; getFieldValueMap(Object obj) &#123;</span><br><span class="line">        Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();</span><br><span class="line">        try &#123;</span><br><span class="line">            Class&lt;?&gt; clazz = obj.getClass();</span><br><span class="line">            for (Field field : clazz.getDeclaredFields()) &#123;</span><br><span class="line">                field.setAccessible(true);</span><br><span class="line">                map.put(field.getName(), field.get(obj));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;åå°„è·å–å±æ€§å¤±è´¥&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">        return map;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å¯¹è±¡è½¬JSONå­—ç¬¦ä¸²</span><br><span class="line">     */</span><br><span class="line">    public static String toJson(Object obj) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            return objectMapper.writeValueAsString(obj);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;å¯¹è±¡è½¬JSONå¤±è´¥&quot;, e);</span><br><span class="line">            return &quot;&#123;&#125;&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * JSONå­—ç¬¦ä¸²è½¬å¯¹è±¡</span><br><span class="line">     */</span><br><span class="line">    public static &lt;T&gt; T fromJson(String json, Class&lt;T&gt; clazz) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            return objectMapper.readValue(json, clazz);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;JSONè½¬å¯¹è±¡å¤±è´¥&quot;, e);</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 2. åˆ†å¸ƒå¼IDç”Ÿæˆå™¨ï¼ˆé›ªèŠ±ç®—æ³•ï¼‰</span><br><span class="line">package com.shophub.common.id;</span><br><span class="line"></span><br><span class="line">import org.springframework.beans.factory.annotation.Value;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line">import java.net.InetAddress;</span><br><span class="line">import java.net.UnknownHostException;</span><br><span class="line">import java.util.concurrent.atomic.AtomicLong;</span><br><span class="line"></span><br><span class="line">@Component</span><br><span class="line">public class SnowflakeIdGenerator &#123;</span><br><span class="line">    </span><br><span class="line">    // æ—¶é—´æˆ³ä½æ•°</span><br><span class="line">    private static final long TIMESTAMP_BITS = 41L;</span><br><span class="line">    // æ•°æ®ä¸­å¿ƒIDä½æ•°</span><br><span class="line">    private static final long DATACENTER_ID_BITS = 5L;</span><br><span class="line">    // æœºå™¨IDä½æ•°</span><br><span class="line">    private static final long WORKER_ID_BITS = 5L;</span><br><span class="line">    // åºåˆ—å·ä½æ•°</span><br><span class="line">    private static final long SEQUENCE_BITS = 12L;</span><br><span class="line">    </span><br><span class="line">    // åç§»é‡</span><br><span class="line">    private static final long DATACENTER_ID_SHIFT = SEQUENCE_BITS;</span><br><span class="line">    private static final long WORKER_ID_SHIFT = SEQUENCE_BITS + DATACENTER_ID_BITS;</span><br><span class="line">    private static final long TIMESTAMP_SHIFT = SEQUENCE_BITS + DATACENTER_ID_BITS + WORKER_ID_BITS;</span><br><span class="line">    </span><br><span class="line">    // æœ€å¤§å€¼</span><br><span class="line">    private static final long MAX_DATACENTER_ID = ~(-1L &lt;&lt; DATACENTER_ID_BITS);</span><br><span class="line">    private static final long MAX_WORKER_ID = ~(-1L &lt;&lt; WORKER_ID_BITS);</span><br><span class="line">    private static final long MAX_SEQUENCE = ~(-1L &lt;&lt; SEQUENCE_BITS);</span><br><span class="line">    </span><br><span class="line">    // èµ·å§‹æ—¶é—´æˆ³ï¼ˆ2023-01-01ï¼‰</span><br><span class="line">    private static final long START_TIMESTAMP = 1672531200000L;</span><br><span class="line">    </span><br><span class="line">    private final long datacenterId;</span><br><span class="line">    private final long workerId;</span><br><span class="line">    private long lastTimestamp = -1L;</span><br><span class="line">    private long sequence = 0L;</span><br><span class="line">    </span><br><span class="line">    public SnowflakeIdGenerator(</span><br><span class="line">            @Value(&quot;$&#123;snowflake.datacenter-id:1&#125;&quot;) long datacenterId,</span><br><span class="line">            @Value(&quot;$&#123;snowflake.worker-id:1&#125;&quot;) long workerId) &#123;</span><br><span class="line">        </span><br><span class="line">        if (datacenterId &gt; MAX_DATACENTER_ID || datacenterId &lt; 0) &#123;</span><br><span class="line">            throw new IllegalArgumentException(&quot;æ•°æ®ä¸­å¿ƒIDèŒƒå›´é”™è¯¯&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        if (workerId &gt; MAX_WORKER_ID || workerId &lt; 0) &#123;</span><br><span class="line">            throw new IllegalArgumentException(&quot;æœºå™¨IDèŒƒå›´é”™è¯¯&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        this.datacenterId = datacenterId;</span><br><span class="line">        this.workerId = workerId;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public SnowflakeIdGenerator() throws UnknownHostException &#123;</span><br><span class="line">        // é»˜è®¤ä½¿ç”¨IPåœ°å€ç”ŸæˆworkerId</span><br><span class="line">        InetAddress inetAddress = InetAddress.getLocalHost();</span><br><span class="line">        byte[] ipBytes = inetAddress.getAddress();</span><br><span class="line">        this.datacenterId = 1;</span><br><span class="line">        this.workerId = (ipBytes[2] &amp; 0xFF) % (MAX_WORKER_ID + 1);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public synchronized long nextId() &#123;</span><br><span class="line">        long timestamp = timeGen();</span><br><span class="line">        </span><br><span class="line">        if (timestamp &lt; lastTimestamp) &#123;</span><br><span class="line">            throw new RuntimeException(&quot;æ—¶é’Ÿå›æ‹¨å¼‚å¸¸&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        if (timestamp == lastTimestamp) &#123;</span><br><span class="line">            sequence = (sequence + 1) &amp; MAX_SEQUENCE;</span><br><span class="line">            if (sequence == 0) &#123;</span><br><span class="line">                timestamp = tilNextMillis(lastTimestamp);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            sequence = 0L;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        lastTimestamp = timestamp;</span><br><span class="line">        </span><br><span class="line">        return ((timestamp - START_TIMESTAMP) &lt;&lt; TIMESTAMP_SHIFT)</span><br><span class="line">                | (datacenterId &lt;&lt; DATACENTER_ID_SHIFT)</span><br><span class="line">                | (workerId &lt;&lt; WORKER_ID_SHIFT)</span><br><span class="line">                | sequence;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private long tilNextMillis(long lastTimestamp) &#123;</span><br><span class="line">        long timestamp = timeGen();</span><br><span class="line">        while (timestamp &lt;= lastTimestamp) &#123;</span><br><span class="line">            timestamp = timeGen();</span><br><span class="line">        &#125;</span><br><span class="line">        return timestamp;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private long timeGen() &#123;</span><br><span class="line">        return System.currentTimeMillis();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 3. é€šç”¨è¿”å›ç»“æœå°è£…</span><br><span class="line">package com.shophub.common.result;</span><br><span class="line"></span><br><span class="line">import lombok.Data;</span><br><span class="line">import java.io.Serializable;</span><br><span class="line"></span><br><span class="line">@Data</span><br><span class="line">public class Result&lt;T&gt; implements Serializable &#123;</span><br><span class="line">    private Integer code;</span><br><span class="line">    private String message;</span><br><span class="line">    private T data;</span><br><span class="line">    private Long timestamp;</span><br><span class="line">    </span><br><span class="line">    public Result() &#123;</span><br><span class="line">        this.timestamp = System.currentTimeMillis();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public static &lt;T&gt; Result&lt;T&gt; success(T data) &#123;</span><br><span class="line">        Result&lt;T&gt; result = new Result&lt;&gt;();</span><br><span class="line">        result.setCode(ResultCode.SUCCESS.getCode());</span><br><span class="line">        result.setMessage(ResultCode.SUCCESS.getMessage());</span><br><span class="line">        result.setData(data);</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public static &lt;T&gt; Result&lt;T&gt; success() &#123;</span><br><span class="line">        return success(null);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public static &lt;T&gt; Result&lt;T&gt; error(ResultCode code) &#123;</span><br><span class="line">        Result&lt;T&gt; result = new Result&lt;&gt;();</span><br><span class="line">        result.setCode(code.getCode());</span><br><span class="line">        result.setMessage(code.getMessage());</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public static &lt;T&gt; Result&lt;T&gt; error(Integer code, String message) &#123;</span><br><span class="line">        Result&lt;T&gt; result = new Result&lt;&gt;();</span><br><span class="line">        result.setCode(code);</span><br><span class="line">        result.setMessage(message);</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 4. å…¨å±€å¼‚å¸¸å¤„ç†</span><br><span class="line">package com.shophub.common.exception;</span><br><span class="line"></span><br><span class="line">import com.shophub.common.result.Result;</span><br><span class="line">import com.shophub.common.result.ResultCode;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.springframework.http.HttpStatus;</span><br><span class="line">import org.springframework.validation.BindException;</span><br><span class="line">import org.springframework.web.bind.annotation.ExceptionHandler;</span><br><span class="line">import org.springframework.web.bind.annotation.ResponseStatus;</span><br><span class="line">import org.springframework.web.bind.annotation.RestControllerAdvice;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@RestControllerAdvice</span><br><span class="line">public class GlobalExceptionHandler &#123;</span><br><span class="line">    </span><br><span class="line">    @ExceptionHandler(Exception.class)</span><br><span class="line">    @ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)</span><br><span class="line">    public Result&lt;String&gt; handleException(Exception e) &#123;</span><br><span class="line">        log.error(&quot;å…¨å±€å¼‚å¸¸ä¿¡æ¯&quot;, e);</span><br><span class="line">        return Result.error(ResultCode.SYSTEM_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @ExceptionHandler(BusinessException.class)</span><br><span class="line">    @ResponseStatus(HttpStatus.BAD_REQUEST)</span><br><span class="line">    public Result&lt;String&gt; handleBusinessException(BusinessException e) &#123;</span><br><span class="line">        log.error(&quot;ä¸šåŠ¡å¼‚å¸¸ä¿¡æ¯&quot;, e);</span><br><span class="line">        return Result.error(e.getCode(), e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @ExceptionHandler(BindException.class)</span><br><span class="line">    @ResponseStatus(HttpStatus.BAD_REQUEST)</span><br><span class="line">    public Result&lt;String&gt; handleBindException(BindException e) &#123;</span><br><span class="line">        log.error(&quot;å‚æ•°æ ¡éªŒå¼‚å¸¸&quot;, e);</span><br><span class="line">        String message = e.getBindingResult().getAllErrors().get(0).getDefaultMessage();</span><br><span class="line">        return Result.error(ResultCode.PARAM_VALID_ERROR.getCode(), message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç¬¬3å¤©ï¼šæ•°æ®åº“è®¾è®¡å’ŒåŸºç¡€è¡¨ç»“æ„"><a href="#ç¬¬3å¤©ï¼šæ•°æ®åº“è®¾è®¡å’ŒåŸºç¡€è¡¨ç»“æ„" class="headerlink" title="ç¬¬3å¤©ï¼šæ•°æ®åº“è®¾è®¡å’ŒåŸºç¡€è¡¨ç»“æ„"></a>ç¬¬3å¤©ï¼šæ•°æ®åº“è®¾è®¡å’ŒåŸºç¡€è¡¨ç»“æ„</h3><p>sql</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line">-- 1. åˆ›å»ºæ•°æ®åº“</span><br><span class="line">CREATE DATABASE IF NOT EXISTS `shophub` DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;</span><br><span class="line"></span><br><span class="line">-- 2. ç”¨æˆ·è¡¨</span><br><span class="line">CREATE TABLE `sys_user` (</span><br><span class="line">  `id` bigint(20) NOT NULL COMMENT &#x27;ç”¨æˆ·ID&#x27;,</span><br><span class="line">  `username` varchar(50) NOT NULL COMMENT &#x27;ç”¨æˆ·å&#x27;,</span><br><span class="line">  `password` varchar(200) NOT NULL COMMENT &#x27;å¯†ç &#x27;,</span><br><span class="line">  `nickname` varchar(50) DEFAULT NULL COMMENT &#x27;æ˜µç§°&#x27;,</span><br><span class="line">  `email` varchar(100) DEFAULT NULL COMMENT &#x27;é‚®ç®±&#x27;,</span><br><span class="line">  `phone` varchar(20) DEFAULT NULL COMMENT &#x27;æ‰‹æœºå·&#x27;,</span><br><span class="line">  `avatar` varchar(500) DEFAULT NULL COMMENT &#x27;å¤´åƒ&#x27;,</span><br><span class="line">  `status` tinyint(1) DEFAULT &#x27;1&#x27; COMMENT &#x27;çŠ¶æ€ 1:æ­£å¸¸ 0:ç¦ç”¨&#x27;,</span><br><span class="line">  `last_login_time` datetime DEFAULT NULL COMMENT &#x27;æœ€åç™»å½•æ—¶é—´&#x27;,</span><br><span class="line">  `last_login_ip` varchar(50) DEFAULT NULL COMMENT &#x27;æœ€åç™»å½•IP&#x27;,</span><br><span class="line">  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;åˆ›å»ºæ—¶é—´&#x27;,</span><br><span class="line">  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &#x27;æ›´æ–°æ—¶é—´&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_username` (`username`),</span><br><span class="line">  UNIQUE KEY `uk_email` (`email`),</span><br><span class="line">  UNIQUE KEY `uk_phone` (`phone`),</span><br><span class="line">  KEY `idx_create_time` (`create_time`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=&#x27;ç”¨æˆ·è¡¨&#x27;;</span><br><span class="line"></span><br><span class="line">-- 3. è§’è‰²è¡¨</span><br><span class="line">CREATE TABLE `sys_role` (</span><br><span class="line">  `id` bigint(20) NOT NULL COMMENT &#x27;è§’è‰²ID&#x27;,</span><br><span class="line">  `role_code` varchar(50) NOT NULL COMMENT &#x27;è§’è‰²ç¼–ç &#x27;,</span><br><span class="line">  `role_name` varchar(50) NOT NULL COMMENT &#x27;è§’è‰²åç§°&#x27;,</span><br><span class="line">  `description` varchar(200) DEFAULT NULL COMMENT &#x27;æè¿°&#x27;,</span><br><span class="line">  `status` tinyint(1) DEFAULT &#x27;1&#x27; COMMENT &#x27;çŠ¶æ€ 1:æ­£å¸¸ 0:ç¦ç”¨&#x27;,</span><br><span class="line">  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;åˆ›å»ºæ—¶é—´&#x27;,</span><br><span class="line">  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &#x27;æ›´æ–°æ—¶é—´&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_role_code` (`role_code`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=&#x27;è§’è‰²è¡¨&#x27;;</span><br><span class="line"></span><br><span class="line">-- 4. æƒé™è¡¨</span><br><span class="line">CREATE TABLE `sys_permission` (</span><br><span class="line">  `id` bigint(20) NOT NULL COMMENT &#x27;æƒé™ID&#x27;,</span><br><span class="line">  `parent_id` bigint(20) DEFAULT &#x27;0&#x27; COMMENT &#x27;çˆ¶æƒé™ID&#x27;,</span><br><span class="line">  `permission_code` varchar(100) NOT NULL COMMENT &#x27;æƒé™ç¼–ç &#x27;,</span><br><span class="line">  `permission_name` varchar(100) NOT NULL COMMENT &#x27;æƒé™åç§°&#x27;,</span><br><span class="line">  `type` tinyint(1) DEFAULT NULL COMMENT &#x27;ç±»å‹ 1:èœå• 2:æŒ‰é’® 3:æ¥å£&#x27;,</span><br><span class="line">  `path` varchar(200) DEFAULT NULL COMMENT &#x27;è·¯å¾„&#x27;,</span><br><span class="line">  `component` varchar(200) DEFAULT NULL COMMENT &#x27;ç»„ä»¶&#x27;,</span><br><span class="line">  `icon` varchar(100) DEFAULT NULL COMMENT &#x27;å›¾æ ‡&#x27;,</span><br><span class="line">  `sort` int(11) DEFAULT &#x27;0&#x27; COMMENT &#x27;æ’åº&#x27;,</span><br><span class="line">  `status` tinyint(1) DEFAULT &#x27;1&#x27; COMMENT &#x27;çŠ¶æ€ 1:æ­£å¸¸ 0:ç¦ç”¨&#x27;,</span><br><span class="line">  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;åˆ›å»ºæ—¶é—´&#x27;,</span><br><span class="line">  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &#x27;æ›´æ–°æ—¶é—´&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_permission_code` (`permission_code`),</span><br><span class="line">  KEY `idx_parent_id` (`parent_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=&#x27;æƒé™è¡¨&#x27;;</span><br><span class="line"></span><br><span class="line">-- 5. ç”¨æˆ·è§’è‰²å…³è”è¡¨</span><br><span class="line">CREATE TABLE `sys_user_role` (</span><br><span class="line">  `id` bigint(20) NOT NULL COMMENT &#x27;ä¸»é”®ID&#x27;,</span><br><span class="line">  `user_id` bigint(20) NOT NULL COMMENT &#x27;ç”¨æˆ·ID&#x27;,</span><br><span class="line">  `role_id` bigint(20) NOT NULL COMMENT &#x27;è§’è‰²ID&#x27;,</span><br><span class="line">  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;åˆ›å»ºæ—¶é—´&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_user_role` (`user_id`,`role_id`),</span><br><span class="line">  KEY `idx_user_id` (`user_id`),</span><br><span class="line">  KEY `idx_role_id` (`role_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=&#x27;ç”¨æˆ·è§’è‰²å…³è”è¡¨&#x27;;</span><br><span class="line"></span><br><span class="line">-- 6. è§’è‰²æƒé™å…³è”è¡¨</span><br><span class="line">CREATE TABLE `sys_role_permission` (</span><br><span class="line">  `id` bigint(20) NOT NULL COMMENT &#x27;ä¸»é”®ID&#x27;,</span><br><span class="line">  `role_id` bigint(20) NOT NULL COMMENT &#x27;è§’è‰²ID&#x27;,</span><br><span class="line">  `permission_id` bigint(20) NOT NULL COMMENT &#x27;æƒé™ID&#x27;,</span><br><span class="line">  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;åˆ›å»ºæ—¶é—´&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_role_permission` (`role_id`,`permission_id`),</span><br><span class="line">  KEY `idx_role_id` (`role_id`),</span><br><span class="line">  KEY `idx_permission_id` (`permission_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=&#x27;è§’è‰²æƒé™å…³è”è¡¨&#x27;;</span><br><span class="line"></span><br><span class="line">-- 7. å•†å“è¡¨</span><br><span class="line">CREATE TABLE `product` (</span><br><span class="line">  `id` bigint(20) NOT NULL COMMENT &#x27;å•†å“ID&#x27;,</span><br><span class="line">  `product_no` varchar(50) NOT NULL COMMENT &#x27;å•†å“ç¼–å·&#x27;,</span><br><span class="line">  `product_name` varchar(200) NOT NULL COMMENT &#x27;å•†å“åç§°&#x27;,</span><br><span class="line">  `category_id` bigint(20) NOT NULL COMMENT &#x27;åˆ†ç±»ID&#x27;,</span><br><span class="line">  `brand` varchar(100) DEFAULT NULL COMMENT &#x27;å“ç‰Œ&#x27;,</span><br><span class="line">  `price` decimal(10,2) NOT NULL COMMENT &#x27;ä»·æ ¼&#x27;,</span><br><span class="line">  `market_price` decimal(10,2) DEFAULT NULL COMMENT &#x27;å¸‚åœºä»·&#x27;,</span><br><span class="line">  `cost_price` decimal(10,2) DEFAULT NULL COMMENT &#x27;æˆæœ¬ä»·&#x27;,</span><br><span class="line">  `stock` int(11) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;åº“å­˜&#x27;,</span><br><span class="line">  `sale_count` int(11) DEFAULT &#x27;0&#x27; COMMENT &#x27;é”€é‡&#x27;,</span><br><span class="line">  `main_image` varchar(500) DEFAULT NULL COMMENT &#x27;ä¸»å›¾&#x27;,</span><br><span class="line">  `sub_images` text COMMENT &#x27;å­å›¾&#x27;,</span><br><span class="line">  `detail` text COMMENT &#x27;è¯¦æƒ…&#x27;,</span><br><span class="line">  `status` tinyint(1) DEFAULT &#x27;1&#x27; COMMENT &#x27;çŠ¶æ€ 1:ä¸Šæ¶ 0:ä¸‹æ¶&#x27;,</span><br><span class="line">  `is_hot` tinyint(1) DEFAULT &#x27;0&#x27; COMMENT &#x27;æ˜¯å¦çƒ­é”€&#x27;,</span><br><span class="line">  `is_new` tinyint(1) DEFAULT &#x27;0&#x27; COMMENT &#x27;æ˜¯å¦æ–°å“&#x27;,</span><br><span class="line">  `weight` decimal(10,2) DEFAULT NULL COMMENT &#x27;é‡é‡&#x27;,</span><br><span class="line">  `unit` varchar(20) DEFAULT NULL COMMENT &#x27;å•ä½&#x27;,</span><br><span class="line">  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;åˆ›å»ºæ—¶é—´&#x27;,</span><br><span class="line">  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &#x27;æ›´æ–°æ—¶é—´&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_product_no` (`product_no`),</span><br><span class="line">  KEY `idx_category_id` (`category_id`),</span><br><span class="line">  KEY `idx_status` (`status`),</span><br><span class="line">  KEY `idx_create_time` (`create_time`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=&#x27;å•†å“è¡¨&#x27;;</span><br><span class="line"></span><br><span class="line">-- 8. è®¢å•è¡¨ï¼ˆæŒ‰æœˆä»½åˆ†è¡¨ï¼‰</span><br><span class="line">CREATE TABLE `order_202312` (</span><br><span class="line">  `id` bigint(20) NOT NULL COMMENT &#x27;è®¢å•ID&#x27;,</span><br><span class="line">  `order_no` varchar(50) NOT NULL COMMENT &#x27;è®¢å•å·&#x27;,</span><br><span class="line">  `user_id` bigint(20) NOT NULL COMMENT &#x27;ç”¨æˆ·ID&#x27;,</span><br><span class="line">  `total_amount` decimal(10,2) NOT NULL COMMENT &#x27;è®¢å•æ€»é‡‘é¢&#x27;,</span><br><span class="line">  `pay_amount` decimal(10,2) NOT NULL COMMENT &#x27;å®ä»˜é‡‘é¢&#x27;,</span><br><span class="line">  `freight_amount` decimal(10,2) DEFAULT &#x27;0.00&#x27; COMMENT &#x27;è¿è´¹&#x27;,</span><br><span class="line">  `discount_amount` decimal(10,2) DEFAULT &#x27;0.00&#x27; COMMENT &#x27;ä¼˜æƒ é‡‘é¢&#x27;,</span><br><span class="line">  `pay_type` tinyint(1) DEFAULT NULL COMMENT &#x27;æ”¯ä»˜æ–¹å¼ 1:æ”¯ä»˜å® 2:å¾®ä¿¡&#x27;,</span><br><span class="line">  `status` tinyint(1) NOT NULL COMMENT &#x27;çŠ¶æ€ 0:å¾…æ”¯ä»˜ 1:å·²æ”¯ä»˜ 2:å·²å‘è´§ 3:å·²å®Œæˆ 4:å·²å–æ¶ˆ&#x27;,</span><br><span class="line">  `delivery_company` varchar(100) DEFAULT NULL COMMENT &#x27;ç‰©æµå…¬å¸&#x27;,</span><br><span class="line">  `delivery_no` varchar(100) DEFAULT NULL COMMENT &#x27;ç‰©æµå•å·&#x27;,</span><br><span class="line">  `receiver_name` varchar(50) NOT NULL COMMENT &#x27;æ”¶è´§äººå§“å&#x27;,</span><br><span class="line">  `receiver_phone` varchar(20) NOT NULL COMMENT &#x27;æ”¶è´§äººç”µè¯&#x27;,</span><br><span class="line">  `receiver_address` varchar(200) NOT NULL COMMENT &#x27;æ”¶è´§åœ°å€&#x27;,</span><br><span class="line">  `remark` varchar(500) DEFAULT NULL COMMENT &#x27;å¤‡æ³¨&#x27;,</span><br><span class="line">  `pay_time` datetime DEFAULT NULL COMMENT &#x27;æ”¯ä»˜æ—¶é—´&#x27;,</span><br><span class="line">  `delivery_time` datetime DEFAULT NULL COMMENT &#x27;å‘è´§æ—¶é—´&#x27;,</span><br><span class="line">  `receive_time` datetime DEFAULT NULL COMMENT &#x27;æ”¶è´§æ—¶é—´&#x27;,</span><br><span class="line">  `cancel_time` datetime DEFAULT NULL COMMENT &#x27;å–æ¶ˆæ—¶é—´&#x27;,</span><br><span class="line">  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;åˆ›å»ºæ—¶é—´&#x27;,</span><br><span class="line">  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &#x27;æ›´æ–°æ—¶é—´&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_order_no` (`order_no`),</span><br><span class="line">  KEY `idx_user_id` (`user_id`),</span><br><span class="line">  KEY `idx_status` (`status`),</span><br><span class="line">  KEY `idx_create_time` (`create_time`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=&#x27;è®¢å•è¡¨&#x27;;</span><br><span class="line"></span><br><span class="line">-- 9. è®¢å•å•†å“è¡¨</span><br><span class="line">CREATE TABLE `order_item` (</span><br><span class="line">  `id` bigint(20) NOT NULL COMMENT &#x27;ä¸»é”®ID&#x27;,</span><br><span class="line">  `order_id` bigint(20) NOT NULL COMMENT &#x27;è®¢å•ID&#x27;,</span><br><span class="line">  `product_id` bigint(20) NOT NULL COMMENT &#x27;å•†å“ID&#x27;,</span><br><span class="line">  `product_name` varchar(200) NOT NULL COMMENT &#x27;å•†å“åç§°&#x27;,</span><br><span class="line">  `product_image` varchar(500) DEFAULT NULL COMMENT &#x27;å•†å“å›¾ç‰‡&#x27;,</span><br><span class="line">  `product_price` decimal(10,2) NOT NULL COMMENT &#x27;å•†å“å•ä»·&#x27;,</span><br><span class="line">  `quantity` int(11) NOT NULL COMMENT &#x27;è´­ä¹°æ•°é‡&#x27;,</span><br><span class="line">  `total_amount` decimal(10,2) NOT NULL COMMENT &#x27;å•†å“æ€»ä»·&#x27;,</span><br><span class="line">  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;åˆ›å»ºæ—¶é—´&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  KEY `idx_order_id` (`order_id`),</span><br><span class="line">  KEY `idx_product_id` (`product_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=&#x27;è®¢å•å•†å“è¡¨&#x27;;</span><br></pre></td></tr></table></figure><h3 id="ç¬¬4å¤©ï¼šRedisé…ç½®å’Œå·¥å…·ç±»"><a href="#ç¬¬4å¤©ï¼šRedisé…ç½®å’Œå·¥å…·ç±»" class="headerlink" title="ç¬¬4å¤©ï¼šRedisé…ç½®å’Œå·¥å…·ç±»"></a>ç¬¬4å¤©ï¼šRedisé…ç½®å’Œå·¥å…·ç±»</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br></pre></td><td class="code"><pre><span class="line">// 1. Redisé…ç½®ç±»</span><br><span class="line">package com.shophub.common.redis;</span><br><span class="line"></span><br><span class="line">import com.fasterxml.jackson.annotation.JsonAutoDetect;</span><br><span class="line">import com.fasterxml.jackson.annotation.JsonTypeInfo;</span><br><span class="line">import com.fasterxml.jackson.annotation.PropertyAccessor;</span><br><span class="line">import com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line">import com.fasterxml.jackson.databind.jsontype.impl.LaissezFaireSubTypeValidator;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.data.redis.connection.RedisConnectionFactory;</span><br><span class="line">import org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line">import org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;</span><br><span class="line">import org.springframework.data.redis.serializer.StringRedisSerializer;</span><br><span class="line"></span><br><span class="line">@Configuration</span><br><span class="line">public class RedisConfig &#123;</span><br><span class="line">    </span><br><span class="line">    @Bean</span><br><span class="line">    public RedisTemplate&lt;String, Object&gt; redisTemplate(RedisConnectionFactory factory) &#123;</span><br><span class="line">        RedisTemplate&lt;String, Object&gt; template = new RedisTemplate&lt;&gt;();</span><br><span class="line">        template.setConnectionFactory(factory);</span><br><span class="line">        </span><br><span class="line">        // é…ç½®åºåˆ—åŒ–</span><br><span class="line">        Jackson2JsonRedisSerializer&lt;Object&gt; jacksonSerializer = new Jackson2JsonRedisSerializer&lt;&gt;(Object.class);</span><br><span class="line">        ObjectMapper objectMapper = new ObjectMapper();</span><br><span class="line">        objectMapper.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);</span><br><span class="line">        objectMapper.activateDefaultTyping(</span><br><span class="line">            LaissezFaireSubTypeValidator.instance,</span><br><span class="line">            ObjectMapper.DefaultTyping.NON_FINAL,</span><br><span class="line">            JsonTypeInfo.As.PROPERTY</span><br><span class="line">        );</span><br><span class="line">        jacksonSerializer.setObjectMapper(objectMapper);</span><br><span class="line">        </span><br><span class="line">        StringRedisSerializer stringSerializer = new StringRedisSerializer();</span><br><span class="line">        </span><br><span class="line">        // keyå’Œhash keyä½¿ç”¨Stringåºåˆ—åŒ–</span><br><span class="line">        template.setKeySerializer(stringSerializer);</span><br><span class="line">        template.setHashKeySerializer(stringSerializer);</span><br><span class="line">        </span><br><span class="line">        // valueå’Œhash valueä½¿ç”¨Jacksonåºåˆ—åŒ–</span><br><span class="line">        template.setValueSerializer(jacksonSerializer);</span><br><span class="line">        template.setHashValueSerializer(jacksonSerializer);</span><br><span class="line">        </span><br><span class="line">        template.afterPropertiesSet();</span><br><span class="line">        return template;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 2. Rediså·¥å…·ç±»</span><br><span class="line">package com.shophub.common.redis;</span><br><span class="line"></span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.data.redis.core.*;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line">import java.util.*;</span><br><span class="line">import java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line">@Component</span><br><span class="line">public class RedisUtil &#123;</span><br><span class="line">    </span><br><span class="line">    @Autowired</span><br><span class="line">    private RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è®¾ç½®ç¼“å­˜</span><br><span class="line">     */</span><br><span class="line">    public void set(String key, Object value) &#123;</span><br><span class="line">        redisTemplate.opsForValue().set(key, value);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è®¾ç½®ç¼“å­˜å¹¶æŒ‡å®šè¿‡æœŸæ—¶é—´</span><br><span class="line">     */</span><br><span class="line">    public void set(String key, Object value, long time, TimeUnit timeUnit) &#123;</span><br><span class="line">        redisTemplate.opsForValue().set(key, value, time, timeUnit);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è·å–ç¼“å­˜</span><br><span class="line">     */</span><br><span class="line">    public Object get(String key) &#123;</span><br><span class="line">        return redisTemplate.opsForValue().get(key);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è·å–ç¼“å­˜å¹¶è½¬æ¢ä¸ºæŒ‡å®šç±»å‹</span><br><span class="line">     */</span><br><span class="line">    public &lt;T&gt; T get(String key, Class&lt;T&gt; clazz) &#123;</span><br><span class="line">        Object value = get(key);</span><br><span class="line">        return value == null ? null : clazz.cast(value);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆ é™¤ç¼“å­˜</span><br><span class="line">     */</span><br><span class="line">    public Boolean delete(String key) &#123;</span><br><span class="line">        return redisTemplate.delete(key);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ‰¹é‡åˆ é™¤</span><br><span class="line">     */</span><br><span class="line">    public Long delete(Collection&lt;String&gt; keys) &#123;</span><br><span class="line">        return redisTemplate.delete(keys);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è®¾ç½®è¿‡æœŸæ—¶é—´</span><br><span class="line">     */</span><br><span class="line">    public Boolean expire(String key, long time, TimeUnit timeUnit) &#123;</span><br><span class="line">        return redisTemplate.expire(key, time, timeUnit);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è·å–è¿‡æœŸæ—¶é—´</span><br><span class="line">     */</span><br><span class="line">    public Long getExpire(String key, TimeUnit timeUnit) &#123;</span><br><span class="line">        return redisTemplate.getExpire(key, timeUnit);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆ¤æ–­keyæ˜¯å¦å­˜åœ¨</span><br><span class="line">     */</span><br><span class="line">    public Boolean hasKey(String key) &#123;</span><br><span class="line">        return redisTemplate.hasKey(key);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * é€’å¢</span><br><span class="line">     */</span><br><span class="line">    public Long increment(String key, long delta) &#123;</span><br><span class="line">        return redisTemplate.opsForValue().increment(key, delta);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * é€’å‡</span><br><span class="line">     */</span><br><span class="line">    public Long decrement(String key, long delta) &#123;</span><br><span class="line">        return redisTemplate.opsForValue().decrement(key, delta);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * Hashæ“ä½œ - è®¾ç½®</span><br><span class="line">     */</span><br><span class="line">    public void hSet(String key, String hashKey, Object value) &#123;</span><br><span class="line">        redisTemplate.opsForHash().put(key, hashKey, value);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * Hashæ“ä½œ - è·å–</span><br><span class="line">     */</span><br><span class="line">    public Object hGet(String key, String hashKey) &#123;</span><br><span class="line">        return redisTemplate.opsForHash().get(key, hashKey);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * Hashæ“ä½œ - è·å–æ‰€æœ‰</span><br><span class="line">     */</span><br><span class="line">    public Map&lt;Object, Object&gt; hGetAll(String key) &#123;</span><br><span class="line">        return redisTemplate.opsForHash().entries(key);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * Listæ“ä½œ - ä»å·¦è¾¹æ·»åŠ </span><br><span class="line">     */</span><br><span class="line">    public Long lPush(String key, Object value) &#123;</span><br><span class="line">        return redisTemplate.opsForList().leftPush(key, value);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * Listæ“ä½œ - ä»å³è¾¹æ·»åŠ </span><br><span class="line">     */</span><br><span class="line">    public Long rPush(String key, Object value) &#123;</span><br><span class="line">        return redisTemplate.opsForList().rightPush(key, value);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * Setæ“ä½œ - æ·»åŠ </span><br><span class="line">     */</span><br><span class="line">    public Long sAdd(String key, Object... values) &#123;</span><br><span class="line">        return redisTemplate.opsForSet().add(key, values);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * Setæ“ä½œ - åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span><br><span class="line">     */</span><br><span class="line">    public Boolean sIsMember(String key, Object value) &#123;</span><br><span class="line">        return redisTemplate.opsForSet().isMember(key, value);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * ZSetæ“ä½œ - æ·»åŠ </span><br><span class="line">     */</span><br><span class="line">    public Boolean zAdd(String key, Object value, double score) &#123;</span><br><span class="line">        return redisTemplate.opsForZSet().add(key, value, score);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆ†å¸ƒå¼é” - è·å–é”</span><br><span class="line">     */</span><br><span class="line">    public Boolean tryLock(String lockKey, String requestId, long expireTime) &#123;</span><br><span class="line">        return redisTemplate.opsForValue().setIfAbsent(</span><br><span class="line">            lockKey, </span><br><span class="line">            requestId, </span><br><span class="line">            expireTime, </span><br><span class="line">            TimeUnit.MILLISECONDS</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆ†å¸ƒå¼é” - é‡Šæ”¾é”</span><br><span class="line">     */</span><br><span class="line">    public Boolean releaseLock(String lockKey, String requestId) &#123;</span><br><span class="line">        String script = &quot;if redis.call(&#x27;get&#x27;, KEYS[1]) == ARGV[1] then &quot; +</span><br><span class="line">                       &quot;return redis.call(&#x27;del&#x27;, KEYS[1]) &quot; +</span><br><span class="line">                       &quot;else return 0 end&quot;;</span><br><span class="line">        DefaultRedisScript&lt;Long&gt; redisScript = new DefaultRedisScript&lt;&gt;();</span><br><span class="line">        redisScript.setScriptText(script);</span><br><span class="line">        redisScript.setResultType(Long.class);</span><br><span class="line">        </span><br><span class="line">        Long result = redisTemplate.execute(</span><br><span class="line">            redisScript, </span><br><span class="line">            Collections.singletonList(lockKey), </span><br><span class="line">            requestId</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        return result != null &amp;&amp; result == 1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç¬¬5å¤©ï¼šè®¤è¯æˆæƒä¸­å¿ƒï¼ˆshophub-authï¼‰å®ç°"><a href="#ç¬¬5å¤©ï¼šè®¤è¯æˆæƒä¸­å¿ƒï¼ˆshophub-authï¼‰å®ç°" class="headerlink" title="ç¬¬5å¤©ï¼šè®¤è¯æˆæƒä¸­å¿ƒï¼ˆshophub-authï¼‰å®ç°"></a>ç¬¬5å¤©ï¼šè®¤è¯æˆæƒä¸­å¿ƒï¼ˆshophub-authï¼‰å®ç°</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br></pre></td><td class="code"><pre><span class="line">// 1. JWTå·¥å…·ç±»</span><br><span class="line">package com.shophub.auth.security;</span><br><span class="line"></span><br><span class="line">import io.jsonwebtoken.*;</span><br><span class="line">import io.jsonwebtoken.security.Keys;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.springframework.beans.factory.annotation.Value;</span><br><span class="line">import org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line">import javax.crypto.SecretKey;</span><br><span class="line">import java.util.Date;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@Component</span><br><span class="line">public class JwtTokenUtil &#123;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;jwt.secret&#125;&quot;)</span><br><span class="line">    private String secret;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;jwt.expiration&#125;&quot;)</span><br><span class="line">    private Long expiration;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;jwt.header&#125;&quot;)</span><br><span class="line">    private String header;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * ç”Ÿæˆtoken</span><br><span class="line">     */</span><br><span class="line">    public String generateToken(UserDetails userDetails) &#123;</span><br><span class="line">        Map&lt;String, Object&gt; claims = new HashMap&lt;&gt;();</span><br><span class="line">        claims.put(&quot;username&quot;, userDetails.getUsername());</span><br><span class="line">        claims.put(&quot;created&quot;, new Date());</span><br><span class="line">        return generateToken(claims);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * ä»claimsç”Ÿæˆtoken</span><br><span class="line">     */</span><br><span class="line">    public String generateToken(Map&lt;String, Object&gt; claims) &#123;</span><br><span class="line">        SecretKey key = Keys.hmacShaKeyFor(secret.getBytes());</span><br><span class="line">        return Jwts.builder()</span><br><span class="line">                .setClaims(claims)</span><br><span class="line">                .setExpiration(generateExpirationDate())</span><br><span class="line">                .signWith(key, SignatureAlgorithm.HS256)</span><br><span class="line">                .compact();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * ä»tokenè·å–ç”¨æˆ·å</span><br><span class="line">     */</span><br><span class="line">    public String getUsernameFromToken(String token) &#123;</span><br><span class="line">        Claims claims = getClaimsFromToken(token);</span><br><span class="line">        return claims.get(&quot;username&quot;, String.class);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * ä»tokenè·å–claims</span><br><span class="line">     */</span><br><span class="line">    public Claims getClaimsFromToken(String token) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            SecretKey key = Keys.hmacShaKeyFor(secret.getBytes());</span><br><span class="line">            return Jwts.parserBuilder()</span><br><span class="line">                    .setSigningKey(key)</span><br><span class="line">                    .build()</span><br><span class="line">                    .parseClaimsJws(token)</span><br><span class="line">                    .getBody();</span><br><span class="line">        &#125; catch (ExpiredJwtException e) &#123;</span><br><span class="line">            log.warn(&quot;Tokenå·²è¿‡æœŸ&quot;, e);</span><br><span class="line">            return e.getClaims();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;è§£æTokenå¤±è´¥&quot;, e);</span><br><span class="line">            throw new JwtException(&quot;Tokenè§£æå¤±è´¥&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * éªŒè¯tokenæ˜¯å¦æœ‰æ•ˆ</span><br><span class="line">     */</span><br><span class="line">    public boolean validateToken(String token, UserDetails userDetails) &#123;</span><br><span class="line">        String username = getUsernameFromToken(token);</span><br><span class="line">        return username.equals(userDetails.getUsername()) &amp;&amp; !isTokenExpired(token);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆ¤æ–­tokenæ˜¯å¦è¿‡æœŸ</span><br><span class="line">     */</span><br><span class="line">    public boolean isTokenExpired(String token) &#123;</span><br><span class="line">        Date expiration = getExpirationDateFromToken(token);</span><br><span class="line">        return expiration.before(new Date());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è·å–tokenè¿‡æœŸæ—¶é—´</span><br><span class="line">     */</span><br><span class="line">    public Date getExpirationDateFromToken(String token) &#123;</span><br><span class="line">        Claims claims = getClaimsFromToken(token);</span><br><span class="line">        return claims.getExpiration();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * ç”Ÿæˆè¿‡æœŸæ—¶é—´</span><br><span class="line">     */</span><br><span class="line">    private Date generateExpirationDate() &#123;</span><br><span class="line">        return new Date(System.currentTimeMillis() + expiration * 1000);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 2. Spring Securityé…ç½®</span><br><span class="line">package com.shophub.auth.security;</span><br><span class="line"></span><br><span class="line">import lombok.RequiredArgsConstructor;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line">import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;</span><br><span class="line">import org.springframework.security.config.annotation.method.configuration.EnableMethodSecurity;</span><br><span class="line">import org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line">import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line">import org.springframework.security.config.http.SessionCreationPolicy;</span><br><span class="line">import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class="line">import org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line">import org.springframework.security.web.SecurityFilterChain;</span><br><span class="line">import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;</span><br><span class="line">import org.springframework.web.cors.CorsConfiguration;</span><br><span class="line">import org.springframework.web.cors.CorsConfigurationSource;</span><br><span class="line">import org.springframework.web.cors.UrlBasedCorsConfigurationSource;</span><br><span class="line"></span><br><span class="line">import java.util.Arrays;</span><br><span class="line"></span><br><span class="line">@Configuration</span><br><span class="line">@EnableWebSecurity</span><br><span class="line">@EnableMethodSecurity</span><br><span class="line">@RequiredArgsConstructor</span><br><span class="line">public class SecurityConfig &#123;</span><br><span class="line">    </span><br><span class="line">    private final JwtAuthenticationEntryPoint jwtAuthenticationEntryPoint;</span><br><span class="line">    private final JwtAuthenticationFilter jwtAuthenticationFilter;</span><br><span class="line">    </span><br><span class="line">    @Bean</span><br><span class="line">    public PasswordEncoder passwordEncoder() &#123;</span><br><span class="line">        return new BCryptPasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Bean</span><br><span class="line">    public AuthenticationManager authenticationManager(</span><br><span class="line">            AuthenticationConfiguration authConfig) throws Exception &#123;</span><br><span class="line">        return authConfig.getAuthenticationManager();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Bean</span><br><span class="line">    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception &#123;</span><br><span class="line">        http</span><br><span class="line">            // ç¦ç”¨CSRF</span><br><span class="line">            .csrf(csrf -&gt; csrf.disable())</span><br><span class="line">            </span><br><span class="line">            // é…ç½®CORS</span><br><span class="line">            .cors(cors -&gt; cors.configurationSource(corsConfigurationSource()))</span><br><span class="line">            </span><br><span class="line">            // é…ç½®å¼‚å¸¸å¤„ç†</span><br><span class="line">            .exceptionHandling(exception -&gt; </span><br><span class="line">                exception.authenticationEntryPoint(jwtAuthenticationEntryPoint))</span><br><span class="line">            </span><br><span class="line">            // é…ç½®Sessionç®¡ç†ä¸ºæ— çŠ¶æ€</span><br><span class="line">            .sessionManagement(session -&gt; </span><br><span class="line">                session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))</span><br><span class="line">            </span><br><span class="line">            // é…ç½®æƒé™è§„åˆ™</span><br><span class="line">            .authorizeHttpRequests(auth -&gt; auth</span><br><span class="line">                // å…¬å¼€æ¥å£</span><br><span class="line">                .requestMatchers(</span><br><span class="line">                    &quot;/api/auth/login&quot;,</span><br><span class="line">                    &quot;/api/auth/register&quot;,</span><br><span class="line">                    &quot;/api/auth/captcha&quot;,</span><br><span class="line">                    &quot;/swagger-ui/**&quot;,</span><br><span class="line">                    &quot;/v3/api-docs/**&quot;</span><br><span class="line">                ).permitAll()</span><br><span class="line">                // å…¶ä»–æ¥å£éœ€è¦è®¤è¯</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            // æ·»åŠ JWTè¿‡æ»¤å™¨</span><br><span class="line">            .addFilterBefore(jwtAuthenticationFilter, </span><br><span class="line">                UsernamePasswordAuthenticationFilter.class);</span><br><span class="line">        </span><br><span class="line">        return http.build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Bean</span><br><span class="line">    public CorsConfigurationSource corsConfigurationSource() &#123;</span><br><span class="line">        CorsConfiguration configuration = new CorsConfiguration();</span><br><span class="line">        configuration.setAllowedOriginPatterns(Arrays.asList(&quot;*&quot;));</span><br><span class="line">        configuration.setAllowedMethods(Arrays.asList(</span><br><span class="line">            &quot;GET&quot;, &quot;POST&quot;, &quot;PUT&quot;, &quot;DELETE&quot;, &quot;OPTIONS&quot;</span><br><span class="line">        ));</span><br><span class="line">        configuration.setAllowedHeaders(Arrays.asList(&quot;*&quot;));</span><br><span class="line">        configuration.setAllowCredentials(true);</span><br><span class="line">        configuration.setMaxAge(3600L);</span><br><span class="line">        </span><br><span class="line">        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();</span><br><span class="line">        source.registerCorsConfiguration(&quot;/**&quot;, configuration);</span><br><span class="line">        return source;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 3. ç”¨æˆ·è¯¦æƒ…æœåŠ¡</span><br><span class="line">package com.shophub.auth.service;</span><br><span class="line"></span><br><span class="line">import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;</span><br><span class="line">import com.shophub.auth.entity.SysUser;</span><br><span class="line">import com.shophub.auth.mapper.SysUserMapper;</span><br><span class="line">import lombok.RequiredArgsConstructor;</span><br><span class="line">import org.springframework.security.core.authority.SimpleGrantedAuthority;</span><br><span class="line">import org.springframework.security.core.userdetails.User;</span><br><span class="line">import org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line">import org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line">import org.springframework.security.core.userdetails.UsernameNotFoundException;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">@Service</span><br><span class="line">@RequiredArgsConstructor</span><br><span class="line">public class UserDetailsServiceImpl implements UserDetailsService &#123;</span><br><span class="line">    </span><br><span class="line">    private final SysUserMapper userMapper;</span><br><span class="line">    private final PermissionService permissionService;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException &#123;</span><br><span class="line">        // æŸ¥è¯¢ç”¨æˆ·</span><br><span class="line">        QueryWrapper&lt;SysUser&gt; wrapper = new QueryWrapper&lt;&gt;();</span><br><span class="line">        wrapper.eq(&quot;username&quot;, username);</span><br><span class="line">        SysUser sysUser = userMapper.selectOne(wrapper);</span><br><span class="line">        </span><br><span class="line">        if (sysUser == null) &#123;</span><br><span class="line">            throw new UsernameNotFoundException(&quot;ç”¨æˆ·ä¸å­˜åœ¨&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        if (!sysUser.getStatus()) &#123;</span><br><span class="line">            throw new UsernameNotFoundException(&quot;ç”¨æˆ·å·²è¢«ç¦ç”¨&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // æŸ¥è¯¢ç”¨æˆ·æƒé™</span><br><span class="line">        List&lt;String&gt; permissions = permissionService.getUserPermissions(sysUser.getId());</span><br><span class="line">        List&lt;SimpleGrantedAuthority&gt; authorities = new ArrayList&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        for (String permission : permissions) &#123;</span><br><span class="line">            authorities.add(new SimpleGrantedAuthority(permission));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return new User(</span><br><span class="line">            sysUser.getUsername(),</span><br><span class="line">            sysUser.getPassword(),</span><br><span class="line">            authorities</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 4. è®¤è¯æ§åˆ¶å™¨</span><br><span class="line">package com.shophub.auth.controller;</span><br><span class="line"></span><br><span class="line">import com.shophub.auth.security.JwtTokenUtil;</span><br><span class="line">import com.shophub.auth.service.AuthService;</span><br><span class="line">import com.shophub.common.result.Result;</span><br><span class="line">import lombok.RequiredArgsConstructor;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line">import javax.validation.Valid;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;/api/auth&quot;)</span><br><span class="line">@RequiredArgsConstructor</span><br><span class="line">public class AuthController &#123;</span><br><span class="line">    </span><br><span class="line">    private final AuthService authService;</span><br><span class="line">    private final JwtTokenUtil jwtTokenUtil;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * ç”¨æˆ·ç™»å½•</span><br><span class="line">     */</span><br><span class="line">    @PostMapping(&quot;/login&quot;)</span><br><span class="line">    public Result&lt;Map&lt;String, String&gt;&gt; login(@RequestBody @Valid LoginRequest request) &#123;</span><br><span class="line">        log.info(&quot;ç”¨æˆ·ç™»å½•ï¼š&#123;&#125;&quot;, request.getUsername());</span><br><span class="line">        </span><br><span class="line">        String token = authService.login(</span><br><span class="line">            request.getUsername(), </span><br><span class="line">            request.getPassword()</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        return Result.success(Map.of(</span><br><span class="line">            &quot;token&quot;, token,</span><br><span class="line">            &quot;tokenType&quot;, &quot;Bearer&quot;</span><br><span class="line">        ));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * ç”¨æˆ·æ³¨å†Œ</span><br><span class="line">     */</span><br><span class="line">    @PostMapping(&quot;/register&quot;)</span><br><span class="line">    public Result&lt;Void&gt; register(@RequestBody @Valid RegisterRequest request) &#123;</span><br><span class="line">        log.info(&quot;ç”¨æˆ·æ³¨å†Œï¼š&#123;&#125;&quot;, request.getUsername());</span><br><span class="line">        </span><br><span class="line">        authService.register(request);</span><br><span class="line">        return Result.success();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯</span><br><span class="line">     */</span><br><span class="line">    @GetMapping(&quot;/current-user&quot;)</span><br><span class="line">    public Result&lt;UserInfo&gt; getCurrentUser() &#123;</span><br><span class="line">        UserInfo userInfo = authService.getCurrentUserInfo();</span><br><span class="line">        return Result.success(userInfo);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆ·æ–°token</span><br><span class="line">     */</span><br><span class="line">    @PostMapping(&quot;/refresh-token&quot;)</span><br><span class="line">    public Result&lt;Map&lt;String, String&gt;&gt; refreshToken(@RequestParam String refreshToken) &#123;</span><br><span class="line">        String newToken = authService.refreshToken(refreshToken);</span><br><span class="line">        return Result.success(Map.of(</span><br><span class="line">            &quot;token&quot;, newToken,</span><br><span class="line">            &quot;tokenType&quot;, &quot;Bearer&quot;</span><br><span class="line">        ));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * é€€å‡ºç™»å½•</span><br><span class="line">     */</span><br><span class="line">    @PostMapping(&quot;/logout&quot;)</span><br><span class="line">    public Result&lt;Void&gt; logout() &#123;</span><br><span class="line">        authService.logout();</span><br><span class="line">        return Result.success();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ğŸš€-ç¬¬äºŒå¤©å¼€å§‹çš„è®¡åˆ’"><a href="#ğŸš€-ç¬¬äºŒå¤©å¼€å§‹çš„è®¡åˆ’" class="headerlink" title="ğŸš€ ç¬¬äºŒå¤©å¼€å§‹çš„è®¡åˆ’"></a>ğŸš€ ç¬¬äºŒå¤©å¼€å§‹çš„è®¡åˆ’</h2><h3 id="ç¬¬6-7å¤©ï¼šç½‘å…³æœåŠ¡ï¼ˆshophub-gatewayï¼‰"><a href="#ç¬¬6-7å¤©ï¼šç½‘å…³æœåŠ¡ï¼ˆshophub-gatewayï¼‰" class="headerlink" title="ç¬¬6-7å¤©ï¼šç½‘å…³æœåŠ¡ï¼ˆshophub-gatewayï¼‰"></a>ç¬¬6-7å¤©ï¼šç½‘å…³æœåŠ¡ï¼ˆshophub-gatewayï¼‰</h3><ul><li>Spring Cloud Gatewayé…ç½®</li><li>åŠ¨æ€è·¯ç”±</li><li>é™æµç†”æ–­</li><li>é‰´æƒè¿‡æ»¤å™¨</li></ul><h3 id="ç¬¬8-9å¤©ï¼šå•†å“æœåŠ¡ï¼ˆshophub-productï¼‰"><a href="#ç¬¬8-9å¤©ï¼šå•†å“æœåŠ¡ï¼ˆshophub-productï¼‰" class="headerlink" title="ç¬¬8-9å¤©ï¼šå•†å“æœåŠ¡ï¼ˆshophub-productï¼‰"></a>ç¬¬8-9å¤©ï¼šå•†å“æœåŠ¡ï¼ˆshophub-productï¼‰</h3><ul><li>MyBatis Plusé›†æˆ</li><li>å•†å“CRUD</li><li>æ–‡ä»¶ä¸Šä¼ ä¸‹è½½ï¼ˆæ–­ç‚¹ç»­ä¼ ï¼‰</li><li>å•†å“åˆ†ç±»ç®¡ç†</li></ul><h3 id="ç¬¬10-11å¤©ï¼šæœç´¢æœåŠ¡ï¼ˆshophub-searchï¼‰"><a href="#ç¬¬10-11å¤©ï¼šæœç´¢æœåŠ¡ï¼ˆshophub-searchï¼‰" class="headerlink" title="ç¬¬10-11å¤©ï¼šæœç´¢æœåŠ¡ï¼ˆshophub-searchï¼‰"></a>ç¬¬10-11å¤©ï¼šæœç´¢æœåŠ¡ï¼ˆshophub-searchï¼‰</h3><ul><li>Elasticsearché›†æˆ</li><li>IKåˆ†è¯å™¨é…ç½®</li><li>å•†å“æœç´¢åŠŸèƒ½</li><li>æœç´¢å»ºè®®å’Œè‡ªåŠ¨è¡¥å…¨</li></ul><h3 id="ç¬¬12-13å¤©ï¼šè®¢å•æœåŠ¡ï¼ˆshophub-orderï¼‰"><a href="#ç¬¬12-13å¤©ï¼šè®¢å•æœåŠ¡ï¼ˆshophub-orderï¼‰" class="headerlink" title="ç¬¬12-13å¤©ï¼šè®¢å•æœåŠ¡ï¼ˆshophub-orderï¼‰"></a>ç¬¬12-13å¤©ï¼šè®¢å•æœåŠ¡ï¼ˆshophub-orderï¼‰</h3><ul><li>åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆSeataï¼‰</li><li>è®¢å•çŠ¶æ€æœº</li><li>åº“å­˜æ‰£å‡</li><li>è¶…æ—¶å–æ¶ˆè®¢å•</li></ul><h3 id="ç¬¬14-15å¤©ï¼šæ”¯ä»˜å’Œé€šçŸ¥æœåŠ¡"><a href="#ç¬¬14-15å¤©ï¼šæ”¯ä»˜å’Œé€šçŸ¥æœåŠ¡" class="headerlink" title="ç¬¬14-15å¤©ï¼šæ”¯ä»˜å’Œé€šçŸ¥æœåŠ¡"></a>ç¬¬14-15å¤©ï¼šæ”¯ä»˜å’Œé€šçŸ¥æœåŠ¡</h3><ul><li>å¾®ä¿¡&#x2F;æ”¯ä»˜å®æ”¯ä»˜é›†æˆ</li><li>WebSocketå®æ—¶é€šçŸ¥</li><li>æ¶ˆæ¯é˜Ÿåˆ—å¤„ç†</li></ul><p>ç”±äºç¯‡å¹…é™åˆ¶ï¼Œæˆ‘å…ˆå®Œæˆç¬¬ä¸€é˜¶æ®µçš„åŸºç¡€æ¶æ„ã€‚æ¥ä¸‹æ¥ï¼Œè¯·å‘Šè¯‰æˆ‘ï¼š</p><ol><li>æ˜¯å¦éœ€è¦æˆ‘ç»§ç»­å®ç°ç¬¬äºŒé˜¶æ®µï¼ˆç½‘å…³æœåŠ¡ï¼‰ï¼Ÿ</li><li>æˆ–è€…ä½ æƒ³å…ˆçœ‹æŸä¸ªç‰¹å®šæ¨¡å—çš„å®ç°ï¼Ÿ</li><li>å¯¹å·²å®ç°çš„éƒ¨åˆ†æœ‰ä»€ä¹ˆç–‘é—®æˆ–éœ€è¦è°ƒæ•´çš„åœ°æ–¹ï¼Ÿ</li></ol><p>æˆ‘ä¼šæŒ‰ç…§è¿™ä¸ªèŠ‚å¥ç»§ç»­å®ç°æ‰€æœ‰æ¨¡å—ï¼Œä¿è¯æ¯ä¸ªæŠ€æœ¯ç‚¹éƒ½æœ‰å……åˆ†çš„å®è·µä»£ç ã€‚</p><p>ç»§ç»­å®ç°ç¬¬äºŒé˜¶æ®µ</p><p>æˆ‘ä»¬å°†ç»§ç»­å®ç°ç¬¬äºŒé˜¶æ®µï¼šç½‘å…³æœåŠ¡ï¼ˆshophub-gatewayï¼‰å’Œæ³¨å†Œä¸­å¿ƒï¼ˆä½¿ç”¨Nacosï¼‰ã€‚ç”±äºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯Spring Cloudï¼Œæˆ‘ä»¬å°†ä½¿ç”¨Spring Cloud Gatewayä½œä¸ºç½‘å…³ï¼ŒNacosä½œä¸ºæœåŠ¡æ³¨å†Œä¸å‘ç°ä¸­å¿ƒã€‚</p><h2 id="ç¬¬6å¤©ï¼šNacosæœåŠ¡æ³¨å†Œä¸å‘ç°"><a href="#ç¬¬6å¤©ï¼šNacosæœåŠ¡æ³¨å†Œä¸å‘ç°" class="headerlink" title="ç¬¬6å¤©ï¼šNacosæœåŠ¡æ³¨å†Œä¸å‘ç°"></a>ç¬¬6å¤©ï¼šNacosæœåŠ¡æ³¨å†Œä¸å‘ç°</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åœ¨çˆ¶å·¥ç¨‹ä¸­å¼•å…¥Nacosçš„ä¾èµ–ï¼Œå¹¶åˆ›å»ºç½‘å…³æ¨¡å—ã€‚</p><h3 id="1-åœ¨çˆ¶å·¥ç¨‹ä¸­ç®¡ç†Nacoså’ŒSpring-Cloud-Gatewayçš„ç‰ˆæœ¬"><a href="#1-åœ¨çˆ¶å·¥ç¨‹ä¸­ç®¡ç†Nacoså’ŒSpring-Cloud-Gatewayçš„ç‰ˆæœ¬" class="headerlink" title="1. åœ¨çˆ¶å·¥ç¨‹ä¸­ç®¡ç†Nacoså’ŒSpring Cloud Gatewayçš„ç‰ˆæœ¬"></a>1. åœ¨çˆ¶å·¥ç¨‹ä¸­ç®¡ç†Nacoså’ŒSpring Cloud Gatewayçš„ç‰ˆæœ¬</h3><p>åœ¨çˆ¶å·¥ç¨‹çš„pom.xmlä¸­ï¼Œæˆ‘ä»¬å·²ç»é€šè¿‡spring-cloud-dependenciesç®¡ç†äº†Spring Cloudçš„ç‰ˆæœ¬ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦åœ¨å­æ¨¡å—ä¸­å¼•å…¥å…·ä½“ä¾èµ–å³å¯ã€‚</p><h3 id="2-åˆ›å»ºç½‘å…³æ¨¡å—ï¼ˆshophub-gatewayï¼‰"><a href="#2-åˆ›å»ºç½‘å…³æ¨¡å—ï¼ˆshophub-gatewayï¼‰" class="headerlink" title="2. åˆ›å»ºç½‘å…³æ¨¡å—ï¼ˆshophub-gatewayï¼‰"></a>2. åˆ›å»ºç½‘å…³æ¨¡å—ï¼ˆshophub-gatewayï¼‰</h3><p>åœ¨çˆ¶å·¥ç¨‹ä¸‹åˆ›å»ºå­æ¨¡å—shophub-gatewayã€‚</p><h4 id="2-1-ç½‘å…³æ¨¡å—çš„pom-xml"><a href="#2-1-ç½‘å…³æ¨¡å—çš„pom-xml" class="headerlink" title="2.1 ç½‘å…³æ¨¡å—çš„pom.xml"></a>2.1 ç½‘å…³æ¨¡å—çš„pom.xml</h4><p>xml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;</span><br><span class="line">         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 </span><br><span class="line">         http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;com.shophub&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;shophub-parent&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;1.0.0&lt;/version&gt;</span><br><span class="line">    &lt;/parent&gt;</span><br><span class="line"></span><br><span class="line">    &lt;artifactId&gt;shophub-gateway&lt;/artifactId&gt;</span><br><span class="line"></span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;maven.compiler.source&gt;17&lt;/maven.compiler.source&gt;</span><br><span class="line">        &lt;maven.compiler.target&gt;17&lt;/maven.compiler.target&gt;</span><br><span class="line">    &lt;/properties&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;!-- Spring Cloud Gateway --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- NacosæœåŠ¡å‘ç° --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- Spring Boot Actuator --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- é‰´æƒä¾èµ–ï¼šæˆ‘ä»¬éœ€è¦ä»auth-serviceè·å–ç”¨æˆ·ä¿¡æ¯ï¼Œæ‰€ä»¥éœ€è¦webfluxçš„ä¾èµ– --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-webflux&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- é…ç½®ä¸­å¿ƒï¼ˆå¯é€‰ï¼‰ --&gt;</span><br><span class="line">        &lt;!-- &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-config&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt; --&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- é™æµä¾èµ–ï¼šä½¿ç”¨Redisè¿›è¡Œé™æµ --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-data-redis-reactive&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- ç›‘æ§ä¾èµ– --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;io.micrometer&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;micrometer-registry-prometheus&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- æ—¥å¿— --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-logging&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- æµ‹è¯• --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">        &lt;/plugins&gt;</span><br><span class="line">    &lt;/build&gt;</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure><h4 id="2-2-ç½‘å…³é…ç½®æ–‡ä»¶ï¼ˆapplication-ymlï¼‰"><a href="#2-2-ç½‘å…³é…ç½®æ–‡ä»¶ï¼ˆapplication-ymlï¼‰" class="headerlink" title="2.2 ç½‘å…³é…ç½®æ–‡ä»¶ï¼ˆapplication.ymlï¼‰"></a>2.2 ç½‘å…³é…ç½®æ–‡ä»¶ï¼ˆapplication.ymlï¼‰</h4><p>åœ¨resourcesç›®å½•ä¸‹åˆ›å»ºapplication.ymlï¼š</p><p>yaml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8080</span><br><span class="line"></span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: shophub-gateway</span><br><span class="line">  cloud:</span><br><span class="line">    nacos:</span><br><span class="line">      discovery:</span><br><span class="line">        server-addr: localhost:8848  # NacosæœåŠ¡åœ°å€</span><br><span class="line">        namespace: public</span><br><span class="line">    gateway:</span><br><span class="line">      discovery:</span><br><span class="line">        locator:</span><br><span class="line">          enabled: true  # å¼€å¯ä»æ³¨å†Œä¸­å¿ƒåŠ¨æ€åˆ›å»ºè·¯ç”±çš„åŠŸèƒ½</span><br><span class="line">      routes:</span><br><span class="line">        - id: auth-service</span><br><span class="line">          uri: lb://shophub-auth  # è´Ÿè½½å‡è¡¡åˆ°auth-service</span><br><span class="line">          predicates:</span><br><span class="line">            - Path=/api/auth/**</span><br><span class="line">          filters:</span><br><span class="line">            - StripPrefix=1  # å»æ‰è·¯å¾„ä¸­çš„ç¬¬ä¸€ä¸ªéƒ¨åˆ†ï¼ˆå³å»æ‰/apiï¼‰</span><br><span class="line">            - name: RequestRateLimiter</span><br><span class="line">              args:</span><br><span class="line">                redis-rate-limiter.replenishRate: 10   # æ¯ç§’å…è®¸å¤„ç†çš„è¯·æ±‚æ•°</span><br><span class="line">                redis-rate-limiter.burstCapacity: 20   # ä»¤ç‰Œæ¡¶çš„å®¹é‡</span><br><span class="line">                key-resolver: &quot;#&#123;@userKeyResolver&#125;&quot;    # ç”¨äºé™æµçš„é”®è§£æå™¨</span><br><span class="line"></span><br><span class="line">        - id: product-service</span><br><span class="line">          uri: lb://shophub-product</span><br><span class="line">          predicates:</span><br><span class="line">            - Path=/api/product/**</span><br><span class="line">          filters:</span><br><span class="line">            - StripPrefix=1</span><br><span class="line"></span><br><span class="line">        - id: order-service</span><br><span class="line">          uri: lb://shophub-order</span><br><span class="line">          predicates:</span><br><span class="line">            - Path=/api/order/**</span><br><span class="line">          filters:</span><br><span class="line">            - StripPrefix=1</span><br><span class="line"></span><br><span class="line">        - id: inventory-service</span><br><span class="line">          uri: lb://shophub-inventory</span><br><span class="line">          predicates:</span><br><span class="line">            - Path=/api/inventory/**</span><br><span class="line">          filters:</span><br><span class="line">            - StripPrefix=1</span><br><span class="line"></span><br><span class="line">        - id: search-service</span><br><span class="line">          uri: lb://shophub-search</span><br><span class="line">          predicates:</span><br><span class="line">            - Path=/api/search/**</span><br><span class="line">          filters:</span><br><span class="line">            - StripPrefix=1</span><br><span class="line"></span><br><span class="line">        - id: payment-service</span><br><span class="line">          uri: lb://shophub-payment</span><br><span class="line">          predicates:</span><br><span class="line">            - Path=/api/payment/**</span><br><span class="line">          filters:</span><br><span class="line">            - StripPrefix=1</span><br><span class="line"></span><br><span class="line">        - id: notification-service</span><br><span class="line">          uri: lb://shophub-notification</span><br><span class="line">          predicates:</span><br><span class="line">            - Path=/api/notification/**</span><br><span class="line">          filters:</span><br><span class="line">            - StripPrefix=1</span><br><span class="line"></span><br><span class="line">  # Redisé…ç½®</span><br><span class="line">  redis:</span><br><span class="line">    host: localhost</span><br><span class="line">    port: 6379</span><br><span class="line">    database: 0</span><br><span class="line">    password:</span><br><span class="line">    timeout: 5000</span><br><span class="line"></span><br><span class="line"># ç›‘æ§ç«¯ç‚¹</span><br><span class="line">management:</span><br><span class="line">  endpoints:</span><br><span class="line">    web:</span><br><span class="line">      exposure:</span><br><span class="line">        include: health,info,metrics,prometheus,gateway</span><br><span class="line">  metrics:</span><br><span class="line">    tags:</span><br><span class="line">      application: $&#123;spring.application.name&#125;</span><br><span class="line"></span><br><span class="line"># æ—¥å¿—é…ç½®</span><br><span class="line">logging:</span><br><span class="line">  level:</span><br><span class="line">    com.shophub.gateway: DEBUG</span><br><span class="line">    org.springframework.cloud.gateway: DEBUG</span><br></pre></td></tr></table></figure><h4 id="2-3-ç½‘å…³ä¸»å¯åŠ¨ç±»"><a href="#2-3-ç½‘å…³ä¸»å¯åŠ¨ç±»" class="headerlink" title="2.3 ç½‘å…³ä¸»å¯åŠ¨ç±»"></a>2.3 ç½‘å…³ä¸»å¯åŠ¨ç±»</h4><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.gateway;</span><br><span class="line"></span><br><span class="line">import org.springframework.boot.SpringApplication;</span><br><span class="line">import org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line">import org.springframework.cloud.client.discovery.EnableDiscoveryClient;</span><br><span class="line"></span><br><span class="line">@SpringBootApplication</span><br><span class="line">@EnableDiscoveryClient</span><br><span class="line">public class GatewayApplication &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(GatewayApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-4-é™æµé…ç½®ç±»"><a href="#2-4-é™æµé…ç½®ç±»" class="headerlink" title="2.4 é™æµé…ç½®ç±»"></a>2.4 é™æµé…ç½®ç±»</h4><p>æˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªKeyResolverç”¨äºé™æµï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ç”¨æˆ·IPä½œä¸ºé™æµçš„é”®ã€‚</p><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.gateway.config;</span><br><span class="line"></span><br><span class="line">import org.springframework.cloud.gateway.filter.ratelimit.KeyResolver;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line">import java.util.Objects;</span><br><span class="line"></span><br><span class="line">@Configuration</span><br><span class="line">public class RateLimiterConfig &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * æ ¹æ®è¯·æ±‚çš„IPè¿›è¡Œé™æµ</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public KeyResolver ipKeyResolver() &#123;</span><br><span class="line">        return exchange -&gt; Mono.just(</span><br><span class="line">            Objects.requireNonNull(exchange.getRequest().getRemoteAddress())</span><br><span class="line">                   .getAddress().getHostAddress()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-5-å…¨å±€è¿‡æ»¤å™¨ï¼ˆé‰´æƒè¿‡æ»¤å™¨ï¼‰"><a href="#2-5-å…¨å±€è¿‡æ»¤å™¨ï¼ˆé‰´æƒè¿‡æ»¤å™¨ï¼‰" class="headerlink" title="2.5 å…¨å±€è¿‡æ»¤å™¨ï¼ˆé‰´æƒè¿‡æ»¤å™¨ï¼‰"></a>2.5 å…¨å±€è¿‡æ»¤å™¨ï¼ˆé‰´æƒè¿‡æ»¤å™¨ï¼‰</h4><p>æˆ‘ä»¬éœ€è¦åœ¨ç½‘å…³å±‚è¿›è¡Œé‰´æƒï¼ŒéªŒè¯Tokençš„æœ‰æ•ˆæ€§ã€‚è¿™é‡Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå…¨å±€è¿‡æ»¤å™¨ï¼Œå¯¹éœ€è¦è®¤è¯çš„è¯·æ±‚è¿›è¡ŒTokenéªŒè¯ã€‚</p><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.gateway.filter;</span><br><span class="line"></span><br><span class="line">import com.fasterxml.jackson.core.JsonProcessingException;</span><br><span class="line">import com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line">import com.shophub.common.result.Result;</span><br><span class="line">import com.shophub.common.result.ResultCode;</span><br><span class="line">import lombok.RequiredArgsConstructor;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.springframework.cloud.gateway.filter.GatewayFilterChain;</span><br><span class="line">import org.springframework.cloud.gateway.filter.GlobalFilter;</span><br><span class="line">import org.springframework.core.Ordered;</span><br><span class="line">import org.springframework.core.io.buffer.DataBuffer;</span><br><span class="line">import org.springframework.http.HttpStatus;</span><br><span class="line">import org.springframework.http.server.reactive.ServerHttpRequest;</span><br><span class="line">import org.springframework.http.server.reactive.ServerHttpResponse;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line">import org.springframework.util.AntPathMatcher;</span><br><span class="line">import org.springframework.util.StringUtils;</span><br><span class="line">import org.springframework.web.server.ServerWebExchange;</span><br><span class="line">import reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line">import java.nio.charset.StandardCharsets;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@Component</span><br><span class="line">@RequiredArgsConstructor</span><br><span class="line">public class AuthenticationFilter implements GlobalFilter, Ordered &#123;</span><br><span class="line"></span><br><span class="line">    private final ObjectMapper objectMapper;</span><br><span class="line">    private final AntPathMatcher antPathMatcher = new AntPathMatcher();</span><br><span class="line"></span><br><span class="line">    // ä¸éœ€è¦é‰´æƒçš„è·¯å¾„</span><br><span class="line">    private static final List&lt;String&gt; WHITE_LIST = List.of(</span><br><span class="line">        &quot;/api/auth/login&quot;,</span><br><span class="line">        &quot;/api/auth/register&quot;,</span><br><span class="line">        &quot;/api/auth/captcha&quot;,</span><br><span class="line">        &quot;/swagger-ui/**&quot;,</span><br><span class="line">        &quot;/v3/api-docs/**&quot;</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) &#123;</span><br><span class="line">        ServerHttpRequest request = exchange.getRequest();</span><br><span class="line">        String path = request.getURI().getPath();</span><br><span class="line"></span><br><span class="line">        // ç™½åå•ç›´æ¥æ”¾è¡Œ</span><br><span class="line">        if (isWhiteList(path)) &#123;</span><br><span class="line">            return chain.filter(exchange);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // ä»è¯·æ±‚å¤´ä¸­è·å–token</span><br><span class="line">        String token = getToken(request);</span><br><span class="line">        if (!StringUtils.hasText(token)) &#123;</span><br><span class="line">            return unauthorized(exchange.getResponse(), &quot;ç¼ºå°‘token&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // TODO: éªŒè¯tokençš„æœ‰æ•ˆæ€§ï¼Œè¿™é‡Œå¯ä»¥è°ƒç”¨auth-serviceéªŒè¯ï¼Œæˆ–è€…ä½¿ç”¨å…¬é’¥è§£æ</span><br><span class="line">        // æš‚æ—¶å‡è®¾tokenæœ‰æ•ˆï¼Œå°†ç”¨æˆ·ä¿¡æ¯ä¼ é€’ç»™ä¸‹æ¸¸æœåŠ¡</span><br><span class="line">        // å®é™…é¡¹ç›®ä¸­ï¼Œè¿™é‡Œåº”è¯¥è§£ætokenï¼Œè·å–ç”¨æˆ·ä¿¡æ¯ï¼Œç„¶åå°†å…¶æ·»åŠ åˆ°è¯·æ±‚å¤´ä¸­</span><br><span class="line">        if (!validateToken(token)) &#123;</span><br><span class="line">            return unauthorized(exchange.getResponse(), &quot;tokenæ— æ•ˆæˆ–å·²è¿‡æœŸ&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // å°†ç”¨æˆ·ä¿¡æ¯æ·»åŠ åˆ°è¯·æ±‚å¤´ä¸­</span><br><span class="line">        String username = extractUsername(token); // å‡è®¾ä»tokenä¸­æå–ç”¨æˆ·å</span><br><span class="line">        ServerHttpRequest newRequest = request.mutate()</span><br><span class="line">                .header(&quot;X-User-Id&quot;, username) // å°†ç”¨æˆ·ä¿¡æ¯ä¼ é€’ç»™ä¸‹æ¸¸æœåŠ¡</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        return chain.filter(exchange.mutate().request(newRequest).build());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private boolean isWhiteList(String path) &#123;</span><br><span class="line">        return WHITE_LIST.stream().anyMatch(pattern -&gt; antPathMatcher.match(pattern, path));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private String getToken(ServerHttpRequest request) &#123;</span><br><span class="line">        String bearerToken = request.getHeaders().getFirst(&quot;Authorization&quot;);</span><br><span class="line">        if (StringUtils.hasText(bearerToken) &amp;&amp; bearerToken.startsWith(&quot;Bearer &quot;)) &#123;</span><br><span class="line">            return bearerToken.substring(7);</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private boolean validateToken(String token) &#123;</span><br><span class="line">        // TODO: å®é™…é¡¹ç›®ä¸­ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨auth-serviceéªŒè¯tokenï¼Œæˆ–è€…ä½¿ç”¨å…¬é’¥è§£ætoken</span><br><span class="line">        // è¿™é‡Œä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬å‡è®¾tokenæœ‰æ•ˆ</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private String extractUsername(String token) &#123;</span><br><span class="line">        // TODO: ä»tokenä¸­æå–ç”¨æˆ·åï¼Œè¿™é‡Œä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬å‡è®¾tokenä¸­åŒ…å«äº†ç”¨æˆ·å</span><br><span class="line">        // å®é™…é¡¹ç›®ä¸­ï¼Œåº”è¯¥è§£æJWT token</span><br><span class="line">        return &quot;admin&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private Mono&lt;Void&gt; unauthorized(ServerHttpResponse response, String message) &#123;</span><br><span class="line">        response.setStatusCode(HttpStatus.UNAUTHORIZED);</span><br><span class="line">        response.getHeaders().add(&quot;Content-Type&quot;, &quot;application/json;charset=UTF-8&quot;);</span><br><span class="line"></span><br><span class="line">        Result&lt;String&gt; result = Result.error(ResultCode.UNAUTHORIZED.getCode(), message);</span><br><span class="line">        try &#123;</span><br><span class="line">            byte[] bytes = objectMapper.writeValueAsBytes(result);</span><br><span class="line">            DataBuffer buffer = response.bufferFactory().wrap(bytes);</span><br><span class="line">            return response.writeWith(Mono.just(buffer));</span><br><span class="line">        &#125; catch (JsonProcessingException e) &#123;</span><br><span class="line">            log.error(&quot;åºåˆ—åŒ–å¼‚å¸¸&quot;, e);</span><br><span class="line">            return response.setComplete();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public int getOrder() &#123;</span><br><span class="line">        return 0; // è¿‡æ»¤å™¨çš„æ‰§è¡Œé¡ºåºï¼Œæ•°å€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-å¯åŠ¨Nacoså¹¶æ³¨å†ŒæœåŠ¡"><a href="#3-å¯åŠ¨Nacoså¹¶æ³¨å†ŒæœåŠ¡" class="headerlink" title="3. å¯åŠ¨Nacoså¹¶æ³¨å†ŒæœåŠ¡"></a>3. å¯åŠ¨Nacoså¹¶æ³¨å†ŒæœåŠ¡</h3><p>æˆ‘ä»¬éœ€è¦å…ˆå¯åŠ¨Nacosï¼Œç„¶åå¯åŠ¨ç½‘å…³æœåŠ¡å’Œå…¶ä»–å¾®æœåŠ¡ã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨Dockeræ¥å¯åŠ¨Nacosã€‚</p><p>bash</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># æ‹‰å–Nacosé•œåƒ</span><br><span class="line">docker pull nacos/nacos-server</span><br><span class="line"></span><br><span class="line"># è¿è¡ŒNacos</span><br><span class="line">docker run -d \</span><br><span class="line">  --name nacos \</span><br><span class="line">  -p 8848:8848 \</span><br><span class="line">  -e MODE=standalone \</span><br><span class="line">  nacos/nacos-server</span><br></pre></td></tr></table></figure><h2 id="ç¬¬7å¤©ï¼šç½‘å…³é«˜çº§åŠŸèƒ½"><a href="#ç¬¬7å¤©ï¼šç½‘å…³é«˜çº§åŠŸèƒ½" class="headerlink" title="ç¬¬7å¤©ï¼šç½‘å…³é«˜çº§åŠŸèƒ½"></a>ç¬¬7å¤©ï¼šç½‘å…³é«˜çº§åŠŸèƒ½</h2><h3 id="3-1-å®ç°åŠ¨æ€è·¯ç”±"><a href="#3-1-å®ç°åŠ¨æ€è·¯ç”±" class="headerlink" title="3.1 å®ç°åŠ¨æ€è·¯ç”±"></a>3.1 å®ç°åŠ¨æ€è·¯ç”±</h3><p>æˆ‘ä»¬å¯ä»¥å°†è·¯ç”±é…ç½®æ”¾åœ¨Nacosé…ç½®ä¸­å¿ƒï¼Œå®ç°åŠ¨æ€è·¯ç”±æ›´æ–°ã€‚</p><h4 id="3-1-1-æ·»åŠ Nacos-Configä¾èµ–"><a href="#3-1-1-æ·»åŠ Nacos-Configä¾èµ–" class="headerlink" title="3.1.1 æ·»åŠ Nacos Configä¾èµ–"></a>3.1.1 æ·»åŠ Nacos Configä¾èµ–</h4><p>åœ¨ç½‘å…³çš„pom.xmlä¸­æ·»åŠ ï¼š</p><p>xml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-config&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><h4 id="3-1-2-åˆ›å»ºbootstrap-yml"><a href="#3-1-2-åˆ›å»ºbootstrap-yml" class="headerlink" title="3.1.2 åˆ›å»ºbootstrap.yml"></a>3.1.2 åˆ›å»ºbootstrap.yml</h4><p>yaml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: shophub-gateway</span><br><span class="line">  cloud:</span><br><span class="line">    nacos:</span><br><span class="line">      config:</span><br><span class="line">        server-addr: localhost:8848</span><br><span class="line">        file-extension: yaml</span><br><span class="line">        group: DEFAULT_GROUP</span><br><span class="line">        namespace: public</span><br><span class="line">      discovery:</span><br><span class="line">        server-addr: localhost:8848</span><br></pre></td></tr></table></figure><h4 id="3-1-3-åœ¨Nacosä¸­åˆ›å»ºé…ç½®"><a href="#3-1-3-åœ¨Nacosä¸­åˆ›å»ºé…ç½®" class="headerlink" title="3.1.3 åœ¨Nacosä¸­åˆ›å»ºé…ç½®"></a>3.1.3 åœ¨Nacosä¸­åˆ›å»ºé…ç½®</h4><p>åœ¨Nacosæ§åˆ¶å°ä¸­åˆ›å»ºData IDä¸º<code>shophub-gateway.yaml</code>çš„é…ç½®ï¼Œå†…å®¹ä¸ºåŠ¨æ€è·¯ç”±è§„åˆ™ï¼ˆè¿™é‡Œæˆ‘ä»¬æš‚æ—¶ä¸å±•å¼€ï¼Œå¯ä»¥å…ˆä½¿ç”¨é™æ€è·¯ç”±ï¼‰ã€‚</p><h3 id="3-2-ç†”æ–­é™çº§"><a href="#3-2-ç†”æ–­é™çº§" class="headerlink" title="3.2 ç†”æ–­é™çº§"></a>3.2 ç†”æ–­é™çº§</h3><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Spring Cloud Gatewayçš„ç†”æ–­é™çº§åŠŸèƒ½ï¼Œå½“åç«¯æœåŠ¡ä¸å¯ç”¨æ—¶ï¼Œè¿”å›é»˜è®¤å“åº”ã€‚</p><h4 id="3-2-1-æ·»åŠ ç†”æ–­å™¨ä¾èµ–"><a href="#3-2-1-æ·»åŠ ç†”æ–­å™¨ä¾èµ–" class="headerlink" title="3.2.1 æ·»åŠ ç†”æ–­å™¨ä¾èµ–"></a>3.2.1 æ·»åŠ ç†”æ–­å™¨ä¾èµ–</h4><p>åœ¨ç½‘å…³çš„pom.xmlä¸­æ·»åŠ ï¼š</p><p>xml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-circuitbreaker-reactor-resilience4j&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><h4 id="3-2-2-é…ç½®ç†”æ–­å™¨"><a href="#3-2-2-é…ç½®ç†”æ–­å™¨" class="headerlink" title="3.2.2 é…ç½®ç†”æ–­å™¨"></a>3.2.2 é…ç½®ç†”æ–­å™¨</h4><p>åœ¨application.ymlä¸­é…ç½®ç†”æ–­å™¨ï¼š</p><p>yaml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">resilience4j:</span><br><span class="line">  circuitbreaker:</span><br><span class="line">    instances:</span><br><span class="line">      authService:</span><br><span class="line">        slidingWindowSize: 10</span><br><span class="line">        failureRateThreshold: 50</span><br><span class="line">        waitDurationInOpenState: 5000</span><br></pre></td></tr></table></figure><h4 id="3-2-3-åœ¨è·¯ç”±ä¸­ä½¿ç”¨ç†”æ–­å™¨"><a href="#3-2-3-åœ¨è·¯ç”±ä¸­ä½¿ç”¨ç†”æ–­å™¨" class="headerlink" title="3.2.3 åœ¨è·¯ç”±ä¸­ä½¿ç”¨ç†”æ–­å™¨"></a>3.2.3 åœ¨è·¯ç”±ä¸­ä½¿ç”¨ç†”æ–­å™¨</h4><p>ä¿®æ”¹è·¯ç”±é…ç½®ï¼Œæ·»åŠ ç†”æ–­å™¨ï¼š</p><p>yaml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">filters:</span><br><span class="line">  - name: CircuitBreaker</span><br><span class="line">    args:</span><br><span class="line">      name: authService</span><br><span class="line">      fallbackUri: forward:/fallback/auth</span><br></pre></td></tr></table></figure><h4 id="3-2-4-åˆ›å»ºé™çº§å¤„ç†"><a href="#3-2-4-åˆ›å»ºé™çº§å¤„ç†" class="headerlink" title="3.2.4 åˆ›å»ºé™çº§å¤„ç†"></a>3.2.4 åˆ›å»ºé™çº§å¤„ç†</h4><p>åˆ›å»ºä¸€ä¸ªé™çº§å¤„ç†çš„Controllerï¼š</p><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.gateway.controller;</span><br><span class="line"></span><br><span class="line">import org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.RestController;</span><br><span class="line">import reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line">@RestController</span><br><span class="line">public class FallbackController &#123;</span><br><span class="line"></span><br><span class="line">    @GetMapping(&quot;/fallback/auth&quot;)</span><br><span class="line">    public Mono&lt;String&gt; authFallback() &#123;</span><br><span class="line">        return Mono.just(&quot;è®¤è¯æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // å…¶ä»–æœåŠ¡çš„é™çº§å¤„ç†...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-3-æ—¥å¿—è®°å½•"><a href="#3-3-æ—¥å¿—è®°å½•" class="headerlink" title="3.3 æ—¥å¿—è®°å½•"></a>3.3 æ—¥å¿—è®°å½•</h3><p>æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªå…¨å±€è¿‡æ»¤å™¨ï¼Œè®°å½•è¯·æ±‚å’Œå“åº”æ—¥å¿—ã€‚</p><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.gateway.filter;</span><br><span class="line"></span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.springframework.cloud.gateway.filter.GatewayFilterChain;</span><br><span class="line">import org.springframework.cloud.gateway.filter.GlobalFilter;</span><br><span class="line">import org.springframework.core.Ordered;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line">import org.springframework.web.server.ServerWebExchange;</span><br><span class="line">import reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@Component</span><br><span class="line">public class LoggingFilter implements GlobalFilter, Ordered &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) &#123;</span><br><span class="line">        long startTime = System.currentTimeMillis();</span><br><span class="line">        String path = exchange.getRequest().getURI().getPath();</span><br><span class="line"></span><br><span class="line">        return chain.filter(exchange).then(Mono.fromRunnable(() -&gt; &#123;</span><br><span class="line">            long duration = System.currentTimeMillis() - startTime;</span><br><span class="line">            int status = exchange.getResponse().getStatusCode() != null ?</span><br><span class="line">                         exchange.getResponse().getStatusCode().value() : 0;</span><br><span class="line">            log.info(&quot;è¯·æ±‚è·¯å¾„: &#123;&#125;, å“åº”çŠ¶æ€: &#123;&#125;, è€—æ—¶: &#123;&#125;ms&quot;, path, status, duration);</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public int getOrder() &#123;</span><br><span class="line">        return Ordered.HIGHEST_PRECEDENCE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†ç½‘å…³æœåŠ¡çš„åŸºç¡€æ­å»ºï¼ŒåŒ…æ‹¬ï¼š</p><ol><li><strong>NacosæœåŠ¡æ³¨å†Œä¸å‘ç°</strong>ï¼šå°†ç½‘å…³æ³¨å†Œåˆ°Nacosï¼Œå¹¶ä»Nacosè·å–å…¶ä»–æœåŠ¡å®ä¾‹ã€‚</li><li><strong>è·¯ç”±é…ç½®</strong>ï¼šé…ç½®äº†é™æ€è·¯ç”±ï¼Œå°†è¯·æ±‚è·¯ç”±åˆ°å¯¹åº”çš„å¾®æœåŠ¡ã€‚</li><li><strong>é™æµ</strong>ï¼šä½¿ç”¨Rediså®ç°äº†åŸºäºIPçš„é™æµã€‚</li><li><strong>é‰´æƒ</strong>ï¼šé€šè¿‡å…¨å±€è¿‡æ»¤å™¨å®ç°äº†TokenéªŒè¯ã€‚</li><li><strong>ç†”æ–­é™çº§</strong>ï¼šä½¿ç”¨Resilience4jå®ç°äº†ç†”æ–­é™çº§ã€‚</li><li><strong>æ—¥å¿—è®°å½•</strong>ï¼šè®°å½•äº†è¯·æ±‚çš„è€—æ—¶å’ŒçŠ¶æ€ã€‚</li></ol><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­å®ç°ç¬¬ä¸‰é˜¶æ®µï¼šå•†å“æœåŠ¡ï¼ˆshophub-productï¼‰ã€‚åœ¨å•†å“æœåŠ¡ä¸­ï¼Œæˆ‘ä»¬å°†å®è·µMyBatis Plusã€æ–‡ä»¶ä¸Šä¼ ä¸‹è½½ã€Redisç¼“å­˜ç­‰æŠ€æœ¯ã€‚</p><p>è¯·å‘Šè¯‰æˆ‘æ˜¯å¦éœ€è¦è°ƒæ•´ç½‘å…³æœåŠ¡çš„å®ç°ï¼Œæˆ–è€…ç»§ç»­å®ç°å•†å“æœåŠ¡ã€‚</p><h1 id="ğŸ“¡-ç¬¬äºŒé˜¶æ®µï¼šç½‘å…³ä¸æœåŠ¡æ³¨å†Œï¼ˆç¬¬6-7å¤©ï¼‰"><a href="#ğŸ“¡-ç¬¬äºŒé˜¶æ®µï¼šç½‘å…³ä¸æœåŠ¡æ³¨å†Œï¼ˆç¬¬6-7å¤©ï¼‰" class="headerlink" title="ğŸ“¡ ç¬¬äºŒé˜¶æ®µï¼šç½‘å…³ä¸æœåŠ¡æ³¨å†Œï¼ˆç¬¬6-7å¤©ï¼‰"></a>ğŸ“¡ ç¬¬äºŒé˜¶æ®µï¼šç½‘å…³ä¸æœåŠ¡æ³¨å†Œï¼ˆç¬¬6-7å¤©ï¼‰</h1><h2 id="ç¬¬6å¤©ï¼šNacosæœåŠ¡æ³¨å†Œä¸å‘ç°-ç½‘å…³åŸºç¡€é…ç½®"><a href="#ç¬¬6å¤©ï¼šNacosæœåŠ¡æ³¨å†Œä¸å‘ç°-ç½‘å…³åŸºç¡€é…ç½®" class="headerlink" title="ç¬¬6å¤©ï¼šNacosæœåŠ¡æ³¨å†Œä¸å‘ç° + ç½‘å…³åŸºç¡€é…ç½®"></a>ç¬¬6å¤©ï¼šNacosæœåŠ¡æ³¨å†Œä¸å‘ç° + ç½‘å…³åŸºç¡€é…ç½®</h2><h3 id="1-å…ˆå¯åŠ¨NacosæœåŠ¡ï¼ˆä½¿ç”¨Dockerï¼‰"><a href="#1-å…ˆå¯åŠ¨NacosæœåŠ¡ï¼ˆä½¿ç”¨Dockerï¼‰" class="headerlink" title="1. å…ˆå¯åŠ¨NacosæœåŠ¡ï¼ˆä½¿ç”¨Dockerï¼‰"></a>1. å…ˆå¯åŠ¨NacosæœåŠ¡ï¼ˆä½¿ç”¨Dockerï¼‰</h3><p>bash</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"># åˆ›å»ºdocker-compose.yml</span><br><span class="line">version: &#x27;3.8&#x27;</span><br><span class="line">services:</span><br><span class="line">  nacos:</span><br><span class="line">    image: nacos/nacos-server:v2.2.0</span><br><span class="line">    container_name: nacos</span><br><span class="line">    environment:</span><br><span class="line">      - MODE=standalone</span><br><span class="line">      - JVM_XMS=512m</span><br><span class="line">      - JVM_XMX=512m</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;8848:8848&quot;</span><br><span class="line">      - &quot;9848:9848&quot;</span><br><span class="line">      - &quot;9849:9849&quot;</span><br><span class="line">    volumes:</span><br><span class="line">      - ./nacos/logs:/home/nacos/logs</span><br><span class="line">      - ./nacos/data:/home/nacos/data</span><br><span class="line">    networks:</span><br><span class="line">      - shophub-network</span><br><span class="line"></span><br><span class="line">  mysql:</span><br><span class="line">    image: mysql:8.0</span><br><span class="line">    container_name: shophub-mysql</span><br><span class="line">    environment:</span><br><span class="line">      MYSQL_ROOT_PASSWORD: root123</span><br><span class="line">      MYSQL_DATABASE: shophub</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;3306:3306&quot;</span><br><span class="line">    volumes:</span><br><span class="line">      - ./mysql/data:/var/lib/mysql</span><br><span class="line">      - ./mysql/init:/docker-entrypoint-initdb.d</span><br><span class="line">    networks:</span><br><span class="line">      - shophub-network</span><br><span class="line"></span><br><span class="line">  redis:</span><br><span class="line">    image: redis:7-alpine</span><br><span class="line">    container_name: shophub-redis</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;6379:6379&quot;</span><br><span class="line">    command: redis-server --appendonly yes --requirepass &quot;redis123&quot;</span><br><span class="line">    volumes:</span><br><span class="line">      - ./redis/data:/data</span><br><span class="line">    networks:</span><br><span class="line">      - shophub-network</span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  shophub-network:</span><br><span class="line">    driver: bridge</span><br></pre></td></tr></table></figure><h3 id="2-æ‰€æœ‰å¾®æœåŠ¡æ·»åŠ Nacosä¾èµ–"><a href="#2-æ‰€æœ‰å¾®æœåŠ¡æ·»åŠ Nacosä¾èµ–" class="headerlink" title="2. æ‰€æœ‰å¾®æœåŠ¡æ·»åŠ Nacosä¾èµ–"></a>2. æ‰€æœ‰å¾®æœåŠ¡æ·»åŠ Nacosä¾èµ–</h3><p>xml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- åœ¨æ¯ä¸ªå¾®æœåŠ¡çš„pom.xmlä¸­æ·»åŠ  --&gt;</span><br><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;!-- Nacos æœåŠ¡æ³¨å†Œä¸å‘ç° --&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;$&#123;nacos.version&#125;&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;!-- Nacos é…ç½®ä¸­å¿ƒï¼ˆå¯é€‰ï¼‰ --&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-config&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;$&#123;nacos.version&#125;&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br></pre></td></tr></table></figure><h3 id="3-ç½‘å…³æœåŠ¡ï¼ˆshophub-gatewayï¼‰è¯¦ç»†å®ç°"><a href="#3-ç½‘å…³æœåŠ¡ï¼ˆshophub-gatewayï¼‰è¯¦ç»†å®ç°" class="headerlink" title="3. ç½‘å…³æœåŠ¡ï¼ˆshophub-gatewayï¼‰è¯¦ç»†å®ç°"></a>3. ç½‘å…³æœåŠ¡ï¼ˆshophub-gatewayï¼‰è¯¦ç»†å®ç°</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line">// 1. ç½‘å…³ä¸»å¯åŠ¨ç±»</span><br><span class="line">package com.shophub.gateway;</span><br><span class="line"></span><br><span class="line">import org.springframework.boot.SpringApplication;</span><br><span class="line">import org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line">import org.springframework.cloud.client.discovery.EnableDiscoveryClient;</span><br><span class="line"></span><br><span class="line">@SpringBootApplication</span><br><span class="line">@EnableDiscoveryClient</span><br><span class="line">public class GatewayApplication &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(GatewayApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 2. ç½‘å…³é…ç½®æ–‡ä»¶ application.yml</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: shophub-gateway</span><br><span class="line">  cloud:</span><br><span class="line">    nacos:</span><br><span class="line">      discovery:</span><br><span class="line">        server-addr: $&#123;NACOS_HOST:localhost&#125;:$&#123;NACOS_PORT:8848&#125;</span><br><span class="line">        namespace: public</span><br><span class="line">        group: DEFAULT_GROUP</span><br><span class="line">      config:</span><br><span class="line">        server-addr: $&#123;NACOS_HOST:localhost&#125;:$&#123;NACOS_PORT:8848&#125;</span><br><span class="line">        file-extension: yaml</span><br><span class="line">        group: DEFAULT_GROUP</span><br><span class="line">        namespace: public</span><br><span class="line">    </span><br><span class="line">    gateway:</span><br><span class="line">      discovery:</span><br><span class="line">        locator:</span><br><span class="line">          enabled: true  # å¼€å¯ä»æ³¨å†Œä¸­å¿ƒè‡ªåŠ¨åˆ›å»ºè·¯ç”±</span><br><span class="line">          lower-case-service-id: true</span><br><span class="line">      </span><br><span class="line">      routes:</span><br><span class="line">        # è®¤è¯æœåŠ¡è·¯ç”±</span><br><span class="line">        - id: auth-service</span><br><span class="line">          uri: lb://shophub-auth</span><br><span class="line">          predicates:</span><br><span class="line">            - Path=/api/auth/**</span><br><span class="line">          filters:</span><br><span class="line">            - StripPrefix=1</span><br><span class="line">            - name: RequestRateLimiter</span><br><span class="line">              args:</span><br><span class="line">                redis-rate-limiter.replenishRate: 10  # æ¯ç§’äº§ç”Ÿçš„ä»¤ç‰Œæ•°</span><br><span class="line">                redis-rate-limiter.burstCapacity: 20  # ä»¤ç‰Œæ¡¶å®¹é‡</span><br><span class="line">                redis-rate-limiter.requestedTokens: 1</span><br><span class="line">                key-resolver: &quot;#&#123;@userKeyResolver&#125;&quot;</span><br><span class="line">        </span><br><span class="line">        # å•†å“æœåŠ¡è·¯ç”±</span><br><span class="line">        - id: product-service</span><br><span class="line">          uri: lb://shophub-product</span><br><span class="line">          predicates:</span><br><span class="line">            - Path=/api/product/**</span><br><span class="line">          filters:</span><br><span class="line">            - StripPrefix=1</span><br><span class="line">            - name: CircuitBreaker</span><br><span class="line">              args:</span><br><span class="line">                name: productService</span><br><span class="line">                fallbackUri: forward:/fallback/product</span><br><span class="line">        </span><br><span class="line">        # è®¢å•æœåŠ¡è·¯ç”±</span><br><span class="line">        - id: order-service</span><br><span class="line">          uri: lb://shophub-order</span><br><span class="line">          predicates:</span><br><span class="line">            - Path=/api/order/**</span><br><span class="line">          filters:</span><br><span class="line">            - StripPrefix=1</span><br><span class="line">            - name: CircuitBreaker</span><br><span class="line">              args:</span><br><span class="line">                name: orderService</span><br><span class="line">                fallbackUri: forward:/fallback/order</span><br><span class="line">        </span><br><span class="line">        # å…¬å¼€æ¥å£è·¯ç”±ï¼ˆæ— éœ€è®¤è¯ï¼‰</span><br><span class="line">        - id: public-api</span><br><span class="line">          uri: lb://shophub-auth</span><br><span class="line">          predicates:</span><br><span class="line">            - Path=/api/public/**</span><br><span class="line">          filters:</span><br><span class="line">            - StripPrefix=1</span><br><span class="line">        </span><br><span class="line">        # é™æ€èµ„æºè·¯ç”±</span><br><span class="line">        - id: static-resource</span><br><span class="line">          uri: lb://shophub-product</span><br><span class="line">          predicates:</span><br><span class="line">            - Path=/static/**</span><br><span class="line">          filters:</span><br><span class="line">            - StripPrefix=1</span><br><span class="line">      </span><br><span class="line">      # å…¨å±€è¿‡æ»¤å™¨é…ç½®</span><br><span class="line">      default-filters:</span><br><span class="line">        - DedupeResponseHeader=Access-Control-Allow-Origin Access-Control-Allow-Credentials, RETAIN_FIRST</span><br><span class="line">        - AddResponseHeader=X-Response-Default-Foo, Default-Bar</span><br><span class="line">    </span><br><span class="line">    # è´Ÿè½½å‡è¡¡é…ç½®</span><br><span class="line">    loadbalancer:</span><br><span class="line">      nacos:</span><br><span class="line">        enabled: true</span><br><span class="line"></span><br><span class="line">  # Redisé…ç½®ï¼ˆç”¨äºé™æµï¼‰</span><br><span class="line">  redis:</span><br><span class="line">    host: $&#123;REDIS_HOST:localhost&#125;</span><br><span class="line">    port: $&#123;REDIS_PORT:6379&#125;</span><br><span class="line">    password: $&#123;REDIS_PASSWORD:redis123&#125;</span><br><span class="line">    database: 0</span><br><span class="line">    timeout: 3000</span><br><span class="line">    lettuce:</span><br><span class="line">      pool:</span><br><span class="line">        max-active: 8</span><br><span class="line">        max-wait: -1ms</span><br><span class="line">        max-idle: 8</span><br><span class="line">        min-idle: 0</span><br><span class="line"></span><br><span class="line"># ç†”æ–­å™¨é…ç½®</span><br><span class="line">resilience4j:</span><br><span class="line">  circuitbreaker:</span><br><span class="line">    instances:</span><br><span class="line">      productService:</span><br><span class="line">        slidingWindowSize: 10</span><br><span class="line">        minimumNumberOfCalls: 5</span><br><span class="line">        permittedNumberOfCallsInHalfOpenState: 3</span><br><span class="line">        automaticTransitionFromOpenToHalfOpenEnabled: true</span><br><span class="line">        waitDurationInOpenState: 5s</span><br><span class="line">        failureRateThreshold: 50</span><br><span class="line">        eventConsumerBufferSize: 10</span><br><span class="line">      orderService:</span><br><span class="line">        slidingWindowSize: 10</span><br><span class="line">        failureRateThreshold: 50</span><br><span class="line">        waitDurationInOpenState: 5s</span><br><span class="line"></span><br><span class="line"># ç®¡ç†ç«¯ç‚¹</span><br><span class="line">management:</span><br><span class="line">  endpoints:</span><br><span class="line">    web:</span><br><span class="line">      exposure:</span><br><span class="line">        include: health,info,metrics,gateway</span><br><span class="line">  endpoint:</span><br><span class="line">    health:</span><br><span class="line">      show-details: always</span><br><span class="line">  metrics:</span><br><span class="line">    export:</span><br><span class="line">      prometheus:</span><br><span class="line">        enabled: true</span><br><span class="line"></span><br><span class="line"># æœåŠ¡ç«¯å£</span><br><span class="line">server:</span><br><span class="line">  port: 8888</span><br><span class="line">  servlet:</span><br><span class="line">    context-path: /</span><br></pre></td></tr></table></figure><h3 id="4-é™æµé…ç½®ç±»"><a href="#4-é™æµé…ç½®ç±»" class="headerlink" title="4. é™æµé…ç½®ç±»"></a>4. é™æµé…ç½®ç±»</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.gateway.config;</span><br><span class="line"></span><br><span class="line">import org.springframework.cloud.gateway.filter.ratelimit.KeyResolver;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.context.annotation.Primary;</span><br><span class="line">import reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line">import java.util.Objects;</span><br><span class="line"></span><br><span class="line">@Configuration</span><br><span class="line">public class RateLimiterConfig &#123;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ ¹æ®ç”¨æˆ·IDé™æµ</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    @Primary</span><br><span class="line">    public KeyResolver userKeyResolver() &#123;</span><br><span class="line">        return exchange -&gt; &#123;</span><br><span class="line">            // ä»è¯·æ±‚å¤´ä¸­è·å–ç”¨æˆ·ID</span><br><span class="line">            String userId = exchange.getRequest().getHeaders().getFirst(&quot;X-User-Id&quot;);</span><br><span class="line">            if (userId != null) &#123;</span><br><span class="line">                return Mono.just(userId);</span><br><span class="line">            &#125;</span><br><span class="line">            // å¦‚æœæ²¡ç™»å½•ï¼Œä½¿ç”¨IPé™æµ</span><br><span class="line">            return ipKeyResolver().resolve(exchange);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ ¹æ®IPé™æµ</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public KeyResolver ipKeyResolver() &#123;</span><br><span class="line">        return exchange -&gt; Mono.just(</span><br><span class="line">            Objects.requireNonNull(exchange.getRequest().getRemoteAddress())</span><br><span class="line">                   .getAddress().getHostAddress()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ ¹æ®è¯·æ±‚è·¯å¾„é™æµ</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public KeyResolver apiKeyResolver() &#123;</span><br><span class="line">        return exchange -&gt; Mono.just(</span><br><span class="line">            exchange.getRequest().getPath().value()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-å…¨å±€è®¤è¯è¿‡æ»¤å™¨"><a href="#5-å…¨å±€è®¤è¯è¿‡æ»¤å™¨" class="headerlink" title="5. å…¨å±€è®¤è¯è¿‡æ»¤å™¨"></a>5. å…¨å±€è®¤è¯è¿‡æ»¤å™¨</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.gateway.filter;</span><br><span class="line"></span><br><span class="line">import com.fasterxml.jackson.core.JsonProcessingException;</span><br><span class="line">import com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line">import com.shophub.common.result.Result;</span><br><span class="line">import com.shophub.common.result.ResultCode;</span><br><span class="line">import lombok.RequiredArgsConstructor;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.springframework.cloud.gateway.filter.GatewayFilterChain;</span><br><span class="line">import org.springframework.cloud.gateway.filter.GlobalFilter;</span><br><span class="line">import org.springframework.core.Ordered;</span><br><span class="line">import org.springframework.core.io.buffer.DataBuffer;</span><br><span class="line">import org.springframework.http.HttpHeaders;</span><br><span class="line">import org.springframework.http.HttpStatus;</span><br><span class="line">import org.springframework.http.MediaType;</span><br><span class="line">import org.springframework.http.server.reactive.ServerHttpRequest;</span><br><span class="line">import org.springframework.http.server.reactive.ServerHttpResponse;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line">import org.springframework.util.AntPathMatcher;</span><br><span class="line">import org.springframework.util.StringUtils;</span><br><span class="line">import org.springframework.web.server.ServerWebExchange;</span><br><span class="line">import reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line">import java.nio.charset.StandardCharsets;</span><br><span class="line">import java.util.Arrays;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@Component</span><br><span class="line">@RequiredArgsConstructor</span><br><span class="line">public class AuthenticationFilter implements GlobalFilter, Ordered &#123;</span><br><span class="line">    </span><br><span class="line">    private final ObjectMapper objectMapper;</span><br><span class="line">    private final JwtTokenUtil jwtTokenUtil;</span><br><span class="line">    private final AntPathMatcher antPathMatcher = new AntPathMatcher();</span><br><span class="line">    </span><br><span class="line">    // ç™½åå•è·¯å¾„ï¼ˆæ— éœ€è®¤è¯ï¼‰</span><br><span class="line">    private static final List&lt;String&gt; WHITE_LIST = Arrays.asList(</span><br><span class="line">        &quot;/api/auth/login&quot;,</span><br><span class="line">        &quot;/api/auth/register&quot;,</span><br><span class="line">        &quot;/api/auth/captcha&quot;,</span><br><span class="line">        &quot;/api/auth/refresh-token&quot;,</span><br><span class="line">        &quot;/api/public/**&quot;,</span><br><span class="line">        &quot;/static/**&quot;,</span><br><span class="line">        &quot;/v2/api-docs&quot;,</span><br><span class="line">        &quot;/v3/api-docs&quot;,</span><br><span class="line">        &quot;/swagger-ui/**&quot;,</span><br><span class="line">        &quot;/swagger-resources/**&quot;,</span><br><span class="line">        &quot;/webjars/**&quot;</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) &#123;</span><br><span class="line">        ServerHttpRequest request = exchange.getRequest();</span><br><span class="line">        String path = request.getURI().getPath();</span><br><span class="line">        </span><br><span class="line">        // æ£€æŸ¥æ˜¯å¦ä¸ºç™½åå•è·¯å¾„</span><br><span class="line">        if (isWhiteList(path)) &#123;</span><br><span class="line">            log.debug(&quot;ç™½åå•è·¯å¾„ï¼š&#123;&#125;&quot;, path);</span><br><span class="line">            return chain.filter(exchange);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // è·å–token</span><br><span class="line">        String token = getToken(request);</span><br><span class="line">        if (!StringUtils.hasText(token)) &#123;</span><br><span class="line">            log.warn(&quot;è¯·æ±‚ç¼ºå°‘tokenï¼š&#123;&#125;&quot;, path);</span><br><span class="line">            return unauthorized(exchange, &quot;è¯·å…ˆç™»å½•&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            // éªŒè¯token</span><br><span class="line">            if (!jwtTokenUtil.validateToken(token)) &#123;</span><br><span class="line">                log.warn(&quot;tokenéªŒè¯å¤±è´¥ï¼š&#123;&#125;&quot;, token);</span><br><span class="line">                return unauthorized(exchange, &quot;ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // ä»tokenä¸­è·å–ç”¨æˆ·ä¿¡æ¯</span><br><span class="line">            String username = jwtTokenUtil.getUsernameFromToken(token);</span><br><span class="line">            String userId = jwtTokenUtil.getUserIdFromToken(token);</span><br><span class="line">            </span><br><span class="line">            // å°†ç”¨æˆ·ä¿¡æ¯æ·»åŠ åˆ°è¯·æ±‚å¤´ä¸­ï¼Œä¼ é€’ç»™ä¸‹æ¸¸æœåŠ¡</span><br><span class="line">            ServerHttpRequest newRequest = request.mutate()</span><br><span class="line">                .header(&quot;X-User-Id&quot;, userId)</span><br><span class="line">                .header(&quot;X-Username&quot;, username)</span><br><span class="line">                .build();</span><br><span class="line">            </span><br><span class="line">            log.debug(&quot;ç”¨æˆ·è®¤è¯æˆåŠŸï¼Œç”¨æˆ·IDï¼š&#123;&#125;ï¼Œè·¯å¾„ï¼š&#123;&#125;&quot;, userId, path);</span><br><span class="line">            </span><br><span class="line">            return chain.filter(exchange.mutate().request(newRequest).build());</span><br><span class="line">            </span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;tokenè§£æå¼‚å¸¸ï¼š&quot;, e);</span><br><span class="line">            return unauthorized(exchange, &quot;ç™»å½•ä¿¡æ¯å¼‚å¸¸&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private boolean isWhiteList(String path) &#123;</span><br><span class="line">        return WHITE_LIST.stream()</span><br><span class="line">            .anyMatch(pattern -&gt; antPathMatcher.match(pattern, path));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private String getToken(ServerHttpRequest request) &#123;</span><br><span class="line">        String bearerToken = request.getHeaders().getFirst(HttpHeaders.AUTHORIZATION);</span><br><span class="line">        if (StringUtils.hasText(bearerToken) &amp;&amp; bearerToken.startsWith(&quot;Bearer &quot;)) &#123;</span><br><span class="line">            return bearerToken.substring(7);</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private Mono&lt;Void&gt; unauthorized(ServerWebExchange exchange, String message) &#123;</span><br><span class="line">        ServerHttpResponse response = exchange.getResponse();</span><br><span class="line">        response.setStatusCode(HttpStatus.UNAUTHORIZED);</span><br><span class="line">        response.getHeaders().setContentType(MediaType.APPLICATION_JSON);</span><br><span class="line">        </span><br><span class="line">        Result&lt;String&gt; result = Result.error(ResultCode.UNAUTHORIZED.getCode(), message);</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            byte[] bytes = objectMapper.writeValueAsBytes(result);</span><br><span class="line">            DataBuffer buffer = response.bufferFactory().wrap(bytes);</span><br><span class="line">            return response.writeWith(Mono.just(buffer));</span><br><span class="line">        &#125; catch (JsonProcessingException e) &#123;</span><br><span class="line">            log.error(&quot;åºåˆ—åŒ–å¼‚å¸¸&quot;, e);</span><br><span class="line">            return response.setComplete();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public int getOrder() &#123;</span><br><span class="line">        return Ordered.HIGHEST_PRECEDENCE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// ç½‘å…³JWTå·¥å…·ç±»</span><br><span class="line">@Component</span><br><span class="line">class JwtTokenUtil &#123;</span><br><span class="line">    </span><br><span class="line">    private static final String SECRET = &quot;shophub-gateway-secret-key-2023-12-01&quot;;</span><br><span class="line">    </span><br><span class="line">    public boolean validateToken(String token) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            // è¿™é‡Œåº”è¯¥è°ƒç”¨è®¤è¯æœåŠ¡éªŒè¯tokenï¼Œæˆ–è€…ä½¿ç”¨å…¬é’¥éªŒè¯</span><br><span class="line">            // ç®€åŒ–å®ç°ï¼šæ£€æŸ¥tokenæ ¼å¼</span><br><span class="line">            return StringUtils.hasText(token) &amp;&amp; token.split(&quot;\\.&quot;).length == 3;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public String getUsernameFromToken(String token) &#123;</span><br><span class="line">        // ç®€åŒ–å®ç°ï¼šå®é™…åº”è¯¥è§£æJWT</span><br><span class="line">        return &quot;user_from_token&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public String getUserIdFromToken(String token) &#123;</span><br><span class="line">        // ç®€åŒ–å®ç°ï¼šå®é™…åº”è¯¥è§£æJWT</span><br><span class="line">        return &quot;1&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-ç½‘å…³é™çº§å¤„ç†"><a href="#6-ç½‘å…³é™çº§å¤„ç†" class="headerlink" title="6. ç½‘å…³é™çº§å¤„ç†"></a>6. ç½‘å…³é™çº§å¤„ç†</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.gateway.handler;</span><br><span class="line"></span><br><span class="line">import com.fasterxml.jackson.core.JsonProcessingException;</span><br><span class="line">import com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line">import com.shophub.common.result.Result;</span><br><span class="line">import com.shophub.common.result.ResultCode;</span><br><span class="line">import lombok.RequiredArgsConstructor;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.springframework.boot.web.reactive.error.ErrorWebExceptionHandler;</span><br><span class="line">import org.springframework.cloud.gateway.support.NotFoundException;</span><br><span class="line">import org.springframework.core.annotation.Order;</span><br><span class="line">import org.springframework.core.io.buffer.DataBuffer;</span><br><span class="line">import org.springframework.http.HttpStatus;</span><br><span class="line">import org.springframework.http.MediaType;</span><br><span class="line">import org.springframework.http.server.reactive.ServerHttpResponse;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line">import org.springframework.web.server.ResponseStatusException;</span><br><span class="line">import org.springframework.web.server.ServerWebExchange;</span><br><span class="line">import reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line">import java.nio.charset.StandardCharsets;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@Order(-1)</span><br><span class="line">@Component</span><br><span class="line">@RequiredArgsConstructor</span><br><span class="line">public class GlobalExceptionHandler implements ErrorWebExceptionHandler &#123;</span><br><span class="line">    </span><br><span class="line">    private final ObjectMapper objectMapper;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public Mono&lt;Void&gt; handle(ServerWebExchange exchange, Throwable ex) &#123;</span><br><span class="line">        ServerHttpResponse response = exchange.getResponse();</span><br><span class="line">        </span><br><span class="line">        if (exchange.getResponse().isCommitted()) &#123;</span><br><span class="line">            return Mono.error(ex);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        Result&lt;String&gt; result;</span><br><span class="line">        </span><br><span class="line">        if (ex instanceof NotFoundException) &#123;</span><br><span class="line">            result = Result.error(ResultCode.SERVICE_NOT_FOUND);</span><br><span class="line">            response.setStatusCode(HttpStatus.NOT_FOUND);</span><br><span class="line">        &#125; else if (ex instanceof ResponseStatusException) &#123;</span><br><span class="line">            ResponseStatusException responseStatusException = (ResponseStatusException) ex;</span><br><span class="line">            result = Result.error(</span><br><span class="line">                responseStatusException.getStatusCode().value(),</span><br><span class="line">                responseStatusException.getReason()</span><br><span class="line">            );</span><br><span class="line">            response.setStatusCode(responseStatusException.getStatusCode());</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            log.error(&quot;ç½‘å…³å¼‚å¸¸ï¼š&quot;, ex);</span><br><span class="line">            result = Result.error(ResultCode.SYSTEM_ERROR);</span><br><span class="line">            response.setStatusCode(HttpStatus.INTERNAL_SERVER_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        response.getHeaders().setContentType(MediaType.APPLICATION_JSON);</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            byte[] bytes = objectMapper.writeValueAsBytes(result);</span><br><span class="line">            DataBuffer buffer = response.bufferFactory().wrap(bytes);</span><br><span class="line">            return response.writeWith(Mono.just(buffer));</span><br><span class="line">        &#125; catch (JsonProcessingException e) &#123;</span><br><span class="line">            log.error(&quot;å¼‚å¸¸å¤„ç†åºåˆ—åŒ–å¤±è´¥&quot;, e);</span><br><span class="line">            return response.writeWith(</span><br><span class="line">                Mono.just(response.bufferFactory().wrap(&quot;ç³»ç»Ÿå¼‚å¸¸&quot;.getBytes()))</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// é™çº§æ§åˆ¶å™¨</span><br><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;/fallback&quot;)</span><br><span class="line">class FallbackController &#123;</span><br><span class="line">    </span><br><span class="line">    private static final ObjectMapper MAPPER = new ObjectMapper();</span><br><span class="line">    </span><br><span class="line">    @GetMapping(&quot;/product&quot;)</span><br><span class="line">    public Mono&lt;String&gt; productFallback() &#123;</span><br><span class="line">        return Mono.just(createFallbackResult(&quot;å•†å“æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•&quot;));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @GetMapping(&quot;/order&quot;)</span><br><span class="line">    public Mono&lt;String&gt; orderFallback() &#123;</span><br><span class="line">        return Mono.just(createFallbackResult(&quot;è®¢å•æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•&quot;));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private String createFallbackResult(String message) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Result&lt;String&gt; result = Result.error(503, message);</span><br><span class="line">            return MAPPER.writeValueAsString(result);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            return &quot;&#123;\&quot;code\&quot;:503,\&quot;message\&quot;:\&quot;æœåŠ¡é™çº§\&quot;&#125;&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="7-ç½‘å…³ç›‘æ§è¿‡æ»¤å™¨"><a href="#7-ç½‘å…³ç›‘æ§è¿‡æ»¤å™¨" class="headerlink" title="7. ç½‘å…³ç›‘æ§è¿‡æ»¤å™¨"></a>7. ç½‘å…³ç›‘æ§è¿‡æ»¤å™¨</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.gateway.filter;</span><br><span class="line"></span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.springframework.cloud.gateway.filter.GatewayFilterChain;</span><br><span class="line">import org.springframework.cloud.gateway.filter.GlobalFilter;</span><br><span class="line">import org.springframework.core.Ordered;</span><br><span class="line">import org.springframework.http.server.reactive.ServerHttpRequest;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line">import org.springframework.web.server.ServerWebExchange;</span><br><span class="line">import reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line">import java.time.Duration;</span><br><span class="line">import java.time.Instant;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@Component</span><br><span class="line">public class MetricsFilter implements GlobalFilter, Ordered &#123;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) &#123;</span><br><span class="line">        Instant startTime = Instant.now();</span><br><span class="line">        ServerHttpRequest request = exchange.getRequest();</span><br><span class="line">        </span><br><span class="line">        String requestId = request.getId();</span><br><span class="line">        String path = request.getURI().getPath();</span><br><span class="line">        String method = request.getMethodValue();</span><br><span class="line">        String clientIp = request.getRemoteAddress() != null ? </span><br><span class="line">                         request.getRemoteAddress().getAddress().getHostAddress() : &quot;unknown&quot;;</span><br><span class="line">        </span><br><span class="line">        // è®°å½•è¯·æ±‚å¼€å§‹æ—¥å¿—</span><br><span class="line">        log.info(&quot;å¼€å§‹è¯·æ±‚ - ID: &#123;&#125;, è·¯å¾„: &#123;&#125;, æ–¹æ³•: &#123;&#125;, IP: &#123;&#125;&quot;, </span><br><span class="line">                requestId, path, method, clientIp);</span><br><span class="line">        </span><br><span class="line">        return chain.filter(exchange).doFinally(signalType -&gt; &#123;</span><br><span class="line">            Instant endTime = Instant.now();</span><br><span class="line">            Duration duration = Duration.between(startTime, endTime);</span><br><span class="line">            </span><br><span class="line">            int status = exchange.getResponse().getStatusCode() != null ?</span><br><span class="line">                        exchange.getResponse().getStatusCode().value() : 0;</span><br><span class="line">            </span><br><span class="line">            // è®°å½•è¯·æ±‚å®Œæˆæ—¥å¿—</span><br><span class="line">            log.info(&quot;å®Œæˆè¯·æ±‚ - ID: &#123;&#125;, è·¯å¾„: &#123;&#125;, çŠ¶æ€: &#123;&#125;, è€—æ—¶: &#123;&#125;ms&quot;, </span><br><span class="line">                    requestId, path, status, duration.toMillis());</span><br><span class="line">            </span><br><span class="line">            // å¯ä»¥åœ¨è¿™é‡Œå°†æŒ‡æ ‡æ¨é€åˆ°ç›‘æ§ç³»ç»Ÿ</span><br><span class="line">            if (duration.toMillis() &gt; 1000) &#123;</span><br><span class="line">                log.warn(&quot;æ…¢è¯·æ±‚ - ID: &#123;&#125;, è·¯å¾„: &#123;&#125;, è€—æ—¶: &#123;&#125;ms&quot;, </span><br><span class="line">                        requestId, path, duration.toMillis());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public int getOrder() &#123;</span><br><span class="line">        return Ordered.LOWEST_PRECEDENCE - 1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="8-åŠ¨æ€è·¯ç”±é…ç½®"><a href="#8-åŠ¨æ€è·¯ç”±é…ç½®" class="headerlink" title="8. åŠ¨æ€è·¯ç”±é…ç½®"></a>8. åŠ¨æ€è·¯ç”±é…ç½®</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.gateway.config;</span><br><span class="line"></span><br><span class="line">import com.alibaba.cloud.nacos.NacosConfigManager;</span><br><span class="line">import com.alibaba.nacos.api.config.listener.Listener;</span><br><span class="line">import com.alibaba.nacos.api.exception.NacosException;</span><br><span class="line">import com.fasterxml.jackson.core.type.TypeReference;</span><br><span class="line">import com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line">import lombok.RequiredArgsConstructor;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.springframework.cloud.gateway.event.RefreshRoutesEvent;</span><br><span class="line">import org.springframework.cloud.gateway.route.RouteDefinition;</span><br><span class="line">import org.springframework.cloud.gateway.route.RouteDefinitionWriter;</span><br><span class="line">import org.springframework.context.ApplicationEventPublisher;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line">import javax.annotation.PostConstruct;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.concurrent.Executor;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@Configuration</span><br><span class="line">@RequiredArgsConstructor</span><br><span class="line">public class DynamicRouteConfig &#123;</span><br><span class="line">    </span><br><span class="line">    private final NacosConfigManager nacosConfigManager;</span><br><span class="line">    private final RouteDefinitionWriter routeDefinitionWriter;</span><br><span class="line">    private final ApplicationEventPublisher publisher;</span><br><span class="line">    private final ObjectMapper objectMapper;</span><br><span class="line">    </span><br><span class="line">    private static final String DATA_ID = &quot;gateway-routes.json&quot;;</span><br><span class="line">    private static final String GROUP = &quot;DEFAULT_GROUP&quot;;</span><br><span class="line">    </span><br><span class="line">    @PostConstruct</span><br><span class="line">    public void init() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            // åˆå§‹åŠ è½½è·¯ç”±é…ç½®</span><br><span class="line">            String config = nacosConfigManager.getConfigService()</span><br><span class="line">                .getConfig(DATA_ID, GROUP, 5000);</span><br><span class="line">            updateRoutes(config);</span><br><span class="line">            </span><br><span class="line">            // æ·»åŠ ç›‘å¬å™¨ï¼Œå®ç°åŠ¨æ€è·¯ç”±</span><br><span class="line">            nacosConfigManager.getConfigService().addListener(</span><br><span class="line">                DATA_ID, GROUP, new Listener() &#123;</span><br><span class="line">                    @Override</span><br><span class="line">                    public Executor getExecutor() &#123;</span><br><span class="line">                        return null;</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    @Override</span><br><span class="line">                    public void receiveConfigInfo(String configInfo) &#123;</span><br><span class="line">                        log.info(&quot;æ£€æµ‹åˆ°è·¯ç”±é…ç½®å˜æ›´ï¼Œå¼€å§‹æ›´æ–°&quot;);</span><br><span class="line">                        updateRoutes(configInfo);</span><br><span class="line">                        // å‘å¸ƒäº‹ä»¶åˆ·æ–°è·¯ç”±</span><br><span class="line">                        publisher.publishEvent(new RefreshRoutesEvent(this));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            log.info(&quot;åŠ¨æ€è·¯ç”±é…ç½®åŠ è½½å®Œæˆ&quot;);</span><br><span class="line">            </span><br><span class="line">        &#125; catch (NacosException e) &#123;</span><br><span class="line">            log.error(&quot;åŠ è½½åŠ¨æ€è·¯ç”±é…ç½®å¤±è´¥&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private void updateRoutes(String config) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            if (config == null || config.trim().isEmpty()) &#123;</span><br><span class="line">                log.warn(&quot;è·¯ç”±é…ç½®ä¸ºç©º&quot;);</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            List&lt;RouteDefinition&gt; routeDefinitions = objectMapper.readValue(</span><br><span class="line">                config, new TypeReference&lt;List&lt;RouteDefinition&gt;&gt;() &#123;&#125;</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            // æ¸…é™¤ç°æœ‰è·¯ç”±</span><br><span class="line">            // å®é™…é¡¹ç›®ä¸­åº”è¯¥æ›´ç²¾ç»†åœ°æ§åˆ¶è·¯ç”±çš„æ›´æ–°</span><br><span class="line">            </span><br><span class="line">            // æ·»åŠ æ–°è·¯ç”±</span><br><span class="line">            for (RouteDefinition routeDefinition : routeDefinitions) &#123;</span><br><span class="line">                routeDefinitionWriter.save(Mono.just(routeDefinition)).subscribe();</span><br><span class="line">                log.info(&quot;æ·»åŠ è·¯ç”±ï¼š&#123;&#125; -&gt; &#123;&#125;&quot;, </span><br><span class="line">                        routeDefinition.getId(), </span><br><span class="line">                        routeDefinition.getUri());</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            log.info(&quot;è·¯ç”±æ›´æ–°å®Œæˆï¼Œå…±&#123;&#125;æ¡è·¯ç”±&quot;, routeDefinitions.size());</span><br><span class="line">            </span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;æ›´æ–°è·¯ç”±é…ç½®å¤±è´¥&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="9-Nacosé…ç½®ç¤ºä¾‹ï¼ˆgateway-routes-jsonï¼‰"><a href="#9-Nacosé…ç½®ç¤ºä¾‹ï¼ˆgateway-routes-jsonï¼‰" class="headerlink" title="9. Nacosé…ç½®ç¤ºä¾‹ï¼ˆgateway-routes.jsonï¼‰"></a>9. Nacosé…ç½®ç¤ºä¾‹ï¼ˆgateway-routes.jsonï¼‰</h3><p>json</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;id&quot;: &quot;auth-service-dynamic&quot;,</span><br><span class="line">    &quot;uri&quot;: &quot;lb://shophub-auth&quot;,</span><br><span class="line">    &quot;predicates&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;name&quot;: &quot;Path&quot;,</span><br><span class="line">        &quot;args&quot;: &#123;</span><br><span class="line">          &quot;pattern&quot;: &quot;/api/auth/v2/**&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;filters&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;name&quot;: &quot;StripPrefix&quot;,</span><br><span class="line">        &quot;args&quot;: &#123;</span><br><span class="line">          &quot;parts&quot;: &quot;1&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;name&quot;: &quot;AddRequestHeader&quot;,</span><br><span class="line">        &quot;args&quot;: &#123;</span><br><span class="line">          &quot;name&quot;: &quot;X-Dynamic-Route&quot;,</span><br><span class="line">          &quot;value&quot;: &quot;true&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;metadata&quot;: &#123;</span><br><span class="line">      &quot;version&quot;: &quot;v2&quot;,</span><br><span class="line">      &quot;description&quot;: &quot;è®¤è¯æœåŠ¡V2ç‰ˆæœ¬è·¯ç”±&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;id&quot;: &quot;product-service-dynamic&quot;,</span><br><span class="line">    &quot;uri&quot;: &quot;lb://shophub-product&quot;,</span><br><span class="line">    &quot;predicates&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;name&quot;: &quot;Path&quot;,</span><br><span class="line">        &quot;args&quot;: &#123;</span><br><span class="line">          &quot;pattern&quot;: &quot;/api/product/v2/**&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;filters&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;name&quot;: &quot;StripPrefix&quot;,</span><br><span class="line">        &quot;args&quot;: &#123;</span><br><span class="line">          &quot;parts&quot;: &quot;1&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;name&quot;: &quot;RequestRateLimiter&quot;,</span><br><span class="line">        &quot;args&quot;: &#123;</span><br><span class="line">          &quot;redis-rate-limiter.replenishRate&quot;: &quot;20&quot;,</span><br><span class="line">          &quot;redis-rate-limiter.burstCapacity&quot;: &quot;40&quot;,</span><br><span class="line">          &quot;key-resolver&quot;: &quot;#&#123;@ipKeyResolver&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h2 id="ç¬¬7å¤©ï¼šä¼˜åŒ–å’Œæµ‹è¯•"><a href="#ç¬¬7å¤©ï¼šä¼˜åŒ–å’Œæµ‹è¯•" class="headerlink" title="ç¬¬7å¤©ï¼šä¼˜åŒ–å’Œæµ‹è¯•"></a>ç¬¬7å¤©ï¼šä¼˜åŒ–å’Œæµ‹è¯•</h2><h3 id="10-ç½‘å…³å¥åº·æ£€æŸ¥ç«¯ç‚¹"><a href="#10-ç½‘å…³å¥åº·æ£€æŸ¥ç«¯ç‚¹" class="headerlink" title="10. ç½‘å…³å¥åº·æ£€æŸ¥ç«¯ç‚¹"></a>10. ç½‘å…³å¥åº·æ£€æŸ¥ç«¯ç‚¹</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.gateway.health;</span><br><span class="line"></span><br><span class="line">import org.springframework.boot.actuate.health.Health;</span><br><span class="line">import org.springframework.boot.actuate.health.ReactiveHealthIndicator;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line">import reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line">import java.net.InetAddress;</span><br><span class="line"></span><br><span class="line">@Component</span><br><span class="line">public class GatewayHealthIndicator implements ReactiveHealthIndicator &#123;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public Mono&lt;Health&gt; health() &#123;</span><br><span class="line">        return checkDownstreamServices()</span><br><span class="line">            .onErrorResume(ex -&gt; </span><br><span class="line">                Mono.just(Health.down(ex).build())</span><br><span class="line">            );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private Mono&lt;Health&gt; checkDownstreamServices() &#123;</span><br><span class="line">        return Mono.fromCallable(() -&gt; &#123;</span><br><span class="line">            // æ£€æŸ¥ç½‘ç»œè¿æ¥</span><br><span class="line">            boolean networkOk = InetAddress.getByName(&quot;www.baidu.com&quot;).isReachable(3000);</span><br><span class="line">            </span><br><span class="line">            // æ£€æŸ¥Redisè¿æ¥ï¼ˆç®€åŒ–ï¼‰</span><br><span class="line">            boolean redisOk = true; // å®é™…åº”è¯¥æ£€æŸ¥Redisè¿æ¥</span><br><span class="line">            </span><br><span class="line">            // æ£€æŸ¥Nacosè¿æ¥ï¼ˆç®€åŒ–ï¼‰</span><br><span class="line">            boolean nacosOk = true;</span><br><span class="line">            </span><br><span class="line">            Health.Builder builder = Health.up();</span><br><span class="line">            </span><br><span class="line">            if (!networkOk) &#123;</span><br><span class="line">                builder.withDetail(&quot;network&quot;, &quot;unreachable&quot;);</span><br><span class="line">                return Health.down().withDetail(&quot;network&quot;, &quot;unreachable&quot;).build();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            if (!redisOk) &#123;</span><br><span class="line">                builder.withDetail(&quot;redis&quot;, &quot;unavailable&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            if (!nacosOk) &#123;</span><br><span class="line">                builder.withDetail(&quot;nacos&quot;, &quot;unavailable&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            return builder.build();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="11-è·¨åŸŸé…ç½®"><a href="#11-è·¨åŸŸé…ç½®" class="headerlink" title="11. è·¨åŸŸé…ç½®"></a>11. è·¨åŸŸé…ç½®</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.gateway.config;</span><br><span class="line"></span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.web.cors.CorsConfiguration;</span><br><span class="line">import org.springframework.web.cors.reactive.CorsWebFilter;</span><br><span class="line">import org.springframework.web.cors.reactive.UrlBasedCorsConfigurationSource;</span><br><span class="line"></span><br><span class="line">import java.util.Arrays;</span><br><span class="line"></span><br><span class="line">@Configuration</span><br><span class="line">public class CorsConfig &#123;</span><br><span class="line">    </span><br><span class="line">    @Bean</span><br><span class="line">    public CorsWebFilter corsWebFilter() &#123;</span><br><span class="line">        CorsConfiguration config = new CorsConfiguration();</span><br><span class="line">        </span><br><span class="line">        // å…è®¸çš„åŸŸ</span><br><span class="line">        config.addAllowedOriginPattern(&quot;*&quot;);</span><br><span class="line">        </span><br><span class="line">        // å…è®¸çš„è¯·æ±‚å¤´</span><br><span class="line">        config.addAllowedHeader(&quot;*&quot;);</span><br><span class="line">        </span><br><span class="line">        // å…è®¸çš„è¯·æ±‚æ–¹æ³•</span><br><span class="line">        config.setAllowedMethods(Arrays.asList(</span><br><span class="line">            &quot;GET&quot;, &quot;POST&quot;, &quot;PUT&quot;, &quot;DELETE&quot;, &quot;OPTIONS&quot;</span><br><span class="line">        ));</span><br><span class="line">        </span><br><span class="line">        // å…è®¸æºå¸¦å‡­è¯</span><br><span class="line">        config.setAllowCredentials(true);</span><br><span class="line">        </span><br><span class="line">        // é¢„æ£€è¯·æ±‚çš„æœ‰æ•ˆæœŸ</span><br><span class="line">        config.setMaxAge(3600L);</span><br><span class="line">        </span><br><span class="line">        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();</span><br><span class="line">        source.registerCorsConfiguration(&quot;/**&quot;, config);</span><br><span class="line">        </span><br><span class="line">        return new CorsWebFilter(source);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="12-æµ‹è¯•è„šæœ¬"><a href="#12-æµ‹è¯•è„šæœ¬" class="headerlink" title="12. æµ‹è¯•è„šæœ¬"></a>12. æµ‹è¯•è„šæœ¬</h3><p>bash</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"># gateway-test.sh</span><br><span class="line"></span><br><span class="line">echo &quot;=== æµ‹è¯•ç½‘å…³æœåŠ¡ ===&quot;</span><br><span class="line"></span><br><span class="line"># 1. æµ‹è¯•ç½‘å…³å¥åº·æ£€æŸ¥</span><br><span class="line">echo &quot;1. æµ‹è¯•å¥åº·æ£€æŸ¥...&quot;</span><br><span class="line">curl -s http://localhost:8888/actuator/health | jq .</span><br><span class="line"></span><br><span class="line"># 2. æµ‹è¯•å…¬å¼€æ¥å£</span><br><span class="line">echo -e &quot;\n2. æµ‹è¯•å…¬å¼€æ¥å£...&quot;</span><br><span class="line">curl -s http://localhost:8888/api/public/hello | jq .</span><br><span class="line"></span><br><span class="line"># 3. æµ‹è¯•éœ€è¦è®¤è¯çš„æ¥å£ï¼ˆä¸å¸¦tokenï¼‰</span><br><span class="line">echo -e &quot;\n3. æµ‹è¯•éœ€è¦è®¤è¯çš„æ¥å£ï¼ˆä¸å¸¦tokenï¼‰...&quot;</span><br><span class="line">curl -s http://localhost:8888/api/auth/current-user | jq .</span><br><span class="line"></span><br><span class="line"># 4. æµ‹è¯•ç™»å½•è·å–token</span><br><span class="line">echo -e &quot;\n4. æµ‹è¯•ç™»å½•...&quot;</span><br><span class="line">LOGIN_RESPONSE=$(curl -s -X POST http://localhost:8888/api/auth/login \</span><br><span class="line">  -H &quot;Content-Type: application/json&quot; \</span><br><span class="line">  -d &#x27;&#123;&quot;username&quot;:&quot;admin&quot;,&quot;password&quot;:&quot;admin123&quot;&#125;&#x27;)</span><br><span class="line"></span><br><span class="line">echo $LOGIN_RESPONSE | jq .</span><br><span class="line">TOKEN=$(echo $LOGIN_RESPONSE | jq -r &#x27;.data.token&#x27;)</span><br><span class="line"></span><br><span class="line"># 5. æµ‹è¯•å¸¦tokençš„è¯·æ±‚</span><br><span class="line">echo -e &quot;\n5. æµ‹è¯•å¸¦tokençš„è¯·æ±‚...&quot;</span><br><span class="line">curl -s http://localhost:8888/api/auth/current-user \</span><br><span class="line">  -H &quot;Authorization: Bearer $TOKEN&quot; | jq .</span><br><span class="line"></span><br><span class="line"># 6. æµ‹è¯•é™æµ</span><br><span class="line">echo -e &quot;\n6. æµ‹è¯•é™æµï¼ˆè¿ç»­è¯·æ±‚10æ¬¡ï¼‰...&quot;</span><br><span class="line">for i in &#123;1..10&#125;; do</span><br><span class="line">  echo &quot;è¯·æ±‚ $i:&quot;</span><br><span class="line">  curl -s -w &quot; HTTPçŠ¶æ€ç : %&#123;http_code&#125;\n&quot; \</span><br><span class="line">    http://localhost:8888/api/auth/current-user \</span><br><span class="line">    -H &quot;Authorization: Bearer $TOKEN&quot; | jq -r &#x27;.code&#x27;</span><br><span class="line">  sleep 0.1</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"># 7. æµ‹è¯•ç½‘å…³æŒ‡æ ‡</span><br><span class="line">echo -e &quot;\n7. æŸ¥çœ‹ç½‘å…³æŒ‡æ ‡...&quot;</span><br><span class="line">curl -s http://localhost:8888/actuator/metrics | jq -r &#x27;.names[]&#x27; | grep gateway</span><br><span class="line"></span><br><span class="line"># 8. æµ‹è¯•ä¸å­˜åœ¨çš„è·¯ç”±</span><br><span class="line">echo -e &quot;\n8. æµ‹è¯•ä¸å­˜åœ¨çš„è·¯ç”±...&quot;</span><br><span class="line">curl -s http://localhost:8888/api/nonexistent | jq .</span><br><span class="line"></span><br><span class="line">echo -e &quot;\n=== æµ‹è¯•å®Œæˆ ===&quot;</span><br></pre></td></tr></table></figure><h3 id="13-Prometheusç›‘æ§é…ç½®"><a href="#13-Prometheusç›‘æ§é…ç½®" class="headerlink" title="13. Prometheusç›‘æ§é…ç½®"></a>13. Prometheusç›‘æ§é…ç½®</h3><p>yaml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># prometheus.yml</span><br><span class="line">global:</span><br><span class="line">  scrape_interval: 15s</span><br><span class="line">  evaluation_interval: 15s</span><br><span class="line"></span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &#x27;shophub-gateway&#x27;</span><br><span class="line">    metrics_path: &#x27;/actuator/prometheus&#x27;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;host.docker.internal:8888&#x27;]</span><br><span class="line">        labels:</span><br><span class="line">          application: &#x27;shophub-gateway&#x27;</span><br><span class="line">          env: &#x27;development&#x27;</span><br><span class="line"></span><br><span class="line">  - job_name: &#x27;shophub-services&#x27;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets:</span><br><span class="line">        - &#x27;host.docker.internal:8081&#x27;  # auth-service</span><br><span class="line">        - &#x27;host.docker.internal:8082&#x27;  # product-service</span><br><span class="line">        - &#x27;host.docker.internal:8083&#x27;  # order-service</span><br><span class="line">    metrics_path: &#x27;/actuator/prometheus&#x27;</span><br></pre></td></tr></table></figure><h3 id="14-å‹åŠ›æµ‹è¯•è„šæœ¬"><a href="#14-å‹åŠ›æµ‹è¯•è„šæœ¬" class="headerlink" title="14. å‹åŠ›æµ‹è¯•è„šæœ¬"></a>14. å‹åŠ›æµ‹è¯•è„šæœ¬</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.gateway.test;</span><br><span class="line"></span><br><span class="line">import io.gatling.javaapi.core.*;</span><br><span class="line">import io.gatling.javaapi.http.*;</span><br><span class="line"></span><br><span class="line">import static io.gatling.javaapi.core.CoreDsl.*;</span><br><span class="line">import static io.gatling.javaapi.http.HttpDsl.*;</span><br><span class="line"></span><br><span class="line">public class GatewayLoadTest extends Simulation &#123;</span><br><span class="line">    </span><br><span class="line">    HttpProtocolBuilder httpProtocol = http</span><br><span class="line">        .baseUrl(&quot;http://localhost:8888&quot;)</span><br><span class="line">        .acceptHeader(&quot;application/json&quot;)</span><br><span class="line">        .userAgentHeader(&quot;Gatling&quot;);</span><br><span class="line">    </span><br><span class="line">    // åœºæ™¯ï¼šæ··åˆè¯·æ±‚</span><br><span class="line">    ScenarioBuilder scn = scenario(&quot;GatewayLoadTest&quot;)</span><br><span class="line">        .exec(</span><br><span class="line">            http(&quot;public_request&quot;)</span><br><span class="line">                .get(&quot;/api/public/hello&quot;)</span><br><span class="line">        )</span><br><span class="line">        .pause(1)</span><br><span class="line">        .exec(</span><br><span class="line">            http(&quot;auth_login&quot;)</span><br><span class="line">                .post(&quot;/api/auth/login&quot;)</span><br><span class="line">                .body(StringBody(&quot;&#123;\&quot;username\&quot;:\&quot;test\&quot;,\&quot;password\&quot;:\&quot;test123\&quot;&#125;&quot;))</span><br><span class="line">                .asJson()</span><br><span class="line">        )</span><br><span class="line">        .pause(1)</span><br><span class="line">        .exec(</span><br><span class="line">            http(&quot;get_product&quot;)</span><br><span class="line">                .get(&quot;/api/product/1&quot;)</span><br><span class="line">        );</span><br><span class="line">    </span><br><span class="line">    &#123;</span><br><span class="line">        setUp(</span><br><span class="line">            scn.injectOpen(</span><br><span class="line">                rampUsers(10).during(10),      // 10ç§’å†…å¢åŠ 10ä¸ªç”¨æˆ·</span><br><span class="line">                constantUsersPerSec(20).during(30),  // 30ç§’å†…ä¿æŒ20ä¸ªç”¨æˆ·/ç§’</span><br><span class="line">                rampUsersPerSec(10).to(50).during(20) // 20ç§’å†…ä»10å¢åŠ åˆ°50ç”¨æˆ·/ç§’</span><br><span class="line">            )</span><br><span class="line">        ).protocols(httpProtocol);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ğŸ¯-ç¬¬äºŒé˜¶æ®µå®Œæˆæ€»ç»“"><a href="#ğŸ¯-ç¬¬äºŒé˜¶æ®µå®Œæˆæ€»ç»“" class="headerlink" title="ğŸ¯ ç¬¬äºŒé˜¶æ®µå®Œæˆæ€»ç»“"></a>ğŸ¯ ç¬¬äºŒé˜¶æ®µå®Œæˆæ€»ç»“</h2><h3 id="å·²å®ç°çš„åŠŸèƒ½ï¼š"><a href="#å·²å®ç°çš„åŠŸèƒ½ï¼š" class="headerlink" title="å·²å®ç°çš„åŠŸèƒ½ï¼š"></a>å·²å®ç°çš„åŠŸèƒ½ï¼š</h3><ol><li><strong>æœåŠ¡æ³¨å†Œä¸å‘ç°</strong>ï¼š<ul><li>é›†æˆNacosä½œä¸ºæ³¨å†Œä¸­å¿ƒ</li><li>æ‰€æœ‰å¾®æœåŠ¡è‡ªåŠ¨æ³¨å†Œ</li></ul></li><li><strong>ç½‘å…³æ ¸å¿ƒåŠŸèƒ½</strong>ï¼š<ul><li>åŠ¨æ€è·¯ç”±é…ç½®</li><li>è´Ÿè½½å‡è¡¡ï¼ˆRibbonï¼‰</li><li>è¯·æ±‚é™æµï¼ˆRedisä»¤ç‰Œæ¡¶ï¼‰</li><li>ç†”æ–­é™çº§ï¼ˆResilience4jï¼‰</li><li>å…¨å±€è®¤è¯ä¸é‰´æƒ</li><li>è·¨åŸŸæ”¯æŒ</li></ul></li><li><strong>é«˜çº§ç‰¹æ€§</strong>ï¼š<ul><li>åŠ¨æ€è·¯ç”±é…ç½®ï¼ˆNacosé…ç½®ä¸­å¿ƒï¼‰</li><li>è¯·æ±‚é“¾è·¯è¿½è¸ª</li><li>æ€§èƒ½ç›‘æ§ï¼ˆPrometheusé›†æˆï¼‰</li><li>å¥åº·æ£€æŸ¥</li><li>ç°åº¦å‘å¸ƒæ”¯æŒï¼ˆé€šè¿‡metadataï¼‰</li></ul></li><li><strong>ç›‘æ§ä¸è¿ç»´</strong>ï¼š<ul><li>Spring Boot Actuatorç«¯ç‚¹</li><li>PrometheusæŒ‡æ ‡æš´éœ²</li><li>è¯·æ±‚æ—¥å¿—è®°å½•</li><li>æ…¢è¯·æ±‚ç›‘æ§</li></ul></li></ol><h3 id="æŠ€æœ¯æ ˆå®è·µï¼š"><a href="#æŠ€æœ¯æ ˆå®è·µï¼š" class="headerlink" title="æŠ€æœ¯æ ˆå®è·µï¼š"></a>æŠ€æœ¯æ ˆå®è·µï¼š</h3><p>âœ… <strong>ç½‘å…³æŠ€æœ¯</strong>ï¼šSpring Cloud Gateway<br>âœ… <strong>æœåŠ¡æ³¨å†Œ</strong>ï¼šNacos Discovery<br>âœ… <strong>é…ç½®ä¸­å¿ƒ</strong>ï¼šNacos Config<br>âœ… <strong>é™æµç®—æ³•</strong>ï¼šä»¤ç‰Œæ¡¶ç®—æ³•<br>âœ… <strong>ç†”æ–­å™¨</strong>ï¼šResilience4j<br>âœ… <strong>è´Ÿè½½å‡è¡¡</strong>ï¼šSpring Cloud LoadBalancer<br>âœ… <strong>ç›‘æ§</strong>ï¼šMicrometer + Prometheus<br>âœ… <strong>åºåˆ—åŒ–</strong>ï¼šJackson<br>âœ… <strong>å“åº”å¼ç¼–ç¨‹</strong>ï¼šWebFlux</p><h3 id="ä¸‹ä¸€æ­¥å»ºè®®ï¼š"><a href="#ä¸‹ä¸€æ­¥å»ºè®®ï¼š" class="headerlink" title="ä¸‹ä¸€æ­¥å»ºè®®ï¼š"></a>ä¸‹ä¸€æ­¥å»ºè®®ï¼š</h3><p>ç¬¬ä¸‰é˜¶æ®µæˆ‘ä»¬å°†å®ç°<strong>å•†å“æœåŠ¡</strong>ï¼Œé‡ç‚¹å®è·µï¼š</p><ol><li>MyBatis Plusæ•°æ®åº“æ“ä½œ</li><li>æ–‡ä»¶ä¸Šä¼ ä¸‹è½½ï¼ˆæ–­ç‚¹ç»­ä¼ ï¼‰</li><li>Redisç¼“å­˜ï¼ˆç¼“å­˜ç©¿é€ã€å‡»ç©¿ã€é›ªå´©è§£å†³æ–¹æ¡ˆï¼‰</li><li>å•†å“åˆ†ç±»ç®¡ç†</li></ol><p>éœ€è¦æˆ‘ç»§ç»­å®ç°å•†å“æœåŠ¡å—ï¼Ÿè¿˜æ˜¯ä½ æƒ³å…ˆäº†è§£æŸä¸ªç‰¹å®šåŠŸèƒ½çš„å®ç°ç»†èŠ‚ï¼Ÿ</p><p>æœ¬å›ç­”ç”± AI ç”Ÿæˆï¼Œå†…å®¹ä»…ä¾›å‚è€ƒï¼Œè¯·ä»”ç»†ç”„åˆ«ã€‚</p><p>ç»§ç»­</p><p>æˆ‘ä»¬ç»§ç»­ç¬¬ä¸‰é˜¶æ®µï¼šå•†å“æœåŠ¡ï¼ˆshophub-productï¼‰çš„å®ç°ã€‚å•†å“æœåŠ¡å°†æ¶µç›–å•†å“ç®¡ç†ã€åˆ†ç±»ç®¡ç†ã€æ–‡ä»¶ä¸Šä¼ ä¸‹è½½ï¼ˆåŒ…æ‹¬æ–­ç‚¹ç»­ä¼ ï¼‰ã€Redisç¼“å­˜åº”ç”¨ç­‰ã€‚<br>ç”±äºå•†å“æœåŠ¡æ¶‰åŠçš„æŠ€æœ¯ç‚¹è¾ƒå¤šï¼Œæˆ‘ä»¬å°†åˆ†æ­¥éª¤å®ç°ã€‚</p><p>ç¬¬8å¤©ï¼šå•†å“æœåŠ¡åŸºç¡€æ¶æ„å’Œå•†å“CRUD<br>ç¬¬9å¤©ï¼šæ–‡ä»¶ä¸Šä¼ ä¸‹è½½ï¼ˆåŒ…æ‹¬æ–­ç‚¹ç»­ä¼ ï¼‰å’Œå•†å“åˆ†ç±»ç®¡ç†</p><p>ç°åœ¨å¼€å§‹ç¬¬8å¤©çš„å†…å®¹ï¼šå•†å“æœåŠ¡åŸºç¡€æ¶æ„å’Œå•†å“CRUDã€‚</p><h1 id="ğŸ›’-ç¬¬ä¸‰é˜¶æ®µï¼šå•†å“æœåŠ¡å®ç°ï¼ˆç¬¬8-9å¤©ï¼‰"><a href="#ğŸ›’-ç¬¬ä¸‰é˜¶æ®µï¼šå•†å“æœåŠ¡å®ç°ï¼ˆç¬¬8-9å¤©ï¼‰" class="headerlink" title="ğŸ›’ ç¬¬ä¸‰é˜¶æ®µï¼šå•†å“æœåŠ¡å®ç°ï¼ˆç¬¬8-9å¤©ï¼‰"></a>ğŸ›’ ç¬¬ä¸‰é˜¶æ®µï¼šå•†å“æœåŠ¡å®ç°ï¼ˆç¬¬8-9å¤©ï¼‰</h1><h2 id="ç¬¬8å¤©ï¼šå•†å“æœåŠ¡åŸºç¡€æ¶æ„-CRUD-ç¼“å­˜ç­–ç•¥"><a href="#ç¬¬8å¤©ï¼šå•†å“æœåŠ¡åŸºç¡€æ¶æ„-CRUD-ç¼“å­˜ç­–ç•¥" class="headerlink" title="ç¬¬8å¤©ï¼šå•†å“æœåŠ¡åŸºç¡€æ¶æ„ + CRUD + ç¼“å­˜ç­–ç•¥"></a>ç¬¬8å¤©ï¼šå•†å“æœåŠ¡åŸºç¡€æ¶æ„ + CRUD + ç¼“å­˜ç­–ç•¥</h2><h3 id="1-å•†å“æœåŠ¡é¡¹ç›®ç»“æ„"><a href="#1-å•†å“æœåŠ¡é¡¹ç›®ç»“æ„" class="headerlink" title="1. å•†å“æœåŠ¡é¡¹ç›®ç»“æ„"></a>1. å•†å“æœåŠ¡é¡¹ç›®ç»“æ„</h3><p>xml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- shophub-product/pom.xml --&gt;</span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;</span><br><span class="line">         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 </span><br><span class="line">         http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;com.shophub&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;shophub-parent&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;1.0.0&lt;/version&gt;</span><br><span class="line">    &lt;/parent&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;artifactId&gt;shophub-product&lt;/artifactId&gt;</span><br><span class="line">    &lt;packaging&gt;jar&lt;/packaging&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;maven.compiler.source&gt;17&lt;/maven.compiler.source&gt;</span><br><span class="line">        &lt;maven.compiler.target&gt;17&lt;/maven.compiler.target&gt;</span><br><span class="line">    &lt;/properties&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;!-- Spring Boot Starter --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- MyBatis Plus --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.baomidou&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;mybatis-plus-boot-starter&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;mybatis-plus.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- MySQLé©±åŠ¨ --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;mysql.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- Redis --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- Redisson --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.redisson&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;redisson-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;redisson.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- Nacos --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- æ–‡ä»¶ä¸Šä¼  --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;commons-fileupload&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;commons-fileupload&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.5&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- å·¥å…·ç±» --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;commons-io&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;commons-io&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;2.11.0&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- éªŒè¯ç  --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.github.penggle&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;kaptcha&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;2.3.2&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- é€šç”¨æ¨¡å— --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.shophub&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;shophub-common&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.0.0&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">        &lt;/plugins&gt;</span><br><span class="line">    &lt;/build&gt;</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure><h3 id="2-å•†å“æœåŠ¡é…ç½®"><a href="#2-å•†å“æœåŠ¡é…ç½®" class="headerlink" title="2. å•†å“æœåŠ¡é…ç½®"></a>2. å•†å“æœåŠ¡é…ç½®</h3><p>yaml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"># application.yml</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: shophub-product</span><br><span class="line">  profiles:</span><br><span class="line">    active: dev</span><br><span class="line">  </span><br><span class="line">  # æ•°æ®æºé…ç½®</span><br><span class="line">  datasource:</span><br><span class="line">    driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="line">    url: jdbc:mysql://$&#123;MYSQL_HOST:localhost&#125;:3306/shophub?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=Asia/Shanghai&amp;useSSL=false</span><br><span class="line">    username: $&#123;MYSQL_USER:root&#125;</span><br><span class="line">    password: $&#123;MYSQL_PASSWORD:root123&#125;</span><br><span class="line">    hikari:</span><br><span class="line">      connection-timeout: 30000</span><br><span class="line">      maximum-pool-size: 20</span><br><span class="line">      minimum-idle: 5</span><br><span class="line">      idle-timeout: 600000</span><br><span class="line">      max-lifetime: 1800000</span><br><span class="line">  </span><br><span class="line">  # Redisé…ç½®</span><br><span class="line">  redis:</span><br><span class="line">    host: $&#123;REDIS_HOST:localhost&#125;</span><br><span class="line">    port: $&#123;REDIS_PORT:6379&#125;</span><br><span class="line">    password: $&#123;REDIS_PASSWORD:redis123&#125;</span><br><span class="line">    database: 1</span><br><span class="line">    lettuce:</span><br><span class="line">      pool:</span><br><span class="line">        max-active: 20</span><br><span class="line">        max-wait: -1ms</span><br><span class="line">        max-idle: 10</span><br><span class="line">        min-idle: 0</span><br><span class="line">      shutdown-timeout: 100ms</span><br><span class="line">  </span><br><span class="line">  # æ–‡ä»¶ä¸Šä¼ é…ç½®</span><br><span class="line">  servlet:</span><br><span class="line">    multipart:</span><br><span class="line">      max-file-size: 100MB</span><br><span class="line">      max-request-size: 200MB</span><br><span class="line">      enabled: true</span><br><span class="line">  </span><br><span class="line">  # Nacosé…ç½®</span><br><span class="line">  cloud:</span><br><span class="line">    nacos:</span><br><span class="line">      discovery:</span><br><span class="line">        server-addr: $&#123;NACOS_HOST:localhost&#125;:$&#123;NACOS_PORT:8848&#125;</span><br><span class="line">        namespace: public</span><br><span class="line">        group: DEFAULT_GROUP</span><br><span class="line"></span><br><span class="line"># MyBatis Plusé…ç½®</span><br><span class="line">mybatis-plus:</span><br><span class="line">  configuration:</span><br><span class="line">    map-underscore-to-camel-case: true</span><br><span class="line">    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl</span><br><span class="line">  global-config:</span><br><span class="line">    db-config:</span><br><span class="line">      id-type: ASSIGN_ID</span><br><span class="line">      logic-delete-field: is_deleted</span><br><span class="line">      logic-delete-value: 1</span><br><span class="line">      logic-not-delete-value: 0</span><br><span class="line"></span><br><span class="line"># æœåŠ¡ç«¯å£</span><br><span class="line">server:</span><br><span class="line">  port: 8082</span><br><span class="line">  servlet:</span><br><span class="line">    context-path: /product</span><br><span class="line">  tomcat:</span><br><span class="line">    max-swallow-size: -1</span><br><span class="line"></span><br><span class="line"># æ—¥å¿—é…ç½®</span><br><span class="line">logging:</span><br><span class="line">  level:</span><br><span class="line">    com.shophub.product.mapper: debug</span><br><span class="line">    com.baomidou.mybatisplus: warn</span><br><span class="line">  pattern:</span><br><span class="line">    console: &#x27;%d&#123;yyyy-MM-dd HH:mm:ss&#125; [%thread] %-5level %logger&#123;36&#125; - %msg%n&#x27;</span><br><span class="line">  file:</span><br><span class="line">    name: logs/product-service.log</span><br><span class="line">    max-size: 10MB</span><br><span class="line">    max-history: 30</span><br><span class="line"></span><br><span class="line"># ç¼“å­˜é…ç½®</span><br><span class="line">cache:</span><br><span class="line">  type: redis</span><br><span class="line">  redis:</span><br><span class="line">    time-to-live: 3600000  # 1å°æ—¶</span><br><span class="line">    cache-null-values: true</span><br><span class="line">    key-prefix: &quot;product:&quot;</span><br><span class="line">    use-key-prefix: true</span><br><span class="line"></span><br><span class="line"># å•†å“æœåŠ¡é…ç½®</span><br><span class="line">product:</span><br><span class="line">  # ç¼“å­˜é…ç½®</span><br><span class="line">  cache:</span><br><span class="line">    product-detail-ttl: 1800  # å•†å“è¯¦æƒ…ç¼“å­˜30åˆ†é’Ÿ</span><br><span class="line">    product-list-ttl: 300     # å•†å“åˆ—è¡¨ç¼“å­˜5åˆ†é’Ÿ</span><br><span class="line">    category-ttl: 86400       # åˆ†ç±»ç¼“å­˜1å¤©</span><br><span class="line">  </span><br><span class="line">  # ä¸Šä¼ é…ç½®</span><br><span class="line">  upload:</span><br><span class="line">    base-dir: /data/upload/product</span><br><span class="line">    temp-dir: /data/temp</span><br><span class="line">    max-size: 104857600  # 100MB</span><br><span class="line">    allowed-extensions: jpg,jpeg,png,gif,bmp,webp</span><br><span class="line">    </span><br><span class="line">  # å•†å“é…ç½®</span><br><span class="line">  default-stock: 1000    # é»˜è®¤åº“å­˜</span><br><span class="line">  hot-threshold: 100     # çƒ­é”€é˜ˆå€¼</span><br><span class="line">  new-days: 7            # æ–°å“å¤©æ•°</span><br><span class="line"></span><br><span class="line"># ç®¡ç†ç«¯ç‚¹</span><br><span class="line">management:</span><br><span class="line">  endpoints:</span><br><span class="line">    web:</span><br><span class="line">      exposure:</span><br><span class="line">        include: health,info,metrics,prometheus</span><br><span class="line">  endpoint:</span><br><span class="line">    health:</span><br><span class="line">      show-details: always</span><br></pre></td></tr></table></figure><h3 id="3-å•†å“å®ä½“ç±»è®¾è®¡"><a href="#3-å•†å“å®ä½“ç±»è®¾è®¡" class="headerlink" title="3. å•†å“å®ä½“ç±»è®¾è®¡"></a>3. å•†å“å®ä½“ç±»è®¾è®¡</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.product.entity;</span><br><span class="line"></span><br><span class="line">import com.baomidou.mybatisplus.annotation.*;</span><br><span class="line">import com.fasterxml.jackson.annotation.JsonFormat;</span><br><span class="line">import lombok.Data;</span><br><span class="line">import lombok.EqualsAndHashCode;</span><br><span class="line"></span><br><span class="line">import java.io.Serializable;</span><br><span class="line">import java.math.BigDecimal;</span><br><span class="line">import java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * å•†å“å®ä½“ç±»</span><br><span class="line"> */</span><br><span class="line">@Data</span><br><span class="line">@EqualsAndHashCode(callSuper = false)</span><br><span class="line">@TableName(&quot;product&quot;)</span><br><span class="line">public class Product implements Serializable &#123;</span><br><span class="line">    </span><br><span class="line">    private static final long serialVersionUID = 1L;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å•†å“ID - ä½¿ç”¨é›ªèŠ±ç®—æ³•</span><br><span class="line">     */</span><br><span class="line">    @TableId(value = &quot;id&quot;, type = IdType.ASSIGN_ID)</span><br><span class="line">    private Long id;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å•†å“ç¼–å·</span><br><span class="line">     */</span><br><span class="line">    private String productNo;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å•†å“åç§°</span><br><span class="line">     */</span><br><span class="line">    private String productName;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆ†ç±»ID</span><br><span class="line">     */</span><br><span class="line">    private Long categoryId;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å“ç‰Œ</span><br><span class="line">     */</span><br><span class="line">    private String brand;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * é”€å”®ä»·æ ¼</span><br><span class="line">     */</span><br><span class="line">    private BigDecimal price;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å¸‚åœºä»·æ ¼</span><br><span class="line">     */</span><br><span class="line">    private BigDecimal marketPrice;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æˆæœ¬ä»·æ ¼</span><br><span class="line">     */</span><br><span class="line">    private BigDecimal costPrice;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åº“å­˜</span><br><span class="line">     */</span><br><span class="line">    private Integer stock;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * é”€é‡</span><br><span class="line">     */</span><br><span class="line">    private Integer saleCount;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * ä¸»å›¾</span><br><span class="line">     */</span><br><span class="line">    private String mainImage;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å­å›¾ï¼ˆJSONæ•°ç»„ï¼‰</span><br><span class="line">     */</span><br><span class="line">    private String subImages;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å•†å“è¯¦æƒ…ï¼ˆå¯Œæ–‡æœ¬ï¼‰</span><br><span class="line">     */</span><br><span class="line">    private String detail;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * çŠ¶æ€ï¼š0-ä¸‹æ¶ï¼Œ1-ä¸Šæ¶</span><br><span class="line">     */</span><br><span class="line">    private Integer status;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ˜¯å¦çƒ­é”€ï¼š0-å¦ï¼Œ1-æ˜¯</span><br><span class="line">     */</span><br><span class="line">    private Integer isHot;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ˜¯å¦æ–°å“ï¼š0-å¦ï¼Œ1-æ˜¯</span><br><span class="line">     */</span><br><span class="line">    private Integer isNew;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * é‡é‡ï¼ˆkgï¼‰</span><br><span class="line">     */</span><br><span class="line">    private BigDecimal weight;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å•ä½</span><br><span class="line">     */</span><br><span class="line">    private String unit;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆ›å»ºæ—¶é—´</span><br><span class="line">     */</span><br><span class="line">    @TableField(fill = FieldFill.INSERT)</span><br><span class="line">    @JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span><br><span class="line">    private LocalDateTime createTime;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ›´æ–°æ—¶é—´</span><br><span class="line">     */</span><br><span class="line">    @TableField(fill = FieldFill.INSERT_UPDATE)</span><br><span class="line">    @JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span><br><span class="line">    private LocalDateTime updateTime;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * é€»è¾‘åˆ é™¤</span><br><span class="line">     */</span><br><span class="line">    @TableLogic</span><br><span class="line">    private Integer isDeleted;</span><br><span class="line">    </span><br><span class="line">    // å…³è”å­—æ®µï¼ˆä¸å­˜æ•°æ®åº“ï¼‰</span><br><span class="line">    @TableField(exist = false)</span><br><span class="line">    private String categoryName;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// å•†å“åˆ†ç±»å®ä½“</span><br><span class="line">@Data</span><br><span class="line">@EqualsAndHashCode(callSuper = false)</span><br><span class="line">@TableName(&quot;product_category&quot;)</span><br><span class="line">class ProductCategory &#123;</span><br><span class="line">    @TableId(value = &quot;id&quot;, type = IdType.ASSIGN_ID)</span><br><span class="line">    private Long id;</span><br><span class="line">    </span><br><span class="line">    private String categoryName;</span><br><span class="line">    private Long parentId;</span><br><span class="line">    private Integer level;</span><br><span class="line">    private Integer sort;</span><br><span class="line">    private Integer status;</span><br><span class="line">    </span><br><span class="line">    @TableField(fill = FieldFill.INSERT)</span><br><span class="line">    private LocalDateTime createTime;</span><br><span class="line">    </span><br><span class="line">    @TableField(fill = FieldFill.INSERT_UPDATE)</span><br><span class="line">    private LocalDateTime updateTime;</span><br><span class="line">    </span><br><span class="line">    // å­åˆ†ç±»</span><br><span class="line">    @TableField(exist = false)</span><br><span class="line">    private List&lt;ProductCategory&gt; children;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// å•†å“è§„æ ¼å®ä½“</span><br><span class="line">@Data</span><br><span class="line">@EqualsAndHashCode(callSuper = false)</span><br><span class="line">@TableName(&quot;product_spec&quot;)</span><br><span class="line">class ProductSpec &#123;</span><br><span class="line">    @TableId(value = &quot;id&quot;, type = IdType.ASSIGN_ID)</span><br><span class="line">    private Long id;</span><br><span class="line">    </span><br><span class="line">    private Long productId;</span><br><span class="line">    private String specName;    // è§„æ ¼åç§°ï¼šé¢œè‰²ã€å°ºå¯¸ç­‰</span><br><span class="line">    private String specValue;   // è§„æ ¼å€¼ï¼šçº¢è‰²ã€XLç­‰</span><br><span class="line">    private BigDecimal price;   // è§„æ ¼ä»·æ ¼</span><br><span class="line">    private Integer stock;      // è§„æ ¼åº“å­˜</span><br><span class="line">    private String image;       // è§„æ ¼å›¾ç‰‡</span><br><span class="line">    </span><br><span class="line">    @TableField(fill = FieldFill.INSERT)</span><br><span class="line">    private LocalDateTime createTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-MyBatis-Plusé…ç½®å’Œå…ƒå¯¹è±¡å¤„ç†å™¨"><a href="#4-MyBatis-Plusé…ç½®å’Œå…ƒå¯¹è±¡å¤„ç†å™¨" class="headerlink" title="4. MyBatis Plusé…ç½®å’Œå…ƒå¯¹è±¡å¤„ç†å™¨"></a>4. MyBatis Plusé…ç½®å’Œå…ƒå¯¹è±¡å¤„ç†å™¨</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.product.config;</span><br><span class="line"></span><br><span class="line">import com.baomidou.mybatisplus.annotation.DbType;</span><br><span class="line">import com.baomidou.mybatisplus.core.handlers.MetaObjectHandler;</span><br><span class="line">import com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor;</span><br><span class="line">import com.baomidou.mybatisplus.extension.plugins.inner.BlockAttackInnerInterceptor;</span><br><span class="line">import com.baomidou.mybatisplus.extension.plugins.inner.PaginationInnerInterceptor;</span><br><span class="line">import org.apache.ibatis.reflection.MetaObject;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line">import java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * MyBatis Plusé…ç½®</span><br><span class="line"> */</span><br><span class="line">@Configuration</span><br><span class="line">public class MybatisPlusConfig implements MetaObjectHandler &#123;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆ†é¡µæ’ä»¶</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public MybatisPlusInterceptor mybatisPlusInterceptor() &#123;</span><br><span class="line">        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();</span><br><span class="line">        </span><br><span class="line">        // åˆ†é¡µæ’ä»¶</span><br><span class="line">        PaginationInnerInterceptor paginationInterceptor = new PaginationInnerInterceptor(DbType.MYSQL);</span><br><span class="line">        paginationInterceptor.setMaxLimit(1000L);</span><br><span class="line">        paginationInterceptor.setOverflow(true);</span><br><span class="line">        interceptor.addInnerInterceptor(paginationInterceptor);</span><br><span class="line">        </span><br><span class="line">        // é˜²æ­¢å…¨è¡¨æ›´æ–°ä¸åˆ é™¤</span><br><span class="line">        interceptor.addInnerInterceptor(new BlockAttackInnerInterceptor());</span><br><span class="line">        </span><br><span class="line">        return interceptor;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è‡ªåŠ¨å¡«å……åˆ›å»ºæ—¶é—´</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public void insertFill(MetaObject metaObject) &#123;</span><br><span class="line">        this.strictInsertFill(metaObject, &quot;createTime&quot;, LocalDateTime.class, LocalDateTime.now());</span><br><span class="line">        this.strictInsertFill(metaObject, &quot;updateTime&quot;, LocalDateTime.class, LocalDateTime.now());</span><br><span class="line">        this.strictInsertFill(metaObject, &quot;isDeleted&quot;, Integer.class, 0);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è‡ªåŠ¨å¡«å……æ›´æ–°æ—¶é—´</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public void updateFill(MetaObject metaObject) &#123;</span><br><span class="line">        this.strictUpdateFill(metaObject, &quot;updateTime&quot;, LocalDateTime.class, LocalDateTime.now());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// åˆ†é¡µå‚æ•°å°è£…</span><br><span class="line">@Data</span><br><span class="line">class PageParam &#123;</span><br><span class="line">    private Integer pageNum = 1;</span><br><span class="line">    private Integer pageSize = 10;</span><br><span class="line">    private String orderBy;</span><br><span class="line">    private Boolean asc = true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// åˆ†é¡µç»“æœå°è£…</span><br><span class="line">@Data</span><br><span class="line">class PageResult&lt;T&gt; &#123;</span><br><span class="line">    private List&lt;T&gt; records;</span><br><span class="line">    private Long total;</span><br><span class="line">    private Long pageNum;</span><br><span class="line">    private Long pageSize;</span><br><span class="line">    private Long pages;</span><br><span class="line">    </span><br><span class="line">    public PageResult(List&lt;T&gt; records, Long total, Long pageNum, Long pageSize) &#123;</span><br><span class="line">        this.records = records;</span><br><span class="line">        this.total = total;</span><br><span class="line">        this.pageNum = pageNum;</span><br><span class="line">        this.pageSize = pageSize;</span><br><span class="line">        this.pages = (total + pageSize - 1) / pageSize;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-å•†å“Mapperå’ŒService"><a href="#5-å•†å“Mapperå’ŒService" class="headerlink" title="5. å•†å“Mapperå’ŒService"></a>5. å•†å“Mapperå’ŒService</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line">// ProductMapper.java</span><br><span class="line">package com.shophub.product.mapper;</span><br><span class="line"></span><br><span class="line">import com.baomidou.mybatisplus.core.mapper.BaseMapper;</span><br><span class="line">import com.baomidou.mybatisplus.core.metadata.IPage;</span><br><span class="line">import com.baomidou.mybatisplus.extension.plugins.pagination.Page;</span><br><span class="line">import com.shophub.product.entity.Product;</span><br><span class="line">import com.shophub.product.entity.vo.ProductVo;</span><br><span class="line">import org.apache.ibatis.annotations.Param;</span><br><span class="line">import org.apache.ibatis.annotations.Select;</span><br><span class="line">import org.apache.ibatis.annotations.Update;</span><br><span class="line"></span><br><span class="line">import java.math.BigDecimal;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">public interface ProductMapper extends BaseMapper&lt;Product&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆ†é¡µæŸ¥è¯¢å•†å“åˆ—è¡¨ï¼ˆå¸¦æ¡ä»¶ï¼‰</span><br><span class="line">     */</span><br><span class="line">    IPage&lt;ProductVo&gt; selectProductPage(Page&lt;ProductVo&gt; page, </span><br><span class="line">                                       @Param(&quot;categoryId&quot;) Long categoryId,</span><br><span class="line">                                       @Param(&quot;keyword&quot;) String keyword,</span><br><span class="line">                                       @Param(&quot;minPrice&quot;) BigDecimal minPrice,</span><br><span class="line">                                       @Param(&quot;maxPrice&quot;) BigDecimal maxPrice,</span><br><span class="line">                                       @Param(&quot;brand&quot;) String brand,</span><br><span class="line">                                       @Param(&quot;status&quot;) Integer status,</span><br><span class="line">                                       @Param(&quot;isHot&quot;) Integer isHot,</span><br><span class="line">                                       @Param(&quot;isNew&quot;) Integer isNew);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ ¹æ®IDæŸ¥è¯¢å•†å“è¯¦æƒ…ï¼ˆå¸¦åˆ†ç±»ä¿¡æ¯ï¼‰</span><br><span class="line">     */</span><br><span class="line">    ProductVo selectProductDetail(@Param(&quot;id&quot;) Long id);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ‰¹é‡æ›´æ–°å•†å“çŠ¶æ€</span><br><span class="line">     */</span><br><span class="line">    int updateStatusBatch(@Param(&quot;ids&quot;) List&lt;Long&gt; ids, </span><br><span class="line">                         @Param(&quot;status&quot;) Integer status);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å‡å°‘åº“å­˜</span><br><span class="line">     */</span><br><span class="line">    @Update(&quot;UPDATE product SET stock = stock - #&#123;quantity&#125; WHERE id = #&#123;id&#125; AND stock &gt;= #&#123;quantity&#125;&quot;)</span><br><span class="line">    int reduceStock(@Param(&quot;id&quot;) Long id, @Param(&quot;quantity&quot;) Integer quantity);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å¢åŠ é”€é‡</span><br><span class="line">     */</span><br><span class="line">    @Update(&quot;UPDATE product SET sale_count = sale_count + #&#123;quantity&#125; WHERE id = #&#123;id&#125;&quot;)</span><br><span class="line">    int increaseSale(@Param(&quot;id&quot;) Long id, @Param(&quot;quantity&quot;) Integer quantity);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è·å–çƒ­é—¨å•†å“</span><br><span class="line">     */</span><br><span class="line">    @Select(&quot;SELECT * FROM product WHERE status = 1 AND is_hot = 1 ORDER BY sale_count DESC LIMIT #&#123;limit&#125;&quot;)</span><br><span class="line">    List&lt;Product&gt; selectHotProducts(@Param(&quot;limit&quot;) int limit);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è·å–æ–°å“</span><br><span class="line">     */</span><br><span class="line">    @Select(&quot;SELECT * FROM product WHERE status = 1 AND is_new = 1 AND create_time &gt;= DATE_SUB(NOW(), INTERVAL 7 DAY) ORDER BY create_time DESC LIMIT #&#123;limit&#125;&quot;)</span><br><span class="line">    List&lt;Product&gt; selectNewProducts(@Param(&quot;limit&quot;) int limit);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// ProductMapper.xml</span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; </span><br><span class="line">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span><br><span class="line">&lt;mapper namespace=&quot;com.shophub.product.mapper.ProductMapper&quot;&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;resultMap id=&quot;ProductVoMap&quot; type=&quot;com.shophub.product.entity.vo.ProductVo&quot;&gt;</span><br><span class="line">        &lt;id column=&quot;id&quot; property=&quot;id&quot;/&gt;</span><br><span class="line">        &lt;result column=&quot;product_no&quot; property=&quot;productNo&quot;/&gt;</span><br><span class="line">        &lt;result column=&quot;product_name&quot; property=&quot;productName&quot;/&gt;</span><br><span class="line">        &lt;result column=&quot;category_id&quot; property=&quot;categoryId&quot;/&gt;</span><br><span class="line">        &lt;result column=&quot;category_name&quot; property=&quot;categoryName&quot;/&gt;</span><br><span class="line">        &lt;result column=&quot;brand&quot; property=&quot;brand&quot;/&gt;</span><br><span class="line">        &lt;result column=&quot;price&quot; property=&quot;price&quot;/&gt;</span><br><span class="line">        &lt;result column=&quot;market_price&quot; property=&quot;marketPrice&quot;/&gt;</span><br><span class="line">        &lt;result column=&quot;cost_price&quot; property=&quot;costPrice&quot;/&gt;</span><br><span class="line">        &lt;result column=&quot;stock&quot; property=&quot;stock&quot;/&gt;</span><br><span class="line">        &lt;result column=&quot;sale_count&quot; property=&quot;saleCount&quot;/&gt;</span><br><span class="line">        &lt;result column=&quot;main_image&quot; property=&quot;mainImage&quot;/&gt;</span><br><span class="line">        &lt;result column=&quot;sub_images&quot; property=&quot;subImages&quot;/&gt;</span><br><span class="line">        &lt;result column=&quot;detail&quot; property=&quot;detail&quot;/&gt;</span><br><span class="line">        &lt;result column=&quot;status&quot; property=&quot;status&quot;/&gt;</span><br><span class="line">        &lt;result column=&quot;is_hot&quot; property=&quot;isHot&quot;/&gt;</span><br><span class="line">        &lt;result column=&quot;is_new&quot; property=&quot;isNew&quot;/&gt;</span><br><span class="line">        &lt;result column=&quot;weight&quot; property=&quot;weight&quot;/&gt;</span><br><span class="line">        &lt;result column=&quot;unit&quot; property=&quot;unit&quot;/&gt;</span><br><span class="line">        &lt;result column=&quot;create_time&quot; property=&quot;createTime&quot;/&gt;</span><br><span class="line">        &lt;result column=&quot;update_time&quot; property=&quot;updateTime&quot;/&gt;</span><br><span class="line">    &lt;/resultMap&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;select id=&quot;selectProductPage&quot; resultMap=&quot;ProductVoMap&quot;&gt;</span><br><span class="line">        SELECT </span><br><span class="line">            p.*,</span><br><span class="line">            pc.category_name</span><br><span class="line">        FROM product p</span><br><span class="line">        LEFT JOIN product_category pc ON p.category_id = pc.id</span><br><span class="line">        WHERE p.is_deleted = 0</span><br><span class="line">        &lt;if test=&quot;categoryId != null&quot;&gt;</span><br><span class="line">            AND p.category_id = #&#123;categoryId&#125;</span><br><span class="line">        &lt;/if&gt;</span><br><span class="line">        &lt;if test=&quot;keyword != null and keyword != &#x27;&#x27;&quot;&gt;</span><br><span class="line">            AND (p.product_name LIKE CONCAT(&#x27;%&#x27;, #&#123;keyword&#125;, &#x27;%&#x27;) </span><br><span class="line">                 OR p.product_no LIKE CONCAT(&#x27;%&#x27;, #&#123;keyword&#125;, &#x27;%&#x27;))</span><br><span class="line">        &lt;/if&gt;</span><br><span class="line">        &lt;if test=&quot;minPrice != null&quot;&gt;</span><br><span class="line">            AND p.price &gt;= #&#123;minPrice&#125;</span><br><span class="line">        &lt;/if&gt;</span><br><span class="line">        &lt;if test=&quot;maxPrice != null&quot;&gt;</span><br><span class="line">            AND p.price &lt;= #&#123;maxPrice&#125;</span><br><span class="line">        &lt;/if&gt;</span><br><span class="line">        &lt;if test=&quot;brand != null and brand != &#x27;&#x27;&quot;&gt;</span><br><span class="line">            AND p.brand = #&#123;brand&#125;</span><br><span class="line">        &lt;/if&gt;</span><br><span class="line">        &lt;if test=&quot;status != null&quot;&gt;</span><br><span class="line">            AND p.status = #&#123;status&#125;</span><br><span class="line">        &lt;/if&gt;</span><br><span class="line">        &lt;if test=&quot;isHot != null&quot;&gt;</span><br><span class="line">            AND p.is_hot = #&#123;isHot&#125;</span><br><span class="line">        &lt;/if&gt;</span><br><span class="line">        &lt;if test=&quot;isNew != null&quot;&gt;</span><br><span class="line">            AND p.is_new = #&#123;isNew&#125;</span><br><span class="line">        &lt;/if&gt;</span><br><span class="line">        ORDER BY p.create_time DESC</span><br><span class="line">    &lt;/select&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;select id=&quot;selectProductDetail&quot; resultMap=&quot;ProductVoMap&quot;&gt;</span><br><span class="line">        SELECT </span><br><span class="line">            p.*,</span><br><span class="line">            pc.category_name</span><br><span class="line">        FROM product p</span><br><span class="line">        LEFT JOIN product_category pc ON p.category_id = pc.id</span><br><span class="line">        WHERE p.id = #&#123;id&#125; AND p.is_deleted = 0</span><br><span class="line">    &lt;/select&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;update id=&quot;updateStatusBatch&quot;&gt;</span><br><span class="line">        UPDATE product </span><br><span class="line">        SET status = #&#123;status&#125;, update_time = NOW()</span><br><span class="line">        WHERE id IN </span><br><span class="line">        &lt;foreach collection=&quot;ids&quot; item=&quot;id&quot; open=&quot;(&quot; separator=&quot;,&quot; close=&quot;)&quot;&gt;</span><br><span class="line">            #&#123;id&#125;</span><br><span class="line">        &lt;/foreach&gt;</span><br><span class="line">    &lt;/update&gt;</span><br><span class="line">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure><h3 id="6-å•†å“Serviceå®ç°ï¼ˆåŒ…å«ç¼“å­˜ç­–ç•¥ï¼‰"><a href="#6-å•†å“Serviceå®ç°ï¼ˆåŒ…å«ç¼“å­˜ç­–ç•¥ï¼‰" class="headerlink" title="6. å•†å“Serviceå®ç°ï¼ˆåŒ…å«ç¼“å­˜ç­–ç•¥ï¼‰"></a>6. å•†å“Serviceå®ç°ï¼ˆåŒ…å«ç¼“å­˜ç­–ç•¥ï¼‰</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.product.service;</span><br><span class="line"></span><br><span class="line">import com.baomidou.mybatisplus.extension.service.IService;</span><br><span class="line">import com.shophub.product.entity.Product;</span><br><span class="line">import com.shophub.product.entity.vo.ProductVo;</span><br><span class="line"></span><br><span class="line">import java.math.BigDecimal;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">public interface ProductService extends IService&lt;Product&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ·»åŠ å•†å“</span><br><span class="line">     */</span><br><span class="line">    Long addProduct(Product product);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ›´æ–°å•†å“</span><br><span class="line">     */</span><br><span class="line">    boolean updateProduct(Product product);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆ é™¤å•†å“ï¼ˆé€»è¾‘åˆ é™¤ï¼‰</span><br><span class="line">     */</span><br><span class="line">    boolean deleteProduct(Long id);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ‰¹é‡åˆ é™¤å•†å“</span><br><span class="line">     */</span><br><span class="line">    boolean deleteProductBatch(List&lt;Long&gt; ids);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è·å–å•†å“è¯¦æƒ…ï¼ˆå¸¦ç¼“å­˜ï¼‰</span><br><span class="line">     */</span><br><span class="line">    ProductVo getProductDetail(Long id);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆ†é¡µæŸ¥è¯¢å•†å“åˆ—è¡¨</span><br><span class="line">     */</span><br><span class="line">    PageResult&lt;ProductVo&gt; getProductPage(PageParam param, </span><br><span class="line">                                        Long categoryId,</span><br><span class="line">                                        String keyword,</span><br><span class="line">                                        BigDecimal minPrice,</span><br><span class="line">                                        BigDecimal maxPrice,</span><br><span class="line">                                        String brand,</span><br><span class="line">                                        Integer status,</span><br><span class="line">                                        Integer isHot,</span><br><span class="line">                                        Integer isNew);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ›´æ–°å•†å“çŠ¶æ€</span><br><span class="line">     */</span><br><span class="line">    boolean updateStatus(Long id, Integer status);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ‰¹é‡æ›´æ–°å•†å“çŠ¶æ€</span><br><span class="line">     */</span><br><span class="line">    boolean updateStatusBatch(List&lt;Long&gt; ids, Integer status);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å‡å°‘åº“å­˜</span><br><span class="line">     */</span><br><span class="line">    boolean reduceStock(Long id, Integer quantity);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å¢åŠ é”€é‡</span><br><span class="line">     */</span><br><span class="line">    boolean increaseSale(Long id, Integer quantity);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è·å–çƒ­é—¨å•†å“</span><br><span class="line">     */</span><br><span class="line">    List&lt;Product&gt; getHotProducts(int limit);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è·å–æ–°å“</span><br><span class="line">     */</span><br><span class="line">    List&lt;Product&gt; getNewProducts(int limit);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å•†å“ä¸Šæ¶</span><br><span class="line">     */</span><br><span class="line">    boolean onShelf(Long id);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å•†å“ä¸‹æ¶</span><br><span class="line">     */</span><br><span class="line">    boolean offShelf(Long id);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è®¾ç½®çƒ­é”€å•†å“</span><br><span class="line">     */</span><br><span class="line">    boolean setHot(Long id, boolean hot);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è®¾ç½®æ–°å“</span><br><span class="line">     */</span><br><span class="line">    boolean setNew(Long id, boolean isNew);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// ProductServiceImpl.java</span><br><span class="line">package com.shophub.product.service.impl;</span><br><span class="line"></span><br><span class="line">import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;</span><br><span class="line">import com.baomidou.mybatisplus.core.metadata.IPage;</span><br><span class="line">import com.baomidou.mybatisplus.extension.plugins.pagination.Page;</span><br><span class="line">import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span><br><span class="line">import com.shophub.common.exception.BusinessException;</span><br><span class="line">import com.shophub.common.id.SnowflakeIdGenerator;</span><br><span class="line">import com.shophub.common.redis.RedisUtil;</span><br><span class="line">import com.shophub.common.result.ResultCode;</span><br><span class="line">import com.shophub.product.entity.Product;</span><br><span class="line">import com.shophub.product.entity.vo.ProductVo;</span><br><span class="line">import com.shophub.product.mapper.ProductMapper;</span><br><span class="line">import com.shophub.product.service.ProductService;</span><br><span class="line">import lombok.RequiredArgsConstructor;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.redisson.api.RBloomFilter;</span><br><span class="line">import org.redisson.api.RLock;</span><br><span class="line">import org.redisson.api.RedissonClient;</span><br><span class="line">import org.springframework.beans.BeanUtils;</span><br><span class="line">import org.springframework.cache.annotation.CacheEvict;</span><br><span class="line">import org.springframework.cache.annotation.Cacheable;</span><br><span class="line">import org.springframework.cache.annotation.Caching;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line">import org.springframework.transaction.annotation.Transactional;</span><br><span class="line">import org.springframework.util.StringUtils;</span><br><span class="line"></span><br><span class="line">import java.math.BigDecimal;</span><br><span class="line">import java.time.LocalDateTime;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@Service</span><br><span class="line">@RequiredArgsConstructor</span><br><span class="line">public class ProductServiceImpl extends ServiceImpl&lt;ProductMapper, Product&gt; implements ProductService &#123;</span><br><span class="line">    </span><br><span class="line">    private final ProductMapper productMapper;</span><br><span class="line">    private final SnowflakeIdGenerator idGenerator;</span><br><span class="line">    private final RedisUtil redisUtil;</span><br><span class="line">    private final RedissonClient redissonClient;</span><br><span class="line">    private final RBloomFilter&lt;String&gt; productBloomFilter;</span><br><span class="line">    </span><br><span class="line">    // ç¼“å­˜keyå‰ç¼€</span><br><span class="line">    private static final String PRODUCT_CACHE_PREFIX = &quot;product:detail:&quot;;</span><br><span class="line">    private static final String PRODUCT_STOCK_CACHE_PREFIX = &quot;product:stock:&quot;;</span><br><span class="line">    private static final String HOT_PRODUCTS_CACHE_KEY = &quot;product:hot:list&quot;;</span><br><span class="line">    private static final String NEW_PRODUCTS_CACHE_KEY = &quot;product:new:list&quot;;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    @Transactional(rollbackFor = Exception.class)</span><br><span class="line">    public Long addProduct(Product product) &#123;</span><br><span class="line">        // ç”Ÿæˆå•†å“ID</span><br><span class="line">        Long productId = idGenerator.nextId();</span><br><span class="line">        product.setId(productId);</span><br><span class="line">        </span><br><span class="line">        // ç”Ÿæˆå•†å“ç¼–å·</span><br><span class="line">        String productNo = generateProductNo();</span><br><span class="line">        product.setProductNo(productNo);</span><br><span class="line">        </span><br><span class="line">        // è®¾ç½®é»˜è®¤å€¼</span><br><span class="line">        if (product.getStock() == null) &#123;</span><br><span class="line">            product.setStock(1000);</span><br><span class="line">        &#125;</span><br><span class="line">        if (product.getSaleCount() == null) &#123;</span><br><span class="line">            product.setSaleCount(0);</span><br><span class="line">        &#125;</span><br><span class="line">        if (product.getStatus() == null) &#123;</span><br><span class="line">            product.setStatus(1); // é»˜è®¤ä¸Šæ¶</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // ä¿å­˜åˆ°æ•°æ®åº“</span><br><span class="line">        boolean success = save(product);</span><br><span class="line">        if (!success) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.SYSTEM_ERROR, &quot;å•†å“æ·»åŠ å¤±è´¥&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // æ·»åŠ åˆ°å¸ƒéš†è¿‡æ»¤å™¨</span><br><span class="line">        productBloomFilter.add(String.valueOf(productId));</span><br><span class="line">        </span><br><span class="line">        log.info(&quot;æ·»åŠ å•†å“æˆåŠŸï¼Œå•†å“IDï¼š&#123;&#125;ï¼Œå•†å“ç¼–å·ï¼š&#123;&#125;&quot;, productId, productNo);</span><br><span class="line">        return productId;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    @Caching(evict = &#123;</span><br><span class="line">        @CacheEvict(value = &quot;product&quot;, key = &quot;&#x27;detail:&#x27; + #product.id&quot;),</span><br><span class="line">        @CacheEvict(value = &quot;product&quot;, key = &quot;&#x27;hot:list&#x27;&quot;),</span><br><span class="line">        @CacheEvict(value = &quot;product&quot;, key = &quot;&#x27;new:list&#x27;&quot;)</span><br><span class="line">    &#125;)</span><br><span class="line">    @Transactional(rollbackFor = Exception.class)</span><br><span class="line">    public boolean updateProduct(Product product) &#123;</span><br><span class="line">        if (product.getId() == null) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.PARAM_VALID_ERROR, &quot;å•†å“IDä¸èƒ½ä¸ºç©º&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // æ£€æŸ¥å•†å“æ˜¯å¦å­˜åœ¨</span><br><span class="line">        if (!productBloomFilter.contains(String.valueOf(product.getId()))) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.RESOURCE_NOT_FOUND, &quot;å•†å“ä¸å­˜åœ¨&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // æ›´æ–°æ•°æ®åº“</span><br><span class="line">        boolean success = updateById(product);</span><br><span class="line">        if (success) &#123;</span><br><span class="line">            // æ¸…é™¤ç¼“å­˜</span><br><span class="line">            redisUtil.delete(PRODUCT_CACHE_PREFIX + product.getId());</span><br><span class="line">            log.info(&quot;æ›´æ–°å•†å“æˆåŠŸï¼Œå•†å“IDï¼š&#123;&#125;&quot;, product.getId());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return success;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    @Transactional(rollbackFor = Exception.class)</span><br><span class="line">    public boolean deleteProduct(Long id) &#123;</span><br><span class="line">        // ä½¿ç”¨é€»è¾‘åˆ é™¤</span><br><span class="line">        return removeById(id);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    @Transactional(rollbackFor = Exception.class)</span><br><span class="line">    public boolean deleteProductBatch(List&lt;Long&gt; ids) &#123;</span><br><span class="line">        return removeByIds(ids);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    @Cacheable(value = &quot;product&quot;, key = &quot;&#x27;detail:&#x27; + #id&quot;, unless = &quot;#result == null&quot;)</span><br><span class="line">    public ProductVo getProductDetail(Long id) &#123;</span><br><span class="line">        log.info(&quot;æŸ¥è¯¢å•†å“è¯¦æƒ…ï¼Œå•†å“IDï¼š&#123;&#125;ï¼Œä»æ•°æ®åº“æŸ¥è¯¢&quot;, id);</span><br><span class="line">        </span><br><span class="line">        // 1. å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­å•†å“æ˜¯å¦å­˜åœ¨</span><br><span class="line">        if (!productBloomFilter.contains(String.valueOf(id))) &#123;</span><br><span class="line">            log.warn(&quot;å•†å“ä¸å­˜åœ¨ï¼Œå•†å“IDï¼š&#123;&#125;&quot;, id);</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 2. æŸ¥è¯¢ç¼“å­˜ï¼ˆSpring Cacheç®¡ç†ï¼‰</span><br><span class="line">        // è¿™é‡Œä¼šç›´æ¥è¿”å›ï¼Œå¦‚æœç¼“å­˜æ²¡æœ‰æ‰ä¼šæ‰§è¡Œä¸‹é¢çš„ä»£ç </span><br><span class="line">        </span><br><span class="line">        // 3. æŸ¥è¯¢æ•°æ®åº“</span><br><span class="line">        ProductVo productVo = productMapper.selectProductDetail(id);</span><br><span class="line">        if (productVo == null) &#123;</span><br><span class="line">            // ç¼“å­˜ç©ºå€¼ï¼Œé˜²æ­¢ç¼“å­˜ç©¿é€</span><br><span class="line">            redisUtil.set(PRODUCT_CACHE_PREFIX + id, &quot;NULL&quot;, 5, TimeUnit.MINUTES);</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 4. å¤„ç†å›¾ç‰‡</span><br><span class="line">        if (StringUtils.hasText(productVo.getSubImages())) &#123;</span><br><span class="line">            // è§£æå­å›¾JSONæ•°ç»„</span><br><span class="line">            // productVo.setSubImageList(JSON.parseArray(productVo.getSubImages(), String.class));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return productVo;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public PageResult&lt;ProductVo&gt; getProductPage(PageParam param, </span><br><span class="line">                                               Long categoryId,</span><br><span class="line">                                               String keyword,</span><br><span class="line">                                               BigDecimal minPrice,</span><br><span class="line">                                               BigDecimal maxPrice,</span><br><span class="line">                                               String brand,</span><br><span class="line">                                               Integer status,</span><br><span class="line">                                               Integer isHot,</span><br><span class="line">                                               Integer isNew) &#123;</span><br><span class="line">        </span><br><span class="line">        // æ„å»ºæŸ¥è¯¢æ¡ä»¶</span><br><span class="line">        QueryWrapper&lt;Product&gt; wrapper = new QueryWrapper&lt;&gt;();</span><br><span class="line">        wrapper.eq(&quot;is_deleted&quot;, 0);</span><br><span class="line">        </span><br><span class="line">        if (categoryId != null) &#123;</span><br><span class="line">            wrapper.eq(&quot;category_id&quot;, categoryId);</span><br><span class="line">        &#125;</span><br><span class="line">        if (StringUtils.hasText(keyword)) &#123;</span><br><span class="line">            wrapper.like(&quot;product_name&quot;, keyword).or().like(&quot;product_no&quot;, keyword);</span><br><span class="line">        &#125;</span><br><span class="line">        if (minPrice != null) &#123;</span><br><span class="line">            wrapper.ge(&quot;price&quot;, minPrice);</span><br><span class="line">        &#125;</span><br><span class="line">        if (maxPrice != null) &#123;</span><br><span class="line">            wrapper.le(&quot;price&quot;, maxPrice);</span><br><span class="line">        &#125;</span><br><span class="line">        if (StringUtils.hasText(brand)) &#123;</span><br><span class="line">            wrapper.eq(&quot;brand&quot;, brand);</span><br><span class="line">        &#125;</span><br><span class="line">        if (status != null) &#123;</span><br><span class="line">            wrapper.eq(&quot;status&quot;, status);</span><br><span class="line">        &#125;</span><br><span class="line">        if (isHot != null) &#123;</span><br><span class="line">            wrapper.eq(&quot;is_hot&quot;, isHot);</span><br><span class="line">        &#125;</span><br><span class="line">        if (isNew != null) &#123;</span><br><span class="line">            wrapper.eq(&quot;is_new&quot;, isNew);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // æ’åº</span><br><span class="line">        if (StringUtils.hasText(param.getOrderBy())) &#123;</span><br><span class="line">            wrapper.orderBy(true, param.getAsc(), param.getOrderBy());</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            wrapper.orderByDesc(&quot;create_time&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // åˆ†é¡µæŸ¥è¯¢</span><br><span class="line">        Page&lt;Product&gt; page = new Page&lt;&gt;(param.getPageNum(), param.getPageSize());</span><br><span class="line">        Page&lt;Product&gt; productPage = page(page, wrapper);</span><br><span class="line">        </span><br><span class="line">        // è½¬æ¢ä¸ºVo</span><br><span class="line">        List&lt;ProductVo&gt; productVos = productPage.getRecords().stream()</span><br><span class="line">            .map(product -&gt; &#123;</span><br><span class="line">                ProductVo vo = new ProductVo();</span><br><span class="line">                BeanUtils.copyProperties(product, vo);</span><br><span class="line">                return vo;</span><br><span class="line">            &#125;)</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">        </span><br><span class="line">        return new PageResult&lt;&gt;(</span><br><span class="line">            productVos,</span><br><span class="line">            productPage.getTotal(),</span><br><span class="line">            productPage.getCurrent(),</span><br><span class="line">            productPage.getSize()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    @CacheEvict(value = &quot;product&quot;, key = &quot;&#x27;detail:&#x27; + #id&quot;)</span><br><span class="line">    public boolean updateStatus(Long id, Integer status) &#123;</span><br><span class="line">        Product product = new Product();</span><br><span class="line">        product.setId(id);</span><br><span class="line">        product.setStatus(status);</span><br><span class="line">        product.setUpdateTime(LocalDateTime.now());</span><br><span class="line">        return updateById(product);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public boolean updateStatusBatch(List&lt;Long&gt; ids, Integer status) &#123;</span><br><span class="line">        return productMapper.updateStatusBatch(ids, status) &gt; 0;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    @Transactional(rollbackFor = Exception.class)</span><br><span class="line">    public boolean reduceStock(Long id, Integer quantity) &#123;</span><br><span class="line">        if (quantity &lt;= 0) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.PARAM_VALID_ERROR, &quot;æ‰£å‡æ•°é‡å¿…é¡»å¤§äº0&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // ä½¿ç”¨åˆ†å¸ƒå¼é”ï¼Œé˜²æ­¢è¶…å–</span><br><span class="line">        String lockKey = &quot;product:stock:lock:&quot; + id;</span><br><span class="line">        RLock lock = redissonClient.getLock(lockKey);</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            // å°è¯•åŠ é”ï¼Œæœ€å¤šç­‰å¾…5ç§’ï¼Œé”10ç§’åè‡ªåŠ¨é‡Šæ”¾</span><br><span class="line">            boolean locked = lock.tryLock(5, 10, TimeUnit.SECONDS);</span><br><span class="line">            if (!locked) &#123;</span><br><span class="line">                throw new BusinessException(ResultCode.SYSTEM_ERROR, &quot;ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // æŸ¥è¯¢å•†å“</span><br><span class="line">            Product product = getById(id);</span><br><span class="line">            if (product == null) &#123;</span><br><span class="line">                throw new BusinessException(ResultCode.RESOURCE_NOT_FOUND, &quot;å•†å“ä¸å­˜åœ¨&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // æ£€æŸ¥åº“å­˜</span><br><span class="line">            if (product.getStock() &lt; quantity) &#123;</span><br><span class="line">                throw new BusinessException(ResultCode.BUSINESS_ERROR, &quot;åº“å­˜ä¸è¶³&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // æ‰£å‡åº“å­˜</span><br><span class="line">            int result = productMapper.reduceStock(id, quantity);</span><br><span class="line">            if (result &lt;= 0) &#123;</span><br><span class="line">                throw new BusinessException(ResultCode.SYSTEM_ERROR, &quot;åº“å­˜æ‰£å‡å¤±è´¥&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // æ›´æ–°ç¼“å­˜</span><br><span class="line">            String stockKey = PRODUCT_STOCK_CACHE_PREFIX + id;</span><br><span class="line">            redisUtil.decrement(stockKey, quantity);</span><br><span class="line">            </span><br><span class="line">            log.info(&quot;æ‰£å‡åº“å­˜æˆåŠŸï¼Œå•†å“IDï¼š&#123;&#125;ï¼Œæ•°é‡ï¼š&#123;&#125;ï¼Œå‰©ä½™åº“å­˜ï¼š&#123;&#125;&quot;, </span><br><span class="line">                    id, quantity, product.getStock() - quantity);</span><br><span class="line">            </span><br><span class="line">            return true;</span><br><span class="line">            </span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">            throw new BusinessException(ResultCode.SYSTEM_ERROR, &quot;ç³»ç»Ÿå¼‚å¸¸&quot;);</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            // é‡Šæ”¾é”</span><br><span class="line">            if (lock.isHeldByCurrentThread()) &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    @Transactional(rollbackFor = Exception.class)</span><br><span class="line">    public boolean increaseSale(Long id, Integer quantity) &#123;</span><br><span class="line">        int result = productMapper.increaseSale(id, quantity);</span><br><span class="line">        return result &gt; 0;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    @Cacheable(value = &quot;product&quot;, key = &quot;&#x27;hot:list&#x27;&quot;, unless = &quot;#result == null || #result.size() == 0&quot;)</span><br><span class="line">    public List&lt;Product&gt; getHotProducts(int limit) &#123;</span><br><span class="line">        log.info(&quot;æŸ¥è¯¢çƒ­é—¨å•†å“ï¼Œä»æ•°æ®åº“æŸ¥è¯¢ï¼Œæ•°é‡ï¼š&#123;&#125;&quot;, limit);</span><br><span class="line">        return productMapper.selectHotProducts(Math.min(limit, 100));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    @Cacheable(value = &quot;product&quot;, key = &quot;&#x27;new:list&#x27;&quot;, unless = &quot;#result == null || #result.size() == 0&quot;)</span><br><span class="line">    public List&lt;Product&gt; getNewProducts(int limit) &#123;</span><br><span class="line">        log.info(&quot;æŸ¥è¯¢æ–°å“ï¼Œä»æ•°æ®åº“æŸ¥è¯¢ï¼Œæ•°é‡ï¼š&#123;&#125;&quot;, limit);</span><br><span class="line">        return productMapper.selectNewProducts(Math.min(limit, 100));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public boolean onShelf(Long id) &#123;</span><br><span class="line">        return updateStatus(id, 1);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public boolean offShelf(Long id) &#123;</span><br><span class="line">        return updateStatus(id, 0);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public boolean setHot(Long id, boolean hot) &#123;</span><br><span class="line">        Product product = new Product();</span><br><span class="line">        product.setId(id);</span><br><span class="line">        product.setIsHot(hot ? 1 : 0);</span><br><span class="line">        product.setUpdateTime(LocalDateTime.now());</span><br><span class="line">        boolean success = updateById(product);</span><br><span class="line">        </span><br><span class="line">        if (success) &#123;</span><br><span class="line">            // æ¸…é™¤çƒ­é—¨å•†å“ç¼“å­˜</span><br><span class="line">            redisUtil.delete(HOT_PRODUCTS_CACHE_KEY);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return success;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public boolean setNew(Long id, boolean isNew) &#123;</span><br><span class="line">        Product product = new Product();</span><br><span class="line">        product.setId(id);</span><br><span class="line">        product.setIsNew(isNew ? 1 : 0);</span><br><span class="line">        product.setUpdateTime(LocalDateTime.now());</span><br><span class="line">        boolean success = updateById(product);</span><br><span class="line">        </span><br><span class="line">        if (success) &#123;</span><br><span class="line">            // æ¸…é™¤æ–°å“ç¼“å­˜</span><br><span class="line">            redisUtil.delete(NEW_PRODUCTS_CACHE_KEY);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return success;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * ç”Ÿæˆå•†å“ç¼–å·</span><br><span class="line">     */</span><br><span class="line">    private String generateProductNo() &#123;</span><br><span class="line">        String timestamp = String.valueOf(System.currentTimeMillis());</span><br><span class="line">        String random = String.valueOf((int)((Math.random() * 9 + 1) * 1000));</span><br><span class="line">        return &quot;P&quot; + timestamp.substring(timestamp.length() - 8) + random;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆå§‹åŒ–å¸ƒéš†è¿‡æ»¤å™¨</span><br><span class="line">     */</span><br><span class="line">    @PostConstruct</span><br><span class="line">    public void initBloomFilter() &#123;</span><br><span class="line">        log.info(&quot;å¼€å§‹åˆå§‹åŒ–å•†å“å¸ƒéš†è¿‡æ»¤å™¨...&quot;);</span><br><span class="line">        </span><br><span class="line">        // æŸ¥è¯¢æ‰€æœ‰å•†å“ID</span><br><span class="line">        List&lt;Long&gt; productIds = productMapper.selectList(new QueryWrapper&lt;Product&gt;()</span><br><span class="line">                .select(&quot;id&quot;))</span><br><span class="line">                .stream()</span><br><span class="line">                .map(Product::getId)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        </span><br><span class="line">        // æ·»åŠ åˆ°å¸ƒéš†è¿‡æ»¤å™¨</span><br><span class="line">        for (Long id : productIds) &#123;</span><br><span class="line">            productBloomFilter.add(String.valueOf(id));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        log.info(&quot;å•†å“å¸ƒéš†è¿‡æ»¤å™¨åˆå§‹åŒ–å®Œæˆï¼Œå…±æ·»åŠ &#123;&#125;ä¸ªå•†å“ID&quot;, productIds.size());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Redissoné…ç½®</span><br><span class="line">@Configuration</span><br><span class="line">public class RedissonConfig &#123;</span><br><span class="line">    </span><br><span class="line">    @Bean</span><br><span class="line">    public RedissonClient redissonClient(RedisProperties redisProperties) &#123;</span><br><span class="line">        Config config = new Config();</span><br><span class="line">        </span><br><span class="line">        // å•æœºæ¨¡å¼</span><br><span class="line">        config.useSingleServer()</span><br><span class="line">              .setAddress(&quot;redis://&quot; + redisProperties.getHost() + &quot;:&quot; + redisProperties.getPort())</span><br><span class="line">              .setPassword(redisProperties.getPassword())</span><br><span class="line">              .setDatabase(redisProperties.getDatabase())</span><br><span class="line">              .setConnectionPoolSize(redisProperties.getLettuce().getPool().getMaxActive())</span><br><span class="line">              .setConnectionMinimumIdleSize(redisProperties.getLettuce().getPool().getMinIdle())</span><br><span class="line">              .setIdleConnectionTimeout(redisProperties.getLettuce().getShutdownTimeout().toMillis())</span><br><span class="line">              .setConnectTimeout((int) redisProperties.getTimeout().toMillis());</span><br><span class="line">        </span><br><span class="line">        return Redisson.create(config);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Bean</span><br><span class="line">    public RBloomFilter&lt;String&gt; productBloomFilter(RedissonClient redissonClient) &#123;</span><br><span class="line">        RBloomFilter&lt;String&gt; bloomFilter = redissonClient.getBloomFilter(&quot;product:bloom:filter&quot;);</span><br><span class="line">        </span><br><span class="line">        // åˆå§‹åŒ–å¸ƒéš†è¿‡æ»¤å™¨</span><br><span class="line">        // é¢„è®¡å…ƒç´ æ•°é‡ï¼š1000000</span><br><span class="line">        // è¯¯åˆ¤ç‡ï¼š0.01</span><br><span class="line">        bloomFilter.tryInit(1000000L, 0.01);</span><br><span class="line">        </span><br><span class="line">        return bloomFilter;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="7-å•†å“Controller"><a href="#7-å•†å“Controller" class="headerlink" title="7. å•†å“Controller"></a>7. å•†å“Controller</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.product.controller;</span><br><span class="line"></span><br><span class="line">import com.shophub.common.result.Result;</span><br><span class="line">import com.shophub.product.entity.Product;</span><br><span class="line">import com.shophub.product.entity.vo.ProductVo;</span><br><span class="line">import com.shophub.product.service.ProductService;</span><br><span class="line">import io.swagger.annotations.Api;</span><br><span class="line">import io.swagger.annotations.ApiOperation;</span><br><span class="line">import io.swagger.annotations.ApiParam;</span><br><span class="line">import lombok.RequiredArgsConstructor;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.springframework.validation.annotation.Validated;</span><br><span class="line">import org.springframework.web.bind.annotation.*;</span><br><span class="line">import org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line">import javax.validation.Valid;</span><br><span class="line">import javax.validation.constraints.Min;</span><br><span class="line">import javax.validation.constraints.NotNull;</span><br><span class="line">import java.math.BigDecimal;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@Validated</span><br><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;/api/product&quot;)</span><br><span class="line">@RequiredArgsConstructor</span><br><span class="line">@Api(tags = &quot;å•†å“ç®¡ç†&quot;)</span><br><span class="line">public class ProductController &#123;</span><br><span class="line">    </span><br><span class="line">    private final ProductService productService;</span><br><span class="line">    </span><br><span class="line">    @PostMapping</span><br><span class="line">    @ApiOperation(&quot;æ·»åŠ å•†å“&quot;)</span><br><span class="line">    public Result&lt;Long&gt; addProduct(@RequestBody @Valid Product product) &#123;</span><br><span class="line">        Long productId = productService.addProduct(product);</span><br><span class="line">        return Result.success(productId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @PutMapping(&quot;/&#123;id&#125;&quot;)</span><br><span class="line">    @ApiOperation(&quot;æ›´æ–°å•†å“&quot;)</span><br><span class="line">    public Result&lt;Boolean&gt; updateProduct(</span><br><span class="line">            @PathVariable @NotNull(message = &quot;å•†å“IDä¸èƒ½ä¸ºç©º&quot;) Long id,</span><br><span class="line">            @RequestBody @Valid Product product) &#123;</span><br><span class="line">        product.setId(id);</span><br><span class="line">        boolean success = productService.updateProduct(product);</span><br><span class="line">        return Result.success(success);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @DeleteMapping(&quot;/&#123;id&#125;&quot;)</span><br><span class="line">    @ApiOperation(&quot;åˆ é™¤å•†å“&quot;)</span><br><span class="line">    public Result&lt;Boolean&gt; deleteProduct(</span><br><span class="line">            @PathVariable @NotNull(message = &quot;å•†å“IDä¸èƒ½ä¸ºç©º&quot;) Long id) &#123;</span><br><span class="line">        boolean success = productService.deleteProduct(id);</span><br><span class="line">        return Result.success(success);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @DeleteMapping(&quot;/batch&quot;)</span><br><span class="line">    @ApiOperation(&quot;æ‰¹é‡åˆ é™¤å•†å“&quot;)</span><br><span class="line">    public Result&lt;Boolean&gt; deleteProductBatch(@RequestBody List&lt;Long&gt; ids) &#123;</span><br><span class="line">        boolean success = productService.deleteProductBatch(ids);</span><br><span class="line">        return Result.success(success);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @GetMapping(&quot;/&#123;id&#125;&quot;)</span><br><span class="line">    @ApiOperation(&quot;è·å–å•†å“è¯¦æƒ…&quot;)</span><br><span class="line">    public Result&lt;ProductVo&gt; getProductDetail(</span><br><span class="line">            @PathVariable @NotNull(message = &quot;å•†å“IDä¸èƒ½ä¸ºç©º&quot;) Long id) &#123;</span><br><span class="line">        ProductVo productVo = productService.getProductDetail(id);</span><br><span class="line">        return Result.success(productVo);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @GetMapping(&quot;/page&quot;)</span><br><span class="line">    @ApiOperation(&quot;åˆ†é¡µæŸ¥è¯¢å•†å“åˆ—è¡¨&quot;)</span><br><span class="line">    public Result&lt;PageResult&lt;ProductVo&gt;&gt; getProductPage(</span><br><span class="line">            @RequestParam(defaultValue = &quot;1&quot;) @Min(1) Integer pageNum,</span><br><span class="line">            @RequestParam(defaultValue = &quot;10&quot;) @Min(1) Integer pageSize,</span><br><span class="line">            @RequestParam(required = false) Long categoryId,</span><br><span class="line">            @RequestParam(required = false) String keyword,</span><br><span class="line">            @RequestParam(required = false) BigDecimal minPrice,</span><br><span class="line">            @RequestParam(required = false) BigDecimal maxPrice,</span><br><span class="line">            @RequestParam(required = false) String brand,</span><br><span class="line">            @RequestParam(required = false) Integer status,</span><br><span class="line">            @RequestParam(required = false) Integer isHot,</span><br><span class="line">            @RequestParam(required = false) Integer isNew) &#123;</span><br><span class="line">        </span><br><span class="line">        PageParam param = new PageParam();</span><br><span class="line">        param.setPageNum(pageNum);</span><br><span class="line">        param.setPageSize(pageSize);</span><br><span class="line">        </span><br><span class="line">        PageResult&lt;ProductVo&gt; pageResult = productService.getProductPage(</span><br><span class="line">            param, categoryId, keyword, minPrice, maxPrice, </span><br><span class="line">            brand, status, isHot, isNew</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        return Result.success(pageResult);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @PutMapping(&quot;/&#123;id&#125;/status&quot;)</span><br><span class="line">    @ApiOperation(&quot;æ›´æ–°å•†å“çŠ¶æ€&quot;)</span><br><span class="line">    public Result&lt;Boolean&gt; updateStatus(</span><br><span class="line">            @PathVariable @NotNull(message = &quot;å•†å“IDä¸èƒ½ä¸ºç©º&quot;) Long id,</span><br><span class="line">            @RequestParam @NotNull(message = &quot;çŠ¶æ€ä¸èƒ½ä¸ºç©º&quot;) Integer status) &#123;</span><br><span class="line">        boolean success = productService.updateStatus(id, status);</span><br><span class="line">        return Result.success(success);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @PutMapping(&quot;/batch/status&quot;)</span><br><span class="line">    @ApiOperation(&quot;æ‰¹é‡æ›´æ–°å•†å“çŠ¶æ€&quot;)</span><br><span class="line">    public Result&lt;Boolean&gt; updateStatusBatch(</span><br><span class="line">            @RequestBody List&lt;Long&gt; ids,</span><br><span class="line">            @RequestParam @NotNull(message = &quot;çŠ¶æ€ä¸èƒ½ä¸ºç©º&quot;) Integer status) &#123;</span><br><span class="line">        boolean success = productService.updateStatusBatch(ids, status);</span><br><span class="line">        return Result.success(success);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @PostMapping(&quot;/&#123;id&#125;/reduce-stock&quot;)</span><br><span class="line">    @ApiOperation(&quot;å‡å°‘å•†å“åº“å­˜&quot;)</span><br><span class="line">    public Result&lt;Boolean&gt; reduceStock(</span><br><span class="line">            @PathVariable @NotNull(message = &quot;å•†å“IDä¸èƒ½ä¸ºç©º&quot;) Long id,</span><br><span class="line">            @RequestParam @NotNull(message = &quot;æ•°é‡ä¸èƒ½ä¸ºç©º&quot;) @Min(1) Integer quantity) &#123;</span><br><span class="line">        boolean success = productService.reduceStock(id, quantity);</span><br><span class="line">        return Result.success(success);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @PostMapping(&quot;/&#123;id&#125;/increase-sale&quot;)</span><br><span class="line">    @ApiOperation(&quot;å¢åŠ å•†å“é”€é‡&quot;)</span><br><span class="line">    public Result&lt;Boolean&gt; increaseSale(</span><br><span class="line">            @PathVariable @NotNull(message = &quot;å•†å“IDä¸èƒ½ä¸ºç©º&quot;) Long id,</span><br><span class="line">            @RequestParam @NotNull(message = &quot;æ•°é‡ä¸èƒ½ä¸ºç©º&quot;) @Min(1) Integer quantity) &#123;</span><br><span class="line">        boolean success = productService.increaseSale(id, quantity);</span><br><span class="line">        return Result.success(success);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @GetMapping(&quot;/hot&quot;)</span><br><span class="line">    @ApiOperation(&quot;è·å–çƒ­é—¨å•†å“&quot;)</span><br><span class="line">    public Result&lt;List&lt;Product&gt;&gt; getHotProducts(</span><br><span class="line">            @RequestParam(defaultValue = &quot;10&quot;) @Min(1) @Max(100) Integer limit) &#123;</span><br><span class="line">        List&lt;Product&gt; hotProducts = productService.getHotProducts(limit);</span><br><span class="line">        return Result.success(hotProducts);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @GetMapping(&quot;/new&quot;)</span><br><span class="line">    @ApiOperation(&quot;è·å–æ–°å“&quot;)</span><br><span class="line">    public Result&lt;List&lt;Product&gt;&gt; getNewProducts(</span><br><span class="line">            @RequestParam(defaultValue = &quot;10&quot;) @Min(1) @Max(100) Integer limit) &#123;</span><br><span class="line">        List&lt;Product&gt; newProducts = productService.getNewProducts(limit);</span><br><span class="line">        return Result.success(newProducts);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @PostMapping(&quot;/&#123;id&#125;/on-shelf&quot;)</span><br><span class="line">    @ApiOperation(&quot;å•†å“ä¸Šæ¶&quot;)</span><br><span class="line">    public Result&lt;Boolean&gt; onShelf(</span><br><span class="line">            @PathVariable @NotNull(message = &quot;å•†å“IDä¸èƒ½ä¸ºç©º&quot;) Long id) &#123;</span><br><span class="line">        boolean success = productService.onShelf(id);</span><br><span class="line">        return Result.success(success);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @PostMapping(&quot;/&#123;id&#125;/off-shelf&quot;)</span><br><span class="line">    @ApiOperation(&quot;å•†å“ä¸‹æ¶&quot;)</span><br><span class="line">    public Result&lt;Boolean&gt; offShelf(</span><br><span class="line">            @PathVariable @NotNull(message = &quot;å•†å“IDä¸èƒ½ä¸ºç©º&quot;) Long id) &#123;</span><br><span class="line">        boolean success = productService.offShelf(id);</span><br><span class="line">        return Result.success(success);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @PostMapping(&quot;/&#123;id&#125;/set-hot&quot;)</span><br><span class="line">    @ApiOperation(&quot;è®¾ç½®/å–æ¶ˆçƒ­é”€å•†å“&quot;)</span><br><span class="line">    public Result&lt;Boolean&gt; setHot(</span><br><span class="line">            @PathVariable @NotNull(message = &quot;å•†å“IDä¸èƒ½ä¸ºç©º&quot;) Long id,</span><br><span class="line">            @RequestParam @NotNull(message = &quot;çƒ­é”€æ ‡å¿—ä¸èƒ½ä¸ºç©º&quot;) Boolean hot) &#123;</span><br><span class="line">        boolean success = productService.setHot(id, hot);</span><br><span class="line">        return Result.success(success);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @PostMapping(&quot;/&#123;id&#125;/set-new&quot;)</span><br><span class="line">    @ApiOperation(&quot;è®¾ç½®/å–æ¶ˆæ–°å“&quot;)</span><br><span class="line">    public Result&lt;Boolean&gt; setNew(</span><br><span class="line">            @PathVariable @NotNull(message = &quot;å•†å“IDä¸èƒ½ä¸ºç©º&quot;) Long id,</span><br><span class="line">            @RequestParam @NotNull(message = &quot;æ–°å“æ ‡å¿—ä¸èƒ½ä¸ºç©º&quot;) Boolean isNew) &#123;</span><br><span class="line">        boolean success = productService.setNew(id, isNew);</span><br><span class="line">        return Result.success(success);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @PostMapping(&quot;/sync-cache&quot;)</span><br><span class="line">    @ApiOperation(&quot;åŒæ­¥å•†å“ç¼“å­˜&quot;)</span><br><span class="line">    public Result&lt;Boolean&gt; syncProductCache() &#123;</span><br><span class="line">        // è¿™é‡Œå¯ä»¥å®ç°ç¼“å­˜é¢„çƒ­é€»è¾‘</span><br><span class="line">        return Result.success(true);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="8-ç¼“å­˜ç®¡ç†Controller"><a href="#8-ç¼“å­˜ç®¡ç†Controller" class="headerlink" title="8. ç¼“å­˜ç®¡ç†Controller"></a>8. ç¼“å­˜ç®¡ç†Controller</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.product.controller;</span><br><span class="line"></span><br><span class="line">import com.shophub.common.result.Result;</span><br><span class="line">import lombok.RequiredArgsConstructor;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line">import org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line">import java.util.Set;</span><br><span class="line">import java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;/api/product/cache&quot;)</span><br><span class="line">@RequiredArgsConstructor</span><br><span class="line">public class CacheController &#123;</span><br><span class="line">    </span><br><span class="line">    private final RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    </span><br><span class="line">    @GetMapping(&quot;/keys&quot;)</span><br><span class="line">    public Result&lt;Set&lt;String&gt;&gt; getCacheKeys(@RequestParam String pattern) &#123;</span><br><span class="line">        Set&lt;String&gt; keys = redisTemplate.keys(pattern);</span><br><span class="line">        return Result.success(keys);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @GetMapping(&quot;/value&quot;)</span><br><span class="line">    public Result&lt;Object&gt; getCacheValue(@RequestParam String key) &#123;</span><br><span class="line">        Object value = redisTemplate.opsForValue().get(key);</span><br><span class="line">        return Result.success(value);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @DeleteMapping</span><br><span class="line">    public Result&lt;Boolean&gt; deleteCache(@RequestParam String key) &#123;</span><br><span class="line">        Boolean deleted = redisTemplate.delete(key);</span><br><span class="line">        return Result.success(deleted);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @DeleteMapping(&quot;/pattern&quot;)</span><br><span class="line">    public Result&lt;Long&gt; deleteCacheByPattern(@RequestParam String pattern) &#123;</span><br><span class="line">        Set&lt;String&gt; keys = redisTemplate.keys(pattern);</span><br><span class="line">        if (keys != null &amp;&amp; !keys.isEmpty()) &#123;</span><br><span class="line">            Long deleted = redisTemplate.delete(keys);</span><br><span class="line">            return Result.success(deleted);</span><br><span class="line">        &#125;</span><br><span class="line">        return Result.success(0L);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @PostMapping(&quot;/ttl&quot;)</span><br><span class="line">    public Result&lt;Boolean&gt; setCacheTTL(</span><br><span class="line">            @RequestParam String key,</span><br><span class="line">            @RequestParam long ttl,</span><br><span class="line">            @RequestParam TimeUnit timeUnit) &#123;</span><br><span class="line">        Boolean success = redisTemplate.expire(key, ttl, timeUnit);</span><br><span class="line">        return Result.success(success);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @PostMapping(&quot;/clear-product&quot;)</span><br><span class="line">    public Result&lt;Long&gt; clearProductCache() &#123;</span><br><span class="line">        // æ¸…é™¤æ‰€æœ‰å•†å“ç›¸å…³ç¼“å­˜</span><br><span class="line">        Set&lt;String&gt; keys = redisTemplate.keys(&quot;product:*&quot;);</span><br><span class="line">        if (keys != null &amp;&amp; !keys.isEmpty()) &#123;</span><br><span class="line">            Long deleted = redisTemplate.delete(keys);</span><br><span class="line">            log.info(&quot;æ¸…é™¤å•†å“ç¼“å­˜ï¼Œå…±æ¸…é™¤&#123;&#125;ä¸ªkey&quot;, deleted);</span><br><span class="line">            return Result.success(deleted);</span><br><span class="line">        &#125;</span><br><span class="line">        return Result.success(0L);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @PostMapping(&quot;/warm-up&quot;)</span><br><span class="line">    public Result&lt;String&gt; warmUpCache() &#123;</span><br><span class="line">        // ç¼“å­˜é¢„çƒ­é€»è¾‘</span><br><span class="line">        // 1. é¢„çƒ­çƒ­é—¨å•†å“</span><br><span class="line">        // 2. é¢„çƒ­æ–°å“</span><br><span class="line">        // 3. é¢„çƒ­é¦–é¡µå•†å“</span><br><span class="line">        </span><br><span class="line">        log.info(&quot;å¼€å§‹ç¼“å­˜é¢„çƒ­...&quot;);</span><br><span class="line">        </span><br><span class="line">        // è¿™é‡Œå¯ä»¥æ·»åŠ å…·ä½“çš„é¢„çƒ­é€»è¾‘</span><br><span class="line">        // ä¾‹å¦‚ï¼šproductService.getHotProducts(10);</span><br><span class="line">        //        productService.getNewProducts(10);</span><br><span class="line">        </span><br><span class="line">        log.info(&quot;ç¼“å­˜é¢„çƒ­å®Œæˆ&quot;);</span><br><span class="line">        return Result.success(&quot;ç¼“å­˜é¢„çƒ­å®Œæˆ&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºç¯‡å¹…é™åˆ¶ï¼Œæˆ‘å…ˆå±•ç¤ºç¬¬8å¤©çš„åŸºç¡€æ¶æ„å’Œå•†å“CRUDå®ç°ã€‚ç¬¬9å¤©æˆ‘ä»¬å°†é‡ç‚¹å®ç°ï¼š</p><ol><li><strong>æ–‡ä»¶ä¸Šä¼ ä¸‹è½½åŠŸèƒ½</strong>ï¼ˆåŒ…æ‹¬åˆ†ç‰‡ä¸Šä¼ ã€æ–­ç‚¹ç»­ä¼ ï¼‰</li><li><strong>å•†å“åˆ†ç±»ç®¡ç†</strong></li><li><strong>Redisç¼“å­˜é«˜çº§åº”ç”¨</strong>ï¼ˆç¼“å­˜ç©¿é€ã€å‡»ç©¿ã€é›ªå´©çš„å®Œæ•´è§£å†³æ–¹æ¡ˆï¼‰</li><li><strong>å¹¶å‘æµ‹è¯•</strong></li></ol><p>æ˜¯å¦ç»§ç»­ç¬¬9å¤©çš„å®ç°ï¼Ÿè¿˜æ˜¯æƒ³å…ˆäº†è§£æŸä¸ªç‰¹å®šåŠŸèƒ½çš„å®ç°ç»†èŠ‚ï¼Ÿ</p><p>æœ¬å›ç­”ç”± AI ç”Ÿæˆï¼Œå†…å®¹ä»…ä¾›å‚è€ƒï¼Œè¯·ä»”ç»†ç”„åˆ«ã€‚</p><p>ç»§ç»­</p><p>æˆ‘ä»¬ç»§ç»­ç¬¬9å¤©çš„å†…å®¹ï¼šæ–‡ä»¶ä¸Šä¼ ä¸‹è½½ã€å•†å“åˆ†ç±»ç®¡ç†å’ŒRedisç¼“å­˜é«˜çº§åº”ç”¨ã€‚</p><h2 id="ç¬¬9å¤©ï¼šæ–‡ä»¶ä¸Šä¼ ä¸‹è½½ã€å•†å“åˆ†ç±»ç®¡ç†å’ŒRedisç¼“å­˜é«˜çº§åº”ç”¨"><a href="#ç¬¬9å¤©ï¼šæ–‡ä»¶ä¸Šä¼ ä¸‹è½½ã€å•†å“åˆ†ç±»ç®¡ç†å’ŒRedisç¼“å­˜é«˜çº§åº”ç”¨" class="headerlink" title="ç¬¬9å¤©ï¼šæ–‡ä»¶ä¸Šä¼ ä¸‹è½½ã€å•†å“åˆ†ç±»ç®¡ç†å’ŒRedisç¼“å­˜é«˜çº§åº”ç”¨"></a>ç¬¬9å¤©ï¼šæ–‡ä»¶ä¸Šä¼ ä¸‹è½½ã€å•†å“åˆ†ç±»ç®¡ç†å’ŒRedisç¼“å­˜é«˜çº§åº”ç”¨</h2><h3 id="1-æ–‡ä»¶ä¸Šä¼ ä¸‹è½½ï¼ˆæ”¯æŒåˆ†ç‰‡ä¸Šä¼ ã€æ–­ç‚¹ç»­ä¼ ï¼‰"><a href="#1-æ–‡ä»¶ä¸Šä¼ ä¸‹è½½ï¼ˆæ”¯æŒåˆ†ç‰‡ä¸Šä¼ ã€æ–­ç‚¹ç»­ä¼ ï¼‰" class="headerlink" title="1. æ–‡ä»¶ä¸Šä¼ ä¸‹è½½ï¼ˆæ”¯æŒåˆ†ç‰‡ä¸Šä¼ ã€æ–­ç‚¹ç»­ä¼ ï¼‰"></a>1. æ–‡ä»¶ä¸Šä¼ ä¸‹è½½ï¼ˆæ”¯æŒåˆ†ç‰‡ä¸Šä¼ ã€æ–­ç‚¹ç»­ä¼ ï¼‰</h3><h4 id="1-1-æ–‡ä»¶ä¸Šä¼ é…ç½®"><a href="#1-1-æ–‡ä»¶ä¸Šä¼ é…ç½®" class="headerlink" title="1.1 æ–‡ä»¶ä¸Šä¼ é…ç½®"></a>1.1 æ–‡ä»¶ä¸Šä¼ é…ç½®</h4><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.product.config;</span><br><span class="line"></span><br><span class="line">import org.springframework.beans.factory.annotation.Value;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.web.servlet.config.annotation.ResourceHandlerRegistry;</span><br><span class="line">import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</span><br><span class="line"></span><br><span class="line">import javax.annotation.PostConstruct;</span><br><span class="line">import java.io.File;</span><br><span class="line"></span><br><span class="line">@Configuration</span><br><span class="line">public class FileUploadConfig implements WebMvcConfigurer &#123;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;product.upload.base-dir&#125;&quot;)</span><br><span class="line">    private String baseDir;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;product.upload.temp-dir&#125;&quot;)</span><br><span class="line">    private String tempDir;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆå§‹åŒ–ç›®å½•</span><br><span class="line">     */</span><br><span class="line">    @PostConstruct</span><br><span class="line">    public void init() &#123;</span><br><span class="line">        createDirIfNotExist(baseDir);</span><br><span class="line">        createDirIfNotExist(tempDir);</span><br><span class="line">        createDirIfNotExist(baseDir + &quot;/images&quot;);</span><br><span class="line">        createDirIfNotExist(baseDir + &quot;/videos&quot;);</span><br><span class="line">        createDirIfNotExist(baseDir + &quot;/documents&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private void createDirIfNotExist(String path) &#123;</span><br><span class="line">        File dir = new File(path);</span><br><span class="line">        if (!dir.exists()) &#123;</span><br><span class="line">            dir.mkdirs();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * é™æ€èµ„æºæ˜ å°„</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public void addResourceHandlers(ResourceHandlerRegistry registry) &#123;</span><br><span class="line">        // æ˜ å°„ä¸Šä¼ æ–‡ä»¶ç›®å½•ä¸ºé™æ€èµ„æº</span><br><span class="line">        registry.addResourceHandler(&quot;/static/product/**&quot;)</span><br><span class="line">                .addResourceLocations(&quot;file:&quot; + baseDir + &quot;/&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="1-2-æ–‡ä»¶ä¸Šä¼ å·¥å…·ç±»"><a href="#1-2-æ–‡ä»¶ä¸Šä¼ å·¥å…·ç±»" class="headerlink" title="1.2 æ–‡ä»¶ä¸Šä¼ å·¥å…·ç±»"></a>1.2 æ–‡ä»¶ä¸Šä¼ å·¥å…·ç±»</h4><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.product.util;</span><br><span class="line"></span><br><span class="line">import com.shophub.common.exception.BusinessException;</span><br><span class="line">import com.shophub.common.result.ResultCode;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.apache.commons.io.FileUtils;</span><br><span class="line">import org.springframework.beans.factory.annotation.Value;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line">import org.springframework.util.DigestUtils;</span><br><span class="line">import org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line">import java.io.*;</span><br><span class="line">import java.nio.file.Files;</span><br><span class="line">import java.nio.file.Path;</span><br><span class="line">import java.nio.file.Paths;</span><br><span class="line">import java.time.LocalDate;</span><br><span class="line">import java.time.format.DateTimeFormatter;</span><br><span class="line">import java.util.*;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@Component</span><br><span class="line">public class FileUploadUtil &#123;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;product.upload.base-dir&#125;&quot;)</span><br><span class="line">    private String baseDir;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;product.upload.temp-dir&#125;&quot;)</span><br><span class="line">    private String tempDir;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;product.upload.max-size&#125;&quot;)</span><br><span class="line">    private long maxSize;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;product.upload.allowed-extensions&#125;&quot;)</span><br><span class="line">    private List&lt;String&gt; allowedExtensions;</span><br><span class="line">    </span><br><span class="line">    private static final DateTimeFormatter DATE_FORMATTER = DateTimeFormatter.ofPattern(&quot;yyyy/MM/dd&quot;);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ™®é€šæ–‡ä»¶ä¸Šä¼ </span><br><span class="line">     */</span><br><span class="line">    public UploadResult upload(MultipartFile file) throws IOException &#123;</span><br><span class="line">        // æ£€æŸ¥æ–‡ä»¶å¤§å°</span><br><span class="line">        if (file.getSize() &gt; maxSize) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.PARAM_VALID_ERROR, &quot;æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡100MB&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // æ£€æŸ¥æ–‡ä»¶æ‰©å±•å</span><br><span class="line">        String originalFilename = file.getOriginalFilename();</span><br><span class="line">        String extension = getFileExtension(originalFilename);</span><br><span class="line">        if (!allowedExtensions.contains(extension.toLowerCase())) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.PARAM_VALID_ERROR, </span><br><span class="line">                    &quot;ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹ï¼Œå…è®¸çš„ç±»å‹ï¼š&quot; + allowedExtensions);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // ç”Ÿæˆå­˜å‚¨è·¯å¾„</span><br><span class="line">        String storagePath = generateStoragePath(originalFilename);</span><br><span class="line">        File destFile = new File(baseDir, storagePath);</span><br><span class="line">        </span><br><span class="line">        // åˆ›å»ºç›®å½•</span><br><span class="line">        destFile.getParentFile().mkdirs();</span><br><span class="line">        </span><br><span class="line">        // ä¿å­˜æ–‡ä»¶</span><br><span class="line">        file.transferTo(destFile);</span><br><span class="line">        </span><br><span class="line">        // è®¡ç®—æ–‡ä»¶MD5</span><br><span class="line">        String md5 = calculateFileMD5(destFile);</span><br><span class="line">        </span><br><span class="line">        UploadResult result = new UploadResult();</span><br><span class="line">        result.setOriginalName(originalFilename);</span><br><span class="line">        result.setFileName(destFile.getName());</span><br><span class="line">        result.setFilePath(storagePath);</span><br><span class="line">        result.setFileSize(file.getSize());</span><br><span class="line">        result.setFileType(extension);</span><br><span class="line">        result.setMd5(md5);</span><br><span class="line">        result.setUrl(&quot;/static/product/&quot; + storagePath);</span><br><span class="line">        </span><br><span class="line">        log.info(&quot;æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼š&#123;&#125;ï¼Œå¤§å°ï¼š&#123;&#125;ï¼ŒMD5ï¼š&#123;&#125;&quot;, storagePath, file.getSize(), md5);</span><br><span class="line">        </span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆ†ç‰‡ä¸Šä¼ ï¼šåˆå§‹åŒ–ä¸Šä¼ </span><br><span class="line">     */</span><br><span class="line">    public ChunkInitResult initChunkUpload(ChunkInitRequest request) &#123;</span><br><span class="line">        // æ£€æŸ¥æ–‡ä»¶å¤§å°</span><br><span class="line">        if (request.getTotalSize() &gt; maxSize) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.PARAM_VALID_ERROR, &quot;æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡100MB&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // æ£€æŸ¥æ‰©å±•å</span><br><span class="line">        String extension = getFileExtension(request.getFileName());</span><br><span class="line">        if (!allowedExtensions.contains(extension.toLowerCase())) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.PARAM_VALID_ERROR, </span><br><span class="line">                    &quot;ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹ï¼Œå…è®¸çš„ç±»å‹ï¼š&quot; + allowedExtensions);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // ç”Ÿæˆæ–‡ä»¶æ ‡è¯†ï¼ˆä½¿ç”¨MD5æˆ–UUIDï¼‰</span><br><span class="line">        String fileKey = request.getFileMd5() != null ? </span><br><span class="line">                        request.getFileMd5() : UUID.randomUUID().toString();</span><br><span class="line">        </span><br><span class="line">        // åˆ›å»ºä¸´æ—¶ç›®å½•</span><br><span class="line">        String chunkDir = tempDir + File.separator + fileKey;</span><br><span class="line">        File dir = new File(chunkDir);</span><br><span class="line">        if (!dir.exists()) &#123;</span><br><span class="line">            dir.mkdirs();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // ç”Ÿæˆæœ€ç»ˆå­˜å‚¨è·¯å¾„</span><br><span class="line">        String storagePath = generateStoragePath(request.getFileName());</span><br><span class="line">        </span><br><span class="line">        ChunkInitResult result = new ChunkInitResult();</span><br><span class="line">        result.setFileKey(fileKey);</span><br><span class="line">        result.setChunkSize(request.getChunkSize());</span><br><span class="line">        result.setTotalChunks(request.getTotalChunks());</span><br><span class="line">        result.setStoragePath(storagePath);</span><br><span class="line">        </span><br><span class="line">        log.info(&quot;åˆå§‹åŒ–åˆ†ç‰‡ä¸Šä¼ ï¼Œæ–‡ä»¶ï¼š&#123;&#125;ï¼Œæ€»å¤§å°ï¼š&#123;&#125;ï¼Œåˆ†ç‰‡æ•°ï¼š&#123;&#125;&quot;, </span><br><span class="line">                request.getFileName(), request.getTotalSize(), request.getTotalChunks());</span><br><span class="line">        </span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆ†ç‰‡ä¸Šä¼ ï¼šä¸Šä¼ åˆ†ç‰‡</span><br><span class="line">     */</span><br><span class="line">    public ChunkUploadResult uploadChunk(String fileKey, Integer chunkNumber, </span><br><span class="line">                                        MultipartFile chunkFile) throws IOException &#123;</span><br><span class="line">        String chunkDir = tempDir + File.separator + fileKey;</span><br><span class="line">        String chunkPath = chunkDir + File.separator + chunkNumber;</span><br><span class="line">        </span><br><span class="line">        // ä¿å­˜åˆ†ç‰‡</span><br><span class="line">        File chunk = new File(chunkPath);</span><br><span class="line">        chunkFile.transferTo(chunk);</span><br><span class="line">        </span><br><span class="line">        // éªŒè¯åˆ†ç‰‡MD5ï¼ˆå¯é€‰ï¼‰</span><br><span class="line">        String chunkMd5 = calculateFileMD5(chunk);</span><br><span class="line">        </span><br><span class="line">        ChunkUploadResult result = new ChunkUploadResult();</span><br><span class="line">        result.setChunkNumber(chunkNumber);</span><br><span class="line">        result.setChunkSize(chunkFile.getSize());</span><br><span class="line">        result.setChunkMd5(chunkMd5);</span><br><span class="line">        </span><br><span class="line">        log.debug(&quot;ä¸Šä¼ åˆ†ç‰‡æˆåŠŸï¼Œæ–‡ä»¶ï¼š&#123;&#125;ï¼Œåˆ†ç‰‡ï¼š&#123;&#125;ï¼Œå¤§å°ï¼š&#123;&#125;&quot;, </span><br><span class="line">                fileKey, chunkNumber, chunkFile.getSize());</span><br><span class="line">        </span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆ†ç‰‡ä¸Šä¼ ï¼šåˆå¹¶åˆ†ç‰‡</span><br><span class="line">     */</span><br><span class="line">    public UploadResult mergeChunks(String fileKey, String fileName, </span><br><span class="line">                                   Integer totalChunks, String fileMd5) throws IOException &#123;</span><br><span class="line">        String chunkDir = tempDir + File.separator + fileKey;</span><br><span class="line">        File dir = new File(chunkDir);</span><br><span class="line">        </span><br><span class="line">        if (!dir.exists() || !dir.isDirectory()) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.RESOURCE_NOT_FOUND, &quot;ä¸Šä¼ è®°å½•ä¸å­˜åœ¨&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // æ£€æŸ¥æ‰€æœ‰åˆ†ç‰‡æ˜¯å¦å®Œæ•´</span><br><span class="line">        for (int i = 1; i &lt;= totalChunks; i++) &#123;</span><br><span class="line">            File chunk = new File(dir, String.valueOf(i));</span><br><span class="line">            if (!chunk.exists()) &#123;</span><br><span class="line">                throw new BusinessException(ResultCode.PARAM_VALID_ERROR, </span><br><span class="line">                        &quot;åˆ†ç‰‡ä¸å®Œæ•´ï¼Œç¼ºå°‘åˆ†ç‰‡ï¼š&quot; + i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // ç”Ÿæˆå­˜å‚¨è·¯å¾„</span><br><span class="line">        String storagePath = generateStoragePath(fileName);</span><br><span class="line">        File destFile = new File(baseDir, storagePath);</span><br><span class="line">        destFile.getParentFile().mkdirs();</span><br><span class="line">        </span><br><span class="line">        // åˆå¹¶åˆ†ç‰‡</span><br><span class="line">        try (RandomAccessFile raf = new RandomAccessFile(destFile, &quot;rw&quot;)) &#123;</span><br><span class="line">            byte[] buffer = new byte[8192];</span><br><span class="line">            for (int i = 1; i &lt;= totalChunks; i++) &#123;</span><br><span class="line">                File chunk = new File(dir, String.valueOf(i));</span><br><span class="line">                try (FileInputStream fis = new FileInputStream(chunk)) &#123;</span><br><span class="line">                    int len;</span><br><span class="line">                    while ((len = fis.read(buffer)) != -1) &#123;</span><br><span class="line">                        raf.write(buffer, 0, len);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // éªŒè¯æ–‡ä»¶MD5</span><br><span class="line">        String mergedMd5 = calculateFileMD5(destFile);</span><br><span class="line">        if (fileMd5 != null &amp;&amp; !fileMd5.equals(mergedMd5)) &#123;</span><br><span class="line">            destFile.delete();</span><br><span class="line">            throw new BusinessException(ResultCode.PARAM_VALID_ERROR, &quot;æ–‡ä»¶MD5æ ¡éªŒå¤±è´¥&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // æ¸…ç†ä¸´æ—¶åˆ†ç‰‡</span><br><span class="line">        FileUtils.deleteDirectory(dir);</span><br><span class="line">        </span><br><span class="line">        UploadResult result = new UploadResult();</span><br><span class="line">        result.setOriginalName(fileName);</span><br><span class="line">        result.setFileName(destFile.getName());</span><br><span class="line">        result.setFilePath(storagePath);</span><br><span class="line">        result.setFileSize(destFile.length());</span><br><span class="line">        result.setFileType(getFileExtension(fileName));</span><br><span class="line">        result.setMd5(mergedMd5);</span><br><span class="line">        result.setUrl(&quot;/static/product/&quot; + storagePath);</span><br><span class="line">        </span><br><span class="line">        log.info(&quot;åˆ†ç‰‡åˆå¹¶æˆåŠŸï¼Œæ–‡ä»¶ï¼š&#123;&#125;ï¼Œå¤§å°ï¼š&#123;&#125;ï¼ŒMD5ï¼š&#123;&#125;&quot;, </span><br><span class="line">                storagePath, destFile.length(), mergedMd5);</span><br><span class="line">        </span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è·å–å·²ä¸Šä¼ çš„åˆ†ç‰‡åˆ—è¡¨ï¼ˆç”¨äºæ–­ç‚¹ç»­ä¼ ï¼‰</span><br><span class="line">     */</span><br><span class="line">    public List&lt;Integer&gt; getUploadedChunks(String fileKey) &#123;</span><br><span class="line">        String chunkDir = tempDir + File.separator + fileKey;</span><br><span class="line">        File dir = new File(chunkDir);</span><br><span class="line">        </span><br><span class="line">        if (!dir.exists() || !dir.isDirectory()) &#123;</span><br><span class="line">            return Collections.emptyList();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        List&lt;Integer&gt; uploaded = new ArrayList&lt;&gt;();</span><br><span class="line">        File[] chunks = dir.listFiles();</span><br><span class="line">        if (chunks != null) &#123;</span><br><span class="line">            for (File chunk : chunks) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    uploaded.add(Integer.parseInt(chunk.getName()));</span><br><span class="line">                &#125; catch (NumberFormatException e) &#123;</span><br><span class="line">                    // å¿½ç•¥éæ•°å­—æ–‡ä»¶</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return uploaded;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * ä¸‹è½½æ–‡ä»¶</span><br><span class="line">     */</span><br><span class="line">    public File download(String filePath) &#123;</span><br><span class="line">        File file = new File(baseDir, filePath);</span><br><span class="line">        if (!file.exists() || !file.isFile()) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.RESOURCE_NOT_FOUND, &quot;æ–‡ä»¶ä¸å­˜åœ¨&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        return file;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆ é™¤æ–‡ä»¶</span><br><span class="line">     */</span><br><span class="line">    public boolean delete(String filePath) &#123;</span><br><span class="line">        File file = new File(baseDir, filePath);</span><br><span class="line">        if (file.exists()) &#123;</span><br><span class="line">            return file.delete();</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * ç”Ÿæˆå­˜å‚¨è·¯å¾„</span><br><span class="line">     */</span><br><span class="line">    private String generateStoragePath(String originalFilename) &#123;</span><br><span class="line">        String datePath = LocalDate.now().format(DATE_FORMATTER);</span><br><span class="line">        String uuid = UUID.randomUUID().toString().replace(&quot;-&quot;, &quot;&quot;);</span><br><span class="line">        String extension = getFileExtension(originalFilename);</span><br><span class="line">        </span><br><span class="line">        return datePath + &quot;/&quot; + uuid + &quot;.&quot; + extension;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è·å–æ–‡ä»¶æ‰©å±•å</span><br><span class="line">     */</span><br><span class="line">    private String getFileExtension(String filename) &#123;</span><br><span class="line">        if (filename == null || filename.lastIndexOf(&quot;.&quot;) == -1) &#123;</span><br><span class="line">            return &quot;&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        return filename.substring(filename.lastIndexOf(&quot;.&quot;) + 1);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è®¡ç®—æ–‡ä»¶MD5</span><br><span class="line">     */</span><br><span class="line">    private String calculateFileMD5(File file) throws IOException &#123;</span><br><span class="line">        try (FileInputStream fis = new FileInputStream(file)) &#123;</span><br><span class="line">            return DigestUtils.md5DigestAsHex(fis);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // ä¸Šä¼ ç»“æœç±»</span><br><span class="line">    @Data</span><br><span class="line">    public static class UploadResult &#123;</span><br><span class="line">        private String originalName;</span><br><span class="line">        private String fileName;</span><br><span class="line">        private String filePath;</span><br><span class="line">        private long fileSize;</span><br><span class="line">        private String fileType;</span><br><span class="line">        private String md5;</span><br><span class="line">        private String url;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // åˆ†ç‰‡åˆå§‹åŒ–è¯·æ±‚</span><br><span class="line">    @Data</span><br><span class="line">    public static class ChunkInitRequest &#123;</span><br><span class="line">        private String fileName;</span><br><span class="line">        private long totalSize;</span><br><span class="line">        private int chunkSize;</span><br><span class="line">        private int totalChunks;</span><br><span class="line">        private String fileMd5;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // åˆ†ç‰‡åˆå§‹åŒ–ç»“æœ</span><br><span class="line">    @Data</span><br><span class="line">    public static class ChunkInitResult &#123;</span><br><span class="line">        private String fileKey;</span><br><span class="line">        private int chunkSize;</span><br><span class="line">        private int totalChunks;</span><br><span class="line">        private String storagePath;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // åˆ†ç‰‡ä¸Šä¼ ç»“æœ</span><br><span class="line">    @Data</span><br><span class="line">    public static class ChunkUploadResult &#123;</span><br><span class="line">        private int chunkNumber;</span><br><span class="line">        private long chunkSize;</span><br><span class="line">        private String chunkMd5;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="1-3-æ–‡ä»¶ä¸Šä¼ Controller"><a href="#1-3-æ–‡ä»¶ä¸Šä¼ Controller" class="headerlink" title="1.3 æ–‡ä»¶ä¸Šä¼ Controller"></a>1.3 æ–‡ä»¶ä¸Šä¼ Controller</h4><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.product.controller;</span><br><span class="line"></span><br><span class="line">import com.shophub.common.result.Result;</span><br><span class="line">import com.shophub.product.util.FileUploadUtil;</span><br><span class="line">import io.swagger.annotations.Api;</span><br><span class="line">import io.swagger.annotations.ApiOperation;</span><br><span class="line">import lombok.RequiredArgsConstructor;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.springframework.http.HttpHeaders;</span><br><span class="line">import org.springframework.http.MediaType;</span><br><span class="line">import org.springframework.http.ResponseEntity;</span><br><span class="line">import org.springframework.web.bind.annotation.*;</span><br><span class="line">import org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line">import javax.servlet.http.HttpServletResponse;</span><br><span class="line">import java.io.File;</span><br><span class="line">import java.io.FileInputStream;</span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.io.OutputStream;</span><br><span class="line">import java.net.URLEncoder;</span><br><span class="line">import java.nio.file.Files;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;/api/product/file&quot;)</span><br><span class="line">@RequiredArgsConstructor</span><br><span class="line">@Api(tags = &quot;æ–‡ä»¶ç®¡ç†&quot;)</span><br><span class="line">public class FileController &#123;</span><br><span class="line">    </span><br><span class="line">    private final FileUploadUtil fileUploadUtil;</span><br><span class="line">    </span><br><span class="line">    @PostMapping(&quot;/upload&quot;)</span><br><span class="line">    @ApiOperation(&quot;ä¸Šä¼ æ–‡ä»¶&quot;)</span><br><span class="line">    public Result&lt;FileUploadUtil.UploadResult&gt; upload(@RequestParam(&quot;file&quot;) MultipartFile file) throws IOException &#123;</span><br><span class="line">        FileUploadUtil.UploadResult result = fileUploadUtil.upload(file);</span><br><span class="line">        return Result.success(result);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @PostMapping(&quot;/chunk/init&quot;)</span><br><span class="line">    @ApiOperation(&quot;åˆå§‹åŒ–åˆ†ç‰‡ä¸Šä¼ &quot;)</span><br><span class="line">    public Result&lt;FileUploadUtil.ChunkInitResult&gt; initChunkUpload(</span><br><span class="line">            @RequestBody FileUploadUtil.ChunkInitRequest request) &#123;</span><br><span class="line">        FileUploadUtil.ChunkInitResult result = fileUploadUtil.initChunkUpload(request);</span><br><span class="line">        return Result.success(result);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @PostMapping(&quot;/chunk/upload&quot;)</span><br><span class="line">    @ApiOperation(&quot;ä¸Šä¼ åˆ†ç‰‡&quot;)</span><br><span class="line">    public Result&lt;FileUploadUtil.ChunkUploadResult&gt; uploadChunk(</span><br><span class="line">            @RequestParam String fileKey,</span><br><span class="line">            @RequestParam Integer chunkNumber,</span><br><span class="line">            @RequestParam(&quot;chunk&quot;) MultipartFile chunkFile) throws IOException &#123;</span><br><span class="line">        FileUploadUtil.ChunkUploadResult result = fileUploadUtil.uploadChunk(</span><br><span class="line">                fileKey, chunkNumber, chunkFile);</span><br><span class="line">        return Result.success(result);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @PostMapping(&quot;/chunk/merge&quot;)</span><br><span class="line">    @ApiOperation(&quot;åˆå¹¶åˆ†ç‰‡&quot;)</span><br><span class="line">    public Result&lt;FileUploadUtil.UploadResult&gt; mergeChunks(</span><br><span class="line">            @RequestParam String fileKey,</span><br><span class="line">            @RequestParam String fileName,</span><br><span class="line">            @RequestParam Integer totalChunks,</span><br><span class="line">            @RequestParam(required = false) String fileMd5) throws IOException &#123;</span><br><span class="line">        FileUploadUtil.UploadResult result = fileUploadUtil.mergeChunks(</span><br><span class="line">                fileKey, fileName, totalChunks, fileMd5);</span><br><span class="line">        return Result.success(result);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @GetMapping(&quot;/chunk/list&quot;)</span><br><span class="line">    @ApiOperation(&quot;è·å–å·²ä¸Šä¼ åˆ†ç‰‡åˆ—è¡¨&quot;)</span><br><span class="line">    public Result&lt;List&lt;Integer&gt;&gt; getUploadedChunks(@RequestParam String fileKey) &#123;</span><br><span class="line">        List&lt;Integer&gt; uploadedChunks = fileUploadUtil.getUploadedChunks(fileKey);</span><br><span class="line">        return Result.success(uploadedChunks);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @GetMapping(&quot;/download&quot;)</span><br><span class="line">    @ApiOperation(&quot;ä¸‹è½½æ–‡ä»¶&quot;)</span><br><span class="line">    public void download(@RequestParam String filePath, </span><br><span class="line">                        HttpServletResponse response) throws IOException &#123;</span><br><span class="line">        File file = fileUploadUtil.download(filePath);</span><br><span class="line">        </span><br><span class="line">        // è®¾ç½®å“åº”å¤´</span><br><span class="line">        response.setContentType(MediaType.APPLICATION_OCTET_STREAM_VALUE);</span><br><span class="line">        response.setHeader(HttpHeaders.CONTENT_DISPOSITION, </span><br><span class="line">                &quot;attachment; filename=\&quot;&quot; + URLEncoder.encode(file.getName(), &quot;UTF-8&quot;) + &quot;\&quot;&quot;);</span><br><span class="line">        response.setContentLengthLong(file.length());</span><br><span class="line">        </span><br><span class="line">        // å†™å…¥å“åº”æµ</span><br><span class="line">        try (FileInputStream fis = new FileInputStream(file);</span><br><span class="line">             OutputStream os = response.getOutputStream()) &#123;</span><br><span class="line">            byte[] buffer = new byte[8192];</span><br><span class="line">            int len;</span><br><span class="line">            while ((len = fis.read(buffer)) != -1) &#123;</span><br><span class="line">                os.write(buffer, 0, len);</span><br><span class="line">            &#125;</span><br><span class="line">            os.flush();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @DeleteMapping</span><br><span class="line">    @ApiOperation(&quot;åˆ é™¤æ–‡ä»¶&quot;)</span><br><span class="line">    public Result&lt;Boolean&gt; deleteFile(@RequestParam String filePath) &#123;</span><br><span class="line">        boolean success = fileUploadUtil.delete(filePath);</span><br><span class="line">        return Result.success(success);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @GetMapping(&quot;/preview&quot;)</span><br><span class="line">    @ApiOperation(&quot;é¢„è§ˆæ–‡ä»¶ï¼ˆå›¾ç‰‡ï¼‰&quot;)</span><br><span class="line">    public ResponseEntity&lt;byte[]&gt; preview(@RequestParam String filePath) throws IOException &#123;</span><br><span class="line">        File file = fileUploadUtil.download(filePath);</span><br><span class="line">        </span><br><span class="line">        // æ£€æŸ¥æ–‡ä»¶ç±»å‹æ˜¯å¦ä¸ºå›¾ç‰‡</span><br><span class="line">        String contentType = Files.probeContentType(file.toPath());</span><br><span class="line">        if (contentType == null || !contentType.startsWith(&quot;image/&quot;)) &#123;</span><br><span class="line">            contentType = &quot;image/jpeg&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        byte[] bytes = Files.readAllBytes(file.toPath());</span><br><span class="line">        </span><br><span class="line">        return ResponseEntity.ok()</span><br><span class="line">                .contentType(MediaType.parseMediaType(contentType))</span><br><span class="line">                .body(bytes);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-å•†å“åˆ†ç±»ç®¡ç†"><a href="#2-å•†å“åˆ†ç±»ç®¡ç†" class="headerlink" title="2. å•†å“åˆ†ç±»ç®¡ç†"></a>2. å•†å“åˆ†ç±»ç®¡ç†</h3><h4 id="2-1-åˆ†ç±»Serviceå®ç°"><a href="#2-1-åˆ†ç±»Serviceå®ç°" class="headerlink" title="2.1 åˆ†ç±»Serviceå®ç°"></a>2.1 åˆ†ç±»Serviceå®ç°</h4><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.product.service;</span><br><span class="line"></span><br><span class="line">import com.baomidou.mybatisplus.extension.service.IService;</span><br><span class="line">import com.shophub.product.entity.ProductCategory;</span><br><span class="line">import com.shophub.product.entity.vo.CategoryTreeVo;</span><br><span class="line"></span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">public interface CategoryService extends IService&lt;ProductCategory&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ·»åŠ åˆ†ç±»</span><br><span class="line">     */</span><br><span class="line">    Long addCategory(ProductCategory category);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ›´æ–°åˆ†ç±»</span><br><span class="line">     */</span><br><span class="line">    boolean updateCategory(ProductCategory category);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆ é™¤åˆ†ç±»</span><br><span class="line">     */</span><br><span class="line">    boolean deleteCategory(Long id);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è·å–åˆ†ç±»æ ‘</span><br><span class="line">     */</span><br><span class="line">    List&lt;CategoryTreeVo&gt; getCategoryTree();</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è·å–å­åˆ†ç±»åˆ—è¡¨</span><br><span class="line">     */</span><br><span class="line">    List&lt;ProductCategory&gt; getChildCategories(Long parentId);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è·å–åˆ†ç±»è·¯å¾„</span><br><span class="line">     */</span><br><span class="line">    List&lt;ProductCategory&gt; getCategoryPath(Long categoryId);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * ç§»åŠ¨åˆ†ç±»</span><br><span class="line">     */</span><br><span class="line">    boolean moveCategory(Long id, Long newParentId);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ›´æ–°åˆ†ç±»æ’åº</span><br><span class="line">     */</span><br><span class="line">    boolean updateCategorySort(List&lt;Long&gt; ids);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// CategoryServiceImpl.java</span><br><span class="line">package com.shophub.product.service.impl;</span><br><span class="line"></span><br><span class="line">import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;</span><br><span class="line">import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span><br><span class="line">import com.shophub.common.exception.BusinessException;</span><br><span class="line">import com.shophub.common.id.SnowflakeIdGenerator;</span><br><span class="line">import com.shophub.common.redis.RedisUtil;</span><br><span class="line">import com.shophub.common.result.ResultCode;</span><br><span class="line">import com.shophub.product.entity.ProductCategory;</span><br><span class="line">import com.shophub.product.entity.vo.CategoryTreeVo;</span><br><span class="line">import com.shophub.product.mapper.CategoryMapper;</span><br><span class="line">import com.shophub.product.service.CategoryService;</span><br><span class="line">import lombok.RequiredArgsConstructor;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.springframework.cache.annotation.CacheEvict;</span><br><span class="line">import org.springframework.cache.annotation.Cacheable;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line">import org.springframework.transaction.annotation.Transactional;</span><br><span class="line">import org.springframework.util.CollectionUtils;</span><br><span class="line"></span><br><span class="line">import java.util.*;</span><br><span class="line">import java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@Service</span><br><span class="line">@RequiredArgsConstructor</span><br><span class="line">public class CategoryServiceImpl extends ServiceImpl&lt;CategoryMapper, ProductCategory&gt; implements CategoryService &#123;</span><br><span class="line">    </span><br><span class="line">    private final CategoryMapper categoryMapper;</span><br><span class="line">    private final SnowflakeIdGenerator idGenerator;</span><br><span class="line">    private final RedisUtil redisUtil;</span><br><span class="line">    </span><br><span class="line">    private static final String CATEGORY_TREE_CACHE_KEY = &quot;product:category:tree&quot;;</span><br><span class="line">    private static final String CATEGORY_CHILDREN_CACHE_PREFIX = &quot;product:category:children:&quot;;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    @Transactional(rollbackFor = Exception.class)</span><br><span class="line">    public Long addCategory(ProductCategory category) &#123;</span><br><span class="line">        // ç”Ÿæˆåˆ†ç±»ID</span><br><span class="line">        Long categoryId = idGenerator.nextId();</span><br><span class="line">        category.setId(categoryId);</span><br><span class="line">        </span><br><span class="line">        // è®¾ç½®åˆ†ç±»çº§åˆ«</span><br><span class="line">        if (category.getParentId() == null || category.getParentId() == 0) &#123;</span><br><span class="line">            category.setParentId(0L);</span><br><span class="line">            category.setLevel(1);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // è·å–çˆ¶åˆ†ç±»</span><br><span class="line">            ProductCategory parent = getById(category.getParentId());</span><br><span class="line">            if (parent == null) &#123;</span><br><span class="line">                throw new BusinessException(ResultCode.RESOURCE_NOT_FOUND, &quot;çˆ¶åˆ†ç±»ä¸å­˜åœ¨&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            category.setLevel(parent.getLevel() + 1);</span><br><span class="line">            </span><br><span class="line">            // é™åˆ¶åˆ†ç±»å±‚çº§ï¼ˆæœ€å¤š3çº§ï¼‰</span><br><span class="line">            if (category.getLevel() &gt; 3) &#123;</span><br><span class="line">                throw new BusinessException(ResultCode.BUSINESS_ERROR, &quot;åˆ†ç±»å±‚çº§ä¸èƒ½è¶…è¿‡3çº§&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // è®¾ç½®é»˜è®¤å€¼</span><br><span class="line">        if (category.getSort() == null) &#123;</span><br><span class="line">            category.setSort(0);</span><br><span class="line">        &#125;</span><br><span class="line">        if (category.getStatus() == null) &#123;</span><br><span class="line">            category.setStatus(1);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // ä¿å­˜åˆ°æ•°æ®åº“</span><br><span class="line">        boolean success = save(category);</span><br><span class="line">        if (!success) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.SYSTEM_ERROR, &quot;åˆ†ç±»æ·»åŠ å¤±è´¥&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // æ¸…é™¤ç¼“å­˜</span><br><span class="line">        clearCategoryCache();</span><br><span class="line">        </span><br><span class="line">        log.info(&quot;æ·»åŠ åˆ†ç±»æˆåŠŸï¼Œåˆ†ç±»IDï¼š&#123;&#125;ï¼Œåˆ†ç±»åç§°ï¼š&#123;&#125;&quot;, categoryId, category.getCategoryName());</span><br><span class="line">        return categoryId;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    @CacheEvict(value = &quot;category&quot;, allEntries = true)</span><br><span class="line">    @Transactional(rollbackFor = Exception.class)</span><br><span class="line">    public boolean updateCategory(ProductCategory category) &#123;</span><br><span class="line">        if (category.getId() == null) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.PARAM_VALID_ERROR, &quot;åˆ†ç±»IDä¸èƒ½ä¸ºç©º&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // æ£€æŸ¥åˆ†ç±»æ˜¯å¦å­˜åœ¨</span><br><span class="line">        ProductCategory existing = getById(category.getId());</span><br><span class="line">        if (existing == null) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.RESOURCE_NOT_FOUND, &quot;åˆ†ç±»ä¸å­˜åœ¨&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // å¦‚æœä¿®æ”¹äº†çˆ¶åˆ†ç±»ï¼Œéœ€è¦é‡æ–°è®¡ç®—å±‚çº§</span><br><span class="line">        if (category.getParentId() != null &amp;&amp; !category.getParentId().equals(existing.getParentId())) &#123;</span><br><span class="line">            // ä¸èƒ½å°†è‡ªå·±è®¾ä¸ºçˆ¶åˆ†ç±»</span><br><span class="line">            if (category.getParentId().equals(category.getId())) &#123;</span><br><span class="line">                throw new BusinessException(ResultCode.BUSINESS_ERROR, &quot;ä¸èƒ½å°†åˆ†ç±»è®¾ç½®ä¸ºè‡ªå·±çš„çˆ¶åˆ†ç±»&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // æ£€æŸ¥æ–°çˆ¶åˆ†ç±»æ˜¯å¦å­˜åœ¨</span><br><span class="line">            if (category.getParentId() != 0) &#123;</span><br><span class="line">                ProductCategory newParent = getById(category.getParentId());</span><br><span class="line">                if (newParent == null) &#123;</span><br><span class="line">                    throw new BusinessException(ResultCode.RESOURCE_NOT_FOUND, &quot;çˆ¶åˆ†ç±»ä¸å­˜åœ¨&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                // æ£€æŸ¥æ˜¯å¦ä¼šäº§ç”Ÿå¾ªç¯å¼•ç”¨</span><br><span class="line">                if (isCircularReference(category.getId(), category.getParentId())) &#123;</span><br><span class="line">                    throw new BusinessException(ResultCode.BUSINESS_ERROR, &quot;ä¼šäº§ç”Ÿå¾ªç¯å¼•ç”¨&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                category.setLevel(newParent.getLevel() + 1);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                category.setLevel(1);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // æ›´æ–°æ•°æ®åº“</span><br><span class="line">        boolean success = updateById(category);</span><br><span class="line">        if (success) &#123;</span><br><span class="line">            // å¦‚æœä¿®æ”¹äº†çˆ¶åˆ†ç±»æˆ–å±‚çº§ï¼Œéœ€è¦æ›´æ–°å­åˆ†ç±»</span><br><span class="line">            if (category.getParentId() != null || category.getLevel() != null) &#123;</span><br><span class="line">                updateChildrenLevel(category.getId(), category.getLevel());</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // æ¸…é™¤ç¼“å­˜</span><br><span class="line">            clearCategoryCache();</span><br><span class="line">            </span><br><span class="line">            log.info(&quot;æ›´æ–°åˆ†ç±»æˆåŠŸï¼Œåˆ†ç±»IDï¼š&#123;&#125;&quot;, category.getId());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return success;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    @CacheEvict(value = &quot;category&quot;, allEntries = true)</span><br><span class="line">    @Transactional(rollbackFor = Exception.class)</span><br><span class="line">    public boolean deleteCategory(Long id) &#123;</span><br><span class="line">        // æ£€æŸ¥åˆ†ç±»æ˜¯å¦å­˜åœ¨</span><br><span class="line">        ProductCategory category = getById(id);</span><br><span class="line">        if (category == null) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.RESOURCE_NOT_FOUND, &quot;åˆ†ç±»ä¸å­˜åœ¨&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // æ£€æŸ¥æ˜¯å¦æœ‰å­åˆ†ç±»</span><br><span class="line">        long childCount = count(new QueryWrapper&lt;ProductCategory&gt;()</span><br><span class="line">                .eq(&quot;parent_id&quot;, id)</span><br><span class="line">                .eq(&quot;is_deleted&quot;, 0));</span><br><span class="line">        if (childCount &gt; 0) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.BUSINESS_ERROR, &quot;è¯¥åˆ†ç±»ä¸‹æœ‰å­åˆ†ç±»ï¼Œä¸èƒ½åˆ é™¤&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // æ£€æŸ¥æ˜¯å¦æœ‰å•†å“ä½¿ç”¨è¯¥åˆ†ç±»</span><br><span class="line">        // è¿™é‡Œéœ€è¦æŸ¥è¯¢å•†å“è¡¨ï¼Œæš‚æ—¶çœç•¥</span><br><span class="line">        </span><br><span class="line">        // é€»è¾‘åˆ é™¤</span><br><span class="line">        boolean success = removeById(id);</span><br><span class="line">        if (success) &#123;</span><br><span class="line">            clearCategoryCache();</span><br><span class="line">            log.info(&quot;åˆ é™¤åˆ†ç±»æˆåŠŸï¼Œåˆ†ç±»IDï¼š&#123;&#125;&quot;, id);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return success;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    @Cacheable(value = &quot;category&quot;, key = &quot;&#x27;tree&#x27;&quot;, unless = &quot;#result == null || #result.size() == 0&quot;)</span><br><span class="line">    public List&lt;CategoryTreeVo&gt; getCategoryTree() &#123;</span><br><span class="line">        log.info(&quot;æŸ¥è¯¢åˆ†ç±»æ ‘ï¼Œä»æ•°æ®åº“æŸ¥è¯¢&quot;);</span><br><span class="line">        </span><br><span class="line">        // æŸ¥è¯¢æ‰€æœ‰å¯ç”¨çš„åˆ†ç±»</span><br><span class="line">        List&lt;ProductCategory&gt; allCategories = list(new QueryWrapper&lt;ProductCategory&gt;()</span><br><span class="line">                .eq(&quot;status&quot;, 1)</span><br><span class="line">                .eq(&quot;is_deleted&quot;, 0)</span><br><span class="line">                .orderByAsc(&quot;sort&quot;, &quot;create_time&quot;));</span><br><span class="line">        </span><br><span class="line">        if (CollectionUtils.isEmpty(allCategories)) &#123;</span><br><span class="line">            return Collections.emptyList();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // æ„å»ºæ ‘å½¢ç»“æ„</span><br><span class="line">        return buildCategoryTree(allCategories, 0L);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    @Cacheable(value = &quot;category&quot;, key = &quot;&#x27;children:&#x27; + #parentId&quot;, unless = &quot;#result == null || #result.size() == 0&quot;)</span><br><span class="line">    public List&lt;ProductCategory&gt; getChildCategories(Long parentId) &#123;</span><br><span class="line">        return list(new QueryWrapper&lt;ProductCategory&gt;()</span><br><span class="line">                .eq(&quot;parent_id&quot;, parentId)</span><br><span class="line">                .eq(&quot;status&quot;, 1)</span><br><span class="line">                .eq(&quot;is_deleted&quot;, 0)</span><br><span class="line">                .orderByAsc(&quot;sort&quot;, &quot;create_time&quot;));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public List&lt;ProductCategory&gt; getCategoryPath(Long categoryId) &#123;</span><br><span class="line">        List&lt;ProductCategory&gt; path = new ArrayList&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        ProductCategory category = getById(categoryId);</span><br><span class="line">        if (category == null) &#123;</span><br><span class="line">            return path;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // æ·»åŠ å½“å‰åˆ†ç±»</span><br><span class="line">        path.add(category);</span><br><span class="line">        </span><br><span class="line">        // é€’å½’æ·»åŠ çˆ¶åˆ†ç±»</span><br><span class="line">        while (category.getParentId() != null &amp;&amp; category.getParentId() != 0) &#123;</span><br><span class="line">            category = getById(category.getParentId());</span><br><span class="line">            if (category != null) &#123;</span><br><span class="line">                path.add(0, category); // æ·»åŠ åˆ°å¼€å¤´</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return path;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    @CacheEvict(value = &quot;category&quot;, allEntries = true)</span><br><span class="line">    @Transactional(rollbackFor = Exception.class)</span><br><span class="line">    public boolean moveCategory(Long id, Long newParentId) &#123;</span><br><span class="line">        ProductCategory category = getById(id);</span><br><span class="line">        if (category == null) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.RESOURCE_NOT_FOUND, &quot;åˆ†ç±»ä¸å­˜åœ¨&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // æ£€æŸ¥æ–°çˆ¶åˆ†ç±»</span><br><span class="line">        if (newParentId != 0) &#123;</span><br><span class="line">            ProductCategory newParent = getById(newParentId);</span><br><span class="line">            if (newParent == null) &#123;</span><br><span class="line">                throw new BusinessException(ResultCode.RESOURCE_NOT_FOUND, &quot;çˆ¶åˆ†ç±»ä¸å­˜åœ¨&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // æ£€æŸ¥æ˜¯å¦ä¼šäº§ç”Ÿå¾ªç¯å¼•ç”¨</span><br><span class="line">            if (isCircularReference(id, newParentId)) &#123;</span><br><span class="line">                throw new BusinessException(ResultCode.BUSINESS_ERROR, &quot;ä¼šäº§ç”Ÿå¾ªç¯å¼•ç”¨&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // æ›´æ–°çˆ¶åˆ†ç±»å’Œå±‚çº§</span><br><span class="line">        category.setParentId(newParentId);</span><br><span class="line">        category.setLevel(newParentId == 0 ? 1 : (getById(newParentId).getLevel() + 1));</span><br><span class="line">        </span><br><span class="line">        boolean success = updateById(category);</span><br><span class="line">        if (success) &#123;</span><br><span class="line">            // æ›´æ–°å­åˆ†ç±»å±‚çº§</span><br><span class="line">            updateChildrenLevel(id, category.getLevel());</span><br><span class="line">            </span><br><span class="line">            // æ¸…é™¤ç¼“å­˜</span><br><span class="line">            clearCategoryCache();</span><br><span class="line">            </span><br><span class="line">            log.info(&quot;ç§»åŠ¨åˆ†ç±»æˆåŠŸï¼Œåˆ†ç±»IDï¼š&#123;&#125;ï¼Œæ–°çˆ¶åˆ†ç±»IDï¼š&#123;&#125;&quot;, id, newParentId);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return success;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    @CacheEvict(value = &quot;category&quot;, allEntries = true)</span><br><span class="line">    @Transactional(rollbackFor = Exception.class)</span><br><span class="line">    public boolean updateCategorySort(List&lt;Long&gt; ids) &#123;</span><br><span class="line">        if (CollectionUtils.isEmpty(ids)) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        for (int i = 0; i &lt; ids.size(); i++) &#123;</span><br><span class="line">            ProductCategory category = new ProductCategory();</span><br><span class="line">            category.setId(ids.get(i));</span><br><span class="line">            category.setSort(i + 1);</span><br><span class="line">            updateById(category);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        clearCategoryCache();</span><br><span class="line">        log.info(&quot;æ›´æ–°åˆ†ç±»æ’åºæˆåŠŸï¼Œæ’åºIDsï¼š&#123;&#125;&quot;, ids);</span><br><span class="line">        </span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ„å»ºåˆ†ç±»æ ‘</span><br><span class="line">     */</span><br><span class="line">    private List&lt;CategoryTreeVo&gt; buildCategoryTree(List&lt;ProductCategory&gt; categories, Long parentId) &#123;</span><br><span class="line">        return categories.stream()</span><br><span class="line">                .filter(category -&gt; parentId.equals(category.getParentId()))</span><br><span class="line">                .map(category -&gt; &#123;</span><br><span class="line">                    CategoryTreeVo treeVo = new CategoryTreeVo();</span><br><span class="line">                    treeVo.setId(category.getId());</span><br><span class="line">                    treeVo.setCategoryName(category.getCategoryName());</span><br><span class="line">                    treeVo.setParentId(category.getParentId());</span><br><span class="line">                    treeVo.setLevel(category.getLevel());</span><br><span class="line">                    treeVo.setSort(category.getSort());</span><br><span class="line">                    treeVo.setStatus(category.getStatus());</span><br><span class="line">                    </span><br><span class="line">                    // é€’å½’æ„å»ºå­èŠ‚ç‚¹</span><br><span class="line">                    List&lt;CategoryTreeVo&gt; children = buildCategoryTree(categories, category.getId());</span><br><span class="line">                    treeVo.setChildren(children);</span><br><span class="line">                    </span><br><span class="line">                    return treeVo;</span><br><span class="line">                &#125;)</span><br><span class="line">                .sorted(Comparator.comparing(CategoryTreeVo::getSort)</span><br><span class="line">                        .thenComparing(CategoryTreeVo::getId))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ›´æ–°å­åˆ†ç±»å±‚çº§</span><br><span class="line">     */</span><br><span class="line">    private void updateChildrenLevel(Long parentId, int parentLevel) &#123;</span><br><span class="line">        List&lt;ProductCategory&gt; children = getChildCategories(parentId);</span><br><span class="line">        for (ProductCategory child : children) &#123;</span><br><span class="line">            child.setLevel(parentLevel + 1);</span><br><span class="line">            updateById(child);</span><br><span class="line">            </span><br><span class="line">            // é€’å½’æ›´æ–°å­™å­åˆ†ç±»</span><br><span class="line">            updateChildrenLevel(child.getId(), child.getLevel());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ£€æŸ¥å¾ªç¯å¼•ç”¨</span><br><span class="line">     */</span><br><span class="line">    private boolean isCircularReference(Long categoryId, Long potentialParentId) &#123;</span><br><span class="line">        if (categoryId.equals(potentialParentId)) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // é€’å½’æ£€æŸ¥æ½œåœ¨çˆ¶åˆ†ç±»çš„çˆ¶åˆ†ç±»</span><br><span class="line">        ProductCategory potentialParent = getById(potentialParentId);</span><br><span class="line">        if (potentialParent != null &amp;&amp; potentialParent.getParentId() != null &amp;&amp; potentialParent.getParentId() != 0) &#123;</span><br><span class="line">            return isCircularReference(categoryId, potentialParent.getParentId());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ¸…é™¤åˆ†ç±»ç¼“å­˜</span><br><span class="line">     */</span><br><span class="line">    private void clearCategoryCache() &#123;</span><br><span class="line">        redisUtil.delete(CATEGORY_TREE_CACHE_KEY);</span><br><span class="line">        redisUtil.deleteByPattern(CATEGORY_CHILDREN_CACHE_PREFIX + &quot;*&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// CategoryTreeVo.java</span><br><span class="line">@Data</span><br><span class="line">class CategoryTreeVo &#123;</span><br><span class="line">    private Long id;</span><br><span class="line">    private String categoryName;</span><br><span class="line">    private Long parentId;</span><br><span class="line">    private Integer level;</span><br><span class="line">    private Integer sort;</span><br><span class="line">    private Integer status;</span><br><span class="line">    private List&lt;CategoryTreeVo&gt; children;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-Redisç¼“å­˜é«˜çº§åº”ç”¨"><a href="#3-Redisç¼“å­˜é«˜çº§åº”ç”¨" class="headerlink" title="3. Redisç¼“å­˜é«˜çº§åº”ç”¨"></a>3. Redisç¼“å­˜é«˜çº§åº”ç”¨</h3><h4 id="3-1-ç¼“å­˜ç©¿é€ã€å‡»ç©¿ã€é›ªå´©è§£å†³æ–¹æ¡ˆ"><a href="#3-1-ç¼“å­˜ç©¿é€ã€å‡»ç©¿ã€é›ªå´©è§£å†³æ–¹æ¡ˆ" class="headerlink" title="3.1 ç¼“å­˜ç©¿é€ã€å‡»ç©¿ã€é›ªå´©è§£å†³æ–¹æ¡ˆ"></a>3.1 ç¼“å­˜ç©¿é€ã€å‡»ç©¿ã€é›ªå´©è§£å†³æ–¹æ¡ˆ</h4><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.product.cache;</span><br><span class="line"></span><br><span class="line">import com.shophub.common.exception.BusinessException;</span><br><span class="line">import com.shophub.common.redis.RedisUtil;</span><br><span class="line">import com.shophub.common.result.ResultCode;</span><br><span class="line">import lombok.RequiredArgsConstructor;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.redisson.api.RLock;</span><br><span class="line">import org.redisson.api.RedissonClient;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.TimeUnit;</span><br><span class="line">import java.util.function.Supplier;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * ç¼“å­˜ç®¡ç†å™¨ - ç»Ÿä¸€å¤„ç†ç¼“å­˜ç©¿é€ã€å‡»ç©¿ã€é›ªå´©é—®é¢˜</span><br><span class="line"> */</span><br><span class="line">@Slf4j</span><br><span class="line">@Component</span><br><span class="line">@RequiredArgsConstructor</span><br><span class="line">public class CacheManager &#123;</span><br><span class="line">    </span><br><span class="line">    private final RedisUtil redisUtil;</span><br><span class="line">    private final RedissonClient redissonClient;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è·å–ç¼“å­˜æ•°æ®ï¼ˆè§£å†³ç¼“å­˜ç©¿é€ã€å‡»ç©¿ã€é›ªå´©ï¼‰</span><br><span class="line">     * </span><br><span class="line">     * @param key ç¼“å­˜key</span><br><span class="line">     * @param clazz æ•°æ®ç±»å‹</span><br><span class="line">     * @param loader æ•°æ®åŠ è½½å™¨ï¼ˆä»æ•°æ®åº“åŠ è½½ï¼‰</span><br><span class="line">     * @param expireSeconds è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰</span><br><span class="line">     * @param &lt;T&gt; æ•°æ®ç±»å‹</span><br><span class="line">     * @return ç¼“å­˜æ•°æ®</span><br><span class="line">     */</span><br><span class="line">    public &lt;T&gt; T get(String key, Class&lt;T&gt; clazz, Supplier&lt;T&gt; loader, long expireSeconds) &#123;</span><br><span class="line">        return get(key, clazz, loader, expireSeconds, true);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è·å–ç¼“å­˜æ•°æ®</span><br><span class="line">     * </span><br><span class="line">     * @param key ç¼“å­˜key</span><br><span class="line">     * @param clazz æ•°æ®ç±»å‹</span><br><span class="line">     * @param loader æ•°æ®åŠ è½½å™¨</span><br><span class="line">     * @param expireSeconds è¿‡æœŸæ—¶é—´</span><br><span class="line">     * @param useBloomFilter æ˜¯å¦ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆé˜²ç©¿é€ï¼‰</span><br><span class="line">     * @param &lt;T&gt; æ•°æ®ç±»å‹</span><br><span class="line">     * @return ç¼“å­˜æ•°æ®</span><br><span class="line">     */</span><br><span class="line">    public &lt;T&gt; T get(String key, Class&lt;T&gt; clazz, Supplier&lt;T&gt; loader, </span><br><span class="line">                    long expireSeconds, boolean useBloomFilter) &#123;</span><br><span class="line">        // 1. ä»ç¼“å­˜è¯»å–</span><br><span class="line">        T value = redisUtil.get(key, clazz);</span><br><span class="line">        if (value != null) &#123;</span><br><span class="line">            // å¦‚æœæ˜¯ç©ºå€¼æ ‡è®°ï¼Œè¿”å›null</span><br><span class="line">            if (isNullValue(value)) &#123;</span><br><span class="line">                return null;</span><br><span class="line">            &#125;</span><br><span class="line">            return value;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 2. ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨é˜²ç©¿é€</span><br><span class="line">        if (useBloomFilter &amp;&amp; !bloomFilterContains(key)) &#123;</span><br><span class="line">            log.debug(&quot;å¸ƒéš†è¿‡æ»¤å™¨åˆ¤å®škeyä¸å­˜åœ¨ï¼š&#123;&#125;&quot;, key);</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 3. è·å–åˆ†å¸ƒå¼é”ï¼ˆé˜²å‡»ç©¿ï¼‰</span><br><span class="line">        String lockKey = &quot;lock:&quot; + key;</span><br><span class="line">        RLock lock = redissonClient.getLock(lockKey);</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            // å°è¯•åŠ é”ï¼Œç­‰å¾…3ç§’ï¼Œé”5ç§’åè‡ªåŠ¨é‡Šæ”¾</span><br><span class="line">            boolean locked = lock.tryLock(3, 5, TimeUnit.SECONDS);</span><br><span class="line">            if (!locked) &#123;</span><br><span class="line">                // è·å–é”å¤±è´¥ï¼Œå¯èƒ½æ˜¯å…¶ä»–çº¿ç¨‹æ­£åœ¨åŠ è½½æ•°æ®</span><br><span class="line">                // å¯ä»¥ç­‰å¾…åé‡è¯•æˆ–ç›´æ¥è¿”å›æ—§æ•°æ®ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰</span><br><span class="line">                log.warn(&quot;è·å–åˆ†å¸ƒå¼é”å¤±è´¥ï¼š&#123;&#125;&quot;, lockKey);</span><br><span class="line">                throw new BusinessException(ResultCode.SYSTEM_ERROR, &quot;ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // 4. å†æ¬¡æ£€æŸ¥ç¼“å­˜ï¼ˆåŒé‡æ£€æŸ¥é”å®šï¼‰</span><br><span class="line">            value = redisUtil.get(key, clazz);</span><br><span class="line">            if (value != null) &#123;</span><br><span class="line">                if (isNullValue(value)) &#123;</span><br><span class="line">                    return null;</span><br><span class="line">                &#125;</span><br><span class="line">                return value;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // 5. ä»æ•°æ®åº“åŠ è½½æ•°æ®</span><br><span class="line">            try &#123;</span><br><span class="line">                value = loader.get();</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                log.error(&quot;ä»æ•°æ®åº“åŠ è½½æ•°æ®å¤±è´¥ï¼š&#123;&#125;&quot;, key, e);</span><br><span class="line">                throw e;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // 6. å†™å…¥ç¼“å­˜</span><br><span class="line">            if (value == null) &#123;</span><br><span class="line">                // ç¼“å­˜ç©ºå€¼ï¼Œé˜²æ­¢ç¼“å­˜ç©¿é€</span><br><span class="line">                cacheNullValue(key, expireSeconds);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                // éšæœºè¿‡æœŸæ—¶é—´ï¼Œé˜²æ­¢ç¼“å­˜é›ªå´©</span><br><span class="line">                long randomExpire = getRandomExpire(expireSeconds);</span><br><span class="line">                redisUtil.set(key, value, randomExpire, TimeUnit.SECONDS);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            return value;</span><br><span class="line">            </span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">            throw new BusinessException(ResultCode.SYSTEM_ERROR, &quot;ç³»ç»Ÿå¼‚å¸¸&quot;);</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            // é‡Šæ”¾é”</span><br><span class="line">            if (lock.isHeldByCurrentThread()) &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ‰¹é‡è·å–ç¼“å­˜æ•°æ®</span><br><span class="line">     */</span><br><span class="line">    public &lt;T&gt; List&lt;T&gt; batchGet(List&lt;String&gt; keys, Class&lt;T&gt; clazz, </span><br><span class="line">                               Supplier&lt;Map&lt;String, T&gt;&gt; batchLoader,</span><br><span class="line">                               long expireSeconds) &#123;</span><br><span class="line">        // 1. æ‰¹é‡ä»ç¼“å­˜è¯»å–</span><br><span class="line">        Map&lt;String, T&gt; cachedMap = new HashMap&lt;&gt;();</span><br><span class="line">        List&lt;String&gt; missingKeys = new ArrayList&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        for (String key : keys) &#123;</span><br><span class="line">            T value = redisUtil.get(key, clazz);</span><br><span class="line">            if (value != null) &#123;</span><br><span class="line">                if (!isNullValue(value)) &#123;</span><br><span class="line">                    cachedMap.put(key, value);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                missingKeys.add(key);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 2. å¦‚æœæ‰€æœ‰æ•°æ®éƒ½åœ¨ç¼“å­˜ä¸­ï¼Œç›´æ¥è¿”å›</span><br><span class="line">        if (missingKeys.isEmpty()) &#123;</span><br><span class="line">            return keys.stream()</span><br><span class="line">                    .map(cachedMap::get)</span><br><span class="line">                    .collect(Collectors.toList());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 3. æ‰¹é‡ä»æ•°æ®åº“åŠ è½½ç¼ºå¤±çš„æ•°æ®</span><br><span class="line">        Map&lt;String, T&gt; loadedMap = batchLoader.get();</span><br><span class="line">        if (loadedMap == null) &#123;</span><br><span class="line">            loadedMap = new HashMap&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 4. æ›´æ–°ç¼“å­˜</span><br><span class="line">        for (String key : missingKeys) &#123;</span><br><span class="line">            T value = loadedMap.get(key);</span><br><span class="line">            if (value == null) &#123;</span><br><span class="line">                // ç¼“å­˜ç©ºå€¼</span><br><span class="line">                cacheNullValue(key, expireSeconds);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                // è®¾ç½®ç¼“å­˜</span><br><span class="line">                long randomExpire = getRandomExpire(expireSeconds);</span><br><span class="line">                redisUtil.set(key, value, randomExpire, TimeUnit.SECONDS);</span><br><span class="line">                cachedMap.put(key, value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 5. è¿”å›ç»“æœ</span><br><span class="line">        return keys.stream()</span><br><span class="line">                .map(key -&gt; cachedMap.getOrDefault(key, null))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆ é™¤ç¼“å­˜</span><br><span class="line">     */</span><br><span class="line">    public boolean delete(String key) &#123;</span><br><span class="line">        return redisUtil.delete(key);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ‰¹é‡åˆ é™¤ç¼“å­˜</span><br><span class="line">     */</span><br><span class="line">    public long deleteByPattern(String pattern) &#123;</span><br><span class="line">        return redisUtil.deleteByPattern(pattern);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è®¾ç½®ç¼“å­˜</span><br><span class="line">     */</span><br><span class="line">    public void set(String key, Object value, long expireSeconds) &#123;</span><br><span class="line">        long randomExpire = getRandomExpire(expireSeconds);</span><br><span class="line">        redisUtil.set(key, value, randomExpire, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * ç¼“å­˜é¢„çƒ­</span><br><span class="line">     */</span><br><span class="line">    public void warmUp(String key, Supplier&lt;Object&gt; loader, long expireSeconds) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Object value = loader.get();</span><br><span class="line">            if (value != null) &#123;</span><br><span class="line">                set(key, value, expireSeconds);</span><br><span class="line">                log.info(&quot;ç¼“å­˜é¢„çƒ­æˆåŠŸï¼š&#123;&#125;&quot;, key);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;ç¼“å­˜é¢„çƒ­å¤±è´¥ï¼š&#123;&#125;&quot;, key, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ‰¹é‡ç¼“å­˜é¢„çƒ­</span><br><span class="line">     */</span><br><span class="line">    public void batchWarmUp(Map&lt;String, Supplier&lt;Object&gt;&gt; loaders, long expireSeconds) &#123;</span><br><span class="line">        for (Map.Entry&lt;String, Supplier&lt;Object&gt;&gt; entry : loaders.entrySet()) &#123;</span><br><span class="line">            warmUp(entry.getKey(), entry.getValue(), expireSeconds);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆ¤æ–­æ˜¯å¦ä¸ºç©ºå€¼æ ‡è®°</span><br><span class="line">     */</span><br><span class="line">    private boolean isNullValue(Object value) &#123;</span><br><span class="line">        if (value instanceof String) &#123;</span><br><span class="line">            return &quot;NULL&quot;.equals(value);</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * ç¼“å­˜ç©ºå€¼</span><br><span class="line">     */</span><br><span class="line">    private void cacheNullValue(String key, long expireSeconds) &#123;</span><br><span class="line">        // ç©ºå€¼ç¼“å­˜æ—¶é—´è¾ƒçŸ­ï¼Œé˜²æ­¢æ•°æ®åº“æœ‰æ•°æ®åä»ç„¶è¿”å›ç©ºå€¼</span><br><span class="line">        long nullCacheExpire = Math.min(expireSeconds / 2, 300); // æœ€å¤š5åˆ†é’Ÿ</span><br><span class="line">        redisUtil.set(key, &quot;NULL&quot;, nullCacheExpire, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è·å–éšæœºè¿‡æœŸæ—¶é—´ï¼ˆé˜²æ­¢ç¼“å­˜é›ªå´©ï¼‰</span><br><span class="line">     */</span><br><span class="line">    private long getRandomExpire(long baseExpire) &#123;</span><br><span class="line">        // åœ¨åŸºç¡€è¿‡æœŸæ—¶é—´ä¸Šå¢åŠ éšæœºåç§»ï¼ˆÂ±10%ï¼‰</span><br><span class="line">        double randomFactor = 0.9 + Math.random() * 0.2; // 0.9 ~ 1.1</span><br><span class="line">        return (long) (baseExpire * randomFactor);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å¸ƒéš†è¿‡æ»¤å™¨æ£€æŸ¥ï¼ˆæ¨¡æ‹Ÿï¼‰</span><br><span class="line">     */</span><br><span class="line">    private boolean bloomFilterContains(String key) &#123;</span><br><span class="line">        // è¿™é‡Œåº”è¯¥ä½¿ç”¨çœŸå®çš„å¸ƒéš†è¿‡æ»¤å™¨</span><br><span class="line">        // ä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬å‡è®¾æ‰€æœ‰keyéƒ½å­˜åœ¨</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-å¹¶å‘æµ‹è¯•"><a href="#4-å¹¶å‘æµ‹è¯•" class="headerlink" title="4. å¹¶å‘æµ‹è¯•"></a>4. å¹¶å‘æµ‹è¯•</h3><h4 id="4-1-å‹åŠ›æµ‹è¯•è„šæœ¬"><a href="#4-1-å‹åŠ›æµ‹è¯•è„šæœ¬" class="headerlink" title="4.1 å‹åŠ›æµ‹è¯•è„šæœ¬"></a>4.1 å‹åŠ›æµ‹è¯•è„šæœ¬</h4><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.product.test;</span><br><span class="line"></span><br><span class="line">import org.junit.jupiter.api.Test;</span><br><span class="line">import org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line">import org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"></span><br><span class="line">import javax.annotation.Resource;</span><br><span class="line">import java.util.concurrent.CountDownLatch;</span><br><span class="line">import java.util.concurrent.ExecutorService;</span><br><span class="line">import java.util.concurrent.Executors;</span><br><span class="line">import java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line">@SpringBootTest</span><br><span class="line">public class ProductConcurrentTest &#123;</span><br><span class="line">    </span><br><span class="line">    @Resource</span><br><span class="line">    private ProductService productService;</span><br><span class="line">    </span><br><span class="line">    @Resource</span><br><span class="line">    private RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æµ‹è¯•ç¼“å­˜ç©¿é€</span><br><span class="line">     */</span><br><span class="line">    @Test</span><br><span class="line">    public void testCachePenetration() throws InterruptedException &#123;</span><br><span class="line">        int threadCount = 100;</span><br><span class="line">        ExecutorService executorService = Executors.newFixedThreadPool(threadCount);</span><br><span class="line">        CountDownLatch latch = new CountDownLatch(threadCount);</span><br><span class="line">        </span><br><span class="line">        AtomicInteger successCount = new AtomicInteger(0);</span><br><span class="line">        AtomicInteger failCount = new AtomicInteger(0);</span><br><span class="line">        </span><br><span class="line">        // æŸ¥è¯¢ä¸å­˜åœ¨çš„å•†å“ID</span><br><span class="line">        Long notExistProductId = 999999999L;</span><br><span class="line">        </span><br><span class="line">        long startTime = System.currentTimeMillis();</span><br><span class="line">        </span><br><span class="line">        for (int i = 0; i &lt; threadCount; i++) &#123;</span><br><span class="line">            executorService.execute(() -&gt; &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    productService.getProductDetail(notExistProductId);</span><br><span class="line">                    successCount.incrementAndGet();</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    failCount.incrementAndGet();</span><br><span class="line">                &#125; finally &#123;</span><br><span class="line">                    latch.countDown();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        latch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        </span><br><span class="line">        long endTime = System.currentTimeMillis();</span><br><span class="line">        </span><br><span class="line">        System.out.println(&quot;==================================&quot;);</span><br><span class="line">        System.out.println(&quot;ç¼“å­˜ç©¿é€æµ‹è¯•ç»“æœï¼š&quot;);</span><br><span class="line">        System.out.println(&quot;çº¿ç¨‹æ•°ï¼š&quot; + threadCount);</span><br><span class="line">        System.out.println(&quot;æˆåŠŸæ¬¡æ•°ï¼š&quot; + successCount.get());</span><br><span class="line">        System.out.println(&quot;å¤±è´¥æ¬¡æ•°ï¼š&quot; + failCount.get());</span><br><span class="line">        System.out.println(&quot;æ€»è€—æ—¶ï¼š&quot; + (endTime - startTime) + &quot;ms&quot;);</span><br><span class="line">        System.out.println(&quot;==================================&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æµ‹è¯•ç¼“å­˜å‡»ç©¿</span><br><span class="line">     */</span><br><span class="line">    @Test</span><br><span class="line">    public void testCacheBreakdown() throws InterruptedException &#123;</span><br><span class="line">        int threadCount = 100;</span><br><span class="line">        ExecutorService executorService = Executors.newFixedThreadPool(threadCount);</span><br><span class="line">        CountDownLatch latch = new CountDownLatch(threadCount);</span><br><span class="line">        </span><br><span class="line">        AtomicInteger successCount = new AtomicInteger(0);</span><br><span class="line">        AtomicInteger failCount = new AtomicInteger(0);</span><br><span class="line">        </span><br><span class="line">        // å…ˆæ¸…é™¤ç¼“å­˜</span><br><span class="line">        Long productId = 1L;</span><br><span class="line">        redisTemplate.delete(&quot;product:detail:&quot; + productId);</span><br><span class="line">        </span><br><span class="line">        long startTime = System.currentTimeMillis();</span><br><span class="line">        </span><br><span class="line">        for (int i = 0; i &lt; threadCount; i++) &#123;</span><br><span class="line">            executorService.execute(() -&gt; &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    productService.getProductDetail(productId);</span><br><span class="line">                    successCount.incrementAndGet();</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    failCount.incrementAndGet();</span><br><span class="line">                &#125; finally &#123;</span><br><span class="line">                    latch.countDown();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        latch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        </span><br><span class="line">        long endTime = System.currentTimeMillis();</span><br><span class="line">        </span><br><span class="line">        System.out.println(&quot;==================================&quot;);</span><br><span class="line">        System.out.println(&quot;ç¼“å­˜å‡»ç©¿æµ‹è¯•ç»“æœï¼š&quot;);</span><br><span class="line">        System.out.println(&quot;çº¿ç¨‹æ•°ï¼š&quot; + threadCount);</span><br><span class="line">        System.out.println(&quot;æˆåŠŸæ¬¡æ•°ï¼š&quot; + successCount.get());</span><br><span class="line">        System.out.println(&quot;å¤±è´¥æ¬¡æ•°ï¼š&quot; + failCount.get());</span><br><span class="line">        System.out.println(&quot;æ€»è€—æ—¶ï¼š&quot; + (endTime - startTime) + &quot;ms&quot;);</span><br><span class="line">        </span><br><span class="line">        // æ£€æŸ¥æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°ï¼ˆåº”è¯¥æœ‰ä¸”ä»…æœ‰ä¸€æ¬¡ï¼‰</span><br><span class="line">        // å®é™…é¡¹ç›®ä¸­å¯ä»¥é€šè¿‡æ—¥å¿—æˆ–ç›‘æ§æ¥æŸ¥çœ‹</span><br><span class="line">        System.out.println(&quot;==================================&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æµ‹è¯•åº“å­˜æ‰£å‡å¹¶å‘</span><br><span class="line">     */</span><br><span class="line">    @Test</span><br><span class="line">    public void testReduceStockConcurrent() throws InterruptedException &#123;</span><br><span class="line">        int threadCount = 50;</span><br><span class="line">        ExecutorService executorService = Executors.newFixedThreadPool(threadCount);</span><br><span class="line">        CountDownLatch latch = new CountDownLatch(threadCount);</span><br><span class="line">        </span><br><span class="line">        AtomicInteger successCount = new AtomicInteger(0);</span><br><span class="line">        AtomicInteger failCount = new AtomicInteger(0);</span><br><span class="line">        </span><br><span class="line">        Long productId = 1L;</span><br><span class="line">        int initialStock = 100;</span><br><span class="line">        int reducePerThread = 2; // æ¯ä¸ªçº¿ç¨‹æ‰£å‡2ä¸ª</span><br><span class="line">        </span><br><span class="line">        // é‡ç½®åº“å­˜</span><br><span class="line">        // productService.resetStock(productId, initialStock);</span><br><span class="line">        </span><br><span class="line">        long startTime = System.currentTimeMillis();</span><br><span class="line">        </span><br><span class="line">        for (int i = 0; i &lt; threadCount; i++) &#123;</span><br><span class="line">            executorService.execute(() -&gt; &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    boolean success = productService.reduceStock(productId, reducePerThread);</span><br><span class="line">                    if (success) &#123;</span><br><span class="line">                        successCount.incrementAndGet();</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        failCount.incrementAndGet();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    failCount.incrementAndGet();</span><br><span class="line">                &#125; finally &#123;</span><br><span class="line">                    latch.countDown();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        latch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        </span><br><span class="line">        long endTime = System.currentTimeMillis();</span><br><span class="line">        </span><br><span class="line">        System.out.println(&quot;==================================&quot;);</span><br><span class="line">        System.out.println(&quot;åº“å­˜æ‰£å‡å¹¶å‘æµ‹è¯•ç»“æœï¼š&quot;);</span><br><span class="line">        System.out.println(&quot;çº¿ç¨‹æ•°ï¼š&quot; + threadCount);</span><br><span class="line">        System.out.println(&quot;æ¯ä¸ªçº¿ç¨‹æ‰£å‡æ•°é‡ï¼š&quot; + reducePerThread);</span><br><span class="line">        System.out.println(&quot;é¢„æœŸæ‰£å‡æ€»æ•°ï¼š&quot; + (threadCount * reducePerThread));</span><br><span class="line">        System.out.println(&quot;åˆå§‹åº“å­˜ï¼š&quot; + initialStock);</span><br><span class="line">        System.out.println(&quot;æˆåŠŸæ‰£å‡æ¬¡æ•°ï¼š&quot; + successCount.get());</span><br><span class="line">        System.out.println(&quot;å¤±è´¥æ¬¡æ•°ï¼š&quot; + failCount.get());</span><br><span class="line">        System.out.println(&quot;å®é™…æ‰£å‡æ€»æ•°ï¼š&quot; + (successCount.get() * reducePerThread));</span><br><span class="line">        System.out.println(&quot;æ€»è€—æ—¶ï¼š&quot; + (endTime - startTime) + &quot;ms&quot;);</span><br><span class="line">        System.out.println(&quot;==================================&quot;);</span><br><span class="line">        </span><br><span class="line">        // éªŒè¯æœ€ç»ˆåº“å­˜</span><br><span class="line">        // int finalStock = productService.getStock(productId);</span><br><span class="line">        // System.out.println(&quot;æœ€ç»ˆåº“å­˜ï¼š&quot; + finalStock);</span><br><span class="line">        // System.out.println(&quot;åº“å­˜æ˜¯å¦æ­£ç¡®ï¼š&quot; + (finalStock == initialStock - successCount.get() * reducePerThread));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ğŸ¯-ç¬¬ä¸‰é˜¶æ®µå®Œæˆæ€»ç»“"><a href="#ğŸ¯-ç¬¬ä¸‰é˜¶æ®µå®Œæˆæ€»ç»“" class="headerlink" title="ğŸ¯ ç¬¬ä¸‰é˜¶æ®µå®Œæˆæ€»ç»“"></a>ğŸ¯ ç¬¬ä¸‰é˜¶æ®µå®Œæˆæ€»ç»“</h2><h3 id="å·²å®ç°çš„åŠŸèƒ½ï¼š-1"><a href="#å·²å®ç°çš„åŠŸèƒ½ï¼š-1" class="headerlink" title="å·²å®ç°çš„åŠŸèƒ½ï¼š"></a>å·²å®ç°çš„åŠŸèƒ½ï¼š</h3><ol><li><strong>æ–‡ä»¶ä¸Šä¼ ä¸‹è½½</strong>ï¼š<ul><li>æ™®é€šæ–‡ä»¶ä¸Šä¼ </li><li>åˆ†ç‰‡ä¸Šä¼ ï¼ˆæ”¯æŒå¤§æ–‡ä»¶ï¼‰</li><li>æ–­ç‚¹ç»­ä¼ </li><li>æ–‡ä»¶é¢„è§ˆå’Œä¸‹è½½</li></ul></li><li><strong>å•†å“åˆ†ç±»ç®¡ç†</strong>ï¼š<ul><li>åˆ†ç±»CRUDæ“ä½œ</li><li>åˆ†ç±»æ ‘å½¢ç»“æ„</li><li>åˆ†ç±»å±‚çº§ç®¡ç†</li><li>åˆ†ç±»ç§»åŠ¨å’Œæ’åº</li></ul></li><li><strong>Redisç¼“å­˜é«˜çº§åº”ç”¨</strong>ï¼š<ul><li>ç¼“å­˜ç©¿é€è§£å†³æ–¹æ¡ˆï¼ˆå¸ƒéš†è¿‡æ»¤å™¨ + ç©ºå€¼ç¼“å­˜ï¼‰</li><li>ç¼“å­˜å‡»ç©¿è§£å†³æ–¹æ¡ˆï¼ˆåˆ†å¸ƒå¼é”ï¼‰</li><li>ç¼“å­˜é›ªå´©è§£å†³æ–¹æ¡ˆï¼ˆéšæœºè¿‡æœŸæ—¶é—´ï¼‰</li><li>æ‰¹é‡ç¼“å­˜æ“ä½œ</li><li>ç¼“å­˜é¢„çƒ­</li></ul></li><li><strong>å¹¶å‘æ§åˆ¶</strong>ï¼š<ul><li>åˆ†å¸ƒå¼é”æ§åˆ¶åº“å­˜æ‰£å‡</li><li>é«˜å¹¶å‘æµ‹è¯•ç”¨ä¾‹</li></ul></li></ol><h3 id="æŠ€æœ¯æ ˆå®è·µï¼š-1"><a href="#æŠ€æœ¯æ ˆå®è·µï¼š-1" class="headerlink" title="æŠ€æœ¯æ ˆå®è·µï¼š"></a>æŠ€æœ¯æ ˆå®è·µï¼š</h3><p>âœ… <strong>æ–‡ä»¶ä¸Šä¼ </strong>ï¼šåˆ†ç‰‡ä¸Šä¼ ã€æ–­ç‚¹ç»­ä¼ <br>âœ… <strong>æ ‘å½¢ç»“æ„</strong>ï¼šé€’å½’ç®—æ³•æ„å»ºåˆ†ç±»æ ‘<br>âœ… <strong>ç¼“å­˜ç­–ç•¥</strong>ï¼šå¤šçº§ç¼“å­˜ã€ç¼“å­˜é¢„çƒ­<br>âœ… <strong>å¹¶å‘ç¼–ç¨‹</strong>ï¼šåˆ†å¸ƒå¼é”ã€çº¿ç¨‹æ± <br>âœ… <strong>æ•°æ®åº“æ“ä½œ</strong>ï¼šMyBatis Plusé«˜çº§ç”¨æ³•<br>âœ… <strong>å¼‚å¸¸å¤„ç†</strong>ï¼šç»Ÿä¸€å¼‚å¸¸å¤„ç†æœºåˆ¶</p><h3 id="ä¸‹ä¸€æ­¥å»ºè®®ï¼š-1"><a href="#ä¸‹ä¸€æ­¥å»ºè®®ï¼š-1" class="headerlink" title="ä¸‹ä¸€æ­¥å»ºè®®ï¼š"></a>ä¸‹ä¸€æ­¥å»ºè®®ï¼š</h3><p>ç¬¬å››é˜¶æ®µæˆ‘ä»¬å°†å®ç°<strong>æœç´¢æœåŠ¡ï¼ˆElasticsearchï¼‰</strong>ï¼Œé‡ç‚¹å®è·µï¼š</p><ol><li><strong>Elasticsearché›†æˆå’Œé…ç½®</strong></li><li><strong>å•†å“æœç´¢åŠŸèƒ½</strong>ï¼ˆå…¨æ–‡æ£€ç´¢ã€æ¡ä»¶ç­›é€‰ã€æ’åºï¼‰</li><li><strong>æœç´¢å»ºè®®å’Œè‡ªåŠ¨è¡¥å…¨</strong></li><li><strong>åŒä¹‰è¯å’Œæ‹¼éŸ³æœç´¢</strong></li><li><strong>æœç´¢ç»“æœé«˜äº®æ˜¾ç¤º</strong></li></ol><p>éœ€è¦æˆ‘ç»§ç»­å®ç°æœç´¢æœåŠ¡å—ï¼Ÿè¿˜æ˜¯ä½ æƒ³å…ˆäº†è§£å…¶ä»–æ¨¡å—çš„å®ç°ï¼Ÿ</p><h1 id="ğŸ”-ç¬¬å››é˜¶æ®µï¼šæœç´¢æœåŠ¡å®ç°ï¼ˆElasticsearché›†æˆï¼‰"><a href="#ğŸ”-ç¬¬å››é˜¶æ®µï¼šæœç´¢æœåŠ¡å®ç°ï¼ˆElasticsearché›†æˆï¼‰" class="headerlink" title="ğŸ” ç¬¬å››é˜¶æ®µï¼šæœç´¢æœåŠ¡å®ç°ï¼ˆElasticsearché›†æˆï¼‰"></a>ğŸ” ç¬¬å››é˜¶æ®µï¼šæœç´¢æœåŠ¡å®ç°ï¼ˆElasticsearché›†æˆï¼‰</h1><h2 id="ç¬¬10å¤©ï¼šElasticsearché›†æˆä¸å•†å“æœç´¢åŸºç¡€"><a href="#ç¬¬10å¤©ï¼šElasticsearché›†æˆä¸å•†å“æœç´¢åŸºç¡€" class="headerlink" title="ç¬¬10å¤©ï¼šElasticsearché›†æˆä¸å•†å“æœç´¢åŸºç¡€"></a>ç¬¬10å¤©ï¼šElasticsearché›†æˆä¸å•†å“æœç´¢åŸºç¡€</h2><h3 id="1-æœç´¢æœåŠ¡é¡¹ç›®ç»“æ„"><a href="#1-æœç´¢æœåŠ¡é¡¹ç›®ç»“æ„" class="headerlink" title="1. æœç´¢æœåŠ¡é¡¹ç›®ç»“æ„"></a>1. æœç´¢æœåŠ¡é¡¹ç›®ç»“æ„</h3><p>xml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- shophub-search/pom.xml --&gt;</span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;</span><br><span class="line">         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 </span><br><span class="line">         http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;com.shophub&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;shophub-parent&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;1.0.0&lt;/version&gt;</span><br><span class="line">    &lt;/parent&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;artifactId&gt;shophub-search&lt;/artifactId&gt;</span><br><span class="line">    &lt;packaging&gt;jar&lt;/packaging&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;elasticsearch.version&gt;7.17.12&lt;/elasticsearch.version&gt;</span><br><span class="line">        &lt;spring-data-elasticsearch.version&gt;5.1.4&lt;/spring-data-elasticsearch.version&gt;</span><br><span class="line">    &lt;/properties&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;!-- Spring Boot Starter --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- Elasticsearch --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-data-elasticsearch&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- Redis --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- Nacos --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- å·¥å…·ç±» --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;commons-lang3&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- JSONå¤„ç† --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;fastjson&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;2.0.42&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- IKåˆ†è¯å™¨ --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.github.magese&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;ik-analyzer&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;8.5.0&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- æ‹¼éŸ³è½¬æ¢ --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.belerweb&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;pinyin4j&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;2.5.1&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- é€šç”¨æ¨¡å— --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.shophub&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;shophub-common&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.0.0&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- å•†å“æœåŠ¡API --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.shophub&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;shophub-product&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.0.0&lt;/version&gt;</span><br><span class="line">            &lt;scope&gt;provided&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">        &lt;/plugins&gt;</span><br><span class="line">    &lt;/build&gt;</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure><h3 id="2-Elasticsearché…ç½®"><a href="#2-Elasticsearché…ç½®" class="headerlink" title="2. Elasticsearché…ç½®"></a>2. Elasticsearché…ç½®</h3><p>yaml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"># application.yml</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: shophub-search</span><br><span class="line">  profiles:</span><br><span class="line">    active: dev</span><br><span class="line">  </span><br><span class="line">  # Elasticsearché…ç½®</span><br><span class="line">  elasticsearch:</span><br><span class="line">    uris: $&#123;ES_HOST:localhost&#125;:$&#123;ES_PORT:9200&#125;</span><br><span class="line">    username: $&#123;ES_USERNAME:elastic&#125;</span><br><span class="line">    password: $&#123;ES_PASSWORD:elastic123&#125;</span><br><span class="line">    connection-timeout: 5s</span><br><span class="line">    socket-timeout: 30s</span><br><span class="line">    </span><br><span class="line">  # Redisé…ç½®</span><br><span class="line">  redis:</span><br><span class="line">    host: $&#123;REDIS_HOST:localhost&#125;</span><br><span class="line">    port: $&#123;REDIS_PORT:6379&#125;</span><br><span class="line">    password: $&#123;REDIS_PASSWORD:redis123&#125;</span><br><span class="line">    database: 2</span><br><span class="line">    lettuce:</span><br><span class="line">      pool:</span><br><span class="line">        max-active: 20</span><br><span class="line">        max-wait: -1ms</span><br><span class="line">        max-idle: 10</span><br><span class="line">        min-idle: 0</span><br><span class="line">  </span><br><span class="line">  # Nacosé…ç½®</span><br><span class="line">  cloud:</span><br><span class="line">    nacos:</span><br><span class="line">      discovery:</span><br><span class="line">        server-addr: $&#123;NACOS_HOST:localhost&#125;:$&#123;NACOS_PORT:8848&#125;</span><br><span class="line">        namespace: public</span><br><span class="line">        group: DEFAULT_GROUP</span><br><span class="line"></span><br><span class="line"># æœç´¢æœåŠ¡é…ç½®</span><br><span class="line">search:</span><br><span class="line">  # Elasticsearchç´¢å¼•é…ç½®</span><br><span class="line">  elasticsearch:</span><br><span class="line">    index:</span><br><span class="line">      product: shophub_product</span><br><span class="line">      product_suggest: shophub_product_suggest</span><br><span class="line">      product_log: shophub_product_log</span><br><span class="line">    settings:</span><br><span class="line">      number_of_shards: 3</span><br><span class="line">      number_of_replicas: 1</span><br><span class="line">    </span><br><span class="line">  # æœç´¢é…ç½®</span><br><span class="line">  config:</span><br><span class="line">    max-search-size: 1000</span><br><span class="line">    default-page-size: 20</span><br><span class="line">    max-page-size: 100</span><br><span class="line">    highlight-pre-tag: &lt;em class=&quot;highlight&quot;&gt;</span><br><span class="line">    highlight-post-tag: &lt;/em&gt;</span><br><span class="line">    suggest-size: 10</span><br><span class="line">    max-suggest-size: 20</span><br><span class="line">    </span><br><span class="line">  # ç¼“å­˜é…ç½®</span><br><span class="line">  cache:</span><br><span class="line">    hot-keywords-ttl: 3600  # çƒ­æœè¯ç¼“å­˜1å°æ—¶</span><br><span class="line">    search-suggest-ttl: 300  # æœç´¢å»ºè®®ç¼“å­˜5åˆ†é’Ÿ</span><br><span class="line">    search-result-ttl: 60    # æœç´¢ç»“æœç¼“å­˜1åˆ†é’Ÿ</span><br><span class="line"></span><br><span class="line"># æœåŠ¡ç«¯å£</span><br><span class="line">server:</span><br><span class="line">  port: 8084</span><br><span class="line">  servlet:</span><br><span class="line">    context-path: /search</span><br><span class="line"></span><br><span class="line"># æ—¥å¿—é…ç½®</span><br><span class="line">logging:</span><br><span class="line">  level:</span><br><span class="line">    com.shophub.search: debug</span><br><span class="line">    org.springframework.data.elasticsearch: warn</span><br><span class="line">    org.elasticsearch: warn</span><br><span class="line">  pattern:</span><br><span class="line">    console: &#x27;%d&#123;yyyy-MM-dd HH:mm:ss&#125; [%thread] %-5level %logger&#123;36&#125; - %msg%n&#x27;</span><br><span class="line">  file:</span><br><span class="line">    name: logs/search-service.log</span><br><span class="line">    max-size: 10MB</span><br><span class="line">    max-history: 30</span><br><span class="line"></span><br><span class="line"># ç®¡ç†ç«¯ç‚¹</span><br><span class="line">management:</span><br><span class="line">  endpoints:</span><br><span class="line">    web:</span><br><span class="line">      exposure:</span><br><span class="line">        include: health,info,metrics,prometheus</span><br><span class="line">  endpoint:</span><br><span class="line">    health:</span><br><span class="line">      show-details: always</span><br><span class="line">      elasticsearch:</span><br><span class="line">        enabled: true</span><br></pre></td></tr></table></figure><h3 id="3-Elasticsearché…ç½®ç±»"><a href="#3-Elasticsearché…ç½®ç±»" class="headerlink" title="3. Elasticsearché…ç½®ç±»"></a>3. Elasticsearché…ç½®ç±»</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.search.config;</span><br><span class="line"></span><br><span class="line">import org.apache.http.HttpHost;</span><br><span class="line">import org.apache.http.auth.AuthScope;</span><br><span class="line">import org.apache.http.auth.UsernamePasswordCredentials;</span><br><span class="line">import org.apache.http.client.CredentialsProvider;</span><br><span class="line">import org.apache.http.impl.client.BasicCredentialsProvider;</span><br><span class="line">import org.elasticsearch.client.RestClient;</span><br><span class="line">import org.elasticsearch.client.RestClientBuilder;</span><br><span class="line">import org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line">import org.springframework.beans.factory.annotation.Value;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.data.elasticsearch.client.ClientConfiguration;</span><br><span class="line">import org.springframework.data.elasticsearch.client.RestClients;</span><br><span class="line">import org.springframework.data.elasticsearch.config.AbstractElasticsearchConfiguration;</span><br><span class="line">import org.springframework.data.elasticsearch.core.ElasticsearchRestTemplate;</span><br><span class="line">import org.springframework.data.elasticsearch.core.convert.ElasticsearchConverter;</span><br><span class="line"></span><br><span class="line">import java.time.Duration;</span><br><span class="line"></span><br><span class="line">@Configuration</span><br><span class="line">public class ElasticsearchConfig extends AbstractElasticsearchConfiguration &#123;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;spring.elasticsearch.uris&#125;&quot;)</span><br><span class="line">    private String[] uris;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;spring.elasticsearch.username&#125;&quot;)</span><br><span class="line">    private String username;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;spring.elasticsearch.password&#125;&quot;)</span><br><span class="line">    private String password;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;spring.elasticsearch.connection-timeout&#125;&quot;)</span><br><span class="line">    private String connectionTimeout;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;spring.elasticsearch.socket-timeout&#125;&quot;)</span><br><span class="line">    private String socketTimeout;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    @Bean</span><br><span class="line">    public RestHighLevelClient elasticsearchClient() &#123;</span><br><span class="line">        // ä½¿ç”¨å¸¦è®¤è¯çš„å®¢æˆ·ç«¯é…ç½®</span><br><span class="line">        ClientConfiguration clientConfiguration = ClientConfiguration.builder()</span><br><span class="line">                .connectedTo(uris)</span><br><span class="line">                .usingSsl()  // å¦‚æœä½¿ç”¨HTTPS</span><br><span class="line">                .withBasicAuth(username, password)</span><br><span class="line">                .withConnectTimeout(Duration.parse(connectionTimeout))</span><br><span class="line">                .withSocketTimeout(Duration.parse(socketTimeout))</span><br><span class="line">                .build();</span><br><span class="line">        </span><br><span class="line">        return RestClients.create(clientConfiguration).rest();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è‡ªå®šä¹‰ElasticsearchRestTemplate</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public ElasticsearchRestTemplate elasticsearchRestTemplate(</span><br><span class="line">            RestHighLevelClient client, </span><br><span class="line">            ElasticsearchConverter converter) &#123;</span><br><span class="line">        return new ElasticsearchRestTemplate(client, converter);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆ›å»ºä½çº§å®¢æˆ·ç«¯ï¼ˆç”¨äºä¸€äº›é«˜çº§æ“ä½œï¼‰</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public RestClient restClient() &#123;</span><br><span class="line">        // è§£æURI</span><br><span class="line">        HttpHost[] httpHosts = new HttpHost[uris.length];</span><br><span class="line">        for (int i = 0; i &lt; uris.length; i++) &#123;</span><br><span class="line">            String[] parts = uris[i].split(&quot;:&quot;);</span><br><span class="line">            httpHosts[i] = new HttpHost(parts[0], Integer.parseInt(parts[1]), &quot;http&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // åˆ›å»ºå‡­è¯æä¾›è€…</span><br><span class="line">        final CredentialsProvider credentialsProvider = new BasicCredentialsProvider();</span><br><span class="line">        credentialsProvider.setCredentials(</span><br><span class="line">            AuthScope.ANY,</span><br><span class="line">            new UsernamePasswordCredentials(username, password)</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        // æ„å»ºRestClient</span><br><span class="line">        RestClientBuilder builder = RestClient.builder(httpHosts)</span><br><span class="line">                .setHttpClientConfigCallback(httpClientBuilder -&gt; </span><br><span class="line">                    httpClientBuilder.setDefaultCredentialsProvider(credentialsProvider)</span><br><span class="line">                );</span><br><span class="line">        </span><br><span class="line">        return builder.build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// IKåˆ†è¯å™¨é…ç½®</span><br><span class="line">@Component</span><br><span class="line">class IKAnalyzerConfig &#123;</span><br><span class="line">    </span><br><span class="line">    @Bean</span><br><span class="line">    public IKAnalyzer ikAnalyzer() &#123;</span><br><span class="line">        return new IKAnalyzer();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Bean</span><br><span class="line">    public IKAnalyzer ikMaxWordAnalyzer() &#123;</span><br><span class="line">        return new IKAnalyzer(IKAnalyzer.IK_MAX_WORD);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Bean</span><br><span class="line">    public IKAnalyzer ikSmartAnalyzer() &#123;</span><br><span class="line">        return new IKAnalyzer(IKAnalyzer.IK_SMART);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-å•†å“æ–‡æ¡£å®ä½“ç±»"><a href="#4-å•†å“æ–‡æ¡£å®ä½“ç±»" class="headerlink" title="4. å•†å“æ–‡æ¡£å®ä½“ç±»"></a>4. å•†å“æ–‡æ¡£å®ä½“ç±»</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.search.document;</span><br><span class="line"></span><br><span class="line">import lombok.Data;</span><br><span class="line">import lombok.EqualsAndHashCode;</span><br><span class="line">import org.springframework.data.annotation.Id;</span><br><span class="line">import org.springframework.data.elasticsearch.annotations.*;</span><br><span class="line"></span><br><span class="line">import java.math.BigDecimal;</span><br><span class="line">import java.time.LocalDateTime;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * å•†å“æœç´¢æ–‡æ¡£</span><br><span class="line"> */</span><br><span class="line">@Data</span><br><span class="line">@EqualsAndHashCode(callSuper = false)</span><br><span class="line">@Document(indexName = &quot;#&#123;@elasticsearchIndexConfig.productIndex&#125;&quot;)</span><br><span class="line">@Setting(settingPath = &quot;/elasticsearch/product-settings.json&quot;)</span><br><span class="line">@Mapping(mappingPath = &quot;/elasticsearch/product-mappings.json&quot;)</span><br><span class="line">public class ProductDocument &#123;</span><br><span class="line">    </span><br><span class="line">    @Id</span><br><span class="line">    @Field(type = FieldType.Long)</span><br><span class="line">    private Long id;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å•†å“ç¼–å·</span><br><span class="line">     */</span><br><span class="line">    @MultiField(</span><br><span class="line">        mainField = @Field(type = FieldType.Keyword),</span><br><span class="line">        otherFields = &#123;</span><br><span class="line">            @InnerField(suffix = &quot;pinyin&quot;, type = FieldType.Text, analyzer = &quot;pinyin_analyzer&quot;)</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line">    private String productNo;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å•†å“åç§° - ä½¿ç”¨IKåˆ†è¯å™¨</span><br><span class="line">     */</span><br><span class="line">    @MultiField(</span><br><span class="line">        mainField = @Field(type = FieldType.Text, </span><br><span class="line">                          analyzer = &quot;ik_max_word&quot;, </span><br><span class="line">                          searchAnalyzer = &quot;ik_smart&quot;,</span><br><span class="line">                          copyTo = &quot;combined&quot;),</span><br><span class="line">        otherFields = &#123;</span><br><span class="line">            @InnerField(suffix = &quot;pinyin&quot;, type = FieldType.Text, analyzer = &quot;pinyin_analyzer&quot;),</span><br><span class="line">            @InnerField(suffix = &quot;keyword&quot;, type = FieldType.Keyword, ignoreAbove = 256)</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line">    private String productName;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆ†ç±»ID</span><br><span class="line">     */</span><br><span class="line">    @Field(type = FieldType.Long)</span><br><span class="line">    private Long categoryId;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆ†ç±»åç§°</span><br><span class="line">     */</span><br><span class="line">    @Field(type = FieldType.Text, analyzer = &quot;ik_max_word&quot;, searchAnalyzer = &quot;ik_smart&quot;)</span><br><span class="line">    private String categoryName;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆ†ç±»è·¯å¾„ï¼ˆç”¨äºå¿«é€Ÿç­›é€‰ï¼‰</span><br><span class="line">     */</span><br><span class="line">    @Field(type = FieldType.Keyword)</span><br><span class="line">    private List&lt;String&gt; categoryPath;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å“ç‰Œ</span><br><span class="line">     */</span><br><span class="line">    @MultiField(</span><br><span class="line">        mainField = @Field(type = FieldType.Keyword),</span><br><span class="line">        otherFields = &#123;</span><br><span class="line">            @InnerField(suffix = &quot;pinyin&quot;, type = FieldType.Text, analyzer = &quot;pinyin_analyzer&quot;)</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line">    private String brand;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * é”€å”®ä»·æ ¼</span><br><span class="line">     */</span><br><span class="line">    @Field(type = FieldType.Double)</span><br><span class="line">    private BigDecimal price;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å¸‚åœºä»·æ ¼</span><br><span class="line">     */</span><br><span class="line">    @Field(type = FieldType.Double)</span><br><span class="line">    private BigDecimal marketPrice;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åº“å­˜</span><br><span class="line">     */</span><br><span class="line">    @Field(type = FieldType.Integer)</span><br><span class="line">    private Integer stock;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * é”€é‡</span><br><span class="line">     */</span><br><span class="line">    @Field(type = FieldType.Integer)</span><br><span class="line">    private Integer saleCount;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * ä¸»å›¾</span><br><span class="line">     */</span><br><span class="line">    @Field(type = FieldType.Keyword, index = false)</span><br><span class="line">    private String mainImage;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å­å›¾åˆ—è¡¨</span><br><span class="line">     */</span><br><span class="line">    @Field(type = FieldType.Keyword, index = false)</span><br><span class="line">    private List&lt;String&gt; subImages;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å•†å“è¯¦æƒ…ï¼ˆç”¨äºæœç´¢ä½†ä¸å±•ç¤ºï¼‰</span><br><span class="line">     */</span><br><span class="line">    @Field(type = FieldType.Text, analyzer = &quot;ik_max_word&quot;, searchAnalyzer = &quot;ik_smart&quot;)</span><br><span class="line">    private String detail;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * çŠ¶æ€ï¼š1-ä¸Šæ¶ï¼Œ0-ä¸‹æ¶</span><br><span class="line">     */</span><br><span class="line">    @Field(type = FieldType.Integer)</span><br><span class="line">    private Integer status;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ˜¯å¦çƒ­é”€</span><br><span class="line">     */</span><br><span class="line">    @Field(type = FieldType.Boolean)</span><br><span class="line">    private Boolean isHot;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ˜¯å¦æ–°å“</span><br><span class="line">     */</span><br><span class="line">    @Field(type = FieldType.Boolean)</span><br><span class="line">    private Boolean isNew;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å•†å“æ ‡ç­¾</span><br><span class="line">     */</span><br><span class="line">    @Field(type = FieldType.Keyword)</span><br><span class="line">    private List&lt;String&gt; tags;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è§„æ ¼å±æ€§ï¼ˆç”¨äºç­›é€‰ï¼‰</span><br><span class="line">     */</span><br><span class="line">    @Field(type = FieldType.Nested)</span><br><span class="line">    private List&lt;ProductSpec&gt; specs;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆ›å»ºæ—¶é—´</span><br><span class="line">     */</span><br><span class="line">    @Field(type = FieldType.Date, format = DateFormat.date_hour_minute_second)</span><br><span class="line">    private LocalDateTime createTime;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ›´æ–°æ—¶é—´</span><br><span class="line">     */</span><br><span class="line">    @Field(type = FieldType.Date, format = DateFormat.date_hour_minute_second)</span><br><span class="line">    private LocalDateTime updateTime;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è¯„åˆ†ï¼ˆç”¨äºæ’åºï¼‰</span><br><span class="line">     */</span><br><span class="line">    @Field(type = FieldType.Double)</span><br><span class="line">    private Double score;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æœç´¢å…³é”®è¯ç»„åˆå­—æ®µï¼ˆcopy_toå­—æ®µï¼‰</span><br><span class="line">     */</span><br><span class="line">    @Field(type = FieldType.Text, analyzer = &quot;ik_max_word&quot;, searchAnalyzer = &quot;ik_smart&quot;)</span><br><span class="line">    private String combined;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å•†å“è§„æ ¼</span><br><span class="line">     */</span><br><span class="line">    @Data</span><br><span class="line">    @EqualsAndHashCode(callSuper = false)</span><br><span class="line">    public static class ProductSpec &#123;</span><br><span class="line">        @Field(type = FieldType.Keyword)</span><br><span class="line">        private String name;</span><br><span class="line">        </span><br><span class="line">        @Field(type = FieldType.Keyword)</span><br><span class="line">        private String value;</span><br><span class="line">        </span><br><span class="line">        @Field(type = FieldType.Double)</span><br><span class="line">        private BigDecimal extraPrice;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æœç´¢å»ºè®®æ–‡æ¡£</span><br><span class="line">@Data</span><br><span class="line">@EqualsAndHashCode(callSuper = false)</span><br><span class="line">@Document(indexName = &quot;#&#123;@elasticsearchIndexConfig.productSuggestIndex&#125;&quot;)</span><br><span class="line">public class ProductSuggestDocument &#123;</span><br><span class="line">    </span><br><span class="line">    @Id</span><br><span class="line">    private String id;</span><br><span class="line">    </span><br><span class="line">    @CompletionField(maxInputLength = 100)</span><br><span class="line">    private Completion suggest;</span><br><span class="line">    </span><br><span class="line">    @Field(type = FieldType.Text, analyzer = &quot;ik_max_word&quot;)</span><br><span class="line">    private String keyword;</span><br><span class="line">    </span><br><span class="line">    @Field(type = FieldType.Integer)</span><br><span class="line">    private Integer searchCount;</span><br><span class="line">    </span><br><span class="line">    @Field(type = FieldType.Date)</span><br><span class="line">    private LocalDateTime lastSearchTime;</span><br><span class="line">    </span><br><span class="line">    @Field(type = FieldType.Keyword)</span><br><span class="line">    private String type;  // product, category, brand</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æœç´¢æ—¥å¿—æ–‡æ¡£</span><br><span class="line">@Data</span><br><span class="line">@EqualsAndHashCode(callSuper = false)</span><br><span class="line">@Document(indexName = &quot;#&#123;@elasticsearchIndexConfig.productLogIndex&#125;&quot;)</span><br><span class="line">public class ProductSearchLog &#123;</span><br><span class="line">    </span><br><span class="line">    @Id</span><br><span class="line">    private String id;</span><br><span class="line">    </span><br><span class="line">    @Field(type = FieldType.Keyword)</span><br><span class="line">    private String sessionId;</span><br><span class="line">    </span><br><span class="line">    @Field(type = FieldType.Long)</span><br><span class="line">    private Long userId;</span><br><span class="line">    </span><br><span class="line">    @Field(type = FieldType.Text, analyzer = &quot;ik_max_word&quot;)</span><br><span class="line">    private String keyword;</span><br><span class="line">    </span><br><span class="line">    @Field(type = FieldType.Integer)</span><br><span class="line">    private Integer resultCount;</span><br><span class="line">    </span><br><span class="line">    @Field(type = FieldType.Double)</span><br><span class="line">    private Double tookTime;</span><br><span class="line">    </span><br><span class="line">    @Field(type = FieldType.Keyword)</span><br><span class="line">    private String searchType;  // keyword, category, filter</span><br><span class="line">    </span><br><span class="line">    @Field(type = FieldType.Object)</span><br><span class="line">    private SearchFilter filters;</span><br><span class="line">    </span><br><span class="line">    @Field(type = FieldType.Date)</span><br><span class="line">    private LocalDateTime searchTime;</span><br><span class="line">    </span><br><span class="line">    @Field(type = FieldType.Keyword)</span><br><span class="line">    private String userAgent;</span><br><span class="line">    </span><br><span class="line">    @Field(type = FieldType.Keyword)</span><br><span class="line">    private String ip;</span><br><span class="line">    </span><br><span class="line">    @Data</span><br><span class="line">    public static class SearchFilter &#123;</span><br><span class="line">        private List&lt;Long&gt; categoryIds;</span><br><span class="line">        private BigDecimal minPrice;</span><br><span class="line">        private BigDecimal maxPrice;</span><br><span class="line">        private List&lt;String&gt; brands;</span><br><span class="line">        private Boolean isHot;</span><br><span class="line">        private Boolean isNew;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-Elasticsearchç´¢å¼•é…ç½®"><a href="#5-Elasticsearchç´¢å¼•é…ç½®" class="headerlink" title="5. Elasticsearchç´¢å¼•é…ç½®"></a>5. Elasticsearchç´¢å¼•é…ç½®</h3><p>json</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- resources/elasticsearch/product-settings.json --&gt;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analysis&quot;: &#123;</span><br><span class="line">    &quot;analyzer&quot;: &#123;</span><br><span class="line">      &quot;ik_max_word&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;custom&quot;,</span><br><span class="line">        &quot;tokenizer&quot;: &quot;ik_max_word&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;ik_smart&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;custom&quot;,</span><br><span class="line">        &quot;tokenizer&quot;: &quot;ik_smart&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;pinyin_analyzer&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;custom&quot;,</span><br><span class="line">        &quot;tokenizer&quot;: &quot;my_pinyin&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;tokenizer&quot;: &#123;</span><br><span class="line">      &quot;my_pinyin&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;pinyin&quot;,</span><br><span class="line">        &quot;keep_separate_first_letter&quot;: false,</span><br><span class="line">        &quot;keep_full_pinyin&quot;: true,</span><br><span class="line">        &quot;keep_original&quot;: true,</span><br><span class="line">        &quot;limit_first_letter_length&quot;: 16,</span><br><span class="line">        &quot;lowercase&quot;: true,</span><br><span class="line">        &quot;remove_duplicated_term&quot;: true</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;number_of_shards&quot;: 3,</span><br><span class="line">  &quot;number_of_replicas&quot;: 1,</span><br><span class="line">  &quot;max_result_window&quot;: 10000,</span><br><span class="line">  &quot;refresh_interval&quot;: &quot;30s&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;!-- resources/elasticsearch/product-mappings.json --&gt;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;properties&quot;: &#123;</span><br><span class="line">    &quot;combined&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">      &quot;analyzer&quot;: &quot;ik_max_word&quot;,</span><br><span class="line">      &quot;search_analyzer&quot;: &quot;ik_smart&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;dynamic_templates&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;strings_as_keywords&quot;: &#123;</span><br><span class="line">        &quot;match_mapping_type&quot;: &quot;string&quot;,</span><br><span class="line">        &quot;mapping&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-ç´¢å¼•é…ç½®ç®¡ç†ç±»"><a href="#6-ç´¢å¼•é…ç½®ç®¡ç†ç±»" class="headerlink" title="6. ç´¢å¼•é…ç½®ç®¡ç†ç±»"></a>6. ç´¢å¼•é…ç½®ç®¡ç†ç±»</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.search.config;</span><br><span class="line"></span><br><span class="line">import lombok.Data;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.elasticsearch.action.admin.indices.alias.IndicesAliasesRequest;</span><br><span class="line">import org.elasticsearch.action.admin.indices.alias.get.GetAliasesRequest;</span><br><span class="line">import org.elasticsearch.action.admin.indices.delete.DeleteIndexRequest;</span><br><span class="line">import org.elasticsearch.action.support.master.AcknowledgedResponse;</span><br><span class="line">import org.elasticsearch.client.GetAliasesResponse;</span><br><span class="line">import org.elasticsearch.client.RequestOptions;</span><br><span class="line">import org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line">import org.elasticsearch.client.indices.*;</span><br><span class="line">import org.elasticsearch.cluster.metadata.AliasMetadata;</span><br><span class="line">import org.springframework.beans.factory.annotation.Value;</span><br><span class="line">import org.springframework.boot.context.event.ApplicationReadyEvent;</span><br><span class="line">import org.springframework.context.event.EventListener;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line">import javax.annotation.Resource;</span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.util.*;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@Component</span><br><span class="line">@Data</span><br><span class="line">public class ElasticsearchIndexConfig &#123;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;search.elasticsearch.index.product&#125;&quot;)</span><br><span class="line">    private String productIndex;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;search.elasticsearch.index.product_suggest&#125;&quot;)</span><br><span class="line">    private String productSuggestIndex;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;search.elasticsearch.index.product_log&#125;&quot;)</span><br><span class="line">    private String productLogIndex;</span><br><span class="line">    </span><br><span class="line">    @Resource</span><br><span class="line">    private RestHighLevelClient restHighLevelClient;</span><br><span class="line">    </span><br><span class="line">    @Resource</span><br><span class="line">    private ElasticsearchRestTemplate elasticsearchRestTemplate;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åº”ç”¨å¯åŠ¨æ—¶æ£€æŸ¥å¹¶åˆ›å»ºç´¢å¼•</span><br><span class="line">     */</span><br><span class="line">    @EventListener(ApplicationReadyEvent.class)</span><br><span class="line">    public void initIndices() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            // æ£€æŸ¥å¹¶åˆ›å»ºå•†å“ç´¢å¼•</span><br><span class="line">            if (!indexExists(productIndex)) &#123;</span><br><span class="line">                createProductIndex();</span><br><span class="line">                log.info(&quot;åˆ›å»ºå•†å“ç´¢å¼•æˆåŠŸï¼š&#123;&#125;&quot;, productIndex);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                log.info(&quot;å•†å“ç´¢å¼•å·²å­˜åœ¨ï¼š&#123;&#125;&quot;, productIndex);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // æ£€æŸ¥å¹¶åˆ›å»ºæœç´¢å»ºè®®ç´¢å¼•</span><br><span class="line">            if (!indexExists(productSuggestIndex)) &#123;</span><br><span class="line">                createSuggestIndex();</span><br><span class="line">                log.info(&quot;åˆ›å»ºæœç´¢å»ºè®®ç´¢å¼•æˆåŠŸï¼š&#123;&#125;&quot;, productSuggestIndex);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                log.info(&quot;æœç´¢å»ºè®®ç´¢å¼•å·²å­˜åœ¨ï¼š&#123;&#125;&quot;, productSuggestIndex);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // æ£€æŸ¥å¹¶åˆ›å»ºæœç´¢æ—¥å¿—ç´¢å¼•</span><br><span class="line">            if (!indexExists(productLogIndex)) &#123;</span><br><span class="line">                createSearchLogIndex();</span><br><span class="line">                log.info(&quot;åˆ›å»ºæœç´¢æ—¥å¿—ç´¢å¼•æˆåŠŸï¼š&#123;&#125;&quot;, productLogIndex);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                log.info(&quot;æœç´¢æ—¥å¿—ç´¢å¼•å·²å­˜åœ¨ï¼š&#123;&#125;&quot;, productLogIndex);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // åˆ›å»ºç´¢å¼•åˆ«å</span><br><span class="line">            createIndexAliases();</span><br><span class="line">            </span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            log.error(&quot;åˆå§‹åŒ–Elasticsearchç´¢å¼•å¤±è´¥&quot;, e);</span><br><span class="line">            throw new RuntimeException(&quot;åˆå§‹åŒ–Elasticsearchç´¢å¼•å¤±è´¥&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ£€æŸ¥ç´¢å¼•æ˜¯å¦å­˜åœ¨</span><br><span class="line">     */</span><br><span class="line">    public boolean indexExists(String indexName) throws IOException &#123;</span><br><span class="line">        GetIndexRequest request = new GetIndexRequest(indexName);</span><br><span class="line">        return restHighLevelClient.indices().exists(request, RequestOptions.DEFAULT);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆ›å»ºå•†å“ç´¢å¼•</span><br><span class="line">     */</span><br><span class="line">    private void createProductIndex() throws IOException &#123;</span><br><span class="line">        CreateIndexRequest request = new CreateIndexRequest(productIndex);</span><br><span class="line">        </span><br><span class="line">        // åŠ è½½ç´¢å¼•è®¾ç½®</span><br><span class="line">        request.settings(Settings.builder()</span><br><span class="line">                .loadFromSource(getIndexSettings(&quot;product&quot;), org.elasticsearch.common.xcontent.XContentType.JSON)</span><br><span class="line">                .build());</span><br><span class="line">        </span><br><span class="line">        // åŠ è½½æ˜ å°„é…ç½®</span><br><span class="line">        request.mapping(getIndexMappings(&quot;product&quot;), org.elasticsearch.common.xcontent.XContentType.JSON);</span><br><span class="line">        </span><br><span class="line">        // æ·»åŠ åˆ«å</span><br><span class="line">        request.alias(new Alias(productIndex + &quot;_alias&quot;));</span><br><span class="line">        </span><br><span class="line">        CreateIndexResponse response = restHighLevelClient.indices().create(request, RequestOptions.DEFAULT);</span><br><span class="line">        if (!response.isAcknowledged()) &#123;</span><br><span class="line">            throw new IOException(&quot;åˆ›å»ºç´¢å¼•å¤±è´¥ï¼š&quot; + productIndex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆ›å»ºæœç´¢å»ºè®®ç´¢å¼•</span><br><span class="line">     */</span><br><span class="line">    private void createSuggestIndex() throws IOException &#123;</span><br><span class="line">        CreateIndexRequest request = new CreateIndexRequest(productSuggestIndex);</span><br><span class="line">        </span><br><span class="line">        // ç®€å•è®¾ç½®</span><br><span class="line">        request.settings(Settings.builder()</span><br><span class="line">                .put(&quot;number_of_shards&quot;, 1)</span><br><span class="line">                .put(&quot;number_of_replicas&quot;, 0)</span><br><span class="line">                .put(&quot;max_result_window&quot;, 10000)</span><br><span class="line">                .build());</span><br><span class="line">        </span><br><span class="line">        // æ˜ å°„é…ç½®</span><br><span class="line">        String mapping = &quot;&quot;&quot;</span><br><span class="line">            &#123;</span><br><span class="line">              &quot;properties&quot;: &#123;</span><br><span class="line">                &quot;suggest&quot;: &#123;</span><br><span class="line">                  &quot;type&quot;: &quot;completion&quot;,</span><br><span class="line">                  &quot;analyzer&quot;: &quot;ik_max_word&quot;,</span><br><span class="line">                  &quot;search_analyzer&quot;: &quot;ik_smart&quot;,</span><br><span class="line">                  &quot;preserve_separators&quot;: false,</span><br><span class="line">                  &quot;preserve_position_increments&quot;: true,</span><br><span class="line">                  &quot;max_input_length&quot;: 50</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;keyword&quot;: &#123;</span><br><span class="line">                  &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">                  &quot;analyzer&quot;: &quot;ik_max_word&quot;,</span><br><span class="line">                  &quot;fields&quot;: &#123;</span><br><span class="line">                    &quot;keyword&quot;: &#123;</span><br><span class="line">                      &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                      &quot;ignore_above&quot;: 256</span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;searchCount&quot;: &#123;</span><br><span class="line">                  &quot;type&quot;: &quot;integer&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;lastSearchTime&quot;: &#123;</span><br><span class="line">                  &quot;type&quot;: &quot;date&quot;,</span><br><span class="line">                  &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss||epoch_millis&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;type&quot;: &#123;</span><br><span class="line">                  &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            &quot;&quot;&quot;;</span><br><span class="line">        </span><br><span class="line">        request.mapping(mapping, org.elasticsearch.common.xcontent.XContentType.JSON);</span><br><span class="line">        </span><br><span class="line">        CreateIndexResponse response = restHighLevelClient.indices().create(request, RequestOptions.DEFAULT);</span><br><span class="line">        if (!response.isAcknowledged()) &#123;</span><br><span class="line">            throw new IOException(&quot;åˆ›å»ºç´¢å¼•å¤±è´¥ï¼š&quot; + productSuggestIndex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆ›å»ºæœç´¢æ—¥å¿—ç´¢å¼•</span><br><span class="line">     */</span><br><span class="line">    private void createSearchLogIndex() throws IOException &#123;</span><br><span class="line">        CreateIndexRequest request = new CreateIndexRequest(productLogIndex);</span><br><span class="line">        </span><br><span class="line">        // æŒ‰å¤©åˆ†ç‰‡çš„è®¾ç½®</span><br><span class="line">        request.settings(Settings.builder()</span><br><span class="line">                .put(&quot;number_of_shards&quot;, 3)</span><br><span class="line">                .put(&quot;number_of_replicas&quot;, 1)</span><br><span class="line">                .put(&quot;max_result_window&quot;, 10000)</span><br><span class="line">                .build());</span><br><span class="line">        </span><br><span class="line">        // æ˜ å°„é…ç½®</span><br><span class="line">        String mapping = &quot;&quot;&quot;</span><br><span class="line">            &#123;</span><br><span class="line">              &quot;properties&quot;: &#123;</span><br><span class="line">                &quot;sessionId&quot;: &#123;</span><br><span class="line">                  &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;userId&quot;: &#123;</span><br><span class="line">                  &quot;type&quot;: &quot;long&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;keyword&quot;: &#123;</span><br><span class="line">                  &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">                  &quot;analyzer&quot;: &quot;ik_max_word&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;resultCount&quot;: &#123;</span><br><span class="line">                  &quot;type&quot;: &quot;integer&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;tookTime&quot;: &#123;</span><br><span class="line">                  &quot;type&quot;: &quot;double&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;searchType&quot;: &#123;</span><br><span class="line">                  &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;filters&quot;: &#123;</span><br><span class="line">                  &quot;type&quot;: &quot;object&quot;,</span><br><span class="line">                  &quot;properties&quot;: &#123;</span><br><span class="line">                    &quot;categoryIds&quot;: &#123;</span><br><span class="line">                      &quot;type&quot;: &quot;long&quot;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &quot;minPrice&quot;: &#123;</span><br><span class="line">                      &quot;type&quot;: &quot;double&quot;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &quot;maxPrice&quot;: &#123;</span><br><span class="line">                      &quot;type&quot;: &quot;double&quot;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &quot;brands&quot;: &#123;</span><br><span class="line">                      &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &quot;isHot&quot;: &#123;</span><br><span class="line">                      &quot;type&quot;: &quot;boolean&quot;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &quot;isNew&quot;: &#123;</span><br><span class="line">                      &quot;type&quot;: &quot;boolean&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;searchTime&quot;: &#123;</span><br><span class="line">                  &quot;type&quot;: &quot;date&quot;,</span><br><span class="line">                  &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss||epoch_millis&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;userAgent&quot;: &#123;</span><br><span class="line">                  &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                  &quot;index&quot;: false</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;ip&quot;: &#123;</span><br><span class="line">                  &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                  &quot;index&quot;: false</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            &quot;&quot;&quot;;</span><br><span class="line">        </span><br><span class="line">        request.mapping(mapping, org.elasticsearch.common.xcontent.XContentType.JSON);</span><br><span class="line">        </span><br><span class="line">        CreateIndexResponse response = restHighLevelClient.indices().create(request, RequestOptions.DEFAULT);</span><br><span class="line">        if (!response.isAcknowledged()) &#123;</span><br><span class="line">            throw new IOException(&quot;åˆ›å»ºç´¢å¼•å¤±è´¥ï¼š&quot; + productLogIndex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆ›å»ºç´¢å¼•åˆ«å</span><br><span class="line">     */</span><br><span class="line">    private void createIndexAliases() throws IOException &#123;</span><br><span class="line">        IndicesAliasesRequest request = new IndicesAliasesRequest();</span><br><span class="line">        </span><br><span class="line">        // å•†å“ç´¢å¼•åˆ«å</span><br><span class="line">        IndicesAliasesRequest.AliasActions aliasAction = </span><br><span class="line">            new IndicesAliasesRequest.AliasActions(IndicesAliasesRequest.AliasActions.Type.ADD)</span><br><span class="line">                .index(productIndex)</span><br><span class="line">                .alias(productIndex + &quot;_alias&quot;);</span><br><span class="line">        request.addAliasAction(aliasAction);</span><br><span class="line">        </span><br><span class="line">        AcknowledgedResponse response = restHighLevelClient.indices().updateAliases(request, RequestOptions.DEFAULT);</span><br><span class="line">        if (!response.isAcknowledged()) &#123;</span><br><span class="line">            log.warn(&quot;åˆ›å»ºç´¢å¼•åˆ«åå¤±è´¥&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * é‡æ–°ç´¢å¼•æ•°æ®ï¼ˆç”¨äºç´¢å¼•ç»“æ„å˜æ›´ï¼‰</span><br><span class="line">     */</span><br><span class="line">    public boolean reindex(String sourceIndex, String destIndex) throws IOException &#123;</span><br><span class="line">        // åˆ›å»ºæ–°çš„ç´¢å¼•</span><br><span class="line">        CreateIndexRequest createRequest = new CreateIndexRequest(destIndex);</span><br><span class="line">        // ... å¤åˆ¶åŸç´¢å¼•çš„è®¾ç½®å’Œæ˜ å°„</span><br><span class="line">        </span><br><span class="line">        // æ‰§è¡Œreindexæ“ä½œ</span><br><span class="line">        org.elasticsearch.client.core.ReindexRequest reindexRequest = </span><br><span class="line">            new org.elasticsearch.client.core.ReindexRequest();</span><br><span class="line">        reindexRequest.setSourceIndices(sourceIndex);</span><br><span class="line">        reindexRequest.setDestIndex(destIndex);</span><br><span class="line">        </span><br><span class="line">        // è®¾ç½®å†²çªå¤„ç†ç­–ç•¥</span><br><span class="line">        reindexRequest.setDestOpType(&quot;create&quot;);</span><br><span class="line">        reindexRequest.setConflicts(&quot;proceed&quot;);</span><br><span class="line">        </span><br><span class="line">        org.elasticsearch.tasks.TaskSubmissionResponse response = </span><br><span class="line">            restHighLevelClient.submitReindexTask(reindexRequest, RequestOptions.DEFAULT);</span><br><span class="line">        </span><br><span class="line">        log.info(&quot;å¼€å§‹é‡æ–°ç´¢å¼•ï¼š&#123;&#125; -&gt; &#123;&#125;ï¼Œä»»åŠ¡IDï¼š&#123;&#125;&quot;, </span><br><span class="line">                sourceIndex, destIndex, response.getTask());</span><br><span class="line">        </span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆ é™¤ç´¢å¼•</span><br><span class="line">     */</span><br><span class="line">    public boolean deleteIndex(String indexName) throws IOException &#123;</span><br><span class="line">        if (!indexExists(indexName)) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        DeleteIndexRequest request = new DeleteIndexRequest(indexName);</span><br><span class="line">        AcknowledgedResponse response = restHighLevelClient.indices().delete(request, RequestOptions.DEFAULT);</span><br><span class="line">        return response.isAcknowledged();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è·å–ç´¢å¼•è®¾ç½®</span><br><span class="line">     */</span><br><span class="line">    private String getIndexSettings(String indexType) &#123;</span><br><span class="line">        // è¿™é‡Œå¯ä»¥ä»æ–‡ä»¶åŠ è½½æˆ–è¿”å›ç¡¬ç¼–ç çš„è®¾ç½®</span><br><span class="line">        return &quot;&quot;&quot;</span><br><span class="line">            &#123;</span><br><span class="line">              &quot;analysis&quot;: &#123;</span><br><span class="line">                &quot;analyzer&quot;: &#123;</span><br><span class="line">                  &quot;ik_max_word&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;custom&quot;,</span><br><span class="line">                    &quot;tokenizer&quot;: &quot;ik_max_word&quot;</span><br><span class="line">                  &#125;,</span><br><span class="line">                  &quot;ik_smart&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;custom&quot;,</span><br><span class="line">                    &quot;tokenizer&quot;: &quot;ik_smart&quot;</span><br><span class="line">                  &#125;,</span><br><span class="line">                  &quot;pinyin_analyzer&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;custom&quot;,</span><br><span class="line">                    &quot;tokenizer&quot;: &quot;my_pinyin&quot;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;tokenizer&quot;: &#123;</span><br><span class="line">                  &quot;my_pinyin&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;pinyin&quot;,</span><br><span class="line">                    &quot;keep_separate_first_letter&quot;: false,</span><br><span class="line">                    &quot;keep_full_pinyin&quot;: true,</span><br><span class="line">                    &quot;keep_original&quot;: true,</span><br><span class="line">                    &quot;limit_first_letter_length&quot;: 16,</span><br><span class="line">                    &quot;lowercase&quot;: true,</span><br><span class="line">                    &quot;remove_duplicated_term&quot;: true</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;,</span><br><span class="line">              &quot;number_of_shards&quot;: 3,</span><br><span class="line">              &quot;number_of_replicas&quot;: 1,</span><br><span class="line">              &quot;max_result_window&quot;: 10000,</span><br><span class="line">              &quot;refresh_interval&quot;: &quot;30s&quot;</span><br><span class="line">            &#125;</span><br><span class="line">            &quot;&quot;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è·å–ç´¢å¼•æ˜ å°„</span><br><span class="line">     */</span><br><span class="line">    private String getIndexMappings(String indexType) &#123;</span><br><span class="line">        return &quot;&quot;&quot;</span><br><span class="line">            &#123;</span><br><span class="line">              &quot;properties&quot;: &#123;</span><br><span class="line">                &quot;combined&quot;: &#123;</span><br><span class="line">                  &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">                  &quot;analyzer&quot;: &quot;ik_max_word&quot;,</span><br><span class="line">                  &quot;search_analyzer&quot;: &quot;ik_smart&quot;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            &quot;&quot;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="7-å•†å“æœç´¢Repository"><a href="#7-å•†å“æœç´¢Repository" class="headerlink" title="7. å•†å“æœç´¢Repository"></a>7. å•†å“æœç´¢Repository</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.search.repository;</span><br><span class="line"></span><br><span class="line">import com.shophub.search.document.ProductDocument;</span><br><span class="line">import org.springframework.data.domain.Page;</span><br><span class="line">import org.springframework.data.domain.Pageable;</span><br><span class="line">import org.springframework.data.elasticsearch.annotations.Query;</span><br><span class="line">import org.springframework.data.elasticsearch.core.SearchHit;</span><br><span class="line">import org.springframework.data.elasticsearch.core.SearchPage;</span><br><span class="line">import org.springframework.data.elasticsearch.repository.ElasticsearchRepository;</span><br><span class="line">import org.springframework.stereotype.Repository;</span><br><span class="line"></span><br><span class="line">import java.math.BigDecimal;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">@Repository</span><br><span class="line">public interface ProductSearchRepository extends ElasticsearchRepository&lt;ProductDocument, Long&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ ¹æ®å•†å“åç§°æœç´¢</span><br><span class="line">     */</span><br><span class="line">    List&lt;ProductDocument&gt; findByProductName(String productName);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ ¹æ®å•†å“åç§°æœç´¢ï¼ˆåˆ†é¡µï¼‰</span><br><span class="line">     */</span><br><span class="line">    Page&lt;ProductDocument&gt; findByProductName(String productName, Pageable pageable);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ ¹æ®å•†å“åç§°å’Œå“ç‰Œæœç´¢</span><br><span class="line">     */</span><br><span class="line">    List&lt;ProductDocument&gt; findByProductNameAndBrand(String productName, String brand);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ ¹æ®åˆ†ç±»IDæœç´¢</span><br><span class="line">     */</span><br><span class="line">    Page&lt;ProductDocument&gt; findByCategoryId(Long categoryId, Pageable pageable);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ ¹æ®ä»·æ ¼èŒƒå›´æœç´¢</span><br><span class="line">     */</span><br><span class="line">    Page&lt;ProductDocument&gt; findByPriceBetween(BigDecimal minPrice, BigDecimal maxPrice, Pageable pageable);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æœç´¢çƒ­é”€å•†å“</span><br><span class="line">     */</span><br><span class="line">    Page&lt;ProductDocument&gt; findByIsHotTrue(Pageable pageable);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æœç´¢æ–°å“</span><br><span class="line">     */</span><br><span class="line">    Page&lt;ProductDocument&gt; findByIsNewTrue(Pageable pageable);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * ä½¿ç”¨è‡ªå®šä¹‰æŸ¥è¯¢è¿›è¡Œæœç´¢</span><br><span class="line">     */</span><br><span class="line">    @Query(&quot;&quot;&quot;</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;bool&quot;: &#123;</span><br><span class="line">            &quot;must&quot;: [</span><br><span class="line">              &#123;</span><br><span class="line">                &quot;multi_match&quot;: &#123;</span><br><span class="line">                  &quot;query&quot;: &quot;?0&quot;,</span><br><span class="line">                  &quot;fields&quot;: [&quot;productName^3&quot;, &quot;categoryName^2&quot;, &quot;brand^2&quot;, &quot;detail&quot;, &quot;combined&quot;],</span><br><span class="line">                  &quot;type&quot;: &quot;best_fields&quot;,</span><br><span class="line">                  &quot;fuzziness&quot;: &quot;AUTO&quot;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            ],</span><br><span class="line">            &quot;filter&quot;: [</span><br><span class="line">              &#123;</span><br><span class="line">                &quot;term&quot;: &#123;</span><br><span class="line">                  &quot;status&quot;: 1</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            ]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        &quot;&quot;&quot;)</span><br><span class="line">    Page&lt;ProductDocument&gt; searchByKeyword(String keyword, Pageable pageable);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å¤æ‚æœç´¢</span><br><span class="line">     */</span><br><span class="line">    @Query(&quot;&quot;&quot;</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;bool&quot;: &#123;</span><br><span class="line">            &quot;must&quot;: [</span><br><span class="line">              &#123;</span><br><span class="line">                &quot;multi_match&quot;: &#123;</span><br><span class="line">                  &quot;query&quot;: &quot;?0&quot;,</span><br><span class="line">                  &quot;fields&quot;: [&quot;productName^3&quot;, &quot;categoryName^2&quot;, &quot;brand^2&quot;, &quot;detail&quot;, &quot;combined&quot;],</span><br><span class="line">                  &quot;type&quot;: &quot;best_fields&quot;,</span><br><span class="line">                  &quot;fuzziness&quot;: &quot;AUTO&quot;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            ],</span><br><span class="line">            &quot;filter&quot;: [</span><br><span class="line">              &#123;</span><br><span class="line">                &quot;term&quot;: &#123;</span><br><span class="line">                  &quot;status&quot;: 1</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;,</span><br><span class="line">              ?1</span><br><span class="line">              ?2</span><br><span class="line">              ?3</span><br><span class="line">              ?4</span><br><span class="line">              ?5</span><br><span class="line">            ]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        &quot;&quot;&quot;)</span><br><span class="line">    Page&lt;ProductDocument&gt; advancedSearch(</span><br><span class="line">        String keyword,</span><br><span class="line">        String categoryFilter,</span><br><span class="line">        String priceFilter,</span><br><span class="line">        String brandFilter,</span><br><span class="line">        String hotFilter,</span><br><span class="line">        String newFilter,</span><br><span class="line">        Pageable pageable</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æœç´¢å»ºè®®</span><br><span class="line">     */</span><br><span class="line">    @Query(&quot;&quot;&quot;</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;suggest&quot;: &#123;</span><br><span class="line">            &quot;product_suggest&quot;: &#123;</span><br><span class="line">              &quot;prefix&quot;: &quot;?0&quot;,</span><br><span class="line">              &quot;completion&quot;: &#123;</span><br><span class="line">                &quot;field&quot;: &quot;productName.suggest&quot;,</span><br><span class="line">                &quot;size&quot;: ?1,</span><br><span class="line">                &quot;skip_duplicates&quot;: true</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        &quot;&quot;&quot;)</span><br><span class="line">    List&lt;ProductDocument&gt; suggestProducts(String prefix, int size);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * èšåˆæœç´¢ - æŒ‰å“ç‰Œèšåˆ</span><br><span class="line">     */</span><br><span class="line">    @Query(&quot;&quot;&quot;</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;size&quot;: 0,</span><br><span class="line">          &quot;aggs&quot;: &#123;</span><br><span class="line">            &quot;brand_agg&quot;: &#123;</span><br><span class="line">              &quot;terms&quot;: &#123;</span><br><span class="line">                &quot;field&quot;: &quot;brand.keyword&quot;,</span><br><span class="line">                &quot;size&quot;: 10</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        &quot;&quot;&quot;)</span><br><span class="line">    Object aggregateBrands();</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æœç´¢å¹¶è¿”å›é«˜äº®ç»“æœ</span><br><span class="line">     */</span><br><span class="line">    @Query(&quot;&quot;&quot;</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;query&quot;: &#123;</span><br><span class="line">            &quot;multi_match&quot;: &#123;</span><br><span class="line">              &quot;query&quot;: &quot;?0&quot;,</span><br><span class="line">              &quot;fields&quot;: [&quot;productName^3&quot;, &quot;categoryName^2&quot;, &quot;brand^2&quot;, &quot;detail&quot;],</span><br><span class="line">              &quot;type&quot;: &quot;best_fields&quot;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;highlight&quot;: &#123;</span><br><span class="line">            &quot;fields&quot;: &#123;</span><br><span class="line">              &quot;productName&quot;: &#123;</span><br><span class="line">                &quot;pre_tags&quot;: [&quot;&lt;em class=&#x27;highlight&#x27;&gt;&quot;],</span><br><span class="line">                &quot;post_tags&quot;: [&quot;&lt;/em&gt;&quot;]</span><br><span class="line">              &#125;,</span><br><span class="line">              &quot;categoryName&quot;: &#123;</span><br><span class="line">                &quot;pre_tags&quot;: [&quot;&lt;em class=&#x27;highlight&#x27;&gt;&quot;],</span><br><span class="line">                &quot;post_tags&quot;: [&quot;&lt;/em&gt;&quot;]</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        &quot;&quot;&quot;)</span><br><span class="line">    SearchPage&lt;ProductDocument&gt; searchWithHighlight(String keyword, Pageable pageable);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="8-æœç´¢æœåŠ¡å®ç°"><a href="#8-æœç´¢æœåŠ¡å®ç°" class="headerlink" title="8. æœç´¢æœåŠ¡å®ç°"></a>8. æœç´¢æœåŠ¡å®ç°</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.search.service;</span><br><span class="line"></span><br><span class="line">import com.shophub.common.result.ResultCode;</span><br><span class="line">import com.shophub.search.document.ProductDocument;</span><br><span class="line">import com.shophub.search.document.ProductSearchLog;</span><br><span class="line">import com.shophub.search.document.ProductSuggestDocument;</span><br><span class="line">import com.shophub.search.repository.ProductSearchRepository;</span><br><span class="line">import com.shophub.search.vo.*;</span><br><span class="line">import lombok.RequiredArgsConstructor;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import net.sourceforge.pinyin4j.PinyinHelper;</span><br><span class="line">import net.sourceforge.pinyin4j.format.HanyuPinyinCaseType;</span><br><span class="line">import net.sourceforge.pinyin4j.format.HanyuPinyinOutputFormat;</span><br><span class="line">import net.sourceforge.pinyin4j.format.HanyuPinyinToneType;</span><br><span class="line">import net.sourceforge.pinyin4j.format.exception.BadHanyuPinyinOutputFormatCombination;</span><br><span class="line">import org.apache.commons.lang3.StringUtils;</span><br><span class="line">import org.elasticsearch.action.search.SearchRequest;</span><br><span class="line">import org.elasticsearch.action.search.SearchResponse;</span><br><span class="line">import org.elasticsearch.client.RequestOptions;</span><br><span class="line">import org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line">import org.elasticsearch.common.lucene.search.function.FunctionScoreQuery;</span><br><span class="line">import org.elasticsearch.index.query.*;</span><br><span class="line">import org.elasticsearch.index.query.functionscore.FunctionScoreQueryBuilder;</span><br><span class="line">import org.elasticsearch.index.query.functionscore.ScoreFunctionBuilders;</span><br><span class="line">import org.elasticsearch.search.SearchHit;</span><br><span class="line">import org.elasticsearch.search.aggregations.AggregationBuilders;</span><br><span class="line">import org.elasticsearch.search.aggregations.Aggregations;</span><br><span class="line">import org.elasticsearch.search.aggregations.bucket.terms.ParsedStringTerms;</span><br><span class="line">import org.elasticsearch.search.aggregations.bucket.terms.Terms;</span><br><span class="line">import org.elasticsearch.search.builder.SearchSourceBuilder;</span><br><span class="line">import org.elasticsearch.search.fetch.subphase.highlight.HighlightBuilder;</span><br><span class="line">import org.elasticsearch.search.sort.SortBuilders;</span><br><span class="line">import org.elasticsearch.search.sort.SortOrder;</span><br><span class="line">import org.elasticsearch.search.suggest.Suggest;</span><br><span class="line">import org.elasticsearch.search.suggest.SuggestBuilder;</span><br><span class="line">import org.elasticsearch.search.suggest.SuggestBuilders;</span><br><span class="line">import org.elasticsearch.search.suggest.completion.CompletionSuggestion;</span><br><span class="line">import org.elasticsearch.search.suggest.completion.CompletionSuggestionBuilder;</span><br><span class="line">import org.springframework.data.domain.Page;</span><br><span class="line">import org.springframework.data.domain.PageRequest;</span><br><span class="line">import org.springframework.data.domain.Pageable;</span><br><span class="line">import org.springframework.data.domain.Sort;</span><br><span class="line">import org.springframework.data.elasticsearch.core.*;</span><br><span class="line">import org.springframework.data.elasticsearch.core.query.NativeSearchQuery;</span><br><span class="line">import org.springframework.data.elasticsearch.core.query.NativeSearchQueryBuilder;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line">import org.springframework.util.CollectionUtils;</span><br><span class="line"></span><br><span class="line">import javax.servlet.http.HttpServletRequest;</span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.math.BigDecimal;</span><br><span class="line">import java.time.LocalDateTime;</span><br><span class="line">import java.util.*;</span><br><span class="line">import java.util.concurrent.CompletableFuture;</span><br><span class="line">import java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@Service</span><br><span class="line">@RequiredArgsConstructor</span><br><span class="line">public class ProductSearchService &#123;</span><br><span class="line">    </span><br><span class="line">    private final ProductSearchRepository productSearchRepository;</span><br><span class="line">    private final ElasticsearchRestTemplate elasticsearchRestTemplate;</span><br><span class="line">    private final RestHighLevelClient restHighLevelClient;</span><br><span class="line">    private final ProductSuggestService productSuggestService;</span><br><span class="line">    private final SearchLogService searchLogService;</span><br><span class="line">    </span><br><span class="line">    private static final String PRODUCT_INDEX = &quot;shophub_product&quot;;</span><br><span class="line">    private static final int DEFAULT_PAGE_SIZE = 20;</span><br><span class="line">    private static final int MAX_PAGE_SIZE = 100;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åŸºç¡€æœç´¢</span><br><span class="line">     */</span><br><span class="line">    public SearchResult&lt;ProductDocument&gt; search(SearchRequest request) &#123;</span><br><span class="line">        long startTime = System.currentTimeMillis();</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            // æ„å»ºæŸ¥è¯¢</span><br><span class="line">            NativeSearchQueryBuilder queryBuilder = buildSearchQuery(request);</span><br><span class="line">            </span><br><span class="line">            // è®¾ç½®åˆ†é¡µ</span><br><span class="line">            int page = Math.max(request.getPage() - 1, 0);</span><br><span class="line">            int size = Math.min(Math.max(request.getSize(), 1), MAX_PAGE_SIZE);</span><br><span class="line">            queryBuilder.withPageable(PageRequest.of(page, size));</span><br><span class="line">            </span><br><span class="line">            // è®¾ç½®æ’åº</span><br><span class="line">            applySorting(queryBuilder, request.getSortBy(), request.getSortOrder());</span><br><span class="line">            </span><br><span class="line">            // æ‰§è¡Œæœç´¢</span><br><span class="line">            SearchHits&lt;ProductDocument&gt; searchHits = elasticsearchRestTemplate.search(</span><br><span class="line">                queryBuilder.build(), ProductDocument.class);</span><br><span class="line">            </span><br><span class="line">            // å¤„ç†ç»“æœ</span><br><span class="line">            List&lt;ProductDocument&gt; products = searchHits.getSearchHits().stream()</span><br><span class="line">                .map(SearchHit::getContent)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">            </span><br><span class="line">            // å¤„ç†é«˜äº®</span><br><span class="line">            if (StringUtils.isNotBlank(request.getKeyword())) &#123;</span><br><span class="line">                products = processHighlights(searchHits, products);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            long tookTime = System.currentTimeMillis() - startTime;</span><br><span class="line">            </span><br><span class="line">            // è®°å½•æœç´¢æ—¥å¿—ï¼ˆå¼‚æ­¥ï¼‰</span><br><span class="line">            logSearch(request, products.size(), tookTime);</span><br><span class="line">            </span><br><span class="line">            // æ›´æ–°æœç´¢å»ºè®®ï¼ˆå¼‚æ­¥ï¼‰</span><br><span class="line">            updateSearchSuggestions(request.getKeyword());</span><br><span class="line">            </span><br><span class="line">            return SearchResult.&lt;ProductDocument&gt;builder()</span><br><span class="line">                .list(products)</span><br><span class="line">                .total(searchHits.getTotalHits())</span><br><span class="line">                .page(request.getPage())</span><br><span class="line">                .size(size)</span><br><span class="line">                .pages((int) Math.ceil((double) searchHits.getTotalHits() / size))</span><br><span class="line">                .tookTime(tookTime)</span><br><span class="line">                .build();</span><br><span class="line">            </span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;æœç´¢å¤±è´¥ï¼Œå‚æ•°ï¼š&#123;&#125;&quot;, request, e);</span><br><span class="line">            throw new RuntimeException(&quot;æœç´¢å¤±è´¥&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * é«˜çº§æœç´¢ï¼ˆæ”¯æŒå¤šç§è¿‡æ»¤æ¡ä»¶ï¼‰</span><br><span class="line">     */</span><br><span class="line">    public SearchResult&lt;ProductDocument&gt; advancedSearch(AdvancedSearchRequest request) &#123;</span><br><span class="line">        long startTime = System.currentTimeMillis();</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            // æ„å»ºå¸ƒå°”æŸ¥è¯¢</span><br><span class="line">            BoolQueryBuilder boolQuery = QueryBuilders.boolQuery();</span><br><span class="line">            </span><br><span class="line">            // å…³é”®è¯æŸ¥è¯¢</span><br><span class="line">            if (StringUtils.isNotBlank(request.getKeyword())) &#123;</span><br><span class="line">                MultiMatchQueryBuilder keywordQuery = QueryBuilders.multiMatchQuery(request.getKeyword())</span><br><span class="line">                    .field(&quot;productName&quot;, 3.0f)</span><br><span class="line">                    .field(&quot;categoryName&quot;, 2.0f)</span><br><span class="line">                    .field(&quot;brand&quot;, 2.0f)</span><br><span class="line">                    .field(&quot;detail&quot;, 1.0f)</span><br><span class="line">                    .field(&quot;combined&quot;, 1.0f)</span><br><span class="line">                    .type(MultiMatchQueryBuilder.Type.BEST_FIELDS)</span><br><span class="line">                    .fuzziness(&quot;AUTO&quot;);</span><br><span class="line">                boolQuery.must(keywordQuery);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // åˆ†ç±»è¿‡æ»¤</span><br><span class="line">            if (!CollectionUtils.isEmpty(request.getCategoryIds())) &#123;</span><br><span class="line">                TermsQueryBuilder categoryQuery = QueryBuilders.termsQuery(&quot;categoryId&quot;, request.getCategoryIds());</span><br><span class="line">                boolQuery.filter(categoryQuery);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // ä»·æ ¼èŒƒå›´è¿‡æ»¤</span><br><span class="line">            if (request.getMinPrice() != null || request.getMaxPrice() != null) &#123;</span><br><span class="line">                RangeQueryBuilder priceQuery = QueryBuilders.rangeQuery(&quot;price&quot;);</span><br><span class="line">                if (request.getMinPrice() != null) &#123;</span><br><span class="line">                    priceQuery.gte(request.getMinPrice());</span><br><span class="line">                &#125;</span><br><span class="line">                if (request.getMaxPrice() != null) &#123;</span><br><span class="line">                    priceQuery.lte(request.getMaxPrice());</span><br><span class="line">                &#125;</span><br><span class="line">                boolQuery.filter(priceQuery);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // å“ç‰Œè¿‡æ»¤</span><br><span class="line">            if (!CollectionUtils.isEmpty(request.getBrands())) &#123;</span><br><span class="line">                TermsQueryBuilder brandQuery = QueryBuilders.termsQuery(&quot;brand.keyword&quot;, request.getBrands());</span><br><span class="line">                boolQuery.filter(brandQuery);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // å±æ€§è¿‡æ»¤</span><br><span class="line">            if (!CollectionUtils.isEmpty(request.getAttributes())) &#123;</span><br><span class="line">                for (AttributeFilter attribute : request.getAttributes()) &#123;</span><br><span class="line">                    NestedQueryBuilder nestedQuery = QueryBuilders.nestedQuery(&quot;specs&quot;,</span><br><span class="line">                        QueryBuilders.boolQuery()</span><br><span class="line">                            .must(QueryBuilders.termQuery(&quot;specs.name&quot;, attribute.getName()))</span><br><span class="line">                            .must(QueryBuilders.termQuery(&quot;specs.value&quot;, attribute.getValue())),</span><br><span class="line">                        org.apache.lucene.search.join.ScoreMode.None);</span><br><span class="line">                    boolQuery.filter(nestedQuery);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // çŠ¶æ€è¿‡æ»¤ï¼ˆåªæŸ¥è¯¢ä¸Šæ¶å•†å“ï¼‰</span><br><span class="line">            boolQuery.filter(QueryBuilders.termQuery(&quot;status&quot;, 1));</span><br><span class="line">            </span><br><span class="line">            // çƒ­é”€/æ–°å“è¿‡æ»¤</span><br><span class="line">            if (request.getIsHot() != null) &#123;</span><br><span class="line">                boolQuery.filter(QueryBuilders.termQuery(&quot;isHot&quot;, request.getIsHot()));</span><br><span class="line">            &#125;</span><br><span class="line">            if (request.getIsNew() != null) &#123;</span><br><span class="line">                boolQuery.filter(QueryBuilders.termQuery(&quot;isNew&quot;, request.getIsNew()));</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // æ„å»ºæŸ¥è¯¢</span><br><span class="line">            NativeSearchQueryBuilder queryBuilder = new NativeSearchQueryBuilder()</span><br><span class="line">                .withQuery(boolQuery);</span><br><span class="line">            </span><br><span class="line">            // åˆ†é¡µ</span><br><span class="line">            int page = Math.max(request.getPage() - 1, 0);</span><br><span class="line">            int size = Math.min(Math.max(request.getSize(), 1), MAX_PAGE_SIZE);</span><br><span class="line">            queryBuilder.withPageable(PageRequest.of(page, size));</span><br><span class="line">            </span><br><span class="line">            // æ’åº</span><br><span class="line">            applySorting(queryBuilder, request.getSortBy(), request.getSortOrder());</span><br><span class="line">            </span><br><span class="line">            // é«˜äº®è®¾ç½®</span><br><span class="line">            if (StringUtils.isNotBlank(request.getKeyword())) &#123;</span><br><span class="line">                HighlightBuilder highlightBuilder = new HighlightBuilder()</span><br><span class="line">                    .field(&quot;productName&quot;)</span><br><span class="line">                    .field(&quot;categoryName&quot;)</span><br><span class="line">                    .field(&quot;brand&quot;)</span><br><span class="line">                    .preTags(&quot;&lt;em class=&#x27;highlight&#x27;&gt;&quot;)</span><br><span class="line">                    .postTags(&quot;&lt;/em&gt;&quot;);</span><br><span class="line">                queryBuilder.withHighlightBuilder(highlightBuilder);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // æ‰§è¡Œæœç´¢</span><br><span class="line">            SearchHits&lt;ProductDocument&gt; searchHits = elasticsearchRestTemplate.search(</span><br><span class="line">                queryBuilder.build(), ProductDocument.class);</span><br><span class="line">            </span><br><span class="line">            // å¤„ç†ç»“æœ</span><br><span class="line">            List&lt;ProductDocument&gt; products = searchHits.getSearchHits().stream()</span><br><span class="line">                .map(SearchHit::getContent)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">            </span><br><span class="line">            // å¤„ç†é«˜äº®</span><br><span class="line">            if (StringUtils.isNotBlank(request.getKeyword())) &#123;</span><br><span class="line">                products = processHighlights(searchHits, products);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            long tookTime = System.currentTimeMillis() - startTime;</span><br><span class="line">            </span><br><span class="line">            return SearchResult.&lt;ProductDocument&gt;builder()</span><br><span class="line">                .list(products)</span><br><span class="line">                .total(searchHits.getTotalHits())</span><br><span class="line">                .page(request.getPage())</span><br><span class="line">                .size(size)</span><br><span class="line">                .pages((int) Math.ceil((double) searchHits.getTotalHits() / size))</span><br><span class="line">                .tookTime(tookTime)</span><br><span class="line">                .build();</span><br><span class="line">            </span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;é«˜çº§æœç´¢å¤±è´¥ï¼Œå‚æ•°ï¼š&#123;&#125;&quot;, request, e);</span><br><span class="line">            throw new RuntimeException(&quot;é«˜çº§æœç´¢å¤±è´¥&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æœç´¢å»ºè®®ï¼ˆè‡ªåŠ¨è¡¥å…¨ï¼‰</span><br><span class="line">     */</span><br><span class="line">    public List&lt;SearchSuggest&gt; getSearchSuggestions(String keyword, int size) &#123;</span><br><span class="line">        if (StringUtils.isBlank(keyword)) &#123;</span><br><span class="line">            return Collections.emptyList();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            // æ„å»ºæœç´¢å»ºè®®è¯·æ±‚</span><br><span class="line">            SearchRequest searchRequest = new SearchRequest(PRODUCT_INDEX);</span><br><span class="line">            SearchSourceBuilder sourceBuilder = new SearchSourceBuilder();</span><br><span class="line">            </span><br><span class="line">            // åˆ›å»ºè¡¥å…¨å»ºè®®</span><br><span class="line">            CompletionSuggestionBuilder suggestionBuilder = SuggestBuilders</span><br><span class="line">                .completionSuggestion(&quot;productName.suggest&quot;)</span><br><span class="line">                .prefix(keyword)</span><br><span class="line">                .size(Math.min(size, 20))</span><br><span class="line">                .skipDuplicates(true);</span><br><span class="line">            </span><br><span class="line">            SuggestBuilder suggestBuilder = new SuggestBuilder()</span><br><span class="line">                .addSuggestion(&quot;product_suggest&quot;, suggestionBuilder);</span><br><span class="line">            </span><br><span class="line">            sourceBuilder.suggest(suggestBuilder);</span><br><span class="line">            searchRequest.source(sourceBuilder);</span><br><span class="line">            </span><br><span class="line">            // æ‰§è¡Œæœç´¢</span><br><span class="line">            SearchResponse response = restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">            </span><br><span class="line">            // å¤„ç†å»ºè®®ç»“æœ</span><br><span class="line">            Suggest suggest = response.getSuggest();</span><br><span class="line">            CompletionSuggestion completionSuggestion = suggest.getSuggestion(&quot;product_suggest&quot;);</span><br><span class="line">            </span><br><span class="line">            List&lt;SearchSuggest&gt; suggestions = new ArrayList&lt;&gt;();</span><br><span class="line">            for (CompletionSuggestion.Entry.Option option : completionSuggestion.getOptions()) &#123;</span><br><span class="line">                String text = option.getText().string();</span><br><span class="line">                SearchSuggest searchSuggest = SearchSuggest.builder()</span><br><span class="line">                    .text(text)</span><br><span class="line">                    .score(option.getScore())</span><br><span class="line">                    .build();</span><br><span class="line">                suggestions.add(searchSuggest);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            return suggestions;</span><br><span class="line">            </span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            log.error(&quot;è·å–æœç´¢å»ºè®®å¤±è´¥ï¼Œå…³é”®è¯ï¼š&#123;&#125;&quot;, keyword, e);</span><br><span class="line">            return Collections.emptyList();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è·å–æœç´¢èšåˆç»“æœï¼ˆç”¨äºç­›é€‰é¢æ¿ï¼‰</span><br><span class="line">     */</span><br><span class="line">    public SearchAggregation getSearchAggregation(SearchRequest request) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            // æ„å»ºåŸºç¡€æŸ¥è¯¢</span><br><span class="line">            NativeSearchQueryBuilder queryBuilder = buildSearchQuery(request);</span><br><span class="line">            </span><br><span class="line">            // æ·»åŠ èšåˆ</span><br><span class="line">            queryBuilder.addAggregation(AggregationBuilders.terms(&quot;brand_agg&quot;)</span><br><span class="line">                .field(&quot;brand.keyword&quot;)</span><br><span class="line">                .size(20));</span><br><span class="line">            </span><br><span class="line">            queryBuilder.addAggregation(AggregationBuilders.terms(&quot;category_agg&quot;)</span><br><span class="line">                .field(&quot;categoryId&quot;)</span><br><span class="line">                .size(20));</span><br><span class="line">            </span><br><span class="line">            queryBuilder.addAggregation(AggregationBuilders.stats(&quot;price_stats&quot;)</span><br><span class="line">                .field(&quot;price&quot;));</span><br><span class="line">            </span><br><span class="line">            // æ‰§è¡Œæœç´¢ï¼ˆä¸è¿”å›æ–‡æ¡£ï¼Œåªè¿”å›èšåˆç»“æœï¼‰</span><br><span class="line">            queryBuilder.withPageable(PageRequest.of(0, 0));</span><br><span class="line">            </span><br><span class="line">            SearchHits&lt;ProductDocument&gt; searchHits = elasticsearchRestTemplate.search(</span><br><span class="line">                queryBuilder.build(), ProductDocument.class);</span><br><span class="line">            </span><br><span class="line">            // å¤„ç†èšåˆç»“æœ</span><br><span class="line">            Aggregations aggregations = searchHits.getAggregations();</span><br><span class="line">            </span><br><span class="line">            SearchAggregation aggregation = new SearchAggregation();</span><br><span class="line">            </span><br><span class="line">            // å“ç‰Œèšåˆ</span><br><span class="line">            if (aggregations != null) &#123;</span><br><span class="line">                ParsedStringTerms brandAgg = aggregations.get(&quot;brand_agg&quot;);</span><br><span class="line">                if (brandAgg != null) &#123;</span><br><span class="line">                    List&lt;Bucket&gt; brandBuckets = brandAgg.getBuckets().stream()</span><br><span class="line">                        .map(bucket -&gt; new Bucket(bucket.getKeyAsString(), bucket.getDocCount()))</span><br><span class="line">                        .collect(Collectors.toList());</span><br><span class="line">                    aggregation.setBrands(brandBuckets);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                // åˆ†ç±»èšåˆ</span><br><span class="line">                ParsedStringTerms categoryAgg = aggregations.get(&quot;category_agg&quot;);</span><br><span class="line">                if (categoryAgg != null) &#123;</span><br><span class="line">                    List&lt;Bucket&gt; categoryBuckets = categoryAgg.getBuckets().stream()</span><br><span class="line">                        .map(bucket -&gt; new Bucket(bucket.getKeyAsString(), bucket.getDocCount()))</span><br><span class="line">                        .collect(Collectors.toList());</span><br><span class="line">                    aggregation.setCategories(categoryBuckets);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            return aggregation;</span><br><span class="line">            </span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;è·å–æœç´¢èšåˆå¤±è´¥&quot;, e);</span><br><span class="line">            return new SearchAggregation();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åŒæ­¥å•†å“æ•°æ®åˆ°Elasticsearch</span><br><span class="line">     */</span><br><span class="line">    public boolean syncProductToEs(Long productId) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            // è¿™é‡Œåº”è¯¥ä»å•†å“æœåŠ¡è·å–å•†å“è¯¦æƒ…</span><br><span class="line">            // Product product = productService.getProductById(productId);</span><br><span class="line">            </span><br><span class="line">            // è½¬æ¢ä¸ºESæ–‡æ¡£</span><br><span class="line">            // ProductDocument document = convertToDocument(product);</span><br><span class="line">            </span><br><span class="line">            // ä¿å­˜åˆ°ES</span><br><span class="line">            // productSearchRepository.save(document);</span><br><span class="line">            </span><br><span class="line">            log.info(&quot;åŒæ­¥å•†å“åˆ°ESæˆåŠŸï¼Œå•†å“IDï¼š&#123;&#125;&quot;, productId);</span><br><span class="line">            return true;</span><br><span class="line">            </span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;åŒæ­¥å•†å“åˆ°ESå¤±è´¥ï¼Œå•†å“IDï¼š&#123;&#125;&quot;, productId, e);</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ‰¹é‡åŒæ­¥å•†å“æ•°æ®</span><br><span class="line">     */</span><br><span class="line">    public void batchSyncProducts(List&lt;Long&gt; productIds) &#123;</span><br><span class="line">        productIds.parallelStream().forEach(this::syncProductToEs);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * é‡å»ºå•†å“ç´¢å¼•</span><br><span class="line">     */</span><br><span class="line">    public boolean rebuildProductIndex() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            // 1. åˆ é™¤æ—§ç´¢å¼•</span><br><span class="line">            // 2. åˆ›å»ºæ–°ç´¢å¼•</span><br><span class="line">            // 3. æ‰¹é‡åŒæ­¥æ‰€æœ‰å•†å“æ•°æ®</span><br><span class="line">            </span><br><span class="line">            log.info(&quot;å¼€å§‹é‡å»ºå•†å“ç´¢å¼•&quot;);</span><br><span class="line">            </span><br><span class="line">            // è¿™é‡Œå®ç°å…·ä½“çš„é‡å»ºé€»è¾‘</span><br><span class="line">            // ...</span><br><span class="line">            </span><br><span class="line">            log.info(&quot;é‡å»ºå•†å“ç´¢å¼•å®Œæˆ&quot;);</span><br><span class="line">            return true;</span><br><span class="line">            </span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;é‡å»ºå•†å“ç´¢å¼•å¤±è´¥&quot;, e);</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ„å»ºæœç´¢æŸ¥è¯¢</span><br><span class="line">     */</span><br><span class="line">    private NativeSearchQueryBuilder buildSearchQuery(SearchRequest request) &#123;</span><br><span class="line">        NativeSearchQueryBuilder queryBuilder = new NativeSearchQueryBuilder();</span><br><span class="line">        </span><br><span class="line">        if (StringUtils.isNotBlank(request.getKeyword())) &#123;</span><br><span class="line">            // å¤šå­—æ®µåŒ¹é…æŸ¥è¯¢</span><br><span class="line">            MultiMatchQueryBuilder multiMatchQuery = QueryBuilders.multiMatchQuery(request.getKeyword())</span><br><span class="line">                .field(&quot;productName&quot;, 3.0f)      // å•†å“åç§°æƒé‡æœ€é«˜</span><br><span class="line">                .field(&quot;categoryName&quot;, 2.0f)     // åˆ†ç±»åç§°æƒé‡æ¬¡ä¹‹</span><br><span class="line">                .field(&quot;brand&quot;, 2.0f)            // å“ç‰Œæƒé‡æ¬¡ä¹‹</span><br><span class="line">                .field(&quot;detail&quot;, 1.0f)           // è¯¦æƒ…æƒé‡æœ€ä½</span><br><span class="line">                .field(&quot;combined&quot;, 1.0f)         // ç»„åˆå­—æ®µ</span><br><span class="line">                .type(MultiMatchQueryBuilder.Type.BEST_FIELDS)</span><br><span class="line">                .fuzziness(&quot;AUTO&quot;);              // æ¨¡ç³ŠæŸ¥è¯¢</span><br><span class="line">            </span><br><span class="line">            // å‡½æ•°è¯„åˆ†æŸ¥è¯¢ï¼ˆæ ¹æ®é”€é‡ã€è¯„åˆ†ç­‰æå‡ç›¸å…³åº¦ï¼‰</span><br><span class="line">            FunctionScoreQueryBuilder.FilterFunctionBuilder[] functions = &#123;</span><br><span class="line">                new FunctionScoreQueryBuilder.FilterFunctionBuilder(</span><br><span class="line">                    ScoreFunctionBuilders.fieldValueFactorFunction(&quot;saleCount&quot;)</span><br><span class="line">                        .factor(0.1f)</span><br><span class="line">                        .modifier(FieldValueFactorFunction.Modifier.LOG1P)</span><br><span class="line">                        .missing(1)</span><br><span class="line">                ),</span><br><span class="line">                new FunctionScoreQueryBuilder.FilterFunctionBuilder(</span><br><span class="line">                    ScoreFunctionBuilders.fieldValueFactorFunction(&quot;score&quot;)</span><br><span class="line">                        .factor(0.2f)</span><br><span class="line">                        .modifier(FieldValueFactorFunction.Modifier.LOG1P)</span><br><span class="line">                        .missing(3)</span><br><span class="line">                ),</span><br><span class="line">                new FunctionScoreQueryBuilder.FilterFunctionBuilder(</span><br><span class="line">                    ScoreFunctionBuilders.fieldValueFactorFunction(&quot;isHot&quot;)</span><br><span class="line">                        .factor(0.3f)</span><br><span class="line">                        .missing(0)</span><br><span class="line">                ),</span><br><span class="line">                new FunctionScoreQueryBuilder.FilterFunctionBuilder(</span><br><span class="line">                    ScoreFunctionBuilders.fieldValueFactorFunction(&quot;isNew&quot;)</span><br><span class="line">                        .factor(0.2f)</span><br><span class="line">                        .missing(0)</span><br><span class="line">                )</span><br><span class="line">            &#125;;</span><br><span class="line">            </span><br><span class="line">            FunctionScoreQueryBuilder functionScoreQuery = QueryBuilders.functionScoreQuery(</span><br><span class="line">                multiMatchQuery, functions)</span><br><span class="line">                .scoreMode(FunctionScoreQuery.ScoreMode.SUM)</span><br><span class="line">                .boostMode(CombineFunction.SUM)</span><br><span class="line">                .maxBoost(10f);</span><br><span class="line">            </span><br><span class="line">            queryBuilder.withQuery(functionScoreQuery);</span><br><span class="line">            </span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // å¦‚æœæ²¡æœ‰å…³é”®è¯ï¼ŒæŸ¥è¯¢æ‰€æœ‰ä¸Šæ¶å•†å“</span><br><span class="line">            queryBuilder.withQuery(QueryBuilders.termQuery(&quot;status&quot;, 1));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // æ·»åŠ é«˜äº®</span><br><span class="line">        if (StringUtils.isNotBlank(request.getKeyword())) &#123;</span><br><span class="line">            HighlightBuilder highlightBuilder = new HighlightBuilder()</span><br><span class="line">                .field(&quot;productName&quot;)</span><br><span class="line">                .field(&quot;categoryName&quot;)</span><br><span class="line">                .field(&quot;brand&quot;)</span><br><span class="line">                .preTags(&quot;&lt;em class=&#x27;highlight&#x27;&gt;&quot;)</span><br><span class="line">                .postTags(&quot;&lt;/em&gt;&quot;)</span><br><span class="line">                .numOfFragments(0);  // è¿”å›å®Œæ•´å­—æ®µ</span><br><span class="line">            </span><br><span class="line">            queryBuilder.withHighlightBuilder(highlightBuilder);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return queryBuilder;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åº”ç”¨æ’åº</span><br><span class="line">     */</span><br><span class="line">    private void applySorting(NativeSearchQueryBuilder queryBuilder, String sortBy, String sortOrder) &#123;</span><br><span class="line">        if (StringUtils.isBlank(sortBy)) &#123;</span><br><span class="line">            // é»˜è®¤æŒ‰ç›¸å…³æ€§æ’åº</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        SortOrder order = &quot;desc&quot;.equalsIgnoreCase(sortOrder) ? SortOrder.DESC : SortOrder.ASC;</span><br><span class="line">        </span><br><span class="line">        switch (sortBy.toLowerCase()) &#123;</span><br><span class="line">            case &quot;price&quot;:</span><br><span class="line">                queryBuilder.withSort(SortBuilders.fieldSort(&quot;price&quot;).order(order));</span><br><span class="line">                break;</span><br><span class="line">            case &quot;sale&quot;:</span><br><span class="line">                queryBuilder.withSort(SortBuilders.fieldSort(&quot;saleCount&quot;).order(order));</span><br><span class="line">                break;</span><br><span class="line">            case &quot;new&quot;:</span><br><span class="line">                queryBuilder.withSort(SortBuilders.fieldSort(&quot;createTime&quot;).order(SortOrder.DESC));</span><br><span class="line">                break;</span><br><span class="line">            case &quot;score&quot;:</span><br><span class="line">                queryBuilder.withSort(SortBuilders.fieldSort(&quot;score&quot;).order(order));</span><br><span class="line">                break;</span><br><span class="line">            default:</span><br><span class="line">                // é»˜è®¤æŒ‰ç›¸å…³æ€§æ’åº</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å¤„ç†é«˜äº®ç»“æœ</span><br><span class="line">     */</span><br><span class="line">    private List&lt;ProductDocument&gt; processHighlights(SearchHits&lt;ProductDocument&gt; searchHits, </span><br><span class="line">                                                   List&lt;ProductDocument&gt; products) &#123;</span><br><span class="line">        Map&lt;Long, Map&lt;String, List&lt;String&gt;&gt;&gt; highlightMap = new HashMap&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        for (SearchHit&lt;ProductDocument&gt; hit : searchHits.getSearchHits()) &#123;</span><br><span class="line">            ProductDocument product = hit.getContent();</span><br><span class="line">            Map&lt;String, List&lt;String&gt;&gt; highlights = hit.getHighlightFields();</span><br><span class="line">            </span><br><span class="line">            if (!CollectionUtils.isEmpty(highlights)) &#123;</span><br><span class="line">                highlightMap.put(product.getId(), highlights);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // åº”ç”¨é«˜äº®åˆ°å•†å“</span><br><span class="line">        return products.stream()</span><br><span class="line">            .map(product -&gt; &#123;</span><br><span class="line">                Map&lt;String, List&lt;String&gt;&gt; highlights = highlightMap.get(product.getId());</span><br><span class="line">                if (highlights != null) &#123;</span><br><span class="line">                    // å¤„ç†å•†å“åç§°é«˜äº®</span><br><span class="line">                    List&lt;String&gt; productNameHighlights = highlights.get(&quot;productName&quot;);</span><br><span class="line">                    if (!CollectionUtils.isEmpty(productNameHighlights)) &#123;</span><br><span class="line">                        product.setProductName(productNameHighlights.get(0));</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    // å¤„ç†åˆ†ç±»åç§°é«˜äº®</span><br><span class="line">                    List&lt;String&gt; categoryNameHighlights = highlights.get(&quot;categoryName&quot;);</span><br><span class="line">                    if (!CollectionUtils.isEmpty(categoryNameHighlights)) &#123;</span><br><span class="line">                        product.setCategoryName(categoryNameHighlights.get(0));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                return product;</span><br><span class="line">            &#125;)</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è®°å½•æœç´¢æ—¥å¿—ï¼ˆå¼‚æ­¥ï¼‰</span><br><span class="line">     */</span><br><span class="line">    private void logSearch(SearchRequest request, int resultCount, double tookTime) &#123;</span><br><span class="line">        CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                ProductSearchLog searchLog = new ProductSearchLog();</span><br><span class="line">                searchLog.setId(UUID.randomUUID().toString());</span><br><span class="line">                searchLog.setKeyword(request.getKeyword());</span><br><span class="line">                searchLog.setResultCount(resultCount);</span><br><span class="line">                searchLog.setTookTime(tookTime);</span><br><span class="line">                searchLog.setSearchTime(LocalDateTime.now());</span><br><span class="line">                searchLog.setSearchType(&quot;keyword&quot;);</span><br><span class="line">                </span><br><span class="line">                // è¿™é‡Œå¯ä»¥è®¾ç½®ç”¨æˆ·ä¿¡æ¯ã€IPç­‰</span><br><span class="line">                // searchLog.setUserId(userId);</span><br><span class="line">                // searchLog.setIp(ip);</span><br><span class="line">                </span><br><span class="line">                searchLogService.saveSearchLog(searchLog);</span><br><span class="line">                </span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                log.error(&quot;è®°å½•æœç´¢æ—¥å¿—å¤±è´¥&quot;, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ›´æ–°æœç´¢å»ºè®®ï¼ˆå¼‚æ­¥ï¼‰</span><br><span class="line">     */</span><br><span class="line">    private void updateSearchSuggestions(String keyword) &#123;</span><br><span class="line">        if (StringUtils.isBlank(keyword) || keyword.length() &lt; 2) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                productSuggestService.incrementSearchCount(keyword);</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                log.error(&quot;æ›´æ–°æœç´¢å»ºè®®å¤±è´¥ï¼Œå…³é”®è¯ï¼š&#123;&#125;&quot;, keyword, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å°†æ±‰å­—è½¬æ¢ä¸ºæ‹¼éŸ³ï¼ˆç”¨äºæ‹¼éŸ³æœç´¢ï¼‰</span><br><span class="line">     */</span><br><span class="line">    private String convertToPinyin(String chinese) &#123;</span><br><span class="line">        if (StringUtils.isBlank(chinese)) &#123;</span><br><span class="line">            return &quot;&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        HanyuPinyinOutputFormat format = new HanyuPinyinOutputFormat();</span><br><span class="line">        format.setCaseType(HanyuPinyinCaseType.LOWERCASE);</span><br><span class="line">        format.setToneType(HanyuPinyinToneType.WITHOUT_TONE);</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            StringBuilder pinyin = new StringBuilder();</span><br><span class="line">            for (char c : chinese.toCharArray()) &#123;</span><br><span class="line">                if (Character.toString(c).matches(&quot;[\\u4E00-\\u9FA5]&quot;)) &#123;</span><br><span class="line">                    String[] pinyinArray = PinyinHelper.toHanyuPinyinStringArray(c, format);</span><br><span class="line">                    if (pinyinArray != null &amp;&amp; pinyinArray.length &gt; 0) &#123;</span><br><span class="line">                        pinyin.append(pinyinArray[0]);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    pinyin.append(c);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            return pinyin.toString();</span><br><span class="line">        &#125; catch (BadHanyuPinyinOutputFormatCombination e) &#123;</span><br><span class="line">            log.error(&quot;è½¬æ¢æ‹¼éŸ³å¤±è´¥ï¼š&#123;&#125;&quot;, chinese, e);</span><br><span class="line">            return &quot;&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æœç´¢è¯·æ±‚VO</span><br><span class="line">@Data</span><br><span class="line">class SearchRequest &#123;</span><br><span class="line">    private String keyword;</span><br><span class="line">    private Integer page = 1;</span><br><span class="line">    private Integer size = 20;</span><br><span class="line">    private String sortBy;</span><br><span class="line">    private String sortOrder = &quot;desc&quot;;</span><br><span class="line">    private Long categoryId;</span><br><span class="line">    private BigDecimal minPrice;</span><br><span class="line">    private BigDecimal maxPrice;</span><br><span class="line">    private String brand;</span><br><span class="line">    private Boolean isHot;</span><br><span class="line">    private Boolean isNew;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// é«˜çº§æœç´¢è¯·æ±‚VO</span><br><span class="line">@Data</span><br><span class="line">class AdvancedSearchRequest &#123;</span><br><span class="line">    private String keyword;</span><br><span class="line">    private List&lt;Long&gt; categoryIds;</span><br><span class="line">    private BigDecimal minPrice;</span><br><span class="line">    private BigDecimal maxPrice;</span><br><span class="line">    private List&lt;String&gt; brands;</span><br><span class="line">    private List&lt;AttributeFilter&gt; attributes;</span><br><span class="line">    private Boolean isHot;</span><br><span class="line">    private Boolean isNew;</span><br><span class="line">    private Integer page = 1;</span><br><span class="line">    private Integer size = 20;</span><br><span class="line">    private String sortBy;</span><br><span class="line">    private String sortOrder = &quot;desc&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// å±æ€§è¿‡æ»¤å™¨</span><br><span class="line">@Data</span><br><span class="line">class AttributeFilter &#123;</span><br><span class="line">    private String name;</span><br><span class="line">    private String value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æœç´¢ç»“æœVO</span><br><span class="line">@Data</span><br><span class="line">@Builder</span><br><span class="line">class SearchResult&lt;T&gt; &#123;</span><br><span class="line">    private List&lt;T&gt; list;</span><br><span class="line">    private Long total;</span><br><span class="line">    private Integer page;</span><br><span class="line">    private Integer size;</span><br><span class="line">    private Integer pages;</span><br><span class="line">    private Double tookTime;</span><br><span class="line">    private SearchAggregation aggregation;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æœç´¢èšåˆVO</span><br><span class="line">@Data</span><br><span class="line">class SearchAggregation &#123;</span><br><span class="line">    private List&lt;Bucket&gt; brands;</span><br><span class="line">    private List&lt;Bucket&gt; categories;</span><br><span class="line">    private PriceRange priceRange;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// èšåˆæ¡¶</span><br><span class="line">@Data</span><br><span class="line">@AllArgsConstructor</span><br><span class="line">class Bucket &#123;</span><br><span class="line">    private String key;</span><br><span class="line">    private Long count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// ä»·æ ¼èŒƒå›´</span><br><span class="line">@Data</span><br><span class="line">class PriceRange &#123;</span><br><span class="line">    private Double min;</span><br><span class="line">    private Double max;</span><br><span class="line">    private Double avg;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æœç´¢å»ºè®®</span><br><span class="line">@Data</span><br><span class="line">@Builder</span><br><span class="line">class SearchSuggest &#123;</span><br><span class="line">    private String text;</span><br><span class="line">    private Float score;</span><br><span class="line">    private String type;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºç¯‡å¹…é™åˆ¶ï¼Œæˆ‘å…ˆå±•ç¤ºç¬¬10å¤©çš„ElasticsearchåŸºç¡€é›†æˆå’Œå•†å“æœç´¢æ ¸å¿ƒåŠŸèƒ½å®ç°ã€‚ç¬¬11å¤©æˆ‘ä»¬å°†é‡ç‚¹å®ç°ï¼š</p><ol><li><strong>æœç´¢æœåŠ¡Controllerå’ŒAPI</strong></li><li><strong>åŒä¹‰è¯æœç´¢å’Œæ‹¼éŸ³æœç´¢</strong></li><li><strong>æœç´¢ç»“æœä¼˜åŒ–å’Œç›¸å…³æ€§æ’åº</strong></li><li><strong>æœç´¢æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–</strong></li><li><strong>æœç´¢æœåŠ¡æµ‹è¯•</strong></li></ol><p>æ˜¯å¦ç»§ç»­ç¬¬11å¤©çš„å®ç°ï¼Ÿ</p><p>ç»§ç»­</p><p>æˆ‘ä»¬ç»§ç»­ç¬¬11å¤©çš„å†…å®¹ï¼šå®Œæˆæœç´¢æœåŠ¡çš„Controllerã€APIã€ä»¥åŠé«˜çº§æœç´¢åŠŸèƒ½ã€‚<br>ç”±äºç¯‡å¹…é™åˆ¶ï¼Œæˆ‘ä»¬å°†é‡ç‚¹å±•ç¤ºæœç´¢æœåŠ¡çš„Controllerã€åŒä¹‰è¯æœç´¢ã€æ‹¼éŸ³æœç´¢ã€ä»¥åŠæœç´¢æ€§èƒ½ç›‘æ§ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºæœç´¢æœåŠ¡çš„Controllerï¼Œæä¾›æœç´¢APIæ¥å£ã€‚</p><h1 id="ğŸ”-ç¬¬å››é˜¶æ®µï¼šæœç´¢æœåŠ¡å®ç°ï¼ˆç¬¬11å¤©ï¼‰"><a href="#ğŸ”-ç¬¬å››é˜¶æ®µï¼šæœç´¢æœåŠ¡å®ç°ï¼ˆç¬¬11å¤©ï¼‰" class="headerlink" title="ğŸ” ç¬¬å››é˜¶æ®µï¼šæœç´¢æœåŠ¡å®ç°ï¼ˆç¬¬11å¤©ï¼‰"></a>ğŸ” ç¬¬å››é˜¶æ®µï¼šæœç´¢æœåŠ¡å®ç°ï¼ˆç¬¬11å¤©ï¼‰</h1><h2 id="ç¬¬11å¤©ï¼šæœç´¢API-é«˜çº§åŠŸèƒ½-æ€§èƒ½ç›‘æ§"><a href="#ç¬¬11å¤©ï¼šæœç´¢API-é«˜çº§åŠŸèƒ½-æ€§èƒ½ç›‘æ§" class="headerlink" title="ç¬¬11å¤©ï¼šæœç´¢API + é«˜çº§åŠŸèƒ½ + æ€§èƒ½ç›‘æ§"></a>ç¬¬11å¤©ï¼šæœç´¢API + é«˜çº§åŠŸèƒ½ + æ€§èƒ½ç›‘æ§</h2><h3 id="1-æœç´¢æœåŠ¡Controllerå’ŒAPI"><a href="#1-æœç´¢æœåŠ¡Controllerå’ŒAPI" class="headerlink" title="1. æœç´¢æœåŠ¡Controllerå’ŒAPI"></a>1. æœç´¢æœåŠ¡Controllerå’ŒAPI</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.search.controller;</span><br><span class="line"></span><br><span class="line">import com.shophub.common.result.Result;</span><br><span class="line">import com.shophub.search.service.ProductSearchService;</span><br><span class="line">import com.shophub.search.vo.*;</span><br><span class="line">import io.swagger.annotations.Api;</span><br><span class="line">import io.swagger.annotations.ApiOperation;</span><br><span class="line">import io.swagger.annotations.ApiParam;</span><br><span class="line">import lombok.RequiredArgsConstructor;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.springframework.validation.annotation.Validated;</span><br><span class="line">import org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line">import javax.validation.Valid;</span><br><span class="line">import javax.validation.constraints.Max;</span><br><span class="line">import javax.validation.constraints.Min;</span><br><span class="line">import java.math.BigDecimal;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@Validated</span><br><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;/api/search&quot;)</span><br><span class="line">@RequiredArgsConstructor</span><br><span class="line">@Api(tags = &quot;å•†å“æœç´¢æœåŠ¡&quot;)</span><br><span class="line">public class ProductSearchController &#123;</span><br><span class="line">    </span><br><span class="line">    private final ProductSearchService productSearchService;</span><br><span class="line">    private final SearchLogService searchLogService;</span><br><span class="line">    private final SearchAnalyticsService searchAnalyticsService;</span><br><span class="line">    </span><br><span class="line">    @GetMapping(&quot;/simple&quot;)</span><br><span class="line">    @ApiOperation(&quot;ç®€å•æœç´¢&quot;)</span><br><span class="line">    public Result&lt;SearchResult&lt;ProductDocument&gt;&gt; simpleSearch(</span><br><span class="line">            @RequestParam(required = false) String keyword,</span><br><span class="line">            @RequestParam(defaultValue = &quot;1&quot;) @Min(1) Integer page,</span><br><span class="line">            @RequestParam(defaultValue = &quot;20&quot;) @Min(1) @Max(100) Integer size,</span><br><span class="line">            @RequestParam(required = false) String sortBy,</span><br><span class="line">            @RequestParam(required = false) String sortOrder) &#123;</span><br><span class="line">        </span><br><span class="line">        SearchRequest request = SearchRequest.builder()</span><br><span class="line">                .keyword(keyword)</span><br><span class="line">                .page(page)</span><br><span class="line">                .size(size)</span><br><span class="line">                .sortBy(sortBy)</span><br><span class="line">                .sortOrder(sortOrder)</span><br><span class="line">                .build();</span><br><span class="line">        </span><br><span class="line">        SearchResult&lt;ProductDocument&gt; result = productSearchService.search(request);</span><br><span class="line">        return Result.success(result);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @PostMapping(&quot;/advanced&quot;)</span><br><span class="line">    @ApiOperation(&quot;é«˜çº§æœç´¢&quot;)</span><br><span class="line">    public Result&lt;SearchResult&lt;ProductDocument&gt;&gt; advancedSearch(</span><br><span class="line">            @RequestBody @Valid AdvancedSearchRequest request) &#123;</span><br><span class="line">        </span><br><span class="line">        log.info(&quot;é«˜çº§æœç´¢è¯·æ±‚ï¼š&#123;&#125;&quot;, request);</span><br><span class="line">        SearchResult&lt;ProductDocument&gt; result = productSearchService.advancedSearch(request);</span><br><span class="line">        return Result.success(result);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @GetMapping(&quot;/suggest&quot;)</span><br><span class="line">    @ApiOperation(&quot;æœç´¢å»ºè®®ï¼ˆè‡ªåŠ¨è¡¥å…¨ï¼‰&quot;)</span><br><span class="line">    public Result&lt;List&lt;SearchSuggest&gt;&gt; getSearchSuggest(</span><br><span class="line">            @RequestParam String keyword,</span><br><span class="line">            @RequestParam(defaultValue = &quot;10&quot;) @Min(1) @Max(20) Integer size) &#123;</span><br><span class="line">        </span><br><span class="line">        List&lt;SearchSuggest&gt; suggests = productSearchService.getSearchSuggestions(keyword, size);</span><br><span class="line">        return Result.success(suggests);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @GetMapping(&quot;/aggregation&quot;)</span><br><span class="line">    @ApiOperation(&quot;è·å–æœç´¢èšåˆç»“æœ&quot;)</span><br><span class="line">    public Result&lt;SearchAggregation&gt; getSearchAggregation(</span><br><span class="line">            @RequestParam(required = false) String keyword,</span><br><span class="line">            @RequestParam(required = false) Long categoryId,</span><br><span class="line">            @RequestParam(required = false) BigDecimal minPrice,</span><br><span class="line">            @RequestParam(required = false) BigDecimal maxPrice,</span><br><span class="line">            @RequestParam(required = false) String brand) &#123;</span><br><span class="line">        </span><br><span class="line">        SearchRequest request = SearchRequest.builder()</span><br><span class="line">                .keyword(keyword)</span><br><span class="line">                .categoryId(categoryId)</span><br><span class="line">                .minPrice(minPrice)</span><br><span class="line">                .maxPrice(maxPrice)</span><br><span class="line">                .brand(brand)</span><br><span class="line">                .build();</span><br><span class="line">        </span><br><span class="line">        SearchAggregation aggregation = productSearchService.getSearchAggregation(request);</span><br><span class="line">        return Result.success(aggregation);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @GetMapping(&quot;/hot-keywords&quot;)</span><br><span class="line">    @ApiOperation(&quot;è·å–çƒ­æœå…³é”®è¯&quot;)</span><br><span class="line">    public Result&lt;List&lt;HotKeyword&gt;&gt; getHotKeywords(</span><br><span class="line">            @RequestParam(defaultValue = &quot;10&quot;) @Min(1) @Max(50) Integer size,</span><br><span class="line">            @RequestParam(required = false) String period) &#123;</span><br><span class="line">        </span><br><span class="line">        List&lt;HotKeyword&gt; hotKeywords = searchAnalyticsService.getHotKeywords(size, period);</span><br><span class="line">        return Result.success(hotKeywords);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @GetMapping(&quot;/related-keywords&quot;)</span><br><span class="line">    @ApiOperation(&quot;è·å–ç›¸å…³æœç´¢è¯&quot;)</span><br><span class="line">    public Result&lt;List&lt;String&gt;&gt; getRelatedKeywords(</span><br><span class="line">            @RequestParam String keyword,</span><br><span class="line">            @RequestParam(defaultValue = &quot;10&quot;) @Min(1) @Max(20) Integer size) &#123;</span><br><span class="line">        </span><br><span class="line">        List&lt;String&gt; relatedKeywords = searchAnalyticsService.getRelatedKeywords(keyword, size);</span><br><span class="line">        return Result.success(relatedKeywords);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @GetMapping(&quot;/zero-result-suggest&quot;)</span><br><span class="line">    @ApiOperation(&quot;é›¶ç»“æœæœç´¢å»ºè®®&quot;)</span><br><span class="line">    public Result&lt;ZeroResultSuggest&gt; getZeroResultSuggest(</span><br><span class="line">            @RequestParam String keyword) &#123;</span><br><span class="line">        </span><br><span class="line">        ZeroResultSuggest suggest = searchAnalyticsService.getZeroResultSuggest(keyword);</span><br><span class="line">        return Result.success(suggest);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @PostMapping(&quot;/sync/&#123;productId&#125;&quot;)</span><br><span class="line">    @ApiOperation(&quot;åŒæ­¥å•ä¸ªå•†å“åˆ°æœç´¢ç´¢å¼•&quot;)</span><br><span class="line">    public Result&lt;Boolean&gt; syncProductToSearch(</span><br><span class="line">            @PathVariable Long productId) &#123;</span><br><span class="line">        </span><br><span class="line">        boolean success = productSearchService.syncProductToEs(productId);</span><br><span class="line">        return Result.success(success);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @PostMapping(&quot;/sync/batch&quot;)</span><br><span class="line">    @ApiOperation(&quot;æ‰¹é‡åŒæ­¥å•†å“åˆ°æœç´¢ç´¢å¼•&quot;)</span><br><span class="line">    public Result&lt;Boolean&gt; batchSyncProducts(</span><br><span class="line">            @RequestBody List&lt;Long&gt; productIds) &#123;</span><br><span class="line">        </span><br><span class="line">        productSearchService.batchSyncProducts(productIds);</span><br><span class="line">        return Result.success(true);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @PostMapping(&quot;/index/rebuild&quot;)</span><br><span class="line">    @ApiOperation(&quot;é‡å»ºå•†å“æœç´¢ç´¢å¼•&quot;)</span><br><span class="line">    public Result&lt;Boolean&gt; rebuildProductIndex() &#123;</span><br><span class="line">        </span><br><span class="line">        boolean success = productSearchService.rebuildProductIndex();</span><br><span class="line">        return Result.success(success);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @GetMapping(&quot;/index/status&quot;)</span><br><span class="line">    @ApiOperation(&quot;è·å–ç´¢å¼•çŠ¶æ€&quot;)</span><br><span class="line">    public Result&lt;IndexStatus&gt; getIndexStatus() &#123;</span><br><span class="line">        </span><br><span class="line">        IndexStatus status = productSearchService.getIndexStatus();</span><br><span class="line">        return Result.success(status);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @GetMapping(&quot;/health&quot;)</span><br><span class="line">    @ApiOperation(&quot;æœç´¢æœåŠ¡å¥åº·æ£€æŸ¥&quot;)</span><br><span class="line">    public Result&lt;SearchHealth&gt; healthCheck() &#123;</span><br><span class="line">        </span><br><span class="line">        SearchHealth health = productSearchService.healthCheck();</span><br><span class="line">        return Result.success(health);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @GetMapping(&quot;/stats&quot;)</span><br><span class="line">    @ApiOperation(&quot;æœç´¢æœåŠ¡ç»Ÿè®¡ä¿¡æ¯&quot;)</span><br><span class="line">    public Result&lt;SearchStats&gt; getSearchStats(</span><br><span class="line">            @RequestParam(required = false) String startTime,</span><br><span class="line">            @RequestParam(required = false) String endTime) &#123;</span><br><span class="line">        </span><br><span class="line">        SearchStats stats = searchAnalyticsService.getSearchStats(startTime, endTime);</span><br><span class="line">        return Result.success(stats);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @GetMapping(&quot;/logs&quot;)</span><br><span class="line">    @ApiOperation(&quot;æŸ¥è¯¢æœç´¢æ—¥å¿—&quot;)</span><br><span class="line">    public Result&lt;PageResult&lt;ProductSearchLog&gt;&gt; getSearchLogs(</span><br><span class="line">            @RequestParam(defaultValue = &quot;1&quot;) @Min(1) Integer page,</span><br><span class="line">            @RequestParam(defaultValue = &quot;20&quot;) @Min(1) @Max(100) Integer size,</span><br><span class="line">            @RequestParam(required = false) String keyword,</span><br><span class="line">            @RequestParam(required = false) Long userId,</span><br><span class="line">            @RequestParam(required = false) String searchType) &#123;</span><br><span class="line">        </span><br><span class="line">        PageResult&lt;ProductSearchLog&gt; logs = searchLogService.getSearchLogs(</span><br><span class="line">                page, size, keyword, userId, searchType);</span><br><span class="line">        return Result.success(logs);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @GetMapping(&quot;/debug/query&quot;)</span><br><span class="line">    @ApiOperation(&quot;è°ƒè¯•æŸ¥è¯¢ - æ˜¾ç¤ºESå®é™…æŸ¥è¯¢è¯­å¥&quot;)</span><br><span class="line">    public Result&lt;DebugQueryResult&gt; debugQuery(</span><br><span class="line">            @RequestParam String keyword,</span><br><span class="line">            @RequestParam(defaultValue = &quot;1&quot;) @Min(1) Integer page,</span><br><span class="line">            @RequestParam(defaultValue = &quot;20&quot;) @Min(1) @Max(100) Integer size) &#123;</span><br><span class="line">        </span><br><span class="line">        DebugQueryResult result = productSearchService.debugQuery(keyword, page, size);</span><br><span class="line">        return Result.success(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// ç´¢å¼•çŠ¶æ€VO</span><br><span class="line">@Data</span><br><span class="line">@Builder</span><br><span class="line">class IndexStatus &#123;</span><br><span class="line">    private String indexName;</span><br><span class="line">    private Long documentCount;</span><br><span class="line">    private Long indexSize;</span><br><span class="line">    private String health;</span><br><span class="line">    private String status;</span><br><span class="line">    private Integer numberOfShards;</span><br><span class="line">    private Integer numberOfReplicas;</span><br><span class="line">    private LocalDateTime lastRefreshTime;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æœç´¢å¥åº·æ£€æŸ¥VO</span><br><span class="line">@Data</span><br><span class="line">@Builder</span><br><span class="line">class SearchHealth &#123;</span><br><span class="line">    private boolean elasticsearchConnected;</span><br><span class="line">    private boolean redisConnected;</span><br><span class="line">    private boolean mysqlConnected;</span><br><span class="line">    private double elasticsearchResponseTime;</span><br><span class="line">    private double cacheHitRate;</span><br><span class="line">    private Map&lt;String, Object&gt; details;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æœç´¢ç»Ÿè®¡VO</span><br><span class="line">@Data</span><br><span class="line">@Builder</span><br><span class="line">class SearchStats &#123;</span><br><span class="line">    private Long totalSearches;</span><br><span class="line">    private Long uniqueUsers;</span><br><span class="line">    private Double avgResponseTime;</span><br><span class="line">    private Double successRate;</span><br><span class="line">    private Long zeroResultSearches;</span><br><span class="line">    private Map&lt;String, Long&gt; searchesByHour;</span><br><span class="line">    private List&lt;TopKeyword&gt; topKeywords;</span><br><span class="line">    private List&lt;TopCategory&gt; topCategories;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// è°ƒè¯•æŸ¥è¯¢ç»“æœVO</span><br><span class="line">@Data</span><br><span class="line">@Builder</span><br><span class="line">class DebugQueryResult &#123;</span><br><span class="line">    private String queryString;</span><br><span class="line">    private String explanation;</span><br><span class="line">    private List&lt;ProductDocument&gt; results;</span><br><span class="line">    private Long tookTime;</span><br><span class="line">    private Long totalHits;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// çƒ­æœå…³é”®è¯VO</span><br><span class="line">@Data</span><br><span class="line">@Builder</span><br><span class="line">class HotKeyword &#123;</span><br><span class="line">    private String keyword;</span><br><span class="line">    private Long searchCount;</span><br><span class="line">    private Long trend; // è¶‹åŠ¿ï¼š1ä¸Šå‡ï¼Œ-1ä¸‹é™ï¼Œ0å¹³ç¨³</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// é›¶ç»“æœå»ºè®®VO</span><br><span class="line">@Data</span><br><span class="line">@Builder</span><br><span class="line">class ZeroResultSuggest &#123;</span><br><span class="line">    private String originalKeyword;</span><br><span class="line">    private List&lt;String&gt; suggestedKeywords;</span><br><span class="line">    private List&lt;String&gt; relatedCategories;</span><br><span class="line">    private List&lt;String&gt; popularProducts;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-åŒä¹‰è¯æœç´¢å’Œæ‹¼éŸ³æœç´¢å¢å¼º"><a href="#2-åŒä¹‰è¯æœç´¢å’Œæ‹¼éŸ³æœç´¢å¢å¼º" class="headerlink" title="2. åŒä¹‰è¯æœç´¢å’Œæ‹¼éŸ³æœç´¢å¢å¼º"></a>2. åŒä¹‰è¯æœç´¢å’Œæ‹¼éŸ³æœç´¢å¢å¼º</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.search.service.impl;</span><br><span class="line"></span><br><span class="line">import com.shophub.search.service.SynonymSearchService;</span><br><span class="line">import lombok.RequiredArgsConstructor;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.apache.commons.lang3.StringUtils;</span><br><span class="line">import org.elasticsearch.index.query.BoolQueryBuilder;</span><br><span class="line">import org.elasticsearch.index.query.QueryBuilders;</span><br><span class="line">import org.springframework.data.elasticsearch.core.ElasticsearchRestTemplate;</span><br><span class="line">import org.springframework.data.elasticsearch.core.SearchHits;</span><br><span class="line">import org.springframework.data.elasticsearch.core.query.NativeSearchQueryBuilder;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line">import javax.annotation.PostConstruct;</span><br><span class="line">import java.io.BufferedReader;</span><br><span class="line">import java.io.InputStream;</span><br><span class="line">import java.io.InputStreamReader;</span><br><span class="line">import java.nio.charset.StandardCharsets;</span><br><span class="line">import java.util.*;</span><br><span class="line">import java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@Service</span><br><span class="line">@RequiredArgsConstructor</span><br><span class="line">public class SynonymSearchServiceImpl implements SynonymSearchService &#123;</span><br><span class="line">    </span><br><span class="line">    private final ElasticsearchRestTemplate elasticsearchRestTemplate;</span><br><span class="line">    </span><br><span class="line">    // åŒä¹‰è¯è¯å…¸</span><br><span class="line">    private final Map&lt;String, Set&lt;String&gt;&gt; synonymDict = new ConcurrentHashMap&lt;&gt;();</span><br><span class="line">    private final Map&lt;String, String&gt; pinyinDict = new ConcurrentHashMap&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    @PostConstruct</span><br><span class="line">    public void init() &#123;</span><br><span class="line">        loadSynonyms();</span><br><span class="line">        log.info(&quot;åŒä¹‰è¯è¯å…¸åŠ è½½å®Œæˆï¼Œå…±&#123;&#125;ä¸ªè¯æ¡&quot;, synonymDict.size());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åŠ è½½åŒä¹‰è¯è¯å…¸</span><br><span class="line">     */</span><br><span class="line">    private void loadSynonyms() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            InputStream is = getClass().getClassLoader().getResourceAsStream(&quot;synonyms/synonyms.txt&quot;);</span><br><span class="line">            if (is != null) &#123;</span><br><span class="line">                BufferedReader reader = new BufferedReader(new InputStreamReader(is, StandardCharsets.UTF_8));</span><br><span class="line">                String line;</span><br><span class="line">                while ((line = reader.readLine()) != null) &#123;</span><br><span class="line">                    line = line.trim();</span><br><span class="line">                    if (line.isEmpty() || line.startsWith(&quot;#&quot;)) &#123;</span><br><span class="line">                        continue;</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    String[] parts = line.split(&quot;=&gt;&quot;);</span><br><span class="line">                    if (parts.length == 2) &#123;</span><br><span class="line">                        String key = parts[0].trim();</span><br><span class="line">                        String[] synonyms = parts[1].split(&quot;,&quot;);</span><br><span class="line">                        </span><br><span class="line">                        Set&lt;String&gt; synonymSet = new HashSet&lt;&gt;();</span><br><span class="line">                        for (String synonym : synonyms) &#123;</span><br><span class="line">                            synonymSet.add(synonym.trim());</span><br><span class="line">                        &#125;</span><br><span class="line">                        synonymDict.put(key, synonymSet);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                reader.close();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // åŠ è½½æ‰©å±•åŒä¹‰è¯</span><br><span class="line">            loadExtendedSynonyms();</span><br><span class="line">            </span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;åŠ è½½åŒä¹‰è¯è¯å…¸å¤±è´¥&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åŠ è½½æ‰©å±•åŒä¹‰è¯ï¼ˆå“ç‰Œã€å“ç±»ç­‰ï¼‰</span><br><span class="line">     */</span><br><span class="line">    private void loadExtendedSynonyms() &#123;</span><br><span class="line">        // å“ç‰ŒåŒä¹‰è¯</span><br><span class="line">        addBrandSynonyms();</span><br><span class="line">        </span><br><span class="line">        // å“ç±»åŒä¹‰è¯</span><br><span class="line">        addCategorySynonyms();</span><br><span class="line">        </span><br><span class="line">        // è§„æ ¼åŒä¹‰è¯</span><br><span class="line">        addSpecSynonyms();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ‰©å±•åŒä¹‰è¯æœç´¢</span><br><span class="line">     */</span><br><span class="line">    public SearchHits&lt;ProductDocument&gt; searchWithSynonyms(String keyword, int page, int size) &#123;</span><br><span class="line">        // è·å–åŒä¹‰è¯</span><br><span class="line">        Set&lt;String&gt; allKeywords = expandWithSynonyms(keyword);</span><br><span class="line">        </span><br><span class="line">        // æ„å»ºæŸ¥è¯¢</span><br><span class="line">        BoolQueryBuilder boolQuery = QueryBuilders.boolQuery();</span><br><span class="line">        </span><br><span class="line">        // ä¸»å…³é”®è¯æŸ¥è¯¢ï¼ˆæƒé‡æœ€é«˜ï¼‰</span><br><span class="line">        boolQuery.should(QueryBuilders.multiMatchQuery(keyword)</span><br><span class="line">                .field(&quot;productName&quot;, 5.0f)</span><br><span class="line">                .field(&quot;categoryName&quot;, 3.0f)</span><br><span class="line">                .field(&quot;brand&quot;, 3.0f)</span><br><span class="line">                .field(&quot;detail&quot;, 1.0f)</span><br><span class="line">                .field(&quot;combined&quot;, 1.0f));</span><br><span class="line">        </span><br><span class="line">        // åŒä¹‰è¯æŸ¥è¯¢ï¼ˆæƒé‡è¾ƒä½ï¼‰</span><br><span class="line">        for (String synonym : allKeywords) &#123;</span><br><span class="line">            if (!synonym.equals(keyword)) &#123;</span><br><span class="line">                boolQuery.should(QueryBuilders.multiMatchQuery(synonym)</span><br><span class="line">                        .field(&quot;productName&quot;, 2.0f)</span><br><span class="line">                        .field(&quot;categoryName&quot;, 1.5f)</span><br><span class="line">                        .field(&quot;brand&quot;, 1.5f)</span><br><span class="line">                        .field(&quot;detail&quot;, 0.5f)</span><br><span class="line">                        .field(&quot;combined&quot;, 0.5f));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // æ‹¼éŸ³æŸ¥è¯¢ï¼ˆæƒé‡æœ€ä½ï¼‰</span><br><span class="line">        String pinyin = convertToPinyin(keyword);</span><br><span class="line">        if (StringUtils.isNotBlank(pinyin)) &#123;</span><br><span class="line">            boolQuery.should(QueryBuilders.multiMatchQuery(pinyin)</span><br><span class="line">                    .field(&quot;productName.pinyin&quot;, 1.0f)</span><br><span class="line">                    .field(&quot;brand.pinyin&quot;, 0.5f)</span><br><span class="line">                    .field(&quot;productNo.pinyin&quot;, 0.3f));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // è®¾ç½®æœ€å°åŒ¹é…æ•°é‡</span><br><span class="line">        boolQuery.minimumShouldMatch(1);</span><br><span class="line">        </span><br><span class="line">        // æ„å»ºæŸ¥è¯¢</span><br><span class="line">        NativeSearchQueryBuilder queryBuilder = new NativeSearchQueryBuilder()</span><br><span class="line">                .withQuery(boolQuery)</span><br><span class="line">                .withPageable(org.springframework.data.domain.PageRequest.of(page, size));</span><br><span class="line">        </span><br><span class="line">        return elasticsearchRestTemplate.search(queryBuilder.build(), ProductDocument.class);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ‰©å±•åŒä¹‰è¯</span><br><span class="line">     */</span><br><span class="line">    private Set&lt;String&gt; expandWithSynonyms(String keyword) &#123;</span><br><span class="line">        Set&lt;String&gt; expanded = new HashSet&lt;&gt;();</span><br><span class="line">        expanded.add(keyword);</span><br><span class="line">        </span><br><span class="line">        // æŸ¥æ‰¾ç›´æ¥åŒä¹‰è¯</span><br><span class="line">        for (Map.Entry&lt;String, Set&lt;String&gt;&gt; entry : synonymDict.entrySet()) &#123;</span><br><span class="line">            if (entry.getValue().contains(keyword)) &#123;</span><br><span class="line">                expanded.add(entry.getKey());</span><br><span class="line">                expanded.addAll(entry.getValue());</span><br><span class="line">            &#125; else if (entry.getKey().equals(keyword)) &#123;</span><br><span class="line">                expanded.addAll(entry.getValue());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // æŸ¥æ‰¾åŒ…å«å…³ç³»çš„åŒä¹‰è¯</span><br><span class="line">        for (Map.Entry&lt;String, Set&lt;String&gt;&gt; entry : synonymDict.entrySet()) &#123;</span><br><span class="line">            for (String synonym : entry.getValue()) &#123;</span><br><span class="line">                if (keyword.contains(synonym) || synonym.contains(keyword)) &#123;</span><br><span class="line">                    expanded.add(entry.getKey());</span><br><span class="line">                    expanded.addAll(entry.getValue());</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return expanded;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ™ºèƒ½çº é”™æœç´¢</span><br><span class="line">     */</span><br><span class="line">    public SearchHits&lt;ProductDocument&gt; searchWithSpellCheck(String keyword, int page, int size) &#123;</span><br><span class="line">        // 1. å…ˆå°è¯•ç›´æ¥æœç´¢</span><br><span class="line">        SearchHits&lt;ProductDocument&gt; hits = searchWithSynonyms(keyword, page, size);</span><br><span class="line">        </span><br><span class="line">        // 2. å¦‚æœç»“æœå¤ªå°‘ï¼Œè¿›è¡Œæ‹¼å†™çº æ­£</span><br><span class="line">        if (hits.getTotalHits() &lt; 5) &#123;</span><br><span class="line">            String corrected = spellCheck(keyword);</span><br><span class="line">            if (!corrected.equals(keyword)) &#123;</span><br><span class="line">                log.info(&quot;æ‹¼å†™çº æ­£ï¼š&#123;&#125; -&gt; &#123;&#125;&quot;, keyword, corrected);</span><br><span class="line">                hits = searchWithSynonyms(corrected, page, size);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return hits;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * ç®€å•æ‹¼å†™çº æ­£</span><br><span class="line">     */</span><br><span class="line">    private String spellCheck(String keyword) &#123;</span><br><span class="line">        // è¿™é‡Œå¯ä»¥é›†æˆæ›´å¤æ‚çš„æ‹¼å†™çº æ­£ç®—æ³•</span><br><span class="line">        // ä¾‹å¦‚ï¼šBKæ ‘ã€ç¼–è¾‘è·ç¦»ç­‰</span><br><span class="line">        </span><br><span class="line">        // ç®€å•å®ç°ï¼šå¸¸è§æ‹¼å†™é”™è¯¯æ˜ å°„</span><br><span class="line">        Map&lt;String, String&gt; commonMistakes = new HashMap&lt;&gt;();</span><br><span class="line">        commonMistakes.put(&quot;iphnoe&quot;, &quot;iphone&quot;);</span><br><span class="line">        commonMistakes.put(&quot;samgsung&quot;, &quot;samsung&quot;);</span><br><span class="line">        commonMistakes.put(&quot;xiaom&quot;, &quot;xiaomi&quot;);</span><br><span class="line">        commonMistakes.put(&quot;huawe&quot;, &quot;huawei&quot;);</span><br><span class="line">        </span><br><span class="line">        return commonMistakes.getOrDefault(keyword.toLowerCase(), keyword);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ·»åŠ å“ç‰ŒåŒä¹‰è¯</span><br><span class="line">     */</span><br><span class="line">    private void addBrandSynonyms() &#123;</span><br><span class="line">        synonymDict.computeIfAbsent(&quot;è‹¹æœ&quot;, k -&gt; new HashSet&lt;&gt;()).addAll(</span><br><span class="line">                Arrays.asList(&quot;Apple&quot;, &quot;iphone&quot;, &quot;ipad&quot;, &quot;macbook&quot;, &quot;è‹¹æœæ‰‹æœº&quot;));</span><br><span class="line">        </span><br><span class="line">        synonymDict.computeIfAbsent(&quot;åä¸º&quot;, k -&gt; new HashSet&lt;&gt;()).addAll(</span><br><span class="line">                Arrays.asList(&quot;Huawei&quot;, &quot;è£è€€&quot;, &quot;honor&quot;));</span><br><span class="line">        </span><br><span class="line">        synonymDict.computeIfAbsent(&quot;å°ç±³&quot;, k -&gt; new HashSet&lt;&gt;()).addAll(</span><br><span class="line">                Arrays.asList(&quot;Xiaomi&quot;, &quot;çº¢ç±³&quot;, &quot;Redmi&quot;, &quot;ç±³å®¶&quot;));</span><br><span class="line">        </span><br><span class="line">        synonymDict.computeIfAbsent(&quot;ä¸‰æ˜Ÿ&quot;, k -&gt; new HashSet&lt;&gt;()).addAll(</span><br><span class="line">                Arrays.asList(&quot;Samsung&quot;, &quot;ç›–ä¹ä¸–&quot;, &quot;Galaxy&quot;));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ·»åŠ å“ç±»åŒä¹‰è¯</span><br><span class="line">     */</span><br><span class="line">    private void addCategorySynonyms() &#123;</span><br><span class="line">        synonymDict.computeIfAbsent(&quot;æ‰‹æœº&quot;, k -&gt; new HashSet&lt;&gt;()).addAll(</span><br><span class="line">                Arrays.asList(&quot;æ™ºèƒ½æ‰‹æœº&quot;, &quot;ç§»åŠ¨ç”µè¯&quot;, &quot;cellular phone&quot;, &quot;ç§»åŠ¨è®¾å¤‡&quot;));</span><br><span class="line">        </span><br><span class="line">        synonymDict.computeIfAbsent(&quot;ç¬”è®°æœ¬&quot;, k -&gt; new HashSet&lt;&gt;()).addAll(</span><br><span class="line">                Arrays.asList(&quot;ç¬”è®°æœ¬ç”µè„‘&quot;, &quot;æ‰‹æç”µè„‘&quot;, &quot;laptop&quot;, &quot;notebook&quot;));</span><br><span class="line">        </span><br><span class="line">        synonymDict.computeIfAbsent(&quot;ç”µè§†&quot;, k -&gt; new HashSet&lt;&gt;()).addAll(</span><br><span class="line">                Arrays.asList(&quot;ç”µè§†æœº&quot;, &quot;æ¶²æ™¶ç”µè§†&quot;, &quot;LEDç”µè§†&quot;, &quot;TV&quot;, &quot;television&quot;));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ·»åŠ è§„æ ¼åŒä¹‰è¯</span><br><span class="line">     */</span><br><span class="line">    private void addSpecSynonyms() &#123;</span><br><span class="line">        synonymDict.computeIfAbsent(&quot;å†…å­˜&quot;, k -&gt; new HashSet&lt;&gt;()).addAll(</span><br><span class="line">                Arrays.asList(&quot;RAM&quot;, &quot;è¿è¡Œå†…å­˜&quot;, &quot;éšæœºå­˜å–å­˜å‚¨å™¨&quot;));</span><br><span class="line">        </span><br><span class="line">        synonymDict.computeIfAbsent(&quot;å­˜å‚¨&quot;, k -&gt; new HashSet&lt;&gt;()).addAll(</span><br><span class="line">                Arrays.asList(&quot;ROM&quot;, &quot;é—ªå­˜&quot;, &quot;å­˜å‚¨ç©ºé—´&quot;, &quot;å†…å­˜&quot;));</span><br><span class="line">        </span><br><span class="line">        synonymDict.computeIfAbsent(&quot;ç”µæ± &quot;, k -&gt; new HashSet&lt;&gt;()).addAll(</span><br><span class="line">                Arrays.asList(&quot;è“„ç”µæ± &quot;, &quot;ç”µèŠ¯&quot;, &quot;ç”µæ± å®¹é‡&quot;));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åŠ¨æ€æ·»åŠ åŒä¹‰è¯</span><br><span class="line">     */</span><br><span class="line">    public void addDynamicSynonym(String word, Set&lt;String&gt; synonyms) &#123;</span><br><span class="line">        synonymDict.put(word, synonyms);</span><br><span class="line">        log.info(&quot;åŠ¨æ€æ·»åŠ åŒä¹‰è¯ï¼š&#123;&#125; -&gt; &#123;&#125;&quot;, word, synonyms);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è·å–åŒä¹‰è¯è¯å…¸ç»Ÿè®¡</span><br><span class="line">     */</span><br><span class="line">    public SynonymStats getSynonymStats() &#123;</span><br><span class="line">        int totalWords = synonymDict.size();</span><br><span class="line">        int totalSynonyms = synonymDict.values().stream()</span><br><span class="line">                .mapToInt(Set::size)</span><br><span class="line">                .sum();</span><br><span class="line">        </span><br><span class="line">        return SynonymStats.builder()</span><br><span class="line">                .totalWords(totalWords)</span><br><span class="line">                .totalSynonyms(totalSynonyms)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// åŒä¹‰è¯ç»Ÿè®¡</span><br><span class="line">@Data</span><br><span class="line">@Builder</span><br><span class="line">class SynonymStats &#123;</span><br><span class="line">    private int totalWords;</span><br><span class="line">    private int totalSynonyms;</span><br><span class="line">    private Map&lt;String, Integer&gt; categoryStats;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-æœç´¢ç›¸å…³æ€§ä¼˜åŒ–å’Œæ’åºç­–ç•¥"><a href="#3-æœç´¢ç›¸å…³æ€§ä¼˜åŒ–å’Œæ’åºç­–ç•¥" class="headerlink" title="3. æœç´¢ç›¸å…³æ€§ä¼˜åŒ–å’Œæ’åºç­–ç•¥"></a>3. æœç´¢ç›¸å…³æ€§ä¼˜åŒ–å’Œæ’åºç­–ç•¥</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.search.service.impl;</span><br><span class="line"></span><br><span class="line">import com.shophub.search.service.RelevanceService;</span><br><span class="line">import lombok.RequiredArgsConstructor;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.elasticsearch.common.lucene.search.function.CombineFunction;</span><br><span class="line">import org.elasticsearch.common.lucene.search.function.FieldValueFactorFunction;</span><br><span class="line">import org.elasticsearch.index.query.BoolQueryBuilder;</span><br><span class="line">import org.elasticsearch.index.query.QueryBuilders;</span><br><span class="line">import org.elasticsearch.index.query.functionscore.FunctionScoreQueryBuilder;</span><br><span class="line">import org.elasticsearch.index.query.functionscore.ScoreFunctionBuilders;</span><br><span class="line">import org.elasticsearch.search.sort.SortBuilders;</span><br><span class="line">import org.elasticsearch.search.sort.SortOrder;</span><br><span class="line">import org.springframework.data.elasticsearch.core.query.NativeSearchQueryBuilder;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line">import java.time.LocalDateTime;</span><br><span class="line">import java.time.ZoneOffset;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@Service</span><br><span class="line">@RequiredArgsConstructor</span><br><span class="line">public class RelevanceServiceImpl implements RelevanceService &#123;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ„å»ºç›¸å…³æ€§è¯„åˆ†æŸ¥è¯¢</span><br><span class="line">     */</span><br><span class="line">    public FunctionScoreQueryBuilder buildRelevanceQuery(String keyword) &#123;</span><br><span class="line">        // åŸºç¡€æŸ¥è¯¢</span><br><span class="line">        BoolQueryBuilder boolQuery = QueryBuilders.boolQuery();</span><br><span class="line">        </span><br><span class="line">        if (keyword != null &amp;&amp; !keyword.trim().isEmpty()) &#123;</span><br><span class="line">            // å¤šå­—æ®µåŒ¹é…</span><br><span class="line">            boolQuery.must(QueryBuilders.multiMatchQuery(keyword)</span><br><span class="line">                    .field(&quot;productName&quot;, 5.0f)</span><br><span class="line">                    .field(&quot;categoryName&quot;, 3.0f)</span><br><span class="line">                    .field(&quot;brand&quot;, 3.0f)</span><br><span class="line">                    .field(&quot;detail&quot;, 1.0f)</span><br><span class="line">                    .field(&quot;combined&quot;, 1.0f)</span><br><span class="line">                    .type(org.elasticsearch.index.query.MultiMatchQueryBuilder.Type.BEST_FIELDS)</span><br><span class="line">                    .fuzziness(&quot;AUTO&quot;));</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            boolQuery.must(QueryBuilders.matchAllQuery());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // åªæŸ¥è¯¢ä¸Šæ¶å•†å“</span><br><span class="line">        boolQuery.filter(QueryBuilders.termQuery(&quot;status&quot;, 1));</span><br><span class="line">        </span><br><span class="line">        // å‡½æ•°è¯„åˆ† - å¤šç§å› ç´ å½±å“ç›¸å…³æ€§</span><br><span class="line">        FunctionScoreQueryBuilder.FilterFunctionBuilder[] functions = &#123;</span><br><span class="line">            // 1. é”€é‡å› ç´ ï¼ˆå¯¹æ•°å‡½æ•°ï¼Œé˜²æ­¢é”€é‡è¿‡é«˜å•†å“å®Œå…¨å æ®å‰æ’ï¼‰</span><br><span class="line">            new FunctionScoreQueryBuilder.FilterFunctionBuilder(</span><br><span class="line">                ScoreFunctionBuilders.fieldValueFactorFunction(&quot;saleCount&quot;)</span><br><span class="line">                    .factor(0.1f)</span><br><span class="line">                    .modifier(FieldValueFactorFunction.Modifier.LOG1P)</span><br><span class="line">                    .missing(1)</span><br><span class="line">            ),</span><br><span class="line">            </span><br><span class="line">            // 2. è¯„åˆ†å› ç´ </span><br><span class="line">            new FunctionScoreQueryBuilder.FilterFunctionBuilder(</span><br><span class="line">                ScoreFunctionBuilders.fieldValueFactorFunction(&quot;score&quot;)</span><br><span class="line">                    .factor(0.2f)</span><br><span class="line">                    .modifier(FieldValueFactorFunction.Modifier.LOG1P)</span><br><span class="line">                    .missing(3)</span><br><span class="line">            ),</span><br><span class="line">            </span><br><span class="line">            // 3. æ–°å“å› ç´ ï¼ˆæ–°å“æœ‰åŠ åˆ†ï¼‰</span><br><span class="line">            new FunctionScoreQueryBuilder.FilterFunctionBuilder(</span><br><span class="line">                ScoreFunctionBuilders.fieldValueFactorFunction(&quot;isNew&quot;)</span><br><span class="line">                    .factor(0.3f)</span><br><span class="line">                    .missing(0)</span><br><span class="line">            ),</span><br><span class="line">            </span><br><span class="line">            // 4. çƒ­é”€å› ç´ </span><br><span class="line">            new FunctionScoreQueryBuilder.FilterFunctionBuilder(</span><br><span class="line">                ScoreFunctionBuilders.fieldValueFactorFunction(&quot;isHot&quot;)</span><br><span class="line">                    .factor(0.2f)</span><br><span class="line">                    .missing(0)</span><br><span class="line">            ),</span><br><span class="line">            </span><br><span class="line">            // 5. æ—¶æ•ˆæ€§å› ç´ ï¼ˆæ–°å“ä¼˜å…ˆï¼‰</span><br><span class="line">            new FunctionScoreQueryBuilder.FilterFunctionBuilder(</span><br><span class="line">                ScoreFunctionBuilders.gaussDecayFunction(</span><br><span class="line">                    &quot;createTime&quot;, </span><br><span class="line">                    LocalDateTime.now().atOffset(ZoneOffset.ofHours(8)).toString(),</span><br><span class="line">                    &quot;30d&quot;, </span><br><span class="line">                    &quot;15d&quot;, </span><br><span class="line">                    0.5</span><br><span class="line">                )</span><br><span class="line">            ),</span><br><span class="line">            </span><br><span class="line">            // 6. åº“å­˜å› ç´ ï¼ˆæœ‰åº“å­˜çš„å•†å“ä¼˜å…ˆï¼‰</span><br><span class="line">            new FunctionScoreQueryBuilder.FilterFunctionBuilder(</span><br><span class="line">                ScoreFunctionBuilders.scriptFunction(</span><br><span class="line">                    &quot;Math.min(doc[&#x27;stock&#x27;].value, 100) / 100.0&quot;</span><br><span class="line">                )</span><br><span class="line">            ),</span><br><span class="line">            </span><br><span class="line">            // 7. ä¸ªæ€§åŒ–å› ç´ ï¼ˆå¯æ ¹æ®ç”¨æˆ·è¡Œä¸ºè°ƒæ•´ï¼‰</span><br><span class="line">            new FunctionScoreQueryBuilder.FilterFunctionBuilder(</span><br><span class="line">                ScoreFunctionBuilders.weightFactorFunction(1.0f) // å ä½ï¼Œå®é™…å¯åŠ¨æ€è°ƒæ•´</span><br><span class="line">            )</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        // æ„å»ºå‡½æ•°è¯„åˆ†æŸ¥è¯¢</span><br><span class="line">        return QueryBuilders.functionScoreQuery(boolQuery, functions)</span><br><span class="line">                .scoreMode(FunctionScoreQueryBuilder.ScoreMode.SUM)</span><br><span class="line">                .boostMode(CombineFunction.SUM)</span><br><span class="line">                .maxBoost(10.0f);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è·å–ä¸åŒåœºæ™¯çš„æ’åºç­–ç•¥</span><br><span class="line">     */</span><br><span class="line">    public NativeSearchQueryBuilder applySortStrategy(</span><br><span class="line">            NativeSearchQueryBuilder queryBuilder, </span><br><span class="line">            String sortType,</span><br><span class="line">            String keyword) &#123;</span><br><span class="line">        </span><br><span class="line">        switch (sortType) &#123;</span><br><span class="line">            case &quot;relevance&quot;: // ç›¸å…³æ€§æ’åºï¼ˆé»˜è®¤ï¼‰</span><br><span class="line">                // å·²ç»é€šè¿‡å‡½æ•°è¯„åˆ†å®ç°ï¼Œä¸éœ€è¦é¢å¤–æ’åº</span><br><span class="line">                break;</span><br><span class="line">                </span><br><span class="line">            case &quot;sales&quot;: // é”€é‡æ’åº</span><br><span class="line">                queryBuilder.withSort(SortBuilders.fieldSort(&quot;saleCount&quot;).order(SortOrder.DESC));</span><br><span class="line">                break;</span><br><span class="line">                </span><br><span class="line">            case &quot;price_asc&quot;: // ä»·æ ¼å‡åº</span><br><span class="line">                queryBuilder.withSort(SortBuilders.fieldSort(&quot;price&quot;).order(SortOrder.ASC));</span><br><span class="line">                break;</span><br><span class="line">                </span><br><span class="line">            case &quot;price_desc&quot;: // ä»·æ ¼é™åº</span><br><span class="line">                queryBuilder.withSort(SortBuilders.fieldSort(&quot;price&quot;).order(SortOrder.DESC));</span><br><span class="line">                break;</span><br><span class="line">                </span><br><span class="line">            case &quot;new&quot;: // æ–°å“ä¼˜å…ˆ</span><br><span class="line">                queryBuilder.withSort(SortBuilders.fieldSort(&quot;createTime&quot;).order(SortOrder.DESC));</span><br><span class="line">                break;</span><br><span class="line">                </span><br><span class="line">            case &quot;score&quot;: // è¯„åˆ†æ’åº</span><br><span class="line">                queryBuilder.withSort(SortBuilders.fieldSort(&quot;score&quot;).order(SortOrder.DESC));</span><br><span class="line">                break;</span><br><span class="line">                </span><br><span class="line">            case &quot;comprehensive&quot;: // ç»¼åˆæ’åºï¼ˆé”€é‡+è¯„åˆ†+æ–°å“ï¼‰</span><br><span class="line">                // ä½¿ç”¨è„šæœ¬æ’åº</span><br><span class="line">                String script = &quot;&quot;&quot;</span><br><span class="line">                    def score = 0;</span><br><span class="line">                    // é”€é‡æƒé‡40%</span><br><span class="line">                    score += doc[&#x27;saleCount&#x27;].value * 0.4;</span><br><span class="line">                    // è¯„åˆ†æƒé‡30%</span><br><span class="line">                    score += (doc[&#x27;score&#x27;].value * 20) * 0.3;</span><br><span class="line">                    // æ–°å“æƒé‡20%</span><br><span class="line">                    if (doc[&#x27;isNew&#x27;].value) &#123;</span><br><span class="line">                        score += 100 * 0.2;</span><br><span class="line">                    &#125;</span><br><span class="line">                    // åº“å­˜æƒé‡10%</span><br><span class="line">                    score += Math.min(doc[&#x27;stock&#x27;].value, 100) * 0.1;</span><br><span class="line">                    return score;</span><br><span class="line">                    &quot;&quot;&quot;;</span><br><span class="line">                queryBuilder.withSort(SortBuilders.scriptSort(</span><br><span class="line">                    new org.elasticsearch.script.Script(script),</span><br><span class="line">                    org.elasticsearch.script.ScriptType.INLINE,</span><br><span class="line">                    &quot;number&quot;</span><br><span class="line">                ).order(SortOrder.DESC));</span><br><span class="line">                break;</span><br><span class="line">                </span><br><span class="line">            default:</span><br><span class="line">                // é»˜è®¤æŒ‰ç›¸å…³æ€§æ’åº</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return queryBuilder;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * ä¸ªæ€§åŒ–æ’åºï¼ˆåŸºäºç”¨æˆ·è¡Œä¸ºï¼‰</span><br><span class="line">     */</span><br><span class="line">    public NativeSearchQueryBuilder applyPersonalizedSort(</span><br><span class="line">            NativeSearchQueryBuilder queryBuilder,</span><br><span class="line">            Long userId,</span><br><span class="line">            String keyword) &#123;</span><br><span class="line">        </span><br><span class="line">        if (userId == null) &#123;</span><br><span class="line">            return queryBuilder;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            // è·å–ç”¨æˆ·è¡Œä¸ºæ•°æ®</span><br><span class="line">            UserBehavior behavior = getUserBehavior(userId);</span><br><span class="line">            </span><br><span class="line">            // æ„å»ºä¸ªæ€§åŒ–è¯„åˆ†è„šæœ¬</span><br><span class="line">            String personalizationScript = buildPersonalizationScript(behavior, keyword);</span><br><span class="line">            </span><br><span class="line">            if (personalizationScript != null) &#123;</span><br><span class="line">                queryBuilder.withSort(SortBuilders.scriptSort(</span><br><span class="line">                    new org.elasticsearch.script.Script(personalizationScript),</span><br><span class="line">                    org.elasticsearch.script.ScriptType.INLINE,</span><br><span class="line">                    &quot;number&quot;</span><br><span class="line">                ).order(SortOrder.DESC));</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;ä¸ªæ€§åŒ–æ’åºå¤±è´¥ï¼Œç”¨æˆ·IDï¼š&#123;&#125;&quot;, userId, e);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return queryBuilder;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ„å»ºä¸ªæ€§åŒ–è¯„åˆ†è„šæœ¬</span><br><span class="line">     */</span><br><span class="line">    private String buildPersonalizationScript(UserBehavior behavior, String keyword) &#123;</span><br><span class="line">        StringBuilder script = new StringBuilder();</span><br><span class="line">        script.append(&quot;def personalScore = 0;\n&quot;);</span><br><span class="line">        </span><br><span class="line">        // 1. å“ç‰Œåå¥½</span><br><span class="line">        if (!behavior.getPreferredBrands().isEmpty()) &#123;</span><br><span class="line">            script.append(&quot;if (doc[&#x27;brand.keyword&#x27;].size() &gt; 0) &#123;\n&quot;);</span><br><span class="line">            script.append(&quot;  def brand = doc[&#x27;brand.keyword&#x27;].value;\n&quot;);</span><br><span class="line">            script.append(&quot;  switch (brand) &#123;\n&quot;);</span><br><span class="line">            </span><br><span class="line">            for (Map.Entry&lt;String, Double&gt; entry : behavior.getPreferredBrands().entrySet()) &#123;</span><br><span class="line">                script.append(String.format(&quot;    case &#x27;%s&#x27;: personalScore += %f; break;\n&quot;, </span><br><span class="line">                        entry.getKey(), entry.getValue()));</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            script.append(&quot;  &#125;\n&quot;);</span><br><span class="line">            script.append(&quot;&#125;\n&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 2. ä»·æ ¼åŒºé—´åå¥½</span><br><span class="line">        if (behavior.getPreferredPriceRange() != null) &#123;</span><br><span class="line">            PriceRange range = behavior.getPreferredPriceRange();</span><br><span class="line">            script.append(String.format(&quot;&quot;&quot;</span><br><span class="line">                def price = doc[&#x27;price&#x27;].value;</span><br><span class="line">                if (price &gt;= %f &amp;&amp; price &lt;= %f) &#123;</span><br><span class="line">                    personalScore += %f;</span><br><span class="line">                &#125;</span><br><span class="line">                &quot;&quot;&quot;, range.getMin(), range.getMax(), range.getWeight()));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 3. å“ç±»åå¥½</span><br><span class="line">        if (!behavior.getPreferredCategories().isEmpty()) &#123;</span><br><span class="line">            script.append(&quot;if (doc[&#x27;categoryId&#x27;].size() &gt; 0) &#123;\n&quot;);</span><br><span class="line">            script.append(&quot;  def categoryId = doc[&#x27;categoryId&#x27;].value;\n&quot;);</span><br><span class="line">            script.append(&quot;  switch (categoryId.toString()) &#123;\n&quot;);</span><br><span class="line">            </span><br><span class="line">            for (Map.Entry&lt;Long, Double&gt; entry : behavior.getPreferredCategories().entrySet()) &#123;</span><br><span class="line">                script.append(String.format(&quot;    case &#x27;%d&#x27;: personalScore += %f; break;\n&quot;, </span><br><span class="line">                        entry.getKey(), entry.getValue()));</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            script.append(&quot;  &#125;\n&quot;);</span><br><span class="line">            script.append(&quot;&#125;\n&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 4. æœç´¢å†å²åŒ¹é…</span><br><span class="line">        if (!behavior.getSearchHistory().isEmpty() &amp;&amp; keyword != null) &#123;</span><br><span class="line">            script.append(&quot;// æœç´¢å†å²åŒ¹é…åº¦\n&quot;);</span><br><span class="line">            script.append(&quot;def keywordMatch = 0;\n&quot;);</span><br><span class="line">            script.append(&quot;def productName = doc[&#x27;productName&#x27;].value;\n&quot;);</span><br><span class="line">            script.append(&quot;def categoryName = doc[&#x27;categoryName&#x27;].value;\n&quot;);</span><br><span class="line">            script.append(&quot;def brand = doc[&#x27;brand.keyword&#x27;].value;\n&quot;);</span><br><span class="line">            </span><br><span class="line">            for (String historyKeyword : behavior.getSearchHistory()) &#123;</span><br><span class="line">                script.append(String.format(&quot;&quot;&quot;</span><br><span class="line">                    if (productName.contains(&#x27;%s&#x27;) || categoryName.contains(&#x27;%s&#x27;) || brand.contains(&#x27;%s&#x27;)) &#123;</span><br><span class="line">                        keywordMatch += %f;</span><br><span class="line">                    &#125;</span><br><span class="line">                    &quot;&quot;&quot;, historyKeyword, historyKeyword, historyKeyword, 0.1));</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            script.append(&quot;personalScore += keywordMatch;\n&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        script.append(&quot;return personalScore;&quot;);</span><br><span class="line">        </span><br><span class="line">        return script.toString();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è·å–ç”¨æˆ·è¡Œä¸ºæ•°æ®ï¼ˆç®€åŒ–å®ç°ï¼‰</span><br><span class="line">     */</span><br><span class="line">    private UserBehavior getUserBehavior(Long userId) &#123;</span><br><span class="line">        // å®é™…é¡¹ç›®ä¸­åº”è¯¥ä»ç”¨æˆ·è¡Œä¸ºåˆ†æç³»ç»Ÿè·å–</span><br><span class="line">        UserBehavior behavior = new UserBehavior();</span><br><span class="line">        </span><br><span class="line">        // æ¨¡æ‹Ÿæ•°æ®</span><br><span class="line">        behavior.getPreferredBrands().put(&quot;è‹¹æœ&quot;, 0.5);</span><br><span class="line">        behavior.getPreferredBrands().put(&quot;åä¸º&quot;, 0.3);</span><br><span class="line">        behavior.getPreferredBrands().put(&quot;å°ç±³&quot;, 0.2);</span><br><span class="line">        </span><br><span class="line">        behavior.setPreferredPriceRange(new PriceRange(3000.0, 8000.0, 0.4));</span><br><span class="line">        </span><br><span class="line">        behavior.getPreferredCategories().put(1L, 0.3); // æ‰‹æœº</span><br><span class="line">        behavior.getPreferredCategories().put(2L, 0.2); // ç¬”è®°æœ¬</span><br><span class="line">        </span><br><span class="line">        behavior.getSearchHistory().add(&quot;æ‰‹æœº&quot;);</span><br><span class="line">        behavior.getSearchHistory().add(&quot;è‹¹æœ&quot;);</span><br><span class="line">        </span><br><span class="line">        return behavior;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * A/Bæµ‹è¯•ä¸åŒæ’åºç­–ç•¥</span><br><span class="line">     */</span><br><span class="line">    public SearchResult&lt;ProductDocument&gt; abTestSearch(</span><br><span class="line">            SearchRequest request, </span><br><span class="line">            String testGroup) &#123;</span><br><span class="line">        </span><br><span class="line">        // è®°å½•æµ‹è¯•åˆ†ç»„</span><br><span class="line">        request.setTestGroup(testGroup);</span><br><span class="line">        </span><br><span class="line">        SearchResult&lt;ProductDocument&gt; result;</span><br><span class="line">        </span><br><span class="line">        switch (testGroup) &#123;</span><br><span class="line">            case &quot;group_a&quot;: // æ§åˆ¶ç»„ï¼šåŸæœ‰ç®—æ³•</span><br><span class="line">                result = productSearchService.search(request);</span><br><span class="line">                break;</span><br><span class="line">                </span><br><span class="line">            case &quot;group_b&quot;: // å®éªŒç»„1ï¼šæ–°ç®—æ³•</span><br><span class="line">                result = searchWithNewAlgorithm(request);</span><br><span class="line">                break;</span><br><span class="line">                </span><br><span class="line">            case &quot;group_c&quot;: // å®éªŒç»„2ï¼šä¸ªæ€§åŒ–ç®—æ³•</span><br><span class="line">                request.setUserId(getCurrentUserId());</span><br><span class="line">                result = searchWithPersonalization(request);</span><br><span class="line">                break;</span><br><span class="line">                </span><br><span class="line">            default:</span><br><span class="line">                result = productSearchService.search(request);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // è®°å½•æµ‹è¯•ç»“æœ</span><br><span class="line">        recordABTestResult(request, result, testGroup);</span><br><span class="line">        </span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * ä½¿ç”¨æ–°ç®—æ³•æœç´¢</span><br><span class="line">     */</span><br><span class="line">    private SearchResult&lt;ProductDocument&gt; searchWithNewAlgorithm(SearchRequest request) &#123;</span><br><span class="line">        // å®ç°æ–°çš„æœç´¢ç®—æ³•</span><br><span class="line">        // ...</span><br><span class="line">        return productSearchService.search(request);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * ä½¿ç”¨ä¸ªæ€§åŒ–ç®—æ³•æœç´¢</span><br><span class="line">     */</span><br><span class="line">    private SearchResult&lt;ProductDocument&gt; searchWithPersonalization(SearchRequest request) &#123;</span><br><span class="line">        // å®ç°ä¸ªæ€§åŒ–æœç´¢ç®—æ³•</span><br><span class="line">        // ...</span><br><span class="line">        return productSearchService.search(request);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è®°å½•A/Bæµ‹è¯•ç»“æœ</span><br><span class="line">     */</span><br><span class="line">    private void recordABTestResult(</span><br><span class="line">            SearchRequest request, </span><br><span class="line">            SearchResult&lt;ProductDocument&gt; result,</span><br><span class="line">            String testGroup) &#123;</span><br><span class="line">        </span><br><span class="line">        ABTestRecord record = ABTestRecord.builder()</span><br><span class="line">                .testId(UUID.randomUUID().toString())</span><br><span class="line">                .testGroup(testGroup)</span><br><span class="line">                .keyword(request.getKeyword())</span><br><span class="line">                .resultCount(result.getList().size())</span><br><span class="line">                .clickThroughRate(0.0) // å®é™…éœ€è¦è·Ÿè¸ªç‚¹å‡»ç‡</span><br><span class="line">                .conversionRate(0.0)   // å®é™…éœ€è¦è·Ÿè¸ªè½¬åŒ–ç‡</span><br><span class="line">                .testTime(LocalDateTime.now())</span><br><span class="line">                .build();</span><br><span class="line">        </span><br><span class="line">        // ä¿å­˜åˆ°æ•°æ®åº“æˆ–åˆ†æç³»ç»Ÿ</span><br><span class="line">        // abTestService.saveRecord(record);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// ç”¨æˆ·è¡Œä¸ºæ•°æ®</span><br><span class="line">@Data</span><br><span class="line">class UserBehavior &#123;</span><br><span class="line">    private Map&lt;String, Double&gt; preferredBrands = new HashMap&lt;&gt;();</span><br><span class="line">    private PriceRange preferredPriceRange;</span><br><span class="line">    private Map&lt;Long, Double&gt; preferredCategories = new HashMap&lt;&gt;();</span><br><span class="line">    private List&lt;String&gt; searchHistory = new ArrayList&lt;&gt;();</span><br><span class="line">    private List&lt;Long&gt; clickedProducts = new ArrayList&lt;&gt;();</span><br><span class="line">    private List&lt;Long&gt; purchasedProducts = new ArrayList&lt;&gt;();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// ä»·æ ¼åŒºé—´</span><br><span class="line">@Data</span><br><span class="line">@AllArgsConstructor</span><br><span class="line">class PriceRange &#123;</span><br><span class="line">    private Double min;</span><br><span class="line">    private Double max;</span><br><span class="line">    private Double weight;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// A/Bæµ‹è¯•è®°å½•</span><br><span class="line">@Data</span><br><span class="line">@Builder</span><br><span class="line">class ABTestRecord &#123;</span><br><span class="line">    private String testId;</span><br><span class="line">    private String testGroup;</span><br><span class="line">    private String keyword;</span><br><span class="line">    private Integer resultCount;</span><br><span class="line">    private Double clickThroughRate;</span><br><span class="line">    private Double conversionRate;</span><br><span class="line">    private LocalDateTime testTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-æœç´¢æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–"><a href="#4-æœç´¢æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–" class="headerlink" title="4. æœç´¢æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–"></a>4. æœç´¢æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.search.monitor;</span><br><span class="line"></span><br><span class="line">import io.micrometer.core.instrument.MeterRegistry;</span><br><span class="line">import io.micrometer.core.instrument.Timer;</span><br><span class="line">import lombok.RequiredArgsConstructor;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.elasticsearch.action.admin.cluster.health.ClusterHealthRequest;</span><br><span class="line">import org.elasticsearch.action.admin.cluster.health.ClusterHealthResponse;</span><br><span class="line">import org.elasticsearch.client.RequestOptions;</span><br><span class="line">import org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line">import org.elasticsearch.cluster.health.ClusterHealthStatus;</span><br><span class="line">import org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line">import org.springframework.scheduling.annotation.Scheduled;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line">import javax.annotation.PostConstruct;</span><br><span class="line">import java.time.LocalDateTime;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line">import java.util.concurrent.ConcurrentHashMap;</span><br><span class="line">import java.util.concurrent.TimeUnit;</span><br><span class="line">import java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line">import java.util.concurrent.atomic.AtomicLong;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@Component</span><br><span class="line">@RequiredArgsConstructor</span><br><span class="line">public class SearchPerformanceMonitor &#123;</span><br><span class="line">    </span><br><span class="line">    private final RestHighLevelClient elasticsearchClient;</span><br><span class="line">    private final RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    private final MeterRegistry meterRegistry;</span><br><span class="line">    </span><br><span class="line">    // æ€§èƒ½æŒ‡æ ‡</span><br><span class="line">    private final AtomicLong totalSearchRequests = new AtomicLong(0);</span><br><span class="line">    private final AtomicLong successfulSearches = new AtomicLong(0);</span><br><span class="line">    private final AtomicLong failedSearches = new AtomicLong(0);</span><br><span class="line">    private final AtomicLong cacheHits = new AtomicLong(0);</span><br><span class="line">    private final AtomicLong cacheMisses = new AtomicLong(0);</span><br><span class="line">    private final Timer searchTimer = Timer.builder(&quot;search.response.time&quot;)</span><br><span class="line">            .description(&quot;æœç´¢å“åº”æ—¶é—´&quot;)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">    </span><br><span class="line">    // å®æ—¶ç›‘æ§æ•°æ®</span><br><span class="line">    private final Map&lt;String, SearchStats&gt; keywordStats = new ConcurrentHashMap&lt;&gt;();</span><br><span class="line">    private final Map&lt;String, AtomicInteger&gt; errorCounts = new ConcurrentHashMap&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    // æ…¢æŸ¥è¯¢é˜ˆå€¼ï¼ˆæ¯«ç§’ï¼‰</span><br><span class="line">    private static final long SLOW_QUERY_THRESHOLD = 1000;</span><br><span class="line">    </span><br><span class="line">    @PostConstruct</span><br><span class="line">    public void init() &#123;</span><br><span class="line">        // åˆå§‹åŒ–ç›‘æ§æŒ‡æ ‡</span><br><span class="line">        initMetrics();</span><br><span class="line">        </span><br><span class="line">        // å¯åŠ¨æ€§èƒ½ç›‘æ§</span><br><span class="line">        startPerformanceMonitoring();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆå§‹åŒ–ç›‘æ§æŒ‡æ ‡</span><br><span class="line">     */</span><br><span class="line">    private void initMetrics() &#123;</span><br><span class="line">        // æ³¨å†Œè‡ªå®šä¹‰æŒ‡æ ‡</span><br><span class="line">        meterRegistry.gauge(&quot;search.total.requests&quot;, totalSearchRequests);</span><br><span class="line">        meterRegistry.gauge(&quot;search.successful.requests&quot;, successfulSearches);</span><br><span class="line">        meterRegistry.gauge(&quot;search.failed.requests&quot;, failedSearches);</span><br><span class="line">        meterRegistry.gauge(&quot;search.cache.hits&quot;, cacheHits);</span><br><span class="line">        meterRegistry.gauge(&quot;search.cache.misses&quot;, cacheMisses);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è®°å½•æœç´¢å¼€å§‹</span><br><span class="line">     */</span><br><span class="line">    public SearchContext startSearch(String keyword) &#123;</span><br><span class="line">        totalSearchRequests.incrementAndGet();</span><br><span class="line">        </span><br><span class="line">        SearchContext context = SearchContext.builder()</span><br><span class="line">                .searchId(generateSearchId())</span><br><span class="line">                .keyword(keyword)</span><br><span class="line">                .startTime(System.currentTimeMillis())</span><br><span class="line">                .build();</span><br><span class="line">        </span><br><span class="line">        // è®°å½•å…³é”®è¯ç»Ÿè®¡</span><br><span class="line">        keywordStats.computeIfAbsent(keyword, k -&gt; new SearchStats())</span><br><span class="line">                .incrementSearchCount();</span><br><span class="line">        </span><br><span class="line">        return context;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è®°å½•æœç´¢ç»“æŸ</span><br><span class="line">     */</span><br><span class="line">    public void endSearch(SearchContext context, boolean success, long resultCount) &#123;</span><br><span class="line">        long endTime = System.currentTimeMillis();</span><br><span class="line">        long duration = endTime - context.getStartTime();</span><br><span class="line">        </span><br><span class="line">        // è®°å½•å“åº”æ—¶é—´</span><br><span class="line">        searchTimer.record(duration, TimeUnit.MILLISECONDS);</span><br><span class="line">        </span><br><span class="line">        // æ›´æ–°æˆåŠŸ/å¤±è´¥è®¡æ•°</span><br><span class="line">        if (success) &#123;</span><br><span class="line">            successfulSearches.incrementAndGet();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            failedSearches.incrementAndGet();</span><br><span class="line">            errorCounts.computeIfAbsent(context.getKeyword(), k -&gt; new AtomicInteger(0))</span><br><span class="line">                    .incrementAndGet();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // æ›´æ–°å…³é”®è¯ç»Ÿè®¡</span><br><span class="line">        SearchStats stats = keywordStats.get(context.getKeyword());</span><br><span class="line">        if (stats != null) &#123;</span><br><span class="line">            stats.addResponseTime(duration);</span><br><span class="line">            stats.addResultCount(resultCount);</span><br><span class="line">            stats.setLastSearchTime(LocalDateTime.now());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // æ£€æŸ¥æ˜¯å¦ä¸ºæ…¢æŸ¥è¯¢</span><br><span class="line">        if (duration &gt; SLOW_QUERY_THRESHOLD) &#123;</span><br><span class="line">            logSlowQuery(context, duration, resultCount);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // è®°å½•åˆ°Elasticsearchï¼ˆå¯é€‰ï¼‰</span><br><span class="line">        // recordSearchMetrics(context, duration, success, resultCount);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è®°å½•ç¼“å­˜å‘½ä¸­</span><br><span class="line">     */</span><br><span class="line">    public void recordCacheHit(String cacheKey) &#123;</span><br><span class="line">        cacheHits.incrementAndGet();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è®°å½•ç¼“å­˜æœªå‘½ä¸­</span><br><span class="line">     */</span><br><span class="line">    public void recordCacheMiss(String cacheKey) &#123;</span><br><span class="line">        cacheMisses.incrementAndGet();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è®°å½•é”™è¯¯</span><br><span class="line">     */</span><br><span class="line">    public void recordError(String component, String errorType, Throwable throwable) &#123;</span><br><span class="line">        String errorKey = component + &quot;:&quot; + errorType;</span><br><span class="line">        errorCounts.computeIfAbsent(errorKey, k -&gt; new AtomicInteger(0))</span><br><span class="line">                .incrementAndGet();</span><br><span class="line">        </span><br><span class="line">        log.error(&quot;ç»„ä»¶é”™è¯¯ï¼š&#123;&#125;ï¼Œç±»å‹ï¼š&#123;&#125;&quot;, component, errorType, throwable);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è·å–æ€§èƒ½æŠ¥å‘Š</span><br><span class="line">     */</span><br><span class="line">    public PerformanceReport getPerformanceReport() &#123;</span><br><span class="line">        long totalRequests = totalSearchRequests.get();</span><br><span class="line">        long successful = successfulSearches.get();</span><br><span class="line">        long failed = failedSearches.get();</span><br><span class="line">        </span><br><span class="line">        double successRate = totalRequests &gt; 0 ? (double) successful / totalRequests * 100 : 0;</span><br><span class="line">        double errorRate = totalRequests &gt; 0 ? (double) failed / totalRequests * 100 : 0;</span><br><span class="line">        </span><br><span class="line">        // è®¡ç®—å¹³å‡å“åº”æ—¶é—´</span><br><span class="line">        double avgResponseTime = searchTimer.totalTime(TimeUnit.MILLISECONDS) / </span><br><span class="line">                Math.max(searchTimer.count(), 1);</span><br><span class="line">        </span><br><span class="line">        // è·å–ç¼“å­˜å‘½ä¸­ç‡</span><br><span class="line">        long cacheHit = cacheHits.get();</span><br><span class="line">        long cacheMiss = cacheMisses.get();</span><br><span class="line">        long totalCacheAccess = cacheHit + cacheMiss;</span><br><span class="line">        double cacheHitRate = totalCacheAccess &gt; 0 ? </span><br><span class="line">                (double) cacheHit / totalCacheAccess * 100 : 0;</span><br><span class="line">        </span><br><span class="line">        // è·å–çƒ­é—¨å…³é”®è¯</span><br><span class="line">        List&lt;KeywordStats&gt; hotKeywords = getHotKeywords(10);</span><br><span class="line">        </span><br><span class="line">        // è·å–é”™è¯¯ç»Ÿè®¡</span><br><span class="line">        Map&lt;String, Integer&gt; errorStats = getErrorStats();</span><br><span class="line">        </span><br><span class="line">        // è·å–ç³»ç»Ÿå¥åº·çŠ¶æ€</span><br><span class="line">        SystemHealth systemHealth = getSystemHealth();</span><br><span class="line">        </span><br><span class="line">        return PerformanceReport.builder()</span><br><span class="line">                .totalRequests(totalRequests)</span><br><span class="line">                .successfulRequests(successful)</span><br><span class="line">                .failedRequests(failed)</span><br><span class="line">                .successRate(successRate)</span><br><span class="line">                .errorRate(errorRate)</span><br><span class="line">                .averageResponseTime(avgResponseTime)</span><br><span class="line">                .cacheHitRate(cacheHitRate)</span><br><span class="line">                .slowQueryCount(getSlowQueryCount())</span><br><span class="line">                .hotKeywords(hotKeywords)</span><br><span class="line">                .errorStats(errorStats)</span><br><span class="line">                .systemHealth(systemHealth)</span><br><span class="line">                .reportTime(LocalDateTime.now())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è·å–çƒ­é—¨å…³é”®è¯</span><br><span class="line">     */</span><br><span class="line">    private List&lt;KeywordStats&gt; getHotKeywords(int limit) &#123;</span><br><span class="line">        return keywordStats.entrySet().stream()</span><br><span class="line">                .sorted((e1, e2) -&gt; Long.compare(</span><br><span class="line">                        e2.getValue().getSearchCount(),</span><br><span class="line">                        e1.getValue().getSearchCount()))</span><br><span class="line">                .limit(limit)</span><br><span class="line">                .map(entry -&gt; KeywordStats.builder()</span><br><span class="line">                        .keyword(entry.getKey())</span><br><span class="line">                        .searchCount(entry.getValue().getSearchCount())</span><br><span class="line">                        .avgResponseTime(entry.getValue().getAverageResponseTime())</span><br><span class="line">                        .avgResultCount(entry.getValue().getAverageResultCount())</span><br><span class="line">                        .lastSearchTime(entry.getValue().getLastSearchTime())</span><br><span class="line">                        .build())</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è·å–é”™è¯¯ç»Ÿè®¡</span><br><span class="line">     */</span><br><span class="line">    private Map&lt;String, Integer&gt; getErrorStats() &#123;</span><br><span class="line">        Map&lt;String, Integer&gt; stats = new HashMap&lt;&gt;();</span><br><span class="line">        errorCounts.forEach((key, count) -&gt; stats.put(key, count.get()));</span><br><span class="line">        return stats;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è·å–ç³»ç»Ÿå¥åº·çŠ¶æ€</span><br><span class="line">     */</span><br><span class="line">    private SystemHealth getSystemHealth() &#123;</span><br><span class="line">        SystemHealth health = new SystemHealth();</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            // æ£€æŸ¥Elasticsearch</span><br><span class="line">            ClusterHealthRequest request = new ClusterHealthRequest();</span><br><span class="line">            ClusterHealthResponse response = elasticsearchClient.cluster()</span><br><span class="line">                    .health(request, RequestOptions.DEFAULT);</span><br><span class="line">            </span><br><span class="line">            health.setElasticsearchStatus(response.getStatus().name());</span><br><span class="line">            health.setElasticsearchNodeCount(response.getNumberOfNodes());</span><br><span class="line">            health.setElasticsearchActiveShards(response.getActiveShards());</span><br><span class="line">            </span><br><span class="line">            // æ£€æŸ¥Redis</span><br><span class="line">            String ping = redisTemplate.getConnectionFactory().getConnection().ping();</span><br><span class="line">            health.setRedisStatus(&quot;OK&quot;.equals(ping) ? &quot;HEALTHY&quot; : &quot;UNHEALTHY&quot;);</span><br><span class="line">            </span><br><span class="line">            // æ£€æŸ¥å†…å­˜</span><br><span class="line">            Runtime runtime = Runtime.getRuntime();</span><br><span class="line">            long totalMemory = runtime.totalMemory();</span><br><span class="line">            long freeMemory = runtime.freeMemory();</span><br><span class="line">            long usedMemory = totalMemory - freeMemory;</span><br><span class="line">            double memoryUsage = (double) usedMemory / totalMemory * 100;</span><br><span class="line">            </span><br><span class="line">            health.setMemoryUsage(memoryUsage);</span><br><span class="line">            health.setTotalMemory(totalMemory);</span><br><span class="line">            health.setUsedMemory(usedMemory);</span><br><span class="line">            </span><br><span class="line">            // æ£€æŸ¥çº¿ç¨‹</span><br><span class="line">            int threadCount = Thread.activeCount();</span><br><span class="line">            health.setThreadCount(threadCount);</span><br><span class="line">            </span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;è·å–ç³»ç»Ÿå¥åº·çŠ¶æ€å¤±è´¥&quot;, e);</span><br><span class="line">            health.setOverallStatus(&quot;UNHEALTHY&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return health;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è®°å½•æ…¢æŸ¥è¯¢æ—¥å¿—</span><br><span class="line">     */</span><br><span class="line">    private void logSlowQuery(SearchContext context, long duration, long resultCount) &#123;</span><br><span class="line">        SlowQueryLog logEntry = SlowQueryLog.builder()</span><br><span class="line">                .searchId(context.getSearchId())</span><br><span class="line">                .keyword(context.getKeyword())</span><br><span class="line">                .duration(duration)</span><br><span class="line">                .resultCount(resultCount)</span><br><span class="line">                .timestamp(LocalDateTime.now())</span><br><span class="line">                .build();</span><br><span class="line">        </span><br><span class="line">        // ä¿å­˜åˆ°æ•°æ®åº“æˆ–æ—¥å¿—æ–‡ä»¶</span><br><span class="line">        log.warn(&quot;æ…¢æŸ¥è¯¢æ£€æµ‹ï¼š&#123;&#125;&quot;, logEntry);</span><br><span class="line">        </span><br><span class="line">        // å‘é€å‘Šè­¦ï¼ˆå¦‚æœé…ç½®äº†å‘Šè­¦ï¼‰</span><br><span class="line">        if (duration &gt; SLOW_QUERY_THRESHOLD * 2) &#123;</span><br><span class="line">            sendAlert(&quot;ä¸¥é‡æ…¢æŸ¥è¯¢å‘Šè­¦&quot;, logEntry);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å‘é€å‘Šè­¦</span><br><span class="line">     */</span><br><span class="line">    private void sendAlert(String title, SlowQueryLog logEntry) &#123;</span><br><span class="line">        // å®ç°å‘Šè­¦é€»è¾‘ï¼ˆé‚®ä»¶ã€çŸ­ä¿¡ã€é’‰é’‰ç­‰ï¼‰</span><br><span class="line">        log.error(&quot;&#123;&#125;: &#123;&#125;&quot;, title, logEntry);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è·å–æ…¢æŸ¥è¯¢æ•°é‡</span><br><span class="line">     */</span><br><span class="line">    private long getSlowQueryCount() &#123;</span><br><span class="line">        // ä»æ—¥å¿—æˆ–æ•°æ®åº“æŸ¥è¯¢</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * ç”Ÿæˆæœç´¢ID</span><br><span class="line">     */</span><br><span class="line">    private String generateSearchId() &#123;</span><br><span class="line">        return &quot;search_&quot; + System.currentTimeMillis() + &quot;_&quot; + </span><br><span class="line">                ThreadLocalRandom.current().nextInt(1000, 9999);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å¯åŠ¨æ€§èƒ½ç›‘æ§</span><br><span class="line">     */</span><br><span class="line">    private void startPerformanceMonitoring() &#123;</span><br><span class="line">        // è¿™é‡Œå¯ä»¥å¯åŠ¨å®šæ—¶ä»»åŠ¡ï¼Œå®šæœŸæ”¶é›†å’ŒæŠ¥å‘Šæ€§èƒ½æŒ‡æ ‡</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å®šæœŸæ¸…ç†æ—§æ•°æ®</span><br><span class="line">     */</span><br><span class="line">    @Scheduled(cron = &quot;0 0 3 * * ?&quot;) // æ¯å¤©å‡Œæ™¨3ç‚¹æ‰§è¡Œ</span><br><span class="line">    public void cleanupOldData() &#123;</span><br><span class="line">        // æ¸…ç†è¿‡æœŸçš„ç»Ÿè®¡æ•°æ®</span><br><span class="line">        LocalDateTime cutoff = LocalDateTime.now().minusDays(30);</span><br><span class="line">        </span><br><span class="line">        keywordStats.entrySet().removeIf(entry -&gt; </span><br><span class="line">                entry.getValue().getLastSearchTime().isBefore(cutoff));</span><br><span class="line">        </span><br><span class="line">        errorCounts.entrySet().removeIf(entry -&gt; </span><br><span class="line">                entry.getValue().get() == 0);</span><br><span class="line">        </span><br><span class="line">        log.info(&quot;æ¸…ç†æ€§èƒ½ç›‘æ§æ—§æ•°æ®å®Œæˆ&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æœç´¢ä¸Šä¸‹æ–‡</span><br><span class="line">@Data</span><br><span class="line">@Builder</span><br><span class="line">class SearchContext &#123;</span><br><span class="line">    private String searchId;</span><br><span class="line">    private String keyword;</span><br><span class="line">    private Long userId;</span><br><span class="line">    private String sessionId;</span><br><span class="line">    private Long startTime;</span><br><span class="line">    private Map&lt;String, Object&gt; additionalInfo;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æœç´¢ç»Ÿè®¡</span><br><span class="line">@Data</span><br><span class="line">class SearchStats &#123;</span><br><span class="line">    private AtomicLong searchCount = new AtomicLong(0);</span><br><span class="line">    private AtomicLong totalResponseTime = new AtomicLong(0);</span><br><span class="line">    private AtomicLong totalResultCount = new AtomicLong(0);</span><br><span class="line">    private LocalDateTime lastSearchTime;</span><br><span class="line">    </span><br><span class="line">    public void incrementSearchCount() &#123;</span><br><span class="line">        searchCount.incrementAndGet();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public void addResponseTime(long responseTime) &#123;</span><br><span class="line">        totalResponseTime.addAndGet(responseTime);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public void addResultCount(long resultCount) &#123;</span><br><span class="line">        totalResultCount.addAndGet(resultCount);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public double getAverageResponseTime() &#123;</span><br><span class="line">        long count = searchCount.get();</span><br><span class="line">        return count &gt; 0 ? (double) totalResponseTime.get() / count : 0;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public double getAverageResultCount() &#123;</span><br><span class="line">        long count = searchCount.get();</span><br><span class="line">        return count &gt; 0 ? (double) totalResultCount.get() / count : 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æ€§èƒ½æŠ¥å‘Š</span><br><span class="line">@Data</span><br><span class="line">@Builder</span><br><span class="line">class PerformanceReport &#123;</span><br><span class="line">    private Long totalRequests;</span><br><span class="line">    private Long successfulRequests;</span><br><span class="line">    private Long failedRequests;</span><br><span class="line">    private Double successRate;</span><br><span class="line">    private Double errorRate;</span><br><span class="line">    private Double averageResponseTime;</span><br><span class="line">    private Double cacheHitRate;</span><br><span class="line">    private Long slowQueryCount;</span><br><span class="line">    private List&lt;KeywordStats&gt; hotKeywords;</span><br><span class="line">    private Map&lt;String, Integer&gt; errorStats;</span><br><span class="line">    private SystemHealth systemHealth;</span><br><span class="line">    private LocalDateTime reportTime;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// å…³é”®è¯ç»Ÿè®¡</span><br><span class="line">@Data</span><br><span class="line">@Builder</span><br><span class="line">class KeywordStats &#123;</span><br><span class="line">    private String keyword;</span><br><span class="line">    private Long searchCount;</span><br><span class="line">    private Double avgResponseTime;</span><br><span class="line">    private Double avgResultCount;</span><br><span class="line">    private LocalDateTime lastSearchTime;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// ç³»ç»Ÿå¥åº·çŠ¶æ€</span><br><span class="line">@Data</span><br><span class="line">class SystemHealth &#123;</span><br><span class="line">    private String overallStatus = &quot;HEALTHY&quot;;</span><br><span class="line">    private String elasticsearchStatus;</span><br><span class="line">    private Integer elasticsearchNodeCount;</span><br><span class="line">    private Integer elasticsearchActiveShards;</span><br><span class="line">    private String redisStatus;</span><br><span class="line">    private Double memoryUsage;</span><br><span class="line">    private Long totalMemory;</span><br><span class="line">    private Long usedMemory;</span><br><span class="line">    private Integer threadCount;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æ…¢æŸ¥è¯¢æ—¥å¿—</span><br><span class="line">@Data</span><br><span class="line">@Builder</span><br><span class="line">class SlowQueryLog &#123;</span><br><span class="line">    private String searchId;</span><br><span class="line">    private String keyword;</span><br><span class="line">    private Long duration;</span><br><span class="line">    private Long resultCount;</span><br><span class="line">    private LocalDateTime timestamp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-Docker-Composeé…ç½®æ–‡ä»¶"><a href="#5-Docker-Composeé…ç½®æ–‡ä»¶" class="headerlink" title="5. Docker Composeé…ç½®æ–‡ä»¶"></a>5. Docker Composeé…ç½®æ–‡ä»¶</h3><p>yaml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"># docker-compose-search.yml</span><br><span class="line">version: &#x27;3.8&#x27;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  elasticsearch:</span><br><span class="line">    image: elasticsearch:7.17.12</span><br><span class="line">    container_name: shophub-elasticsearch</span><br><span class="line">    environment:</span><br><span class="line">      - discovery.type=single-node</span><br><span class="line">      - ES_JAVA_OPTS=-Xms2g -Xmx2g</span><br><span class="line">      - xpack.security.enabled=false</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;9200:9200&quot;</span><br><span class="line">      - &quot;9300:9300&quot;</span><br><span class="line">    volumes:</span><br><span class="line">      - ./elasticsearch/data:/usr/share/elasticsearch/data</span><br><span class="line">      - ./elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml</span><br><span class="line">      - ./elasticsearch/plugins:/usr/share/elasticsearch/plugins</span><br><span class="line">    networks:</span><br><span class="line">      - shophub-network</span><br><span class="line">    healthcheck:</span><br><span class="line">      test: [&quot;CMD&quot;, &quot;curl&quot;, &quot;-f&quot;, &quot;http://localhost:9200&quot;]</span><br><span class="line">      interval: 30s</span><br><span class="line">      timeout: 10s</span><br><span class="line">      retries: 3</span><br><span class="line"></span><br><span class="line">  kibana:</span><br><span class="line">    image: kibana:7.17.12</span><br><span class="line">    container_name: shophub-kibana</span><br><span class="line">    environment:</span><br><span class="line">      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;5601:5601&quot;</span><br><span class="line">    networks:</span><br><span class="line">      - shophub-network</span><br><span class="line">    depends_on:</span><br><span class="line">      - elasticsearch</span><br><span class="line"></span><br><span class="line">  logstash:</span><br><span class="line">    image: logstash:7.17.12</span><br><span class="line">    container_name: shophub-logstash</span><br><span class="line">    volumes:</span><br><span class="line">      - ./logstash/config/logstash.yml:/usr/share/logstash/config/logstash.yml</span><br><span class="line">      - ./logstash/pipeline:/usr/share/logstash/pipeline</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;5044:5044&quot;</span><br><span class="line">      - &quot;9600:9600&quot;</span><br><span class="line">    networks:</span><br><span class="line">      - shophub-network</span><br><span class="line">    depends_on:</span><br><span class="line">      - elasticsearch</span><br><span class="line"></span><br><span class="line">  search-service:</span><br><span class="line">    build:</span><br><span class="line">      context: ./shophub-search</span><br><span class="line">      dockerfile: Dockerfile</span><br><span class="line">    container_name: shophub-search-service</span><br><span class="line">    environment:</span><br><span class="line">      - SPRING_PROFILES_ACTIVE=docker</span><br><span class="line">      - ES_HOST=elasticsearch</span><br><span class="line">      - ES_PORT=9200</span><br><span class="line">      - REDIS_HOST=redis</span><br><span class="line">      - REDIS_PORT=6379</span><br><span class="line">      - MYSQL_HOST=mysql</span><br><span class="line">      - MYSQL_PORT=3306</span><br><span class="line">      - NACOS_HOST=nacos</span><br><span class="line">      - NACOS_PORT=8848</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;8084:8084&quot;</span><br><span class="line">    networks:</span><br><span class="line">      - shophub-network</span><br><span class="line">    depends_on:</span><br><span class="line">      elasticsearch:</span><br><span class="line">        condition: service_healthy</span><br><span class="line">      redis:</span><br><span class="line">        condition: service_healthy</span><br><span class="line">      mysql:</span><br><span class="line">        condition: service_healthy</span><br><span class="line">    healthcheck:</span><br><span class="line">      test: [&quot;CMD&quot;, &quot;curl&quot;, &quot;-f&quot;, &quot;http://localhost:8084/search/health&quot;]</span><br><span class="line">      interval: 30s</span><br><span class="line">      timeout: 10s</span><br><span class="line">      retries: 3</span><br><span class="line">    volumes:</span><br><span class="line">      - ./logs/search:/app/logs</span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  shophub-network:</span><br><span class="line">    external: true</span><br></pre></td></tr></table></figure><h3 id="6-æ€§èƒ½æµ‹è¯•è„šæœ¬"><a href="#6-æ€§èƒ½æµ‹è¯•è„šæœ¬" class="headerlink" title="6. æ€§èƒ½æµ‹è¯•è„šæœ¬"></a>6. æ€§èƒ½æµ‹è¯•è„šæœ¬</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.search.test;</span><br><span class="line"></span><br><span class="line">import io.gatling.javaapi.core.*;</span><br><span class="line">import io.gatling.javaapi.http.*;</span><br><span class="line"></span><br><span class="line">import java.time.Duration;</span><br><span class="line">import java.util.*;</span><br><span class="line">import java.util.concurrent.ThreadLocalRandom;</span><br><span class="line"></span><br><span class="line">import static io.gatling.javaapi.core.CoreDsl.*;</span><br><span class="line">import static io.gatling.javaapi.http.HttpDsl.*;</span><br><span class="line"></span><br><span class="line">public class SearchPerformanceTest extends Simulation &#123;</span><br><span class="line">    </span><br><span class="line">    // æµ‹è¯•æ•°æ®</span><br><span class="line">    private static final List&lt;String&gt; SEARCH_KEYWORDS = Arrays.asList(</span><br><span class="line">        &quot;æ‰‹æœº&quot;, &quot;ç¬”è®°æœ¬&quot;, &quot;ç”µè§†&quot;, &quot;å†°ç®±&quot;, &quot;æ´—è¡£æœº&quot;,</span><br><span class="line">        &quot;è‹¹æœ&quot;, &quot;åä¸º&quot;, &quot;å°ç±³&quot;, &quot;ä¸‰æ˜Ÿ&quot;, &quot;è”æƒ³&quot;,</span><br><span class="line">        &quot;æ¸¸æˆæœ¬&quot;, &quot;è½»è–„æœ¬&quot;, &quot;æ™ºèƒ½æ‰‹æœº&quot;, &quot;å¹³æ¿ç”µè„‘&quot;</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    private static final List&lt;String&gt; SORT_TYPES = Arrays.asList(</span><br><span class="line">        &quot;relevance&quot;, &quot;sales&quot;, &quot;price_asc&quot;, &quot;price_desc&quot;, &quot;new&quot;</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    HttpProtocolBuilder httpProtocol = http</span><br><span class="line">        .baseUrl(&quot;http://localhost:8084&quot;)</span><br><span class="line">        .acceptHeader(&quot;application/json&quot;)</span><br><span class="line">        .userAgentHeader(&quot;Gatling Performance Test&quot;)</span><br><span class="line">        .shareConnections();</span><br><span class="line">    </span><br><span class="line">    // åœºæ™¯1ï¼šæ™®é€šæœç´¢</span><br><span class="line">    ScenarioBuilder normalSearchScenario = scenario(&quot;æ™®é€šæœç´¢æµ‹è¯•&quot;)</span><br><span class="line">        .exec(session -&gt; &#123;</span><br><span class="line">            String keyword = SEARCH_KEYWORDS.get(</span><br><span class="line">                ThreadLocalRandom.current().nextInt(SEARCH_KEYWORDS.size())</span><br><span class="line">            );</span><br><span class="line">            return session.set(&quot;keyword&quot;, keyword);</span><br><span class="line">        &#125;)</span><br><span class="line">        .exec(</span><br><span class="line">            http(&quot;æ™®é€šæœç´¢&quot;)</span><br><span class="line">                .get(&quot;/api/search/simple&quot;)</span><br><span class="line">                .queryParam(&quot;keyword&quot;, &quot;#&#123;keyword&#125;&quot;)</span><br><span class="line">                .queryParam(&quot;page&quot;, &quot;1&quot;)</span><br><span class="line">                .queryParam(&quot;size&quot;, &quot;20&quot;)</span><br><span class="line">                .check(status().is(200))</span><br><span class="line">                .check(jsonPath(&quot;$.code&quot;).is(&quot;200&quot;))</span><br><span class="line">        )</span><br><span class="line">        .pause(1);</span><br><span class="line">    </span><br><span class="line">    // åœºæ™¯2ï¼šé«˜çº§æœç´¢</span><br><span class="line">    ScenarioBuilder advancedSearchScenario = scenario(&quot;é«˜çº§æœç´¢æµ‹è¯•&quot;)</span><br><span class="line">        .exec(session -&gt; &#123;</span><br><span class="line">            String keyword = SEARCH_KEYWORDS.get(</span><br><span class="line">                ThreadLocalRandom.current().nextInt(SEARCH_KEYWORDS.size())</span><br><span class="line">            );</span><br><span class="line">            String sortType = SORT_TYPES.get(</span><br><span class="line">                ThreadLocalRandom.current().nextInt(SORT_TYPES.size())</span><br><span class="line">            );</span><br><span class="line">            return session.setAll(Map.of(</span><br><span class="line">                &quot;keyword&quot;, keyword,</span><br><span class="line">                &quot;sortType&quot;, sortType,</span><br><span class="line">                &quot;minPrice&quot;, ThreadLocalRandom.current().nextInt(1000, 5000),</span><br><span class="line">                &quot;maxPrice&quot;, ThreadLocalRandom.current().nextInt(5000, 20000)</span><br><span class="line">            ));</span><br><span class="line">        &#125;)</span><br><span class="line">        .exec(</span><br><span class="line">            http(&quot;é«˜çº§æœç´¢&quot;)</span><br><span class="line">                .post(&quot;/api/search/advanced&quot;)</span><br><span class="line">                .body(StringBody(&quot;&quot;&quot;</span><br><span class="line">                    &#123;</span><br><span class="line">                      &quot;keyword&quot;: &quot;#&#123;keyword&#125;&quot;,</span><br><span class="line">                      &quot;page&quot;: 1,</span><br><span class="line">                      &quot;size&quot;: 20,</span><br><span class="line">                      &quot;sortBy&quot;: &quot;#&#123;sortType&#125;&quot;,</span><br><span class="line">                      &quot;minPrice&quot;: #&#123;minPrice&#125;,</span><br><span class="line">                      &quot;maxPrice&quot;: #&#123;maxPrice&#125;,</span><br><span class="line">                      &quot;brands&quot;: [&quot;è‹¹æœ&quot;, &quot;åä¸º&quot;]</span><br><span class="line">                    &#125;</span><br><span class="line">                    &quot;&quot;&quot;))</span><br><span class="line">                .asJson()</span><br><span class="line">                .check(status().is(200))</span><br><span class="line">                .check(jsonPath(&quot;$.code&quot;).is(&quot;200&quot;))</span><br><span class="line">        )</span><br><span class="line">        .pause(2);</span><br><span class="line">    </span><br><span class="line">    // åœºæ™¯3ï¼šæœç´¢å»ºè®®</span><br><span class="line">    ScenarioBuilder suggestScenario = scenario(&quot;æœç´¢å»ºè®®æµ‹è¯•&quot;)</span><br><span class="line">        .exec(session -&gt; &#123;</span><br><span class="line">            String keyword = SEARCH_KEYWORDS.get(</span><br><span class="line">                ThreadLocalRandom.current().nextInt(SEARCH_KEYWORDS.size())</span><br><span class="line">            ).substring(0, 2); // å–å‰ä¸¤ä¸ªå­—</span><br><span class="line">            return session.set(&quot;keyword&quot;, keyword);</span><br><span class="line">        &#125;)</span><br><span class="line">        .exec(</span><br><span class="line">            http(&quot;æœç´¢å»ºè®®&quot;)</span><br><span class="line">                .get(&quot;/api/search/suggest&quot;)</span><br><span class="line">                .queryParam(&quot;keyword&quot;, &quot;#&#123;keyword&#125;&quot;)</span><br><span class="line">                .queryParam(&quot;size&quot;, &quot;10&quot;)</span><br><span class="line">                .check(status().is(200))</span><br><span class="line">                .check(jsonPath(&quot;$.code&quot;).is(&quot;200&quot;))</span><br><span class="line">        )</span><br><span class="line">        .pause(1);</span><br><span class="line">    </span><br><span class="line">    // åœºæ™¯4ï¼šèšåˆæŸ¥è¯¢</span><br><span class="line">    ScenarioBuilder aggregationScenario = scenario(&quot;èšåˆæŸ¥è¯¢æµ‹è¯•&quot;)</span><br><span class="line">        .exec(</span><br><span class="line">            http(&quot;èšåˆæŸ¥è¯¢&quot;)</span><br><span class="line">                .get(&quot;/api/search/aggregation&quot;)</span><br><span class="line">                .queryParam(&quot;keyword&quot;, &quot;æ‰‹æœº&quot;)</span><br><span class="line">                .check(status().is(200))</span><br><span class="line">                .check(jsonPath(&quot;$.code&quot;).is(&quot;200&quot;))</span><br><span class="line">        )</span><br><span class="line">        .pause(1);</span><br><span class="line">    </span><br><span class="line">    &#123;</span><br><span class="line">        // æ··åˆåœºæ™¯æµ‹è¯•</span><br><span class="line">        setUp(</span><br><span class="line">            normalSearchScenario.injectOpen(</span><br><span class="line">                rampUsersPerSec(1).to(50).during(Duration.ofMinutes(2)), // 2åˆ†é’Ÿå†…ä»1å¢åŠ åˆ°50ç”¨æˆ·/ç§’</span><br><span class="line">                constantUsersPerSec(50).during(Duration.ofMinutes(5)),   // ä¿æŒ50ç”¨æˆ·/ç§’5åˆ†é’Ÿ</span><br><span class="line">                rampUsersPerSec(50).to(0).during(Duration.ofMinutes(1))  // 1åˆ†é’Ÿå†…é™åˆ°0</span><br><span class="line">            ),</span><br><span class="line">            </span><br><span class="line">            advancedSearchScenario.injectOpen(</span><br><span class="line">                rampUsersPerSec(1).to(20).during(Duration.ofMinutes(2)),</span><br><span class="line">                constantUsersPerSec(20).during(Duration.ofMinutes(5)),</span><br><span class="line">                rampUsersPerSec(20).to(0).during(Duration.ofMinutes(1))</span><br><span class="line">            ),</span><br><span class="line">            </span><br><span class="line">            suggestScenario.injectOpen(</span><br><span class="line">                rampUsersPerSec(1).to(30).during(Duration.ofMinutes(2)),</span><br><span class="line">                constantUsersPerSec(30).during(Duration.ofMinutes(5)),</span><br><span class="line">                rampUsersPerSec(30).to(0).during(Duration.ofMinutes(1))</span><br><span class="line">            )</span><br><span class="line">        ).protocols(httpProtocol)</span><br><span class="line">         .assertions(</span><br><span class="line">             global().responseTime().percentile3().lt(500), // 99%çš„å“åº”æ—¶é—´å°äº500ms</span><br><span class="line">             global().successfulRequests().percent().gt(99.5), // æˆåŠŸç‡å¤§äº99.5%</span><br><span class="line">             details(&quot;æ™®é€šæœç´¢&quot;).responseTime().percentile4().lt(300),</span><br><span class="line">             details(&quot;é«˜çº§æœç´¢&quot;).responseTime().percentile4().lt(800)</span><br><span class="line">         );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ğŸ¯-ç¬¬å››é˜¶æ®µå®Œæˆæ€»ç»“"><a href="#ğŸ¯-ç¬¬å››é˜¶æ®µå®Œæˆæ€»ç»“" class="headerlink" title="ğŸ¯ ç¬¬å››é˜¶æ®µå®Œæˆæ€»ç»“"></a>ğŸ¯ ç¬¬å››é˜¶æ®µå®Œæˆæ€»ç»“</h2><h3 id="å·²å®ç°çš„åŠŸèƒ½ï¼š-2"><a href="#å·²å®ç°çš„åŠŸèƒ½ï¼š-2" class="headerlink" title="å·²å®ç°çš„åŠŸèƒ½ï¼š"></a>å·²å®ç°çš„åŠŸèƒ½ï¼š</h3><ol><li><strong>Elasticsearché›†æˆ</strong>ï¼š<ul><li>å®Œæ•´çš„æ•°æ®ç´¢å¼•å’Œæ˜ å°„é…ç½®</li><li>IKåˆ†è¯å™¨ + æ‹¼éŸ³æœç´¢æ”¯æŒ</li><li>åŒä¹‰è¯æ‰©å±•æœç´¢</li><li>æœç´¢å»ºè®®å’Œè‡ªåŠ¨è¡¥å…¨</li></ul></li><li><strong>é«˜çº§æœç´¢åŠŸèƒ½</strong>ï¼š<ul><li>å¤šæ¡ä»¶å¤åˆæœç´¢</li><li>ä»·æ ¼èŒƒå›´ã€å“ç‰Œã€åˆ†ç±»ç­›é€‰</li><li>æ™ºèƒ½æ‹¼å†™çº æ­£</li><li>ä¸ªæ€§åŒ–æ’åºç®—æ³•</li></ul></li><li><strong>ç›¸å…³æ€§ä¼˜åŒ–</strong>ï¼š<ul><li>å¤šç»´åº¦è¯„åˆ†å‡½æ•°</li><li>ä¸ªæ€§åŒ–æ¨èç®—æ³•</li><li>A&#x2F;Bæµ‹è¯•æ¡†æ¶</li><li>ç»¼åˆæ’åºç­–ç•¥</li></ul></li><li><strong>æ€§èƒ½ç›‘æ§</strong>ï¼š<ul><li>å®æ—¶æ€§èƒ½æŒ‡æ ‡æ”¶é›†</li><li>æ…¢æŸ¥è¯¢æ£€æµ‹å’Œå‘Šè­¦</li><li>ç¼“å­˜å‘½ä¸­ç‡ç»Ÿè®¡</li><li>ç³»ç»Ÿå¥åº·æ£€æŸ¥</li></ul></li><li><strong>APIæ¥å£</strong>ï¼š<ul><li>RESTful APIè®¾è®¡</li><li>æœç´¢æ—¥å¿—ç®¡ç†</li><li>ç´¢å¼•ç»´æŠ¤æ¥å£</li><li>è°ƒè¯•å’Œç›‘æ§æ¥å£</li></ul></li></ol><h3 id="æŠ€æœ¯æ ˆå®è·µï¼š-2"><a href="#æŠ€æœ¯æ ˆå®è·µï¼š-2" class="headerlink" title="æŠ€æœ¯æ ˆå®è·µï¼š"></a>æŠ€æœ¯æ ˆå®è·µï¼š</h3><p>âœ… <strong>æœç´¢å¼•æ“</strong>ï¼šElasticsearch 7.x<br>âœ… <strong>åˆ†è¯å™¨</strong>ï¼šIK Analyzer + æ‹¼éŸ³åˆ†è¯<br>âœ… <strong>ç›‘æ§</strong>ï¼šMicrometer + è‡ªå®šä¹‰ç›‘æ§<br>âœ… <strong>æ€§èƒ½æµ‹è¯•</strong>ï¼šGatling<br>âœ… <strong>å®¹å™¨åŒ–</strong>ï¼šDocker Compose<br>âœ… <strong>ç¼“å­˜</strong>ï¼šRedisäºŒçº§ç¼“å­˜<br>âœ… <strong>åŒä¹‰è¯</strong>ï¼šåŠ¨æ€åŒä¹‰è¯è¯å…¸</p><h3 id="æ€§èƒ½æŒ‡æ ‡ï¼š"><a href="#æ€§èƒ½æŒ‡æ ‡ï¼š" class="headerlink" title="æ€§èƒ½æŒ‡æ ‡ï¼š"></a>æ€§èƒ½æŒ‡æ ‡ï¼š</h3><ol><li><strong>å“åº”æ—¶é—´</strong>ï¼š99%çš„æœç´¢è¯·æ±‚ &lt; 300ms</li><li><strong>å¹¶å‘èƒ½åŠ›</strong>ï¼šæ”¯æŒ100+ QPS</li><li><strong>ç¼“å­˜å‘½ä¸­ç‡</strong>ï¼š&gt; 80%ï¼ˆçƒ­ç‚¹æ•°æ®ï¼‰</li><li><strong>å¯ç”¨æ€§</strong>ï¼š99.9% SLA</li><li><strong>æ•°æ®æ–°é²œåº¦</strong>ï¼šè¿‘å®æ—¶ï¼ˆ&lt; 1ç§’å»¶è¿Ÿï¼‰</li></ol><h3 id="ä¸‹ä¸€æ­¥å»ºè®®ï¼š-2"><a href="#ä¸‹ä¸€æ­¥å»ºè®®ï¼š-2" class="headerlink" title="ä¸‹ä¸€æ­¥å»ºè®®ï¼š"></a>ä¸‹ä¸€æ­¥å»ºè®®ï¼š</h3><p>ç¬¬äº”é˜¶æ®µæˆ‘ä»¬å°†å®ç°<strong>è®¢å•æœåŠ¡</strong>ï¼Œé‡ç‚¹å®è·µï¼š</p><ol><li><strong>åˆ†å¸ƒå¼äº‹åŠ¡</strong>ï¼ˆSeataé›†æˆï¼‰</li><li><strong>è®¢å•çŠ¶æ€æœº</strong></li><li><strong>åº“å­˜æ‰£å‡çš„å¹¶å‘æ§åˆ¶</strong></li><li><strong>è¶…æ—¶è®¢å•è‡ªåŠ¨å–æ¶ˆ</strong></li><li><strong>åˆ†åº“åˆ†è¡¨ç­–ç•¥</strong></li></ol><p>éœ€è¦æˆ‘ç»§ç»­å®ç°è®¢å•æœåŠ¡å—ï¼Ÿ</p><p>ç»§ç»­</p><p>æˆ‘ä»¬è¿›å…¥ç¬¬äº”é˜¶æ®µï¼šè®¢å•æœåŠ¡ï¼ˆç¬¬12-13å¤©ï¼‰<br>è®¢å•æœåŠ¡æ˜¯ç”µå•†ç³»ç»Ÿçš„æ ¸å¿ƒï¼Œå°†æ¶‰åŠåˆ†å¸ƒå¼äº‹åŠ¡ã€è®¢å•çŠ¶æ€æœºã€åº“å­˜å¹¶å‘æ§åˆ¶ã€è¶…æ—¶å–æ¶ˆã€åˆ†åº“åˆ†è¡¨ç­‰ã€‚</p><p>ç¬¬12å¤©ï¼šè®¢å•æœåŠ¡åŸºç¡€æ¶æ„ + åˆ†å¸ƒå¼äº‹åŠ¡ + çŠ¶æ€æœº</p><p>æˆ‘ä»¬å°†å®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š</p><ol><li>è®¢å•æœåŠ¡é¡¹ç›®æ­å»º</li><li>è®¢å•è¡¨ç»“æ„è®¾è®¡ï¼ˆåˆ†åº“åˆ†è¡¨ï¼‰</li><li>è®¢å•çŠ¶æ€æœº</li><li>åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆSeataï¼‰é›†æˆ</li><li>åˆ›å»ºè®¢å•é€»è¾‘ï¼ˆæ‰£å‡åº“å­˜ï¼‰</li></ol><p>ç”±äºç¯‡å¹…é™åˆ¶ï¼Œæˆ‘å°†åˆ†æ­¥éª¤å®ç°ã€‚</p><p>æ­¥éª¤1ï¼šè®¢å•æœåŠ¡é¡¹ç›®ç»“æ„ï¼ˆpom.xmlï¼Œé…ç½®ç­‰ï¼‰<br>æ­¥éª¤2ï¼šè®¢å•è¡¨ç»“æ„ï¼ˆåˆ†åº“åˆ†è¡¨è®¾è®¡ï¼‰<br>æ­¥éª¤3ï¼šè®¢å•çŠ¶æ€æœº<br>æ­¥éª¤4ï¼šåˆ†å¸ƒå¼äº‹åŠ¡é…ç½®<br>æ­¥éª¤5ï¼šåˆ›å»ºè®¢å•é€»è¾‘</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹å®ç°ã€‚</p><h1 id="ğŸ“¦-ç¬¬äº”é˜¶æ®µï¼šè®¢å•æœåŠ¡å®ç°ï¼ˆåˆ†å¸ƒå¼äº‹åŠ¡ä¸å¹¶å‘æ§åˆ¶ï¼‰"><a href="#ğŸ“¦-ç¬¬äº”é˜¶æ®µï¼šè®¢å•æœåŠ¡å®ç°ï¼ˆåˆ†å¸ƒå¼äº‹åŠ¡ä¸å¹¶å‘æ§åˆ¶ï¼‰" class="headerlink" title="ğŸ“¦ ç¬¬äº”é˜¶æ®µï¼šè®¢å•æœåŠ¡å®ç°ï¼ˆåˆ†å¸ƒå¼äº‹åŠ¡ä¸å¹¶å‘æ§åˆ¶ï¼‰"></a>ğŸ“¦ ç¬¬äº”é˜¶æ®µï¼šè®¢å•æœåŠ¡å®ç°ï¼ˆåˆ†å¸ƒå¼äº‹åŠ¡ä¸å¹¶å‘æ§åˆ¶ï¼‰</h1><h2 id="ç¬¬12å¤©ï¼šè®¢å•æœåŠ¡åŸºç¡€æ¶æ„-åˆ†å¸ƒå¼äº‹åŠ¡-çŠ¶æ€æœº"><a href="#ç¬¬12å¤©ï¼šè®¢å•æœåŠ¡åŸºç¡€æ¶æ„-åˆ†å¸ƒå¼äº‹åŠ¡-çŠ¶æ€æœº" class="headerlink" title="ç¬¬12å¤©ï¼šè®¢å•æœåŠ¡åŸºç¡€æ¶æ„ + åˆ†å¸ƒå¼äº‹åŠ¡ + çŠ¶æ€æœº"></a>ç¬¬12å¤©ï¼šè®¢å•æœåŠ¡åŸºç¡€æ¶æ„ + åˆ†å¸ƒå¼äº‹åŠ¡ + çŠ¶æ€æœº</h2><h3 id="1-è®¢å•æœåŠ¡é¡¹ç›®ç»“æ„"><a href="#1-è®¢å•æœåŠ¡é¡¹ç›®ç»“æ„" class="headerlink" title="1. è®¢å•æœåŠ¡é¡¹ç›®ç»“æ„"></a>1. è®¢å•æœåŠ¡é¡¹ç›®ç»“æ„</h3><p>xml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- shophub-order/pom.xml --&gt;</span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;</span><br><span class="line">         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 </span><br><span class="line">         http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;com.shophub&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;shophub-parent&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;1.0.0&lt;/version&gt;</span><br><span class="line">    &lt;/parent&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;artifactId&gt;shophub-order&lt;/artifactId&gt;</span><br><span class="line">    &lt;packaging&gt;jar&lt;/packaging&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;seata.version&gt;1.7.1&lt;/seata.version&gt;</span><br><span class="line">        &lt;rocketmq.version&gt;4.9.7&lt;/rocketmq.version&gt;</span><br><span class="line">    &lt;/properties&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;!-- Spring Boot Starter --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- MyBatis Plus --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.baomidou&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;mybatis-plus-boot-starter&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;mybatis-plus.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- MySQLé©±åŠ¨ --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- Redis --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- Redisson --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.redisson&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;redisson-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;redisson.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- Seata åˆ†å¸ƒå¼äº‹åŠ¡ --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;io.seata&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;seata-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;seata.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- RocketMQ æ¶ˆæ¯é˜Ÿåˆ— --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.rocketmq&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;rocketmq-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;rocketmq.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- Nacos --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- çŠ¶æ€æœº --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.statemachine&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-statemachine-starter&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;3.2.0&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- åˆ†å¸ƒå¼IDç”Ÿæˆå™¨ --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.github.yitter&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;yitter-idgenerator&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.0.6&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- å·¥å…·ç±» --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;commons-lang3&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;commons-collections&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;commons-collections&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;3.2.2&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- é€šç”¨æ¨¡å— --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.shophub&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;shophub-common&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.0.0&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- å•†å“æœåŠ¡API --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.shophub&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;shophub-product&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.0.0&lt;/version&gt;</span><br><span class="line">            &lt;scope&gt;provided&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- åº“å­˜æœåŠ¡API --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.shophub&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;shophub-inventory&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.0.0&lt;/version&gt;</span><br><span class="line">            &lt;scope&gt;provided&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">            &lt;!-- MyBatis Plus ä»£ç ç”Ÿæˆå™¨ --&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.mybatis.generator&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;mybatis-generator-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;1.4.2&lt;/version&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">        &lt;/plugins&gt;</span><br><span class="line">    &lt;/build&gt;</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure><h3 id="2-è®¢å•æœåŠ¡é…ç½®"><a href="#2-è®¢å•æœåŠ¡é…ç½®" class="headerlink" title="2. è®¢å•æœåŠ¡é…ç½®"></a>2. è®¢å•æœåŠ¡é…ç½®</h3><p>yaml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line"># application.yml</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: shophub-order</span><br><span class="line">  profiles:</span><br><span class="line">    active: dev</span><br><span class="line">  </span><br><span class="line">  # æ•°æ®æºé…ç½®ï¼ˆå¤šæ•°æ®æºï¼‰</span><br><span class="line">  datasource:</span><br><span class="line">    dynamic:</span><br><span class="line">      primary: master # è®¾ç½®é»˜è®¤çš„æ•°æ®æºæˆ–è€…æ•°æ®æºç»„ï¼Œé»˜è®¤å€¼å³ä¸ºmaster</span><br><span class="line">      strict: false # ä¸¥æ ¼åŒ¹é…æ•°æ®æºï¼Œé»˜è®¤falseï¼ŒtrueæœªåŒ¹é…åˆ°æŒ‡å®šæ•°æ®æºæ—¶æŠ›å¼‚å¸¸ï¼Œfalseä½¿ç”¨é»˜è®¤æ•°æ®æº</span><br><span class="line">      datasource:</span><br><span class="line">        # ä¸»åº“</span><br><span class="line">        master:</span><br><span class="line">          driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="line">          url: jdbc:mysql://$&#123;MYSQL_HOST:localhost&#125;:3306/shophub_order?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=Asia/Shanghai&amp;useSSL=false</span><br><span class="line">          username: $&#123;MYSQL_USER:root&#125;</span><br><span class="line">          password: $&#123;MYSQL_PASSWORD:root123&#125;</span><br><span class="line">        # ä»åº“</span><br><span class="line">        slave1:</span><br><span class="line">          driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="line">          url: jdbc:mysql://$&#123;MYSQL_SLAVE_HOST:localhost&#125;:3306/shophub_order_slave?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=Asia/Shanghai&amp;useSSL=false</span><br><span class="line">          username: $&#123;MYSQL_USER:root&#125;</span><br><span class="line">          password: $&#123;MYSQL_PASSWORD:root123&#125;</span><br><span class="line">    </span><br><span class="line">    # Hikariè¿æ¥æ± é…ç½®</span><br><span class="line">    hikari:</span><br><span class="line">      connection-timeout: 30000</span><br><span class="line">      maximum-pool-size: 20</span><br><span class="line">      minimum-idle: 5</span><br><span class="line">      idle-timeout: 600000</span><br><span class="line">      max-lifetime: 1800000</span><br><span class="line">      connection-test-query: SELECT 1</span><br><span class="line">  </span><br><span class="line">  # Redisé…ç½®</span><br><span class="line">  redis:</span><br><span class="line">    host: $&#123;REDIS_HOST:localhost&#125;</span><br><span class="line">    port: $&#123;REDIS_PORT:6379&#125;</span><br><span class="line">    password: $&#123;REDIS_PASSWORD:redis123&#125;</span><br><span class="line">    database: 3</span><br><span class="line">    lettuce:</span><br><span class="line">      pool:</span><br><span class="line">        max-active: 20</span><br><span class="line">        max-wait: -1ms</span><br><span class="line">        max-idle: 10</span><br><span class="line">        min-idle: 0</span><br><span class="line">  </span><br><span class="line">  # çŠ¶æ€æœºé…ç½®</span><br><span class="line">  statemachine:</span><br><span class="line">    order:</span><br><span class="line">      states: CREATED,PAID,SHIPPED,RECEIVED,COMPLETED,CANCELLED,REFUNDED</span><br><span class="line">      initial: CREATED</span><br><span class="line">  </span><br><span class="line">  # RocketMQé…ç½®</span><br><span class="line">  rocketmq:</span><br><span class="line">    name-server: $&#123;ROCKETMQ_HOST:localhost&#125;:9876</span><br><span class="line">    producer:</span><br><span class="line">      group: order-producer-group</span><br><span class="line">      send-message-timeout: 3000</span><br><span class="line">      compress-message-body-threshold: 4096</span><br><span class="line">      max-message-size: 4194304</span><br><span class="line">      retry-times-when-send-failed: 2</span><br><span class="line">      retry-times-when-send-async-failed: 2</span><br><span class="line">      retry-next-server: true</span><br><span class="line">  </span><br><span class="line">  # Nacosé…ç½®</span><br><span class="line">  cloud:</span><br><span class="line">    nacos:</span><br><span class="line">      discovery:</span><br><span class="line">        server-addr: $&#123;NACOS_HOST:localhost&#125;:$&#123;NACOS_PORT:8848&#125;</span><br><span class="line">        namespace: public</span><br><span class="line">        group: DEFAULT_GROUP</span><br><span class="line">      config:</span><br><span class="line">        server-addr: $&#123;NACOS_HOST:localhost&#125;:$&#123;NACOS_PORT:8848&#125;</span><br><span class="line">        file-extension: yaml</span><br><span class="line">        group: DEFAULT_GROUP</span><br><span class="line">        namespace: public</span><br><span class="line"></span><br><span class="line"># Seataåˆ†å¸ƒå¼äº‹åŠ¡é…ç½®</span><br><span class="line">seata:</span><br><span class="line">  enabled: true</span><br><span class="line">  application-id: shophub-order</span><br><span class="line">  tx-service-group: my_test_tx_group</span><br><span class="line">  enable-auto-data-source-proxy: true</span><br><span class="line">  config:</span><br><span class="line">    type: nacos</span><br><span class="line">    nacos:</span><br><span class="line">      server-addr: $&#123;NACOS_HOST:localhost&#125;:$&#123;NACOS_PORT:8848&#125;</span><br><span class="line">      namespace: public</span><br><span class="line">      group: SEATA_GROUP</span><br><span class="line">      data-id: seataServer.properties</span><br><span class="line">  registry:</span><br><span class="line">    type: nacos</span><br><span class="line">    nacos:</span><br><span class="line">      application: seata-server</span><br><span class="line">      server-addr: $&#123;NACOS_HOST:localhost&#125;:$&#123;NACOS_PORT:8848&#125;</span><br><span class="line">      namespace: public</span><br><span class="line">      group: DEFAULT_GROUP</span><br><span class="line"></span><br><span class="line"># MyBatis Plusé…ç½®</span><br><span class="line">mybatis-plus:</span><br><span class="line">  configuration:</span><br><span class="line">    map-underscore-to-camel-case: true</span><br><span class="line">    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl</span><br><span class="line">  global-config:</span><br><span class="line">    db-config:</span><br><span class="line">      id-type: ASSIGN_ID</span><br><span class="line">      logic-delete-field: is_deleted</span><br><span class="line">      logic-delete-value: 1</span><br><span class="line">      logic-not-delete-value: 0</span><br><span class="line"></span><br><span class="line"># è®¢å•æœåŠ¡é…ç½®</span><br><span class="line">order:</span><br><span class="line">  # è®¢å•ç¼–å·ç”Ÿæˆç­–ç•¥</span><br><span class="line">  order-no:</span><br><span class="line">    prefix: &quot;SH&quot;  # è®¢å•å·å‰ç¼€</span><br><span class="line">    date-format: &quot;yyyyMMdd&quot;  # æ—¥æœŸæ ¼å¼</span><br><span class="line">    random-length: 6  # éšæœºæ•°é•¿åº¦</span><br><span class="line">    </span><br><span class="line">  # è®¢å•è¶…æ—¶é…ç½®</span><br><span class="line">  timeout:</span><br><span class="line">    unpaid: 1800  # æœªæ”¯ä»˜è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œ30åˆ†é’Ÿ</span><br><span class="line">    unreceived: 604800  # æœªæ”¶è´§è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œ7å¤©</span><br><span class="line">    auto-confirm: 2592000  # è‡ªåŠ¨ç¡®è®¤æ”¶è´§æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œ30å¤©</span><br><span class="line">    </span><br><span class="line">  # åº“å­˜é”å®šé…ç½®</span><br><span class="line">  inventory:</span><br><span class="line">    lock-timeout: 300  # åº“å­˜é”å®šè¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œ5åˆ†é’Ÿ</span><br><span class="line">    max-retry-times: 3  # åº“å­˜é”å®šæœ€å¤§é‡è¯•æ¬¡æ•°</span><br><span class="line">    </span><br><span class="line">  # åˆ†åº“åˆ†è¡¨é…ç½®</span><br><span class="line">  sharding:</span><br><span class="line">    table-count: 8  # è®¢å•è¡¨åˆ†è¡¨æ•°é‡</span><br><span class="line">    database-count: 2  # è®¢å•åº“åˆ†åº“æ•°é‡</span><br><span class="line">    </span><br><span class="line">  # æ¶ˆæ¯é˜Ÿåˆ—é…ç½®</span><br><span class="line">  mq:</span><br><span class="line">    topic: ORDER_TOPIC</span><br><span class="line">    tag:</span><br><span class="line">      create: ORDER_CREATE</span><br><span class="line">      pay: ORDER_PAY</span><br><span class="line">      cancel: ORDER_CANCEL</span><br><span class="line">      timeout: ORDER_TIMEOUT</span><br><span class="line">      </span><br><span class="line">  # é‡è¯•é…ç½®</span><br><span class="line">  retry:</span><br><span class="line">    max-attempts: 3</span><br><span class="line">    backoff-delay: 1000</span><br><span class="line"></span><br><span class="line"># æœåŠ¡ç«¯å£</span><br><span class="line">server:</span><br><span class="line">  port: 8085</span><br><span class="line">  servlet:</span><br><span class="line">    context-path: /order</span><br><span class="line">  tomcat:</span><br><span class="line">    max-swallow-size: -1</span><br><span class="line"></span><br><span class="line"># æ—¥å¿—é…ç½®</span><br><span class="line">logging:</span><br><span class="line">  level:</span><br><span class="line">    com.shophub.order: debug</span><br><span class="line">    io.seata: debug</span><br><span class="line">    org.apache.rocketmq: warn</span><br><span class="line">  pattern:</span><br><span class="line">    console: &#x27;%d&#123;yyyy-MM-dd HH:mm:ss&#125; [%thread] %-5level %logger&#123;36&#125; - %msg%n&#x27;</span><br><span class="line">  file:</span><br><span class="line">    name: logs/order-service.log</span><br><span class="line">    max-size: 10MB</span><br><span class="line">    max-history: 30</span><br><span class="line"></span><br><span class="line"># ç®¡ç†ç«¯ç‚¹</span><br><span class="line">management:</span><br><span class="line">  endpoints:</span><br><span class="line">    web:</span><br><span class="line">      exposure:</span><br><span class="line">        include: health,info,metrics,prometheus,seata</span><br><span class="line">  endpoint:</span><br><span class="line">    health:</span><br><span class="line">      show-details: always</span><br></pre></td></tr></table></figure><h3 id="3-åˆ†åº“åˆ†è¡¨è®¢å•è¡¨è®¾è®¡"><a href="#3-åˆ†åº“åˆ†è¡¨è®¢å•è¡¨è®¾è®¡" class="headerlink" title="3. åˆ†åº“åˆ†è¡¨è®¢å•è¡¨è®¾è®¡"></a>3. åˆ†åº“åˆ†è¡¨è®¢å•è¡¨è®¾è®¡</h3><p>sql</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line">-- ä¸»åº“è®¢å•è¡¨ï¼ˆæŒ‰æœˆåˆ†è¡¨ï¼‰</span><br><span class="line">-- è®¢å•è¡¨2024å¹´1æœˆ</span><br><span class="line">CREATE TABLE `order_202401` (</span><br><span class="line">  `id` bigint(20) NOT NULL COMMENT &#x27;è®¢å•IDï¼ˆé›ªèŠ±ç®—æ³•ï¼‰&#x27;,</span><br><span class="line">  `order_no` varchar(32) NOT NULL COMMENT &#x27;è®¢å•å·&#x27;,</span><br><span class="line">  `user_id` bigint(20) NOT NULL COMMENT &#x27;ç”¨æˆ·ID&#x27;,</span><br><span class="line">  `total_amount` decimal(10,2) NOT NULL DEFAULT &#x27;0.00&#x27; COMMENT &#x27;è®¢å•æ€»é‡‘é¢&#x27;,</span><br><span class="line">  `pay_amount` decimal(10,2) NOT NULL DEFAULT &#x27;0.00&#x27; COMMENT &#x27;å®ä»˜é‡‘é¢&#x27;,</span><br><span class="line">  `freight_amount` decimal(10,2) DEFAULT &#x27;0.00&#x27; COMMENT &#x27;è¿è´¹&#x27;,</span><br><span class="line">  `discount_amount` decimal(10,2) DEFAULT &#x27;0.00&#x27; COMMENT &#x27;ä¼˜æƒ é‡‘é¢&#x27;,</span><br><span class="line">  `pay_type` tinyint(1) DEFAULT NULL COMMENT &#x27;æ”¯ä»˜æ–¹å¼ï¼š1-æ”¯ä»˜å®ï¼Œ2-å¾®ä¿¡ï¼Œ3-é“¶è”&#x27;,</span><br><span class="line">  `status` tinyint(1) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;è®¢å•çŠ¶æ€ï¼š0-å¾…æ”¯ä»˜ï¼Œ1-å·²æ”¯ä»˜ï¼Œ2-å·²å‘è´§ï¼Œ3-å·²å®Œæˆï¼Œ4-å·²å–æ¶ˆï¼Œ5-é€€æ¬¾ä¸­ï¼Œ6-å·²é€€æ¬¾&#x27;,</span><br><span class="line">  `delivery_company` varchar(100) DEFAULT NULL COMMENT &#x27;ç‰©æµå…¬å¸&#x27;,</span><br><span class="line">  `delivery_no` varchar(100) DEFAULT NULL COMMENT &#x27;ç‰©æµå•å·&#x27;,</span><br><span class="line">  `receiver_name` varchar(50) NOT NULL COMMENT &#x27;æ”¶è´§äººå§“å&#x27;,</span><br><span class="line">  `receiver_phone` varchar(20) NOT NULL COMMENT &#x27;æ”¶è´§äººç”µè¯&#x27;,</span><br><span class="line">  `receiver_province` varchar(50) DEFAULT NULL COMMENT &#x27;çœ&#x27;,</span><br><span class="line">  `receiver_city` varchar(50) DEFAULT NULL COMMENT &#x27;å¸‚&#x27;,</span><br><span class="line">  `receiver_region` varchar(50) DEFAULT NULL COMMENT &#x27;åŒº&#x27;,</span><br><span class="line">  `receiver_address` varchar(200) NOT NULL COMMENT &#x27;è¯¦ç»†åœ°å€&#x27;,</span><br><span class="line">  `remark` varchar(500) DEFAULT NULL COMMENT &#x27;è®¢å•å¤‡æ³¨&#x27;,</span><br><span class="line">  `pay_time` datetime DEFAULT NULL COMMENT &#x27;æ”¯ä»˜æ—¶é—´&#x27;,</span><br><span class="line">  `delivery_time` datetime DEFAULT NULL COMMENT &#x27;å‘è´§æ—¶é—´&#x27;,</span><br><span class="line">  `receive_time` datetime DEFAULT NULL COMMENT &#x27;æ”¶è´§æ—¶é—´&#x27;,</span><br><span class="line">  `cancel_time` datetime DEFAULT NULL COMMENT &#x27;å–æ¶ˆæ—¶é—´&#x27;,</span><br><span class="line">  `cancel_reason` varchar(200) DEFAULT NULL COMMENT &#x27;å–æ¶ˆåŸå› &#x27;,</span><br><span class="line">  `refund_time` datetime DEFAULT NULL COMMENT &#x27;é€€æ¬¾æ—¶é—´&#x27;,</span><br><span class="line">  `refund_reason` varchar(200) DEFAULT NULL COMMENT &#x27;é€€æ¬¾åŸå› &#x27;,</span><br><span class="line">  `auto_confirm_days` int(11) DEFAULT &#x27;15&#x27; COMMENT &#x27;è‡ªåŠ¨ç¡®è®¤æ”¶è´§å¤©æ•°&#x27;,</span><br><span class="line">  `is_deleted` tinyint(1) DEFAULT &#x27;0&#x27; COMMENT &#x27;æ˜¯å¦åˆ é™¤ï¼š0-å¦ï¼Œ1-æ˜¯&#x27;,</span><br><span class="line">  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;åˆ›å»ºæ—¶é—´&#x27;,</span><br><span class="line">  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &#x27;æ›´æ–°æ—¶é—´&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_order_no` (`order_no`),</span><br><span class="line">  KEY `idx_user_id` (`user_id`),</span><br><span class="line">  KEY `idx_status` (`status`),</span><br><span class="line">  KEY `idx_create_time` (`create_time`),</span><br><span class="line">  KEY `idx_pay_time` (`pay_time`),</span><br><span class="line">  KEY `idx_user_status` (`user_id`,`status`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=&#x27;è®¢å•è¡¨&#x27;</span><br><span class="line">PARTITION BY RANGE (TO_DAYS(create_time)) (</span><br><span class="line">    PARTITION p202401 VALUES LESS THAN (TO_DAYS(&#x27;2024-02-01&#x27;)),</span><br><span class="line">    PARTITION p202402 VALUES LESS THAN (TO_DAYS(&#x27;2024-03-01&#x27;))</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">-- è®¢å•å•†å“è¡¨ï¼ˆä¸è®¢å•åŒåº“ï¼Œä¸åˆ†è¡¨ï¼‰</span><br><span class="line">CREATE TABLE `order_item` (</span><br><span class="line">  `id` bigint(20) NOT NULL COMMENT &#x27;ä¸»é”®ID&#x27;,</span><br><span class="line">  `order_id` bigint(20) NOT NULL COMMENT &#x27;è®¢å•ID&#x27;,</span><br><span class="line">  `order_no` varchar(32) NOT NULL COMMENT &#x27;è®¢å•å·&#x27;,</span><br><span class="line">  `product_id` bigint(20) NOT NULL COMMENT &#x27;å•†å“ID&#x27;,</span><br><span class="line">  `product_name` varchar(200) NOT NULL COMMENT &#x27;å•†å“åç§°&#x27;,</span><br><span class="line">  `product_image` varchar(500) DEFAULT NULL COMMENT &#x27;å•†å“å›¾ç‰‡&#x27;,</span><br><span class="line">  `product_price` decimal(10,2) NOT NULL COMMENT &#x27;å•†å“å•ä»·&#x27;,</span><br><span class="line">  `product_attr` varchar(500) DEFAULT NULL COMMENT &#x27;å•†å“å±æ€§ï¼ˆJSONï¼‰&#x27;,</span><br><span class="line">  `quantity` int(11) NOT NULL COMMENT &#x27;è´­ä¹°æ•°é‡&#x27;,</span><br><span class="line">  `total_amount` decimal(10,2) NOT NULL COMMENT &#x27;å•†å“æ€»ä»·&#x27;,</span><br><span class="line">  `is_deleted` tinyint(1) DEFAULT &#x27;0&#x27; COMMENT &#x27;æ˜¯å¦åˆ é™¤ï¼š0-å¦ï¼Œ1-æ˜¯&#x27;,</span><br><span class="line">  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;åˆ›å»ºæ—¶é—´&#x27;,</span><br><span class="line">  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &#x27;æ›´æ–°æ—¶é—´&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  KEY `idx_order_id` (`order_id`),</span><br><span class="line">  KEY `idx_product_id` (`product_id`),</span><br><span class="line">  KEY `idx_create_time` (`create_time`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=&#x27;è®¢å•å•†å“è¡¨&#x27;;</span><br><span class="line"></span><br><span class="line">-- è®¢å•æ“ä½œæ—¥å¿—è¡¨</span><br><span class="line">CREATE TABLE `order_operation_log` (</span><br><span class="line">  `id` bigint(20) NOT NULL COMMENT &#x27;ä¸»é”®ID&#x27;,</span><br><span class="line">  `order_id` bigint(20) NOT NULL COMMENT &#x27;è®¢å•ID&#x27;,</span><br><span class="line">  `order_no` varchar(32) NOT NULL COMMENT &#x27;è®¢å•å·&#x27;,</span><br><span class="line">  `operation_type` varchar(50) NOT NULL COMMENT &#x27;æ“ä½œç±»å‹ï¼šCREATE-åˆ›å»ºï¼ŒPAY-æ”¯ä»˜ï¼ŒCANCEL-å–æ¶ˆï¼ŒSHIP-å‘è´§ï¼ŒRECEIVE-æ”¶è´§ï¼ŒREFUND-é€€æ¬¾&#x27;,</span><br><span class="line">  `operation_user` varchar(100) DEFAULT NULL COMMENT &#x27;æ“ä½œäºº&#x27;,</span><br><span class="line">  `operation_user_type` tinyint(1) DEFAULT NULL COMMENT &#x27;æ“ä½œäººç±»å‹ï¼š1-ç”¨æˆ·ï¼Œ2-ç³»ç»Ÿï¼Œ3-ç®¡ç†å‘˜&#x27;,</span><br><span class="line">  `operation_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;æ“ä½œæ—¶é—´&#x27;,</span><br><span class="line">  `operation_content` varchar(500) DEFAULT NULL COMMENT &#x27;æ“ä½œå†…å®¹&#x27;,</span><br><span class="line">  `before_status` tinyint(1) DEFAULT NULL COMMENT &#x27;æ“ä½œå‰çŠ¶æ€&#x27;,</span><br><span class="line">  `after_status` tinyint(1) DEFAULT NULL COMMENT &#x27;æ“ä½œåçŠ¶æ€&#x27;,</span><br><span class="line">  `remark` varchar(500) DEFAULT NULL COMMENT &#x27;å¤‡æ³¨&#x27;,</span><br><span class="line">  `is_deleted` tinyint(1) DEFAULT &#x27;0&#x27; COMMENT &#x27;æ˜¯å¦åˆ é™¤ï¼š0-å¦ï¼Œ1-æ˜¯&#x27;,</span><br><span class="line">  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;åˆ›å»ºæ—¶é—´&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  KEY `idx_order_id` (`order_id`),</span><br><span class="line">  KEY `idx_operation_time` (`operation_time`),</span><br><span class="line">  KEY `idx_operation_type` (`operation_type`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=&#x27;è®¢å•æ“ä½œæ—¥å¿—è¡¨&#x27;;</span><br><span class="line"></span><br><span class="line">-- è®¢å•é€€æ¬¾è®°å½•è¡¨</span><br><span class="line">CREATE TABLE `order_refund` (</span><br><span class="line">  `id` bigint(20) NOT NULL COMMENT &#x27;é€€æ¬¾ID&#x27;,</span><br><span class="line">  `refund_no` varchar(32) NOT NULL COMMENT &#x27;é€€æ¬¾å•å·&#x27;,</span><br><span class="line">  `order_id` bigint(20) NOT NULL COMMENT &#x27;è®¢å•ID&#x27;,</span><br><span class="line">  `order_no` varchar(32) NOT NULL COMMENT &#x27;è®¢å•å·&#x27;,</span><br><span class="line">  `user_id` bigint(20) NOT NULL COMMENT &#x27;ç”¨æˆ·ID&#x27;,</span><br><span class="line">  `refund_amount` decimal(10,2) NOT NULL COMMENT &#x27;é€€æ¬¾é‡‘é¢&#x27;,</span><br><span class="line">  `refund_type` tinyint(1) NOT NULL COMMENT &#x27;é€€æ¬¾ç±»å‹ï¼š1-ä»…é€€æ¬¾ï¼Œ2-é€€è´§é€€æ¬¾&#x27;,</span><br><span class="line">  `refund_reason` varchar(500) DEFAULT NULL COMMENT &#x27;é€€æ¬¾åŸå› &#x27;,</span><br><span class="line">  `refund_status` tinyint(1) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;é€€æ¬¾çŠ¶æ€ï¼š0-ç”³è¯·ä¸­ï¼Œ1-åŒæ„é€€æ¬¾ï¼Œ2-æ‹’ç»é€€æ¬¾ï¼Œ3-é€€æ¬¾æˆåŠŸï¼Œ4-é€€æ¬¾å¤±è´¥&#x27;,</span><br><span class="line">  `refund_evidence` varchar(1000) DEFAULT NULL COMMENT &#x27;é€€æ¬¾å‡­è¯ï¼ˆJSONï¼‰&#x27;,</span><br><span class="line">  `refuse_reason` varchar(500) DEFAULT NULL COMMENT &#x27;æ‹’ç»åŸå› &#x27;,</span><br><span class="line">  `refund_time` datetime DEFAULT NULL COMMENT &#x27;é€€æ¬¾æ—¶é—´&#x27;,</span><br><span class="line">  `complete_time` datetime DEFAULT NULL COMMENT &#x27;å®Œæˆæ—¶é—´&#x27;,</span><br><span class="line">  `is_deleted` tinyint(1) DEFAULT &#x27;0&#x27; COMMENT &#x27;æ˜¯å¦åˆ é™¤ï¼š0-å¦ï¼Œ1-æ˜¯&#x27;,</span><br><span class="line">  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;åˆ›å»ºæ—¶é—´&#x27;,</span><br><span class="line">  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &#x27;æ›´æ–°æ—¶é—´&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_refund_no` (`refund_no`),</span><br><span class="line">  KEY `idx_order_id` (`order_id`),</span><br><span class="line">  KEY `idx_user_id` (`user_id`),</span><br><span class="line">  KEY `idx_refund_status` (`refund_status`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=&#x27;è®¢å•é€€æ¬¾è®°å½•è¡¨&#x27;;</span><br><span class="line"></span><br><span class="line">-- ä»åº“è®¢å•ç»Ÿè®¡è¡¨ï¼ˆç”¨äºåˆ†ææŸ¥è¯¢ï¼Œé¿å…å½±å“ä¸»åº“ï¼‰</span><br><span class="line">CREATE TABLE `order_statistics` (</span><br><span class="line">  `id` bigint(20) NOT NULL COMMENT &#x27;ç»Ÿè®¡ID&#x27;,</span><br><span class="line">  `stat_date` date NOT NULL COMMENT &#x27;ç»Ÿè®¡æ—¥æœŸ&#x27;,</span><br><span class="line">  `total_orders` int(11) DEFAULT &#x27;0&#x27; COMMENT &#x27;è®¢å•æ€»æ•°&#x27;,</span><br><span class="line">  `total_amount` decimal(15,2) DEFAULT &#x27;0.00&#x27; COMMENT &#x27;è®¢å•æ€»é‡‘é¢&#x27;,</span><br><span class="line">  `paid_orders` int(11) DEFAULT &#x27;0&#x27; COMMENT &#x27;å·²æ”¯ä»˜è®¢å•æ•°&#x27;,</span><br><span class="line">  `paid_amount` decimal(15,2) DEFAULT &#x27;0.00&#x27; COMMENT &#x27;å·²æ”¯ä»˜é‡‘é¢&#x27;,</span><br><span class="line">  `refund_orders` int(11) DEFAULT &#x27;0&#x27; COMMENT &#x27;é€€æ¬¾è®¢å•æ•°&#x27;,</span><br><span class="line">  `refund_amount` decimal(15,2) DEFAULT &#x27;0.00&#x27; COMMENT &#x27;é€€æ¬¾é‡‘é¢&#x27;,</span><br><span class="line">  `avg_order_amount` decimal(10,2) DEFAULT &#x27;0.00&#x27; COMMENT &#x27;å¹³å‡è®¢å•é‡‘é¢&#x27;,</span><br><span class="line">  `user_count` int(11) DEFAULT &#x27;0&#x27; COMMENT &#x27;ä¸‹å•ç”¨æˆ·æ•°&#x27;,</span><br><span class="line">  `new_user_count` int(11) DEFAULT &#x27;0&#x27; COMMENT &#x27;æ–°ç”¨æˆ·æ•°&#x27;,</span><br><span class="line">  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;åˆ›å»ºæ—¶é—´&#x27;,</span><br><span class="line">  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &#x27;æ›´æ–°æ—¶é—´&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_stat_date` (`stat_date`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=&#x27;è®¢å•ç»Ÿè®¡è¡¨&#x27;;</span><br></pre></td></tr></table></figure><h3 id="4-è®¢å•å®ä½“ç±»å’ŒVO"><a href="#4-è®¢å•å®ä½“ç±»å’ŒVO" class="headerlink" title="4. è®¢å•å®ä½“ç±»å’ŒVO"></a>4. è®¢å•å®ä½“ç±»å’ŒVO</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.order.entity;</span><br><span class="line"></span><br><span class="line">import com.baomidou.mybatisplus.annotation.*;</span><br><span class="line">import com.fasterxml.jackson.annotation.JsonFormat;</span><br><span class="line">import lombok.Data;</span><br><span class="line">import lombok.EqualsAndHashCode;</span><br><span class="line"></span><br><span class="line">import java.io.Serializable;</span><br><span class="line">import java.math.BigDecimal;</span><br><span class="line">import java.time.LocalDateTime;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * è®¢å•å®ä½“ç±»</span><br><span class="line"> */</span><br><span class="line">@Data</span><br><span class="line">@EqualsAndHashCode(callSuper = false)</span><br><span class="line">@TableName(&quot;order_202401&quot;)</span><br><span class="line">public class Order implements Serializable &#123;</span><br><span class="line">    </span><br><span class="line">    private static final long serialVersionUID = 1L;</span><br><span class="line">    </span><br><span class="line">    @TableId(value = &quot;id&quot;, type = IdType.ASSIGN_ID)</span><br><span class="line">    private Long id;</span><br><span class="line">    </span><br><span class="line">    @TableField(&quot;order_no&quot;)</span><br><span class="line">    private String orderNo;</span><br><span class="line">    </span><br><span class="line">    @TableField(&quot;user_id&quot;)</span><br><span class="line">    private Long userId;</span><br><span class="line">    </span><br><span class="line">    @TableField(&quot;total_amount&quot;)</span><br><span class="line">    private BigDecimal totalAmount;</span><br><span class="line">    </span><br><span class="line">    @TableField(&quot;pay_amount&quot;)</span><br><span class="line">    private BigDecimal payAmount;</span><br><span class="line">    </span><br><span class="line">    @TableField(&quot;freight_amount&quot;)</span><br><span class="line">    private BigDecimal freightAmount;</span><br><span class="line">    </span><br><span class="line">    @TableField(&quot;discount_amount&quot;)</span><br><span class="line">    private BigDecimal discountAmount;</span><br><span class="line">    </span><br><span class="line">    @TableField(&quot;pay_type&quot;)</span><br><span class="line">    private Integer payType;</span><br><span class="line">    </span><br><span class="line">    private Integer status;</span><br><span class="line">    </span><br><span class="line">    @TableField(&quot;delivery_company&quot;)</span><br><span class="line">    private String deliveryCompany;</span><br><span class="line">    </span><br><span class="line">    @TableField(&quot;delivery_no&quot;)</span><br><span class="line">    private String deliveryNo;</span><br><span class="line">    </span><br><span class="line">    @TableField(&quot;receiver_name&quot;)</span><br><span class="line">    private String receiverName;</span><br><span class="line">    </span><br><span class="line">    @TableField(&quot;receiver_phone&quot;)</span><br><span class="line">    private String receiverPhone;</span><br><span class="line">    </span><br><span class="line">    @TableField(&quot;receiver_province&quot;)</span><br><span class="line">    private String receiverProvince;</span><br><span class="line">    </span><br><span class="line">    @TableField(&quot;receiver_city&quot;)</span><br><span class="line">    private String receiverCity;</span><br><span class="line">    </span><br><span class="line">    @TableField(&quot;receiver_region&quot;)</span><br><span class="line">    private String receiverRegion;</span><br><span class="line">    </span><br><span class="line">    @TableField(&quot;receiver_address&quot;)</span><br><span class="line">    private String receiverAddress;</span><br><span class="line">    </span><br><span class="line">    private String remark;</span><br><span class="line">    </span><br><span class="line">    @TableField(&quot;pay_time&quot;)</span><br><span class="line">    @JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span><br><span class="line">    private LocalDateTime payTime;</span><br><span class="line">    </span><br><span class="line">    @TableField(&quot;delivery_time&quot;)</span><br><span class="line">    @JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span><br><span class="line">    private LocalDateTime deliveryTime;</span><br><span class="line">    </span><br><span class="line">    @TableField(&quot;receive_time&quot;)</span><br><span class="line">    @JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span><br><span class="line">    private LocalDateTime receiveTime;</span><br><span class="line">    </span><br><span class="line">    @TableField(&quot;cancel_time&quot;)</span><br><span class="line">    @JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span><br><span class="line">    private LocalDateTime cancelTime;</span><br><span class="line">    </span><br><span class="line">    @TableField(&quot;cancel_reason&quot;)</span><br><span class="line">    private String cancelReason;</span><br><span class="line">    </span><br><span class="line">    @TableField(&quot;refund_time&quot;)</span><br><span class="line">    @JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span><br><span class="line">    private LocalDateTime refundTime;</span><br><span class="line">    </span><br><span class="line">    @TableField(&quot;refund_reason&quot;)</span><br><span class="line">    private String refundReason;</span><br><span class="line">    </span><br><span class="line">    @TableField(&quot;auto_confirm_days&quot;)</span><br><span class="line">    private Integer autoConfirmDays;</span><br><span class="line">    </span><br><span class="line">    @TableLogic</span><br><span class="line">    @TableField(&quot;is_deleted&quot;)</span><br><span class="line">    private Integer isDeleted;</span><br><span class="line">    </span><br><span class="line">    @TableField(fill = FieldFill.INSERT)</span><br><span class="line">    @JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span><br><span class="line">    private LocalDateTime createTime;</span><br><span class="line">    </span><br><span class="line">    @TableField(fill = FieldFill.INSERT_UPDATE)</span><br><span class="line">    @JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span><br><span class="line">    private LocalDateTime updateTime;</span><br><span class="line">    </span><br><span class="line">    // éæ•°æ®åº“å­—æ®µ</span><br><span class="line">    @TableField(exist = false)</span><br><span class="line">    private List&lt;OrderItem&gt; orderItems;</span><br><span class="line">    </span><br><span class="line">    @TableField(exist = false)</span><br><span class="line">    private String statusDesc;</span><br><span class="line">    </span><br><span class="line">    @TableField(exist = false)</span><br><span class="line">    private String payTypeDesc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// è®¢å•å•†å“å®ä½“</span><br><span class="line">@Data</span><br><span class="line">@EqualsAndHashCode(callSuper = false)</span><br><span class="line">@TableName(&quot;order_item&quot;)</span><br><span class="line">class OrderItem implements Serializable &#123;</span><br><span class="line">    </span><br><span class="line">    private static final long serialVersionUID = 1L;</span><br><span class="line">    </span><br><span class="line">    @TableId(value = &quot;id&quot;, type = IdType.ASSIGN_ID)</span><br><span class="line">    private Long id;</span><br><span class="line">    </span><br><span class="line">    @TableField(&quot;order_id&quot;)</span><br><span class="line">    private Long orderId;</span><br><span class="line">    </span><br><span class="line">    @TableField(&quot;order_no&quot;)</span><br><span class="line">    private String orderNo;</span><br><span class="line">    </span><br><span class="line">    @TableField(&quot;product_id&quot;)</span><br><span class="line">    private Long productId;</span><br><span class="line">    </span><br><span class="line">    @TableField(&quot;product_name&quot;)</span><br><span class="line">    private String productName;</span><br><span class="line">    </span><br><span class="line">    @TableField(&quot;product_image&quot;)</span><br><span class="line">    private String productImage;</span><br><span class="line">    </span><br><span class="line">    @TableField(&quot;product_price&quot;)</span><br><span class="line">    private BigDecimal productPrice;</span><br><span class="line">    </span><br><span class="line">    @TableField(&quot;product_attr&quot;)</span><br><span class="line">    private String productAttr;</span><br><span class="line">    </span><br><span class="line">    private Integer quantity;</span><br><span class="line">    </span><br><span class="line">    @TableField(&quot;total_amount&quot;)</span><br><span class="line">    private BigDecimal totalAmount;</span><br><span class="line">    </span><br><span class="line">    @TableLogic</span><br><span class="line">    @TableField(&quot;is_deleted&quot;)</span><br><span class="line">    private Integer isDeleted;</span><br><span class="line">    </span><br><span class="line">    @TableField(fill = FieldFill.INSERT)</span><br><span class="line">    private LocalDateTime createTime;</span><br><span class="line">    </span><br><span class="line">    @TableField(fill = FieldFill.INSERT_UPDATE)</span><br><span class="line">    private LocalDateTime updateTime;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// è®¢å•æ“ä½œæ—¥å¿—å®ä½“</span><br><span class="line">@Data</span><br><span class="line">@EqualsAndHashCode(callSuper = false)</span><br><span class="line">@TableName(&quot;order_operation_log&quot;)</span><br><span class="line">class OrderOperationLog implements Serializable &#123;</span><br><span class="line">    </span><br><span class="line">    private static final long serialVersionUID = 1L;</span><br><span class="line">    </span><br><span class="line">    @TableId(value = &quot;id&quot;, type = IdType.ASSIGN_ID)</span><br><span class="line">    private Long id;</span><br><span class="line">    </span><br><span class="line">    @TableField(&quot;order_id&quot;)</span><br><span class="line">    private Long orderId;</span><br><span class="line">    </span><br><span class="line">    @TableField(&quot;order_no&quot;)</span><br><span class="line">    private String orderNo;</span><br><span class="line">    </span><br><span class="line">    @TableField(&quot;operation_type&quot;)</span><br><span class="line">    private String operationType;</span><br><span class="line">    </span><br><span class="line">    @TableField(&quot;operation_user&quot;)</span><br><span class="line">    private String operationUser;</span><br><span class="line">    </span><br><span class="line">    @TableField(&quot;operation_user_type&quot;)</span><br><span class="line">    private Integer operationUserType;</span><br><span class="line">    </span><br><span class="line">    @TableField(&quot;operation_time&quot;)</span><br><span class="line">    private LocalDateTime operationTime;</span><br><span class="line">    </span><br><span class="line">    @TableField(&quot;operation_content&quot;)</span><br><span class="line">    private String operationContent;</span><br><span class="line">    </span><br><span class="line">    @TableField(&quot;before_status&quot;)</span><br><span class="line">    private Integer beforeStatus;</span><br><span class="line">    </span><br><span class="line">    @TableField(&quot;after_status&quot;)</span><br><span class="line">    private Integer afterStatus;</span><br><span class="line">    </span><br><span class="line">    private String remark;</span><br><span class="line">    </span><br><span class="line">    @TableLogic</span><br><span class="line">    @TableField(&quot;is_deleted&quot;)</span><br><span class="line">    private Integer isDeleted;</span><br><span class="line">    </span><br><span class="line">    @TableField(fill = FieldFill.INSERT)</span><br><span class="line">    private LocalDateTime createTime;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// è®¢å•VOï¼ˆç”¨äºå‰ç«¯å±•ç¤ºï¼‰</span><br><span class="line">@Data</span><br><span class="line">@Builder</span><br><span class="line">class OrderVo &#123;</span><br><span class="line">    private Long id;</span><br><span class="line">    private String orderNo;</span><br><span class="line">    private Long userId;</span><br><span class="line">    private BigDecimal totalAmount;</span><br><span class="line">    private BigDecimal payAmount;</span><br><span class="line">    private BigDecimal freightAmount;</span><br><span class="line">    private BigDecimal discountAmount;</span><br><span class="line">    private Integer payType;</span><br><span class="line">    private String payTypeDesc;</span><br><span class="line">    private Integer status;</span><br><span class="line">    private String statusDesc;</span><br><span class="line">    private String deliveryCompany;</span><br><span class="line">    private String deliveryNo;</span><br><span class="line">    private String receiverName;</span><br><span class="line">    private String receiverPhone;</span><br><span class="line">    private String receiverAddress;</span><br><span class="line">    private String remark;</span><br><span class="line">    private LocalDateTime payTime;</span><br><span class="line">    private LocalDateTime deliveryTime;</span><br><span class="line">    private LocalDateTime receiveTime;</span><br><span class="line">    private LocalDateTime cancelTime;</span><br><span class="line">    private String cancelReason;</span><br><span class="line">    private LocalDateTime createTime;</span><br><span class="line">    private List&lt;OrderItemVo&gt; orderItems;</span><br><span class="line">    private List&lt;OrderOperationLogVo&gt; operationLogs;</span><br><span class="line">    private Boolean canCancel;  // æ˜¯å¦å¯ä»¥å–æ¶ˆ</span><br><span class="line">    private Boolean canPay;     // æ˜¯å¦å¯ä»¥æ”¯ä»˜</span><br><span class="line">    private Boolean canConfirm; // æ˜¯å¦å¯ä»¥ç¡®è®¤æ”¶è´§</span><br><span class="line">    private Boolean canRefund;  // æ˜¯å¦å¯ä»¥é€€æ¬¾</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// åˆ›å»ºè®¢å•è¯·æ±‚VO</span><br><span class="line">@Data</span><br><span class="line">@Validated</span><br><span class="line">class CreateOrderRequest &#123;</span><br><span class="line">    </span><br><span class="line">    @NotNull(message = &quot;æ”¶è´§åœ°å€IDä¸èƒ½ä¸ºç©º&quot;)</span><br><span class="line">    private Long addressId;</span><br><span class="line">    </span><br><span class="line">    @NotEmpty(message = &quot;è®¢å•å•†å“ä¸èƒ½ä¸ºç©º&quot;)</span><br><span class="line">    private List&lt;OrderItemRequest&gt; orderItems;</span><br><span class="line">    </span><br><span class="line">    @NotNull(message = &quot;æ”¯ä»˜æ–¹å¼ä¸èƒ½ä¸ºç©º&quot;)</span><br><span class="line">    @Range(min = 1, max = 3, message = &quot;æ”¯ä»˜æ–¹å¼ä¸åˆæ³•&quot;)</span><br><span class="line">    private Integer payType;</span><br><span class="line">    </span><br><span class="line">    private String remark;</span><br><span class="line">    </span><br><span class="line">    private Long couponId;</span><br><span class="line">    </span><br><span class="line">    @Data</span><br><span class="line">    public static class OrderItemRequest &#123;</span><br><span class="line">        @NotNull(message = &quot;å•†å“IDä¸èƒ½ä¸ºç©º&quot;)</span><br><span class="line">        private Long productId;</span><br><span class="line">        </span><br><span class="line">        @NotNull(message = &quot;å•†å“æ•°é‡ä¸èƒ½ä¸ºç©º&quot;)</span><br><span class="line">        @Min(value = 1, message = &quot;å•†å“æ•°é‡å¿…é¡»å¤§äº0&quot;)</span><br><span class="line">        private Integer quantity;</span><br><span class="line">        </span><br><span class="line">        private String productAttr; // å•†å“å±æ€§JSON</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// è®¢å•æŸ¥è¯¢æ¡ä»¶VO</span><br><span class="line">@Data</span><br><span class="line">class OrderQueryRequest &#123;</span><br><span class="line">    private Long userId;</span><br><span class="line">    private Integer status;</span><br><span class="line">    private String orderNo;</span><br><span class="line">    private String receiverName;</span><br><span class="line">    private String receiverPhone;</span><br><span class="line">    private LocalDateTime startTime;</span><br><span class="line">    private LocalDateTime endTime;</span><br><span class="line">    private Integer pageNum = 1;</span><br><span class="line">    private Integer pageSize = 10;</span><br><span class="line">    private String sortBy = &quot;create_time&quot;;</span><br><span class="line">    private String sortOrder = &quot;desc&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-è®¢å•çŠ¶æ€æœºé…ç½®"><a href="#5-è®¢å•çŠ¶æ€æœºé…ç½®" class="headerlink" title="5. è®¢å•çŠ¶æ€æœºé…ç½®"></a>5. è®¢å•çŠ¶æ€æœºé…ç½®</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.order.statemachine;</span><br><span class="line"></span><br><span class="line">import com.shophub.order.constants.OrderConstants;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.statemachine.StateMachineContext;</span><br><span class="line">import org.springframework.statemachine.StateMachinePersist;</span><br><span class="line">import org.springframework.statemachine.annotation.OnTransition;</span><br><span class="line">import org.springframework.statemachine.annotation.WithStateMachine;</span><br><span class="line">import org.springframework.statemachine.config.EnableStateMachine;</span><br><span class="line">import org.springframework.statemachine.config.EnumStateMachineConfigurerAdapter;</span><br><span class="line">import org.springframework.statemachine.config.builders.StateMachineConfigurationConfigurer;</span><br><span class="line">import org.springframework.statemachine.config.builders.StateMachineStateConfigurer;</span><br><span class="line">import org.springframework.statemachine.config.builders.StateMachineTransitionConfigurer;</span><br><span class="line">import org.springframework.statemachine.persist.DefaultStateMachinePersister;</span><br><span class="line">import org.springframework.statemachine.persist.StateMachinePersister;</span><br><span class="line">import org.springframework.statemachine.support.DefaultStateMachineContext;</span><br><span class="line"></span><br><span class="line">import java.util.EnumSet;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * è®¢å•çŠ¶æ€æœºé…ç½®</span><br><span class="line"> * çŠ¶æ€å®šä¹‰ï¼š</span><br><span class="line"> * CREATED(0, &quot;å¾…æ”¯ä»˜&quot;) -&gt; PAID(1, &quot;å·²æ”¯ä»˜&quot;) -&gt; SHIPPED(2, &quot;å·²å‘è´§&quot;) -&gt; RECEIVED(3, &quot;å·²æ”¶è´§&quot;) -&gt; COMPLETED(4, &quot;å·²å®Œæˆ&quot;)</span><br><span class="line"> *              |-&gt; CANCELLED(5, &quot;å·²å–æ¶ˆ&quot;)                    |-&gt; REFUNDED(6, &quot;å·²é€€æ¬¾&quot;)</span><br><span class="line"> */</span><br><span class="line">@Slf4j</span><br><span class="line">@Configuration</span><br><span class="line">@EnableStateMachine</span><br><span class="line">public class OrderStateMachineConfig extends EnumStateMachineConfigurerAdapter&lt;OrderState, OrderEvent&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * é…ç½®çŠ¶æ€</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public void configure(StateMachineStateConfigurer&lt;OrderState, OrderEvent&gt; states) throws Exception &#123;</span><br><span class="line">        states.withStates()</span><br><span class="line">                .initial(OrderState.CREATED)</span><br><span class="line">                .states(EnumSet.allOf(OrderState.class))</span><br><span class="line">                .end(OrderState.COMPLETED)</span><br><span class="line">                .end(OrderState.CANCELLED)</span><br><span class="line">                .end(OrderState.REFUNDED);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * é…ç½®çŠ¶æ€è½¬æ¢</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public void configure(StateMachineTransitionConfigurer&lt;OrderState, OrderEvent&gt; transitions) throws Exception &#123;</span><br><span class="line">        transitions</span><br><span class="line">                // æ”¯ä»˜</span><br><span class="line">                .withExternal()</span><br><span class="line">                .source(OrderState.CREATED).target(OrderState.PAID)</span><br><span class="line">                .event(OrderEvent.PAY)</span><br><span class="line">                .action(payAction())</span><br><span class="line">                </span><br><span class="line">                // å–æ¶ˆï¼ˆå¾…æ”¯ä»˜çŠ¶æ€ä¸‹ï¼‰</span><br><span class="line">                .and()</span><br><span class="line">                .withExternal()</span><br><span class="line">                .source(OrderState.CREATED).target(OrderState.CANCELLED)</span><br><span class="line">                .event(OrderEvent.CANCEL)</span><br><span class="line">                .action(cancelAction())</span><br><span class="line">                </span><br><span class="line">                // å‘è´§</span><br><span class="line">                .and()</span><br><span class="line">                .withExternal()</span><br><span class="line">                .source(OrderState.PAID).target(OrderState.SHIPPED)</span><br><span class="line">                .event(OrderEvent.SHIP)</span><br><span class="line">                .action(shipAction())</span><br><span class="line">                </span><br><span class="line">                // æ”¶è´§</span><br><span class="line">                .and()</span><br><span class="line">                .withExternal()</span><br><span class="line">                .source(OrderState.SHIPPED).target(OrderState.RECEIVED)</span><br><span class="line">                .event(OrderEvent.RECEIVE)</span><br><span class="line">                .action(receiveAction())</span><br><span class="line">                </span><br><span class="line">                // å®Œæˆï¼ˆè‡ªåŠ¨ç¡®è®¤æ”¶è´§ï¼‰</span><br><span class="line">                .and()</span><br><span class="line">                .withExternal()</span><br><span class="line">                .source(OrderState.RECEIVED).target(OrderState.COMPLETED)</span><br><span class="line">                .event(OrderEvent.COMPLETE)</span><br><span class="line">                .action(completeAction())</span><br><span class="line">                </span><br><span class="line">                // é€€æ¬¾</span><br><span class="line">                .and()</span><br><span class="line">                .withExternal()</span><br><span class="line">                .source(OrderState.PAID).target(OrderState.REFUNDED)</span><br><span class="line">                .event(OrderEvent.REFUND)</span><br><span class="line">                .action(refundAction())</span><br><span class="line">                </span><br><span class="line">                // é€€æ¬¾ï¼ˆå·²å‘è´§çŠ¶æ€ä¸‹ï¼‰</span><br><span class="line">                .and()</span><br><span class="line">                .withExternal()</span><br><span class="line">                .source(OrderState.SHIPPED).target(OrderState.REFUNDED)</span><br><span class="line">                .event(OrderEvent.REFUND)</span><br><span class="line">                .action(refundAction())</span><br><span class="line">                </span><br><span class="line">                // è¶…æ—¶å–æ¶ˆ</span><br><span class="line">                .and()</span><br><span class="line">                .withExternal()</span><br><span class="line">                .source(OrderState.CREATED).target(OrderState.CANCELLED)</span><br><span class="line">                .event(OrderEvent.TIMEOUT)</span><br><span class="line">                .action(timeoutAction())</span><br><span class="line">                </span><br><span class="line">                // ç®¡ç†å‘˜å–æ¶ˆ</span><br><span class="line">                .and()</span><br><span class="line">                .withExternal()</span><br><span class="line">                .source(OrderState.PAID).target(OrderState.CANCELLED)</span><br><span class="line">                .event(OrderEvent.ADMIN_CANCEL)</span><br><span class="line">                .action(adminCancelAction());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * é…ç½®çŠ¶æ€æœº</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public void configure(StateMachineConfigurationConfigurer&lt;OrderState, OrderEvent&gt; config) throws Exception &#123;</span><br><span class="line">        config.withConfiguration()</span><br><span class="line">                .machineId(&quot;orderStateMachine&quot;)</span><br><span class="line">                .autoStartup(true);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ”¯ä»˜åŠ¨ä½œ</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public PayAction payAction() &#123;</span><br><span class="line">        return new PayAction();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å–æ¶ˆåŠ¨ä½œ</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public CancelAction cancelAction() &#123;</span><br><span class="line">        return new CancelAction();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å‘è´§åŠ¨ä½œ</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public ShipAction shipAction() &#123;</span><br><span class="line">        return new ShipAction();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ”¶è´§åŠ¨ä½œ</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public ReceiveAction receiveAction() &#123;</span><br><span class="line">        return new ReceiveAction();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å®ŒæˆåŠ¨ä½œ</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public CompleteAction completeAction() &#123;</span><br><span class="line">        return new CompleteAction();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * é€€æ¬¾åŠ¨ä½œ</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public RefundAction refundAction() &#123;</span><br><span class="line">        return new RefundAction();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è¶…æ—¶åŠ¨ä½œ</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public TimeoutAction timeoutAction() &#123;</span><br><span class="line">        return new TimeoutAction();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * ç®¡ç†å‘˜å–æ¶ˆåŠ¨ä½œ</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public AdminCancelAction adminCancelAction() &#123;</span><br><span class="line">        return new AdminCancelAction();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * çŠ¶æ€æœºæŒä¹…åŒ–</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public StateMachinePersister&lt;OrderState, OrderEvent, String&gt; stateMachinePersister() &#123;</span><br><span class="line">        return new DefaultStateMachinePersister&lt;&gt;(new StateMachinePersist&lt;OrderState, OrderEvent, String&gt;() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void write(StateMachineContext&lt;OrderState, OrderEvent&gt; context, String orderId) &#123;</span><br><span class="line">                // å°†çŠ¶æ€æœºä¸Šä¸‹æ–‡ä¿å­˜åˆ°Redisæˆ–æ•°æ®åº“</span><br><span class="line">                // è¿™é‡Œç®€åŒ–å®ç°ï¼Œå®é™…é¡¹ç›®ä¸­éœ€è¦æŒä¹…åŒ–</span><br><span class="line">                log.info(&quot;æŒä¹…åŒ–çŠ¶æ€æœºä¸Šä¸‹æ–‡ï¼Œè®¢å•IDï¼š&#123;&#125;ï¼ŒçŠ¶æ€ï¼š&#123;&#125;&quot;, orderId, context.getState());</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            @Override</span><br><span class="line">            public StateMachineContext&lt;OrderState, OrderEvent&gt; read(String orderId) &#123;</span><br><span class="line">                // ä»Redisæˆ–æ•°æ®åº“åŠ è½½çŠ¶æ€æœºä¸Šä¸‹æ–‡</span><br><span class="line">                // è¿™é‡Œç®€åŒ–å®ç°ï¼Œè¿”å›åˆå§‹çŠ¶æ€</span><br><span class="line">                return new DefaultStateMachineContext&lt;&gt;(</span><br><span class="line">                        OrderState.CREATED, null, null, null, null, &quot;orderStateMachine&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// è®¢å•çŠ¶æ€æšä¸¾</span><br><span class="line">enum OrderState &#123;</span><br><span class="line">    CREATED(0, &quot;å¾…æ”¯ä»˜&quot;),</span><br><span class="line">    PAID(1, &quot;å·²æ”¯ä»˜&quot;),</span><br><span class="line">    SHIPPED(2, &quot;å·²å‘è´§&quot;),</span><br><span class="line">    RECEIVED(3, &quot;å·²æ”¶è´§&quot;),</span><br><span class="line">    COMPLETED(4, &quot;å·²å®Œæˆ&quot;),</span><br><span class="line">    CANCELLED(5, &quot;å·²å–æ¶ˆ&quot;),</span><br><span class="line">    REFUNDED(6, &quot;å·²é€€æ¬¾&quot;);</span><br><span class="line">    </span><br><span class="line">    private final Integer code;</span><br><span class="line">    private final String desc;</span><br><span class="line">    </span><br><span class="line">    OrderState(Integer code, String desc) &#123;</span><br><span class="line">        this.code = code;</span><br><span class="line">        this.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public Integer getCode() &#123;</span><br><span class="line">        return code;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public String getDesc() &#123;</span><br><span class="line">        return desc;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public static OrderState getByCode(Integer code) &#123;</span><br><span class="line">        for (OrderState state : values()) &#123;</span><br><span class="line">            if (state.getCode().equals(code)) &#123;</span><br><span class="line">                return state;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// è®¢å•äº‹ä»¶æšä¸¾</span><br><span class="line">enum OrderEvent &#123;</span><br><span class="line">    PAY,           // æ”¯ä»˜</span><br><span class="line">    CANCEL,        // å–æ¶ˆ</span><br><span class="line">    SHIP,          // å‘è´§</span><br><span class="line">    RECEIVE,       // æ”¶è´§</span><br><span class="line">    COMPLETE,      // å®Œæˆ</span><br><span class="line">    REFUND,        // é€€æ¬¾</span><br><span class="line">    TIMEOUT,       // è¶…æ—¶</span><br><span class="line">    ADMIN_CANCEL   // ç®¡ç†å‘˜å–æ¶ˆ</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// çŠ¶æ€æœºç›‘å¬å™¨</span><br><span class="line">@Slf4j</span><br><span class="line">@WithStateMachine(name = &quot;orderStateMachine&quot;)</span><br><span class="line">class OrderStateMachineListener &#123;</span><br><span class="line">    </span><br><span class="line">    @OnTransition(source = &quot;CREATED&quot;, target = &quot;PAID&quot;)</span><br><span class="line">    public void onPay() &#123;</span><br><span class="line">        log.info(&quot;è®¢å•çŠ¶æ€è½¬æ¢ï¼šCREATED -&gt; PAID&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @OnTransition(source = &quot;CREATED&quot;, target = &quot;CANCELLED&quot;)</span><br><span class="line">    public void onCancel() &#123;</span><br><span class="line">        log.info(&quot;è®¢å•çŠ¶æ€è½¬æ¢ï¼šCREATED -&gt; CANCELLED&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @OnTransition(source = &quot;PAID&quot;, target = &quot;SHIPPED&quot;)</span><br><span class="line">    public void onShip() &#123;</span><br><span class="line">        log.info(&quot;è®¢å•çŠ¶æ€è½¬æ¢ï¼šPAID -&gt; SHIPPED&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @OnTransition(source = &quot;SHIPPED&quot;, target = &quot;RECEIVED&quot;)</span><br><span class="line">    public void onReceive() &#123;</span><br><span class="line">        log.info(&quot;è®¢å•çŠ¶æ€è½¬æ¢ï¼šSHIPPED -&gt; RECEIVED&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @OnTransition(source = &quot;RECEIVED&quot;, target = &quot;COMPLETED&quot;)</span><br><span class="line">    public void onComplete() &#123;</span><br><span class="line">        log.info(&quot;è®¢å•çŠ¶æ€è½¬æ¢ï¼šRECEIVED -&gt; COMPLETED&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @OnTransition(source = &quot;PAID&quot;, target = &quot;REFUNDED&quot;)</span><br><span class="line">    public void onRefund() &#123;</span><br><span class="line">        log.info(&quot;è®¢å•çŠ¶æ€è½¬æ¢ï¼šPAID -&gt; REFUNDED&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æ”¯ä»˜åŠ¨ä½œ</span><br><span class="line">class PayAction implements org.springframework.statemachine.action.Action&lt;OrderState, OrderEvent&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public void execute(org.springframework.statemachine.StateContext&lt;OrderState, OrderEvent&gt; context) &#123;</span><br><span class="line">        Long orderId = (Long) context.getMessageHeader(&quot;orderId&quot;);</span><br><span class="line">        log.info(&quot;æ‰§è¡Œæ”¯ä»˜åŠ¨ä½œï¼Œè®¢å•IDï¼š&#123;&#125;&quot;, orderId);</span><br><span class="line">        </span><br><span class="line">        // 1. æ›´æ–°è®¢å•çŠ¶æ€ä¸ºå·²æ”¯ä»˜</span><br><span class="line">        // 2. è®°å½•æ”¯ä»˜æ—¶é—´</span><br><span class="line">        // 3. å‘é€æ”¯ä»˜æˆåŠŸæ¶ˆæ¯</span><br><span class="line">        // 4. æ›´æ–°åº“å­˜ï¼ˆå®é™…åº“å­˜æ‰£å‡åœ¨åˆ›å»ºè®¢å•æ—¶å·²å®Œæˆï¼Œè¿™é‡Œæ˜¯é¢„æ‰£åº“å­˜ï¼‰</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// å–æ¶ˆåŠ¨ä½œ</span><br><span class="line">class CancelAction implements org.springframework.statemachine.action.Action&lt;OrderState, OrderEvent&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public void execute(org.springframework.statemachine.StateContext&lt;OrderState, OrderEvent&gt; context) &#123;</span><br><span class="line">        Long orderId = (Long) context.getMessageHeader(&quot;orderId&quot;);</span><br><span class="line">        String cancelReason = (String) context.getMessageHeader(&quot;cancelReason&quot;);</span><br><span class="line">        log.info(&quot;æ‰§è¡Œå–æ¶ˆåŠ¨ä½œï¼Œè®¢å•IDï¼š&#123;&#125;ï¼Œå–æ¶ˆåŸå› ï¼š&#123;&#125;&quot;, orderId, cancelReason);</span><br><span class="line">        </span><br><span class="line">        // 1. æ›´æ–°è®¢å•çŠ¶æ€ä¸ºå·²å–æ¶ˆ</span><br><span class="line">        // 2. è®°å½•å–æ¶ˆæ—¶é—´</span><br><span class="line">        // 3. é‡Šæ”¾é”å®šåº“å­˜</span><br><span class="line">        // 4. å‘é€å–æ¶ˆæ¶ˆæ¯</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// å…¶ä»–åŠ¨ä½œç±»å®ç°ç±»ä¼¼...</span><br></pre></td></tr></table></figure><h3 id="6-Seataåˆ†å¸ƒå¼äº‹åŠ¡é…ç½®"><a href="#6-Seataåˆ†å¸ƒå¼äº‹åŠ¡é…ç½®" class="headerlink" title="6. Seataåˆ†å¸ƒå¼äº‹åŠ¡é…ç½®"></a>6. Seataåˆ†å¸ƒå¼äº‹åŠ¡é…ç½®</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.order.config;</span><br><span class="line"></span><br><span class="line">import com.alibaba.druid.pool.DruidDataSource;</span><br><span class="line">import com.baomidou.mybatisplus.core.MybatisConfiguration;</span><br><span class="line">import com.baomidou.mybatisplus.extension.spring.MybatisSqlSessionFactoryBean;</span><br><span class="line">import io.seata.rm.datasource.DataSourceProxy;</span><br><span class="line">import io.seata.spring.annotation.GlobalTransactionScanner;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.apache.ibatis.session.SqlSessionFactory;</span><br><span class="line">import org.apache.ibatis.type.JdbcType;</span><br><span class="line">import org.springframework.beans.factory.annotation.Value;</span><br><span class="line">import org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.context.annotation.Primary;</span><br><span class="line">import org.springframework.core.io.support.PathMatchingResourcePatternResolver;</span><br><span class="line"></span><br><span class="line">import javax.sql.DataSource;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Seataåˆ†å¸ƒå¼äº‹åŠ¡é…ç½®</span><br><span class="line"> */</span><br><span class="line">@Slf4j</span><br><span class="line">@Configuration</span><br><span class="line">public class SeataConfig &#123;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;spring.application.name&#125;&quot;)</span><br><span class="line">    private String applicationId;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆ›å»ºæ•°æ®æºä»£ç†ï¼ˆSeataéœ€è¦ä»£ç†æ•°æ®æºï¼‰</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    @ConfigurationProperties(prefix = &quot;spring.datasource.dynamic.datasource.master&quot;)</span><br><span class="line">    public DataSource druidDataSource() &#123;</span><br><span class="line">        return new DruidDataSource();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆ›å»ºæ•°æ®æºä»£ç†</span><br><span class="line">     */</span><br><span class="line">    @Primary</span><br><span class="line">    @Bean(&quot;dataSource&quot;)</span><br><span class="line">    public DataSource dataSourceProxy(DataSource druidDataSource) &#123;</span><br><span class="line">        log.info(&quot;åˆ›å»ºSeataæ•°æ®æºä»£ç†&quot;);</span><br><span class="line">        return new DataSourceProxy(druidDataSource);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * é…ç½®MyBatis SqlSessionFactoryï¼ˆä½¿ç”¨Seataä»£ç†çš„æ•°æ®æºï¼‰</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public SqlSessionFactory sqlSessionFactory(DataSource dataSource) throws Exception &#123;</span><br><span class="line">        MybatisSqlSessionFactoryBean factoryBean = new MybatisSqlSessionFactoryBean();</span><br><span class="line">        factoryBean.setDataSource(dataSource);</span><br><span class="line">        factoryBean.setMapperLocations(</span><br><span class="line">            new PathMatchingResourcePatternResolver()</span><br><span class="line">                .getResources(&quot;classpath*:/mapper/**/*.xml&quot;)</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        MybatisConfiguration configuration = new MybatisConfiguration();</span><br><span class="line">        configuration.setJdbcTypeForNull(JdbcType.NULL);</span><br><span class="line">        configuration.setMapUnderscoreToCamelCase(true);</span><br><span class="line">        configuration.setCacheEnabled(false);</span><br><span class="line">        factoryBean.setConfiguration(configuration);</span><br><span class="line">        </span><br><span class="line">        return factoryBean.getObject();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆå§‹åŒ–å…¨å±€äº‹åŠ¡æ‰«æå™¨</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public GlobalTransactionScanner globalTransactionScanner() &#123;</span><br><span class="line">        log.info(&quot;é…ç½®Seataå…¨å±€äº‹åŠ¡æ‰«æå™¨ï¼Œåº”ç”¨IDï¼š&#123;&#125;&quot;, applicationId);</span><br><span class="line">        </span><br><span class="line">        return new GlobalTransactionScanner(</span><br><span class="line">            applicationId, </span><br><span class="line">            &quot;my_test_tx_group&quot;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * Seataé…ç½®åˆå§‹åŒ–ï¼ˆå¯é€‰ï¼‰</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public SeataInitializer seataInitializer() &#123;</span><br><span class="line">        return new SeataInitializer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Seataåˆå§‹åŒ–å™¨</span><br><span class="line">class SeataInitializer &#123;</span><br><span class="line">    </span><br><span class="line">    @javax.annotation.PostConstruct</span><br><span class="line">    public void init() &#123;</span><br><span class="line">        log.info(&quot;Seataåˆ†å¸ƒå¼äº‹åŠ¡åˆå§‹åŒ–å®Œæˆ&quot;);</span><br><span class="line">        </span><br><span class="line">        // é…ç½®å…¨å±€äº‹åŠ¡è¶…æ—¶æ—¶é—´</span><br><span class="line">        io.seata.core.context.RootContext.setTimeout(60000); // 60ç§’</span><br><span class="line">        </span><br><span class="line">        // æ³¨å†Œäº‹åŠ¡å›æ»šå¤„ç†å™¨ï¼ˆå¯é€‰ï¼‰</span><br><span class="line">        // io.seata.tm.api.DefaultFailureHandlerImpl</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// åˆ†å¸ƒå¼äº‹åŠ¡å·¥å…·ç±»</span><br><span class="line">@Component</span><br><span class="line">class DistributedTransactionUtil &#123;</span><br><span class="line">    </span><br><span class="line">    private static final String XID_KEY = &quot;X-Global-Transaction-Id&quot;;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è·å–å½“å‰äº‹åŠ¡XID</span><br><span class="line">     */</span><br><span class="line">    public String getCurrentXid() &#123;</span><br><span class="line">        return io.seata.core.context.RootContext.getXID();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆ¤æ–­å½“å‰æ˜¯å¦åœ¨å…¨å±€äº‹åŠ¡ä¸­</span><br><span class="line">     */</span><br><span class="line">    public boolean inGlobalTransaction() &#123;</span><br><span class="line">        return io.seata.core.context.RootContext.inGlobalTransaction();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * ç»‘å®šåˆ†æ”¯äº‹åŠ¡åˆ°å…¨å±€äº‹åŠ¡</span><br><span class="line">     */</span><br><span class="line">    public void bindBranchTransaction(String xid) &#123;</span><br><span class="line">        io.seata.core.context.RootContext.bind(xid);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è§£ç»‘åˆ†æ”¯äº‹åŠ¡</span><br><span class="line">     */</span><br><span class="line">    public void unbindBranchTransaction() &#123;</span><br><span class="line">        io.seata.core.context.RootContext.unbind();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆ›å»ºäº‹åŠ¡ä¸Šä¸‹æ–‡</span><br><span class="line">     */</span><br><span class="line">    public TransactionContext createTransactionContext() &#123;</span><br><span class="line">        return new TransactionContext(getCurrentXid());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ‰‹åŠ¨å›æ»šäº‹åŠ¡</span><br><span class="line">     */</span><br><span class="line">    public void rollback() &#123;</span><br><span class="line">        if (inGlobalTransaction()) &#123;</span><br><span class="line">            throw new RuntimeException(&quot;å…¨å±€äº‹åŠ¡å›æ»š&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * äº‹åŠ¡ä¸Šä¸‹æ–‡</span><br><span class="line">     */</span><br><span class="line">    @Data</span><br><span class="line">    @AllArgsConstructor</span><br><span class="line">    public static class TransactionContext &#123;</span><br><span class="line">        private String xid;</span><br><span class="line">        private LocalDateTime startTime;</span><br><span class="line">        </span><br><span class="line">        public TransactionContext(String xid) &#123;</span><br><span class="line">            this.xid = xid;</span><br><span class="line">            this.startTime = LocalDateTime.now();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// åˆ†å¸ƒå¼äº‹åŠ¡æ³¨è§£ï¼ˆå¢å¼ºç‰ˆï¼‰</span><br><span class="line">@Target(&#123;ElementType.METHOD&#125;)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Inherited</span><br><span class="line">public @interface GlobalTransactional &#123;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * äº‹åŠ¡è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰</span><br><span class="line">     */</span><br><span class="line">    int timeout() default 60000;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * äº‹åŠ¡åç§°</span><br><span class="line">     */</span><br><span class="line">    String name() default &quot;&quot;;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å›æ»šå¼‚å¸¸ç±»</span><br><span class="line">     */</span><br><span class="line">    Class&lt;? extends Throwable&gt;[] rollbackFor() default &#123;Exception.class&#125;;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * ä¸å›æ»šå¼‚å¸¸ç±»</span><br><span class="line">     */</span><br><span class="line">    Class&lt;? extends Throwable&gt;[] noRollbackFor() default &#123;&#125;;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * äº‹åŠ¡ä¼ æ’­è¡Œä¸º</span><br><span class="line">     */</span><br><span class="line">    Propagation propagation() default Propagation.REQUIRED;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * é”ç­–ç•¥</span><br><span class="line">     */</span><br><span class="line">    LockMode lockMode() default LockMode.NONE;</span><br><span class="line">    </span><br><span class="line">    enum Propagation &#123;</span><br><span class="line">        REQUIRED,  // æ”¯æŒå½“å‰äº‹åŠ¡ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºæ–°äº‹åŠ¡</span><br><span class="line">        REQUIRES_NEW, // åˆ›å»ºæ–°äº‹åŠ¡ï¼Œæš‚åœå½“å‰äº‹åŠ¡</span><br><span class="line">        NESTED,    // åµŒå¥—äº‹åŠ¡</span><br><span class="line">        SUPPORTS,  // æ”¯æŒå½“å‰äº‹åŠ¡ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œ</span><br><span class="line">        NOT_SUPPORTED, // ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œï¼Œæš‚åœå½“å‰äº‹åŠ¡</span><br><span class="line">        NEVER,     // ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œï¼Œå¦‚æœå­˜åœ¨äº‹åŠ¡åˆ™æŠ›å¼‚å¸¸</span><br><span class="line">        MANDATORY  // å¿…é¡»åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œï¼Œå¦åˆ™æŠ›å¼‚å¸¸</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    enum LockMode &#123;</span><br><span class="line">        NONE,      // ä¸åŠ é”</span><br><span class="line">        READ,      // è¯»é”</span><br><span class="line">        WRITE      // å†™é”</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// åˆ†å¸ƒå¼äº‹åŠ¡AOPå¤„ç†å™¨</span><br><span class="line">@Slf4j</span><br><span class="line">@Aspect</span><br><span class="line">@Component</span><br><span class="line">public class GlobalTransactionalAspect &#123;</span><br><span class="line">    </span><br><span class="line">    private final DistributedTransactionUtil transactionUtil;</span><br><span class="line">    </span><br><span class="line">    @Around(&quot;@annotation(globalTransactional)&quot;)</span><br><span class="line">    public Object around(ProceedingJoinPoint joinPoint, GlobalTransactional globalTransactional) throws Throwable &#123;</span><br><span class="line">        // 1. æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨å…¨å±€äº‹åŠ¡</span><br><span class="line">        boolean existingTransaction = transactionUtil.inGlobalTransaction();</span><br><span class="line">        </span><br><span class="line">        // 2. æ ¹æ®ä¼ æ’­è¡Œä¸ºå¤„ç†</span><br><span class="line">        switch (globalTransactional.propagation()) &#123;</span><br><span class="line">            case REQUIRED:</span><br><span class="line">                if (!existingTransaction) &#123;</span><br><span class="line">                    return executeInNewTransaction(joinPoint, globalTransactional);</span><br><span class="line">                &#125;</span><br><span class="line">                break;</span><br><span class="line">            case REQUIRES_NEW:</span><br><span class="line">                // æŒ‚èµ·å½“å‰äº‹åŠ¡ï¼ˆå¦‚æœæœ‰ï¼‰</span><br><span class="line">                String oldXid = transactionUtil.getCurrentXid();</span><br><span class="line">                if (oldXid != null) &#123;</span><br><span class="line">                    transactionUtil.unbindBranchTransaction();</span><br><span class="line">                &#125;</span><br><span class="line">                try &#123;</span><br><span class="line">                    return executeInNewTransaction(joinPoint, globalTransactional);</span><br><span class="line">                &#125; finally &#123;</span><br><span class="line">                    // æ¢å¤åŸäº‹åŠ¡</span><br><span class="line">                    if (oldXid != null) &#123;</span><br><span class="line">                        transactionUtil.bindBranchTransaction(oldXid);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            case NEVER:</span><br><span class="line">                if (existingTransaction) &#123;</span><br><span class="line">                    throw new RuntimeException(&quot;å­˜åœ¨äº‹åŠ¡ï¼Œä½†æ–¹æ³•è¦æ±‚éäº‹åŠ¡æ‰§è¡Œ&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                break;</span><br><span class="line">            case MANDATORY:</span><br><span class="line">                if (!existingTransaction) &#123;</span><br><span class="line">                    throw new RuntimeException(&quot;è¦æ±‚å¿…é¡»åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œ&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                break;</span><br><span class="line">            default:</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 3. æ‰§è¡ŒåŸæ–¹æ³•</span><br><span class="line">        return joinPoint.proceed();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åœ¨æ–°äº‹åŠ¡ä¸­æ‰§è¡Œ</span><br><span class="line">     */</span><br><span class="line">    private Object executeInNewTransaction(ProceedingJoinPoint joinPoint, </span><br><span class="line">                                          GlobalTransactional globalTransactional) throws Throwable &#123;</span><br><span class="line">        log.info(&quot;å¼€å§‹å…¨å±€äº‹åŠ¡ï¼Œæ–¹æ³•ï¼š&#123;&#125;&quot;, joinPoint.getSignature().getName());</span><br><span class="line">        </span><br><span class="line">        long startTime = System.currentTimeMillis();</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            // è¿™é‡Œåº”è¯¥ä½¿ç”¨Seataçš„@GlobalTransactionalæ³¨è§£</span><br><span class="line">            // ç®€åŒ–å®ç°ï¼Œç›´æ¥æ‰§è¡Œ</span><br><span class="line">            Object result = joinPoint.proceed();</span><br><span class="line">            </span><br><span class="line">            long costTime = System.currentTimeMillis() - startTime;</span><br><span class="line">            log.info(&quot;å…¨å±€äº‹åŠ¡æ‰§è¡ŒæˆåŠŸï¼Œè€—æ—¶ï¼š&#123;&#125;ms&quot;, costTime);</span><br><span class="line">            </span><br><span class="line">            return result;</span><br><span class="line">            </span><br><span class="line">        &#125; catch (Throwable throwable) &#123;</span><br><span class="line">            log.error(&quot;å…¨å±€äº‹åŠ¡æ‰§è¡Œå¤±è´¥ï¼Œæ–¹æ³•ï¼š&#123;&#125;&quot;, joinPoint.getSignature().getName(), throwable);</span><br><span class="line">            </span><br><span class="line">            // åˆ¤æ–­æ˜¯å¦éœ€è¦å›æ»š</span><br><span class="line">            if (shouldRollback(throwable, globalTransactional)) &#123;</span><br><span class="line">                transactionUtil.rollback();</span><br><span class="line">                log.info(&quot;å…¨å±€äº‹åŠ¡å·²å›æ»š&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            throw throwable;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆ¤æ–­æ˜¯å¦éœ€è¦å›æ»š</span><br><span class="line">     */</span><br><span class="line">    private boolean shouldRollback(Throwable throwable, GlobalTransactional globalTransactional) &#123;</span><br><span class="line">        // æ£€æŸ¥ä¸å›æ»šçš„å¼‚å¸¸</span><br><span class="line">        for (Class&lt;? extends Throwable&gt; noRollbackClass : globalTransactional.noRollbackFor()) &#123;</span><br><span class="line">            if (noRollbackClass.isInstance(throwable)) &#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // æ£€æŸ¥éœ€è¦å›æ»šçš„å¼‚å¸¸</span><br><span class="line">        for (Class&lt;? extends Throwable&gt; rollbackClass : globalTransactional.rollbackFor()) &#123;</span><br><span class="line">            if (rollbackClass.isInstance(throwable)) &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // é»˜è®¤æ‰€æœ‰å¼‚å¸¸éƒ½å›æ»š</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="7-è®¢å•Serviceå®ç°ï¼ˆåŒ…å«åˆ†å¸ƒå¼äº‹åŠ¡ï¼‰"><a href="#7-è®¢å•Serviceå®ç°ï¼ˆåŒ…å«åˆ†å¸ƒå¼äº‹åŠ¡ï¼‰" class="headerlink" title="7. è®¢å•Serviceå®ç°ï¼ˆåŒ…å«åˆ†å¸ƒå¼äº‹åŠ¡ï¼‰"></a>7. è®¢å•Serviceå®ç°ï¼ˆåŒ…å«åˆ†å¸ƒå¼äº‹åŠ¡ï¼‰</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.order.service.impl;</span><br><span class="line"></span><br><span class="line">import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;</span><br><span class="line">import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span><br><span class="line">import com.shophub.common.exception.BusinessException;</span><br><span class="line">import com.shophub.common.result.ResultCode;</span><br><span class="line">import com.shophub.order.constants.OrderConstants;</span><br><span class="line">import com.shophub.order.entity.Order;</span><br><span class="line">import com.shophub.order.entity.OrderItem;</span><br><span class="line">import com.shophub.order.entity.OrderOperationLog;</span><br><span class="line">import com.shophub.order.mapper.OrderMapper;</span><br><span class="line">import com.shophub.order.service.OrderService;</span><br><span class="line">import com.shophub.order.statemachine.OrderEvent;</span><br><span class="line">import com.shophub.order.statemachine.OrderState;</span><br><span class="line">import com.shophub.order.vo.*;</span><br><span class="line">import io.seata.spring.annotation.GlobalTransactional;</span><br><span class="line">import lombok.RequiredArgsConstructor;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.apache.rocketmq.spring.core.RocketMQTemplate;</span><br><span class="line">import org.redisson.api.RLock;</span><br><span class="line">import org.redisson.api.RedissonClient;</span><br><span class="line">import org.springframework.beans.BeanUtils;</span><br><span class="line">import org.springframework.messaging.support.MessageBuilder;</span><br><span class="line">import org.springframework.statemachine.StateMachine;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line">import org.springframework.transaction.annotation.Transactional;</span><br><span class="line">import org.springframework.util.CollectionUtils;</span><br><span class="line"></span><br><span class="line">import java.math.BigDecimal;</span><br><span class="line">import java.time.LocalDateTime;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.UUID;</span><br><span class="line">import java.util.concurrent.TimeUnit;</span><br><span class="line">import java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@Service</span><br><span class="line">@RequiredArgsConstructor</span><br><span class="line">public class OrderServiceImpl extends ServiceImpl&lt;OrderMapper, Order&gt; implements OrderService &#123;</span><br><span class="line">    </span><br><span class="line">    private final OrderMapper orderMapper;</span><br><span class="line">    private final OrderItemService orderItemService;</span><br><span class="line">    private final OrderOperationLogService operationLogService;</span><br><span class="line">    private final InventoryService inventoryService;</span><br><span class="line">    private final ProductService productService;</span><br><span class="line">    private final CouponService couponService;</span><br><span class="line">    private final RedissonClient redissonClient;</span><br><span class="line">    private final RocketMQTemplate rocketMQTemplate;</span><br><span class="line">    private final StateMachine&lt;OrderState, OrderEvent&gt; orderStateMachine;</span><br><span class="line">    </span><br><span class="line">    private static final String ORDER_LOCK_PREFIX = &quot;order:lock:&quot;;</span><br><span class="line">    private static final String ORDER_IDEMPOTENT_PREFIX = &quot;order:idempotent:&quot;;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    @GlobalTransactional(timeoutMills = 60000, name = &quot;create-order-tx&quot;)</span><br><span class="line">    @Transactional(rollbackFor = Exception.class)</span><br><span class="line">    public CreateOrderResult createOrder(CreateOrderRequest request, Long userId) &#123;</span><br><span class="line">        log.info(&quot;å¼€å§‹åˆ›å»ºè®¢å•ï¼Œç”¨æˆ·IDï¼š&#123;&#125;ï¼Œè¯·æ±‚å‚æ•°ï¼š&#123;&#125;&quot;, userId, request);</span><br><span class="line">        </span><br><span class="line">        // 1. å¹‚ç­‰æ€§æ ¡éªŒ</span><br><span class="line">        String idempotentKey = ORDER_IDEMPOTENT_PREFIX + userId + &quot;:&quot; + UUID.randomUUID();</span><br><span class="line">        if (!checkIdempotent(idempotentKey)) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.REPEAT_REQUEST, &quot;è¯·å‹¿é‡å¤æäº¤è®¢å•&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 2. å‚æ•°æ ¡éªŒ</span><br><span class="line">        validateCreateOrderRequest(request);</span><br><span class="line">        </span><br><span class="line">        // 3. è·å–æ”¶è´§åœ°å€</span><br><span class="line">        AddressVo address = getAddressById(request.getAddressId(), userId);</span><br><span class="line">        </span><br><span class="line">        // 4. è®¡ç®—è®¢å•é‡‘é¢</span><br><span class="line">        OrderCalculateResult calculateResult = calculateOrderAmount(request, userId);</span><br><span class="line">        </span><br><span class="line">        // 5. ä½¿ç”¨åˆ†å¸ƒå¼é”åˆ›å»ºè®¢å•</span><br><span class="line">        String lockKey = ORDER_LOCK_PREFIX + userId;</span><br><span class="line">        RLock lock = redissonClient.getLock(lockKey);</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            // å°è¯•åŠ é”ï¼Œæœ€å¤šç­‰å¾…3ç§’ï¼Œé”10ç§’åè‡ªåŠ¨é‡Šæ”¾</span><br><span class="line">            boolean locked = lock.tryLock(3, 10, TimeUnit.SECONDS);</span><br><span class="line">            if (!locked) &#123;</span><br><span class="line">                throw new BusinessException(ResultCode.SYSTEM_ERROR, &quot;ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // 6. æ‰£å‡åº“å­˜ï¼ˆé¢„æ‰£åº“å­˜ï¼‰</span><br><span class="line">            boolean lockInventorySuccess = lockInventory(calculateResult.getOrderItems());</span><br><span class="line">            if (!lockInventorySuccess) &#123;</span><br><span class="line">                throw new BusinessException(ResultCode.BUSINESS_ERROR, &quot;åº“å­˜ä¸è¶³&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // 7. ä½¿ç”¨ä¼˜æƒ åˆ¸</span><br><span class="line">            if (request.getCouponId() != null) &#123;</span><br><span class="line">                useCoupon(request.getCouponId(), userId, calculateResult.getTotalAmount());</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // 8. ç”Ÿæˆè®¢å•å·</span><br><span class="line">            String orderNo = generateOrderNo();</span><br><span class="line">            </span><br><span class="line">            // 9. ä¿å­˜è®¢å•</span><br><span class="line">            Order order = saveOrder(orderNo, userId, address, calculateResult, request);</span><br><span class="line">            </span><br><span class="line">            // 10. ä¿å­˜è®¢å•å•†å“</span><br><span class="line">            saveOrderItems(order.getId(), orderNo, calculateResult.getOrderItems());</span><br><span class="line">            </span><br><span class="line">            // 11. è®°å½•æ“ä½œæ—¥å¿—</span><br><span class="line">            saveOperationLog(order, OrderConstants.OperationType.CREATE, userId);</span><br><span class="line">            </span><br><span class="line">            // 12. å‘é€åˆ›å»ºè®¢å•æ¶ˆæ¯</span><br><span class="line">            sendOrderCreateMessage(order);</span><br><span class="line">            </span><br><span class="line">            // 13. è®¾ç½®è®¢å•è¶…æ—¶ä»»åŠ¡</span><br><span class="line">            scheduleOrderTimeout(order.getId(), orderNo);</span><br><span class="line">            </span><br><span class="line">            log.info(&quot;è®¢å•åˆ›å»ºæˆåŠŸï¼Œè®¢å•å·ï¼š&#123;&#125;ï¼Œè®¢å•IDï¼š&#123;&#125;&quot;, orderNo, order.getId());</span><br><span class="line">            </span><br><span class="line">            return CreateOrderResult.builder()</span><br><span class="line">                    .orderId(order.getId())</span><br><span class="line">                    .orderNo(orderNo)</span><br><span class="line">                    .totalAmount(order.getTotalAmount())</span><br><span class="line">                    .payAmount(order.getPayAmount())</span><br><span class="line">                    .build();</span><br><span class="line">            </span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">            throw new BusinessException(ResultCode.SYSTEM_ERROR, &quot;ç³»ç»Ÿå¼‚å¸¸&quot;);</span><br><span class="line">        &#125; catch (BusinessException e) &#123;</span><br><span class="line">            throw e;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;åˆ›å»ºè®¢å•å¤±è´¥&quot;, e);</span><br><span class="line">            throw new BusinessException(ResultCode.SYSTEM_ERROR, &quot;åˆ›å»ºè®¢å•å¤±è´¥&quot;);</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            // é‡Šæ”¾é”</span><br><span class="line">            if (lock.isHeldByCurrentThread()) &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    @GlobalTransactional(timeoutMills = 30000, name = &quot;pay-order-tx&quot;)</span><br><span class="line">    @Transactional(rollbackFor = Exception.class)</span><br><span class="line">    public boolean payOrder(PayOrderRequest request, Long userId) &#123;</span><br><span class="line">        log.info(&quot;å¼€å§‹æ”¯ä»˜è®¢å•ï¼Œç”¨æˆ·IDï¼š&#123;&#125;ï¼Œè®¢å•å·ï¼š&#123;&#125;&quot;, userId, request.getOrderNo());</span><br><span class="line">        </span><br><span class="line">        // 1. æŸ¥è¯¢è®¢å•</span><br><span class="line">        Order order = getOrderByNoAndUser(request.getOrderNo(), userId);</span><br><span class="line">        if (order == null) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.RESOURCE_NOT_FOUND, &quot;è®¢å•ä¸å­˜åœ¨&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 2. æ ¡éªŒè®¢å•çŠ¶æ€</span><br><span class="line">        if (!OrderState.CREATED.getCode().equals(order.getStatus())) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.BUSINESS_ERROR, &quot;è®¢å•çŠ¶æ€ä¸å…è®¸æ”¯ä»˜&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 3. æ ¡éªŒæ”¯ä»˜é‡‘é¢</span><br><span class="line">        if (request.getPayAmount().compareTo(order.getPayAmount()) != 0) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.BUSINESS_ERROR, &quot;æ”¯ä»˜é‡‘é¢ä¸æ­£ç¡®&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 4. è°ƒç”¨æ”¯ä»˜æœåŠ¡</span><br><span class="line">        PayResult payResult = callPaymentService(request, order);</span><br><span class="line">        if (!payResult.isSuccess()) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.BUSINESS_ERROR, &quot;æ”¯ä»˜å¤±è´¥ï¼š&quot; + payResult.getErrorMsg());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 5. æ›´æ–°è®¢å•çŠ¶æ€</span><br><span class="line">        order.setStatus(OrderState.PAID.getCode());</span><br><span class="line">        order.setPayType(request.getPayType());</span><br><span class="line">        order.setPayTime(LocalDateTime.now());</span><br><span class="line">        boolean updateSuccess = updateById(order);</span><br><span class="line">        if (!updateSuccess) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.SYSTEM_ERROR, &quot;æ›´æ–°è®¢å•çŠ¶æ€å¤±è´¥&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 6. æ‰£å‡å®é™…åº“å­˜ï¼ˆä»é¢„æ‰£åº“å­˜è½¬ä¸ºå®é™…æ‰£å‡ï¼‰</span><br><span class="line">        boolean deductInventorySuccess = deductInventory(order.getId());</span><br><span class="line">        if (!deductInventorySuccess) &#123;</span><br><span class="line">            // å¦‚æœæ‰£å‡åº“å­˜å¤±è´¥ï¼Œéœ€è¦è§¦å‘é€€æ¬¾</span><br><span class="line">            triggerRefund(order, &quot;åº“å­˜æ‰£å‡å¤±è´¥&quot;);</span><br><span class="line">            throw new BusinessException(ResultCode.BUSINESS_ERROR, &quot;åº“å­˜æ‰£å‡å¤±è´¥&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 7. è®°å½•æ“ä½œæ—¥å¿—</span><br><span class="line">        saveOperationLog(order, OrderConstants.OperationType.PAY, userId);</span><br><span class="line">        </span><br><span class="line">        // 8. å‘é€æ”¯ä»˜æˆåŠŸæ¶ˆæ¯</span><br><span class="line">        sendOrderPayMessage(order);</span><br><span class="line">        </span><br><span class="line">        // 9. å–æ¶ˆè®¢å•è¶…æ—¶ä»»åŠ¡</span><br><span class="line">        cancelOrderTimeout(order.getOrderNo());</span><br><span class="line">        </span><br><span class="line">        // 10. è§¦å‘çŠ¶æ€æœºè½¬æ¢</span><br><span class="line">        triggerStateMachine(order.getId(), OrderEvent.PAY);</span><br><span class="line">        </span><br><span class="line">        log.info(&quot;è®¢å•æ”¯ä»˜æˆåŠŸï¼Œè®¢å•å·ï¼š&#123;&#125;&quot;, order.getOrderNo());</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    @Transactional(rollbackFor = Exception.class)</span><br><span class="line">    public boolean cancelOrder(Long orderId, Long userId, String cancelReason) &#123;</span><br><span class="line">        log.info(&quot;å¼€å§‹å–æ¶ˆè®¢å•ï¼Œç”¨æˆ·IDï¼š&#123;&#125;ï¼Œè®¢å•IDï¼š&#123;&#125;&quot;, userId, orderId);</span><br><span class="line">        </span><br><span class="line">        // 1. æŸ¥è¯¢è®¢å•</span><br><span class="line">        Order order = getById(orderId);</span><br><span class="line">        if (order == null || !order.getUserId().equals(userId)) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.RESOURCE_NOT_FOUND, &quot;è®¢å•ä¸å­˜åœ¨&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 2. æ ¡éªŒè®¢å•çŠ¶æ€ï¼ˆåªæœ‰å¾…æ”¯ä»˜å’Œå·²æ”¯ä»˜æœªå‘è´§çš„è®¢å•å¯ä»¥å–æ¶ˆï¼‰</span><br><span class="line">        if (!canCancel(order)) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.BUSINESS_ERROR, &quot;è®¢å•çŠ¶æ€ä¸å…è®¸å–æ¶ˆ&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 3. æ›´æ–°è®¢å•çŠ¶æ€</span><br><span class="line">        order.setStatus(OrderState.CANCELLED.getCode());</span><br><span class="line">        order.setCancelReason(cancelReason);</span><br><span class="line">        order.setCancelTime(LocalDateTime.now());</span><br><span class="line">        boolean updateSuccess = updateById(order);</span><br><span class="line">        if (!updateSuccess) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.SYSTEM_ERROR, &quot;æ›´æ–°è®¢å•çŠ¶æ€å¤±è´¥&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 4. é‡Šæ”¾é”å®šåº“å­˜</span><br><span class="line">        releaseLockedInventory(order.getId());</span><br><span class="line">        </span><br><span class="line">        // 5. é€€å›ä¼˜æƒ åˆ¸ï¼ˆå¦‚æœä½¿ç”¨äº†ï¼‰</span><br><span class="line">        if (order.getDiscountAmount().compareTo(BigDecimal.ZERO) &gt; 0) &#123;</span><br><span class="line">            returnCoupon(order);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 6. è®°å½•æ“ä½œæ—¥å¿—</span><br><span class="line">        saveOperationLog(order, OrderConstants.OperationType.CANCEL, userId);</span><br><span class="line">        </span><br><span class="line">        // 7. å‘é€å–æ¶ˆè®¢å•æ¶ˆæ¯</span><br><span class="line">        sendOrderCancelMessage(order);</span><br><span class="line">        </span><br><span class="line">        // 8. å–æ¶ˆè®¢å•è¶…æ—¶ä»»åŠ¡</span><br><span class="line">        cancelOrderTimeout(order.getOrderNo());</span><br><span class="line">        </span><br><span class="line">        // 9. è§¦å‘çŠ¶æ€æœºè½¬æ¢</span><br><span class="line">        triggerStateMachine(order.getId(), OrderEvent.CANCEL);</span><br><span class="line">        </span><br><span class="line">        log.info(&quot;è®¢å•å–æ¶ˆæˆåŠŸï¼Œè®¢å•IDï¼š&#123;&#125;&quot;, orderId);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public PageResult&lt;OrderVo&gt; getOrderPage(OrderQueryRequest request, Long userId) &#123;</span><br><span class="line">        log.info(&quot;æŸ¥è¯¢è®¢å•åˆ—è¡¨ï¼Œç”¨æˆ·IDï¼š&#123;&#125;ï¼ŒæŸ¥è¯¢æ¡ä»¶ï¼š&#123;&#125;&quot;, userId, request);</span><br><span class="line">        </span><br><span class="line">        // è®¾ç½®åˆ†é¡µ</span><br><span class="line">        Page&lt;Order&gt; page = new Page&lt;&gt;(request.getPageNum(), request.getPageSize());</span><br><span class="line">        </span><br><span class="line">        // æ„å»ºæŸ¥è¯¢æ¡ä»¶</span><br><span class="line">        QueryWrapper&lt;Order&gt; wrapper = new QueryWrapper&lt;&gt;();</span><br><span class="line">        wrapper.eq(&quot;user_id&quot;, userId);</span><br><span class="line">        wrapper.eq(&quot;is_deleted&quot;, 0);</span><br><span class="line">        </span><br><span class="line">        if (request.getStatus() != null) &#123;</span><br><span class="line">            wrapper.eq(&quot;status&quot;, request.getStatus());</span><br><span class="line">        &#125;</span><br><span class="line">        if (StringUtils.isNotBlank(request.getOrderNo())) &#123;</span><br><span class="line">            wrapper.eq(&quot;order_no&quot;, request.getOrderNo());</span><br><span class="line">        &#125;</span><br><span class="line">        if (StringUtils.isNotBlank(request.getReceiverName())) &#123;</span><br><span class="line">            wrapper.like(&quot;receiver_name&quot;, request.getReceiverName());</span><br><span class="line">        &#125;</span><br><span class="line">        if (StringUtils.isNotBlank(request.getReceiverPhone())) &#123;</span><br><span class="line">            wrapper.like(&quot;receiver_phone&quot;, request.getReceiverPhone());</span><br><span class="line">        &#125;</span><br><span class="line">        if (request.getStartTime() != null) &#123;</span><br><span class="line">            wrapper.ge(&quot;create_time&quot;, request.getStartTime());</span><br><span class="line">        &#125;</span><br><span class="line">        if (request.getEndTime() != null) &#123;</span><br><span class="line">            wrapper.le(&quot;create_time&quot;, request.getEndTime());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // æ’åº</span><br><span class="line">        wrapper.orderBy(true, &quot;asc&quot;.equalsIgnoreCase(request.getSortOrder()), </span><br><span class="line">                       request.getSortBy());</span><br><span class="line">        </span><br><span class="line">        // æŸ¥è¯¢</span><br><span class="line">        Page&lt;Order&gt; orderPage = page(page, wrapper);</span><br><span class="line">        </span><br><span class="line">        // è½¬æ¢ä¸ºVO</span><br><span class="line">        List&lt;OrderVo&gt; orderVos = orderPage.getRecords().stream()</span><br><span class="line">                .map(this::convertToVo)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        </span><br><span class="line">        // æŸ¥è¯¢è®¢å•å•†å“</span><br><span class="line">        for (OrderVo orderVo : orderVos) &#123;</span><br><span class="line">            List&lt;OrderItem&gt; items = orderItemService.getByOrderId(orderVo.getId());</span><br><span class="line">            orderVo.setOrderItems(convertToItemVos(items));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return new PageResult&lt;&gt;(</span><br><span class="line">                orderVos,</span><br><span class="line">                orderPage.getTotal(),</span><br><span class="line">                orderPage.getCurrent(),</span><br><span class="line">                orderPage.getSize()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public OrderVo getOrderDetail(Long orderId, Long userId) &#123;</span><br><span class="line">        log.info(&quot;æŸ¥è¯¢è®¢å•è¯¦æƒ…ï¼Œç”¨æˆ·IDï¼š&#123;&#125;ï¼Œè®¢å•IDï¼š&#123;&#125;&quot;, userId, orderId);</span><br><span class="line">        </span><br><span class="line">        // æŸ¥è¯¢è®¢å•</span><br><span class="line">        Order order = getById(orderId);</span><br><span class="line">        if (order == null || !order.getUserId().equals(userId)) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.RESOURCE_NOT_FOUND, &quot;è®¢å•ä¸å­˜åœ¨&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // è½¬æ¢ä¸ºVO</span><br><span class="line">        OrderVo orderVo = convertToVo(order);</span><br><span class="line">        </span><br><span class="line">        // æŸ¥è¯¢è®¢å•å•†å“</span><br><span class="line">        List&lt;OrderItem&gt; items = orderItemService.getByOrderId(orderId);</span><br><span class="line">        orderVo.setOrderItems(convertToItemVos(items));</span><br><span class="line">        </span><br><span class="line">        // æŸ¥è¯¢æ“ä½œæ—¥å¿—</span><br><span class="line">        List&lt;OrderOperationLog&gt; logs = operationLogService.getByOrderId(orderId);</span><br><span class="line">        orderVo.setOperationLogs(convertToLogVos(logs));</span><br><span class="line">        </span><br><span class="line">        // è®¾ç½®æ“ä½œæƒé™</span><br><span class="line">        setOperationPermissions(orderVo, order);</span><br><span class="line">        </span><br><span class="line">        return orderVo;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    @Scheduled(cron = &quot;0 */5 * * * ?&quot;) // æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡</span><br><span class="line">    public void handleTimeoutOrders() &#123;</span><br><span class="line">        log.info(&quot;å¼€å§‹å¤„ç†è¶…æ—¶è®¢å•&quot;);</span><br><span class="line">        </span><br><span class="line">        // æŸ¥è¯¢è¶…æ—¶æœªæ”¯ä»˜çš„è®¢å•</span><br><span class="line">        LocalDateTime timeoutTime = LocalDateTime.now().minusMinutes(30);</span><br><span class="line">        QueryWrapper&lt;Order&gt; wrapper = new QueryWrapper&lt;&gt;();</span><br><span class="line">        wrapper.eq(&quot;status&quot;, OrderState.CREATED.getCode());</span><br><span class="line">        wrapper.le(&quot;create_time&quot;, timeoutTime);</span><br><span class="line">        wrapper.eq(&quot;is_deleted&quot;, 0);</span><br><span class="line">        </span><br><span class="line">        List&lt;Order&gt; timeoutOrders = list(wrapper);</span><br><span class="line">        </span><br><span class="line">        for (Order order : timeoutOrders) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                log.info(&quot;è‡ªåŠ¨å–æ¶ˆè¶…æ—¶è®¢å•ï¼Œè®¢å•å·ï¼š&#123;&#125;&quot;, order.getOrderNo());</span><br><span class="line">                cancelOrder(order.getId(), order.getUserId(), &quot;è¶…æ—¶æœªæ”¯ä»˜ï¼Œç³»ç»Ÿè‡ªåŠ¨å–æ¶ˆ&quot;);</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                log.error(&quot;å–æ¶ˆè¶…æ—¶è®¢å•å¤±è´¥ï¼Œè®¢å•å·ï¼š&#123;&#125;&quot;, order.getOrderNo(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        log.info(&quot;è¶…æ—¶è®¢å•å¤„ç†å®Œæˆï¼Œå…±å¤„ç†&#123;&#125;ä¸ªè®¢å•&quot;, timeoutOrders.size());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    @Scheduled(cron = &quot;0 0 2 * * ?&quot;) // æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ</span><br><span class="line">    public void autoConfirmOrders() &#123;</span><br><span class="line">        log.info(&quot;å¼€å§‹è‡ªåŠ¨ç¡®è®¤æ”¶è´§&quot;);</span><br><span class="line">        </span><br><span class="line">        // æŸ¥è¯¢è¶…æ—¶æœªç¡®è®¤æ”¶è´§çš„è®¢å•ï¼ˆå‘è´§å15å¤©ï¼‰</span><br><span class="line">        LocalDateTime confirmTime = LocalDateTime.now().minusDays(15);</span><br><span class="line">        QueryWrapper&lt;Order&gt; wrapper = new QueryWrapper&lt;&gt;();</span><br><span class="line">        wrapper.eq(&quot;status&quot;, OrderState.SHIPPED.getCode());</span><br><span class="line">        wrapper.le(&quot;delivery_time&quot;, confirmTime);</span><br><span class="line">        wrapper.eq(&quot;is_deleted&quot;, 0);</span><br><span class="line">        </span><br><span class="line">        List&lt;Order&gt; confirmOrders = list(wrapper);</span><br><span class="line">        </span><br><span class="line">        for (Order order : confirmOrders) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                log.info(&quot;è‡ªåŠ¨ç¡®è®¤æ”¶è´§ï¼Œè®¢å•å·ï¼š&#123;&#125;&quot;, order.getOrderNo());</span><br><span class="line">                confirmOrder(order.getId(), order.getUserId());</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                log.error(&quot;è‡ªåŠ¨ç¡®è®¤æ”¶è´§å¤±è´¥ï¼Œè®¢å•å·ï¼š&#123;&#125;&quot;, order.getOrderNo(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        log.info(&quot;è‡ªåŠ¨ç¡®è®¤æ”¶è´§å®Œæˆï¼Œå…±å¤„ç†&#123;&#125;ä¸ªè®¢å•&quot;, confirmOrders.size());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ ¡éªŒåˆ›å»ºè®¢å•è¯·æ±‚</span><br><span class="line">     */</span><br><span class="line">    private void validateCreateOrderRequest(CreateOrderRequest request) &#123;</span><br><span class="line">        if (CollectionUtils.isEmpty(request.getOrderItems())) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.PARAM_VALID_ERROR, &quot;è®¢å•å•†å“ä¸èƒ½ä¸ºç©º&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        for (CreateOrderRequest.OrderItemRequest item : request.getOrderItems()) &#123;</span><br><span class="line">            if (item.getProductId() == null || item.getQuantity() == null || item.getQuantity() &lt;= 0) &#123;</span><br><span class="line">                throw new BusinessException(ResultCode.PARAM_VALID_ERROR, &quot;å•†å“å‚æ•°ä¸åˆæ³•&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è®¡ç®—è®¢å•é‡‘é¢</span><br><span class="line">     */</span><br><span class="line">    private OrderCalculateResult calculateOrderAmount(CreateOrderRequest request, Long userId) &#123;</span><br><span class="line">        BigDecimal totalAmount = BigDecimal.ZERO;</span><br><span class="line">        BigDecimal discountAmount = BigDecimal.ZERO;</span><br><span class="line">        BigDecimal freightAmount = BigDecimal.ZERO;</span><br><span class="line">        </span><br><span class="line">        List&lt;OrderCalculateItem&gt; calculateItems = new ArrayList&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        // è®¡ç®—å•†å“é‡‘é¢</span><br><span class="line">        for (CreateOrderRequest.OrderItemRequest itemRequest : request.getOrderItems()) &#123;</span><br><span class="line">            // æŸ¥è¯¢å•†å“ä¿¡æ¯</span><br><span class="line">            ProductVo product = productService.getProductById(itemRequest.getProductId());</span><br><span class="line">            if (product == null || !product.getStatus().equals(1)) &#123;</span><br><span class="line">                throw new BusinessException(ResultCode.RESOURCE_NOT_FOUND, </span><br><span class="line">                        &quot;å•†å“ä¸å­˜åœ¨æˆ–å·²ä¸‹æ¶ï¼ŒIDï¼š&quot; + itemRequest.getProductId());</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // æ ¡éªŒåº“å­˜</span><br><span class="line">            if (product.getStock() &lt; itemRequest.getQuantity()) &#123;</span><br><span class="line">                throw new BusinessException(ResultCode.BUSINESS_ERROR, </span><br><span class="line">                        &quot;å•†å“åº“å­˜ä¸è¶³ï¼š&quot; + product.getProductName());</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // è®¡ç®—å•†å“é‡‘é¢</span><br><span class="line">            BigDecimal itemTotal = product.getPrice()</span><br><span class="line">                    .multiply(BigDecimal.valueOf(itemRequest.getQuantity()));</span><br><span class="line">            </span><br><span class="line">            totalAmount = totalAmount.add(itemTotal);</span><br><span class="line">            </span><br><span class="line">            // æ„å»ºè®¡ç®—é¡¹</span><br><span class="line">            OrderCalculateItem calculateItem = OrderCalculateItem.builder()</span><br><span class="line">                    .productId(product.getId())</span><br><span class="line">                    .productName(product.getProductName())</span><br><span class="line">                    .productImage(product.getMainImage())</span><br><span class="line">                    .productPrice(product.getPrice())</span><br><span class="line">                    .quantity(itemRequest.getQuantity())</span><br><span class="line">                    .totalAmount(itemTotal)</span><br><span class="line">                    .productAttr(itemRequest.getProductAttr())</span><br><span class="line">                    .build();</span><br><span class="line">            </span><br><span class="line">            calculateItems.add(calculateItem);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // è®¡ç®—è¿è´¹ï¼ˆæ ¹æ®æ€»é‡‘é¢åˆ¤æ–­æ˜¯å¦åŒ…é‚®ï¼‰</span><br><span class="line">        if (totalAmount.compareTo(new BigDecimal(&quot;99&quot;)) &lt; 0) &#123;</span><br><span class="line">            freightAmount = new BigDecimal(&quot;10&quot;); // è¿è´¹10å…ƒ</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // è®¡ç®—ä¼˜æƒ é‡‘é¢</span><br><span class="line">        if (request.getCouponId() != null) &#123;</span><br><span class="line">            CouponVo coupon = couponService.getCouponById(request.getCouponId(), userId);</span><br><span class="line">            if (coupon != null &amp;&amp; coupon.isValid() &amp;&amp; </span><br><span class="line">                    totalAmount.compareTo(coupon.getMinAmount()) &gt;= 0) &#123;</span><br><span class="line">                discountAmount = coupon.getDiscountAmount();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // è®¡ç®—å®ä»˜é‡‘é¢</span><br><span class="line">        BigDecimal payAmount = totalAmount.add(freightAmount).subtract(discountAmount);</span><br><span class="line">        if (payAmount.compareTo(BigDecimal.ZERO) &lt; 0) &#123;</span><br><span class="line">            payAmount = BigDecimal.ZERO;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return OrderCalculateResult.builder()</span><br><span class="line">                .totalAmount(totalAmount)</span><br><span class="line">                .discountAmount(discountAmount)</span><br><span class="line">                .freightAmount(freightAmount)</span><br><span class="line">                .payAmount(payAmount)</span><br><span class="line">                .orderItems(calculateItems)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * é”å®šåº“å­˜</span><br><span class="line">     */</span><br><span class="line">    private boolean lockInventory(List&lt;OrderCalculateItem&gt; orderItems) &#123;</span><br><span class="line">        for (OrderCalculateItem item : orderItems) &#123;</span><br><span class="line">            boolean success = inventoryService.lockInventory(</span><br><span class="line">                    item.getProductId(), </span><br><span class="line">                    item.getQuantity(),</span><br><span class="line">                    300); // é”å®š5åˆ†é’Ÿ</span><br><span class="line">            </span><br><span class="line">            if (!success) &#123;</span><br><span class="line">                // å¦‚æœæœ‰ä¸€ä¸ªå•†å“é”å®šå¤±è´¥ï¼Œéœ€è¦é‡Šæ”¾ä¹‹å‰å·²é”å®šçš„åº“å­˜</span><br><span class="line">                releaseAllLockedInventory(orderItems);</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * ç”Ÿæˆè®¢å•å·</span><br><span class="line">     */</span><br><span class="line">    private String generateOrderNo() &#123;</span><br><span class="line">        // æ ¼å¼ï¼šSH + å¹´æœˆæ—¥ + 6ä½éšæœºæ•°</span><br><span class="line">        String dateStr = LocalDateTime.now().format(DateTimeFormatter.ofPattern(&quot;yyyyMMdd&quot;));</span><br><span class="line">        String random = String.valueOf((int)((Math.random() * 9 + 1) * 100000));</span><br><span class="line">        return &quot;SH&quot; + dateStr + random;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * ä¿å­˜è®¢å•</span><br><span class="line">     */</span><br><span class="line">    private Order saveOrder(String orderNo, Long userId, AddressVo address, </span><br><span class="line">                           OrderCalculateResult calculateResult, CreateOrderRequest request) &#123;</span><br><span class="line">        Order order = new Order();</span><br><span class="line">        order.setOrderNo(orderNo);</span><br><span class="line">        order.setUserId(userId);</span><br><span class="line">        order.setTotalAmount(calculateResult.getTotalAmount());</span><br><span class="line">        order.setPayAmount(calculateResult.getPayAmount());</span><br><span class="line">        order.setFreightAmount(calculateResult.getFreightAmount());</span><br><span class="line">        order.setDiscountAmount(calculateResult.getDiscountAmount());</span><br><span class="line">        order.setPayType(request.getPayType());</span><br><span class="line">        order.setStatus(OrderState.CREATED.getCode());</span><br><span class="line">        order.setReceiverName(address.getReceiverName());</span><br><span class="line">        order.setReceiverPhone(address.getReceiverPhone());</span><br><span class="line">        order.setReceiverProvince(address.getProvince());</span><br><span class="line">        order.setReceiverCity(address.getCity());</span><br><span class="line">        order.setReceiverRegion(address.getRegion());</span><br><span class="line">        order.setReceiverAddress(address.getDetailAddress());</span><br><span class="line">        order.setRemark(request.getRemark());</span><br><span class="line">        order.setAutoConfirmDays(15); // é»˜è®¤15å¤©è‡ªåŠ¨ç¡®è®¤æ”¶è´§</span><br><span class="line">        </span><br><span class="line">        boolean saveSuccess = save(order);</span><br><span class="line">        if (!saveSuccess) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.SYSTEM_ERROR, &quot;ä¿å­˜è®¢å•å¤±è´¥&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return order;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * ä¿å­˜è®¢å•å•†å“</span><br><span class="line">     */</span><br><span class="line">    private void saveOrderItems(Long orderId, String orderNo, List&lt;OrderCalculateItem&gt; calculateItems) &#123;</span><br><span class="line">        List&lt;OrderItem&gt; orderItems = calculateItems.stream()</span><br><span class="line">                .map(item -&gt; &#123;</span><br><span class="line">                    OrderItem orderItem = new OrderItem();</span><br><span class="line">                    orderItem.setOrderId(orderId);</span><br><span class="line">                    orderItem.setOrderNo(orderNo);</span><br><span class="line">                    orderItem.setProductId(item.getProductId());</span><br><span class="line">                    orderItem.setProductName(item.getProductName());</span><br><span class="line">                    orderItem.setProductImage(item.getProductImage());</span><br><span class="line">                    orderItem.setProductPrice(item.getProductPrice());</span><br><span class="line">                    orderItem.setProductAttr(item.getProductAttr());</span><br><span class="line">                    orderItem.setQuantity(item.getQuantity());</span><br><span class="line">                    orderItem.setTotalAmount(item.getTotalAmount());</span><br><span class="line">                    return orderItem;</span><br><span class="line">                &#125;)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        </span><br><span class="line">        boolean saveSuccess = orderItemService.saveBatch(orderItems);</span><br><span class="line">        if (!saveSuccess) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.SYSTEM_ERROR, &quot;ä¿å­˜è®¢å•å•†å“å¤±è´¥&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è®°å½•æ“ä½œæ—¥å¿—</span><br><span class="line">     */</span><br><span class="line">    private void saveOperationLog(Order order, String operationType, Long userId) &#123;</span><br><span class="line">        OrderOperationLog log = new OrderOperationLog();</span><br><span class="line">        log.setOrderId(order.getId());</span><br><span class="line">        log.setOrderNo(order.getOrderNo());</span><br><span class="line">        log.setOperationType(operationType);</span><br><span class="line">        log.setOperationUser(String.valueOf(userId));</span><br><span class="line">        log.setOperationUserType(1); // ç”¨æˆ·æ“ä½œ</span><br><span class="line">        log.setOperationTime(LocalDateTime.now());</span><br><span class="line">        log.setBeforeStatus(order.getStatus());</span><br><span class="line">        // æ“ä½œåçŠ¶æ€éœ€è¦æ ¹æ®æ“ä½œç±»å‹ç¡®å®š</span><br><span class="line">        log.setRemark(&quot;ç”¨æˆ·æ“ä½œ&quot;);</span><br><span class="line">        </span><br><span class="line">        operationLogService.save(log);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å‘é€è®¢å•åˆ›å»ºæ¶ˆæ¯</span><br><span class="line">     */</span><br><span class="line">    private void sendOrderCreateMessage(Order order) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            OrderCreateMessage message = OrderCreateMessage.builder()</span><br><span class="line">                    .orderId(order.getId())</span><br><span class="line">                    .orderNo(order.getOrderNo())</span><br><span class="line">                    .userId(order.getUserId())</span><br><span class="line">                    .totalAmount(order.getTotalAmount())</span><br><span class="line">                    .createTime(order.getCreateTime())</span><br><span class="line">                    .build();</span><br><span class="line">            </span><br><span class="line">            rocketMQTemplate.syncSend(</span><br><span class="line">                    &quot;ORDER_TOPIC:ORDER_CREATE&quot;,</span><br><span class="line">                    MessageBuilder.withPayload(message).build()</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            log.info(&quot;å‘é€è®¢å•åˆ›å»ºæ¶ˆæ¯æˆåŠŸï¼Œè®¢å•å·ï¼š&#123;&#125;&quot;, order.getOrderNo());</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;å‘é€è®¢å•åˆ›å»ºæ¶ˆæ¯å¤±è´¥ï¼Œè®¢å•å·ï¼š&#123;&#125;&quot;, order.getOrderNo(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è®¾ç½®è®¢å•è¶…æ—¶ä»»åŠ¡</span><br><span class="line">     */</span><br><span class="line">    private void scheduleOrderTimeout(Long orderId, String orderNo) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            // ä½¿ç”¨Redisè®¾ç½®è¶…æ—¶keyï¼Œ30åˆ†é’Ÿåè¿‡æœŸ</span><br><span class="line">            String timeoutKey = &quot;order:timeout:&quot; + orderNo;</span><br><span class="line">            redisTemplate.opsForValue().set(timeoutKey, orderId, 30, TimeUnit.MINUTES);</span><br><span class="line">            </span><br><span class="line">            log.info(&quot;è®¾ç½®è®¢å•è¶…æ—¶ä»»åŠ¡ï¼Œè®¢å•å·ï¼š&#123;&#125;&quot;, orderNo);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;è®¾ç½®è®¢å•è¶…æ—¶ä»»åŠ¡å¤±è´¥ï¼Œè®¢å•å·ï¼š&#123;&#125;&quot;, orderNo, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è§¦å‘çŠ¶æ€æœºè½¬æ¢</span><br><span class="line">     */</span><br><span class="line">    private void triggerStateMachine(Long orderId, OrderEvent event) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            orderStateMachine.getStateMachineAccessor()</span><br><span class="line">                    .doWithAllRegions(access -&gt; &#123;</span><br><span class="line">                        access.resetStateMachine(</span><br><span class="line">                                new DefaultStateMachineContext&lt;&gt;(</span><br><span class="line">                                        OrderState.CREATED, null, null, null)</span><br><span class="line">                        );</span><br><span class="line">                    &#125;);</span><br><span class="line">            </span><br><span class="line">            orderStateMachine.start();</span><br><span class="line">            orderStateMachine.sendEvent(MessageBuilder</span><br><span class="line">                    .withPayload(event)</span><br><span class="line">                    .setHeader(&quot;orderId&quot;, orderId)</span><br><span class="line">                    .build());</span><br><span class="line">            </span><br><span class="line">            log.info(&quot;è§¦å‘çŠ¶æ€æœºè½¬æ¢ï¼Œè®¢å•IDï¼š&#123;&#125;ï¼Œäº‹ä»¶ï¼š&#123;&#125;&quot;, orderId, event);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;è§¦å‘çŠ¶æ€æœºè½¬æ¢å¤±è´¥ï¼Œè®¢å•IDï¼š&#123;&#125;ï¼Œäº‹ä»¶ï¼š&#123;&#125;&quot;, orderId, event, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ£€æŸ¥è®¢å•æ˜¯å¦å¯ä»¥å–æ¶ˆ</span><br><span class="line">     */</span><br><span class="line">    private boolean canCancel(Order order) &#123;</span><br><span class="line">        Integer status = order.getStatus();</span><br><span class="line">        return OrderState.CREATED.getCode().equals(status) || </span><br><span class="line">               (OrderState.PAID.getCode().equals(status) &amp;&amp; </span><br><span class="line">                order.getDeliveryTime() == null); // å·²æ”¯ä»˜ä½†æœªå‘è´§</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è®¾ç½®æ“ä½œæƒé™</span><br><span class="line">     */</span><br><span class="line">    private void setOperationPermissions(OrderVo orderVo, Order order) &#123;</span><br><span class="line">        Integer status = order.getStatus();</span><br><span class="line">        </span><br><span class="line">        // æ˜¯å¦å¯ä»¥å–æ¶ˆ</span><br><span class="line">        orderVo.setCanCancel(canCancel(order));</span><br><span class="line">        </span><br><span class="line">        // æ˜¯å¦å¯ä»¥æ”¯ä»˜</span><br><span class="line">        orderVo.setCanPay(OrderState.CREATED.getCode().equals(status));</span><br><span class="line">        </span><br><span class="line">        // æ˜¯å¦å¯ä»¥ç¡®è®¤æ”¶è´§</span><br><span class="line">        orderVo.setCanConfirm(OrderState.SHIPPED.getCode().equals(status));</span><br><span class="line">        </span><br><span class="line">        // æ˜¯å¦å¯ä»¥é€€æ¬¾</span><br><span class="line">        orderVo.setCanRefund(OrderState.PAID.getCode().equals(status) || </span><br><span class="line">                            OrderState.SHIPPED.getCode().equals(status));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è½¬æ¢è®¢å•ä¸ºVO</span><br><span class="line">     */</span><br><span class="line">    private OrderVo convertToVo(Order order) &#123;</span><br><span class="line">        OrderVo vo = new OrderVo();</span><br><span class="line">        BeanUtils.copyProperties(order, vo);</span><br><span class="line">        </span><br><span class="line">        // è®¾ç½®çŠ¶æ€æè¿°</span><br><span class="line">        OrderState state = OrderState.getByCode(order.getStatus());</span><br><span class="line">        if (state != null) &#123;</span><br><span class="line">            vo.setStatusDesc(state.getDesc());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // è®¾ç½®æ”¯ä»˜æ–¹å¼æè¿°</span><br><span class="line">        if (order.getPayType() != null) &#123;</span><br><span class="line">            vo.setPayTypeDesc(getPayTypeDesc(order.getPayType()));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return vo;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è·å–æ”¯ä»˜æ–¹å¼æè¿°</span><br><span class="line">     */</span><br><span class="line">    private String getPayTypeDesc(Integer payType) &#123;</span><br><span class="line">        switch (payType) &#123;</span><br><span class="line">            case 1: return &quot;æ”¯ä»˜å®&quot;;</span><br><span class="line">            case 2: return &quot;å¾®ä¿¡&quot;;</span><br><span class="line">            case 3: return &quot;é“¶è”&quot;;</span><br><span class="line">            default: return &quot;æœªçŸ¥&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// è®¢å•è®¡ç®—ç»“æœ</span><br><span class="line">@Data</span><br><span class="line">@Builder</span><br><span class="line">class OrderCalculateResult &#123;</span><br><span class="line">    private BigDecimal totalAmount;</span><br><span class="line">    private BigDecimal discountAmount;</span><br><span class="line">    private BigDecimal freightAmount;</span><br><span class="line">    private BigDecimal payAmount;</span><br><span class="line">    private List&lt;OrderCalculateItem&gt; orderItems;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// è®¢å•è®¡ç®—é¡¹</span><br><span class="line">@Data</span><br><span class="line">@Builder</span><br><span class="line">class OrderCalculateItem &#123;</span><br><span class="line">    private Long productId;</span><br><span class="line">    private String productName;</span><br><span class="line">    private String productImage;</span><br><span class="line">    private BigDecimal productPrice;</span><br><span class="line">    private Integer quantity;</span><br><span class="line">    private BigDecimal totalAmount;</span><br><span class="line">    private String productAttr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// åˆ›å»ºè®¢å•ç»“æœ</span><br><span class="line">@Data</span><br><span class="line">@Builder</span><br><span class="line">class CreateOrderResult &#123;</span><br><span class="line">    private Long orderId;</span><br><span class="line">    private String orderNo;</span><br><span class="line">    private BigDecimal totalAmount;</span><br><span class="line">    private BigDecimal payAmount;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æ”¯ä»˜è®¢å•è¯·æ±‚</span><br><span class="line">@Data</span><br><span class="line">class PayOrderRequest &#123;</span><br><span class="line">    @NotNull(message = &quot;è®¢å•å·ä¸èƒ½ä¸ºç©º&quot;)</span><br><span class="line">    private String orderNo;</span><br><span class="line">    </span><br><span class="line">    @NotNull(message = &quot;æ”¯ä»˜æ–¹å¼ä¸èƒ½ä¸ºç©º&quot;)</span><br><span class="line">    private Integer payType;</span><br><span class="line">    </span><br><span class="line">    @NotNull(message = &quot;æ”¯ä»˜é‡‘é¢ä¸èƒ½ä¸ºç©º&quot;)</span><br><span class="line">    private BigDecimal payAmount;</span><br><span class="line">    </span><br><span class="line">    private String paymentNo; // ç¬¬ä¸‰æ–¹æ”¯ä»˜æµæ°´å·</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æ”¯ä»˜ç»“æœ</span><br><span class="line">@Data</span><br><span class="line">class PayResult &#123;</span><br><span class="line">    private boolean success;</span><br><span class="line">    private String transactionId;</span><br><span class="line">    private String errorMsg;</span><br><span class="line">    private LocalDateTime payTime;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// è®¢å•åˆ›å»ºæ¶ˆæ¯</span><br><span class="line">@Data</span><br><span class="line">@Builder</span><br><span class="line">class OrderCreateMessage &#123;</span><br><span class="line">    private Long orderId;</span><br><span class="line">    private String orderNo;</span><br><span class="line">    private Long userId;</span><br><span class="line">    private BigDecimal totalAmount;</span><br><span class="line">    private LocalDateTime createTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºç¯‡å¹…é™åˆ¶ï¼Œæˆ‘å…ˆå±•ç¤ºç¬¬12å¤©çš„è®¢å•æœåŠ¡åŸºç¡€æ¶æ„ã€åˆ†å¸ƒå¼äº‹åŠ¡é›†æˆå’ŒçŠ¶æ€æœºå®ç°ã€‚ç¬¬13å¤©æˆ‘ä»¬å°†é‡ç‚¹å®ç°ï¼š</p><ol><li><strong>åº“å­˜æœåŠ¡çš„å¹¶å‘æ§åˆ¶</strong>ï¼ˆåˆ†å¸ƒå¼é” + RedisåŸå­æ“ä½œï¼‰</li><li><strong>è®¢å•è¶…æ—¶è‡ªåŠ¨å–æ¶ˆ</strong>ï¼ˆå®šæ—¶ä»»åŠ¡ + å»¶è¿Ÿé˜Ÿåˆ—ï¼‰</li><li><strong>è®¢å•åˆ†åº“åˆ†è¡¨æŸ¥è¯¢</strong>ï¼ˆShardingSphereé›†æˆï¼‰</li><li><strong>è®¢å•é€€æ¬¾æµç¨‹</strong></li><li><strong>è®¢å•æ•°æ®åŒæ­¥åˆ°ES</strong></li></ol><p>æ˜¯å¦ç»§ç»­ç¬¬13å¤©çš„å®ç°ï¼Ÿ</p><p>ç»§ç»­</p><p>æˆ‘ä»¬ç»§ç»­ç¬¬13å¤©çš„å®ç°ï¼šåº“å­˜æœåŠ¡çš„å¹¶å‘æ§åˆ¶ã€è®¢å•è¶…æ—¶è‡ªåŠ¨å–æ¶ˆã€è®¢å•åˆ†åº“åˆ†è¡¨æŸ¥è¯¢ã€è®¢å•é€€æ¬¾æµç¨‹å’Œè®¢å•æ•°æ®åŒæ­¥åˆ°ESã€‚</p><p>ç”±äºå†…å®¹è¾ƒå¤šï¼Œæˆ‘ä»¬å°†åˆ†æ­¥éª¤è¿›è¡Œã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å®ç°åº“å­˜æœåŠ¡çš„å¹¶å‘æ§åˆ¶ã€‚</p><h2 id="1-åº“å­˜æœåŠ¡çš„å¹¶å‘æ§åˆ¶"><a href="#1-åº“å­˜æœåŠ¡çš„å¹¶å‘æ§åˆ¶" class="headerlink" title="1. åº“å­˜æœåŠ¡çš„å¹¶å‘æ§åˆ¶"></a>1. åº“å­˜æœåŠ¡çš„å¹¶å‘æ§åˆ¶</h2><p>åº“å­˜æ‰£å‡æ˜¯ç”µå•†ç³»ç»Ÿä¸­ä¸€ä¸ªå…¸å‹çš„å¹¶å‘åœºæ™¯ï¼Œéœ€è¦ä¿è¯åœ¨é«˜å¹¶å‘ä¸‹åº“å­˜æ•°æ®çš„ä¸€è‡´æ€§å’Œå‡†ç¡®æ€§ã€‚æˆ‘ä»¬å°†ä½¿ç”¨åˆ†å¸ƒå¼é”ï¼ˆRedissonï¼‰å’ŒRedisåŸå­æ“ä½œæ¥å®ç°ã€‚</p><h3 id="åº“å­˜æœåŠ¡ï¼ˆshophub-inventoryï¼‰å®ç°"><a href="#åº“å­˜æœåŠ¡ï¼ˆshophub-inventoryï¼‰å®ç°" class="headerlink" title="åº“å­˜æœåŠ¡ï¼ˆshophub-inventoryï¼‰å®ç°"></a>åº“å­˜æœåŠ¡ï¼ˆshophub-inventoryï¼‰å®ç°</h3><p>é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºåº“å­˜æœåŠ¡æ¨¡å—ï¼Œå¹¶å®ç°åº“å­˜æ‰£å‡ã€é”å®šã€é‡Šæ”¾ç­‰åŠŸèƒ½ã€‚</p><p><strong>æ³¨æ„</strong>ï¼šç”±äºæˆ‘ä»¬ä¹‹å‰å·²ç»åœ¨è®¢å•æœåŠ¡ä¸­å¼•ç”¨äº†åº“å­˜æœåŠ¡ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦å®ç°åº“å­˜æœåŠ¡çš„æ¥å£ã€‚</p><h4 id="1-1-åº“å­˜æœåŠ¡é¡¹ç›®ç»“æ„"><a href="#1-1-åº“å­˜æœåŠ¡é¡¹ç›®ç»“æ„" class="headerlink" title="1.1 åº“å­˜æœåŠ¡é¡¹ç›®ç»“æ„"></a>1.1 åº“å­˜æœåŠ¡é¡¹ç›®ç»“æ„</h4><p>ç±»ä¼¼å…¶ä»–æœåŠ¡ï¼Œæˆ‘ä»¬åˆ›å»ºåº“å­˜æœåŠ¡æ¨¡å—ï¼ŒåŒ…å«ä»¥ä¸‹ä¾èµ–ï¼š</p><p>xml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- shophub-inventory/pom.xml --&gt;</span><br><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;!-- Spring Boot Starter --&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;!-- MyBatis Plus --&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;com.baomidou&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;mybatis-plus-boot-starter&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;$&#123;mybatis-plus.version&#125;&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;!-- Redis --&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;!-- Redisson --&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.redisson&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;redisson-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;$&#123;redisson.version&#125;&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;!-- Nacos --&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;!-- é€šç”¨æ¨¡å— --&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;com.shophub&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;shophub-common&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;1.0.0&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br></pre></td></tr></table></figure><h4 id="1-2-åº“å­˜è¡¨ç»“æ„"><a href="#1-2-åº“å­˜è¡¨ç»“æ„" class="headerlink" title="1.2 åº“å­˜è¡¨ç»“æ„"></a>1.2 åº“å­˜è¡¨ç»“æ„</h4><p>sql</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">-- åº“å­˜è¡¨</span><br><span class="line">CREATE TABLE `inventory` (</span><br><span class="line">  `id` bigint(20) NOT NULL COMMENT &#x27;åº“å­˜ID&#x27;,</span><br><span class="line">  `product_id` bigint(20) NOT NULL COMMENT &#x27;å•†å“ID&#x27;,</span><br><span class="line">  `total_stock` int(11) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;æ€»åº“å­˜&#x27;,</span><br><span class="line">  `available_stock` int(11) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;å¯ç”¨åº“å­˜&#x27;,</span><br><span class="line">  `locked_stock` int(11) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;é”å®šåº“å­˜&#x27;,</span><br><span class="line">  `is_deleted` tinyint(1) DEFAULT &#x27;0&#x27; COMMENT &#x27;æ˜¯å¦åˆ é™¤ï¼š0-å¦ï¼Œ1-æ˜¯&#x27;,</span><br><span class="line">  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;åˆ›å»ºæ—¶é—´&#x27;,</span><br><span class="line">  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &#x27;æ›´æ–°æ—¶é—´&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_product_id` (`product_id`),</span><br><span class="line">  KEY `idx_product_id` (`product_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=&#x27;åº“å­˜è¡¨&#x27;;</span><br><span class="line"></span><br><span class="line">-- åº“å­˜æ“ä½œæµæ°´è¡¨</span><br><span class="line">CREATE TABLE `inventory_log` (</span><br><span class="line">  `id` bigint(20) NOT NULL COMMENT &#x27;æµæ°´ID&#x27;,</span><br><span class="line">  `product_id` bigint(20) NOT NULL COMMENT &#x27;å•†å“ID&#x27;,</span><br><span class="line">  `order_id` bigint(20) DEFAULT NULL COMMENT &#x27;è®¢å•ID&#x27;,</span><br><span class="line">  `order_no` varchar(32) DEFAULT NULL COMMENT &#x27;è®¢å•å·&#x27;,</span><br><span class="line">  `change_type` tinyint(1) NOT NULL COMMENT &#x27;å˜æ›´ç±»å‹ï¼š1-é”å®šï¼Œ2-æ‰£å‡ï¼Œ3-é‡Šæ”¾ï¼Œ4-å¢åŠ &#x27;,</span><br><span class="line">  `change_quantity` int(11) NOT NULL COMMENT &#x27;å˜æ›´æ•°é‡&#x27;,</span><br><span class="line">  `before_total` int(11) NOT NULL COMMENT &#x27;å˜æ›´å‰æ€»åº“å­˜&#x27;,</span><br><span class="line">  `after_total` int(11) NOT NULL COMMENT &#x27;å˜æ›´åæ€»åº“å­˜&#x27;,</span><br><span class="line">  `before_available` int(11) NOT NULL COMMENT &#x27;å˜æ›´å‰å¯ç”¨åº“å­˜&#x27;,</span><br><span class="line">  `after_available` int(11) NOT NULL COMMENT &#x27;å˜æ›´åå¯ç”¨åº“å­˜&#x27;,</span><br><span class="line">  `before_locked` int(11) NOT NULL COMMENT &#x27;å˜æ›´å‰é”å®šåº“å­˜&#x27;,</span><br><span class="line">  `after_locked` int(11) NOT NULL COMMENT &#x27;å˜æ›´åé”å®šåº“å­˜&#x27;,</span><br><span class="line">  `remark` varchar(500) DEFAULT NULL COMMENT &#x27;å¤‡æ³¨&#x27;,</span><br><span class="line">  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;åˆ›å»ºæ—¶é—´&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  KEY `idx_product_id` (`product_id`),</span><br><span class="line">  KEY `idx_order_id` (`order_id`),</span><br><span class="line">  KEY `idx_create_time` (`create_time`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=&#x27;åº“å­˜æ“ä½œæµæ°´è¡¨&#x27;;</span><br></pre></td></tr></table></figure><h4 id="1-3-åº“å­˜æœåŠ¡å®ç°"><a href="#1-3-åº“å­˜æœåŠ¡å®ç°" class="headerlink" title="1.3 åº“å­˜æœåŠ¡å®ç°"></a>1.3 åº“å­˜æœåŠ¡å®ç°</h4><p>æˆ‘ä»¬å®ç°åº“å­˜çš„é”å®šã€æ‰£å‡ã€é‡Šæ”¾ç­‰æ“ä½œï¼Œå¹¶åˆ©ç”¨åˆ†å¸ƒå¼é”ä¿è¯å¹¶å‘å®‰å…¨ã€‚</p><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.inventory.service.impl;</span><br><span class="line"></span><br><span class="line">import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;</span><br><span class="line">import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span><br><span class="line">import com.shophub.common.exception.BusinessException;</span><br><span class="line">import com.shophub.common.result.ResultCode;</span><br><span class="line">import com.shophub.inventory.entity.Inventory;</span><br><span class="line">import com.shophub.inventory.entity.InventoryLog;</span><br><span class="line">import com.shophub.inventory.mapper.InventoryMapper;</span><br><span class="line">import com.shophub.inventory.service.InventoryService;</span><br><span class="line">import lombok.RequiredArgsConstructor;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.redisson.api.RLock;</span><br><span class="line">import org.redisson.api.RedissonClient;</span><br><span class="line">import org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line">import org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line">import java.time.LocalDateTime;</span><br><span class="line">import java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@Service</span><br><span class="line">@RequiredArgsConstructor</span><br><span class="line">public class InventoryServiceImpl extends ServiceImpl&lt;InventoryMapper, Inventory&gt; implements InventoryService &#123;</span><br><span class="line">    </span><br><span class="line">    private final InventoryMapper inventoryMapper;</span><br><span class="line">    private final RedissonClient redissonClient;</span><br><span class="line">    private final RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    private final InventoryLogService inventoryLogService;</span><br><span class="line">    </span><br><span class="line">    // Redis keyå‰ç¼€</span><br><span class="line">    private static final String INVENTORY_LOCK_PREFIX = &quot;inventory:lock:&quot;;</span><br><span class="line">    private static final String INVENTORY_STOCK_PREFIX = &quot;inventory:stock:&quot;;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    @Transactional(rollbackFor = Exception.class)</span><br><span class="line">    public boolean lockInventory(Long productId, Integer quantity, Integer timeoutSeconds) &#123;</span><br><span class="line">        log.info(&quot;é”å®šåº“å­˜ï¼Œå•†å“IDï¼š&#123;&#125;ï¼Œæ•°é‡ï¼š&#123;&#125;ï¼Œè¶…æ—¶æ—¶é—´ï¼š&#123;&#125;ç§’&quot;, productId, quantity, timeoutSeconds);</span><br><span class="line">        </span><br><span class="line">        if (productId == null || quantity == null || quantity &lt;= 0) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.PARAM_VALID_ERROR, &quot;å‚æ•°ä¸åˆæ³•&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // ä½¿ç”¨å•†å“IDä½œä¸ºé”keyï¼Œç¡®ä¿åŒä¸€å•†å“çš„åº“å­˜æ“ä½œä¸²è¡ŒåŒ–</span><br><span class="line">        String lockKey = INVENTORY_LOCK_PREFIX + productId;</span><br><span class="line">        RLock lock = redissonClient.getLock(lockKey);</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            // å°è¯•åŠ é”ï¼Œæœ€å¤šç­‰å¾…5ç§’ï¼Œé”10ç§’åè‡ªåŠ¨é‡Šæ”¾</span><br><span class="line">            boolean locked = lock.tryLock(5, 10, TimeUnit.SECONDS);</span><br><span class="line">            if (!locked) &#123;</span><br><span class="line">                throw new BusinessException(ResultCode.SYSTEM_ERROR, &quot;ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // æŸ¥è¯¢åº“å­˜</span><br><span class="line">            Inventory inventory = getByProductId(productId);</span><br><span class="line">            if (inventory == null) &#123;</span><br><span class="line">                throw new BusinessException(ResultCode.RESOURCE_NOT_FOUND, &quot;å•†å“åº“å­˜ä¸å­˜åœ¨&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // æ£€æŸ¥å¯ç”¨åº“å­˜</span><br><span class="line">            if (inventory.getAvailableStock() &lt; quantity) &#123;</span><br><span class="line">                log.error(&quot;åº“å­˜ä¸è¶³ï¼Œå•†å“IDï¼š&#123;&#125;ï¼Œå¯ç”¨åº“å­˜ï¼š&#123;&#125;ï¼Œéœ€è¦é”å®šï¼š&#123;&#125;&quot;, </span><br><span class="line">                        productId, inventory.getAvailableStock(), quantity);</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // æ›´æ–°åº“å­˜ï¼ˆé”å®šï¼‰</span><br><span class="line">            int updateCount = inventoryMapper.lockStock(productId, quantity);</span><br><span class="line">            if (updateCount &lt;= 0) &#123;</span><br><span class="line">                throw new BusinessException(ResultCode.SYSTEM_ERROR, &quot;é”å®šåº“å­˜å¤±è´¥&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // è®°å½•åº“å­˜æµæ°´</span><br><span class="line">            InventoryLog inventoryLog = new InventoryLog();</span><br><span class="line">            inventoryLog.setProductId(productId);</span><br><span class="line">            inventoryLog.setChangeType(1); // é”å®š</span><br><span class="line">            inventoryLog.setChangeQuantity(quantity);</span><br><span class="line">            inventoryLog.setBeforeAvailable(inventory.getAvailableStock());</span><br><span class="line">            inventoryLog.setAfterAvailable(inventory.getAvailableStock() - quantity);</span><br><span class="line">            inventoryLog.setBeforeLocked(inventory.getLockedStock());</span><br><span class="line">            inventoryLog.setAfterLocked(inventory.getLockedStock() + quantity);</span><br><span class="line">            inventoryLog.setBeforeTotal(inventory.getTotalStock());</span><br><span class="line">            inventoryLog.setAfterTotal(inventory.getTotalStock());</span><br><span class="line">            inventoryLog.setRemark(&quot;è®¢å•é”å®šåº“å­˜&quot;);</span><br><span class="line">            inventoryLogService.save(inventoryLog);</span><br><span class="line">            </span><br><span class="line">            // æ›´æ–°Redisç¼“å­˜ï¼ˆå¯é€‰ï¼Œç”¨äºå¿«é€ŸæŸ¥è¯¢ï¼‰</span><br><span class="line">            updateInventoryCache(productId, inventory);</span><br><span class="line">            </span><br><span class="line">            log.info(&quot;é”å®šåº“å­˜æˆåŠŸï¼Œå•†å“IDï¼š&#123;&#125;ï¼Œæ•°é‡ï¼š&#123;&#125;&quot;, productId, quantity);</span><br><span class="line">            return true;</span><br><span class="line">            </span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">            throw new BusinessException(ResultCode.SYSTEM_ERROR, &quot;ç³»ç»Ÿå¼‚å¸¸&quot;);</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            // é‡Šæ”¾é”</span><br><span class="line">            if (lock.isHeldByCurrentThread()) &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    @Transactional(rollbackFor = Exception.class)</span><br><span class="line">    public boolean deductInventory(Long productId, Integer quantity) &#123;</span><br><span class="line">        log.info(&quot;æ‰£å‡åº“å­˜ï¼Œå•†å“IDï¼š&#123;&#125;ï¼Œæ•°é‡ï¼š&#123;&#125;&quot;, productId, quantity);</span><br><span class="line">        </span><br><span class="line">        // åŒæ ·éœ€è¦åŠ é”</span><br><span class="line">        String lockKey = INVENTORY_LOCK_PREFIX + productId;</span><br><span class="line">        RLock lock = redissonClient.getLock(lockKey);</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            boolean locked = lock.tryLock(5, 10, TimeUnit.SECONDS);</span><br><span class="line">            if (!locked) &#123;</span><br><span class="line">                throw new BusinessException(ResultCode.SYSTEM_ERROR, &quot;ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            Inventory inventory = getByProductId(productId);</span><br><span class="line">            if (inventory == null) &#123;</span><br><span class="line">                throw new BusinessException(ResultCode.RESOURCE_NOT_FOUND, &quot;å•†å“åº“å­˜ä¸å­˜åœ¨&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // æ£€æŸ¥é”å®šåº“å­˜æ˜¯å¦è¶³å¤Ÿ</span><br><span class="line">            if (inventory.getLockedStock() &lt; quantity) &#123;</span><br><span class="line">                log.error(&quot;é”å®šåº“å­˜ä¸è¶³ï¼Œå•†å“IDï¼š&#123;&#125;ï¼Œé”å®šåº“å­˜ï¼š&#123;&#125;ï¼Œéœ€è¦æ‰£å‡ï¼š&#123;&#125;&quot;, </span><br><span class="line">                        productId, inventory.getLockedStock(), quantity);</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // æ‰£å‡åº“å­˜ï¼ˆä»é”å®šåº“å­˜ä¸­æ‰£å‡ï¼ŒåŒæ—¶å‡å°‘æ€»åº“å­˜ï¼‰</span><br><span class="line">            int updateCount = inventoryMapper.deductStock(productId, quantity);</span><br><span class="line">            if (updateCount &lt;= 0) &#123;</span><br><span class="line">                throw new BusinessException(ResultCode.SYSTEM_ERROR, &quot;æ‰£å‡åº“å­˜å¤±è´¥&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // è®°å½•åº“å­˜æµæ°´</span><br><span class="line">            InventoryLog inventoryLog = new InventoryLog();</span><br><span class="line">            inventoryLog.setProductId(productId);</span><br><span class="line">            inventoryLog.setChangeType(2); // æ‰£å‡</span><br><span class="line">            inventoryLog.setChangeQuantity(quantity);</span><br><span class="line">            inventoryLog.setBeforeAvailable(inventory.getAvailableStock());</span><br><span class="line">            inventoryLog.setAfterAvailable(inventory.getAvailableStock());</span><br><span class="line">            inventoryLog.setBeforeLocked(inventory.getLockedStock());</span><br><span class="line">            inventoryLog.setAfterLocked(inventory.getLockedStock() - quantity);</span><br><span class="line">            inventoryLog.setBeforeTotal(inventory.getTotalStock());</span><br><span class="line">            inventoryLog.setAfterTotal(inventory.getTotalStock() - quantity);</span><br><span class="line">            inventoryLog.setRemark(&quot;è®¢å•æ‰£å‡åº“å­˜&quot;);</span><br><span class="line">            inventoryLogService.save(inventoryLog);</span><br><span class="line">            </span><br><span class="line">            // æ›´æ–°Redisç¼“å­˜</span><br><span class="line">            updateInventoryCache(productId, inventory);</span><br><span class="line">            </span><br><span class="line">            log.info(&quot;æ‰£å‡åº“å­˜æˆåŠŸï¼Œå•†å“IDï¼š&#123;&#125;ï¼Œæ•°é‡ï¼š&#123;&#125;&quot;, productId, quantity);</span><br><span class="line">            return true;</span><br><span class="line">            </span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">            throw new BusinessException(ResultCode.SYSTEM_ERROR, &quot;ç³»ç»Ÿå¼‚å¸¸&quot;);</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            if (lock.isHeldByCurrentThread()) &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    @Transactional(rollbackFor = Exception.class)</span><br><span class="line">    public boolean releaseLockedInventory(Long productId, Integer quantity) &#123;</span><br><span class="line">        log.info(&quot;é‡Šæ”¾é”å®šåº“å­˜ï¼Œå•†å“IDï¼š&#123;&#125;ï¼Œæ•°é‡ï¼š&#123;&#125;&quot;, productId, quantity);</span><br><span class="line">        </span><br><span class="line">        String lockKey = INVENTORY_LOCK_PREFIX + productId;</span><br><span class="line">        RLock lock = redissonClient.getLock(lockKey);</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            boolean locked = lock.tryLock(5, 10, TimeUnit.SECONDS);</span><br><span class="line">            if (!locked) &#123;</span><br><span class="line">                throw new BusinessException(ResultCode.SYSTEM_ERROR, &quot;ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            Inventory inventory = getByProductId(productId);</span><br><span class="line">            if (inventory == null) &#123;</span><br><span class="line">                throw new BusinessException(ResultCode.RESOURCE_NOT_FOUND, &quot;å•†å“åº“å­˜ä¸å­˜åœ¨&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // æ£€æŸ¥é”å®šåº“å­˜æ˜¯å¦è¶³å¤Ÿé‡Šæ”¾</span><br><span class="line">            if (inventory.getLockedStock() &lt; quantity) &#123;</span><br><span class="line">                // å¦‚æœé”å®šåº“å­˜ä¸è¶³ï¼Œåˆ™é‡Šæ”¾å…¨éƒ¨é”å®šåº“å­˜</span><br><span class="line">                quantity = inventory.getLockedStock();</span><br><span class="line">                if (quantity == 0) &#123;</span><br><span class="line">                    log.info(&quot;é”å®šåº“å­˜å·²ä¸º0ï¼Œæ— éœ€é‡Šæ”¾ï¼Œå•†å“IDï¼š&#123;&#125;&quot;, productId);</span><br><span class="line">                    return true;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // é‡Šæ”¾é”å®šåº“å­˜ï¼ˆå¢åŠ å¯ç”¨åº“å­˜ï¼Œå‡å°‘é”å®šåº“å­˜ï¼‰</span><br><span class="line">            int updateCount = inventoryMapper.releaseStock(productId, quantity);</span><br><span class="line">            if (updateCount &lt;= 0) &#123;</span><br><span class="line">                throw new BusinessException(ResultCode.SYSTEM_ERROR, &quot;é‡Šæ”¾é”å®šåº“å­˜å¤±è´¥&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // è®°å½•åº“å­˜æµæ°´</span><br><span class="line">            InventoryLog inventoryLog = new InventoryLog();</span><br><span class="line">            inventoryLog.setProductId(productId);</span><br><span class="line">            inventoryLog.setChangeType(3); // é‡Šæ”¾</span><br><span class="line">            inventoryLog.setChangeQuantity(quantity);</span><br><span class="line">            inventoryLog.setBeforeAvailable(inventory.getAvailableStock());</span><br><span class="line">            inventoryLog.setAfterAvailable(inventory.getAvailableStock() + quantity);</span><br><span class="line">            inventoryLog.setBeforeLocked(inventory.getLockedStock());</span><br><span class="line">            inventoryLog.setAfterLocked(inventory.getLockedStock() - quantity);</span><br><span class="line">            inventoryLog.setBeforeTotal(inventory.getTotalStock());</span><br><span class="line">            inventoryLog.setAfterTotal(inventory.getTotalStock());</span><br><span class="line">            inventoryLog.setRemark(&quot;è®¢å•å–æ¶ˆï¼Œé‡Šæ”¾é”å®šåº“å­˜&quot;);</span><br><span class="line">            inventoryLogService.save(inventoryLog);</span><br><span class="line">            </span><br><span class="line">            updateInventoryCache(productId, inventory);</span><br><span class="line">            </span><br><span class="line">            log.info(&quot;é‡Šæ”¾é”å®šåº“å­˜æˆåŠŸï¼Œå•†å“IDï¼š&#123;&#125;ï¼Œæ•°é‡ï¼š&#123;&#125;&quot;, productId, quantity);</span><br><span class="line">            return true;</span><br><span class="line">            </span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">            throw new BusinessException(ResultCode.SYSTEM_ERROR, &quot;ç³»ç»Ÿå¼‚å¸¸&quot;);</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            if (lock.isHeldByCurrentThread()) &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public Inventory getByProductId(Long productId) &#123;</span><br><span class="line">        QueryWrapper&lt;Inventory&gt; wrapper = new QueryWrapper&lt;&gt;();</span><br><span class="line">        wrapper.eq(&quot;product_id&quot;, productId);</span><br><span class="line">        wrapper.eq(&quot;is_deleted&quot;, 0);</span><br><span class="line">        return getOne(wrapper);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public Integer getAvailableStock(Long productId) &#123;</span><br><span class="line">        // å…ˆå°è¯•ä»ç¼“å­˜è·å–</span><br><span class="line">        String cacheKey = INVENTORY_STOCK_PREFIX + productId;</span><br><span class="line">        Object cacheValue = redisTemplate.opsForValue().get(cacheKey);</span><br><span class="line">        if (cacheValue != null) &#123;</span><br><span class="line">            return (Integer) cacheValue;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // ç¼“å­˜æ²¡æœ‰åˆ™æŸ¥è¯¢æ•°æ®åº“</span><br><span class="line">        Inventory inventory = getByProductId(productId);</span><br><span class="line">        if (inventory == null) &#123;</span><br><span class="line">            return 0;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // æ›´æ–°ç¼“å­˜</span><br><span class="line">        redisTemplate.opsForValue().set(cacheKey, inventory.getAvailableStock(), 5, TimeUnit.MINUTES);</span><br><span class="line">        </span><br><span class="line">        return inventory.getAvailableStock();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ›´æ–°åº“å­˜ç¼“å­˜</span><br><span class="line">     */</span><br><span class="line">    private void updateInventoryCache(Long productId, Inventory inventory) &#123;</span><br><span class="line">        String cacheKey = INVENTORY_STOCK_PREFIX + productId;</span><br><span class="line">        redisTemplate.opsForValue().set(cacheKey, inventory.getAvailableStock(), 5, TimeUnit.MINUTES);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// InventoryMapper.java</span><br><span class="line">public interface InventoryMapper extends BaseMapper&lt;Inventory&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * é”å®šåº“å­˜</span><br><span class="line">     */</span><br><span class="line">    @Update(&quot;UPDATE inventory SET available_stock = available_stock - #&#123;quantity&#125;, &quot; +</span><br><span class="line">            &quot;locked_stock = locked_stock + #&#123;quantity&#125;, update_time = NOW() &quot; +</span><br><span class="line">            &quot;WHERE product_id = #&#123;productId&#125; AND available_stock &gt;= #&#123;quantity&#125;&quot;)</span><br><span class="line">    int lockStock(@Param(&quot;productId&quot;) Long productId, @Param(&quot;quantity&quot;) Integer quantity);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ‰£å‡åº“å­˜</span><br><span class="line">     */</span><br><span class="line">    @Update(&quot;UPDATE inventory SET locked_stock = locked_stock - #&#123;quantity&#125;, &quot; +</span><br><span class="line">            &quot;total_stock = total_stock - #&#123;quantity&#125;, update_time = NOW() &quot; +</span><br><span class="line">            &quot;WHERE product_id = #&#123;productId&#125; AND locked_stock &gt;= #&#123;quantity&#125;&quot;)</span><br><span class="line">    int deductStock(@Param(&quot;productId&quot;) Long productId, @Param(&quot;quantity&quot;) Integer quantity);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * é‡Šæ”¾é”å®šåº“å­˜</span><br><span class="line">     */</span><br><span class="line">    @Update(&quot;UPDATE inventory SET available_stock = available_stock + #&#123;quantity&#125;, &quot; +</span><br><span class="line">            &quot;locked_stock = locked_stock - #&#123;quantity&#125;, update_time = NOW() &quot; +</span><br><span class="line">            &quot;WHERE product_id = #&#123;productId&#125; AND locked_stock &gt;= #&#123;quantity&#125;&quot;)</span><br><span class="line">    int releaseStock(@Param(&quot;productId&quot;) Long productId, @Param(&quot;quantity&quot;) Integer quantity);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å¢åŠ åº“å­˜</span><br><span class="line">     */</span><br><span class="line">    @Update(&quot;UPDATE inventory SET total_stock = total_stock + #&#123;quantity&#125;, &quot; +</span><br><span class="line">            &quot;available_stock = available_stock + #&#123;quantity&#125;, update_time = NOW() &quot; +</span><br><span class="line">            &quot;WHERE product_id = #&#123;productId&#125;&quot;)</span><br><span class="line">    int increaseStock(@Param(&quot;productId&quot;) Long productId, @Param(&quot;quantity&quot;) Integer quantity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±å®Œæˆäº†åº“å­˜æœåŠ¡çš„åŸºæœ¬å®ç°ï¼Œä¿è¯äº†åœ¨å¹¶å‘åœºæ™¯ä¸‹åº“å­˜æ“ä½œçš„å®‰å…¨æ€§ã€‚</p><h2 id="2-è®¢å•è¶…æ—¶è‡ªåŠ¨å–æ¶ˆ"><a href="#2-è®¢å•è¶…æ—¶è‡ªåŠ¨å–æ¶ˆ" class="headerlink" title="2. è®¢å•è¶…æ—¶è‡ªåŠ¨å–æ¶ˆ"></a>2. è®¢å•è¶…æ—¶è‡ªåŠ¨å–æ¶ˆ</h2><p>è®¢å•è¶…æ—¶è‡ªåŠ¨å–æ¶ˆæ˜¯ç”µå•†ç³»ç»Ÿçš„å¸¸è§éœ€æ±‚ã€‚æˆ‘ä»¬å°†ä½¿ç”¨å®šæ—¶ä»»åŠ¡å’Œå»¶è¿Ÿé˜Ÿåˆ—ä¸¤ç§æ–¹å¼æ¥å®ç°ã€‚</p><h3 id="2-1-å®šæ—¶ä»»åŠ¡å®ç°"><a href="#2-1-å®šæ—¶ä»»åŠ¡å®ç°" class="headerlink" title="2.1 å®šæ—¶ä»»åŠ¡å®ç°"></a>2.1 å®šæ—¶ä»»åŠ¡å®ç°</h3><p>åœ¨è®¢å•æœåŠ¡ä¸­ï¼Œæˆ‘ä»¬å·²ç»æœ‰äº†ä¸€ä¸ªå®šæ—¶ä»»åŠ¡æ–¹æ³•<code>handleTimeoutOrders</code>ï¼Œå®ƒæ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼ŒæŸ¥è¯¢åˆ›å»ºæ—¶é—´è¶…è¿‡30åˆ†é’Ÿä¸”æœªæ”¯ä»˜çš„è®¢å•ï¼Œç„¶åå–æ¶ˆå®ƒä»¬ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬ä¼˜åŒ–ä¸€ä¸‹ï¼Œä½¿ç”¨åˆ†é¡µæŸ¥è¯¢ï¼Œé¿å…ä¸€æ¬¡æŸ¥è¯¢è¿‡å¤šæ•°æ®ã€‚</p><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">@Scheduled(cron = &quot;0 */5 * * * ?&quot;) // æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡</span><br><span class="line">public void handleTimeoutOrders() &#123;</span><br><span class="line">    log.info(&quot;å¼€å§‹å¤„ç†è¶…æ—¶è®¢å•&quot;);</span><br><span class="line">    </span><br><span class="line">    int pageNum = 1;</span><br><span class="line">    int pageSize = 100;</span><br><span class="line">    boolean hasNext = true;</span><br><span class="line">    </span><br><span class="line">    while (hasNext) &#123;</span><br><span class="line">        // æŸ¥è¯¢è¶…æ—¶æœªæ”¯ä»˜çš„è®¢å•</span><br><span class="line">        LocalDateTime timeoutTime = LocalDateTime.now().minusMinutes(30);</span><br><span class="line">        Page&lt;Order&gt; page = new Page&lt;&gt;(pageNum, pageSize);</span><br><span class="line">        </span><br><span class="line">        QueryWrapper&lt;Order&gt; wrapper = new QueryWrapper&lt;&gt;();</span><br><span class="line">        wrapper.eq(&quot;status&quot;, OrderState.CREATED.getCode());</span><br><span class="line">        wrapper.le(&quot;create_time&quot;, timeoutTime);</span><br><span class="line">        wrapper.eq(&quot;is_deleted&quot;, 0);</span><br><span class="line">        wrapper.orderByAsc(&quot;create_time&quot;); // æŒ‰åˆ›å»ºæ—¶é—´å‡åºï¼Œå…ˆå¤„ç†æœ€æ—©çš„è®¢å•</span><br><span class="line">        </span><br><span class="line">        Page&lt;Order&gt; orderPage = page(page, wrapper);</span><br><span class="line">        List&lt;Order&gt; timeoutOrders = orderPage.getRecords();</span><br><span class="line">        </span><br><span class="line">        for (Order order : timeoutOrders) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                log.info(&quot;è‡ªåŠ¨å–æ¶ˆè¶…æ—¶è®¢å•ï¼Œè®¢å•å·ï¼š&#123;&#125;&quot;, order.getOrderNo());</span><br><span class="line">                cancelOrder(order.getId(), order.getUserId(), &quot;è¶…æ—¶æœªæ”¯ä»˜ï¼Œç³»ç»Ÿè‡ªåŠ¨å–æ¶ˆ&quot;);</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                log.error(&quot;å–æ¶ˆè¶…æ—¶è®¢å•å¤±è´¥ï¼Œè®¢å•å·ï¼š&#123;&#125;&quot;, order.getOrderNo(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        hasNext = orderPage.hasNext();</span><br><span class="line">        pageNum++;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    log.info(&quot;è¶…æ—¶è®¢å•å¤„ç†å®Œæˆ&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-2-å»¶è¿Ÿé˜Ÿåˆ—å®ç°"><a href="#2-2-å»¶è¿Ÿé˜Ÿåˆ—å®ç°" class="headerlink" title="2.2 å»¶è¿Ÿé˜Ÿåˆ—å®ç°"></a>2.2 å»¶è¿Ÿé˜Ÿåˆ—å®ç°</h3><p>é™¤äº†å®šæ—¶ä»»åŠ¡ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨å»¶è¿Ÿé˜Ÿåˆ—æ¥å®ç°æ›´ç²¾ç¡®çš„è¶…æ—¶å–æ¶ˆã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨Redisçš„ZSetï¼ˆæœ‰åºé›†åˆï¼‰æ¥å®ç°å»¶è¿Ÿé˜Ÿåˆ—ã€‚</p><p><strong>Rediså»¶è¿Ÿé˜Ÿåˆ—å®ç°ï¼š</strong></p><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">@Slf4j</span><br><span class="line">public class RedisDelayQueue &#123;</span><br><span class="line">    </span><br><span class="line">    private static final String ORDER_TIMEOUT_QUEUE = &quot;order:timeout:queue&quot;;</span><br><span class="line">    </span><br><span class="line">    @Autowired</span><br><span class="line">    private RedisTemplate&lt;String, String&gt; redisTemplate;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ·»åŠ è®¢å•åˆ°å»¶è¿Ÿé˜Ÿåˆ—</span><br><span class="line">     * @param orderNo è®¢å•å·</span><br><span class="line">     * @param delaySeconds å»¶è¿Ÿæ—¶é—´ï¼ˆç§’ï¼‰</span><br><span class="line">     */</span><br><span class="line">    public void addOrder(String orderNo, long delaySeconds) &#123;</span><br><span class="line">        long score = System.currentTimeMillis() + delaySeconds * 1000;</span><br><span class="line">        redisTemplate.opsForZSet().add(ORDER_TIMEOUT_QUEUE, orderNo, score);</span><br><span class="line">        log.info(&quot;æ·»åŠ è®¢å•åˆ°å»¶è¿Ÿé˜Ÿåˆ—ï¼Œè®¢å•å·ï¼š&#123;&#125;ï¼Œå»¶è¿Ÿæ—¶é—´ï¼š&#123;&#125;ç§’&quot;, orderNo, delaySeconds);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * ä»å»¶è¿Ÿé˜Ÿåˆ—ç§»é™¤è®¢å•</span><br><span class="line">     * @param orderNo è®¢å•å·</span><br><span class="line">     */</span><br><span class="line">    public void removeOrder(String orderNo) &#123;</span><br><span class="line">        redisTemplate.opsForZSet().remove(ORDER_TIMEOUT_QUEUE, orderNo);</span><br><span class="line">        log.info(&quot;ä»å»¶è¿Ÿé˜Ÿåˆ—ç§»é™¤è®¢å•ï¼Œè®¢å•å·ï¼š&#123;&#125;&quot;, orderNo);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è·å–å·²åˆ°æœŸçš„è®¢å•</span><br><span class="line">     * @return è®¢å•å·åˆ—è¡¨</span><br><span class="line">     */</span><br><span class="line">    public List&lt;String&gt; getExpiredOrders() &#123;</span><br><span class="line">        long maxScore = System.currentTimeMillis();</span><br><span class="line">        Set&lt;String&gt; orderSet = redisTemplate.opsForZSet().rangeByScore(ORDER_TIMEOUT_QUEUE, 0, maxScore);</span><br><span class="line">        return new ArrayList&lt;&gt;(orderSet);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å¤„ç†å·²åˆ°æœŸçš„è®¢å•</span><br><span class="line">     */</span><br><span class="line">    public void processExpiredOrders() &#123;</span><br><span class="line">        List&lt;String&gt; expiredOrders = getExpiredOrders();</span><br><span class="line">        for (String orderNo : expiredOrders) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                // ä»é˜Ÿåˆ—ä¸­ç§»é™¤</span><br><span class="line">                removeOrder(orderNo);</span><br><span class="line">                </span><br><span class="line">                // å¤„ç†è®¢å•è¶…æ—¶é€»è¾‘</span><br><span class="line">                // è¿™é‡Œå¯ä»¥å‘é€æ¶ˆæ¯æˆ–è€…è°ƒç”¨è®¢å•æœåŠ¡çš„æ–¹æ³•</span><br><span class="line">                log.info(&quot;å¤„ç†å»¶è¿Ÿé˜Ÿåˆ—ä¸­çš„è¶…æ—¶è®¢å•ï¼Œè®¢å•å·ï¼š&#123;&#125;&quot;, orderNo);</span><br><span class="line">                </span><br><span class="line">                // å‘é€è®¢å•è¶…æ—¶æ¶ˆæ¯</span><br><span class="line">                sendOrderTimeoutMessage(orderNo);</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                log.error(&quot;å¤„ç†å»¶è¿Ÿé˜Ÿåˆ—è®¢å•å¤±è´¥ï¼Œè®¢å•å·ï¼š&#123;&#125;&quot;, orderNo, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å‘é€è®¢å•è¶…æ—¶æ¶ˆæ¯</span><br><span class="line">     */</span><br><span class="line">    private void sendOrderTimeoutMessage(String orderNo) &#123;</span><br><span class="line">        // ä½¿ç”¨RocketMQå‘é€æ¶ˆæ¯</span><br><span class="line">        try &#123;</span><br><span class="line">            OrderTimeoutMessage message = new OrderTimeoutMessage();</span><br><span class="line">            message.setOrderNo(orderNo);</span><br><span class="line">            message.setTimeoutTime(LocalDateTime.now());</span><br><span class="line">            </span><br><span class="line">            rocketMQTemplate.syncSend(</span><br><span class="line">                &quot;ORDER_TOPIC:ORDER_TIMEOUT&quot;,</span><br><span class="line">                MessageBuilder.withPayload(message).build()</span><br><span class="line">            );</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;å‘é€è®¢å•è¶…æ—¶æ¶ˆæ¯å¤±è´¥ï¼Œè®¢å•å·ï¼š&#123;&#125;&quot;, orderNo, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åï¼Œæˆ‘ä»¬åœ¨è®¢å•åˆ›å»ºæ—¶ï¼Œå°†è®¢å•æ·»åŠ åˆ°å»¶è¿Ÿé˜Ÿåˆ—ï¼š</p><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">private void scheduleOrderTimeout(Long orderId, String orderNo) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        // ä½¿ç”¨Rediså»¶è¿Ÿé˜Ÿåˆ—ï¼Œ30åˆ†é’Ÿè¶…æ—¶</span><br><span class="line">        redisDelayQueue.addOrder(orderNo, 30 * 60);</span><br><span class="line">        log.info(&quot;æ·»åŠ è®¢å•åˆ°å»¶è¿Ÿé˜Ÿåˆ—ï¼Œè®¢å•å·ï¼š&#123;&#125;&quot;, orderNo);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        log.error(&quot;æ·»åŠ è®¢å•åˆ°å»¶è¿Ÿé˜Ÿåˆ—å¤±è´¥ï¼Œè®¢å•å·ï¼š&#123;&#125;&quot;, orderNo, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è®¢å•æ”¯ä»˜æˆåŠŸæ—¶ï¼Œä»å»¶è¿Ÿé˜Ÿåˆ—ä¸­ç§»é™¤ï¼š</p><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">private void cancelOrderTimeout(String orderNo) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        redisDelayQueue.removeOrder(orderNo);</span><br><span class="line">        log.info(&quot;ä»å»¶è¿Ÿé˜Ÿåˆ—ç§»é™¤è®¢å•ï¼Œè®¢å•å·ï¼š&#123;&#125;&quot;, orderNo);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        log.error(&quot;ä»å»¶è¿Ÿé˜Ÿåˆ—ç§»é™¤è®¢å•å¤±è´¥ï¼Œè®¢å•å·ï¼š&#123;&#125;&quot;, orderNo, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå®šæ—¶ä»»åŠ¡æ¥å¤„ç†å»¶è¿Ÿé˜Ÿåˆ—ä¸­çš„è¶…æ—¶è®¢å•ï¼š</p><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class DelayQueueTask &#123;</span><br><span class="line">    </span><br><span class="line">    @Autowired</span><br><span class="line">    private RedisDelayQueue redisDelayQueue;</span><br><span class="line">    </span><br><span class="line">    @Scheduled(fixedDelay = 5000) // æ¯5ç§’æ‰§è¡Œä¸€æ¬¡</span><br><span class="line">    public void processDelayQueue() &#123;</span><br><span class="line">        redisDelayQueue.processExpiredOrders();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±å®ç°äº†ä¸¤ç§è®¢å•è¶…æ—¶è‡ªåŠ¨å–æ¶ˆçš„æ–¹å¼ï¼šå®šæ—¶ä»»åŠ¡å’Œå»¶è¿Ÿé˜Ÿåˆ—ã€‚å»¶è¿Ÿé˜Ÿåˆ—çš„ç²¾åº¦æ›´é«˜ï¼Œä½†å®ç°ä¹Ÿç›¸å¯¹å¤æ‚ã€‚</p><h2 id="3-è®¢å•åˆ†åº“åˆ†è¡¨æŸ¥è¯¢"><a href="#3-è®¢å•åˆ†åº“åˆ†è¡¨æŸ¥è¯¢" class="headerlink" title="3. è®¢å•åˆ†åº“åˆ†è¡¨æŸ¥è¯¢"></a>3. è®¢å•åˆ†åº“åˆ†è¡¨æŸ¥è¯¢</h2><p>éšç€è®¢å•é‡çš„å¢é•¿ï¼Œå•è¡¨å­˜å‚¨è®¢å•æ•°æ®ä¼šé¢ä¸´æ€§èƒ½ç“¶é¢ˆã€‚æˆ‘ä»¬éœ€è¦å¯¹è®¢å•è¡¨è¿›è¡Œåˆ†åº“åˆ†è¡¨ã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ShardingSphereæ¥å®ç°ã€‚</p><h3 id="3-1-ShardingSphereé…ç½®"><a href="#3-1-ShardingSphereé…ç½®" class="headerlink" title="3.1 ShardingSphereé…ç½®"></a>3.1 ShardingSphereé…ç½®</h3><p>é¦–å…ˆï¼Œåœ¨è®¢å•æœåŠ¡ä¸­å¼•å…¥ShardingSphereçš„ä¾èµ–ï¼š</p><p>xml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.shardingsphere&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;sharding-jdbc-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;4.1.1&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><p>ç„¶åï¼Œåœ¨application.ymlä¸­é…ç½®åˆ†åº“åˆ†è¡¨è§„åˆ™ï¼š</p><p>yaml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  shardingsphere:</span><br><span class="line">    datasource:</span><br><span class="line">      names: ds0,ds1</span><br><span class="line">      ds0:</span><br><span class="line">        type: com.zaxxer.hikari.HikariDataSource</span><br><span class="line">        driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="line">        jdbc-url: jdbc:mysql://localhost:3306/order_db_0?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=Asia/Shanghai&amp;useSSL=false</span><br><span class="line">        username: root</span><br><span class="line">        password: root123</span><br><span class="line">      ds1:</span><br><span class="line">        type: com.zaxxer.hikari.HikariDataSource</span><br><span class="line">        driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="line">        jdbc-url: jdbc:mysql://localhost:3306/order_db_1?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=Asia/Shanghai&amp;useSSL=false</span><br><span class="line">        username: root</span><br><span class="line">        password: root123</span><br><span class="line">    </span><br><span class="line">    sharding:</span><br><span class="line">      tables:</span><br><span class="line">        order:</span><br><span class="line">          actual-data-nodes: ds$-&gt;&#123;0..1&#125;.order_$-&gt;&#123;202401..202412&#125;</span><br><span class="line">          table-strategy:</span><br><span class="line">            standard:</span><br><span class="line">              sharding-column: create_time</span><br><span class="line">              precise-algorithm-class-name: com.shophub.order.sharding.OrderTableShardingAlgorithm</span><br><span class="line">          key-generator:</span><br><span class="line">            column: id</span><br><span class="line">            type: SNOWFLAKE</span><br><span class="line">        order_item:</span><br><span class="line">          actual-data-nodes: ds$-&gt;&#123;0..1&#125;.order_item</span><br><span class="line">          database-strategy:</span><br><span class="line">            standard:</span><br><span class="line">              sharding-column: order_id</span><br><span class="line">              precise-algorithm-class-name: com.shophub.order.sharding.OrderDatabaseShardingAlgorithm</span><br><span class="line">          key-generator:</span><br><span class="line">            column: id</span><br><span class="line">            type: SNOWFLAKE</span><br><span class="line">      </span><br><span class="line">      binding-tables:</span><br><span class="line">        - order,order_item</span><br><span class="line">      </span><br><span class="line">      broadcast-tables:</span><br><span class="line">        - order_operation_log</span><br><span class="line">      </span><br><span class="line">      default-database-strategy:</span><br><span class="line">        standard:</span><br><span class="line">          sharding-column: user_id</span><br><span class="line">          precise-algorithm-class-name: com.shophub.order.sharding.OrderDatabaseShardingAlgorithm</span><br><span class="line">    </span><br><span class="line">    props:</span><br><span class="line">      sql:</span><br><span class="line">        show: true</span><br></pre></td></tr></table></figure><h3 id="3-2-åˆ†åº“åˆ†è¡¨ç®—æ³•"><a href="#3-2-åˆ†åº“åˆ†è¡¨ç®—æ³•" class="headerlink" title="3.2 åˆ†åº“åˆ†è¡¨ç®—æ³•"></a>3.2 åˆ†åº“åˆ†è¡¨ç®—æ³•</h3><p>æˆ‘ä»¬éœ€è¦å®ç°åˆ†åº“åˆ†è¡¨ç®—æ³•ã€‚è¿™é‡Œæˆ‘ä»¬æ ¹æ®ç”¨æˆ·IDåˆ†åº“ï¼Œæ ¹æ®åˆ›å»ºæ—¶é—´åˆ†è¡¨ã€‚</p><p><strong>åˆ†åº“ç®—æ³•ï¼ˆæ ¹æ®ç”¨æˆ·IDï¼‰ï¼š</strong></p><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.order.sharding;</span><br><span class="line"></span><br><span class="line">import org.apache.shardingsphere.api.sharding.standard.PreciseShardingAlgorithm;</span><br><span class="line">import org.apache.shardingsphere.api.sharding.standard.PreciseShardingValue;</span><br><span class="line"></span><br><span class="line">import java.util.Collection;</span><br><span class="line"></span><br><span class="line">public class OrderDatabaseShardingAlgorithm implements PreciseShardingAlgorithm&lt;Long&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public String doSharding(Collection&lt;String&gt; databaseNames, PreciseShardingValue&lt;Long&gt; shardingValue) &#123;</span><br><span class="line">        // æ ¹æ®ç”¨æˆ·IDåˆ†åº“ï¼Œå‡è®¾ç”¨æˆ·IDä¸ºLongç±»å‹</span><br><span class="line">        Long userId = shardingValue.getValue();</span><br><span class="line">        int databaseIndex = (int) (userId % databaseNames.size());</span><br><span class="line">        </span><br><span class="line">        for (String databaseName : databaseNames) &#123;</span><br><span class="line">            if (databaseName.endsWith(String.valueOf(databaseIndex))) &#123;</span><br><span class="line">                return databaseName;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        throw new IllegalArgumentException(&quot;æœªæ‰¾åˆ°å¯¹åº”çš„æ•°æ®åº“&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>åˆ†è¡¨ç®—æ³•ï¼ˆæ ¹æ®åˆ›å»ºæ—¶é—´ï¼‰ï¼š</strong></p><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.order.sharding;</span><br><span class="line"></span><br><span class="line">import org.apache.shardingsphere.api.sharding.standard.PreciseShardingAlgorithm;</span><br><span class="line">import org.apache.shardingsphere.api.sharding.standard.PreciseShardingValue;</span><br><span class="line"></span><br><span class="line">import java.time.LocalDateTime;</span><br><span class="line">import java.time.format.DateTimeFormatter;</span><br><span class="line">import java.util.Collection;</span><br><span class="line"></span><br><span class="line">public class OrderTableShardingAlgorithm implements PreciseShardingAlgorithm&lt;LocalDateTime&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public String doSharding(Collection&lt;String&gt; tableNames, PreciseShardingValue&lt;LocalDateTime&gt; shardingValue) &#123;</span><br><span class="line">        // æ ¹æ®åˆ›å»ºæ—¶é—´åˆ†è¡¨ï¼Œè¡¨åæ ¼å¼ä¸ºorder_yyyyMM</span><br><span class="line">        LocalDateTime createTime = shardingValue.getValue();</span><br><span class="line">        String tableSuffix = createTime.format(DateTimeFormatter.ofPattern(&quot;yyyyMM&quot;));</span><br><span class="line">        String targetTable = shardingValue.getLogicTableName() + &quot;_&quot; + tableSuffix;</span><br><span class="line">        </span><br><span class="line">        if (tableNames.contains(targetTable)) &#123;</span><br><span class="line">            return targetTable;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        throw new IllegalArgumentException(&quot;æœªæ‰¾åˆ°å¯¹åº”çš„è¡¨: &quot; + targetTable);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-3-åˆ†åº“åˆ†è¡¨æŸ¥è¯¢ä¼˜åŒ–"><a href="#3-3-åˆ†åº“åˆ†è¡¨æŸ¥è¯¢ä¼˜åŒ–" class="headerlink" title="3.3 åˆ†åº“åˆ†è¡¨æŸ¥è¯¢ä¼˜åŒ–"></a>3.3 åˆ†åº“åˆ†è¡¨æŸ¥è¯¢ä¼˜åŒ–</h3><p>åœ¨åˆ†åº“åˆ†è¡¨åï¼ŒæŸ¥è¯¢è®¢å•åˆ—è¡¨éœ€è¦è·¨å¤šä¸ªè¡¨æŸ¥è¯¢ã€‚ShardingSphereæ”¯æŒè·¨è¡¨æŸ¥è¯¢ï¼Œä½†ä¸ºäº†æ€§èƒ½ï¼Œæˆ‘ä»¬åº”å°½é‡é¿å…è·¨å¤ªå¤šè¡¨ã€‚</p><p>åœ¨æŸ¥è¯¢è®¢å•åˆ—è¡¨æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®æ—¶é—´èŒƒå›´æ¥åŠ¨æ€é€‰æ‹©è¡¨ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæŸ¥è¯¢æœ€è¿‘ä¸€ä¸ªæœˆçš„è®¢å•ï¼Œæˆ‘ä»¬åªéœ€è¦æŸ¥è¯¢æœ€è¿‘çš„ä¸€å¼ è¡¨ã€‚</p><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public PageResult&lt;OrderVo&gt; getOrderPage(OrderQueryRequest request, Long userId) &#123;</span><br><span class="line">    // å¦‚æœæŸ¥è¯¢æ¡ä»¶ä¸­åŒ…å«äº†æ—¶é—´èŒƒå›´ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®æ—¶é—´èŒƒå›´æ¥ç¡®å®šæŸ¥è¯¢å“ªäº›è¡¨</span><br><span class="line">    // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œä½¿ç”¨ShardingSphereçš„è·¯ç”±åŠŸèƒ½</span><br><span class="line">    </span><br><span class="line">    // è®¾ç½®åˆ†é¡µ</span><br><span class="line">    Page&lt;Order&gt; page = new Page&lt;&gt;(request.getPageNum(), request.getPageSize());</span><br><span class="line">    </span><br><span class="line">    // æ„å»ºæŸ¥è¯¢æ¡ä»¶</span><br><span class="line">    QueryWrapper&lt;Order&gt; wrapper = new QueryWrapper&lt;&gt;();</span><br><span class="line">    wrapper.eq(&quot;user_id&quot;, userId);</span><br><span class="line">    wrapper.eq(&quot;is_deleted&quot;, 0);</span><br><span class="line">    </span><br><span class="line">    if (request.getStatus() != null) &#123;</span><br><span class="line">        wrapper.eq(&quot;status&quot;, request.getStatus());</span><br><span class="line">    &#125;</span><br><span class="line">    if (StringUtils.isNotBlank(request.getOrderNo())) &#123;</span><br><span class="line">        wrapper.eq(&quot;order_no&quot;, request.getOrderNo());</span><br><span class="line">    &#125;</span><br><span class="line">    if (StringUtils.isNotBlank(request.getReceiverName())) &#123;</span><br><span class="line">        wrapper.like(&quot;receiver_name&quot;, request.getReceiverName());</span><br><span class="line">    &#125;</span><br><span class="line">    if (StringUtils.isNotBlank(request.getReceiverPhone())) &#123;</span><br><span class="line">        wrapper.like(&quot;receiver_phone&quot;, request.getReceiverPhone());</span><br><span class="line">    &#125;</span><br><span class="line">    if (request.getStartTime() != null) &#123;</span><br><span class="line">        wrapper.ge(&quot;create_time&quot;, request.getStartTime());</span><br><span class="line">    &#125;</span><br><span class="line">    if (request.getEndTime() != null) &#123;</span><br><span class="line">        wrapper.le(&quot;create_time&quot;, request.getEndTime());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // æ’åº</span><br><span class="line">    wrapper.orderBy(true, &quot;asc&quot;.equalsIgnoreCase(request.getSortOrder()), </span><br><span class="line">                   request.getSortBy());</span><br><span class="line">    </span><br><span class="line">    // æŸ¥è¯¢ï¼ŒShardingSphereä¼šè‡ªåŠ¨è·¯ç”±åˆ°å¯¹åº”çš„è¡¨</span><br><span class="line">    Page&lt;Order&gt; orderPage = page(page, wrapper);</span><br><span class="line">    </span><br><span class="line">    // è½¬æ¢ä¸ºVO</span><br><span class="line">    List&lt;OrderVo&gt; orderVos = orderPage.getRecords().stream()</span><br><span class="line">            .map(this::convertToVo)</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">    </span><br><span class="line">    // æŸ¥è¯¢è®¢å•å•†å“</span><br><span class="line">    for (OrderVo orderVo : orderVos) &#123;</span><br><span class="line">        List&lt;OrderItem&gt; items = orderItemService.getByOrderId(orderVo.getId());</span><br><span class="line">        orderVo.setOrderItems(convertToItemVos(items));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return new PageResult&lt;&gt;(</span><br><span class="line">            orderVos,</span><br><span class="line">            orderPage.getTotal(),</span><br><span class="line">            orderPage.getCurrent(),</span><br><span class="line">            orderPage.getSize()</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-è®¢å•é€€æ¬¾æµç¨‹"><a href="#4-è®¢å•é€€æ¬¾æµç¨‹" class="headerlink" title="4. è®¢å•é€€æ¬¾æµç¨‹"></a>4. è®¢å•é€€æ¬¾æµç¨‹</h2><p>è®¢å•é€€æ¬¾æ˜¯ä¸€ä¸ªå¤æ‚çš„ä¸šåŠ¡æµç¨‹ï¼Œéœ€è¦åè°ƒè®¢å•ã€åº“å­˜ã€æ”¯ä»˜ç­‰å¤šä¸ªæœåŠ¡ã€‚æˆ‘ä»¬ä½¿ç”¨çŠ¶æ€æœºå’Œåˆ†å¸ƒå¼äº‹åŠ¡æ¥ä¿è¯é€€æ¬¾æµç¨‹çš„ä¸€è‡´æ€§ã€‚</p><h3 id="4-1-é€€æ¬¾çŠ¶æ€æœº"><a href="#4-1-é€€æ¬¾çŠ¶æ€æœº" class="headerlink" title="4.1 é€€æ¬¾çŠ¶æ€æœº"></a>4.1 é€€æ¬¾çŠ¶æ€æœº</h3><p>æˆ‘ä»¬æ‰©å±•è®¢å•çŠ¶æ€æœºï¼Œå¢åŠ é€€æ¬¾ç›¸å…³çš„çŠ¶æ€å’Œäº‹ä»¶ã€‚</p><p><strong>é€€æ¬¾çŠ¶æ€ï¼š</strong></p><ul><li>é€€æ¬¾ç”³è¯·ä¸­</li><li>åŒæ„é€€æ¬¾</li><li>æ‹’ç»é€€æ¬¾</li><li>é€€æ¬¾æˆåŠŸ</li><li>é€€æ¬¾å¤±è´¥</li></ul><p><strong>é€€æ¬¾äº‹ä»¶ï¼š</strong></p><ul><li>ç”³è¯·é€€æ¬¾</li><li>åŒæ„é€€æ¬¾</li><li>æ‹’ç»é€€æ¬¾</li><li>é€€æ¬¾æˆåŠŸ</li><li>é€€æ¬¾å¤±è´¥</li></ul><h3 id="4-2-é€€æ¬¾æœåŠ¡å®ç°"><a href="#4-2-é€€æ¬¾æœåŠ¡å®ç°" class="headerlink" title="4.2 é€€æ¬¾æœåŠ¡å®ç°"></a>4.2 é€€æ¬¾æœåŠ¡å®ç°</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.order.service.impl;</span><br><span class="line"></span><br><span class="line">import com.shophub.order.entity.OrderRefund;</span><br><span class="line">import com.shophub.order.service.OrderRefundService;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line">import org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@Service</span><br><span class="line">public class OrderRefundServiceImpl implements OrderRefundService &#123;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    @Transactional(rollbackFor = Exception.class)</span><br><span class="line">    public boolean applyRefund(OrderRefund refund) &#123;</span><br><span class="line">        log.info(&quot;ç”³è¯·é€€æ¬¾ï¼Œè®¢å•IDï¼š&#123;&#125;ï¼Œé€€æ¬¾é‡‘é¢ï¼š&#123;&#125;&quot;, refund.getOrderId(), refund.getRefundAmount());</span><br><span class="line">        </span><br><span class="line">        // 1. æ ¡éªŒè®¢å•çŠ¶æ€æ˜¯å¦å…è®¸é€€æ¬¾</span><br><span class="line">        Order order = orderService.getById(refund.getOrderId());</span><br><span class="line">        if (!canRefund(order)) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.BUSINESS_ERROR, &quot;è®¢å•çŠ¶æ€ä¸å…è®¸é€€æ¬¾&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 2. ç”Ÿæˆé€€æ¬¾å•å·</span><br><span class="line">        String refundNo = generateRefundNo();</span><br><span class="line">        refund.setRefundNo(refundNo);</span><br><span class="line">        refund.setRefundStatus(0); // ç”³è¯·ä¸­</span><br><span class="line">        </span><br><span class="line">        // 3. ä¿å­˜é€€æ¬¾è®°å½•</span><br><span class="line">        boolean saveSuccess = save(refund);</span><br><span class="line">        if (!saveSuccess) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.SYSTEM_ERROR, &quot;ä¿å­˜é€€æ¬¾è®°å½•å¤±è´¥&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 4. æ›´æ–°è®¢å•çŠ¶æ€ä¸ºé€€æ¬¾ä¸­</span><br><span class="line">        order.setStatus(OrderState.REFUNDING.getCode());</span><br><span class="line">        orderService.updateById(order);</span><br><span class="line">        </span><br><span class="line">        // 5. è®°å½•æ“ä½œæ—¥å¿—</span><br><span class="line">        saveOperationLog(order, &quot;ç”³è¯·é€€æ¬¾&quot;, refund.getUserId());</span><br><span class="line">        </span><br><span class="line">        // 6. å‘é€é€€æ¬¾ç”³è¯·æ¶ˆæ¯</span><br><span class="line">        sendRefundApplyMessage(refund);</span><br><span class="line">        </span><br><span class="line">        log.info(&quot;é€€æ¬¾ç”³è¯·æˆåŠŸï¼Œé€€æ¬¾å•å·ï¼š&#123;&#125;&quot;, refundNo);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    @GlobalTransactional(timeoutMills = 60000, name = &quot;agree-refund-tx&quot;)</span><br><span class="line">    @Transactional(rollbackFor = Exception.class)</span><br><span class="line">    public boolean agreeRefund(Long refundId, Long operatorId) &#123;</span><br><span class="line">        log.info(&quot;åŒæ„é€€æ¬¾ï¼Œé€€æ¬¾IDï¼š&#123;&#125;ï¼Œæ“ä½œäººï¼š&#123;&#125;&quot;, refundId, operatorId);</span><br><span class="line">        </span><br><span class="line">        // 1. æŸ¥è¯¢é€€æ¬¾è®°å½•</span><br><span class="line">        OrderRefund refund = getById(refundId);</span><br><span class="line">        if (refund == null) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.RESOURCE_NOT_FOUND, &quot;é€€æ¬¾è®°å½•ä¸å­˜åœ¨&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 2. æ›´æ–°é€€æ¬¾çŠ¶æ€ä¸ºåŒæ„é€€æ¬¾</span><br><span class="line">        refund.setRefundStatus(1); // åŒæ„é€€æ¬¾</span><br><span class="line">        refund.setUpdateTime(LocalDateTime.now());</span><br><span class="line">        updateById(refund);</span><br><span class="line">        </span><br><span class="line">        // 3. è°ƒç”¨æ”¯ä»˜æœåŠ¡è¿›è¡Œé€€æ¬¾</span><br><span class="line">        boolean refundSuccess = callPaymentRefund(refund);</span><br><span class="line">        if (!refundSuccess) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.BUSINESS_ERROR, &quot;é€€æ¬¾å¤±è´¥&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 4. æ›´æ–°é€€æ¬¾çŠ¶æ€ä¸ºé€€æ¬¾æˆåŠŸ</span><br><span class="line">        refund.setRefundStatus(3); // é€€æ¬¾æˆåŠŸ</span><br><span class="line">        refund.setRefundTime(LocalDateTime.now());</span><br><span class="line">        updateById(refund);</span><br><span class="line">        </span><br><span class="line">        // 5. æ›´æ–°è®¢å•çŠ¶æ€ä¸ºå·²é€€æ¬¾</span><br><span class="line">        Order order = orderService.getById(refund.getOrderId());</span><br><span class="line">        order.setStatus(OrderState.REFUNDED.getCode());</span><br><span class="line">        orderService.updateById(order);</span><br><span class="line">        </span><br><span class="line">        // 6. å¦‚æœè®¢å•å·²å‘è´§ï¼Œéœ€è¦å¢åŠ åº“å­˜</span><br><span class="line">        if (order.getDeliveryTime() != null) &#123;</span><br><span class="line">            // å¢åŠ åº“å­˜</span><br><span class="line">            increaseInventory(order);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 7. è®°å½•æ“ä½œæ—¥å¿—</span><br><span class="line">        saveOperationLog(order, &quot;åŒæ„é€€æ¬¾&quot;, operatorId);</span><br><span class="line">        </span><br><span class="line">        // 8. å‘é€é€€æ¬¾æˆåŠŸæ¶ˆæ¯</span><br><span class="line">        sendRefundSuccessMessage(refund);</span><br><span class="line">        </span><br><span class="line">        log.info(&quot;åŒæ„é€€æ¬¾æˆåŠŸï¼Œé€€æ¬¾å•å·ï¼š&#123;&#125;&quot;, refund.getRefundNo());</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    @Transactional(rollbackFor = Exception.class)</span><br><span class="line">    public boolean rejectRefund(Long refundId, Long operatorId, String rejectReason) &#123;</span><br><span class="line">        log.info(&quot;æ‹’ç»é€€æ¬¾ï¼Œé€€æ¬¾IDï¼š&#123;&#125;ï¼Œæ“ä½œäººï¼š&#123;&#125;&quot;, refundId, operatorId);</span><br><span class="line">        </span><br><span class="line">        // 1. æŸ¥è¯¢é€€æ¬¾è®°å½•</span><br><span class="line">        OrderRefund refund = getById(refundId);</span><br><span class="line">        if (refund == null) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.RESOURCE_NOT_FOUND, &quot;é€€æ¬¾è®°å½•ä¸å­˜åœ¨&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 2. æ›´æ–°é€€æ¬¾çŠ¶æ€ä¸ºæ‹’ç»é€€æ¬¾</span><br><span class="line">        refund.setRefundStatus(2); // æ‹’ç»é€€æ¬¾</span><br><span class="line">        refund.setRefuseReason(rejectReason);</span><br><span class="line">        refund.setUpdateTime(LocalDateTime.now());</span><br><span class="line">        updateById(refund);</span><br><span class="line">        </span><br><span class="line">        // 3. æ›´æ–°è®¢å•çŠ¶æ€ä¸ºåŸçŠ¶æ€ï¼ˆæ ¹æ®è®¢å•æ˜¯å¦å‘è´§ï¼‰</span><br><span class="line">        Order order = orderService.getById(refund.getOrderId());</span><br><span class="line">        if (order.getDeliveryTime() != null) &#123;</span><br><span class="line">            order.setStatus(OrderState.SHIPPED.getCode()); // å·²å‘è´§</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            order.setStatus(OrderState.PAID.getCode()); // å·²æ”¯ä»˜</span><br><span class="line">        &#125;</span><br><span class="line">        orderService.updateById(order);</span><br><span class="line">        </span><br><span class="line">        // 4. è®°å½•æ“ä½œæ—¥å¿—</span><br><span class="line">        saveOperationLog(order, &quot;æ‹’ç»é€€æ¬¾&quot;, operatorId);</span><br><span class="line">        </span><br><span class="line">        // 5. å‘é€é€€æ¬¾æ‹’ç»æ¶ˆæ¯</span><br><span class="line">        sendRefundRejectMessage(refund);</span><br><span class="line">        </span><br><span class="line">        log.info(&quot;æ‹’ç»é€€æ¬¾æˆåŠŸï¼Œé€€æ¬¾å•å·ï¼š&#123;&#125;&quot;, refund.getRefundNo());</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆ¤æ–­è®¢å•æ˜¯å¦å¯ä»¥é€€æ¬¾</span><br><span class="line">     */</span><br><span class="line">    private boolean canRefund(Order order) &#123;</span><br><span class="line">        // å·²æ”¯ä»˜å’Œå·²å‘è´§çš„è®¢å•å¯ä»¥é€€æ¬¾</span><br><span class="line">        return OrderState.PAID.getCode().equals(order.getStatus()) || </span><br><span class="line">               OrderState.SHIPPED.getCode().equals(order.getStatus());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * ç”Ÿæˆé€€æ¬¾å•å·</span><br><span class="line">     */</span><br><span class="line">    private String generateRefundNo() &#123;</span><br><span class="line">        // æ ¼å¼ï¼šRF + å¹´æœˆæ—¥ + 6ä½éšæœºæ•°</span><br><span class="line">        String dateStr = LocalDateTime.now().format(DateTimeFormatter.ofPattern(&quot;yyyyMMdd&quot;));</span><br><span class="line">        String random = String.valueOf((int)((Math.random() * 9 + 1) * 100000));</span><br><span class="line">        return &quot;RF&quot; + dateStr + random;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è°ƒç”¨æ”¯ä»˜æœåŠ¡é€€æ¬¾</span><br><span class="line">     */</span><br><span class="line">    private boolean callPaymentRefund(OrderRefund refund) &#123;</span><br><span class="line">        // è°ƒç”¨æ”¯ä»˜æœåŠ¡çš„é€€æ¬¾æ¥å£</span><br><span class="line">        // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œç›´æ¥è¿”å›æˆåŠŸ</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å¢åŠ åº“å­˜</span><br><span class="line">     */</span><br><span class="line">    private void increaseInventory(Order order) &#123;</span><br><span class="line">        // æŸ¥è¯¢è®¢å•å•†å“</span><br><span class="line">        List&lt;OrderItem&gt; items = orderItemService.getByOrderId(order.getId());</span><br><span class="line">        for (OrderItem item : items) &#123;</span><br><span class="line">            inventoryService.increaseStock(item.getProductId(), item.getQuantity());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="5-è®¢å•æ•°æ®åŒæ­¥åˆ°ES"><a href="#5-è®¢å•æ•°æ®åŒæ­¥åˆ°ES" class="headerlink" title="5. è®¢å•æ•°æ®åŒæ­¥åˆ°ES"></a>5. è®¢å•æ•°æ®åŒæ­¥åˆ°ES</h2><p>ä¸ºäº†æä¾›æ›´å¥½çš„æœç´¢ä½“éªŒï¼Œæˆ‘ä»¬éœ€è¦å°†è®¢å•æ•°æ®åŒæ­¥åˆ°Elasticsearchä¸­ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Canalç›‘å¬MySQLçš„binlogï¼Œæˆ–è€…ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—æ¥åŒæ­¥æ•°æ®ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—çš„æ–¹å¼ï¼šåœ¨è®¢å•çŠ¶æ€å˜æ›´æ—¶ï¼Œå‘é€æ¶ˆæ¯åˆ°MQï¼Œç„¶åç”±æœç´¢æœåŠ¡æ¶ˆè´¹æ¶ˆæ¯ï¼Œæ›´æ–°ESä¸­çš„è®¢å•æ•°æ®ã€‚</p><h3 id="5-1-è®¢å•çŠ¶æ€å˜æ›´å‘é€æ¶ˆæ¯"><a href="#5-1-è®¢å•çŠ¶æ€å˜æ›´å‘é€æ¶ˆæ¯" class="headerlink" title="5.1 è®¢å•çŠ¶æ€å˜æ›´å‘é€æ¶ˆæ¯"></a>5.1 è®¢å•çŠ¶æ€å˜æ›´å‘é€æ¶ˆæ¯</h3><p>åœ¨è®¢å•æœåŠ¡ä¸­ï¼Œæ¯æ¬¡è®¢å•çŠ¶æ€å˜æ›´æ—¶ï¼Œå‘é€æ¶ˆæ¯åˆ°RocketMQã€‚</p><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">private void sendOrderStatusChangeMessage(Order order, String operationType) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        OrderStatusChangeMessage message = OrderStatusChangeMessage.builder()</span><br><span class="line">                .orderId(order.getId())</span><br><span class="line">                .orderNo(order.getOrderNo())</span><br><span class="line">                .userId(order.getUserId())</span><br><span class="line">                .status(order.getStatus())</span><br><span class="line">                .operationType(operationType)</span><br><span class="line">                .changeTime(LocalDateTime.now())</span><br><span class="line">                .build();</span><br><span class="line">        </span><br><span class="line">        rocketMQTemplate.syncSend(</span><br><span class="line">                &quot;ORDER_TOPIC:ORDER_STATUS_CHANGE&quot;,</span><br><span class="line">                MessageBuilder.withPayload(message).build()</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        log.info(&quot;å‘é€è®¢å•çŠ¶æ€å˜æ›´æ¶ˆæ¯ï¼Œè®¢å•å·ï¼š&#123;&#125;ï¼ŒçŠ¶æ€ï¼š&#123;&#125;&quot;, order.getOrderNo(), order.getStatus());</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        log.error(&quot;å‘é€è®¢å•çŠ¶æ€å˜æ›´æ¶ˆæ¯å¤±è´¥ï¼Œè®¢å•å·ï¼š&#123;&#125;&quot;, order.getOrderNo(), e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-2-æœç´¢æœåŠ¡æ¶ˆè´¹æ¶ˆæ¯"><a href="#5-2-æœç´¢æœåŠ¡æ¶ˆè´¹æ¶ˆæ¯" class="headerlink" title="5.2 æœç´¢æœåŠ¡æ¶ˆè´¹æ¶ˆæ¯"></a>5.2 æœç´¢æœåŠ¡æ¶ˆè´¹æ¶ˆæ¯</h3><p>åœ¨æœç´¢æœåŠ¡ä¸­ï¼Œç›‘å¬è®¢å•çŠ¶æ€å˜æ›´æ¶ˆæ¯ï¼Œæ›´æ–°ESä¸­çš„è®¢å•æ•°æ®ã€‚</p><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">@Slf4j</span><br><span class="line">public class OrderStatusChangeConsumer &#123;</span><br><span class="line">    </span><br><span class="line">    @Autowired</span><br><span class="line">    private OrderSearchService orderSearchService;</span><br><span class="line">    </span><br><span class="line">    @RocketMQMessageListener(</span><br><span class="line">            topic = &quot;ORDER_TOPIC&quot;,</span><br><span class="line">            selectorExpression = &quot;ORDER_STATUS_CHANGE&quot;,</span><br><span class="line">            consumerGroup = &quot;order-search-consumer-group&quot;</span><br><span class="line">    )</span><br><span class="line">    public void onMessage(OrderStatusChangeMessage message) &#123;</span><br><span class="line">        log.info(&quot;æ”¶åˆ°è®¢å•çŠ¶æ€å˜æ›´æ¶ˆæ¯ï¼š&#123;&#125;&quot;, message);</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            // æ ¹æ®æ¶ˆæ¯ç±»å‹æ›´æ–°ESä¸­çš„è®¢å•æ•°æ®</span><br><span class="line">            switch (message.getOperationType()) &#123;</span><br><span class="line">                case &quot;CREATE&quot;:</span><br><span class="line">                    orderSearchService.indexOrder(message.getOrderId());</span><br><span class="line">                    break;</span><br><span class="line">                case &quot;UPDATE&quot;:</span><br><span class="line">                    orderSearchService.updateOrder(message.getOrderId());</span><br><span class="line">                    break;</span><br><span class="line">                case &quot;CANCEL&quot;:</span><br><span class="line">                case &quot;COMPLETE&quot;:</span><br><span class="line">                case &quot;REFUND&quot;:</span><br><span class="line">                    orderSearchService.updateOrderStatus(message.getOrderId(), message.getStatus());</span><br><span class="line">                    break;</span><br><span class="line">                default:</span><br><span class="line">                    log.warn(&quot;æœªçŸ¥çš„æ“ä½œç±»å‹ï¼š&#123;&#125;&quot;, message.getOperationType());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;å¤„ç†è®¢å•çŠ¶æ€å˜æ›´æ¶ˆæ¯å¤±è´¥ï¼Œè®¢å•IDï¼š&#123;&#125;&quot;, message.getOrderId(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-3-è®¢å•æœç´¢æœåŠ¡å®ç°"><a href="#5-3-è®¢å•æœç´¢æœåŠ¡å®ç°" class="headerlink" title="5.3 è®¢å•æœç´¢æœåŠ¡å®ç°"></a>5.3 è®¢å•æœç´¢æœåŠ¡å®ç°</h3><p>åœ¨æœç´¢æœåŠ¡ä¸­ï¼Œå®ç°è®¢å•çš„ç´¢å¼•ã€æ›´æ–°å’Œæœç´¢åŠŸèƒ½ã€‚</p><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">@Service</span><br><span class="line">@Slf4j</span><br><span class="line">public class OrderSearchServiceImpl implements OrderSearchService &#123;</span><br><span class="line">    </span><br><span class="line">    @Autowired</span><br><span class="line">    private OrderRepository orderRepository;</span><br><span class="line">    </span><br><span class="line">    @Autowired</span><br><span class="line">    private OrderService orderService;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public boolean indexOrder(Long orderId) &#123;</span><br><span class="line">        // ä»è®¢å•æœåŠ¡è·å–è®¢å•è¯¦æƒ…</span><br><span class="line">        OrderVo order = orderService.getOrderDetail(orderId);</span><br><span class="line">        </span><br><span class="line">        // è½¬æ¢ä¸ºESæ–‡æ¡£</span><br><span class="line">        OrderDocument document = convertToDocument(order);</span><br><span class="line">        </span><br><span class="line">        // ä¿å­˜åˆ°ES</span><br><span class="line">        orderRepository.save(document);</span><br><span class="line">        </span><br><span class="line">        log.info(&quot;ç´¢å¼•è®¢å•æˆåŠŸï¼Œè®¢å•IDï¼š&#123;&#125;&quot;, orderId);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public boolean updateOrder(Long orderId) &#123;</span><br><span class="line">        // å…ˆåˆ é™¤æ—§çš„ç´¢å¼•</span><br><span class="line">        orderRepository.deleteById(orderId);</span><br><span class="line">        </span><br><span class="line">        // é‡æ–°ç´¢å¼•</span><br><span class="line">        return indexOrder(orderId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public boolean updateOrderStatus(Long orderId, Integer status) &#123;</span><br><span class="line">        // æŸ¥è¯¢ESä¸­çš„è®¢å•</span><br><span class="line">        Optional&lt;OrderDocument&gt; optional = orderRepository.findById(orderId);</span><br><span class="line">        if (optional.isPresent()) &#123;</span><br><span class="line">            OrderDocument document = optional.get();</span><br><span class="line">            document.setStatus(status);</span><br><span class="line">            orderRepository.save(document);</span><br><span class="line">            log.info(&quot;æ›´æ–°è®¢å•çŠ¶æ€æˆåŠŸï¼Œè®¢å•IDï¼š&#123;&#125;ï¼ŒçŠ¶æ€ï¼š&#123;&#125;&quot;, orderId, status);</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è½¬æ¢è®¢å•ä¸ºESæ–‡æ¡£</span><br><span class="line">     */</span><br><span class="line">    private OrderDocument convertToDocument(OrderVo order) &#123;</span><br><span class="line">        OrderDocument document = new OrderDocument();</span><br><span class="line">        // è®¾ç½®å±æ€§</span><br><span class="line">        // ...</span><br><span class="line">        return document;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±å®ç°äº†è®¢å•æ•°æ®çš„å®æ—¶åŒæ­¥åˆ°ESï¼Œå¯ä»¥æ”¯æŒè®¢å•çš„æœç´¢å’Œç»Ÿè®¡åˆ†æã€‚</p><h2 id="æ€»ç»“-1"><a href="#æ€»ç»“-1" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>åœ¨è¿™ä¸€é˜¶æ®µï¼Œæˆ‘ä»¬å®ç°äº†è®¢å•æœåŠ¡çš„æ ¸å¿ƒåŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š</p><ol><li><strong>åº“å­˜æœåŠ¡çš„å¹¶å‘æ§åˆ¶</strong>ï¼šä½¿ç”¨åˆ†å¸ƒå¼é”å’ŒRedisä¿è¯åº“å­˜æ“ä½œçš„ä¸€è‡´æ€§ã€‚</li><li><strong>è®¢å•è¶…æ—¶è‡ªåŠ¨å–æ¶ˆ</strong>ï¼šä½¿ç”¨å®šæ—¶ä»»åŠ¡å’Œå»¶è¿Ÿé˜Ÿåˆ—ä¸¤ç§æ–¹å¼ã€‚</li><li><strong>è®¢å•åˆ†åº“åˆ†è¡¨</strong>ï¼šä½¿ç”¨ShardingSphereå®ç°åˆ†åº“åˆ†è¡¨ï¼Œæé«˜ç³»ç»Ÿæ‰©å±•æ€§ã€‚</li><li><strong>è®¢å•é€€æ¬¾æµç¨‹</strong>ï¼šä½¿ç”¨çŠ¶æ€æœºå’Œåˆ†å¸ƒå¼äº‹åŠ¡ä¿è¯é€€æ¬¾æµç¨‹çš„ä¸€è‡´æ€§ã€‚</li><li><strong>è®¢å•æ•°æ®åŒæ­¥åˆ°ES</strong>ï¼šä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å®ç°è®¢å•æ•°æ®çš„å®æ—¶åŒæ­¥ã€‚</li></ol><p>è¿™äº›åŠŸèƒ½çš„å®ç°ï¼Œä½¿å¾—æˆ‘ä»¬çš„ç”µå•†ç³»ç»Ÿèƒ½å¤Ÿå¤„ç†é«˜å¹¶å‘çš„è®¢å•åœºæ™¯ï¼Œä¿è¯æ•°æ®çš„ä¸€è‡´æ€§å’Œç³»ç»Ÿçš„å¯ç”¨æ€§ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­å®ç°å…¶ä»–æ¨¡å—ï¼Œå¦‚æ”¯ä»˜æœåŠ¡ã€é€šçŸ¥æœåŠ¡ç­‰ï¼Œæœ€ç»ˆå®Œæˆæ•´ä¸ªç”µå•†ç³»ç»Ÿçš„å¼€å‘ã€‚</p><h1 id="ğŸš€-ç¬¬äº”é˜¶æ®µï¼šè®¢å•æœåŠ¡å®ç°ï¼ˆç¬¬13å¤©ï¼‰ç»­"><a href="#ğŸš€-ç¬¬äº”é˜¶æ®µï¼šè®¢å•æœåŠ¡å®ç°ï¼ˆç¬¬13å¤©ï¼‰ç»­" class="headerlink" title="ğŸš€ ç¬¬äº”é˜¶æ®µï¼šè®¢å•æœåŠ¡å®ç°ï¼ˆç¬¬13å¤©ï¼‰ç»­"></a>ğŸš€ ç¬¬äº”é˜¶æ®µï¼šè®¢å•æœåŠ¡å®ç°ï¼ˆç¬¬13å¤©ï¼‰ç»­</h1><h2 id="ç¬¬13å¤©ï¼šåº“å­˜å¹¶å‘æ§åˆ¶-å»¶è¿Ÿé˜Ÿåˆ—-åˆ†åº“åˆ†è¡¨-æ•°æ®åŒæ­¥"><a href="#ç¬¬13å¤©ï¼šåº“å­˜å¹¶å‘æ§åˆ¶-å»¶è¿Ÿé˜Ÿåˆ—-åˆ†åº“åˆ†è¡¨-æ•°æ®åŒæ­¥" class="headerlink" title="ç¬¬13å¤©ï¼šåº“å­˜å¹¶å‘æ§åˆ¶ + å»¶è¿Ÿé˜Ÿåˆ— + åˆ†åº“åˆ†è¡¨ + æ•°æ®åŒæ­¥"></a>ç¬¬13å¤©ï¼šåº“å­˜å¹¶å‘æ§åˆ¶ + å»¶è¿Ÿé˜Ÿåˆ— + åˆ†åº“åˆ†è¡¨ + æ•°æ®åŒæ­¥</h2><h3 id="1-åº“å­˜æœåŠ¡çš„å¹¶å‘æ§åˆ¶å®ç°"><a href="#1-åº“å­˜æœåŠ¡çš„å¹¶å‘æ§åˆ¶å®ç°" class="headerlink" title="1. åº“å­˜æœåŠ¡çš„å¹¶å‘æ§åˆ¶å®ç°"></a>1. åº“å­˜æœåŠ¡çš„å¹¶å‘æ§åˆ¶å®ç°</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.inventory.service.impl;</span><br><span class="line"></span><br><span class="line">import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;</span><br><span class="line">import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span><br><span class="line">import com.shophub.common.exception.BusinessException;</span><br><span class="line">import com.shophub.common.result.ResultCode;</span><br><span class="line">import com.shophub.inventory.entity.Inventory;</span><br><span class="line">import com.shophub.inventory.entity.InventoryLog;</span><br><span class="line">import com.shophub.inventory.mapper.InventoryMapper;</span><br><span class="line">import com.shophub.inventory.service.InventoryService;</span><br><span class="line">import lombok.RequiredArgsConstructor;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.redisson.api.RLock;</span><br><span class="line">import org.redisson.api.RedissonClient;</span><br><span class="line">import org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line">import org.springframework.data.redis.core.script.DefaultRedisScript;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line">import org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line">import java.time.LocalDateTime;</span><br><span class="line">import java.util.Arrays;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@Service</span><br><span class="line">@RequiredArgsConstructor</span><br><span class="line">public class InventoryServiceImpl extends ServiceImpl&lt;InventoryMapper, Inventory&gt; implements InventoryService &#123;</span><br><span class="line">    </span><br><span class="line">    private final InventoryMapper inventoryMapper;</span><br><span class="line">    private final RedissonClient redissonClient;</span><br><span class="line">    private final RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    private final InventoryLogService inventoryLogService;</span><br><span class="line">    </span><br><span class="line">    // Redis keyå‰ç¼€</span><br><span class="line">    private static final String INVENTORY_LOCK_PREFIX = &quot;inventory:lock:&quot;;</span><br><span class="line">    private static final String INVENTORY_STOCK_PREFIX = &quot;inventory:stock:&quot;;</span><br><span class="line">    private static final String INVENTORY_STOCK_LOCK_PREFIX = &quot;inventory:stock:lock:&quot;;</span><br><span class="line">    private static final String INVENTORY_SECKILL_PREFIX = &quot;inventory:seckill:&quot;;</span><br><span class="line">    </span><br><span class="line">    // Luaè„šæœ¬ - åŸå­åŒ–æ‰£å‡åº“å­˜ï¼ˆè§£å†³è¶…å–é—®é¢˜ï¼‰</span><br><span class="line">    private static final String REDUCE_STOCK_SCRIPT = &quot;&quot;&quot;</span><br><span class="line">        local stockKey = KEYS[1]</span><br><span class="line">        local lockKey = KEYS[2]</span><br><span class="line">        local quantity = tonumber(ARGV[1])</span><br><span class="line">        local lockTimeout = tonumber(ARGV[2])</span><br><span class="line">        </span><br><span class="line">        -- æ£€æŸ¥åº“å­˜</span><br><span class="line">        local stock = redis.call(&#x27;get&#x27;, stockKey)</span><br><span class="line">        if not stock then</span><br><span class="line">            return -1  -- åº“å­˜ä¸å­˜åœ¨</span><br><span class="line">        end</span><br><span class="line">        </span><br><span class="line">        stock = tonumber(stock)</span><br><span class="line">        if stock &lt; quantity then</span><br><span class="line">            return -2  -- åº“å­˜ä¸è¶³</span><br><span class="line">        end</span><br><span class="line">        </span><br><span class="line">        -- æ‰£å‡åº“å­˜</span><br><span class="line">        local newStock = stock - quantity</span><br><span class="line">        redis.call(&#x27;set&#x27;, stockKey, newStock)</span><br><span class="line">        </span><br><span class="line">        -- è®¾ç½®åº“å­˜é”ï¼ˆé˜²æ­¢é‡å¤æ‰£å‡ï¼‰</span><br><span class="line">        redis.call(&#x27;set&#x27;, lockKey, 1, &#x27;EX&#x27;, lockTimeout)</span><br><span class="line">        </span><br><span class="line">        return newStock</span><br><span class="line">        &quot;&quot;&quot;;</span><br><span class="line">    </span><br><span class="line">    // Luaè„šæœ¬ - é¢„æ‰£åº“å­˜ï¼ˆç§’æ€åœºæ™¯ï¼‰</span><br><span class="line">    private static final String PRE_REDUCE_STOCK_SCRIPT = &quot;&quot;&quot;</span><br><span class="line">        local stockKey = KEYS[1]</span><br><span class="line">        local preStockKey = KEYS[2]</span><br><span class="line">        local lockKey = KEYS[3]</span><br><span class="line">        local quantity = tonumber(ARGV[1])</span><br><span class="line">        local userId = ARGV[2]</span><br><span class="line">        local expireTime = tonumber(ARGV[3])</span><br><span class="line">        </span><br><span class="line">        -- æ£€æŸ¥æ€»åº“å­˜</span><br><span class="line">        local totalStock = redis.call(&#x27;get&#x27;, stockKey)</span><br><span class="line">        if not totalStock then</span><br><span class="line">            return -1  -- åº“å­˜ä¸å­˜åœ¨</span><br><span class="line">        end</span><br><span class="line">        </span><br><span class="line">        totalStock = tonumber(totalStock)</span><br><span class="line">        </span><br><span class="line">        -- æ£€æŸ¥é¢„æ‰£åº“å­˜</span><br><span class="line">        local preStock = redis.call(&#x27;get&#x27;, preStockKey)</span><br><span class="line">        if not preStock then</span><br><span class="line">            preStock = 0</span><br><span class="line">        else</span><br><span class="line">            preStock = tonumber(preStock)</span><br><span class="line">        end</span><br><span class="line">        </span><br><span class="line">        -- æ£€æŸ¥æ˜¯å¦è¿˜æœ‰åº“å­˜å¯æ‰£</span><br><span class="line">        if totalStock - preStock &lt; quantity then</span><br><span class="line">            return -2  -- åº“å­˜ä¸è¶³</span><br><span class="line">        end</span><br><span class="line">        </span><br><span class="line">        -- å¢åŠ é¢„æ‰£åº“å­˜</span><br><span class="line">        local newPreStock = preStock + quantity</span><br><span class="line">        redis.call(&#x27;set&#x27;, preStockKey, newPreStock, &#x27;EX&#x27;, expireTime)</span><br><span class="line">        </span><br><span class="line">        -- è®°å½•ç”¨æˆ·é¢„æ‰£ä¿¡æ¯ï¼ˆç”¨äºåç»­ç¡®è®¤ï¼‰</span><br><span class="line">        local userKey = KEYS[4] .. userId</span><br><span class="line">        redis.call(&#x27;set&#x27;, userKey, quantity, &#x27;EX&#x27;, expireTime)</span><br><span class="line">        </span><br><span class="line">        -- è®¾ç½®é”</span><br><span class="line">        redis.call(&#x27;set&#x27;, lockKey, 1, &#x27;EX&#x27;, 5)</span><br><span class="line">        </span><br><span class="line">        return newPreStock</span><br><span class="line">        &quot;&quot;&quot;;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    @Transactional(rollbackFor = Exception.class)</span><br><span class="line">    public boolean reduceStock(Long productId, Integer quantity) &#123;</span><br><span class="line">        log.info(&quot;æ‰£å‡åº“å­˜ï¼Œå•†å“IDï¼š&#123;&#125;ï¼Œæ•°é‡ï¼š&#123;&#125;&quot;, productId, quantity);</span><br><span class="line">        </span><br><span class="line">        if (productId == null || quantity == null || quantity &lt;= 0) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.PARAM_VALID_ERROR, &quot;å‚æ•°ä¸åˆæ³•&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        String lockKey = INVENTORY_LOCK_PREFIX + productId;</span><br><span class="line">        RLock lock = redissonClient.getLock(lockKey);</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            // ä½¿ç”¨Redissonåˆ†å¸ƒå¼é”</span><br><span class="line">            boolean locked = lock.tryLock(5, 10, TimeUnit.SECONDS);</span><br><span class="line">            if (!locked) &#123;</span><br><span class="line">                throw new BusinessException(ResultCode.SYSTEM_ERROR, &quot;ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // æŸ¥è¯¢åº“å­˜</span><br><span class="line">            Inventory inventory = getByProductId(productId);</span><br><span class="line">            if (inventory == null) &#123;</span><br><span class="line">                throw new BusinessException(ResultCode.RESOURCE_NOT_FOUND, &quot;å•†å“åº“å­˜ä¸å­˜åœ¨&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // æ£€æŸ¥åº“å­˜æ˜¯å¦å……è¶³</span><br><span class="line">            if (inventory.getAvailableStock() &lt; quantity) &#123;</span><br><span class="line">                log.error(&quot;åº“å­˜ä¸è¶³ï¼Œå•†å“IDï¼š&#123;&#125;ï¼Œå¯ç”¨åº“å­˜ï¼š&#123;&#125;ï¼Œéœ€è¦æ‰£å‡ï¼š&#123;&#125;&quot;, </span><br><span class="line">                        productId, inventory.getAvailableStock(), quantity);</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // æ‰£å‡åº“å­˜</span><br><span class="line">            int updateCount = inventoryMapper.reduceStock(productId, quantity);</span><br><span class="line">            if (updateCount &lt;= 0) &#123;</span><br><span class="line">                throw new BusinessException(ResultCode.SYSTEM_ERROR, &quot;æ‰£å‡åº“å­˜å¤±è´¥&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // è®°å½•åº“å­˜æµæ°´</span><br><span class="line">            saveInventoryLog(inventory, productId, null, null, 2, quantity);</span><br><span class="line">            </span><br><span class="line">            // æ›´æ–°Redisç¼“å­˜</span><br><span class="line">            updateInventoryCache(productId);</span><br><span class="line">            </span><br><span class="line">            log.info(&quot;æ‰£å‡åº“å­˜æˆåŠŸï¼Œå•†å“IDï¼š&#123;&#125;ï¼Œæ•°é‡ï¼š&#123;&#125;&quot;, productId, quantity);</span><br><span class="line">            return true;</span><br><span class="line">            </span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">            throw new BusinessException(ResultCode.SYSTEM_ERROR, &quot;ç³»ç»Ÿå¼‚å¸¸&quot;);</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            if (lock.isHeldByCurrentThread()) &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public boolean reduceStockWithRedis(Long productId, Integer quantity) &#123;</span><br><span class="line">        log.info(&quot;ä½¿ç”¨RedisåŸå­æ“ä½œæ‰£å‡åº“å­˜ï¼Œå•†å“IDï¼š&#123;&#125;ï¼Œæ•°é‡ï¼š&#123;&#125;&quot;, productId, quantity);</span><br><span class="line">        </span><br><span class="line">        String stockKey = INVENTORY_STOCK_PREFIX + productId;</span><br><span class="line">        String lockKey = INVENTORY_STOCK_LOCK_PREFIX + productId;</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            // æ‰§è¡ŒLuaè„šæœ¬ï¼ˆåŸå­æ“ä½œï¼‰</span><br><span class="line">            DefaultRedisScript&lt;Long&gt; redisScript = new DefaultRedisScript&lt;&gt;();</span><br><span class="line">            redisScript.setScriptText(REDUCE_STOCK_SCRIPT);</span><br><span class="line">            redisScript.setResultType(Long.class);</span><br><span class="line">            </span><br><span class="line">            Long result = redisTemplate.execute(</span><br><span class="line">                redisScript,</span><br><span class="line">                Arrays.asList(stockKey, lockKey),</span><br><span class="line">                quantity, 5 // é”è¶…æ—¶5ç§’</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            if (result == null) &#123;</span><br><span class="line">                log.error(&quot;Redisæ‰£å‡åº“å­˜å¤±è´¥ï¼Œå•†å“IDï¼š&#123;&#125;&quot;, productId);</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            if (result == -1) &#123;</span><br><span class="line">                log.error(&quot;åº“å­˜ä¸å­˜åœ¨ï¼Œå•†å“IDï¼š&#123;&#125;&quot;, productId);</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            if (result == -2) &#123;</span><br><span class="line">                log.error(&quot;åº“å­˜ä¸è¶³ï¼Œå•†å“IDï¼š&#123;&#125;&quot;, productId);</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // å¼‚æ­¥æ›´æ–°æ•°æ®åº“</span><br><span class="line">            asyncUpdateDatabaseStock(productId, quantity);</span><br><span class="line">            </span><br><span class="line">            log.info(&quot;Redisæ‰£å‡åº“å­˜æˆåŠŸï¼Œå•†å“IDï¼š&#123;&#125;ï¼Œå‰©ä½™åº“å­˜ï¼š&#123;&#125;&quot;, productId, result);</span><br><span class="line">            return true;</span><br><span class="line">            </span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;Redisæ‰£å‡åº“å­˜å¼‚å¸¸ï¼Œå•†å“IDï¼š&#123;&#125;&quot;, productId, e);</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    @Transactional(rollbackFor = Exception.class)</span><br><span class="line">    public boolean lockInventory(Long productId, Integer quantity, Integer timeoutSeconds) &#123;</span><br><span class="line">        log.info(&quot;é”å®šåº“å­˜ï¼Œå•†å“IDï¼š&#123;&#125;ï¼Œæ•°é‡ï¼š&#123;&#125;ï¼Œè¶…æ—¶æ—¶é—´ï¼š&#123;&#125;ç§’&quot;, productId, quantity, timeoutSeconds);</span><br><span class="line">        </span><br><span class="line">        String lockKey = INVENTORY_LOCK_PREFIX + productId;</span><br><span class="line">        RLock lock = redissonClient.getLock(lockKey);</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            boolean locked = lock.tryLock(5, 10, TimeUnit.SECONDS);</span><br><span class="line">            if (!locked) &#123;</span><br><span class="line">                throw new BusinessException(ResultCode.SYSTEM_ERROR, &quot;ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            Inventory inventory = getByProductId(productId);</span><br><span class="line">            if (inventory == null) &#123;</span><br><span class="line">                throw new BusinessException(ResultCode.RESOURCE_NOT_FOUND, &quot;å•†å“åº“å­˜ä¸å­˜åœ¨&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // æ£€æŸ¥å¯ç”¨åº“å­˜</span><br><span class="line">            if (inventory.getAvailableStock() &lt; quantity) &#123;</span><br><span class="line">                log.error(&quot;åº“å­˜ä¸è¶³ï¼Œå•†å“IDï¼š&#123;&#125;ï¼Œå¯ç”¨åº“å­˜ï¼š&#123;&#125;ï¼Œéœ€è¦é”å®šï¼š&#123;&#125;&quot;, </span><br><span class="line">                        productId, inventory.getAvailableStock(), quantity);</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // é”å®šåº“å­˜</span><br><span class="line">            int updateCount = inventoryMapper.lockStock(productId, quantity);</span><br><span class="line">            if (updateCount &lt;= 0) &#123;</span><br><span class="line">                throw new BusinessException(ResultCode.SYSTEM_ERROR, &quot;é”å®šåº“å­˜å¤±è´¥&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // è®°å½•åº“å­˜æµæ°´</span><br><span class="line">            saveInventoryLog(inventory, productId, null, null, 1, quantity);</span><br><span class="line">            </span><br><span class="line">            // è®¾ç½®Redisè¿‡æœŸé”ï¼ˆç”¨äºè‡ªåŠ¨é‡Šæ”¾ï¼‰</span><br><span class="line">            String redisLockKey = &quot;inventory:temp:lock:&quot; + productId;</span><br><span class="line">            redisTemplate.opsForValue().set(</span><br><span class="line">                redisLockKey, </span><br><span class="line">                quantity, </span><br><span class="line">                timeoutSeconds, </span><br><span class="line">                TimeUnit.SECONDS</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            log.info(&quot;é”å®šåº“å­˜æˆåŠŸï¼Œå•†å“IDï¼š&#123;&#125;ï¼Œæ•°é‡ï¼š&#123;&#125;&quot;, productId, quantity);</span><br><span class="line">            return true;</span><br><span class="line">            </span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">            throw new BusinessException(ResultCode.SYSTEM_ERROR, &quot;ç³»ç»Ÿå¼‚å¸¸&quot;);</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            if (lock.isHeldByCurrentThread()) &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    @Transactional(rollbackFor = Exception.class)</span><br><span class="line">    public boolean releaseLockedInventory(Long productId, Integer quantity) &#123;</span><br><span class="line">        log.info(&quot;é‡Šæ”¾é”å®šåº“å­˜ï¼Œå•†å“IDï¼š&#123;&#125;ï¼Œæ•°é‡ï¼š&#123;&#125;&quot;, productId, quantity);</span><br><span class="line">        </span><br><span class="line">        String lockKey = INVENTORY_LOCK_PREFIX + productId;</span><br><span class="line">        RLock lock = redissonClient.getLock(lockKey);</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            boolean locked = lock.tryLock(5, 10, TimeUnit.SECONDS);</span><br><span class="line">            if (!locked) &#123;</span><br><span class="line">                throw new BusinessException(ResultCode.SYSTEM_ERROR, &quot;ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            Inventory inventory = getByProductId(productId);</span><br><span class="line">            if (inventory == null) &#123;</span><br><span class="line">                throw new BusinessException(ResultCode.RESOURCE_NOT_FOUND, &quot;å•†å“åº“å­˜ä¸å­˜åœ¨&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // å¦‚æœä¼ å…¥æ•°é‡ä¸ºnullï¼Œåˆ™é‡Šæ”¾æ‰€æœ‰é”å®šåº“å­˜</span><br><span class="line">            if (quantity == null) &#123;</span><br><span class="line">                quantity = inventory.getLockedStock();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // æ£€æŸ¥é”å®šåº“å­˜æ˜¯å¦è¶³å¤Ÿ</span><br><span class="line">            if (inventory.getLockedStock() &lt; quantity) &#123;</span><br><span class="line">                quantity = inventory.getLockedStock(); // é‡Šæ”¾å…¨éƒ¨é”å®šåº“å­˜</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            if (quantity == 0) &#123;</span><br><span class="line">                log.info(&quot;æ— é”å®šåº“å­˜å¯é‡Šæ”¾ï¼Œå•†å“IDï¼š&#123;&#125;&quot;, productId);</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // é‡Šæ”¾é”å®šåº“å­˜</span><br><span class="line">            int updateCount = inventoryMapper.releaseStock(productId, quantity);</span><br><span class="line">            if (updateCount &lt;= 0) &#123;</span><br><span class="line">                throw new BusinessException(ResultCode.SYSTEM_ERROR, &quot;é‡Šæ”¾é”å®šåº“å­˜å¤±è´¥&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // è®°å½•åº“å­˜æµæ°´</span><br><span class="line">            saveInventoryLog(inventory, productId, null, null, 3, quantity);</span><br><span class="line">            </span><br><span class="line">            log.info(&quot;é‡Šæ”¾é”å®šåº“å­˜æˆåŠŸï¼Œå•†å“IDï¼š&#123;&#125;ï¼Œæ•°é‡ï¼š&#123;&#125;&quot;, productId, quantity);</span><br><span class="line">            return true;</span><br><span class="line">            </span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">            throw new BusinessException(ResultCode.SYSTEM_ERROR, &quot;ç³»ç»Ÿå¼‚å¸¸&quot;);</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            if (lock.isHeldByCurrentThread()) &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public boolean seckillReduceStock(Long productId, Integer quantity, Long userId) &#123;</span><br><span class="line">        log.info(&quot;ç§’æ€æ‰£å‡åº“å­˜ï¼Œå•†å“IDï¼š&#123;&#125;ï¼Œæ•°é‡ï¼š&#123;&#125;ï¼Œç”¨æˆ·IDï¼š&#123;&#125;&quot;, productId, quantity, userId);</span><br><span class="line">        </span><br><span class="line">        String stockKey = INVENTORY_STOCK_PREFIX + productId;</span><br><span class="line">        String preStockKey = INVENTORY_SECKILL_PREFIX + productId + &quot;:pre&quot;;</span><br><span class="line">        String lockKey = INVENTORY_SECKILL_PREFIX + productId + &quot;:lock&quot;;</span><br><span class="line">        String userKey = INVENTORY_SECKILL_PREFIX + productId + &quot;:user:&quot;;</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            // æ‰§è¡Œç§’æ€é¢„æ‰£åº“å­˜Luaè„šæœ¬</span><br><span class="line">            DefaultRedisScript&lt;Long&gt; redisScript = new DefaultRedisScript&lt;&gt;();</span><br><span class="line">            redisScript.setScriptText(PRE_REDUCE_STOCK_SCRIPT);</span><br><span class="line">            redisScript.setResultType(Long.class);</span><br><span class="line">            </span><br><span class="line">            Long result = redisTemplate.execute(</span><br><span class="line">                redisScript,</span><br><span class="line">                Arrays.asList(stockKey, preStockKey, lockKey, userKey),</span><br><span class="line">                quantity, userId, 300 // é¢„æ‰£åº“å­˜5åˆ†é’Ÿæœ‰æ•ˆæœŸ</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            if (result == null || result &lt; 0) &#123;</span><br><span class="line">                if (result != null) &#123;</span><br><span class="line">                    log.warn(&quot;ç§’æ€é¢„æ‰£åº“å­˜å¤±è´¥ï¼Œå•†å“IDï¼š&#123;&#125;ï¼Œç»“æœç ï¼š&#123;&#125;&quot;, productId, result);</span><br><span class="line">                &#125;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // å¼‚æ­¥å¤„ç†æ•°æ®åº“æ‰£å‡</span><br><span class="line">            asyncHandleSeckillSuccess(productId, quantity, userId);</span><br><span class="line">            </span><br><span class="line">            log.info(&quot;ç§’æ€é¢„æ‰£åº“å­˜æˆåŠŸï¼Œå•†å“IDï¼š&#123;&#125;ï¼Œç”¨æˆ·IDï¼š&#123;&#125;ï¼Œé¢„æ‰£åæ€»é‡ï¼š&#123;&#125;&quot;, </span><br><span class="line">                    productId, userId, result);</span><br><span class="line">            return true;</span><br><span class="line">            </span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;ç§’æ€æ‰£å‡åº“å­˜å¼‚å¸¸ï¼Œå•†å“IDï¼š&#123;&#125;&quot;, productId, e);</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public Integer getAvailableStock(Long productId) &#123;</span><br><span class="line">        // å…ˆæŸ¥Redisç¼“å­˜</span><br><span class="line">        String cacheKey = INVENTORY_STOCK_PREFIX + productId;</span><br><span class="line">        Object cacheValue = redisTemplate.opsForValue().get(cacheKey);</span><br><span class="line">        </span><br><span class="line">        if (cacheValue != null) &#123;</span><br><span class="line">            return Integer.parseInt(cacheValue.toString());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“</span><br><span class="line">        Inventory inventory = getByProductId(productId);</span><br><span class="line">        if (inventory == null) &#123;</span><br><span class="line">            return 0;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        Integer availableStock = inventory.getAvailableStock();</span><br><span class="line">        </span><br><span class="line">        // æ›´æ–°ç¼“å­˜</span><br><span class="line">        redisTemplate.opsForValue().set(</span><br><span class="line">            cacheKey, </span><br><span class="line">            availableStock, </span><br><span class="line">            5, </span><br><span class="line">            TimeUnit.MINUTES</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        return availableStock;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public void warmUpInventoryCache() &#123;</span><br><span class="line">        log.info(&quot;å¼€å§‹é¢„çƒ­åº“å­˜ç¼“å­˜&quot;);</span><br><span class="line">        </span><br><span class="line">        // æŸ¥è¯¢æ‰€æœ‰å•†å“çš„åº“å­˜</span><br><span class="line">        List&lt;Inventory&gt; inventoryList = list();</span><br><span class="line">        </span><br><span class="line">        for (Inventory inventory : inventoryList) &#123;</span><br><span class="line">            String cacheKey = INVENTORY_STOCK_PREFIX + inventory.getProductId();</span><br><span class="line">            redisTemplate.opsForValue().set(</span><br><span class="line">                cacheKey,</span><br><span class="line">                inventory.getAvailableStock(),</span><br><span class="line">                10, // ç¼“å­˜10åˆ†é’Ÿ</span><br><span class="line">                TimeUnit.MINUTES</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        log.info(&quot;åº“å­˜ç¼“å­˜é¢„çƒ­å®Œæˆï¼Œå…±é¢„çƒ­&#123;&#125;ä¸ªå•†å“&quot;, inventoryList.size());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å¼‚æ­¥æ›´æ–°æ•°æ®åº“åº“å­˜</span><br><span class="line">     */</span><br><span class="line">    private void asyncUpdateDatabaseStock(Long productId, Integer quantity) &#123;</span><br><span class="line">        CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                reduceStock(productId, quantity);</span><br><span class="line">                log.info(&quot;å¼‚æ­¥æ›´æ–°æ•°æ®åº“åº“å­˜æˆåŠŸï¼Œå•†å“IDï¼š&#123;&#125;ï¼Œæ•°é‡ï¼š&#123;&#125;&quot;, productId, quantity);</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                log.error(&quot;å¼‚æ­¥æ›´æ–°æ•°æ®åº“åº“å­˜å¤±è´¥ï¼Œå•†å“IDï¼š&#123;&#125;&quot;, productId, e);</span><br><span class="line">                // è¿™é‡Œå¯ä»¥åŠ å…¥é‡è¯•æœºåˆ¶</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å¼‚æ­¥å¤„ç†ç§’æ€æˆåŠŸ</span><br><span class="line">     */</span><br><span class="line">    private void asyncHandleSeckillSuccess(Long productId, Integer quantity, Long userId) &#123;</span><br><span class="line">        CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                // 1. æ‰£å‡æ•°æ®åº“åº“å­˜</span><br><span class="line">                reduceStock(productId, quantity);</span><br><span class="line">                </span><br><span class="line">                // 2. åˆ›å»ºç§’æ€è®¢å•</span><br><span class="line">                createSeckillOrder(productId, quantity, userId);</span><br><span class="line">                </span><br><span class="line">                // 3. å‘é€ç§’æ€æˆåŠŸé€šçŸ¥</span><br><span class="line">                sendSeckillSuccessMessage(userId, productId);</span><br><span class="line">                </span><br><span class="line">                log.info(&quot;ç§’æ€å¼‚æ­¥å¤„ç†æˆåŠŸï¼Œå•†å“IDï¼š&#123;&#125;ï¼Œç”¨æˆ·IDï¼š&#123;&#125;&quot;, productId, userId);</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                log.error(&quot;ç§’æ€å¼‚æ­¥å¤„ç†å¤±è´¥ï¼Œå•†å“IDï¼š&#123;&#125;ï¼Œç”¨æˆ·IDï¼š&#123;&#125;&quot;, productId, userId, e);</span><br><span class="line">                // å›æ»šRedisé¢„æ‰£åº“å­˜</span><br><span class="line">                rollbackSeckillPreStock(productId, quantity, userId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * ä¿å­˜åº“å­˜æµæ°´</span><br><span class="line">     */</span><br><span class="line">    private void saveInventoryLog(Inventory inventory, Long productId, Long orderId, </span><br><span class="line">                                 String orderNo, Integer changeType, Integer changeQuantity) &#123;</span><br><span class="line">        InventoryLog log = new InventoryLog();</span><br><span class="line">        log.setProductId(productId);</span><br><span class="line">        log.setOrderId(orderId);</span><br><span class="line">        log.setOrderNo(orderNo);</span><br><span class="line">        log.setChangeType(changeType);</span><br><span class="line">        log.setChangeQuantity(changeQuantity);</span><br><span class="line">        log.setBeforeTotal(inventory.getTotalStock());</span><br><span class="line">        log.setAfterTotal(inventory.getTotalStock() - </span><br><span class="line">                         (changeType == 2 ? changeQuantity : 0));</span><br><span class="line">        log.setBeforeAvailable(inventory.getAvailableStock());</span><br><span class="line">        log.setAfterAvailable(inventory.getAvailableStock() - </span><br><span class="line">                            (changeType == 1 || changeType == 2 ? changeQuantity : 0));</span><br><span class="line">        log.setBeforeLocked(inventory.getLockedStock());</span><br><span class="line">        log.setAfterLocked(inventory.getLockedStock() + </span><br><span class="line">                         (changeType == 1 ? changeQuantity : </span><br><span class="line">                          changeType == 3 ? -changeQuantity : 0));</span><br><span class="line">        log.setCreateTime(LocalDateTime.now());</span><br><span class="line">        </span><br><span class="line">        inventoryLogService.save(log);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ›´æ–°åº“å­˜ç¼“å­˜</span><br><span class="line">     */</span><br><span class="line">    private void updateInventoryCache(Long productId) &#123;</span><br><span class="line">        Inventory inventory = getByProductId(productId);</span><br><span class="line">        if (inventory != null) &#123;</span><br><span class="line">            String cacheKey = INVENTORY_STOCK_PREFIX + productId;</span><br><span class="line">            redisTemplate.opsForValue().set(</span><br><span class="line">                cacheKey,</span><br><span class="line">                inventory.getAvailableStock(),</span><br><span class="line">                5,</span><br><span class="line">                TimeUnit.MINUTES</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ ¹æ®å•†å“IDæŸ¥è¯¢åº“å­˜</span><br><span class="line">     */</span><br><span class="line">    private Inventory getByProductId(Long productId) &#123;</span><br><span class="line">        QueryWrapper&lt;Inventory&gt; wrapper = new QueryWrapper&lt;&gt;();</span><br><span class="line">        wrapper.eq(&quot;product_id&quot;, productId);</span><br><span class="line">        wrapper.eq(&quot;is_deleted&quot;, 0);</span><br><span class="line">        return getOne(wrapper);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// åº“å­˜Mapper</span><br><span class="line">public interface InventoryMapper extends BaseMapper&lt;Inventory&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    @Update(&quot;UPDATE inventory SET available_stock = available_stock - #&#123;quantity&#125;, &quot; +</span><br><span class="line">            &quot;total_stock = total_stock - #&#123;quantity&#125;, update_time = NOW() &quot; +</span><br><span class="line">            &quot;WHERE product_id = #&#123;productId&#125; AND available_stock &gt;= #&#123;quantity&#125;&quot;)</span><br><span class="line">    int reduceStock(@Param(&quot;productId&quot;) Long productId, @Param(&quot;quantity&quot;) Integer quantity);</span><br><span class="line">    </span><br><span class="line">    @Update(&quot;UPDATE inventory SET available_stock = available_stock - #&#123;quantity&#125;, &quot; +</span><br><span class="line">            &quot;locked_stock = locked_stock + #&#123;quantity&#125;, update_time = NOW() &quot; +</span><br><span class="line">            &quot;WHERE product_id = #&#123;productId&#125; AND available_stock &gt;= #&#123;quantity&#125;&quot;)</span><br><span class="line">    int lockStock(@Param(&quot;productId&quot;) Long productId, @Param(&quot;quantity&quot;) Integer quantity);</span><br><span class="line">    </span><br><span class="line">    @Update(&quot;UPDATE inventory SET available_stock = available_stock + #&#123;quantity&#125;, &quot; +</span><br><span class="line">            &quot;locked_stock = locked_stock - #&#123;quantity&#125;, update_time = NOW() &quot; +</span><br><span class="line">            &quot;WHERE product_id = #&#123;productId&#125; AND locked_stock &gt;= #&#123;quantity&#125;&quot;)</span><br><span class="line">    int releaseStock(@Param(&quot;productId&quot;) Long productId, @Param(&quot;quantity&quot;) Integer quantity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// åº“å­˜æœåŠ¡æ¥å£</span><br><span class="line">public interface InventoryService &#123;</span><br><span class="line">    </span><br><span class="line">    boolean reduceStock(Long productId, Integer quantity);</span><br><span class="line">    </span><br><span class="line">    boolean reduceStockWithRedis(Long productId, Integer quantity);</span><br><span class="line">    </span><br><span class="line">    boolean lockInventory(Long productId, Integer quantity, Integer timeoutSeconds);</span><br><span class="line">    </span><br><span class="line">    boolean releaseLockedInventory(Long productId, Integer quantity);</span><br><span class="line">    </span><br><span class="line">    boolean seckillReduceStock(Long productId, Integer quantity, Long userId);</span><br><span class="line">    </span><br><span class="line">    Integer getAvailableStock(Long productId);</span><br><span class="line">    </span><br><span class="line">    void warmUpInventoryCache();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-è®¢å•è¶…æ—¶è‡ªåŠ¨å–æ¶ˆï¼ˆå»¶è¿Ÿé˜Ÿåˆ—å®ç°ï¼‰"><a href="#2-è®¢å•è¶…æ—¶è‡ªåŠ¨å–æ¶ˆï¼ˆå»¶è¿Ÿé˜Ÿåˆ—å®ç°ï¼‰" class="headerlink" title="2. è®¢å•è¶…æ—¶è‡ªåŠ¨å–æ¶ˆï¼ˆå»¶è¿Ÿé˜Ÿåˆ—å®ç°ï¼‰"></a>2. è®¢å•è¶…æ—¶è‡ªåŠ¨å–æ¶ˆï¼ˆå»¶è¿Ÿé˜Ÿåˆ—å®ç°ï¼‰</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.order.service;</span><br><span class="line"></span><br><span class="line">import lombok.RequiredArgsConstructor;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.apache.rocketmq.client.producer.SendResult;</span><br><span class="line">import org.apache.rocketmq.client.producer.SendStatus;</span><br><span class="line">import org.apache.rocketmq.spring.core.RocketMQTemplate;</span><br><span class="line">import org.springframework.beans.factory.annotation.Value;</span><br><span class="line">import org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line">import org.springframework.scheduling.annotation.Scheduled;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line">import java.time.LocalDateTime;</span><br><span class="line">import java.time.format.DateTimeFormatter;</span><br><span class="line">import java.util.Set;</span><br><span class="line">import java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@Service</span><br><span class="line">@RequiredArgsConstructor</span><br><span class="line">public class OrderTimeoutService &#123;</span><br><span class="line">    </span><br><span class="line">    private final RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    private final RocketMQTemplate rocketMQTemplate;</span><br><span class="line">    private final OrderService orderService;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;order.timeout.unpaid:1800&#125;&quot;)</span><br><span class="line">    private Integer unpaidTimeoutSeconds;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;order.timeout.unreceived:604800&#125;&quot;)</span><br><span class="line">    private Integer unreceivedTimeoutSeconds;</span><br><span class="line">    </span><br><span class="line">    private static final String ORDER_TIMEOUT_ZSET = &quot;order:timeout:zset&quot;;</span><br><span class="line">    private static final String ORDER_UNPAID_PREFIX = &quot;order:unpaid:&quot;;</span><br><span class="line">    private static final String ORDER_UNRECEIVED_PREFIX = &quot;order:unreceived:&quot;;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ·»åŠ è®¢å•åˆ°è¶…æ—¶é˜Ÿåˆ—</span><br><span class="line">     */</span><br><span class="line">    public void addOrderToTimeoutQueue(String orderNo, Integer orderStatus, LocalDateTime createTime) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            long score = 0;</span><br><span class="line">            String key = &quot;&quot;;</span><br><span class="line">            </span><br><span class="line">            switch (orderStatus) &#123;</span><br><span class="line">                case 0: // å¾…æ”¯ä»˜</span><br><span class="line">                    score = createTime.plusSeconds(unpaidTimeoutSeconds)</span><br><span class="line">                            .atZone(java.time.ZoneId.systemDefault())</span><br><span class="line">                            .toEpochSecond();</span><br><span class="line">                    key = ORDER_UNPAID_PREFIX + orderNo;</span><br><span class="line">                    break;</span><br><span class="line">                case 2: // å·²å‘è´§</span><br><span class="line">                    // è¿™é‡Œéœ€è¦å‘è´§æ—¶é—´ï¼Œç®€åŒ–å¤„ç†ä½¿ç”¨å½“å‰æ—¶é—´</span><br><span class="line">                    score = LocalDateTime.now().plusSeconds(unreceivedTimeoutSeconds)</span><br><span class="line">                            .atZone(java.time.ZoneId.systemDefault())</span><br><span class="line">                            .toEpochSecond();</span><br><span class="line">                    key = ORDER_UNRECEIVED_PREFIX + orderNo;</span><br><span class="line">                    break;</span><br><span class="line">                default:</span><br><span class="line">                    return;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // æ·»åŠ åˆ°æœ‰åºé›†åˆ</span><br><span class="line">            redisTemplate.opsForZSet().add(ORDER_TIMEOUT_ZSET, key, score);</span><br><span class="line">            </span><br><span class="line">            // è®¾ç½®è®¢å•è¯¦æƒ…ï¼ˆç”¨äºæ¢å¤ï¼‰</span><br><span class="line">            OrderTimeoutInfo timeoutInfo = OrderTimeoutInfo.builder()</span><br><span class="line">                    .orderNo(orderNo)</span><br><span class="line">                    .orderStatus(orderStatus)</span><br><span class="line">                    .createTime(createTime)</span><br><span class="line">                    .timeoutTime(LocalDateTime.now().plusSeconds(</span><br><span class="line">                            orderStatus == 0 ? unpaidTimeoutSeconds : unreceivedTimeoutSeconds))</span><br><span class="line">                    .build();</span><br><span class="line">            </span><br><span class="line">            redisTemplate.opsForValue().set(key, timeoutInfo, </span><br><span class="line">                    (orderStatus == 0 ? unpaidTimeoutSeconds : unreceivedTimeoutSeconds) + 3600, </span><br><span class="line">                    TimeUnit.SECONDS);</span><br><span class="line">            </span><br><span class="line">            log.info(&quot;æ·»åŠ è®¢å•åˆ°è¶…æ—¶é˜Ÿåˆ—ï¼Œè®¢å•å·ï¼š&#123;&#125;ï¼ŒçŠ¶æ€ï¼š&#123;&#125;ï¼Œè¶…æ—¶æ—¶é—´ï¼š&#123;&#125;&quot;, </span><br><span class="line">                    orderNo, orderStatus, </span><br><span class="line">                    LocalDateTime.ofEpochSecond(score, 0, java.time.ZoneOffset.ofHours(8)));</span><br><span class="line">                    </span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;æ·»åŠ è®¢å•åˆ°è¶…æ—¶é˜Ÿåˆ—å¤±è´¥ï¼Œè®¢å•å·ï¼š&#123;&#125;&quot;, orderNo, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * ä»è¶…æ—¶é˜Ÿåˆ—ç§»é™¤è®¢å•</span><br><span class="line">     */</span><br><span class="line">    public void removeOrderFromTimeoutQueue(String orderNo, Integer orderStatus) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            String key = &quot;&quot;;</span><br><span class="line">            </span><br><span class="line">            switch (orderStatus) &#123;</span><br><span class="line">                case 0:</span><br><span class="line">                    key = ORDER_UNPAID_PREFIX + orderNo;</span><br><span class="line">                    break;</span><br><span class="line">                case 2:</span><br><span class="line">                    key = ORDER_UNRECEIVED_PREFIX + orderNo;</span><br><span class="line">                    break;</span><br><span class="line">                default:</span><br><span class="line">                    return;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // ä»æœ‰åºé›†åˆç§»é™¤</span><br><span class="line">            redisTemplate.opsForZSet().remove(ORDER_TIMEOUT_ZSET, key);</span><br><span class="line">            </span><br><span class="line">            // åˆ é™¤è®¢å•è¯¦æƒ…</span><br><span class="line">            redisTemplate.delete(key);</span><br><span class="line">            </span><br><span class="line">            log.info(&quot;ä»è¶…æ—¶é˜Ÿåˆ—ç§»é™¤è®¢å•ï¼Œè®¢å•å·ï¼š&#123;&#125;ï¼ŒçŠ¶æ€ï¼š&#123;&#125;&quot;, orderNo, orderStatus);</span><br><span class="line">            </span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;ä»è¶…æ—¶é˜Ÿåˆ—ç§»é™¤è®¢å•å¤±è´¥ï¼Œè®¢å•å·ï¼š&#123;&#125;&quot;, orderNo, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å¤„ç†è¶…æ—¶è®¢å•ï¼ˆæ¯10ç§’æ‰§è¡Œä¸€æ¬¡ï¼‰</span><br><span class="line">     */</span><br><span class="line">    @Scheduled(fixedDelay = 10000)</span><br><span class="line">    public void processTimeoutOrders() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            long now = System.currentTimeMillis() / 1000;</span><br><span class="line">            </span><br><span class="line">            // è·å–å·²è¶…æ—¶çš„è®¢å•</span><br><span class="line">            Set&lt;Object&gt; timeoutOrders = redisTemplate.opsForZSet()</span><br><span class="line">                    .rangeByScore(ORDER_TIMEOUT_ZSET, 0, now);</span><br><span class="line">            </span><br><span class="line">            if (timeoutOrders == null || timeoutOrders.isEmpty()) &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            for (Object keyObj : timeoutOrders) &#123;</span><br><span class="line">                String key = (String) keyObj;</span><br><span class="line">                </span><br><span class="line">                try &#123;</span><br><span class="line">                    // è·å–è®¢å•è¶…æ—¶ä¿¡æ¯</span><br><span class="line">                    OrderTimeoutInfo timeoutInfo = (OrderTimeoutInfo) </span><br><span class="line">                            redisTemplate.opsForValue().get(key);</span><br><span class="line">                    </span><br><span class="line">                    if (timeoutInfo == null) &#123;</span><br><span class="line">                        // ä¿¡æ¯å·²è¿‡æœŸï¼Œä»æœ‰åºé›†åˆç§»é™¤</span><br><span class="line">                        redisTemplate.opsForZSet().remove(ORDER_TIMEOUT_ZSET, key);</span><br><span class="line">                        continue;</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    // å‘é€è¶…æ—¶æ¶ˆæ¯åˆ°RocketMQ</span><br><span class="line">                    sendTimeoutMessage(timeoutInfo);</span><br><span class="line">                    </span><br><span class="line">                    // ä»æœ‰åºé›†åˆç§»é™¤</span><br><span class="line">                    redisTemplate.opsForZSet().remove(ORDER_TIMEOUT_ZSET, key);</span><br><span class="line">                    </span><br><span class="line">                    log.info(&quot;å¤„ç†è¶…æ—¶è®¢å•ï¼Œè®¢å•å·ï¼š&#123;&#125;ï¼ŒçŠ¶æ€ï¼š&#123;&#125;&quot;, </span><br><span class="line">                            timeoutInfo.getOrderNo(), timeoutInfo.getOrderStatus());</span><br><span class="line">                            </span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    log.error(&quot;å¤„ç†è¶…æ—¶è®¢å•å¤±è´¥ï¼Œkeyï¼š&#123;&#125;&quot;, key, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;å¤„ç†è¶…æ—¶è®¢å•ä»»åŠ¡å¼‚å¸¸&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å‘é€è¶…æ—¶æ¶ˆæ¯</span><br><span class="line">     */</span><br><span class="line">    private void sendTimeoutMessage(OrderTimeoutInfo timeoutInfo) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            OrderTimeoutMessage message = OrderTimeoutMessage.builder()</span><br><span class="line">                    .orderNo(timeoutInfo.getOrderNo())</span><br><span class="line">                    .orderStatus(timeoutInfo.getOrderStatus())</span><br><span class="line">                    .timeoutTime(LocalDateTime.now())</span><br><span class="line">                    .build();</span><br><span class="line">            </span><br><span class="line">            SendResult sendResult = rocketMQTemplate.syncSend(</span><br><span class="line">                    &quot;ORDER_TIMEOUT_TOPIC&quot;,</span><br><span class="line">                    message</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            if (sendResult.getSendStatus() == SendStatus.SEND_OK) &#123;</span><br><span class="line">                log.info(&quot;å‘é€è®¢å•è¶…æ—¶æ¶ˆæ¯æˆåŠŸï¼Œè®¢å•å·ï¼š&#123;&#125;&quot;, timeoutInfo.getOrderNo());</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                log.error(&quot;å‘é€è®¢å•è¶…æ—¶æ¶ˆæ¯å¤±è´¥ï¼Œè®¢å•å·ï¼š&#123;&#125;&quot;, timeoutInfo.getOrderNo());</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;å‘é€è®¢å•è¶…æ—¶æ¶ˆæ¯å¼‚å¸¸ï¼Œè®¢å•å·ï¼š&#123;&#125;&quot;, timeoutInfo.getOrderNo(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è¶…æ—¶æ¶ˆæ¯æ¶ˆè´¹è€…</span><br><span class="line">     */</span><br><span class="line">    @Service</span><br><span class="line">    @RequiredArgsConstructor</span><br><span class="line">    class OrderTimeoutConsumer &#123;</span><br><span class="line">        </span><br><span class="line">        private final OrderService orderService;</span><br><span class="line">        </span><br><span class="line">        @RocketMQMessageListener(</span><br><span class="line">                topic = &quot;ORDER_TIMEOUT_TOPIC&quot;,</span><br><span class="line">                consumerGroup = &quot;order-timeout-consumer-group&quot;</span><br><span class="line">        )</span><br><span class="line">        public void consumeTimeoutMessage(OrderTimeoutMessage message) &#123;</span><br><span class="line">            log.info(&quot;æ”¶åˆ°è®¢å•è¶…æ—¶æ¶ˆæ¯ï¼š&#123;&#125;&quot;, message);</span><br><span class="line">            </span><br><span class="line">            try &#123;</span><br><span class="line">                switch (message.getOrderStatus()) &#123;</span><br><span class="line">                    case 0: // æœªæ”¯ä»˜è¶…æ—¶</span><br><span class="line">                        orderService.cancelOrderByTimeout(message.getOrderNo());</span><br><span class="line">                        break;</span><br><span class="line">                    case 2: // æœªæ”¶è´§è¶…æ—¶</span><br><span class="line">                        orderService.confirmOrderByTimeout(message.getOrderNo());</span><br><span class="line">                        break;</span><br><span class="line">                    default:</span><br><span class="line">                        log.warn(&quot;æœªçŸ¥çš„è®¢å•çŠ¶æ€ï¼š&#123;&#125;&quot;, message.getOrderStatus());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                log.error(&quot;å¤„ç†è®¢å•è¶…æ—¶æ¶ˆæ¯å¤±è´¥ï¼Œè®¢å•å·ï¼š&#123;&#125;&quot;, message.getOrderNo(), e);</span><br><span class="line">                // å¯ä»¥åŠ å…¥é‡è¯•é˜Ÿåˆ—</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// è®¢å•è¶…æ—¶ä¿¡æ¯</span><br><span class="line">@Data</span><br><span class="line">@Builder</span><br><span class="line">class OrderTimeoutInfo &#123;</span><br><span class="line">    private String orderNo;</span><br><span class="line">    private Integer orderStatus;</span><br><span class="line">    private LocalDateTime createTime;</span><br><span class="line">    private LocalDateTime timeoutTime;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// è®¢å•è¶…æ—¶æ¶ˆæ¯</span><br><span class="line">@Data</span><br><span class="line">@Builder</span><br><span class="line">class OrderTimeoutMessage &#123;</span><br><span class="line">    private String orderNo;</span><br><span class="line">    private Integer orderStatus;</span><br><span class="line">    private LocalDateTime timeoutTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-åˆ†åº“åˆ†è¡¨é…ç½®å’ŒæŸ¥è¯¢ä¼˜åŒ–"><a href="#3-åˆ†åº“åˆ†è¡¨é…ç½®å’ŒæŸ¥è¯¢ä¼˜åŒ–" class="headerlink" title="3. åˆ†åº“åˆ†è¡¨é…ç½®å’ŒæŸ¥è¯¢ä¼˜åŒ–"></a>3. åˆ†åº“åˆ†è¡¨é…ç½®å’ŒæŸ¥è¯¢ä¼˜åŒ–</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.order.config;</span><br><span class="line"></span><br><span class="line">import com.google.common.collect.Range;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.apache.shardingsphere.api.config.sharding.ShardingRuleConfiguration;</span><br><span class="line">import org.apache.shardingsphere.api.config.sharding.TableRuleConfiguration;</span><br><span class="line">import org.apache.shardingsphere.api.config.sharding.strategy.StandardShardingStrategyConfiguration;</span><br><span class="line">import org.apache.shardingsphere.shardingjdbc.api.ShardingDataSourceFactory;</span><br><span class="line">import org.springframework.beans.factory.annotation.Value;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.context.annotation.Primary;</span><br><span class="line"></span><br><span class="line">import javax.sql.DataSource;</span><br><span class="line">import java.sql.SQLException;</span><br><span class="line">import java.util.*;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@Configuration</span><br><span class="line">public class ShardingConfig &#123;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;order.sharding.table-count:8&#125;&quot;)</span><br><span class="line">    private Integer tableCount;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;order.sharding.database-count:2&#125;&quot;)</span><br><span class="line">    private Integer databaseCount;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * é…ç½®åˆ†åº“åˆ†è¡¨æ•°æ®æº</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    @Primary</span><br><span class="line">    public DataSource shardingDataSource() throws SQLException &#123;</span><br><span class="line">        // é…ç½®çœŸå®æ•°æ®æº</span><br><span class="line">        Map&lt;String, DataSource&gt; dataSourceMap = createDataSourceMap();</span><br><span class="line">        </span><br><span class="line">        // é…ç½®åˆ†ç‰‡è§„åˆ™</span><br><span class="line">        ShardingRuleConfiguration shardingRuleConfig = new ShardingRuleConfiguration();</span><br><span class="line">        </span><br><span class="line">        // é…ç½®è®¢å•è¡¨åˆ†ç‰‡è§„åˆ™</span><br><span class="line">        TableRuleConfiguration orderTableRuleConfig = new TableRuleConfiguration(</span><br><span class="line">                &quot;order&quot;, </span><br><span class="line">                &quot;ds$&#123;0..&quot; + (databaseCount-1) + &quot;&#125;.order_$&#123;0..&quot; + (tableCount-1) + &quot;&#125;&quot;</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        // åˆ†åº“ç­–ç•¥ï¼ˆæŒ‰ç”¨æˆ·IDåˆ†åº“ï¼‰</span><br><span class="line">        orderTableRuleConfig.setDatabaseShardingStrategyConfig(</span><br><span class="line">                new StandardShardingStrategyConfiguration(</span><br><span class="line">                        &quot;user_id&quot;, </span><br><span class="line">                        new DatabaseShardingAlgorithm()</span><br><span class="line">                )</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        // åˆ†è¡¨ç­–ç•¥ï¼ˆæŒ‰è®¢å•åˆ›å»ºæ—¶é—´åˆ†è¡¨ï¼‰</span><br><span class="line">        orderTableRuleConfig.setTableShardingStrategyConfig(</span><br><span class="line">                new StandardShardingStrategyConfiguration(</span><br><span class="line">                        &quot;create_time&quot;, </span><br><span class="line">                        new TableShardingAlgorithm()</span><br><span class="line">                )</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        // é…ç½®è®¢å•å•†å“è¡¨åˆ†ç‰‡è§„åˆ™ï¼ˆä¸è®¢å•è¡¨ç»‘å®šï¼‰</span><br><span class="line">        TableRuleConfiguration orderItemTableRuleConfig = new TableRuleConfiguration(</span><br><span class="line">                &quot;order_item&quot;, </span><br><span class="line">                &quot;ds$&#123;0..&quot; + (databaseCount-1) + &quot;&#125;.order_item_$&#123;0..&quot; + (tableCount-1) + &quot;&#125;&quot;</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        orderItemTableRuleConfig.setDatabaseShardingStrategyConfig(</span><br><span class="line">                new StandardShardingStrategyConfiguration(</span><br><span class="line">                        &quot;order_id&quot;, </span><br><span class="line">                        new OrderIdShardingAlgorithm()</span><br><span class="line">                )</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        // æ·»åŠ åˆ°åˆ†ç‰‡è§„åˆ™</span><br><span class="line">        shardingRuleConfig.getTableRuleConfigs().add(orderTableRuleConfig);</span><br><span class="line">        shardingRuleConfig.getTableRuleConfigs().add(orderItemTableRuleConfig);</span><br><span class="line">        </span><br><span class="line">        // è®¾ç½®ç»‘å®šè¡¨ï¼ˆè®¢å•è¡¨å’Œè®¢å•å•†å“è¡¨ï¼‰</span><br><span class="line">        List&lt;String&gt; bindingTables = new ArrayList&lt;&gt;();</span><br><span class="line">        bindingTables.add(&quot;order&quot;);</span><br><span class="line">        bindingTables.add(&quot;order_item&quot;);</span><br><span class="line">        shardingRuleConfig.getBindingTableGroups().addAll(bindingTables);</span><br><span class="line">        </span><br><span class="line">        // åˆ›å»ºæ•°æ®æº</span><br><span class="line">        return ShardingDataSourceFactory.createDataSource(</span><br><span class="line">                dataSourceMap, </span><br><span class="line">                shardingRuleConfig, </span><br><span class="line">                new Properties()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆ›å»ºæ•°æ®æºæ˜ å°„</span><br><span class="line">     */</span><br><span class="line">    private Map&lt;String, DataSource&gt; createDataSourceMap() &#123;</span><br><span class="line">        Map&lt;String, DataSource&gt; dataSourceMap = new HashMap&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        for (int i = 0; i &lt; databaseCount; i++) &#123;</span><br><span class="line">            DataSource dataSource = createSingleDataSource(i);</span><br><span class="line">            dataSourceMap.put(&quot;ds&quot; + i, dataSource);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return dataSourceMap;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆ›å»ºå•ä¸ªæ•°æ®æº</span><br><span class="line">     */</span><br><span class="line">    private DataSource createSingleDataSource(int databaseIndex) &#123;</span><br><span class="line">        // è¿™é‡Œä½¿ç”¨Druidæ•°æ®æº</span><br><span class="line">        DruidDataSource dataSource = new DruidDataSource();</span><br><span class="line">        dataSource.setDriverClassName(&quot;com.mysql.cj.jdbc.Driver&quot;);</span><br><span class="line">        dataSource.setUrl(&quot;jdbc:mysql://localhost:3306/shop_order_&quot; + </span><br><span class="line">                         databaseIndex + &quot;?useUnicode=true&amp;characterEncoding=UTF-8&quot;);</span><br><span class="line">        dataSource.setUsername(&quot;root&quot;);</span><br><span class="line">        dataSource.setPassword(&quot;root123&quot;);</span><br><span class="line">        dataSource.setInitialSize(5);</span><br><span class="line">        dataSource.setMinIdle(5);</span><br><span class="line">        dataSource.setMaxActive(20);</span><br><span class="line">        dataSource.setMaxWait(60000);</span><br><span class="line">        dataSource.setTimeBetweenEvictionRunsMillis(60000);</span><br><span class="line">        dataSource.setMinEvictableIdleTimeMillis(300000);</span><br><span class="line">        </span><br><span class="line">        return dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æ•°æ®åº“åˆ†ç‰‡ç®—æ³•ï¼ˆæŒ‰ç”¨æˆ·IDï¼‰</span><br><span class="line">class DatabaseShardingAlgorithm implements PreciseShardingAlgorithm&lt;Long&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public String doSharding(Collection&lt;String&gt; availableTargetNames, </span><br><span class="line">                            PreciseShardingValue&lt;Long&gt; shardingValue) &#123;</span><br><span class="line">        Long userId = shardingValue.getValue();</span><br><span class="line">        </span><br><span class="line">        // ç®€å•å–æ¨¡ç®—æ³•</span><br><span class="line">        int databaseIndex = (int) (userId % availableTargetNames.size());</span><br><span class="line">        </span><br><span class="line">        for (String databaseName : availableTargetNames) &#123;</span><br><span class="line">            if (databaseName.endsWith(String.valueOf(databaseIndex))) &#123;</span><br><span class="line">                return databaseName;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        throw new IllegalArgumentException(&quot;æœªæ‰¾åˆ°åˆé€‚çš„æ•°æ®åº“&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// è¡¨åˆ†ç‰‡ç®—æ³•ï¼ˆæŒ‰åˆ›å»ºæ—¶é—´ï¼‰</span><br><span class="line">class TableShardingAlgorithm implements PreciseShardingAlgorithm&lt;LocalDateTime&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    private static final DateTimeFormatter MONTH_FORMATTER = </span><br><span class="line">            DateTimeFormatter.ofPattern(&quot;yyyyMM&quot;);</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public String doSharding(Collection&lt;String&gt; availableTargetNames, </span><br><span class="line">                            PreciseShardingValue&lt;LocalDateTime&gt; shardingValue) &#123;</span><br><span class="line">        LocalDateTime createTime = shardingValue.getValue();</span><br><span class="line">        String month = createTime.format(MONTH_FORMATTER);</span><br><span class="line">        </span><br><span class="line">        // æ ¹æ®æœˆä»½è®¡ç®—è¡¨å</span><br><span class="line">        String logicTableName = shardingValue.getLogicTableName();</span><br><span class="line">        String targetTable = logicTableName + &quot;_&quot; + month;</span><br><span class="line">        </span><br><span class="line">        if (availableTargetNames.contains(targetTable)) &#123;</span><br><span class="line">            return targetTable;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        throw new IllegalArgumentException(&quot;æœªæ‰¾åˆ°åˆé€‚çš„è¡¨: &quot; + targetTable);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public Collection&lt;String&gt; doSharding(Collection&lt;String&gt; availableTargetNames, </span><br><span class="line">                                        RangeShardingValue&lt;LocalDateTime&gt; shardingValue) &#123;</span><br><span class="line">        // èŒƒå›´æŸ¥è¯¢æ—¶ï¼Œè¿”å›æ‰€æœ‰å¯èƒ½çš„è¡¨</span><br><span class="line">        List&lt;String&gt; result = new ArrayList&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        Range&lt;LocalDateTime&gt; range = shardingValue.getValueRange();</span><br><span class="line">        LocalDateTime lower = range.hasLowerBound() ? range.lowerEndpoint() : null;</span><br><span class="line">        LocalDateTime upper = range.hasUpperBound() ? range.upperEndpoint() : null;</span><br><span class="line">        </span><br><span class="line">        // è®¡ç®—æ—¶é—´èŒƒå›´å†…çš„æ‰€æœ‰æœˆä»½è¡¨</span><br><span class="line">        LocalDateTime current = lower != null ? lower : LocalDateTime.now().minusYears(1);</span><br><span class="line">        LocalDateTime end = upper != null ? upper : LocalDateTime.now();</span><br><span class="line">        </span><br><span class="line">        while (!current.isAfter(end)) &#123;</span><br><span class="line">            String month = current.format(MONTH_FORMATTER);</span><br><span class="line">            String tableName = shardingValue.getLogicTableName() + &quot;_&quot; + month;</span><br><span class="line">            </span><br><span class="line">            if (availableTargetNames.contains(tableName)) &#123;</span><br><span class="line">                result.add(tableName);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            current = current.plusMonths(1);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// è®¢å•IDåˆ†ç‰‡ç®—æ³•ï¼ˆç”¨äºå…³è”è¡¨ï¼‰</span><br><span class="line">class OrderIdShardingAlgorithm implements PreciseShardingAlgorithm&lt;Long&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public String doSharding(Collection&lt;String&gt; availableTargetNames, </span><br><span class="line">                            PreciseShardingValue&lt;Long&gt; shardingValue) &#123;</span><br><span class="line">        Long orderId = shardingValue.getValue();</span><br><span class="line">        </span><br><span class="line">        // ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ï¼Œç¡®ä¿è®¢å•å’Œè®¢å•å•†å“åœ¨åŒä¸€ä¸ªè¡¨ä¸­</span><br><span class="line">        int tableIndex = Math.abs(orderId.hashCode()) % availableTargetNames.size();</span><br><span class="line">        </span><br><span class="line">        for (String tableName : availableTargetNames) &#123;</span><br><span class="line">            if (tableName.endsWith(&quot;_&quot; + tableIndex)) &#123;</span><br><span class="line">                return tableName;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        throw new IllegalArgumentException(&quot;æœªæ‰¾åˆ°åˆé€‚çš„è¡¨&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// åˆ†åº“åˆ†è¡¨æŸ¥è¯¢ä¼˜åŒ–</span><br><span class="line">@Service</span><br><span class="line">@Slf4j</span><br><span class="line">class ShardingQueryOptimizer &#123;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * ä¼˜åŒ–è®¢å•æŸ¥è¯¢ï¼ˆé¿å…å…¨è¡¨æ‰«æï¼‰</span><br><span class="line">     */</span><br><span class="line">    public String optimizeOrderQuery(OrderQueryRequest request) &#123;</span><br><span class="line">        StringBuilder sql = new StringBuilder();</span><br><span class="line">        List&lt;Object&gt; params = new ArrayList&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        sql.append(&quot;SELECT * FROM order_&quot;);</span><br><span class="line">        </span><br><span class="line">        // æ ¹æ®æ—¶é—´èŒƒå›´ç¡®å®šæŸ¥è¯¢å“ªäº›è¡¨</span><br><span class="line">        if (request.getStartTime() != null &amp;&amp; request.getEndTime() != null) &#123;</span><br><span class="line">            // è®¡ç®—æ—¶é—´èŒƒå›´å†…çš„æœˆä»½</span><br><span class="line">            List&lt;String&gt; months = getMonthsBetween(</span><br><span class="line">                    request.getStartTime(), </span><br><span class="line">                    request.getEndTime()</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            if (months.size() == 1) &#123;</span><br><span class="line">                // å•æœˆæŸ¥è¯¢</span><br><span class="line">                sql.append(months.get(0));</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                // å¤šæœˆæŸ¥è¯¢ï¼Œä½¿ç”¨UNION ALL</span><br><span class="line">                return buildUnionQuery(months, request, params);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // æ²¡æœ‰æ—¶é—´èŒƒå›´ï¼ŒæŸ¥è¯¢æœ€è¿‘3ä¸ªæœˆ</span><br><span class="line">            sql.append(getCurrentMonth());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        sql.append(&quot; WHERE 1=1&quot;);</span><br><span class="line">        </span><br><span class="line">        // æ·»åŠ å…¶ä»–æŸ¥è¯¢æ¡ä»¶</span><br><span class="line">        if (request.getUserId() != null) &#123;</span><br><span class="line">            sql.append(&quot; AND user_id = ?&quot;);</span><br><span class="line">            params.add(request.getUserId());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        if (request.getStatus() != null) &#123;</span><br><span class="line">            sql.append(&quot; AND status = ?&quot;);</span><br><span class="line">            params.add(request.getStatus());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        sql.append(&quot; ORDER BY create_time DESC LIMIT ?, ?&quot;);</span><br><span class="line">        params.add((request.getPageNum() - 1) * request.getPageSize());</span><br><span class="line">        params.add(request.getPageSize());</span><br><span class="line">        </span><br><span class="line">        return sql.toString();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ„å»ºUNION ALLæŸ¥è¯¢</span><br><span class="line">     */</span><br><span class="line">    private String buildUnionQuery(List&lt;String&gt; months, OrderQueryRequest request, </span><br><span class="line">                                  List&lt;Object&gt; params) &#123;</span><br><span class="line">        StringBuilder unionSql = new StringBuilder();</span><br><span class="line">        </span><br><span class="line">        for (int i = 0; i &lt; months.size(); i++) &#123;</span><br><span class="line">            if (i &gt; 0) &#123;</span><br><span class="line">                unionSql.append(&quot; UNION ALL &quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            unionSql.append(&quot;(SELECT * FROM order_&quot;)</span><br><span class="line">                   .append(months.get(i))</span><br><span class="line">                   .append(&quot; WHERE 1=1&quot;);</span><br><span class="line">            </span><br><span class="line">            if (request.getUserId() != null) &#123;</span><br><span class="line">                unionSql.append(&quot; AND user_id = ?&quot;);</span><br><span class="line">                params.add(request.getUserId());</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            if (request.getStatus() != null) &#123;</span><br><span class="line">                unionSql.append(&quot; AND status = ?&quot;);</span><br><span class="line">                params.add(request.getStatus());</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            unionSql.append(&quot;)&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        unionSql.append(&quot; ORDER BY create_time DESC LIMIT ?, ?&quot;);</span><br><span class="line">        params.add((request.getPageNum() - 1) * request.getPageSize());</span><br><span class="line">        params.add(request.getPageSize());</span><br><span class="line">        </span><br><span class="line">        return unionSql.toString();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è·å–ä¸¤ä¸ªæ—¥æœŸä¹‹é—´çš„æ‰€æœ‰æœˆä»½</span><br><span class="line">     */</span><br><span class="line">    private List&lt;String&gt; getMonthsBetween(LocalDateTime start, LocalDateTime end) &#123;</span><br><span class="line">        List&lt;String&gt; months = new ArrayList&lt;&gt;();</span><br><span class="line">        DateTimeFormatter formatter = DateTimeFormatter.ofPattern(&quot;yyyyMM&quot;);</span><br><span class="line">        </span><br><span class="line">        LocalDateTime current = start.withDayOfMonth(1);</span><br><span class="line">        </span><br><span class="line">        while (!current.isAfter(end)) &#123;</span><br><span class="line">            months.add(current.format(formatter));</span><br><span class="line">            current = current.plusMonths(1);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return months;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è·å–å½“å‰æœˆä»½</span><br><span class="line">     */</span><br><span class="line">    private String getCurrentMonth() &#123;</span><br><span class="line">        return LocalDateTime.now().format(DateTimeFormatter.ofPattern(&quot;yyyyMM&quot;));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è®¢å•ç»Ÿè®¡æŸ¥è¯¢ä¼˜åŒ–ï¼ˆä½¿ç”¨æ±‡æ€»è¡¨ï¼‰</span><br><span class="line">     */</span><br><span class="line">    public OrderStatistics getOrderStatistics(LocalDateTime startTime, </span><br><span class="line">                                             LocalDateTime endTime) &#123;</span><br><span class="line">        // 1. å…ˆæŸ¥æ±‡æ€»è¡¨</span><br><span class="line">        OrderStatistics summary = getOrderSummaryFromStatisticsTable(startTime, endTime);</span><br><span class="line">        </span><br><span class="line">        // 2. å¦‚æœæ±‡æ€»è¡¨æ•°æ®ä¸å®Œæ•´ï¼Œå†æŸ¥è¯¦ç»†è¡¨</span><br><span class="line">        if (summary == null || summary.isIncomplete()) &#123;</span><br><span class="line">            summary = calculateOrderStatisticsFromDetail(startTime, endTime);</span><br><span class="line">            </span><br><span class="line">            // 3. æ›´æ–°æ±‡æ€»è¡¨</span><br><span class="line">            updateOrderSummaryTable(startTime, endTime, summary);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return summary;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * ä»æ±‡æ€»è¡¨è·å–è®¢å•ç»Ÿè®¡</span><br><span class="line">     */</span><br><span class="line">    private OrderStatistics getOrderSummaryFromStatisticsTable(LocalDateTime startTime, </span><br><span class="line">                                                              LocalDateTime endTime) &#123;</span><br><span class="line">        // å®ç°æŸ¥è¯¢é€»è¾‘</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * ä»è¯¦ç»†è¡¨è®¡ç®—è®¢å•ç»Ÿè®¡</span><br><span class="line">     */</span><br><span class="line">    private OrderStatistics calculateOrderStatisticsFromDetail(LocalDateTime startTime, </span><br><span class="line">                                                              LocalDateTime endTime) &#123;</span><br><span class="line">        // ä½¿ç”¨åˆ†é¡µæŸ¥è¯¢ï¼Œé¿å…å¤§æ•°æ®é‡æŸ¥è¯¢</span><br><span class="line">        OrderStatistics statistics = new OrderStatistics();</span><br><span class="line">        int pageNum = 1;</span><br><span class="line">        int pageSize = 1000;</span><br><span class="line">        boolean hasNext = true;</span><br><span class="line">        </span><br><span class="line">        while (hasNext) &#123;</span><br><span class="line">            // åˆ†æ‰¹æŸ¥è¯¢</span><br><span class="line">            List&lt;Order&gt; orders = getOrdersByTimeRange(startTime, endTime, pageNum, pageSize);</span><br><span class="line">            </span><br><span class="line">            // ç»Ÿè®¡</span><br><span class="line">            for (Order order : orders) &#123;</span><br><span class="line">                statistics.addOrder(order);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            hasNext = orders.size() == pageSize;</span><br><span class="line">            pageNum++;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return statistics;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-è®¢å•é€€æ¬¾æµç¨‹å®ç°"><a href="#4-è®¢å•é€€æ¬¾æµç¨‹å®ç°" class="headerlink" title="4. è®¢å•é€€æ¬¾æµç¨‹å®ç°"></a>4. è®¢å•é€€æ¬¾æµç¨‹å®ç°</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.order.service.impl;</span><br><span class="line"></span><br><span class="line">import com.shophub.order.constants.OrderConstants;</span><br><span class="line">import com.shophub.order.entity.OrderRefund;</span><br><span class="line">import com.shophub.order.service.OrderRefundService;</span><br><span class="line">import io.seata.spring.annotation.GlobalTransactional;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.apache.rocketmq.spring.core.RocketMQTemplate;</span><br><span class="line">import org.springframework.beans.factory.annotation.Value;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line">import org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line">import java.math.BigDecimal;</span><br><span class="line">import java.time.LocalDateTime;</span><br><span class="line">import java.util.UUID;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@Service</span><br><span class="line">public class OrderRefundServiceImpl implements OrderRefundService &#123;</span><br><span class="line">    </span><br><span class="line">    private final RocketMQTemplate rocketMQTemplate;</span><br><span class="line">    private final OrderService orderService;</span><br><span class="line">    private final PaymentService paymentService;</span><br><span class="line">    private final InventoryService inventoryService;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;refund.max-amount:10000&#125;&quot;)</span><br><span class="line">    private BigDecimal maxRefundAmount;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    @GlobalTransactional(timeoutMills = 120000, name = &quot;apply-refund-tx&quot;)</span><br><span class="line">    @Transactional(rollbackFor = Exception.class)</span><br><span class="line">    public RefundResult applyRefund(RefundRequest request) &#123;</span><br><span class="line">        log.info(&quot;ç”³è¯·é€€æ¬¾ï¼Œè¯·æ±‚å‚æ•°ï¼š&#123;&#125;&quot;, request);</span><br><span class="line">        </span><br><span class="line">        // 1. å‚æ•°æ ¡éªŒ</span><br><span class="line">        validateRefundRequest(request);</span><br><span class="line">        </span><br><span class="line">        // 2. æŸ¥è¯¢è®¢å•</span><br><span class="line">        Order order = orderService.getOrderByNo(request.getOrderNo());</span><br><span class="line">        if (order == null) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.RESOURCE_NOT_FOUND, &quot;è®¢å•ä¸å­˜åœ¨&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 3. æ ¡éªŒè®¢å•çŠ¶æ€æ˜¯å¦å…è®¸é€€æ¬¾</span><br><span class="line">        if (!canRefund(order)) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.BUSINESS_ERROR, &quot;è®¢å•çŠ¶æ€ä¸å…è®¸é€€æ¬¾&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 4. æ ¡éªŒé€€æ¬¾é‡‘é¢</span><br><span class="line">        BigDecimal refundAmount = calculateRefundAmount(order, request);</span><br><span class="line">        if (refundAmount.compareTo(maxRefundAmount) &gt; 0) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.BUSINESS_ERROR, </span><br><span class="line">                    &quot;é€€æ¬¾é‡‘é¢è¶…è¿‡æœ€å¤§é™é¢ï¼š&quot; + maxRefundAmount);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 5. åˆ›å»ºé€€æ¬¾è®°å½•</span><br><span class="line">        OrderRefund refund = createRefundRecord(order, request, refundAmount);</span><br><span class="line">        </span><br><span class="line">        // 6. æ›´æ–°è®¢å•çŠ¶æ€</span><br><span class="line">        order.setStatus(OrderConstants.Status.REFUNDING);</span><br><span class="line">        orderService.updateOrder(order);</span><br><span class="line">        </span><br><span class="line">        // 7. è®°å½•æ“ä½œæ—¥å¿—</span><br><span class="line">        saveRefundOperationLog(refund, &quot;ç”³è¯·é€€æ¬¾&quot;);</span><br><span class="line">        </span><br><span class="line">        // 8. å‘é€é€€æ¬¾ç”³è¯·æ¶ˆæ¯</span><br><span class="line">        sendRefundApplyMessage(refund);</span><br><span class="line">        </span><br><span class="line">        log.info(&quot;é€€æ¬¾ç”³è¯·æˆåŠŸï¼Œé€€æ¬¾å•å·ï¼š&#123;&#125;ï¼Œé‡‘é¢ï¼š&#123;&#125;&quot;, </span><br><span class="line">                refund.getRefundNo(), refund.getRefundAmount());</span><br><span class="line">        </span><br><span class="line">        return RefundResult.builder()</span><br><span class="line">                .refundNo(refund.getRefundNo())</span><br><span class="line">                .refundAmount(refund.getRefundAmount())</span><br><span class="line">                .estimatedTime(LocalDateTime.now().plusDays(3))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    @GlobalTransactional(timeoutMills = 120000, name = &quot;process-refund-tx&quot;)</span><br><span class="line">    @Transactional(rollbackFor = Exception.class)</span><br><span class="line">    public boolean processRefund(String refundNo, Long operatorId) &#123;</span><br><span class="line">        log.info(&quot;å¤„ç†é€€æ¬¾ï¼Œé€€æ¬¾å•å·ï¼š&#123;&#125;ï¼Œæ“ä½œäººï¼š&#123;&#125;&quot;, refundNo, operatorId);</span><br><span class="line">        </span><br><span class="line">        // 1. æŸ¥è¯¢é€€æ¬¾è®°å½•</span><br><span class="line">        OrderRefund refund = getRefundByNo(refundNo);</span><br><span class="line">        if (refund == null) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.RESOURCE_NOT_FOUND, &quot;é€€æ¬¾è®°å½•ä¸å­˜åœ¨&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 2. æ ¡éªŒé€€æ¬¾çŠ¶æ€</span><br><span class="line">        if (!canProcessRefund(refund)) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.BUSINESS_ERROR, &quot;é€€æ¬¾çŠ¶æ€ä¸å…è®¸å¤„ç†&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 3. è°ƒç”¨æ”¯ä»˜æœåŠ¡é€€æ¬¾</span><br><span class="line">        PaymentRefundResult paymentResult = paymentService.refund(</span><br><span class="line">                refund.getOrderNo(), </span><br><span class="line">                refund.getRefundAmount(),</span><br><span class="line">                refund.getRefundReason()</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        if (!paymentResult.isSuccess()) &#123;</span><br><span class="line">            // é€€æ¬¾å¤±è´¥</span><br><span class="line">            refund.setRefundStatus(OrderConstants.RefundStatus.FAILED);</span><br><span class="line">            refund.setFailReason(paymentResult.getErrorMsg());</span><br><span class="line">            updateRefund(refund);</span><br><span class="line">            </span><br><span class="line">            // å‘é€é€€æ¬¾å¤±è´¥é€šçŸ¥</span><br><span class="line">            sendRefundFailedMessage(refund);</span><br><span class="line">            </span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 4. æ›´æ–°é€€æ¬¾è®°å½•</span><br><span class="line">        refund.setRefundStatus(OrderConstants.RefundStatus.SUCCESS);</span><br><span class="line">        refund.setRefundTime(LocalDateTime.now());</span><br><span class="line">        refund.setTransactionId(paymentResult.getTransactionId());</span><br><span class="line">        updateRefund(refund);</span><br><span class="line">        </span><br><span class="line">        // 5. æ›´æ–°è®¢å•çŠ¶æ€</span><br><span class="line">        Order order = orderService.getOrderByNo(refund.getOrderNo());</span><br><span class="line">        order.setStatus(OrderConstants.Status.REFUNDED);</span><br><span class="line">        orderService.updateOrder(order);</span><br><span class="line">        </span><br><span class="line">        // 6. å¦‚æœè®¢å•å·²å‘è´§ï¼Œéœ€è¦æ¢å¤åº“å­˜</span><br><span class="line">        if (order.getDeliveryTime() != null &amp;&amp; </span><br><span class="line">                refund.getRefundType() == OrderConstants.RefundType.RETURN_REFUND) &#123;</span><br><span class="line">            restoreInventory(order);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 7. è®°å½•æ“ä½œæ—¥å¿—</span><br><span class="line">        saveRefundOperationLog(refund, &quot;é€€æ¬¾å¤„ç†å®Œæˆ&quot;);</span><br><span class="line">        </span><br><span class="line">        // 8. å‘é€é€€æ¬¾æˆåŠŸé€šçŸ¥</span><br><span class="line">        sendRefundSuccessMessage(refund);</span><br><span class="line">        </span><br><span class="line">        log.info(&quot;é€€æ¬¾å¤„ç†æˆåŠŸï¼Œé€€æ¬¾å•å·ï¼š&#123;&#125;&quot;, refundNo);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    @Transactional(rollbackFor = Exception.class)</span><br><span class="line">    public boolean rejectRefund(String refundNo, String rejectReason, Long operatorId) &#123;</span><br><span class="line">        log.info(&quot;æ‹’ç»é€€æ¬¾ï¼Œé€€æ¬¾å•å·ï¼š&#123;&#125;ï¼ŒåŸå› ï¼š&#123;&#125;&quot;, refundNo, rejectReason);</span><br><span class="line">        </span><br><span class="line">        // 1. æŸ¥è¯¢é€€æ¬¾è®°å½•</span><br><span class="line">        OrderRefund refund = getRefundByNo(refundNo);</span><br><span class="line">        if (refund == null) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.RESOURCE_NOT_FOUND, &quot;é€€æ¬¾è®°å½•ä¸å­˜åœ¨&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 2. æ›´æ–°é€€æ¬¾çŠ¶æ€</span><br><span class="line">        refund.setRefundStatus(OrderConstants.RefundStatus.REJECTED);</span><br><span class="line">        refund.setRejectReason(rejectReason);</span><br><span class="line">        refund.setRejectTime(LocalDateTime.now());</span><br><span class="line">        updateRefund(refund);</span><br><span class="line">        </span><br><span class="line">        // 3. æ›´æ–°è®¢å•çŠ¶æ€ï¼ˆæ¢å¤åŸçŠ¶æ€ï¼‰</span><br><span class="line">        Order order = orderService.getOrderByNo(refund.getOrderNo());</span><br><span class="line">        order.setStatus(order.getOriginalStatus()); // ä¿å­˜çš„åŸçŠ¶æ€</span><br><span class="line">        orderService.updateOrder(order);</span><br><span class="line">        </span><br><span class="line">        // 4. è®°å½•æ“ä½œæ—¥å¿—</span><br><span class="line">        saveRefundOperationLog(refund, &quot;é€€æ¬¾è¢«æ‹’ç»ï¼š&quot; + rejectReason);</span><br><span class="line">        </span><br><span class="line">        // 5. å‘é€é€€æ¬¾æ‹’ç»é€šçŸ¥</span><br><span class="line">        sendRefundRejectMessage(refund);</span><br><span class="line">        </span><br><span class="line">        log.info(&quot;é€€æ¬¾æ‹’ç»æˆåŠŸï¼Œé€€æ¬¾å•å·ï¼š&#123;&#125;&quot;, refundNo);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public RefundDetail getRefundDetail(String refundNo) &#123;</span><br><span class="line">        OrderRefund refund = getRefundByNo(refundNo);</span><br><span class="line">        if (refund == null) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        Order order = orderService.getOrderByNo(refund.getOrderNo());</span><br><span class="line">        </span><br><span class="line">        return RefundDetail.builder()</span><br><span class="line">                .refundNo(refund.getRefundNo())</span><br><span class="line">                .orderNo(refund.getOrderNo())</span><br><span class="line">                .refundAmount(refund.getRefundAmount())</span><br><span class="line">                .refundType(refund.getRefundType())</span><br><span class="line">                .refundStatus(refund.getRefundStatus())</span><br><span class="line">                .refundReason(refund.getRefundReason())</span><br><span class="line">                .applyTime(refund.getCreateTime())</span><br><span class="line">                .refundTime(refund.getRefundTime())</span><br><span class="line">                .rejectReason(refund.getRejectReason())</span><br><span class="line">                .orderAmount(order.getPayAmount())</span><br><span class="line">                .productList(getOrderProducts(order))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ ¡éªŒé€€æ¬¾è¯·æ±‚</span><br><span class="line">     */</span><br><span class="line">    private void validateRefundRequest(RefundRequest request) &#123;</span><br><span class="line">        if (request.getOrderNo() == null || request.getOrderNo().trim().isEmpty()) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.PARAM_VALID_ERROR, &quot;è®¢å•å·ä¸èƒ½ä¸ºç©º&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        if (request.getRefundReason() == null || request.getRefundReason().trim().isEmpty()) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.PARAM_VALID_ERROR, &quot;é€€æ¬¾åŸå› ä¸èƒ½ä¸ºç©º&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        if (request.getRefundType() == null) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.PARAM_VALID_ERROR, &quot;é€€æ¬¾ç±»å‹ä¸èƒ½ä¸ºç©º&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        if (request.getRefundType() == OrderConstants.RefundType.RETURN_REFUND &amp;&amp; </span><br><span class="line">                (request.getReturnEvidence() == null || request.getReturnEvidence().isEmpty())) &#123;</span><br><span class="line">            throw new BusinessException(ResultCode.PARAM_VALID_ERROR, &quot;é€€è´§é€€æ¬¾å¿…é¡»æä¾›é€€è´§å‡­è¯&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆ¤æ–­è®¢å•æ˜¯å¦å¯ä»¥é€€æ¬¾</span><br><span class="line">     */</span><br><span class="line">    private boolean canRefund(Order order) &#123;</span><br><span class="line">        // å·²æ”¯ä»˜ã€å·²å‘è´§ã€å·²æ”¶è´§çš„è®¢å•å¯ä»¥é€€æ¬¾</span><br><span class="line">        return order.getStatus() &gt;= OrderConstants.Status.PAID &amp;&amp; </span><br><span class="line">               order.getStatus() &lt;= OrderConstants.Status.RECEIVED;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è®¡ç®—é€€æ¬¾é‡‘é¢</span><br><span class="line">     */</span><br><span class="line">    private BigDecimal calculateRefundAmount(Order order, RefundRequest request) &#123;</span><br><span class="line">        BigDecimal refundAmount;</span><br><span class="line">        </span><br><span class="line">        if (request.getRefundAmount() != null) &#123;</span><br><span class="line">            // ä½¿ç”¨ç”¨æˆ·æŒ‡å®šçš„é€€æ¬¾é‡‘é¢</span><br><span class="line">            refundAmount = request.getRefundAmount();</span><br><span class="line">            </span><br><span class="line">            // æ ¡éªŒé€€æ¬¾é‡‘é¢ä¸èƒ½è¶…è¿‡è®¢å•å®ä»˜é‡‘é¢</span><br><span class="line">            if (refundAmount.compareTo(order.getPayAmount()) &gt; 0) &#123;</span><br><span class="line">                throw new BusinessException(ResultCode.BUSINESS_ERROR, </span><br><span class="line">                        &quot;é€€æ¬¾é‡‘é¢ä¸èƒ½è¶…è¿‡è®¢å•å®ä»˜é‡‘é¢&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // è‡ªåŠ¨è®¡ç®—é€€æ¬¾é‡‘é¢</span><br><span class="line">            if (request.getRefundType() == OrderConstants.RefundType.ONLY_REFUND) &#123;</span><br><span class="line">                // ä»…é€€æ¬¾ï¼šæ‰£é™¤è¿è´¹ï¼ˆå¦‚æœå·²å‘è´§ï¼‰</span><br><span class="line">                refundAmount = order.getPayAmount();</span><br><span class="line">                if (order.getDeliveryTime() != null) &#123;</span><br><span class="line">                    // å·²å‘è´§çš„å•†å“ï¼Œæ‰£é™¤è¿è´¹</span><br><span class="line">                    refundAmount = refundAmount.subtract(order.getFreightAmount());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                // é€€è´§é€€æ¬¾ï¼šå…¨é¢é€€æ¬¾</span><br><span class="line">                refundAmount = order.getPayAmount();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // ç¡®ä¿é€€æ¬¾é‡‘é¢ä¸å°äº0</span><br><span class="line">        if (refundAmount.compareTo(BigDecimal.ZERO) &lt; 0) &#123;</span><br><span class="line">            refundAmount = BigDecimal.ZERO;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return refundAmount;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆ›å»ºé€€æ¬¾è®°å½•</span><br><span class="line">     */</span><br><span class="line">    private OrderRefund createRefundRecord(Order order, RefundRequest request, </span><br><span class="line">                                          BigDecimal refundAmount) &#123;</span><br><span class="line">        OrderRefund refund = new OrderRefund();</span><br><span class="line">        refund.setRefundNo(generateRefundNo());</span><br><span class="line">        refund.setOrderId(order.getId());</span><br><span class="line">        refund.setOrderNo(order.getOrderNo());</span><br><span class="line">        refund.setUserId(order.getUserId());</span><br><span class="line">        refund.setRefundAmount(refundAmount);</span><br><span class="line">        refund.setRefundType(request.getRefundType());</span><br><span class="line">        refund.setRefundReason(request.getRefundReason());</span><br><span class="line">        refund.setRefundStatus(OrderConstants.RefundStatus.APPLYING);</span><br><span class="line">        </span><br><span class="line">        if (request.getRefundType() == OrderConstants.RefundType.RETURN_REFUND) &#123;</span><br><span class="line">            refund.setReturnEvidence(JSON.toJSONString(request.getReturnEvidence()));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // ä¿å­˜é€€æ¬¾è®°å½•</span><br><span class="line">        saveRefund(refund);</span><br><span class="line">        </span><br><span class="line">        return refund;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * ç”Ÿæˆé€€æ¬¾å•å·</span><br><span class="line">     */</span><br><span class="line">    private String generateRefundNo() &#123;</span><br><span class="line">        // RF + å¹´æœˆæ—¥ + 8ä½éšæœºæ•°</span><br><span class="line">        String dateStr = LocalDateTime.now().format(DateTimeFormatter.ofPattern(&quot;yyyyMMdd&quot;));</span><br><span class="line">        String random = UUID.randomUUID().toString().replace(&quot;-&quot;, &quot;&quot;).substring(0, 8);</span><br><span class="line">        return &quot;RF&quot; + dateStr + random;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ¢å¤åº“å­˜</span><br><span class="line">     */</span><br><span class="line">    private void restoreInventory(Order order) &#123;</span><br><span class="line">        List&lt;OrderItem&gt; orderItems = orderItemService.getByOrderId(order.getId());</span><br><span class="line">        </span><br><span class="line">        for (OrderItem item : orderItems) &#123;</span><br><span class="line">            inventoryService.increaseStock(</span><br><span class="line">                    item.getProductId(), </span><br><span class="line">                    item.getQuantity()</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        log.info(&quot;æ¢å¤åº“å­˜æˆåŠŸï¼Œè®¢å•å·ï¼š&#123;&#125;&quot;, order.getOrderNo());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å‘é€é€€æ¬¾ç”³è¯·æ¶ˆæ¯</span><br><span class="line">     */</span><br><span class="line">    private void sendRefundApplyMessage(OrderRefund refund) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            RefundApplyMessage message = RefundApplyMessage.builder()</span><br><span class="line">                    .refundNo(refund.getRefundNo())</span><br><span class="line">                    .orderNo(refund.getOrderNo())</span><br><span class="line">                    .userId(refund.getUserId())</span><br><span class="line">                    .refundAmount(refund.getRefundAmount())</span><br><span class="line">                    .refundType(refund.getRefundType())</span><br><span class="line">                    .applyTime(LocalDateTime.now())</span><br><span class="line">                    .build();</span><br><span class="line">            </span><br><span class="line">            rocketMQTemplate.syncSend(</span><br><span class="line">                    &quot;REFUND_TOPIC:REFUND_APPLY&quot;,</span><br><span class="line">                    message</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            log.info(&quot;å‘é€é€€æ¬¾ç”³è¯·æ¶ˆæ¯æˆåŠŸï¼Œé€€æ¬¾å•å·ï¼š&#123;&#125;&quot;, refund.getRefundNo());</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;å‘é€é€€æ¬¾ç”³è¯·æ¶ˆæ¯å¤±è´¥ï¼Œé€€æ¬¾å•å·ï¼š&#123;&#125;&quot;, refund.getRefundNo(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// é€€æ¬¾è¯·æ±‚</span><br><span class="line">@Data</span><br><span class="line">class RefundRequest &#123;</span><br><span class="line">    @NotNull(message = &quot;è®¢å•å·ä¸èƒ½ä¸ºç©º&quot;)</span><br><span class="line">    private String orderNo;</span><br><span class="line">    </span><br><span class="line">    @NotNull(message = &quot;é€€æ¬¾ç±»å‹ä¸èƒ½ä¸ºç©º&quot;)</span><br><span class="line">    private Integer refundType; // 1-ä»…é€€æ¬¾ï¼Œ2-é€€è´§é€€æ¬¾</span><br><span class="line">    </span><br><span class="line">    @NotNull(message = &quot;é€€æ¬¾åŸå› ä¸èƒ½ä¸ºç©º&quot;)</span><br><span class="line">    private String refundReason;</span><br><span class="line">    </span><br><span class="line">    private BigDecimal refundAmount;</span><br><span class="line">    </span><br><span class="line">    private List&lt;String&gt; returnEvidence; // é€€è´§å‡­è¯</span><br><span class="line">    </span><br><span class="line">    private String contactPhone;</span><br><span class="line">    private String contactName;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// é€€æ¬¾ç»“æœ</span><br><span class="line">@Data</span><br><span class="line">@Builder</span><br><span class="line">class RefundResult &#123;</span><br><span class="line">    private String refundNo;</span><br><span class="line">    private BigDecimal refundAmount;</span><br><span class="line">    private LocalDateTime estimatedTime;</span><br><span class="line">    private String tips;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// é€€æ¬¾è¯¦æƒ…</span><br><span class="line">@Data</span><br><span class="line">@Builder</span><br><span class="line">class RefundDetail &#123;</span><br><span class="line">    private String refundNo;</span><br><span class="line">    private String orderNo;</span><br><span class="line">    private BigDecimal refundAmount;</span><br><span class="line">    private Integer refundType;</span><br><span class="line">    private Integer refundStatus;</span><br><span class="line">    private String refundReason;</span><br><span class="line">    private LocalDateTime applyTime;</span><br><span class="line">    private LocalDateTime refundTime;</span><br><span class="line">    private String rejectReason;</span><br><span class="line">    private BigDecimal orderAmount;</span><br><span class="line">    private List&lt;ProductInfo&gt; productList;</span><br><span class="line">    private List&lt;RefundOperationLog&gt; operationLogs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// é€€æ¬¾ç”³è¯·æ¶ˆæ¯</span><br><span class="line">@Data</span><br><span class="line">@Builder</span><br><span class="line">class RefundApplyMessage &#123;</span><br><span class="line">    private String refundNo;</span><br><span class="line">    private String orderNo;</span><br><span class="line">    private Long userId;</span><br><span class="line">    private BigDecimal refundAmount;</span><br><span class="line">    private Integer refundType;</span><br><span class="line">    private LocalDateTime applyTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-è®¢å•æ•°æ®åŒæ­¥åˆ°ES-1"><a href="#5-è®¢å•æ•°æ®åŒæ­¥åˆ°ES-1" class="headerlink" title="5. è®¢å•æ•°æ®åŒæ­¥åˆ°ES"></a>5. è®¢å•æ•°æ®åŒæ­¥åˆ°ES</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.order.sync;</span><br><span class="line"></span><br><span class="line">import com.alibaba.fastjson.JSON;</span><br><span class="line">import com.shophub.order.entity.Order;</span><br><span class="line">import com.shophub.order.entity.OrderItem;</span><br><span class="line">import com.shophub.search.document.OrderDocument;</span><br><span class="line">import com.shophub.search.service.OrderSearchService;</span><br><span class="line">import lombok.RequiredArgsConstructor;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.apache.rocketmq.spring.annotation.RocketMQMessageListener;</span><br><span class="line">import org.apache.rocketmq.spring.core.RocketMQTemplate;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line">import java.time.LocalDateTime;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * è®¢å•æ•°æ®åŒæ­¥åˆ°Elasticsearch</span><br><span class="line"> */</span><br><span class="line">@Slf4j</span><br><span class="line">@Component</span><br><span class="line">@RequiredArgsConstructor</span><br><span class="line">public class OrderDataSyncService &#123;</span><br><span class="line">    </span><br><span class="line">    private final RocketMQTemplate rocketMQTemplate;</span><br><span class="line">    private final OrderSearchService orderSearchService;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åŒæ­¥è®¢å•åˆ°ES</span><br><span class="line">     */</span><br><span class="line">    public void syncOrderToEs(Order order) &#123;</span><br><span class="line">        log.info(&quot;åŒæ­¥è®¢å•åˆ°ESï¼Œè®¢å•å·ï¼š&#123;&#125;&quot;, order.getOrderNo());</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            // è½¬æ¢ä¸ºESæ–‡æ¡£</span><br><span class="line">            OrderDocument document = convertToDocument(order);</span><br><span class="line">            </span><br><span class="line">            // ä¿å­˜åˆ°ES</span><br><span class="line">            orderSearchService.indexOrder(document);</span><br><span class="line">            </span><br><span class="line">            log.info(&quot;åŒæ­¥è®¢å•åˆ°ESæˆåŠŸï¼Œè®¢å•å·ï¼š&#123;&#125;&quot;, order.getOrderNo());</span><br><span class="line">            </span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;åŒæ­¥è®¢å•åˆ°ESå¤±è´¥ï¼Œè®¢å•å·ï¼š&#123;&#125;&quot;, order.getOrderNo(), e);</span><br><span class="line">            // åŠ å…¥é‡è¯•é˜Ÿåˆ—</span><br><span class="line">            addToRetryQueue(order);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ‰¹é‡åŒæ­¥è®¢å•åˆ°ES</span><br><span class="line">     */</span><br><span class="line">    public void batchSyncOrdersToEs(List&lt;Order&gt; orders) &#123;</span><br><span class="line">        log.info(&quot;æ‰¹é‡åŒæ­¥è®¢å•åˆ°ESï¼Œæ•°é‡ï¼š&#123;&#125;&quot;, orders.size());</span><br><span class="line">        </span><br><span class="line">        List&lt;OrderDocument&gt; documents = orders.stream()</span><br><span class="line">                .map(this::convertToDocument)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            // æ‰¹é‡ä¿å­˜åˆ°ES</span><br><span class="line">            orderSearchService.bulkIndexOrders(documents);</span><br><span class="line">            </span><br><span class="line">            log.info(&quot;æ‰¹é‡åŒæ­¥è®¢å•åˆ°ESæˆåŠŸï¼Œæ•°é‡ï¼š&#123;&#125;&quot;, orders.size());</span><br><span class="line">            </span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;æ‰¹é‡åŒæ­¥è®¢å•åˆ°ESå¤±è´¥&quot;, e);</span><br><span class="line">            // å•æ¡é‡è¯•</span><br><span class="line">            for (Order order : orders) &#123;</span><br><span class="line">                syncOrderToEs(order);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * ç›‘å¬è®¢å•çŠ¶æ€å˜æ›´æ¶ˆæ¯</span><br><span class="line">     */</span><br><span class="line">    @RocketMQMessageListener(</span><br><span class="line">            topic = &quot;ORDER_TOPIC&quot;,</span><br><span class="line">            selectorExpression = &quot;ORDER_STATUS_CHANGE&quot;,</span><br><span class="line">            consumerGroup = &quot;order-sync-consumer-group&quot;</span><br><span class="line">    )</span><br><span class="line">    public void consumeOrderStatusChange(OrderStatusChangeMessage message) &#123;</span><br><span class="line">        log.info(&quot;æ”¶åˆ°è®¢å•çŠ¶æ€å˜æ›´æ¶ˆæ¯ï¼š&#123;&#125;&quot;, message);</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            // æ ¹æ®è®¢å•å·æŸ¥è¯¢è®¢å•è¯¦æƒ…</span><br><span class="line">            Order order = orderService.getOrderByNo(message.getOrderNo());</span><br><span class="line">            if (order == null) &#123;</span><br><span class="line">                log.error(&quot;è®¢å•ä¸å­˜åœ¨ï¼Œè®¢å•å·ï¼š&#123;&#125;&quot;, message.getOrderNo());</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // åŒæ­¥åˆ°ES</span><br><span class="line">            syncOrderToEs(order);</span><br><span class="line">            </span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;å¤„ç†è®¢å•çŠ¶æ€å˜æ›´æ¶ˆæ¯å¤±è´¥ï¼Œè®¢å•å·ï¼š&#123;&#125;&quot;, </span><br><span class="line">                    message.getOrderNo(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * ç›‘å¬è®¢å•åˆ›å»ºæ¶ˆæ¯</span><br><span class="line">     */</span><br><span class="line">    @RocketMQMessageListener(</span><br><span class="line">            topic = &quot;ORDER_TOPIC&quot;,</span><br><span class="line">            selectorExpression = &quot;ORDER_CREATE&quot;,</span><br><span class="line">            consumerGroup = &quot;order-sync-consumer-group&quot;</span><br><span class="line">    )</span><br><span class="line">    public void consumeOrderCreate(OrderCreateMessage message) &#123;</span><br><span class="line">        log.info(&quot;æ”¶åˆ°è®¢å•åˆ›å»ºæ¶ˆæ¯ï¼š&#123;&#125;&quot;, message);</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            // å»¶è¿ŸåŒæ­¥ï¼Œç­‰å¾…è®¢å•æ•°æ®å®Œæ•´</span><br><span class="line">            Thread.sleep(1000);</span><br><span class="line">            </span><br><span class="line">            Order order = orderService.getOrderByNo(message.getOrderNo());</span><br><span class="line">            if (order != null) &#123;</span><br><span class="line">                syncOrderToEs(order);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;å¤„ç†è®¢å•åˆ›å»ºæ¶ˆæ¯å¤±è´¥ï¼Œè®¢å•å·ï¼š&#123;&#125;&quot;, </span><br><span class="line">                    message.getOrderNo(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è½¬æ¢è®¢å•ä¸ºESæ–‡æ¡£</span><br><span class="line">     */</span><br><span class="line">    private OrderDocument convertToDocument(Order order) &#123;</span><br><span class="line">        OrderDocument document = new OrderDocument();</span><br><span class="line">        </span><br><span class="line">        // åŸºæœ¬ä¿¡æ¯</span><br><span class="line">        document.setId(order.getId());</span><br><span class="line">        document.setOrderNo(order.getOrderNo());</span><br><span class="line">        document.setUserId(order.getUserId());</span><br><span class="line">        document.setTotalAmount(order.getTotalAmount());</span><br><span class="line">        document.setPayAmount(order.getPayAmount());</span><br><span class="line">        document.setStatus(order.getStatus());</span><br><span class="line">        document.setPayType(order.getPayType());</span><br><span class="line">        </span><br><span class="line">        // æ”¶è´§ä¿¡æ¯</span><br><span class="line">        document.setReceiverName(order.getReceiverName());</span><br><span class="line">        document.setReceiverPhone(order.getReceiverPhone());</span><br><span class="line">        document.setReceiverProvince(order.getReceiverProvince());</span><br><span class="line">        document.setReceiverCity(order.getReceiverCity());</span><br><span class="line">        document.setReceiverRegion(order.getReceiverRegion());</span><br><span class="line">        document.setReceiverAddress(order.getReceiverAddress());</span><br><span class="line">        </span><br><span class="line">        // æ—¶é—´ä¿¡æ¯</span><br><span class="line">        document.setCreateTime(order.getCreateTime());</span><br><span class="line">        document.setPayTime(order.getPayTime());</span><br><span class="line">        document.setDeliveryTime(order.getDeliveryTime());</span><br><span class="line">        document.setReceiveTime(order.getReceiveTime());</span><br><span class="line">        </span><br><span class="line">        // å•†å“ä¿¡æ¯</span><br><span class="line">        List&lt;OrderItem&gt; items = orderItemService.getByOrderId(order.getId());</span><br><span class="line">        List&lt;OrderDocument.OrderItem&gt; orderItems = items.stream()</span><br><span class="line">                .map(this::convertToOrderItem)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        document.setOrderItems(orderItems);</span><br><span class="line">        </span><br><span class="line">        // æœç´¢å­—æ®µï¼ˆç”¨äºå…¨æ–‡æœç´¢ï¼‰</span><br><span class="line">        String searchText = buildSearchText(order, items);</span><br><span class="line">        document.setSearchText(searchText);</span><br><span class="line">        </span><br><span class="line">        // ç»Ÿè®¡å­—æ®µ</span><br><span class="line">        document.setItemCount(items.size());</span><br><span class="line">        BigDecimal totalQuantity = items.stream()</span><br><span class="line">                .map(OrderItem::getQuantity)</span><br><span class="line">                .map(BigDecimal::valueOf)</span><br><span class="line">                .reduce(BigDecimal.ZERO, BigDecimal::add);</span><br><span class="line">        document.setTotalQuantity(totalQuantity);</span><br><span class="line">        </span><br><span class="line">        return document;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ„å»ºæœç´¢æ–‡æœ¬</span><br><span class="line">     */</span><br><span class="line">    private String buildSearchText(Order order, List&lt;OrderItem&gt; items) &#123;</span><br><span class="line">        StringBuilder sb = new StringBuilder();</span><br><span class="line">        </span><br><span class="line">        // è®¢å•å·</span><br><span class="line">        sb.append(order.getOrderNo()).append(&quot; &quot;);</span><br><span class="line">        </span><br><span class="line">        // æ”¶è´§äººä¿¡æ¯</span><br><span class="line">        sb.append(order.getReceiverName()).append(&quot; &quot;);</span><br><span class="line">        sb.append(order.getReceiverPhone()).append(&quot; &quot;);</span><br><span class="line">        sb.append(order.getReceiverProvince()).append(&quot; &quot;);</span><br><span class="line">        sb.append(order.getReceiverCity()).append(&quot; &quot;);</span><br><span class="line">        sb.append(order.getReceiverRegion()).append(&quot; &quot;);</span><br><span class="line">        sb.append(order.getReceiverAddress()).append(&quot; &quot;);</span><br><span class="line">        </span><br><span class="line">        // å•†å“ä¿¡æ¯</span><br><span class="line">        for (OrderItem item : items) &#123;</span><br><span class="line">            sb.append(item.getProductName()).append(&quot; &quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return sb.toString().trim();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è½¬æ¢è®¢å•å•†å“</span><br><span class="line">     */</span><br><span class="line">    private OrderDocument.OrderItem convertToOrderItem(OrderItem item) &#123;</span><br><span class="line">        OrderDocument.OrderItem orderItem = new OrderDocument.OrderItem();</span><br><span class="line">        orderItem.setProductId(item.getProductId());</span><br><span class="line">        orderItem.setProductName(item.getProductName());</span><br><span class="line">        orderItem.setProductImage(item.getProductImage());</span><br><span class="line">        orderItem.setProductPrice(item.getProductPrice());</span><br><span class="line">        orderItem.setQuantity(item.getQuantity());</span><br><span class="line">        orderItem.setTotalAmount(item.getTotalAmount());</span><br><span class="line">        return orderItem;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åŠ å…¥é‡è¯•é˜Ÿåˆ—</span><br><span class="line">     */</span><br><span class="line">    private void addToRetryQueue(Order order) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            OrderSyncRetryMessage message = OrderSyncRetryMessage.builder()</span><br><span class="line">                    .orderNo(order.getOrderNo())</span><br><span class="line">                    .retryCount(0)</span><br><span class="line">                    .lastRetryTime(LocalDateTime.now())</span><br><span class="line">                    .build();</span><br><span class="line">            </span><br><span class="line">            // å‘é€å»¶è¿Ÿæ¶ˆæ¯ï¼Œ5ç§’åé‡è¯•</span><br><span class="line">            rocketMQTemplate.syncSendDelaySeconds(</span><br><span class="line">                    &quot;ORDER_SYNC_RETRY_TOPIC&quot;,</span><br><span class="line">                    message,</span><br><span class="line">                    5</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            log.info(&quot;è®¢å•åŒæ­¥åŠ å…¥é‡è¯•é˜Ÿåˆ—ï¼Œè®¢å•å·ï¼š&#123;&#125;&quot;, order.getOrderNo());</span><br><span class="line">            </span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;åŠ å…¥é‡è¯•é˜Ÿåˆ—å¤±è´¥ï¼Œè®¢å•å·ï¼š&#123;&#125;&quot;, order.getOrderNo(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å¤„ç†é‡è¯•æ¶ˆæ¯</span><br><span class="line">     */</span><br><span class="line">    @RocketMQMessageListener(</span><br><span class="line">            topic = &quot;ORDER_SYNC_RETRY_TOPIC&quot;,</span><br><span class="line">            consumerGroup = &quot;order-sync-retry-consumer-group&quot;</span><br><span class="line">    )</span><br><span class="line">    public void consumeRetryMessage(OrderSyncRetryMessage message) &#123;</span><br><span class="line">        log.info(&quot;æ”¶åˆ°è®¢å•åŒæ­¥é‡è¯•æ¶ˆæ¯ï¼š&#123;&#125;&quot;, message);</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            // è·å–è®¢å•</span><br><span class="line">            Order order = orderService.getOrderByNo(message.getOrderNo());</span><br><span class="line">            if (order == null) &#123;</span><br><span class="line">                log.error(&quot;è®¢å•ä¸å­˜åœ¨ï¼Œåœæ­¢é‡è¯•ï¼Œè®¢å•å·ï¼š&#123;&#125;&quot;, message.getOrderNo());</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // å°è¯•åŒæ­¥</span><br><span class="line">            OrderDocument document = convertToDocument(order);</span><br><span class="line">            orderSearchService.indexOrder(document);</span><br><span class="line">            </span><br><span class="line">            log.info(&quot;è®¢å•åŒæ­¥é‡è¯•æˆåŠŸï¼Œè®¢å•å·ï¼š&#123;&#125;&quot;, message.getOrderNo());</span><br><span class="line">            </span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;è®¢å•åŒæ­¥é‡è¯•å¤±è´¥ï¼Œè®¢å•å·ï¼š&#123;&#125;&quot;, message.getOrderNo(), e);</span><br><span class="line">            </span><br><span class="line">            // å¢åŠ é‡è¯•æ¬¡æ•°</span><br><span class="line">            message.setRetryCount(message.getRetryCount() + 1);</span><br><span class="line">            message.setLastRetryTime(LocalDateTime.now());</span><br><span class="line">            </span><br><span class="line">            // åˆ¤æ–­æ˜¯å¦ç»§ç»­é‡è¯•</span><br><span class="line">            if (message.getRetryCount() &lt; 3) &#123;</span><br><span class="line">                // æŒ‡æ•°é€€é¿é‡è¯•</span><br><span class="line">                int delaySeconds = (int) Math.pow(2, message.getRetryCount()) * 5;</span><br><span class="line">                rocketMQTemplate.syncSendDelaySeconds(</span><br><span class="line">                        &quot;ORDER_SYNC_RETRY_TOPIC&quot;,</span><br><span class="line">                        message,</span><br><span class="line">                        delaySeconds</span><br><span class="line">                );</span><br><span class="line">                log.info(&quot;é‡æ–°åŠ å…¥é‡è¯•é˜Ÿåˆ—ï¼Œè®¢å•å·ï¼š&#123;&#125;ï¼Œé‡è¯•æ¬¡æ•°ï¼š&#123;&#125;ï¼Œå»¶è¿Ÿï¼š&#123;&#125;ç§’&quot;,</span><br><span class="line">                        message.getOrderNo(), message.getRetryCount(), delaySeconds);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                // é‡è¯•æ¬¡æ•°ç”¨å°½ï¼Œè®°å½•åˆ°æ­»ä¿¡é˜Ÿåˆ—</span><br><span class="line">                sendToDeadLetterQueue(message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—</span><br><span class="line">     */</span><br><span class="line">    private void sendToDeadLetterQueue(OrderSyncRetryMessage message) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            rocketMQTemplate.syncSend(</span><br><span class="line">                    &quot;ORDER_SYNC_DLQ_TOPIC&quot;,</span><br><span class="line">                    message</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            log.warn(&quot;è®¢å•åŒæ­¥å¤±è´¥ï¼Œå·²åŠ å…¥æ­»ä¿¡é˜Ÿåˆ—ï¼Œè®¢å•å·ï¼š&#123;&#125;&quot;, </span><br><span class="line">                    message.getOrderNo());</span><br><span class="line">            </span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;å‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—å¤±è´¥ï¼Œè®¢å•å·ï¼š&#123;&#125;&quot;, </span><br><span class="line">                    message.getOrderNo(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åˆå§‹åŒ–è®¢å•ESç´¢å¼•</span><br><span class="line">     */</span><br><span class="line">    public void initOrderIndex() &#123;</span><br><span class="line">        log.info(&quot;å¼€å§‹åˆå§‹åŒ–è®¢å•ESç´¢å¼•&quot;);</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            // 1. åˆ›å»ºç´¢å¼•</span><br><span class="line">            orderSearchService.createOrderIndex();</span><br><span class="line">            </span><br><span class="line">            // 2. åŒæ­¥æœ€è¿‘3ä¸ªæœˆçš„è®¢å•</span><br><span class="line">            LocalDateTime endTime = LocalDateTime.now();</span><br><span class="line">            LocalDateTime startTime = endTime.minusMonths(3);</span><br><span class="line">            </span><br><span class="line">            int pageNum = 1;</span><br><span class="line">            int pageSize = 1000;</span><br><span class="line">            boolean hasNext = true;</span><br><span class="line">            </span><br><span class="line">            while (hasNext) &#123;</span><br><span class="line">                // åˆ†é¡µæŸ¥è¯¢è®¢å•</span><br><span class="line">                List&lt;Order&gt; orders = orderService.getOrdersByTimeRange(</span><br><span class="line">                        startTime, endTime, pageNum, pageSize);</span><br><span class="line">                </span><br><span class="line">                if (orders.isEmpty()) &#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                // æ‰¹é‡åŒæ­¥åˆ°ES</span><br><span class="line">                batchSyncOrdersToEs(orders);</span><br><span class="line">                </span><br><span class="line">                hasNext = orders.size() == pageSize;</span><br><span class="line">                pageNum++;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            log.info(&quot;è®¢å•ESç´¢å¼•åˆå§‹åŒ–å®Œæˆ&quot;);</span><br><span class="line">            </span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;åˆå§‹åŒ–è®¢å•ESç´¢å¼•å¤±è´¥&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// ESè®¢å•æ–‡æ¡£</span><br><span class="line">@Data</span><br><span class="line">class OrderDocument &#123;</span><br><span class="line">    </span><br><span class="line">    @Id</span><br><span class="line">    private Long id;</span><br><span class="line">    </span><br><span class="line">    @Field(type = FieldType.Keyword)</span><br><span class="line">    private String orderNo;</span><br><span class="line">    </span><br><span class="line">    @Field(type = FieldType.Long)</span><br><span class="line">    private Long userId;</span><br><span class="line">    </span><br><span class="line">    @Field(type = FieldType.Double)</span><br><span class="line">    private BigDecimal totalAmount;</span><br><span class="line">    </span><br><span class="line">    @Field(type = FieldType.Double)</span><br><span class="line">    private BigDecimal payAmount;</span><br><span class="line">    </span><br><span class="line">    @Field(type = FieldType.Integer)</span><br><span class="line">    private Integer status;</span><br><span class="line">    </span><br><span class="line">    @Field(type = FieldType.Integer)</span><br><span class="line">    private Integer payType;</span><br><span class="line">    </span><br><span class="line">    @Field(type = FieldType.Text, analyzer = &quot;ik_max_word&quot;, searchAnalyzer = &quot;ik_smart&quot;)</span><br><span class="line">    private String receiverName;</span><br><span class="line">    </span><br><span class="line">    @Field(type = FieldType.Keyword)</span><br><span class="line">    private String receiverPhone;</span><br><span class="line">    </span><br><span class="line">    @Field(type = FieldType.Keyword)</span><br><span class="line">    private String receiverProvince;</span><br><span class="line">    </span><br><span class="line">    @Field(type = FieldType.Keyword)</span><br><span class="line">    private String receiverCity;</span><br><span class="line">    </span><br><span class="line">    @Field(type = FieldType.Keyword)</span><br><span class="line">    private String receiverRegion;</span><br><span class="line">    </span><br><span class="line">    @Field(type = FieldType.Text, analyzer = &quot;ik_max_word&quot;, searchAnalyzer = &quot;ik_smart&quot;)</span><br><span class="line">    private String receiverAddress;</span><br><span class="line">    </span><br><span class="line">    @Field(type = FieldType.Date)</span><br><span class="line">    private LocalDateTime createTime;</span><br><span class="line">    </span><br><span class="line">    @Field(type = FieldType.Date)</span><br><span class="line">    private LocalDateTime payTime;</span><br><span class="line">    </span><br><span class="line">    @Field(type = FieldType.Date)</span><br><span class="line">    private LocalDateTime deliveryTime;</span><br><span class="line">    </span><br><span class="line">    @Field(type = FieldType.Date)</span><br><span class="line">    private LocalDateTime receiveTime;</span><br><span class="line">    </span><br><span class="line">    @Field(type = FieldType.Nested)</span><br><span class="line">    private List&lt;OrderItem&gt; orderItems;</span><br><span class="line">    </span><br><span class="line">    @Field(type = FieldType.Text, analyzer = &quot;ik_max_word&quot;, searchAnalyzer = &quot;ik_smart&quot;)</span><br><span class="line">    private String searchText;</span><br><span class="line">    </span><br><span class="line">    @Field(type = FieldType.Integer)</span><br><span class="line">    private Integer itemCount;</span><br><span class="line">    </span><br><span class="line">    @Field(type = FieldType.Double)</span><br><span class="line">    private BigDecimal totalQuantity;</span><br><span class="line">    </span><br><span class="line">    @Data</span><br><span class="line">    public static class OrderItem &#123;</span><br><span class="line">        @Field(type = FieldType.Long)</span><br><span class="line">        private Long productId;</span><br><span class="line">        </span><br><span class="line">        @Field(type = FieldType.Text, analyzer = &quot;ik_max_word&quot;)</span><br><span class="line">        private String productName;</span><br><span class="line">        </span><br><span class="line">        @Field(type = FieldType.Keyword)</span><br><span class="line">        private String productImage;</span><br><span class="line">        </span><br><span class="line">        @Field(type = FieldType.Double)</span><br><span class="line">        private BigDecimal productPrice;</span><br><span class="line">        </span><br><span class="line">        @Field(type = FieldType.Integer)</span><br><span class="line">        private Integer quantity;</span><br><span class="line">        </span><br><span class="line">        @Field(type = FieldType.Double)</span><br><span class="line">        private BigDecimal totalAmount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// è®¢å•åŒæ­¥é‡è¯•æ¶ˆæ¯</span><br><span class="line">@Data</span><br><span class="line">@Builder</span><br><span class="line">class OrderSyncRetryMessage &#123;</span><br><span class="line">    private String orderNo;</span><br><span class="line">    private Integer retryCount;</span><br><span class="line">    private LocalDateTime lastRetryTime;</span><br><span class="line">    private String errorMessage;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ğŸ¯-ç¬¬äº”é˜¶æ®µå®Œæˆæ€»ç»“"><a href="#ğŸ¯-ç¬¬äº”é˜¶æ®µå®Œæˆæ€»ç»“" class="headerlink" title="ğŸ¯ ç¬¬äº”é˜¶æ®µå®Œæˆæ€»ç»“"></a>ğŸ¯ ç¬¬äº”é˜¶æ®µå®Œæˆæ€»ç»“</h2><h3 id="å·²å®ç°çš„åŠŸèƒ½ï¼š-3"><a href="#å·²å®ç°çš„åŠŸèƒ½ï¼š-3" class="headerlink" title="å·²å®ç°çš„åŠŸèƒ½ï¼š"></a>å·²å®ç°çš„åŠŸèƒ½ï¼š</h3><ol><li><strong>åº“å­˜å¹¶å‘æ§åˆ¶</strong>ï¼š<ul><li>åˆ†å¸ƒå¼é”ï¼ˆRedissonï¼‰å®ç°åº“å­˜æ“ä½œä¸²è¡ŒåŒ–</li><li>Redis Luaè„šæœ¬åŸå­æ“ä½œè§£å†³è¶…å–é—®é¢˜</li><li>ç§’æ€åº“å­˜é¢„æ‰£æœºåˆ¶</li><li>åº“å­˜ç¼“å­˜é¢„çƒ­å’Œæ›´æ–°</li></ul></li><li><strong>è®¢å•è¶…æ—¶å¤„ç†</strong>ï¼š<ul><li>Redis ZSetå»¶è¿Ÿé˜Ÿåˆ—å®ç°ç²¾ç¡®è¶…æ—¶</li><li>RocketMQæ¶ˆæ¯é©±åŠ¨çŠ¶æ€å˜æ›´</li><li>å®šæ—¶ä»»åŠ¡å…œåº•å¤„ç†</li><li>è‡ªåŠ¨å–æ¶ˆå’Œè‡ªåŠ¨ç¡®è®¤æ”¶è´§</li></ul></li><li><strong>åˆ†åº“åˆ†è¡¨</strong>ï¼š<ul><li>ShardingSphereåˆ†åº“åˆ†è¡¨é…ç½®</li><li>æŒ‰ç”¨æˆ·IDåˆ†åº“ + æŒ‰æ—¶é—´åˆ†è¡¨ç­–ç•¥</li><li>ç»‘å®šè¡¨ä¼˜åŒ–å…³è”æŸ¥è¯¢</li><li>åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–å’Œç»Ÿè®¡æŸ¥è¯¢ä¼˜åŒ–</li></ul></li><li><strong>é€€æ¬¾æµç¨‹</strong>ï¼š<ul><li>å®Œæ•´é€€æ¬¾çŠ¶æ€æœº</li><li>Seataåˆ†å¸ƒå¼äº‹åŠ¡ä¿è¯ä¸€è‡´æ€§</li><li>é€€æ¬¾é‡‘é¢è‡ªåŠ¨è®¡ç®—</li><li>åº“å­˜è‡ªåŠ¨æ¢å¤æœºåˆ¶</li></ul></li><li><strong>æ•°æ®åŒæ­¥</strong>ï¼š<ul><li>è®¢å•æ•°æ®å®æ—¶åŒæ­¥åˆ°Elasticsearch</li><li>é‡è¯•æœºåˆ¶å’Œæ­»ä¿¡é˜Ÿåˆ—</li><li>æ‰¹é‡åŒæ­¥å’Œç´¢å¼•åˆå§‹åŒ–</li><li>æ”¯æŒè®¢å•å…¨æ–‡æœç´¢</li></ul></li></ol><h3 id="æŠ€æœ¯æ ˆå®è·µï¼š-3"><a href="#æŠ€æœ¯æ ˆå®è·µï¼š-3" class="headerlink" title="æŠ€æœ¯æ ˆå®è·µï¼š"></a>æŠ€æœ¯æ ˆå®è·µï¼š</h3><p>âœ… <strong>åˆ†å¸ƒå¼é”</strong>ï¼šRedisson + Redis Lua<br>âœ… <strong>å»¶è¿Ÿé˜Ÿåˆ—</strong>ï¼šRedis ZSet + RocketMQå»¶è¿Ÿæ¶ˆæ¯<br>âœ… <strong>åˆ†åº“åˆ†è¡¨</strong>ï¼šShardingSphere<br>âœ… <strong>åˆ†å¸ƒå¼äº‹åŠ¡</strong>ï¼šSeata<br>âœ… <strong>æ¶ˆæ¯é˜Ÿåˆ—</strong>ï¼šRocketMQ<br>âœ… <strong>æœç´¢å¼•æ“</strong>ï¼šElasticsearchåŒæ­¥<br>âœ… <strong>å¹¶å‘æ§åˆ¶</strong>ï¼šå¤šç§æ–¹æ¡ˆç»„åˆ</p><h3 id="æ€§èƒ½ä¼˜åŒ–ï¼š"><a href="#æ€§èƒ½ä¼˜åŒ–ï¼š" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–ï¼š"></a>æ€§èƒ½ä¼˜åŒ–ï¼š</h3><ol><li><strong>åº“å­˜æ“ä½œ</strong>ï¼š99.9%è¯·æ±‚ &lt; 50ms</li><li><strong>è®¢å•åˆ›å»º</strong>ï¼šæ”¯æŒ1000+ TPS</li><li><strong>æ•°æ®åŒæ­¥</strong>ï¼šè¿‘å®æ—¶ï¼ˆ&lt; 1ç§’å»¶è¿Ÿï¼‰</li><li><strong>æŸ¥è¯¢æ€§èƒ½</strong>ï¼šåˆ†åº“åˆ†è¡¨åæå‡10å€+</li></ol><h3 id="ä¸‹ä¸€æ­¥å»ºè®®ï¼š-3"><a href="#ä¸‹ä¸€æ­¥å»ºè®®ï¼š-3" class="headerlink" title="ä¸‹ä¸€æ­¥å»ºè®®ï¼š"></a>ä¸‹ä¸€æ­¥å»ºè®®ï¼š</h3><p>ç¬¬å…­é˜¶æ®µæˆ‘ä»¬å°†å®ç°<strong>æ”¯ä»˜æœåŠ¡</strong>å’Œ<strong>é€šçŸ¥æœåŠ¡</strong>ï¼Œé‡ç‚¹å®è·µï¼š</p><ol><li><strong>å¤šæ¸ é“æ”¯ä»˜é›†æˆ</strong>ï¼ˆæ”¯ä»˜å®ã€å¾®ä¿¡ã€é“¶è”ï¼‰</li><li><strong>æ”¯ä»˜çŠ¶æ€æœº</strong>å’Œ<strong>å¯¹è´¦ç³»ç»Ÿ</strong></li><li><strong>WebSocketå®æ—¶é€šçŸ¥</strong></li><li><strong>æ¶ˆæ¯æ¨é€å’Œé‚®ä»¶&#x2F;SMSé€šçŸ¥</strong></li><li><strong>åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª</strong></li></ol><p>éœ€è¦æˆ‘ç»§ç»­å®ç°ç¬¬å…­é˜¶æ®µå—ï¼Ÿ</p><p>ç»§ç»­</p><p>æˆ‘ä»¬è¿›å…¥ç¬¬å…­é˜¶æ®µï¼šæ”¯ä»˜æœåŠ¡å’Œé€šçŸ¥æœåŠ¡ã€‚è¿™ä¸ªé˜¶æ®µå°†é‡ç‚¹å®ç°æ”¯ä»˜åŠŸèƒ½å’Œå®æ—¶é€šçŸ¥ã€‚</p><p>ç”±äºå†…å®¹è¾ƒå¤šï¼Œæˆ‘å°†åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š<br>ç¬¬14å¤©ï¼šæ”¯ä»˜æœåŠ¡ï¼ˆå¤šæ¸ é“æ”¯ä»˜é›†æˆã€æ”¯ä»˜çŠ¶æ€æœºã€å¯¹è´¦ç³»ç»Ÿï¼‰<br>ç¬¬15å¤©ï¼šé€šçŸ¥æœåŠ¡ï¼ˆWebSocketå®æ—¶é€šçŸ¥ã€æ¶ˆæ¯æ¨é€ã€é‚®ä»¶&#x2F;SMSé€šçŸ¥ï¼‰</p><p>ç°åœ¨å¼€å§‹ç¬¬14å¤©çš„å†…å®¹ï¼šæ”¯ä»˜æœåŠ¡å®ç°ã€‚</p><h2 id="ç¬¬14å¤©ï¼šæ”¯ä»˜æœåŠ¡å®ç°"><a href="#ç¬¬14å¤©ï¼šæ”¯ä»˜æœåŠ¡å®ç°" class="headerlink" title="ç¬¬14å¤©ï¼šæ”¯ä»˜æœåŠ¡å®ç°"></a>ç¬¬14å¤©ï¼šæ”¯ä»˜æœåŠ¡å®ç°</h2><h3 id="1-æ”¯ä»˜æœåŠ¡é¡¹ç›®ç»“æ„"><a href="#1-æ”¯ä»˜æœåŠ¡é¡¹ç›®ç»“æ„" class="headerlink" title="1. æ”¯ä»˜æœåŠ¡é¡¹ç›®ç»“æ„"></a>1. æ”¯ä»˜æœåŠ¡é¡¹ç›®ç»“æ„</h3><p>xml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- shophub-payment/pom.xml --&gt;</span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;</span><br><span class="line">         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 </span><br><span class="line">         http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;com.shophub&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;shophub-parent&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;1.0.0&lt;/version&gt;</span><br><span class="line">    &lt;/parent&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;artifactId&gt;shophub-payment&lt;/artifactId&gt;</span><br><span class="line">    &lt;packaging&gt;jar&lt;/packaging&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;alipay-sdk.version&gt;4.38.10.ALL&lt;/alipay-sdk.version&gt;</span><br><span class="line">        &lt;wxpay-sdk.version&gt;0.2.9&lt;/wxpay-sdk.version&gt;</span><br><span class="line">    &lt;/properties&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;!-- Spring Boot Starter --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- MyBatis Plus --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.baomidou&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;mybatis-plus-boot-starter&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;mybatis-plus.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- MySQLé©±åŠ¨ --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- Redis --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- æ”¯ä»˜å®SDK --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alipay.sdk&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;alipay-sdk-java&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;alipay-sdk.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- å¾®ä¿¡æ”¯ä»˜SDK --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.github.wxpay&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;wxpay-sdk&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;wxpay-sdk.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- RocketMQ --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.rocketmq&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;rocketmq-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;rocketmq.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- Nacos --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- çŠ¶æ€æœº --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.statemachine&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-statemachine-starter&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;3.2.0&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- åŠ å¯†è§£å¯†å·¥å…· --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.bouncycastle&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;bcprov-jdk15on&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.70&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- äºŒç»´ç ç”Ÿæˆ --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.google.zxing&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;core&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;3.5.1&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- é€šç”¨æ¨¡å— --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.shophub&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;shophub-common&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.0.0&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">        &lt;/plugins&gt;</span><br><span class="line">    &lt;/build&gt;</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure><h3 id="2-æ”¯ä»˜æœåŠ¡é…ç½®"><a href="#2-æ”¯ä»˜æœåŠ¡é…ç½®" class="headerlink" title="2. æ”¯ä»˜æœåŠ¡é…ç½®"></a>2. æ”¯ä»˜æœåŠ¡é…ç½®</h3><p>yaml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"># application.yml</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: shophub-payment</span><br><span class="line">  profiles:</span><br><span class="line">    active: dev</span><br><span class="line">  </span><br><span class="line">  # æ•°æ®æºé…ç½®</span><br><span class="line">  datasource:</span><br><span class="line">    driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="line">    url: jdbc:mysql://$&#123;MYSQL_HOST:localhost&#125;:3306/shophub_payment?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=Asia/Shanghai&amp;useSSL=false</span><br><span class="line">    username: $&#123;MYSQL_USER:root&#125;</span><br><span class="line">    password: $&#123;MYSQL_PASSWORD:root123&#125;</span><br><span class="line">    hikari:</span><br><span class="line">      connection-timeout: 30000</span><br><span class="line">      maximum-pool-size: 20</span><br><span class="line">      minimum-idle: 5</span><br><span class="line">      idle-timeout: 600000</span><br><span class="line">      max-lifetime: 1800000</span><br><span class="line">  </span><br><span class="line">  # Redisé…ç½®</span><br><span class="line">  redis:</span><br><span class="line">    host: $&#123;REDIS_HOST:localhost&#125;</span><br><span class="line">    port: $&#123;REDIS_PORT:6379&#125;</span><br><span class="line">    password: $&#123;REDIS_PASSWORD:redis123&#125;</span><br><span class="line">    database: 4</span><br><span class="line">    lettuce:</span><br><span class="line">      pool:</span><br><span class="line">        max-active: 20</span><br><span class="line">        max-wait: -1ms</span><br><span class="line">        max-idle: 10</span><br><span class="line">        min-idle: 0</span><br><span class="line">  </span><br><span class="line">  # RocketMQé…ç½®</span><br><span class="line">  rocketmq:</span><br><span class="line">    name-server: $&#123;ROCKETMQ_HOST:localhost&#125;:9876</span><br><span class="line">    producer:</span><br><span class="line">      group: payment-producer-group</span><br><span class="line">  </span><br><span class="line">  # Nacosé…ç½®</span><br><span class="line">  cloud:</span><br><span class="line">    nacos:</span><br><span class="line">      discovery:</span><br><span class="line">        server-addr: $&#123;NACOS_HOST:localhost&#125;:$&#123;NACOS_PORT:8848&#125;</span><br><span class="line">        namespace: public</span><br><span class="line">        group: DEFAULT_GROUP</span><br><span class="line"></span><br><span class="line"># æ”¯ä»˜å®é…ç½®</span><br><span class="line">alipay:</span><br><span class="line">  app-id: $&#123;ALIPAY_APP_ID&#125;</span><br><span class="line">  merchant-private-key: $&#123;ALIPAY_MERCHANT_PRIVATE_KEY&#125;</span><br><span class="line">  alipay-public-key: $&#123;ALIPAY_PUBLIC_KEY&#125;</span><br><span class="line">  gateway: https://openapi.alipay.com/gateway.do</span><br><span class="line">  notify-url: $&#123;PAYMENT_NOTIFY_URL&#125;/api/payment/alipay/notify</span><br><span class="line">  return-url: $&#123;PAYMENT_RETURN_URL&#125;/api/payment/alipay/return</span><br><span class="line">  charset: UTF-8</span><br><span class="line">  format: JSON</span><br><span class="line">  sign-type: RSA2</span><br><span class="line"></span><br><span class="line"># å¾®ä¿¡æ”¯ä»˜é…ç½®</span><br><span class="line">wechat:</span><br><span class="line">  app-id: $&#123;WECHAT_APP_ID&#125;</span><br><span class="line">  mch-id: $&#123;WECHAT_MCH_ID&#125;</span><br><span class="line">  mch-key: $&#123;WECHAT_MCH_KEY&#125;</span><br><span class="line">  key-path: $&#123;WECHAT_KEY_PATH&#125;</span><br><span class="line">  cert-path: $&#123;WECHAT_CERT_PATH&#125;</span><br><span class="line">  notify-url: $&#123;PAYMENT_NOTIFY_URL&#125;/api/payment/wechat/notify</span><br><span class="line">  trade-type: JSAPI</span><br><span class="line"></span><br><span class="line"># æ”¯ä»˜æœåŠ¡é…ç½®</span><br><span class="line">payment:</span><br><span class="line">  # æ”¯ä»˜è¶…æ—¶æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰</span><br><span class="line">  timeout: 30</span><br><span class="line">  # å¯¹è´¦æ—¶é—´ï¼ˆæ¯å¤©å‡Œæ™¨2ç‚¹ï¼‰</span><br><span class="line">  reconcile-time: 0 0 2 * * ?</span><br><span class="line">  # æœ€å¤§é‡è¯•æ¬¡æ•°</span><br><span class="line">  max-retry: 3</span><br><span class="line"></span><br><span class="line"># æœåŠ¡ç«¯å£</span><br><span class="line">server:</span><br><span class="line">  port: 8086</span><br><span class="line">  servlet:</span><br><span class="line">    context-path: /payment</span><br><span class="line">  tomcat:</span><br><span class="line">    max-swallow-size: -1</span><br><span class="line"></span><br><span class="line"># æ—¥å¿—é…ç½®</span><br><span class="line">logging:</span><br><span class="line">  level:</span><br><span class="line">    com.shophub.payment: debug</span><br><span class="line">    org.apache.rocketmq: warn</span><br><span class="line">  pattern:</span><br><span class="line">    console: &#x27;%d&#123;yyyy-MM-dd HH:mm:ss&#125; [%thread] %-5level %logger&#123;36&#125; - %msg%n&#x27;</span><br><span class="line">  file:</span><br><span class="line">    name: logs/payment-service.log</span><br><span class="line">    max-size: 10MB</span><br><span class="line">    max-history: 30</span><br><span class="line"></span><br><span class="line"># ç®¡ç†ç«¯ç‚¹</span><br><span class="line">management:</span><br><span class="line">  endpoints:</span><br><span class="line">    web:</span><br><span class="line">      exposure:</span><br><span class="line">        include: health,info,metrics,prometheus</span><br><span class="line">  endpoint:</span><br><span class="line">    health:</span><br><span class="line">      show-details: always</span><br></pre></td></tr></table></figure><h3 id="3-æ”¯ä»˜è¡¨è®¾è®¡"><a href="#3-æ”¯ä»˜è¡¨è®¾è®¡" class="headerlink" title="3. æ”¯ä»˜è¡¨è®¾è®¡"></a>3. æ”¯ä»˜è¡¨è®¾è®¡</h3><p>sql</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">-- æ”¯ä»˜è®°å½•è¡¨</span><br><span class="line">CREATE TABLE `payment_record` (</span><br><span class="line">  `id` bigint(20) NOT NULL COMMENT &#x27;æ”¯ä»˜è®°å½•ID&#x27;,</span><br><span class="line">  `payment_no` varchar(32) NOT NULL COMMENT &#x27;æ”¯ä»˜æµæ°´å·&#x27;,</span><br><span class="line">  `order_no` varchar(32) NOT NULL COMMENT &#x27;è®¢å•å·&#x27;,</span><br><span class="line">  `order_id` bigint(20) NOT NULL COMMENT &#x27;è®¢å•ID&#x27;,</span><br><span class="line">  `user_id` bigint(20) NOT NULL COMMENT &#x27;ç”¨æˆ·ID&#x27;,</span><br><span class="line">  `amount` decimal(10,2) NOT NULL COMMENT &#x27;æ”¯ä»˜é‡‘é¢&#x27;,</span><br><span class="line">  `pay_type` tinyint(1) NOT NULL COMMENT &#x27;æ”¯ä»˜æ–¹å¼ï¼š1-æ”¯ä»˜å®ï¼Œ2-å¾®ä¿¡ï¼Œ3-é“¶è”&#x27;,</span><br><span class="line">  `status` tinyint(1) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;æ”¯ä»˜çŠ¶æ€ï¼š0-å¾…æ”¯ä»˜ï¼Œ1-æ”¯ä»˜æˆåŠŸï¼Œ2-æ”¯ä»˜å¤±è´¥ï¼Œ3-å·²é€€æ¬¾&#x27;,</span><br><span class="line">  `third_party_no` varchar(100) DEFAULT NULL COMMENT &#x27;ç¬¬ä¸‰æ–¹æ”¯ä»˜æµæ°´å·&#x27;,</span><br><span class="line">  `third_party_data` text COMMENT &#x27;ç¬¬ä¸‰æ–¹æ”¯ä»˜è¿”å›æ•°æ®&#x27;,</span><br><span class="line">  `pay_time` datetime DEFAULT NULL COMMENT &#x27;æ”¯ä»˜æ—¶é—´&#x27;,</span><br><span class="line">  `refund_time` datetime DEFAULT NULL COMMENT &#x27;é€€æ¬¾æ—¶é—´&#x27;,</span><br><span class="line">  `notify_time` datetime DEFAULT NULL COMMENT &#x27;é€šçŸ¥æ—¶é—´&#x27;,</span><br><span class="line">  `notify_count` int(11) DEFAULT &#x27;0&#x27; COMMENT &#x27;é€šçŸ¥æ¬¡æ•°&#x27;,</span><br><span class="line">  `notify_result` varchar(500) DEFAULT NULL COMMENT &#x27;é€šçŸ¥ç»“æœ&#x27;,</span><br><span class="line">  `is_deleted` tinyint(1) DEFAULT &#x27;0&#x27; COMMENT &#x27;æ˜¯å¦åˆ é™¤ï¼š0-å¦ï¼Œ1-æ˜¯&#x27;,</span><br><span class="line">  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;åˆ›å»ºæ—¶é—´&#x27;,</span><br><span class="line">  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &#x27;æ›´æ–°æ—¶é—´&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_payment_no` (`payment_no`),</span><br><span class="line">  UNIQUE KEY `uk_order_no` (`order_no`),</span><br><span class="line">  KEY `idx_user_id` (`user_id`),</span><br><span class="line">  KEY `idx_status` (`status`),</span><br><span class="line">  KEY `idx_create_time` (`create_time`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=&#x27;æ”¯ä»˜è®°å½•è¡¨&#x27;;</span><br><span class="line"></span><br><span class="line">-- é€€æ¬¾è®°å½•è¡¨</span><br><span class="line">CREATE TABLE `refund_record` (</span><br><span class="line">  `id` bigint(20) NOT NULL COMMENT &#x27;é€€æ¬¾è®°å½•ID&#x27;,</span><br><span class="line">  `refund_no` varchar(32) NOT NULL COMMENT &#x27;é€€æ¬¾æµæ°´å·&#x27;,</span><br><span class="line">  `payment_no` varchar(32) NOT NULL COMMENT &#x27;æ”¯ä»˜æµæ°´å·&#x27;,</span><br><span class="line">  `order_no` varchar(32) NOT NULL COMMENT &#x27;è®¢å•å·&#x27;,</span><br><span class="line">  `user_id` bigint(20) NOT NULL COMMENT &#x27;ç”¨æˆ·ID&#x27;,</span><br><span class="line">  `refund_amount` decimal(10,2) NOT NULL COMMENT &#x27;é€€æ¬¾é‡‘é¢&#x27;,</span><br><span class="line">  `refund_reason` varchar(500) DEFAULT NULL COMMENT &#x27;é€€æ¬¾åŸå› &#x27;,</span><br><span class="line">  `status` tinyint(1) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;é€€æ¬¾çŠ¶æ€ï¼š0-ç”³è¯·ä¸­ï¼Œ1-é€€æ¬¾æˆåŠŸï¼Œ2-é€€æ¬¾å¤±è´¥&#x27;,</span><br><span class="line">  `third_party_refund_no` varchar(100) DEFAULT NULL COMMENT &#x27;ç¬¬ä¸‰æ–¹é€€æ¬¾æµæ°´å·&#x27;,</span><br><span class="line">  `third_party_data` text COMMENT &#x27;ç¬¬ä¸‰æ–¹é€€æ¬¾è¿”å›æ•°æ®&#x27;,</span><br><span class="line">  `refund_time` datetime DEFAULT NULL COMMENT &#x27;é€€æ¬¾æ—¶é—´&#x27;,</span><br><span class="line">  `notify_time` datetime DEFAULT NULL COMMENT &#x27;é€šçŸ¥æ—¶é—´&#x27;,</span><br><span class="line">  `is_deleted` tinyint(1) DEFAULT &#x27;0&#x27; COMMENT &#x27;æ˜¯å¦åˆ é™¤ï¼š0-å¦ï¼Œ1-æ˜¯&#x27;,</span><br><span class="line">  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;åˆ›å»ºæ—¶é—´&#x27;,</span><br><span class="line">  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &#x27;æ›´æ–°æ—¶é—´&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_refund_no` (`refund_no`),</span><br><span class="line">  KEY `idx_payment_no` (`payment_no`),</span><br><span class="line">  KEY `idx_order_no` (`order_no`),</span><br><span class="line">  KEY `idx_user_id` (`user_id`),</span><br><span class="line">  KEY `idx_status` (`status`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=&#x27;é€€æ¬¾è®°å½•è¡¨&#x27;;</span><br><span class="line"></span><br><span class="line">-- å¯¹è´¦è®°å½•è¡¨</span><br><span class="line">CREATE TABLE `reconcile_record` (</span><br><span class="line">  `id` bigint(20) NOT NULL COMMENT &#x27;å¯¹è´¦è®°å½•ID&#x27;,</span><br><span class="line">  `reconcile_date` date NOT NULL COMMENT &#x27;å¯¹è´¦æ—¥æœŸ&#x27;,</span><br><span class="line">  `pay_type` tinyint(1) NOT NULL COMMENT &#x27;æ”¯ä»˜æ–¹å¼ï¼š1-æ”¯ä»˜å®ï¼Œ2-å¾®ä¿¡&#x27;,</span><br><span class="line">  `total_count` int(11) DEFAULT &#x27;0&#x27; COMMENT &#x27;æ€»ç¬”æ•°&#x27;,</span><br><span class="line">  `total_amount` decimal(15,2) DEFAULT &#x27;0.00&#x27; COMMENT &#x27;æ€»é‡‘é¢&#x27;,</span><br><span class="line">  `success_count` int(11) DEFAULT &#x27;0&#x27; COMMENT &#x27;æˆåŠŸç¬”æ•°&#x27;,</span><br><span class="line">  `success_amount` decimal(15,2) DEFAULT &#x27;0.00&#x27; COMMENT &#x27;æˆåŠŸé‡‘é¢&#x27;,</span><br><span class="line">  `fail_count` int(11) DEFAULT &#x27;0&#x27; COMMENT &#x27;å¤±è´¥ç¬”æ•°&#x27;,</span><br><span class="line">  `fail_amount` decimal(15,2) DEFAULT &#x27;0.00&#x27; COMMENT &#x27;å¤±è´¥é‡‘é¢&#x27;,</span><br><span class="line">  `exception_count` int(11) DEFAULT &#x27;0&#x27; COMMENT &#x27;å¼‚å¸¸ç¬”æ•°&#x27;,</span><br><span class="line">  `exception_amount` decimal(15,2) DEFAULT &#x27;0.00&#x27; COMMENT &#x27;å¼‚å¸¸é‡‘é¢&#x27;,</span><br><span class="line">  `reconcile_status` tinyint(1) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;å¯¹è´¦çŠ¶æ€ï¼š0-å¾…å¯¹è´¦ï¼Œ1-å¯¹è´¦ä¸­ï¼Œ2-å¯¹è´¦å®Œæˆï¼Œ3-å¯¹è´¦å¼‚å¸¸&#x27;,</span><br><span class="line">  `reconcile_result` text COMMENT &#x27;å¯¹è´¦ç»“æœè¯¦æƒ…&#x27;,</span><br><span class="line">  `reconcile_time` datetime DEFAULT NULL COMMENT &#x27;å¯¹è´¦æ—¶é—´&#x27;,</span><br><span class="line">  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;åˆ›å»ºæ—¶é—´&#x27;,</span><br><span class="line">  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &#x27;æ›´æ–°æ—¶é—´&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_reconcile_date_type` (`reconcile_date`,`pay_type`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=&#x27;å¯¹è´¦è®°å½•è¡¨&#x27;;</span><br></pre></td></tr></table></figure><h3 id="4-æ”¯ä»˜ç­–ç•¥æ¨¡å¼å®ç°"><a href="#4-æ”¯ä»˜ç­–ç•¥æ¨¡å¼å®ç°" class="headerlink" title="4. æ”¯ä»˜ç­–ç•¥æ¨¡å¼å®ç°"></a>4. æ”¯ä»˜ç­–ç•¥æ¨¡å¼å®ç°</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.payment.strategy;</span><br><span class="line"></span><br><span class="line">import com.shophub.payment.entity.PaymentRecord;</span><br><span class="line"></span><br><span class="line">import java.math.BigDecimal;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * æ”¯ä»˜ç­–ç•¥æ¥å£</span><br><span class="line"> */</span><br><span class="line">public interface PaymentStrategy &#123;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ”¯ä»˜</span><br><span class="line">     */</span><br><span class="line">    PayResult pay(PaymentRecord paymentRecord, Map&lt;String, String&gt; params);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * é€€æ¬¾</span><br><span class="line">     */</span><br><span class="line">    RefundResult refund(String paymentNo, BigDecimal refundAmount, String refundReason);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€</span><br><span class="line">     */</span><br><span class="line">    PayStatusResult queryPayStatus(String paymentNo);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å¤„ç†æ”¯ä»˜é€šçŸ¥</span><br><span class="line">     */</span><br><span class="line">    PayNotifyResult handleNotify(Map&lt;String, String&gt; notifyParams);</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è·å–æ”¯ä»˜æ–¹å¼</span><br><span class="line">     */</span><br><span class="line">    Integer getPayType();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * æ”¯ä»˜å®æ”¯ä»˜ç­–ç•¥</span><br><span class="line"> */</span><br><span class="line">@Component</span><br><span class="line">@Slf4j</span><br><span class="line">class AlipayStrategy implements PaymentStrategy &#123;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;alipay.app-id&#125;&quot;)</span><br><span class="line">    private String appId;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;alipay.merchant-private-key&#125;&quot;)</span><br><span class="line">    private String merchantPrivateKey;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;alipay.alipay-public-key&#125;&quot;)</span><br><span class="line">    private String alipayPublicKey;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;alipay.gateway&#125;&quot;)</span><br><span class="line">    private String gateway;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;alipay.notify-url&#125;&quot;)</span><br><span class="line">    private String notifyUrl;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;alipay.return-url&#125;&quot;)</span><br><span class="line">    private String returnUrl;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public PayResult pay(PaymentRecord paymentRecord, Map&lt;String, String&gt; params) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            // åˆ›å»ºæ”¯ä»˜å®å®¢æˆ·ç«¯</span><br><span class="line">            AlipayClient alipayClient = new DefaultAlipayClient(</span><br><span class="line">                    gateway, appId, merchantPrivateKey, </span><br><span class="line">                    &quot;JSON&quot;, &quot;UTF-8&quot;, alipayPublicKey, &quot;RSA2&quot;);</span><br><span class="line">            </span><br><span class="line">            // åˆ›å»ºæ”¯ä»˜è¯·æ±‚</span><br><span class="line">            AlipayTradePagePayRequest request = new AlipayTradePagePayRequest();</span><br><span class="line">            request.setReturnUrl(returnUrl);</span><br><span class="line">            request.setNotifyUrl(notifyUrl);</span><br><span class="line">            </span><br><span class="line">            // è®¾ç½®ä¸šåŠ¡å‚æ•°</span><br><span class="line">            AlipayTradePagePayModel model = new AlipayTradePagePayModel();</span><br><span class="line">            model.setOutTradeNo(paymentRecord.getPaymentNo());</span><br><span class="line">            model.setTotalAmount(paymentRecord.getAmount().toString());</span><br><span class="line">            model.setSubject(&quot;ShopHubè®¢å•æ”¯ä»˜&quot;);</span><br><span class="line">            model.setBody(paymentRecord.getOrderNo());</span><br><span class="line">            model.setProductCode(&quot;FAST_INSTANT_TRADE_PAY&quot;);</span><br><span class="line">            model.setTimeExpire(&quot;30m&quot;); // 30åˆ†é’Ÿè¶…æ—¶</span><br><span class="line">            </span><br><span class="line">            request.setBizModel(model);</span><br><span class="line">            </span><br><span class="line">            // è°ƒç”¨æ”¯ä»˜</span><br><span class="line">            AlipayTradePagePayResponse response = alipayClient.pageExecute(request);</span><br><span class="line">            </span><br><span class="line">            if (response.isSuccess()) &#123;</span><br><span class="line">                return PayResult.builder()</span><br><span class="line">                        .success(true)</span><br><span class="line">                        .paymentNo(paymentRecord.getPaymentNo())</span><br><span class="line">                        .thirdPartyNo(response.getTradeNo())</span><br><span class="line">                        .payData(response.getBody())</span><br><span class="line">                        .build();</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                return PayResult.builder()</span><br><span class="line">                        .success(false)</span><br><span class="line">                        .errorCode(response.getCode())</span><br><span class="line">                        .errorMsg(response.getMsg())</span><br><span class="line">                        .build();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;æ”¯ä»˜å®æ”¯ä»˜å¤±è´¥&quot;, e);</span><br><span class="line">            return PayResult.builder()</span><br><span class="line">                    .success(false)</span><br><span class="line">                    .errorMsg(&quot;æ”¯ä»˜å®æ”¯ä»˜å¤±è´¥ï¼š&quot; + e.getMessage())</span><br><span class="line">                    .build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public RefundResult refund(String paymentNo, BigDecimal refundAmount, String refundReason) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            // æ”¯ä»˜å®é€€æ¬¾å®ç°</span><br><span class="line">            // ...</span><br><span class="line">            return RefundResult.builder()</span><br><span class="line">                    .success(true)</span><br><span class="line">                    .refundNo(paymentNo)</span><br><span class="line">                    .build();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;æ”¯ä»˜å®é€€æ¬¾å¤±è´¥&quot;, e);</span><br><span class="line">            return RefundResult.builder()</span><br><span class="line">                    .success(false)</span><br><span class="line">                    .errorMsg(&quot;æ”¯ä»˜å®é€€æ¬¾å¤±è´¥ï¼š&quot; + e.getMessage())</span><br><span class="line">                    .build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public PayStatusResult queryPayStatus(String paymentNo) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            // æ”¯ä»˜å®æŸ¥è¯¢å®ç°</span><br><span class="line">            // ...</span><br><span class="line">            return PayStatusResult.builder()</span><br><span class="line">                    .success(true)</span><br><span class="line">                    .payStatus(1)</span><br><span class="line">                    .build();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;æ”¯ä»˜å®æŸ¥è¯¢å¤±è´¥&quot;, e);</span><br><span class="line">            return PayStatusResult.builder()</span><br><span class="line">                    .success(false)</span><br><span class="line">                    .errorMsg(&quot;æ”¯ä»˜å®æŸ¥è¯¢å¤±è´¥ï¼š&quot; + e.getMessage())</span><br><span class="line">                    .build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public PayNotifyResult handleNotify(Map&lt;String, String&gt; notifyParams) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            // éªŒè¯ç­¾å</span><br><span class="line">            boolean signVerified = AlipaySignature.rsaCheckV1(</span><br><span class="line">                    notifyParams, alipayPublicKey, &quot;UTF-8&quot;, &quot;RSA2&quot;);</span><br><span class="line">            </span><br><span class="line">            if (!signVerified) &#123;</span><br><span class="line">                return PayNotifyResult.builder()</span><br><span class="line">                        .success(false)</span><br><span class="line">                        .errorMsg(&quot;ç­¾åéªŒè¯å¤±è´¥&quot;)</span><br><span class="line">                        .build();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            String tradeStatus = notifyParams.get(&quot;trade_status&quot;);</span><br><span class="line">            String outTradeNo = notifyParams.get(&quot;out_trade_no&quot;);</span><br><span class="line">            String tradeNo = notifyParams.get(&quot;trade_no&quot;);</span><br><span class="line">            </span><br><span class="line">            if (&quot;TRADE_SUCCESS&quot;.equals(tradeStatus) || </span><br><span class="line">                &quot;TRADE_FINISHED&quot;.equals(tradeStatus)) &#123;</span><br><span class="line">                return PayNotifyResult.builder()</span><br><span class="line">                        .success(true)</span><br><span class="line">                        .paymentNo(outTradeNo)</span><br><span class="line">                        .thirdPartyNo(tradeNo)</span><br><span class="line">                        .payAmount(new BigDecimal(notifyParams.get(&quot;total_amount&quot;)))</span><br><span class="line">                        .payTime(notifyParams.get(&quot;gmt_payment&quot;))</span><br><span class="line">                        .build();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            return PayNotifyResult.builder()</span><br><span class="line">                    .success(false)</span><br><span class="line">                    .errorMsg(&quot;äº¤æ˜“æœªæˆåŠŸï¼š&quot; + tradeStatus)</span><br><span class="line">                    .build();</span><br><span class="line">            </span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;å¤„ç†æ”¯ä»˜å®é€šçŸ¥å¤±è´¥&quot;, e);</span><br><span class="line">            return PayNotifyResult.builder()</span><br><span class="line">                    .success(false)</span><br><span class="line">                    .errorMsg(&quot;å¤„ç†æ”¯ä»˜å®é€šçŸ¥å¤±è´¥ï¼š&quot; + e.getMessage())</span><br><span class="line">                    .build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public Integer getPayType() &#123;</span><br><span class="line">        return 1; // æ”¯ä»˜å®</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * å¾®ä¿¡æ”¯ä»˜ç­–ç•¥</span><br><span class="line"> */</span><br><span class="line">@Component</span><br><span class="line">@Slf4j</span><br><span class="line">class WechatPayStrategy implements PaymentStrategy &#123;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;wechat.app-id&#125;&quot;)</span><br><span class="line">    private String appId;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;wechat.mch-id&#125;&quot;)</span><br><span class="line">    private String mchId;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;wechat.mch-key&#125;&quot;)</span><br><span class="line">    private String mchKey;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;wechat.notify-url&#125;&quot;)</span><br><span class="line">    private String notifyUrl;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public PayResult pay(PaymentRecord paymentRecord, Map&lt;String, String&gt; params) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            // å¾®ä¿¡æ”¯ä»˜å®ç°</span><br><span class="line">            // ...</span><br><span class="line">            return PayResult.builder()</span><br><span class="line">                    .success(true)</span><br><span class="line">                    .paymentNo(paymentRecord.getPaymentNo())</span><br><span class="line">                    .build();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;å¾®ä¿¡æ”¯ä»˜å¤±è´¥&quot;, e);</span><br><span class="line">            return PayResult.builder()</span><br><span class="line">                    .success(false)</span><br><span class="line">                    .errorMsg(&quot;å¾®ä¿¡æ”¯ä»˜å¤±è´¥ï¼š&quot; + e.getMessage())</span><br><span class="line">                    .build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // å…¶ä»–æ–¹æ³•å®ç°ç±»ä¼¼...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * æ”¯ä»˜ç­–ç•¥å·¥å‚</span><br><span class="line"> */</span><br><span class="line">@Component</span><br><span class="line">public class PaymentStrategyFactory &#123;</span><br><span class="line">    </span><br><span class="line">    private final Map&lt;Integer, PaymentStrategy&gt; strategyMap;</span><br><span class="line">    </span><br><span class="line">    public PaymentStrategyFactory(List&lt;PaymentStrategy&gt; strategies) &#123;</span><br><span class="line">        strategyMap = strategies.stream()</span><br><span class="line">                .collect(Collectors.toMap(</span><br><span class="line">                        PaymentStrategy::getPayType,</span><br><span class="line">                        Function.identity()</span><br><span class="line">                ));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public PaymentStrategy getStrategy(Integer payType) &#123;</span><br><span class="line">        PaymentStrategy strategy = strategyMap.get(payType);</span><br><span class="line">        if (strategy == null) &#123;</span><br><span class="line">            throw new IllegalArgumentException(&quot;ä¸æ”¯æŒçš„æ”¯ä»˜æ–¹å¼ï¼š&quot; + payType);</span><br><span class="line">        &#125;</span><br><span class="line">        return strategy;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-æ”¯ä»˜çŠ¶æ€æœº"><a href="#5-æ”¯ä»˜çŠ¶æ€æœº" class="headerlink" title="5. æ”¯ä»˜çŠ¶æ€æœº"></a>5. æ”¯ä»˜çŠ¶æ€æœº</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.payment.statemachine;</span><br><span class="line"></span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.statemachine.config.EnableStateMachine;</span><br><span class="line">import org.springframework.statemachine.config.EnumStateMachineConfigurerAdapter;</span><br><span class="line">import org.springframework.statemachine.config.builders.StateMachineConfigurationConfigurer;</span><br><span class="line">import org.springframework.statemachine.config.builders.StateMachineStateConfigurer;</span><br><span class="line">import org.springframework.statemachine.config.builders.StateMachineTransitionConfigurer;</span><br><span class="line"></span><br><span class="line">import java.util.EnumSet;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * æ”¯ä»˜çŠ¶æ€æœºé…ç½®</span><br><span class="line"> * çŠ¶æ€ï¼šWAIT_PAY -&gt; PAYING -&gt; SUCCESS/FAILED -&gt; REFUNDED</span><br><span class="line"> */</span><br><span class="line">@Configuration</span><br><span class="line">@EnableStateMachine</span><br><span class="line">public class PaymentStateMachineConfig extends EnumStateMachineConfigurerAdapter&lt;PaymentState, PaymentEvent&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public void configure(StateMachineStateConfigurer&lt;PaymentState, PaymentEvent&gt; states) throws Exception &#123;</span><br><span class="line">        states.withStates()</span><br><span class="line">                .initial(PaymentState.WAIT_PAY)</span><br><span class="line">                .states(EnumSet.allOf(PaymentState.class))</span><br><span class="line">                .end(PaymentState.SUCCESS)</span><br><span class="line">                .end(PaymentState.FAILED)</span><br><span class="line">                .end(PaymentState.REFUNDED);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public void configure(StateMachineTransitionConfigurer&lt;PaymentState, PaymentEvent&gt; transitions) throws Exception &#123;</span><br><span class="line">        transitions</span><br><span class="line">                .withExternal()</span><br><span class="line">                .source(PaymentState.WAIT_PAY).target(PaymentState.PAYING)</span><br><span class="line">                .event(PaymentEvent.PAY_REQUEST)</span><br><span class="line">                .action(payRequestAction())</span><br><span class="line">                </span><br><span class="line">                .and()</span><br><span class="line">                .withExternal()</span><br><span class="line">                .source(PaymentState.PAYING).target(PaymentState.SUCCESS)</span><br><span class="line">                .event(PaymentEvent.PAY_SUCCESS)</span><br><span class="line">                .action(paySuccessAction())</span><br><span class="line">                </span><br><span class="line">                .and()</span><br><span class="line">                .withExternal()</span><br><span class="line">                .source(PaymentState.PAYING).target(PaymentState.FAILED)</span><br><span class="line">                .event(PaymentEvent.PAY_FAIL)</span><br><span class="line">                .action(payFailAction())</span><br><span class="line">                </span><br><span class="line">                .and()</span><br><span class="line">                .withExternal()</span><br><span class="line">                .source(PaymentState.SUCCESS).target(PaymentState.REFUNDED)</span><br><span class="line">                .event(PaymentEvent.REFUND)</span><br><span class="line">                .action(refundAction());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public void configure(StateMachineConfigurationConfigurer&lt;PaymentState, PaymentEvent&gt; config) throws Exception &#123;</span><br><span class="line">        config.withConfiguration()</span><br><span class="line">                .machineId(&quot;paymentStateMachine&quot;)</span><br><span class="line">                .autoStartup(true);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Bean</span><br><span class="line">    public PayRequestAction payRequestAction() &#123;</span><br><span class="line">        return new PayRequestAction();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // å…¶ä»–Actionå®šä¹‰...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æ”¯ä»˜çŠ¶æ€æšä¸¾</span><br><span class="line">enum PaymentState &#123;</span><br><span class="line">    WAIT_PAY,    // å¾…æ”¯ä»˜</span><br><span class="line">    PAYING,      // æ”¯ä»˜ä¸­</span><br><span class="line">    SUCCESS,     // æ”¯ä»˜æˆåŠŸ</span><br><span class="line">    FAILED,      // æ”¯ä»˜å¤±è´¥</span><br><span class="line">    REFUNDED     // å·²é€€æ¬¾</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æ”¯ä»˜äº‹ä»¶æšä¸¾</span><br><span class="line">enum PaymentEvent &#123;</span><br><span class="line">    PAY_REQUEST,  // æ”¯ä»˜è¯·æ±‚</span><br><span class="line">    PAY_SUCCESS,  // æ”¯ä»˜æˆåŠŸ</span><br><span class="line">    PAY_FAIL,     // æ”¯ä»˜å¤±è´¥</span><br><span class="line">    REFUND        // é€€æ¬¾</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-å¯¹è´¦ç³»ç»Ÿå®ç°"><a href="#6-å¯¹è´¦ç³»ç»Ÿå®ç°" class="headerlink" title="6. å¯¹è´¦ç³»ç»Ÿå®ç°"></a>6. å¯¹è´¦ç³»ç»Ÿå®ç°</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.payment.reconcile;</span><br><span class="line"></span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.springframework.scheduling.annotation.Scheduled;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line">import java.time.LocalDate;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * å¯¹è´¦æœåŠ¡</span><br><span class="line"> */</span><br><span class="line">@Slf4j</span><br><span class="line">@Service</span><br><span class="line">public class ReconcileService &#123;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ¯æ—¥å¯¹è´¦ä»»åŠ¡</span><br><span class="line">     */</span><br><span class="line">    @Scheduled(cron = &quot;$&#123;payment.reconcile-time&#125;&quot;)</span><br><span class="line">    public void dailyReconcile() &#123;</span><br><span class="line">        LocalDate reconcileDate = LocalDate.now().minusDays(1);</span><br><span class="line">        log.info(&quot;å¼€å§‹å¯¹è´¦ï¼Œå¯¹è´¦æ—¥æœŸï¼š&#123;&#125;&quot;, reconcileDate);</span><br><span class="line">        </span><br><span class="line">        // å¯¹è´¦æ”¯ä»˜å®</span><br><span class="line">        reconcileAlipay(reconcileDate);</span><br><span class="line">        </span><br><span class="line">        // å¯¹è´¦å¾®ä¿¡</span><br><span class="line">        reconcileWechat(reconcileDate);</span><br><span class="line">        </span><br><span class="line">        log.info(&quot;å¯¹è´¦å®Œæˆï¼Œå¯¹è´¦æ—¥æœŸï¼š&#123;&#125;&quot;, reconcileDate);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ”¯ä»˜å®å¯¹è´¦</span><br><span class="line">     */</span><br><span class="line">    private void reconcileAlipay(LocalDate reconcileDate) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            // 1. ä»æ”¯ä»˜å®ä¸‹è½½å¯¹è´¦å•</span><br><span class="line">            List&lt;AlipayBillRecord&gt; alipayBills = downloadAlipayBill(reconcileDate);</span><br><span class="line">            </span><br><span class="line">            // 2. ä»æ•°æ®åº“æŸ¥è¯¢å½“å¤©çš„æ”¯ä»˜å®æ”¯ä»˜è®°å½•</span><br><span class="line">            List&lt;PaymentRecord&gt; ourRecords = getOurAlipayRecords(reconcileDate);</span><br><span class="line">            </span><br><span class="line">            // 3. å¯¹è´¦</span><br><span class="line">            ReconcileResult result = doReconcile(alipayBills, ourRecords);</span><br><span class="line">            </span><br><span class="line">            // 4. ä¿å­˜å¯¹è´¦ç»“æœ</span><br><span class="line">            saveReconcileResult(reconcileDate, 1, result);</span><br><span class="line">            </span><br><span class="line">            // 5. å¤„ç†å·®å¼‚</span><br><span class="line">            handleDiscrepancies(result.getDiscrepancies());</span><br><span class="line">            </span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;æ”¯ä»˜å®å¯¹è´¦å¤±è´¥ï¼Œæ—¥æœŸï¼š&#123;&#125;&quot;, reconcileDate, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ‰§è¡Œå¯¹è´¦</span><br><span class="line">     */</span><br><span class="line">    private ReconcileResult doReconcile(List&lt;? extends ThirdPartyBillRecord&gt; thirdPartyRecords, </span><br><span class="line">                                       List&lt;PaymentRecord&gt; ourRecords) &#123;</span><br><span class="line">        ReconcileResult result = new ReconcileResult();</span><br><span class="line">        </span><br><span class="line">        // è½¬æ¢ä¸ºMapæ–¹ä¾¿æŸ¥æ‰¾</span><br><span class="line">        Map&lt;String, ThirdPartyBillRecord&gt; thirdPartyMap = thirdPartyRecords.stream()</span><br><span class="line">                .collect(Collectors.toMap(</span><br><span class="line">                        ThirdPartyBillRecord::getOutTradeNo,</span><br><span class="line">                        Function.identity()</span><br><span class="line">                ));</span><br><span class="line">        </span><br><span class="line">        Map&lt;String, PaymentRecord&gt; ourMap = ourRecords.stream()</span><br><span class="line">                .collect(Collectors.toMap(</span><br><span class="line">                        PaymentRecord::getPaymentNo,</span><br><span class="line">                        Function.identity()</span><br><span class="line">                ));</span><br><span class="line">        </span><br><span class="line">        // æ‰¾å‡ºåŒ¹é…çš„è®°å½•</span><br><span class="line">        for (PaymentRecord ourRecord : ourRecords) &#123;</span><br><span class="line">            ThirdPartyBillRecord thirdPartyRecord = thirdPartyMap.get(ourRecord.getPaymentNo());</span><br><span class="line">            </span><br><span class="line">            if (thirdPartyRecord == null) &#123;</span><br><span class="line">                // æˆ‘ä»¬æœ‰ä½†ç¬¬ä¸‰æ–¹æ²¡æœ‰</span><br><span class="line">                result.addDiscrepancy(new Discrepancy(</span><br><span class="line">                        ourRecord.getPaymentNo(),</span><br><span class="line">                        DiscrepancyType.MISSING_IN_THIRD_PARTY,</span><br><span class="line">                        ourRecord.getAmount(),</span><br><span class="line">                        null</span><br><span class="line">                ));</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // æ¯”è¾ƒé‡‘é¢</span><br><span class="line">            if (ourRecord.getAmount().compareTo(thirdPartyRecord.getAmount()) != 0) &#123;</span><br><span class="line">                result.addDiscrepancy(new Discrepancy(</span><br><span class="line">                        ourRecord.getPaymentNo(),</span><br><span class="line">                        DiscrepancyType.AMOUNT_MISMATCH,</span><br><span class="line">                        ourRecord.getAmount(),</span><br><span class="line">                        thirdPartyRecord.getAmount()</span><br><span class="line">                ));</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // æ¯”è¾ƒçŠ¶æ€</span><br><span class="line">            if (!ourRecord.getStatus().equals(thirdPartyRecord.getStatus())) &#123;</span><br><span class="line">                result.addDiscrepancy(new Discrepancy(</span><br><span class="line">                        ourRecord.getPaymentNo(),</span><br><span class="line">                        DiscrepancyType.STATUS_MISMATCH,</span><br><span class="line">                        ourRecord.getStatus(),</span><br><span class="line">                        thirdPartyRecord.getStatus()</span><br><span class="line">                ));</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // åŒ¹é…æˆåŠŸ</span><br><span class="line">            result.addMatchedRecord(new MatchedRecord(</span><br><span class="line">                    ourRecord.getPaymentNo(),</span><br><span class="line">                    ourRecord.getAmount(),</span><br><span class="line">                    ourRecord.getStatus()</span><br><span class="line">            ));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // æ‰¾å‡ºç¬¬ä¸‰æ–¹æœ‰ä½†æˆ‘ä»¬æ²¡æœ‰çš„è®°å½•</span><br><span class="line">        for (ThirdPartyBillRecord thirdPartyRecord : thirdPartyRecords) &#123;</span><br><span class="line">            if (!ourMap.containsKey(thirdPartyRecord.getOutTradeNo())) &#123;</span><br><span class="line">                result.addDiscrepancy(new Discrepancy(</span><br><span class="line">                        thirdPartyRecord.getOutTradeNo(),</span><br><span class="line">                        DiscrepancyType.MISSING_IN_OUR_SYSTEM,</span><br><span class="line">                        null,</span><br><span class="line">                        thirdPartyRecord.getAmount()</span><br><span class="line">                ));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å¤„ç†å·®å¼‚</span><br><span class="line">     */</span><br><span class="line">    private void handleDiscrepancies(List&lt;Discrepancy&gt; discrepancies) &#123;</span><br><span class="line">        for (Discrepancy discrepancy : discrepancies) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                switch (discrepancy.getType()) &#123;</span><br><span class="line">                    case MISSING_IN_THIRD_PARTY:</span><br><span class="line">                        // æˆ‘ä»¬æœ‰ä½†ç¬¬ä¸‰æ–¹æ²¡æœ‰ï¼Œéœ€è¦äººå·¥æ ¸æŸ¥</span><br><span class="line">                        log.warn(&quot;æ”¯ä»˜è®°å½•åœ¨ç¬¬ä¸‰æ–¹ç¼ºå¤±ï¼š&#123;&#125;&quot;, discrepancy.getPaymentNo());</span><br><span class="line">                        break;</span><br><span class="line">                    case MISSING_IN_OUR_SYSTEM:</span><br><span class="line">                        // ç¬¬ä¸‰æ–¹æœ‰ä½†æˆ‘ä»¬æ²¡æœ‰ï¼Œå¯èƒ½æ˜¯æ”¯ä»˜æˆåŠŸä½†æœªæ”¶åˆ°é€šçŸ¥</span><br><span class="line">                        handleMissingRecord(discrepancy);</span><br><span class="line">                        break;</span><br><span class="line">                    case AMOUNT_MISMATCH:</span><br><span class="line">                        // é‡‘é¢ä¸åŒ¹é…ï¼Œéœ€è¦äººå·¥æ ¸æŸ¥</span><br><span class="line">                        log.warn(&quot;æ”¯ä»˜é‡‘é¢ä¸åŒ¹é…ï¼š&#123;&#125;ï¼Œæˆ‘ä»¬ï¼š&#123;&#125;ï¼Œç¬¬ä¸‰æ–¹ï¼š&#123;&#125;&quot;,</span><br><span class="line">                                discrepancy.getPaymentNo(),</span><br><span class="line">                                discrepancy.getOurValue(),</span><br><span class="line">                                discrepancy.getThirdPartyValue());</span><br><span class="line">                        break;</span><br><span class="line">                    case STATUS_MISMATCH:</span><br><span class="line">                        // çŠ¶æ€ä¸åŒ¹é…ï¼Œéœ€è¦åŒæ­¥çŠ¶æ€</span><br><span class="line">                        handleStatusMismatch(discrepancy);</span><br><span class="line">                        break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                log.error(&quot;å¤„ç†å·®å¼‚å¤±è´¥ï¼š&#123;&#125;&quot;, discrepancy.getPaymentNo(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å¤„ç†ç¼ºå¤±è®°å½•</span><br><span class="line">     */</span><br><span class="line">    private void handleMissingRecord(Discrepancy discrepancy) &#123;</span><br><span class="line">        // æŸ¥è¯¢ç¬¬ä¸‰æ–¹æ”¯ä»˜è¯¦æƒ…</span><br><span class="line">        PaymentRecord record = queryThirdPartyDetail(discrepancy.getPaymentNo());</span><br><span class="line">        </span><br><span class="line">        if (record != null) &#123;</span><br><span class="line">            // åˆ›å»ºæ”¯ä»˜è®°å½•</span><br><span class="line">            createPaymentRecord(record);</span><br><span class="line">            </span><br><span class="line">            // æ›´æ–°è®¢å•çŠ¶æ€</span><br><span class="line">            updateOrderStatus(record.getOrderNo(), 1);</span><br><span class="line">            </span><br><span class="line">            log.info(&quot;å·²è¡¥å½•ç¼ºå¤±çš„æ”¯ä»˜è®°å½•ï¼š&#123;&#125;&quot;, discrepancy.getPaymentNo());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// å¯¹è´¦ç»“æœ</span><br><span class="line">@Data</span><br><span class="line">class ReconcileResult &#123;</span><br><span class="line">    private int totalCount;</span><br><span class="line">    private BigDecimal totalAmount;</span><br><span class="line">    private int matchedCount;</span><br><span class="line">    private BigDecimal matchedAmount;</span><br><span class="line">    private int discrepancyCount;</span><br><span class="line">    private BigDecimal discrepancyAmount;</span><br><span class="line">    private List&lt;MatchedRecord&gt; matchedRecords = new ArrayList&lt;&gt;();</span><br><span class="line">    private List&lt;Discrepancy&gt; discrepancies = new ArrayList&lt;&gt;();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// å·®å¼‚ç±»å‹</span><br><span class="line">enum DiscrepancyType &#123;</span><br><span class="line">    MISSING_IN_THIRD_PARTY,    // ç¬¬ä¸‰æ–¹ç¼ºå¤±</span><br><span class="line">    MISSING_IN_OUR_SYSTEM,     // æˆ‘ä»¬ç³»ç»Ÿç¼ºå¤±</span><br><span class="line">    AMOUNT_MISMATCH,           // é‡‘é¢ä¸åŒ¹é…</span><br><span class="line">    STATUS_MISMATCH            // çŠ¶æ€ä¸åŒ¹é…</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// å·®å¼‚è®°å½•</span><br><span class="line">@Data</span><br><span class="line">@AllArgsConstructor</span><br><span class="line">class Discrepancy &#123;</span><br><span class="line">    private String paymentNo;</span><br><span class="line">    private DiscrepancyType type;</span><br><span class="line">    private Object ourValue;</span><br><span class="line">    private Object thirdPartyValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºç¯‡å¹…é™åˆ¶ï¼Œæˆ‘å…ˆå±•ç¤ºæ”¯ä»˜æœåŠ¡çš„æ ¸å¿ƒå®ç°ã€‚æ¥ä¸‹æ¥ç¬¬15å¤©å°†å®ç°é€šçŸ¥æœåŠ¡ï¼ŒåŒ…æ‹¬WebSocketå®æ—¶é€šçŸ¥ã€æ¶ˆæ¯æ¨é€ã€é‚®ä»¶&#x2F;SMSé€šçŸ¥ç­‰ã€‚</p><p>æ˜¯å¦éœ€è¦æˆ‘ç»§ç»­ç¬¬15å¤©çš„å†…å®¹ï¼Ÿ</p><h1 id="ğŸ“¨-ç¬¬å…­é˜¶æ®µï¼šé€šçŸ¥æœåŠ¡å®ç°ï¼ˆWebSocketå®æ—¶é€šçŸ¥-å¤šæ¸ é“æ¨é€ï¼‰"><a href="#ğŸ“¨-ç¬¬å…­é˜¶æ®µï¼šé€šçŸ¥æœåŠ¡å®ç°ï¼ˆWebSocketå®æ—¶é€šçŸ¥-å¤šæ¸ é“æ¨é€ï¼‰" class="headerlink" title="ğŸ“¨ ç¬¬å…­é˜¶æ®µï¼šé€šçŸ¥æœåŠ¡å®ç°ï¼ˆWebSocketå®æ—¶é€šçŸ¥ + å¤šæ¸ é“æ¨é€ï¼‰"></a>ğŸ“¨ ç¬¬å…­é˜¶æ®µï¼šé€šçŸ¥æœåŠ¡å®ç°ï¼ˆWebSocketå®æ—¶é€šçŸ¥ + å¤šæ¸ é“æ¨é€ï¼‰</h1><h2 id="ç¬¬15å¤©ï¼šé€šçŸ¥æœåŠ¡å®ç°"><a href="#ç¬¬15å¤©ï¼šé€šçŸ¥æœåŠ¡å®ç°" class="headerlink" title="ç¬¬15å¤©ï¼šé€šçŸ¥æœåŠ¡å®ç°"></a>ç¬¬15å¤©ï¼šé€šçŸ¥æœåŠ¡å®ç°</h2><h3 id="1-é€šçŸ¥æœåŠ¡é¡¹ç›®ç»“æ„"><a href="#1-é€šçŸ¥æœåŠ¡é¡¹ç›®ç»“æ„" class="headerlink" title="1. é€šçŸ¥æœåŠ¡é¡¹ç›®ç»“æ„"></a>1. é€šçŸ¥æœåŠ¡é¡¹ç›®ç»“æ„</h3><p>xml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- shophub-notification/pom.xml --&gt;</span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;</span><br><span class="line">         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 </span><br><span class="line">         http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;com.shophub&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;shophub-parent&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;1.0.0&lt;/version&gt;</span><br><span class="line">    &lt;/parent&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;artifactId&gt;shophub-notification&lt;/artifactId&gt;</span><br><span class="line">    &lt;packaging&gt;jar&lt;/packaging&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;netty.version&gt;4.1.97.Final&lt;/netty.version&gt;</span><br><span class="line">        &lt;websocket.version&gt;3.1.0&lt;/websocket.version&gt;</span><br><span class="line">        &lt;java-mail.version&gt;1.6.2&lt;/java-mail.version&gt;</span><br><span class="line">        &lt;sms-sdk.version&gt;4.0.6&lt;/sms-sdk.version&gt;</span><br><span class="line">    &lt;/properties&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;!-- Spring Boot Starter --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- WebSocket --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-websocket&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- Netty --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;io.netty&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;netty-all&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;netty.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- MyBatis Plus --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.baomidou&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;mybatis-plus-boot-starter&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;mybatis-plus.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- MySQLé©±åŠ¨ --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- Redis --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- RabbitMQ --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-amqp&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- é‚®ä»¶ --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-mail&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- SMS SDKï¼ˆé˜¿é‡Œäº‘ï¼‰ --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.aliyun&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;aliyun-java-sdk-core&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;4.6.3&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.aliyun&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;aliyun-java-sdk-dysmsapi&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;sms-sdk.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- æ¨¡æ¿å¼•æ“ --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.freemarker&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;freemarker&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-thymeleaf&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- Nacos --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- é€šç”¨æ¨¡å— --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.shophub&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;shophub-common&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.0.0&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">        &lt;/plugins&gt;</span><br><span class="line">    &lt;/build&gt;</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure><h3 id="2-é€šçŸ¥æœåŠ¡é…ç½®"><a href="#2-é€šçŸ¥æœåŠ¡é…ç½®" class="headerlink" title="2. é€šçŸ¥æœåŠ¡é…ç½®"></a>2. é€šçŸ¥æœåŠ¡é…ç½®</h3><p>yaml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br></pre></td><td class="code"><pre><span class="line"># application.yml</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: shophub-notification</span><br><span class="line">  profiles:</span><br><span class="line">    active: dev</span><br><span class="line">  </span><br><span class="line">  # æ•°æ®æºé…ç½®</span><br><span class="line">  datasource:</span><br><span class="line">    driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="line">    url: jdbc:mysql://$&#123;MYSQL_HOST:localhost&#125;:3306/shophub_notification?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=Asia/Shanghai&amp;useSSL=false</span><br><span class="line">    username: $&#123;MYSQL_USER:root&#125;</span><br><span class="line">    password: $&#123;MYSQL_PASSWORD:root123&#125;</span><br><span class="line">    hikari:</span><br><span class="line">      connection-timeout: 30000</span><br><span class="line">      maximum-pool-size: 20</span><br><span class="line">      minimum-idle: 5</span><br><span class="line">      idle-timeout: 600000</span><br><span class="line">      max-lifetime: 1800000</span><br><span class="line">  </span><br><span class="line">  # Redisé…ç½®</span><br><span class="line">  redis:</span><br><span class="line">    host: $&#123;REDIS_HOST:localhost&#125;</span><br><span class="line">    port: $&#123;REDIS_PORT:6379&#125;</span><br><span class="line">    password: $&#123;REDIS_PASSWORD:redis123&#125;</span><br><span class="line">    database: 5</span><br><span class="line">    lettuce:</span><br><span class="line">      pool:</span><br><span class="line">        max-active: 50  # WebSocketéœ€è¦æ›´å¤šè¿æ¥</span><br><span class="line">        max-wait: -1ms</span><br><span class="line">        max-idle: 20</span><br><span class="line">        min-idle: 5</span><br><span class="line">  </span><br><span class="line">  # RabbitMQé…ç½®</span><br><span class="line">  rabbitmq:</span><br><span class="line">    host: $&#123;RABBITMQ_HOST:localhost&#125;</span><br><span class="line">    port: $&#123;RABBITMQ_PORT:5672&#125;</span><br><span class="line">    username: $&#123;RABBITMQ_USER:guest&#125;</span><br><span class="line">    password: $&#123;RABBITMQ_PASSWORD:guest&#125;</span><br><span class="line">    virtual-host: /</span><br><span class="line">    listener:</span><br><span class="line">      simple:</span><br><span class="line">        prefetch: 10</span><br><span class="line">        concurrency: 5</span><br><span class="line">        max-concurrency: 20</span><br><span class="line">    template:</span><br><span class="line">      retry:</span><br><span class="line">        enabled: true</span><br><span class="line">        initial-interval: 1000</span><br><span class="line">        max-attempts: 3</span><br><span class="line">  </span><br><span class="line">  # é‚®ä»¶é…ç½®</span><br><span class="line">  mail:</span><br><span class="line">    host: $&#123;MAIL_HOST:smtp.163.com&#125;</span><br><span class="line">    port: $&#123;MAIL_PORT:465&#125;</span><br><span class="line">    username: $&#123;MAIL_USERNAME&#125;</span><br><span class="line">    password: $&#123;MAIL_PASSWORD&#125;</span><br><span class="line">    protocol: smtps</span><br><span class="line">    default-encoding: UTF-8</span><br><span class="line">    properties:</span><br><span class="line">      mail:</span><br><span class="line">        smtp:</span><br><span class="line">          auth: true</span><br><span class="line">          starttls:</span><br><span class="line">            enable: true</span><br><span class="line">            required: true</span><br><span class="line">          ssl:</span><br><span class="line">            enable: true</span><br><span class="line">        debug: false</span><br><span class="line">  </span><br><span class="line">  # æ¨¡æ¿å¼•æ“</span><br><span class="line">  freemarker:</span><br><span class="line">    template-loader-path: classpath:/templates/</span><br><span class="line">    suffix: .ftl</span><br><span class="line">    charset: UTF-8</span><br><span class="line">    cache: false</span><br><span class="line">  thymeleaf:</span><br><span class="line">    prefix: classpath:/templates/</span><br><span class="line">    suffix: .html</span><br><span class="line">    mode: HTML</span><br><span class="line">    encoding: UTF-8</span><br><span class="line">    cache: false</span><br><span class="line">  </span><br><span class="line">  # Nacosé…ç½®</span><br><span class="line">  cloud:</span><br><span class="line">    nacos:</span><br><span class="line">      discovery:</span><br><span class="line">        server-addr: $&#123;NACOS_HOST:localhost&#125;:$&#123;NACOS_PORT:8848&#125;</span><br><span class="line">        namespace: public</span><br><span class="line">        group: DEFAULT_GROUP</span><br><span class="line"></span><br><span class="line"># WebSocketé…ç½®</span><br><span class="line">websocket:</span><br><span class="line">  enabled: true</span><br><span class="line">  port: 8088</span><br><span class="line">  path: /ws</span><br><span class="line">  max-frame-size: 65536</span><br><span class="line">  max-message-size: 1048576</span><br><span class="line">  idle-timeout: 300000  # 5åˆ†é’Ÿ</span><br><span class="line">  broadcast-interval: 5000  # å¹¿æ’­é—´éš”5ç§’</span><br><span class="line">  </span><br><span class="line">  # å¿ƒè·³é…ç½®</span><br><span class="line">  heartbeat:</span><br><span class="line">    enabled: true</span><br><span class="line">    interval: 30000  # 30ç§’</span><br><span class="line">    timeout: 120000  # 2åˆ†é’Ÿ</span><br><span class="line">  </span><br><span class="line">  # é›†ç¾¤é…ç½®</span><br><span class="line">  cluster:</span><br><span class="line">    enabled: false</span><br><span class="line">    redis-channel: websocket:cluster:channel</span><br><span class="line"></span><br><span class="line"># çŸ­ä¿¡é…ç½®ï¼ˆé˜¿é‡Œäº‘ï¼‰</span><br><span class="line">sms:</span><br><span class="line">  aliyun:</span><br><span class="line">    access-key-id: $&#123;SMS_ACCESS_KEY_ID&#125;</span><br><span class="line">    access-key-secret: $&#123;SMS_ACCESS_KEY_SECRET&#125;</span><br><span class="line">    sign-name: $&#123;SMS_SIGN_NAME&#125;</span><br><span class="line">    template-codes:</span><br><span class="line">      verification: SMS_123456789  # éªŒè¯ç æ¨¡æ¿</span><br><span class="line">      order-paid: SMS_234567890    # è®¢å•æ”¯ä»˜æˆåŠŸ</span><br><span class="line">      order-shipped: SMS_345678901 # è®¢å•å·²å‘è´§</span><br><span class="line">      order-refund: SMS_456789012  # è®¢å•é€€æ¬¾</span><br><span class="line">    endpoint: dysmsapi.aliyuncs.com</span><br><span class="line">    region-id: cn-hangzhou</span><br><span class="line"></span><br><span class="line"># æ¨é€é…ç½®</span><br><span class="line">push:</span><br><span class="line">  # é‡è¯•é…ç½®</span><br><span class="line">  retry:</span><br><span class="line">    max-attempts: 3</span><br><span class="line">    backoff-delay: 1000</span><br><span class="line">  # æ‰¹é‡å‘é€é…ç½®</span><br><span class="line">  batch:</span><br><span class="line">    size: 100</span><br><span class="line">    interval: 5000</span><br><span class="line">  # å»é‡é…ç½®</span><br><span class="line">  deduplication:</span><br><span class="line">    enabled: true</span><br><span class="line">    ttl: 3600  # 1å°æ—¶</span><br><span class="line"></span><br><span class="line"># é€šçŸ¥æœåŠ¡é…ç½®</span><br><span class="line">notification:</span><br><span class="line">  # é€šçŸ¥ç±»å‹é…ç½®</span><br><span class="line">  types:</span><br><span class="line">    - code: system</span><br><span class="line">      name: ç³»ç»Ÿé€šçŸ¥</span><br><span class="line">      channels: [websocket, app_push]</span><br><span class="line">    - code: order</span><br><span class="line">      name: è®¢å•é€šçŸ¥</span><br><span class="line">      channels: [websocket, sms, email, app_push]</span><br><span class="line">    - code: promotion</span><br><span class="line">      name: è¥é”€é€šçŸ¥</span><br><span class="line">      channels: [email, app_push]</span><br><span class="line">    - code: security</span><br><span class="line">      name: å®‰å…¨é€šçŸ¥</span><br><span class="line">      channels: [sms, email]</span><br><span class="line">  </span><br><span class="line">  # æ¸ é“é…ç½®</span><br><span class="line">  channels:</span><br><span class="line">    websocket:</span><br><span class="line">      enabled: true</span><br><span class="line">      priority: 1</span><br><span class="line">    sms:</span><br><span class="line">      enabled: true</span><br><span class="line">      priority: 2</span><br><span class="line">      daily-limit: 10  # æ¯æ—¥å‘é€é™åˆ¶</span><br><span class="line">    email:</span><br><span class="line">      enabled: true</span><br><span class="line">      priority: 3</span><br><span class="line">      daily-limit: 20</span><br><span class="line">    app_push:</span><br><span class="line">      enabled: true</span><br><span class="line">      priority: 4</span><br><span class="line">  </span><br><span class="line">  # æ¨¡æ¿é…ç½®</span><br><span class="line">  templates:</span><br><span class="line">    order_paid:</span><br><span class="line">      title: &quot;è®¢å•æ”¯ä»˜æˆåŠŸ&quot;</span><br><span class="line">      content: &quot;æ‚¨çš„è®¢å•&#123;orderNo&#125;å·²æ”¯ä»˜æˆåŠŸï¼Œæ”¯ä»˜é‡‘é¢ï¼š&#123;amount&#125;å…ƒ&quot;</span><br><span class="line">      channels: [websocket, sms, email, app_push]</span><br><span class="line">    order_shipped:</span><br><span class="line">      title: &quot;è®¢å•å·²å‘è´§&quot;</span><br><span class="line">      content: &quot;æ‚¨çš„è®¢å•&#123;orderNo&#125;å·²å‘è´§ï¼Œç‰©æµå…¬å¸ï¼š&#123;deliveryCompany&#125;ï¼Œç‰©æµå•å·ï¼š&#123;deliveryNo&#125;&quot;</span><br><span class="line">      channels: [websocket, sms, email, app_push]</span><br><span class="line">    verification_code:</span><br><span class="line">      title: &quot;éªŒè¯ç &quot;</span><br><span class="line">      content: &quot;æ‚¨çš„éªŒè¯ç æ˜¯ï¼š&#123;code&#125;ï¼Œæœ‰æ•ˆæœŸ10åˆ†é’Ÿ&quot;</span><br><span class="line">      channels: [sms]</span><br><span class="line"></span><br><span class="line"># æœåŠ¡ç«¯å£</span><br><span class="line">server:</span><br><span class="line">  port: 8087</span><br><span class="line">  servlet:</span><br><span class="line">    context-path: /notification</span><br><span class="line">  tomcat:</span><br><span class="line">    max-swallow-size: -1</span><br><span class="line"></span><br><span class="line"># æ—¥å¿—é…ç½®</span><br><span class="line">logging:</span><br><span class="line">  level:</span><br><span class="line">    com.shophub.notification: debug</span><br><span class="line">    org.springframework.web.socket: debug</span><br><span class="line">    io.netty: warn</span><br><span class="line">  pattern:</span><br><span class="line">    console: &#x27;%d&#123;yyyy-MM-dd HH:mm:ss&#125; [%thread] %-5level %logger&#123;36&#125; - %msg%n&#x27;</span><br><span class="line">  file:</span><br><span class="line">    name: logs/notification-service.log</span><br><span class="line">    max-size: 10MB</span><br><span class="line">    max-history: 30</span><br><span class="line"></span><br><span class="line"># ç®¡ç†ç«¯ç‚¹</span><br><span class="line">management:</span><br><span class="line">  endpoints:</span><br><span class="line">    web:</span><br><span class="line">      exposure:</span><br><span class="line">        include: health,info,metrics,prometheus,websocket</span><br><span class="line">  endpoint:</span><br><span class="line">    health:</span><br><span class="line">      show-details: always</span><br></pre></td></tr></table></figure><h3 id="3-æ•°æ®åº“è¡¨è®¾è®¡"><a href="#3-æ•°æ®åº“è¡¨è®¾è®¡" class="headerlink" title="3. æ•°æ®åº“è¡¨è®¾è®¡"></a>3. æ•°æ®åº“è¡¨è®¾è®¡</h3><p>sql</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line">-- é€šçŸ¥æ¨¡æ¿è¡¨</span><br><span class="line">CREATE TABLE `notification_template` (</span><br><span class="line">  `id` bigint(20) NOT NULL COMMENT &#x27;æ¨¡æ¿ID&#x27;,</span><br><span class="line">  `template_code` varchar(50) NOT NULL COMMENT &#x27;æ¨¡æ¿ç¼–ç &#x27;,</span><br><span class="line">  `template_name` varchar(100) NOT NULL COMMENT &#x27;æ¨¡æ¿åç§°&#x27;,</span><br><span class="line">  `template_type` varchar(20) NOT NULL COMMENT &#x27;æ¨¡æ¿ç±»å‹ï¼šsystem, order, promotion, security&#x27;,</span><br><span class="line">  `title` varchar(200) NOT NULL COMMENT &#x27;é€šçŸ¥æ ‡é¢˜&#x27;,</span><br><span class="line">  `content` text NOT NULL COMMENT &#x27;é€šçŸ¥å†…å®¹æ¨¡æ¿&#x27;,</span><br><span class="line">  `variables` varchar(500) DEFAULT NULL COMMENT &#x27;æ¨¡æ¿å˜é‡è¯´æ˜&#x27;,</span><br><span class="line">  `channels` varchar(200) NOT NULL COMMENT &#x27;æ”¯æŒçš„æ¸ é“ï¼šwebsocket,sms,email,app_push&#x27;,</span><br><span class="line">  `status` tinyint(1) NOT NULL DEFAULT &#x27;1&#x27; COMMENT &#x27;çŠ¶æ€ï¼š1-å¯ç”¨ï¼Œ0-ç¦ç”¨&#x27;,</span><br><span class="line">  `is_deleted` tinyint(1) DEFAULT &#x27;0&#x27; COMMENT &#x27;æ˜¯å¦åˆ é™¤ï¼š0-å¦ï¼Œ1-æ˜¯&#x27;,</span><br><span class="line">  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;åˆ›å»ºæ—¶é—´&#x27;,</span><br><span class="line">  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &#x27;æ›´æ–°æ—¶é—´&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_template_code` (`template_code`),</span><br><span class="line">  KEY `idx_template_type` (`template_type`),</span><br><span class="line">  KEY `idx_status` (`status`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=&#x27;é€šçŸ¥æ¨¡æ¿è¡¨&#x27;;</span><br><span class="line"></span><br><span class="line">-- é€šçŸ¥è®°å½•è¡¨</span><br><span class="line">CREATE TABLE `notification_record` (</span><br><span class="line">  `id` bigint(20) NOT NULL COMMENT &#x27;é€šçŸ¥ID&#x27;,</span><br><span class="line">  `notification_no` varchar(32) NOT NULL COMMENT &#x27;é€šçŸ¥ç¼–å·&#x27;,</span><br><span class="line">  `user_id` bigint(20) NOT NULL COMMENT &#x27;ç”¨æˆ·ID&#x27;,</span><br><span class="line">  `template_code` varchar(50) NOT NULL COMMENT &#x27;æ¨¡æ¿ç¼–ç &#x27;,</span><br><span class="line">  `title` varchar(200) NOT NULL COMMENT &#x27;é€šçŸ¥æ ‡é¢˜&#x27;,</span><br><span class="line">  `content` text NOT NULL COMMENT &#x27;é€šçŸ¥å†…å®¹&#x27;,</span><br><span class="line">  `notification_type` varchar(20) NOT NULL COMMENT &#x27;é€šçŸ¥ç±»å‹&#x27;,</span><br><span class="line">  `channels` varchar(200) NOT NULL COMMENT &#x27;å‘é€æ¸ é“&#x27;,</span><br><span class="line">  `channel_results` text COMMENT &#x27;æ¸ é“å‘é€ç»“æœ&#x27;,</span><br><span class="line">  `business_id` varchar(100) DEFAULT NULL COMMENT &#x27;ä¸šåŠ¡IDï¼ˆå¦‚è®¢å•å·ï¼‰&#x27;,</span><br><span class="line">  `business_type` varchar(50) DEFAULT NULL COMMENT &#x27;ä¸šåŠ¡ç±»å‹&#x27;,</span><br><span class="line">  `status` tinyint(1) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;çŠ¶æ€ï¼š0-å¾…å‘é€ï¼Œ1-å‘é€ä¸­ï¼Œ2-å‘é€æˆåŠŸï¼Œ3-å‘é€å¤±è´¥ï¼Œ4-éƒ¨åˆ†å¤±è´¥&#x27;,</span><br><span class="line">  `read_status` tinyint(1) DEFAULT &#x27;0&#x27; COMMENT &#x27;é˜…è¯»çŠ¶æ€ï¼š0-æœªè¯»ï¼Œ1-å·²è¯»&#x27;,</span><br><span class="line">  `send_time` datetime DEFAULT NULL COMMENT &#x27;å‘é€æ—¶é—´&#x27;,</span><br><span class="line">  `read_time` datetime DEFAULT NULL COMMENT &#x27;é˜…è¯»æ—¶é—´&#x27;,</span><br><span class="line">  `expire_time` datetime DEFAULT NULL COMMENT &#x27;è¿‡æœŸæ—¶é—´&#x27;,</span><br><span class="line">  `retry_count` int(11) DEFAULT &#x27;0&#x27; COMMENT &#x27;é‡è¯•æ¬¡æ•°&#x27;,</span><br><span class="line">  `fail_reason` varchar(500) DEFAULT NULL COMMENT &#x27;å¤±è´¥åŸå› &#x27;,</span><br><span class="line">  `is_deleted` tinyint(1) DEFAULT &#x27;0&#x27; COMMENT &#x27;æ˜¯å¦åˆ é™¤ï¼š0-å¦ï¼Œ1-æ˜¯&#x27;,</span><br><span class="line">  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;åˆ›å»ºæ—¶é—´&#x27;,</span><br><span class="line">  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &#x27;æ›´æ–°æ—¶é—´&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_notification_no` (`notification_no`),</span><br><span class="line">  KEY `idx_user_id` (`user_id`),</span><br><span class="line">  KEY `idx_business` (`business_type`, `business_id`),</span><br><span class="line">  KEY `idx_status` (`status`),</span><br><span class="line">  KEY `idx_create_time` (`create_time`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=&#x27;é€šçŸ¥è®°å½•è¡¨&#x27;;</span><br><span class="line"></span><br><span class="line">-- ç”¨æˆ·é€šçŸ¥é…ç½®è¡¨</span><br><span class="line">CREATE TABLE `user_notification_config` (</span><br><span class="line">  `id` bigint(20) NOT NULL COMMENT &#x27;é…ç½®ID&#x27;,</span><br><span class="line">  `user_id` bigint(20) NOT NULL COMMENT &#x27;ç”¨æˆ·ID&#x27;,</span><br><span class="line">  `notification_type` varchar(20) NOT NULL COMMENT &#x27;é€šçŸ¥ç±»å‹&#x27;,</span><br><span class="line">  `channel` varchar(20) NOT NULL COMMENT &#x27;æ¸ é“&#x27;,</span><br><span class="line">  `enabled` tinyint(1) NOT NULL DEFAULT &#x27;1&#x27; COMMENT &#x27;æ˜¯å¦å¯ç”¨ï¼š1-æ˜¯ï¼Œ0-å¦&#x27;,</span><br><span class="line">  `config_value` varchar(500) DEFAULT NULL COMMENT &#x27;é…ç½®å€¼ï¼ˆå¦‚é‚®ç®±ã€æ‰‹æœºå·ï¼‰&#x27;,</span><br><span class="line">  `is_deleted` tinyint(1) DEFAULT &#x27;0&#x27; COMMENT &#x27;æ˜¯å¦åˆ é™¤ï¼š0-å¦ï¼Œ1-æ˜¯&#x27;,</span><br><span class="line">  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;åˆ›å»ºæ—¶é—´&#x27;,</span><br><span class="line">  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &#x27;æ›´æ–°æ—¶é—´&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_user_type_channel` (`user_id`, `notification_type`, `channel`),</span><br><span class="line">  KEY `idx_user_id` (`user_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=&#x27;ç”¨æˆ·é€šçŸ¥é…ç½®è¡¨&#x27;;</span><br><span class="line"></span><br><span class="line">-- WebSocketè¿æ¥è¡¨</span><br><span class="line">CREATE TABLE `websocket_session` (</span><br><span class="line">  `id` bigint(20) NOT NULL COMMENT &#x27;ä¼šè¯ID&#x27;,</span><br><span class="line">  `session_id` varchar(100) NOT NULL COMMENT &#x27;WebSocketä¼šè¯ID&#x27;,</span><br><span class="line">  `user_id` bigint(20) NOT NULL COMMENT &#x27;ç”¨æˆ·ID&#x27;,</span><br><span class="line">  `client_ip` varchar(50) DEFAULT NULL COMMENT &#x27;å®¢æˆ·ç«¯IP&#x27;,</span><br><span class="line">  `user_agent` varchar(500) DEFAULT NULL COMMENT &#x27;ç”¨æˆ·ä»£ç†&#x27;,</span><br><span class="line">  `device_type` varchar(50) DEFAULT NULL COMMENT &#x27;è®¾å¤‡ç±»å‹&#x27;,</span><br><span class="line">  `connect_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;è¿æ¥æ—¶é—´&#x27;,</span><br><span class="line">  `last_heartbeat_time` datetime DEFAULT NULL COMMENT &#x27;æœ€åå¿ƒè·³æ—¶é—´&#x27;,</span><br><span class="line">  `status` tinyint(1) NOT NULL DEFAULT &#x27;1&#x27; COMMENT &#x27;çŠ¶æ€ï¼š1-åœ¨çº¿ï¼Œ0-ç¦»çº¿&#x27;,</span><br><span class="line">  `is_deleted` tinyint(1) DEFAULT &#x27;0&#x27; COMMENT &#x27;æ˜¯å¦åˆ é™¤ï¼š0-å¦ï¼Œ1-æ˜¯&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_session_id` (`session_id`),</span><br><span class="line">  KEY `idx_user_id` (`user_id`),</span><br><span class="line">  KEY `idx_status` (`status`),</span><br><span class="line">  KEY `idx_heartbeat` (`last_heartbeat_time`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=&#x27;WebSocketè¿æ¥è¡¨&#x27;;</span><br><span class="line"></span><br><span class="line">-- çŸ­ä¿¡å‘é€è®°å½•è¡¨</span><br><span class="line">CREATE TABLE `sms_record` (</span><br><span class="line">  `id` bigint(20) NOT NULL COMMENT &#x27;çŸ­ä¿¡è®°å½•ID&#x27;,</span><br><span class="line">  `sms_no` varchar(32) NOT NULL COMMENT &#x27;çŸ­ä¿¡ç¼–å·&#x27;,</span><br><span class="line">  `phone` varchar(20) NOT NULL COMMENT &#x27;æ‰‹æœºå·&#x27;,</span><br><span class="line">  `template_code` varchar(50) NOT NULL COMMENT &#x27;çŸ­ä¿¡æ¨¡æ¿&#x27;,</span><br><span class="line">  `template_params` varchar(500) DEFAULT NULL COMMENT &#x27;æ¨¡æ¿å‚æ•°&#x27;,</span><br><span class="line">  `content` varchar(500) NOT NULL COMMENT &#x27;çŸ­ä¿¡å†…å®¹&#x27;,</span><br><span class="line">  `send_status` tinyint(1) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;å‘é€çŠ¶æ€ï¼š0-å¾…å‘é€ï¼Œ1-å‘é€ä¸­ï¼Œ2-å‘é€æˆåŠŸï¼Œ3-å‘é€å¤±è´¥&#x27;,</span><br><span class="line">  `third_party_id` varchar(100) DEFAULT NULL COMMENT &#x27;ç¬¬ä¸‰æ–¹çŸ­ä¿¡ID&#x27;,</span><br><span class="line">  `third_party_result` text COMMENT &#x27;ç¬¬ä¸‰æ–¹è¿”å›ç»“æœ&#x27;,</span><br><span class="line">  `fail_reason` varchar(500) DEFAULT NULL COMMENT &#x27;å¤±è´¥åŸå› &#x27;,</span><br><span class="line">  `send_time` datetime DEFAULT NULL COMMENT &#x27;å‘é€æ—¶é—´&#x27;,</span><br><span class="line">  `receive_time` datetime DEFAULT NULL COMMENT &#x27;æ¥æ”¶æ—¶é—´&#x27;,</span><br><span class="line">  `retry_count` int(11) DEFAULT &#x27;0&#x27; COMMENT &#x27;é‡è¯•æ¬¡æ•°&#x27;,</span><br><span class="line">  `is_deleted` tinyint(1) DEFAULT &#x27;0&#x27; COMMENT &#x27;æ˜¯å¦åˆ é™¤ï¼š0-å¦ï¼Œ1-æ˜¯&#x27;,</span><br><span class="line">  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;åˆ›å»ºæ—¶é—´&#x27;,</span><br><span class="line">  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &#x27;æ›´æ–°æ—¶é—´&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_sms_no` (`sms_no`),</span><br><span class="line">  KEY `idx_phone` (`phone`),</span><br><span class="line">  KEY `idx_send_status` (`send_status`),</span><br><span class="line">  KEY `idx_send_time` (`send_time`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=&#x27;çŸ­ä¿¡å‘é€è®°å½•è¡¨&#x27;;</span><br><span class="line"></span><br><span class="line">-- é‚®ä»¶å‘é€è®°å½•è¡¨</span><br><span class="line">CREATE TABLE `email_record` (</span><br><span class="line">  `id` bigint(20) NOT NULL COMMENT &#x27;é‚®ä»¶è®°å½•ID&#x27;,</span><br><span class="line">  `email_no` varchar(32) NOT NULL COMMENT &#x27;é‚®ä»¶ç¼–å·&#x27;,</span><br><span class="line">  `email` varchar(100) NOT NULL COMMENT &#x27;é‚®ç®±åœ°å€&#x27;,</span><br><span class="line">  `subject` varchar(200) NOT NULL COMMENT &#x27;é‚®ä»¶ä¸»é¢˜&#x27;,</span><br><span class="line">  `template_name` varchar(100) DEFAULT NULL COMMENT &#x27;æ¨¡æ¿åç§°&#x27;,</span><br><span class="line">  `template_params` text COMMENT &#x27;æ¨¡æ¿å‚æ•°&#x27;,</span><br><span class="line">  `content` text NOT NULL COMMENT &#x27;é‚®ä»¶å†…å®¹&#x27;,</span><br><span class="line">  `content_type` varchar(50) DEFAULT &#x27;text/html&#x27; COMMENT &#x27;å†…å®¹ç±»å‹&#x27;,</span><br><span class="line">  `attachments` text COMMENT &#x27;é™„ä»¶ä¿¡æ¯&#x27;,</span><br><span class="line">  `send_status` tinyint(1) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;å‘é€çŠ¶æ€ï¼š0-å¾…å‘é€ï¼Œ1-å‘é€ä¸­ï¼Œ2-å‘é€æˆåŠŸï¼Œ3-å‘é€å¤±è´¥&#x27;,</span><br><span class="line">  `third_party_result` text COMMENT &#x27;ç¬¬ä¸‰æ–¹è¿”å›ç»“æœ&#x27;,</span><br><span class="line">  `fail_reason` varchar(500) DEFAULT NULL COMMENT &#x27;å¤±è´¥åŸå› &#x27;,</span><br><span class="line">  `send_time` datetime DEFAULT NULL COMMENT &#x27;å‘é€æ—¶é—´&#x27;,</span><br><span class="line">  `retry_count` int(11) DEFAULT &#x27;0&#x27; COMMENT &#x27;é‡è¯•æ¬¡æ•°&#x27;,</span><br><span class="line">  `is_deleted` tinyint(1) DEFAULT &#x27;0&#x27; COMMENT &#x27;æ˜¯å¦åˆ é™¤ï¼š0-å¦ï¼Œ1-æ˜¯&#x27;,</span><br><span class="line">  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;åˆ›å»ºæ—¶é—´&#x27;,</span><br><span class="line">  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &#x27;æ›´æ–°æ—¶é—´&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_email_no` (`email_no`),</span><br><span class="line">  KEY `idx_email` (`email`),</span><br><span class="line">  KEY `idx_send_status` (`send_status`),</span><br><span class="line">  KEY `idx_send_time` (`send_time`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=&#x27;é‚®ä»¶å‘é€è®°å½•è¡¨&#x27;;</span><br></pre></td></tr></table></figure><h3 id="4-WebSocketæœåŠ¡å®ç°ï¼ˆNetty-Spring-WebSocketï¼‰"><a href="#4-WebSocketæœåŠ¡å®ç°ï¼ˆNetty-Spring-WebSocketï¼‰" class="headerlink" title="4. WebSocketæœåŠ¡å®ç°ï¼ˆNetty + Spring WebSocketï¼‰"></a>4. WebSocketæœåŠ¡å®ç°ï¼ˆNetty + Spring WebSocketï¼‰</h3><h4 id="4-1-Netty-WebSocketæœåŠ¡å™¨"><a href="#4-1-Netty-WebSocketæœåŠ¡å™¨" class="headerlink" title="4.1 Netty WebSocketæœåŠ¡å™¨"></a>4.1 Netty WebSocketæœåŠ¡å™¨</h4><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.notification.websocket;</span><br><span class="line"></span><br><span class="line">import io.netty.bootstrap.ServerBootstrap;</span><br><span class="line">import io.netty.channel.Channel;</span><br><span class="line">import io.netty.channel.ChannelInitializer;</span><br><span class="line">import io.netty.channel.ChannelPipeline;</span><br><span class="line">import io.netty.channel.EventLoopGroup;</span><br><span class="line">import io.netty.channel.nio.NioEventLoopGroup;</span><br><span class="line">import io.netty.channel.socket.SocketChannel;</span><br><span class="line">import io.netty.channel.socket.nio.NioServerSocketChannel;</span><br><span class="line">import io.netty.handler.codec.http.HttpObjectAggregator;</span><br><span class="line">import io.netty.handler.codec.http.HttpServerCodec;</span><br><span class="line">import io.netty.handler.codec.http.websocketx.WebSocketServerProtocolHandler;</span><br><span class="line">import io.netty.handler.codec.http.websocketx.extensions.compression.WebSocketServerCompressionHandler;</span><br><span class="line">import io.netty.handler.logging.LogLevel;</span><br><span class="line">import io.netty.handler.logging.LoggingHandler;</span><br><span class="line">import io.netty.handler.stream.ChunkedWriteHandler;</span><br><span class="line">import io.netty.handler.timeout.IdleStateHandler;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.springframework.beans.factory.annotation.Value;</span><br><span class="line">import org.springframework.boot.CommandLineRunner;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line">import javax.annotation.PreDestroy;</span><br><span class="line">import java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Netty WebSocketæœåŠ¡å™¨</span><br><span class="line"> */</span><br><span class="line">@Slf4j</span><br><span class="line">@Component</span><br><span class="line">public class NettyWebSocketServer implements CommandLineRunner &#123;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;websocket.port:8088&#125;&quot;)</span><br><span class="line">    private int port;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;websocket.path:/ws&#125;&quot;)</span><br><span class="line">    private String path;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;websocket.max-frame-size:65536&#125;&quot;)</span><br><span class="line">    private int maxFrameSize;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;websocket.idle-timeout:300000&#125;&quot;)</span><br><span class="line">    private int idleTimeout;</span><br><span class="line">    </span><br><span class="line">    private EventLoopGroup bossGroup;</span><br><span class="line">    private EventLoopGroup workerGroup;</span><br><span class="line">    private Channel channel;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public void run(String... args) throws Exception &#123;</span><br><span class="line">        start();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å¯åŠ¨WebSocketæœåŠ¡å™¨</span><br><span class="line">     */</span><br><span class="line">    public void start() &#123;</span><br><span class="line">        log.info(&quot;å¼€å§‹å¯åŠ¨Netty WebSocketæœåŠ¡å™¨ï¼Œç«¯å£ï¼š&#123;&#125;ï¼Œè·¯å¾„ï¼š&#123;&#125;&quot;, port, path);</span><br><span class="line">        </span><br><span class="line">        bossGroup = new NioEventLoopGroup(1);</span><br><span class="line">        workerGroup = new NioEventLoopGroup();</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            ServerBootstrap bootstrap = new ServerBootstrap();</span><br><span class="line">            bootstrap.group(bossGroup, workerGroup)</span><br><span class="line">                    .channel(NioServerSocketChannel.class)</span><br><span class="line">                    .handler(new LoggingHandler(LogLevel.INFO))</span><br><span class="line">                    .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        @Override</span><br><span class="line">                        protected void initChannel(SocketChannel ch) throws Exception &#123;</span><br><span class="line">                            ChannelPipeline pipeline = ch.pipeline();</span><br><span class="line">                            </span><br><span class="line">                            // HTTPç¼–è§£ç å™¨</span><br><span class="line">                            pipeline.addLast(new HttpServerCodec());</span><br><span class="line">                            </span><br><span class="line">                            // èšåˆHTTPè¯·æ±‚</span><br><span class="line">                            pipeline.addLast(new HttpObjectAggregator(65536));</span><br><span class="line">                            </span><br><span class="line">                            // æ”¯æŒå¤§æ•°æ®æµ</span><br><span class="line">                            pipeline.addLast(new ChunkedWriteHandler());</span><br><span class="line">                            </span><br><span class="line">                            // WebSocketå‹ç¼©</span><br><span class="line">                            pipeline.addLast(new WebSocketServerCompressionHandler());</span><br><span class="line">                            </span><br><span class="line">                            // å¿ƒè·³æ£€æµ‹</span><br><span class="line">                            pipeline.addLast(new IdleStateHandler(</span><br><span class="line">                                    idleTimeout / 1000,</span><br><span class="line">                                    idleTimeout / 1000,</span><br><span class="line">                                    idleTimeout / 1000,</span><br><span class="line">                                    TimeUnit.SECONDS</span><br><span class="line">                            ));</span><br><span class="line">                            </span><br><span class="line">                            // WebSocketåè®®å¤„ç†å™¨</span><br><span class="line">                            pipeline.addLast(new WebSocketServerProtocolHandler(</span><br><span class="line">                                    path,</span><br><span class="line">                                    null,</span><br><span class="line">                                    true,</span><br><span class="line">                                    maxFrameSize</span><br><span class="line">                            ));</span><br><span class="line">                            </span><br><span class="line">                            // è‡ªå®šä¹‰å¤„ç†å™¨</span><br><span class="line">                            pipeline.addLast(new WebSocketFrameHandler());</span><br><span class="line">                            pipeline.addLast(new HeartbeatHandler());</span><br><span class="line">                            pipeline.addLast(new MessageHandler());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            </span><br><span class="line">            channel = bootstrap.bind(port).sync().channel();</span><br><span class="line">            </span><br><span class="line">            log.info(&quot;Netty WebSocketæœåŠ¡å™¨å¯åŠ¨æˆåŠŸï¼Œç›‘å¬ç«¯å£ï¼š&#123;&#125;&quot;, port);</span><br><span class="line">            </span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;å¯åŠ¨Netty WebSocketæœåŠ¡å™¨å¤±è´¥&quot;, e);</span><br><span class="line">            stop();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * åœæ­¢WebSocketæœåŠ¡å™¨</span><br><span class="line">     */</span><br><span class="line">    @PreDestroy</span><br><span class="line">    public void stop() &#123;</span><br><span class="line">        log.info(&quot;åœæ­¢Netty WebSocketæœåŠ¡å™¨&quot;);</span><br><span class="line">        </span><br><span class="line">        if (channel != null) &#123;</span><br><span class="line">            channel.close();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        if (bossGroup != null) &#123;</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        if (workerGroup != null) &#123;</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        log.info(&quot;Netty WebSocketæœåŠ¡å™¨å·²åœæ­¢&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// WebSocketå¸§å¤„ç†å™¨</span><br><span class="line">@Slf4j</span><br><span class="line">class WebSocketFrameHandler extends SimpleChannelInboundHandler&lt;WebSocketFrame&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    private final WebSocketSessionManager sessionManager;</span><br><span class="line">    private final NotificationService notificationService;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    protected void channelRead0(ChannelHandlerContext ctx, WebSocketFrame frame) throws Exception &#123;</span><br><span class="line">        // å¤„ç†æ–‡æœ¬å¸§</span><br><span class="line">        if (frame instanceof TextWebSocketFrame) &#123;</span><br><span class="line">            handleTextFrame(ctx, (TextWebSocketFrame) frame);</span><br><span class="line">        &#125;</span><br><span class="line">        // å¤„ç†äºŒè¿›åˆ¶å¸§</span><br><span class="line">        else if (frame instanceof BinaryWebSocketFrame) &#123;</span><br><span class="line">            handleBinaryFrame(ctx, (BinaryWebSocketFrame) frame);</span><br><span class="line">        &#125;</span><br><span class="line">        // å¤„ç†å…³é—­å¸§</span><br><span class="line">        else if (frame instanceof CloseWebSocketFrame) &#123;</span><br><span class="line">            handleCloseFrame(ctx, (CloseWebSocketFrame) frame);</span><br><span class="line">        &#125;</span><br><span class="line">        // å¤„ç†ping/pongå¸§</span><br><span class="line">        else if (frame instanceof PingWebSocketFrame) &#123;</span><br><span class="line">            handlePingFrame(ctx, (PingWebSocketFrame) frame);</span><br><span class="line">        &#125; else if (frame instanceof PongWebSocketFrame) &#123;</span><br><span class="line">            handlePongFrame(ctx, (PongWebSocketFrame) frame);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å¤„ç†æ–‡æœ¬å¸§</span><br><span class="line">     */</span><br><span class="line">    private void handleTextFrame(ChannelHandlerContext ctx, TextWebSocketFrame frame) &#123;</span><br><span class="line">        String text = frame.text();</span><br><span class="line">        log.debug(&quot;æ”¶åˆ°WebSocketæ–‡æœ¬æ¶ˆæ¯ï¼š&#123;&#125;&quot;, text);</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            WebSocketMessage message = JSON.parseObject(text, WebSocketMessage.class);</span><br><span class="line">            </span><br><span class="line">            switch (message.getType()) &#123;</span><br><span class="line">                case &quot;auth&quot;:</span><br><span class="line">                    handleAuthMessage(ctx, message);</span><br><span class="line">                    break;</span><br><span class="line">                case &quot;subscribe&quot;:</span><br><span class="line">                    handleSubscribeMessage(ctx, message);</span><br><span class="line">                    break;</span><br><span class="line">                case &quot;unsubscribe&quot;:</span><br><span class="line">                    handleUnsubscribeMessage(ctx, message);</span><br><span class="line">                    break;</span><br><span class="line">                case &quot;heartbeat&quot;:</span><br><span class="line">                    handleHeartbeatMessage(ctx, message);</span><br><span class="line">                    break;</span><br><span class="line">                case &quot;message&quot;:</span><br><span class="line">                    handleUserMessage(ctx, message);</span><br><span class="line">                    break;</span><br><span class="line">                default:</span><br><span class="line">                    sendError(ctx, &quot;æœªçŸ¥çš„æ¶ˆæ¯ç±»å‹: &quot; + message.getType());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;å¤„ç†WebSocketæ¶ˆæ¯å¤±è´¥&quot;, e);</span><br><span class="line">            sendError(ctx, &quot;æ¶ˆæ¯æ ¼å¼é”™è¯¯&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å¤„ç†è®¤è¯æ¶ˆæ¯</span><br><span class="line">     */</span><br><span class="line">    private void handleAuthMessage(ChannelHandlerContext ctx, WebSocketMessage message) &#123;</span><br><span class="line">        String token = message.getData().getString(&quot;token&quot;);</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            // éªŒè¯tokenï¼Œè·å–ç”¨æˆ·ä¿¡æ¯</span><br><span class="line">            AuthUser user = authService.verifyToken(token);</span><br><span class="line">            </span><br><span class="line">            if (user == null) &#123;</span><br><span class="line">                sendError(ctx, &quot;è®¤è¯å¤±è´¥&quot;);</span><br><span class="line">                ctx.close();</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // æ³¨å†Œä¼šè¯</span><br><span class="line">            String sessionId = ctx.channel().id().asLongText();</span><br><span class="line">            WebSocketSession session = WebSocketSession.builder()</span><br><span class="line">                    .sessionId(sessionId)</span><br><span class="line">                    .userId(user.getUserId())</span><br><span class="line">                    .username(user.getUsername())</span><br><span class="line">                    .channel(ctx.channel())</span><br><span class="line">                    .connectTime(LocalDateTime.now())</span><br><span class="line">                    .lastHeartbeatTime(LocalDateTime.now())</span><br><span class="line">                    .build();</span><br><span class="line">            </span><br><span class="line">            sessionManager.register(session);</span><br><span class="line">            </span><br><span class="line">            // å‘é€è®¤è¯æˆåŠŸæ¶ˆæ¯</span><br><span class="line">            WebSocketMessage authSuccess = WebSocketMessage.builder()</span><br><span class="line">                    .type(&quot;auth_success&quot;)</span><br><span class="line">                    .data(Map.of(&quot;userId&quot;, user.getUserId()))</span><br><span class="line">                    .timestamp(System.currentTimeMillis())</span><br><span class="line">                    .build();</span><br><span class="line">            </span><br><span class="line">            sendMessage(ctx, authSuccess);</span><br><span class="line">            </span><br><span class="line">            log.info(&quot;WebSocketè®¤è¯æˆåŠŸï¼Œç”¨æˆ·IDï¼š&#123;&#125;ï¼Œä¼šè¯IDï¼š&#123;&#125;&quot;, user.getUserId(), sessionId);</span><br><span class="line">            </span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;WebSocketè®¤è¯å¤±è´¥&quot;, e);</span><br><span class="line">            sendError(ctx, &quot;è®¤è¯å¤±è´¥&quot;);</span><br><span class="line">            ctx.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å¤„ç†è®¢é˜…æ¶ˆæ¯</span><br><span class="line">     */</span><br><span class="line">    private void handleSubscribeMessage(ChannelHandlerContext ctx, WebSocketMessage message) &#123;</span><br><span class="line">        String topic = message.getData().getString(&quot;topic&quot;);</span><br><span class="line">        String sessionId = ctx.channel().id().asLongText();</span><br><span class="line">        </span><br><span class="line">        WebSocketSession session = sessionManager.get(sessionId);</span><br><span class="line">        if (session == null) &#123;</span><br><span class="line">            sendError(ctx, &quot;è¯·å…ˆè®¤è¯&quot;);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        sessionManager.subscribe(session.getUserId(), topic);</span><br><span class="line">        </span><br><span class="line">        WebSocketMessage response = WebSocketMessage.builder()</span><br><span class="line">                .type(&quot;subscribe_success&quot;)</span><br><span class="line">                .data(Map.of(&quot;topic&quot;, topic))</span><br><span class="line">                .timestamp(System.currentTimeMillis())</span><br><span class="line">                .build();</span><br><span class="line">        </span><br><span class="line">        sendMessage(ctx, response);</span><br><span class="line">        </span><br><span class="line">        log.debug(&quot;ç”¨æˆ·è®¢é˜…ä¸»é¢˜ï¼Œç”¨æˆ·IDï¼š&#123;&#125;ï¼Œä¸»é¢˜ï¼š&#123;&#125;&quot;, session.getUserId(), topic);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å‘é€æ¶ˆæ¯</span><br><span class="line">     */</span><br><span class="line">    private void sendMessage(ChannelHandlerContext ctx, WebSocketMessage message) &#123;</span><br><span class="line">        String json = JSON.toJSONString(message);</span><br><span class="line">        ctx.channel().writeAndFlush(new TextWebSocketFrame(json));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public void channelActive(ChannelHandlerContext ctx) throws Exception &#123;</span><br><span class="line">        log.debug(&quot;WebSocketè¿æ¥å»ºç«‹ï¼š&#123;&#125;&quot;, ctx.channel().remoteAddress());</span><br><span class="line">        super.channelActive(ctx);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public void channelInactive(ChannelHandlerContext ctx) throws Exception &#123;</span><br><span class="line">        String sessionId = ctx.channel().id().asLongText();</span><br><span class="line">        WebSocketSession session = sessionManager.get(sessionId);</span><br><span class="line">        </span><br><span class="line">        if (session != null) &#123;</span><br><span class="line">            sessionManager.unregister(sessionId);</span><br><span class="line">            log.info(&quot;WebSocketè¿æ¥æ–­å¼€ï¼Œç”¨æˆ·IDï¼š&#123;&#125;&quot;, session.getUserId());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        super.channelInactive(ctx);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception &#123;</span><br><span class="line">        log.error(&quot;WebSocketå¤„ç†å¼‚å¸¸&quot;, cause);</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// å¿ƒè·³å¤„ç†å™¨</span><br><span class="line">@Slf4j</span><br><span class="line">class HeartbeatHandler extends ChannelInboundHandlerAdapter &#123;</span><br><span class="line">    </span><br><span class="line">    private final WebSocketSessionManager sessionManager;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public void userEventTriggered(ChannelHandlerContext ctx, Object evt) throws Exception &#123;</span><br><span class="line">        if (evt instanceof IdleStateEvent) &#123;</span><br><span class="line">            IdleStateEvent event = (IdleStateEvent) evt;</span><br><span class="line">            </span><br><span class="line">            if (event.state() == IdleState.READER_IDLE) &#123;</span><br><span class="line">                // è¯»ç©ºé—²ï¼Œå‘é€å¿ƒè·³æ£€æµ‹</span><br><span class="line">                sendHeartbeat(ctx);</span><br><span class="line">            &#125; else if (event.state() == IdleState.WRITER_IDLE) &#123;</span><br><span class="line">                // å†™ç©ºé—²ï¼Œæ›´æ–°å¿ƒè·³æ—¶é—´</span><br><span class="line">                updateHeartbeatTime(ctx);</span><br><span class="line">            &#125; else if (event.state() == IdleState.ALL_IDLE) &#123;</span><br><span class="line">                // è¯»å†™éƒ½ç©ºé—²ï¼Œæ–­å¼€è¿æ¥</span><br><span class="line">                log.warn(&quot;WebSocketè¿æ¥ç©ºé—²è¶…æ—¶ï¼Œæ–­å¼€è¿æ¥&quot;);</span><br><span class="line">                ctx.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        super.userEventTriggered(ctx, evt);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å‘é€å¿ƒè·³</span><br><span class="line">     */</span><br><span class="line">    private void sendHeartbeat(ChannelHandlerContext ctx) &#123;</span><br><span class="line">        WebSocketMessage heartbeat = WebSocketMessage.builder()</span><br><span class="line">                .type(&quot;heartbeat&quot;)</span><br><span class="line">                .data(Map.of(&quot;timestamp&quot;, System.currentTimeMillis()))</span><br><span class="line">                .timestamp(System.currentTimeMillis())</span><br><span class="line">                .build();</span><br><span class="line">        </span><br><span class="line">        String json = JSON.toJSONString(heartbeat);</span><br><span class="line">        ctx.writeAndFlush(new TextWebSocketFrame(json));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ›´æ–°å¿ƒè·³æ—¶é—´</span><br><span class="line">     */</span><br><span class="line">    private void updateHeartbeatTime(ChannelHandlerContext ctx) &#123;</span><br><span class="line">        String sessionId = ctx.channel().id().asLongText();</span><br><span class="line">        sessionManager.updateHeartbeatTime(sessionId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æ¶ˆæ¯å¤„ç†å™¨</span><br><span class="line">@Slf4j</span><br><span class="line">class MessageHandler extends SimpleChannelInboundHandler&lt;TextWebSocketFrame&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    private final NotificationService notificationService;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    protected void channelRead0(ChannelHandlerContext ctx, TextWebSocketFrame frame) throws Exception &#123;</span><br><span class="line">        String message = frame.text();</span><br><span class="line">        </span><br><span class="line">        // å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰è¿æ¥</span><br><span class="line">        WebSocketSessionManager.broadcast(message);</span><br><span class="line">        </span><br><span class="line">        // å¤„ç†ä¸šåŠ¡æ¶ˆæ¯</span><br><span class="line">        processBusinessMessage(message);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å¤„ç†ä¸šåŠ¡æ¶ˆæ¯</span><br><span class="line">     */</span><br><span class="line">    private void processBusinessMessage(String message) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            WebSocketMessage wsMessage = JSON.parseObject(message, WebSocketMessage.class);</span><br><span class="line">            </span><br><span class="line">            // æ ¹æ®æ¶ˆæ¯ç±»å‹å¤„ç†</span><br><span class="line">            switch (wsMessage.getType()) &#123;</span><br><span class="line">                case &quot;notification_read&quot;:</span><br><span class="line">                    handleNotificationRead(wsMessage);</span><br><span class="line">                    break;</span><br><span class="line">                case &quot;notification_delete&quot;:</span><br><span class="line">                    handleNotificationDelete(wsMessage);</span><br><span class="line">                    break;</span><br><span class="line">                case &quot;notification_clear&quot;:</span><br><span class="line">                    handleNotificationClear(wsMessage);</span><br><span class="line">                    break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;å¤„ç†ä¸šåŠ¡æ¶ˆæ¯å¤±è´¥&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private void handleNotificationRead(WebSocketMessage message) &#123;</span><br><span class="line">        Long userId = message.getData().getLong(&quot;userId&quot;);</span><br><span class="line">        Long notificationId = message.getData().getLong(&quot;notificationId&quot;);</span><br><span class="line">        </span><br><span class="line">        notificationService.markAsRead(userId, notificationId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// WebSocketä¼šè¯ç®¡ç†å™¨</span><br><span class="line">@Component</span><br><span class="line">@Slf4j</span><br><span class="line">class WebSocketSessionManager &#123;</span><br><span class="line">    </span><br><span class="line">    private final RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    </span><br><span class="line">    // æœ¬åœ°ä¼šè¯å­˜å‚¨</span><br><span class="line">    private final ConcurrentHashMap&lt;String, WebSocketSession&gt; sessions = new ConcurrentHashMap&lt;&gt;();</span><br><span class="line">    private final ConcurrentHashMap&lt;Long, Set&lt;String&gt;&gt; userSessions = new ConcurrentHashMap&lt;&gt;();</span><br><span class="line">    private final ConcurrentHashMap&lt;String, Set&lt;Long&gt;&gt; topicSubscribers = new ConcurrentHashMap&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ³¨å†Œä¼šè¯</span><br><span class="line">     */</span><br><span class="line">    public void register(WebSocketSession session) &#123;</span><br><span class="line">        sessions.put(session.getSessionId(), session);</span><br><span class="line">        </span><br><span class="line">        // æŒ‰ç”¨æˆ·åˆ†ç»„</span><br><span class="line">        userSessions.computeIfAbsent(session.getUserId(), k -&gt; ConcurrentHashMap.newKeySet())</span><br><span class="line">                .add(session.getSessionId());</span><br><span class="line">        </span><br><span class="line">        // ä¿å­˜åˆ°Redisï¼ˆç”¨äºé›†ç¾¤ï¼‰</span><br><span class="line">        saveSessionToRedis(session);</span><br><span class="line">        </span><br><span class="line">        log.debug(&quot;æ³¨å†ŒWebSocketä¼šè¯ï¼Œç”¨æˆ·IDï¼š&#123;&#125;ï¼Œä¼šè¯IDï¼š&#123;&#125;&quot;, </span><br><span class="line">                session.getUserId(), session.getSessionId());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ³¨é”€ä¼šè¯</span><br><span class="line">     */</span><br><span class="line">    public void unregister(String sessionId) &#123;</span><br><span class="line">        WebSocketSession session = sessions.remove(sessionId);</span><br><span class="line">        if (session != null) &#123;</span><br><span class="line">            // ä»ç”¨æˆ·åˆ†ç»„ä¸­ç§»é™¤</span><br><span class="line">            Set&lt;String&gt; userSessionIds = userSessions.get(session.getUserId());</span><br><span class="line">            if (userSessionIds != null) &#123;</span><br><span class="line">                userSessionIds.remove(sessionId);</span><br><span class="line">                if (userSessionIds.isEmpty()) &#123;</span><br><span class="line">                    userSessions.remove(session.getUserId());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // ä»æ‰€æœ‰ä¸»é¢˜ä¸­å–æ¶ˆè®¢é˜…</span><br><span class="line">            unsubscribeAll(session.getUserId());</span><br><span class="line">            </span><br><span class="line">            // ä»Redisåˆ é™¤</span><br><span class="line">            deleteSessionFromRedis(sessionId);</span><br><span class="line">            </span><br><span class="line">            log.debug(&quot;æ³¨é”€WebSocketä¼šè¯ï¼Œç”¨æˆ·IDï¼š&#123;&#125;ï¼Œä¼šè¯IDï¼š&#123;&#125;&quot;, </span><br><span class="line">                    session.getUserId(), sessionId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è®¢é˜…ä¸»é¢˜</span><br><span class="line">     */</span><br><span class="line">    public void subscribe(Long userId, String topic) &#123;</span><br><span class="line">        topicSubscribers.computeIfAbsent(topic, k -&gt; ConcurrentHashMap.newKeySet())</span><br><span class="line">                .add(userId);</span><br><span class="line">        </span><br><span class="line">        // ä¿å­˜åˆ°Redisï¼ˆç”¨äºé›†ç¾¤ï¼‰</span><br><span class="line">        saveSubscriptionToRedis(userId, topic);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å–æ¶ˆè®¢é˜…ä¸»é¢˜</span><br><span class="line">     */</span><br><span class="line">    public void unsubscribe(Long userId, String topic) &#123;</span><br><span class="line">        Set&lt;Long&gt; subscribers = topicSubscribers.get(topic);</span><br><span class="line">        if (subscribers != null) &#123;</span><br><span class="line">            subscribers.remove(userId);</span><br><span class="line">            if (subscribers.isEmpty()) &#123;</span><br><span class="line">                topicSubscribers.remove(topic);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // ä»Redisåˆ é™¤è®¢é˜…</span><br><span class="line">        deleteSubscriptionFromRedis(userId, topic);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å–æ¶ˆæ‰€æœ‰è®¢é˜…</span><br><span class="line">     */</span><br><span class="line">    public void unsubscribeAll(Long userId) &#123;</span><br><span class="line">        for (Set&lt;Long&gt; subscribers : topicSubscribers.values()) &#123;</span><br><span class="line">            subscribers.remove(userId);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // æ¸…ç†ç©ºé›†åˆ</span><br><span class="line">        topicSubscribers.entrySet().removeIf(entry -&gt; entry.getValue().isEmpty());</span><br><span class="line">        </span><br><span class="line">        // ä»Redisåˆ é™¤æ‰€æœ‰è®¢é˜…</span><br><span class="line">        deleteAllSubscriptionsFromRedis(userId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å‘é€æ¶ˆæ¯ç»™ç”¨æˆ·</span><br><span class="line">     */</span><br><span class="line">    public void sendToUser(Long userId, String message) &#123;</span><br><span class="line">        Set&lt;String&gt; sessionIds = userSessions.get(userId);</span><br><span class="line">        if (sessionIds == null || sessionIds.isEmpty()) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        for (String sessionId : sessionIds) &#123;</span><br><span class="line">            WebSocketSession session = sessions.get(sessionId);</span><br><span class="line">            if (session != null &amp;&amp; session.getChannel().isActive()) &#123;</span><br><span class="line">                session.getChannel().writeAndFlush(new TextWebSocketFrame(message));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å‘é€æ¶ˆæ¯ç»™ä¸»é¢˜è®¢é˜…è€…</span><br><span class="line">     */</span><br><span class="line">    public void sendToTopic(String topic, String message) &#123;</span><br><span class="line">        Set&lt;Long&gt; subscribers = topicSubscribers.get(topic);</span><br><span class="line">        if (subscribers == null || subscribers.isEmpty()) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        for (Long userId : subscribers) &#123;</span><br><span class="line">            sendToUser(userId, message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰è¿æ¥</span><br><span class="line">     */</span><br><span class="line">    public void broadcast(String message) &#123;</span><br><span class="line">        for (WebSocketSession session : sessions.values()) &#123;</span><br><span class="line">            if (session.getChannel().isActive()) &#123;</span><br><span class="line">                session.getChannel().writeAndFlush(new TextWebSocketFrame(message));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ›´æ–°å¿ƒè·³æ—¶é—´</span><br><span class="line">     */</span><br><span class="line">    public void updateHeartbeatTime(String sessionId) &#123;</span><br><span class="line">        WebSocketSession session = sessions.get(sessionId);</span><br><span class="line">        if (session != null) &#123;</span><br><span class="line">            session.setLastHeartbeatTime(LocalDateTime.now());</span><br><span class="line">            </span><br><span class="line">            // æ›´æ–°Redisä¸­çš„å¿ƒè·³æ—¶é—´</span><br><span class="line">            updateHeartbeatTimeInRedis(sessionId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ¸…ç†è¿‡æœŸä¼šè¯</span><br><span class="line">     */</span><br><span class="line">    @Scheduled(fixedDelay = 60000) // æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡</span><br><span class="line">    public void cleanupExpiredSessions() &#123;</span><br><span class="line">        log.debug(&quot;å¼€å§‹æ¸…ç†è¿‡æœŸWebSocketä¼šè¯&quot;);</span><br><span class="line">        </span><br><span class="line">        LocalDateTime cutoffTime = LocalDateTime.now().minusMinutes(2);</span><br><span class="line">        int count = 0;</span><br><span class="line">        </span><br><span class="line">        for (WebSocketSession session : sessions.values()) &#123;</span><br><span class="line">            if (session.getLastHeartbeatTime().isBefore(cutoffTime)) &#123;</span><br><span class="line">                log.info(&quot;æ¸…ç†è¿‡æœŸWebSocketä¼šè¯ï¼Œç”¨æˆ·IDï¼š&#123;&#125;ï¼Œæœ€åå¿ƒè·³ï¼š&#123;&#125;&quot;, </span><br><span class="line">                        session.getUserId(), session.getLastHeartbeatTime());</span><br><span class="line">                </span><br><span class="line">                // å…³é—­è¿æ¥</span><br><span class="line">                if (session.getChannel().isActive()) &#123;</span><br><span class="line">                    session.getChannel().close();</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                // ä»ç®¡ç†å™¨ä¸­ç§»é™¤</span><br><span class="line">                unregister(session.getSessionId());</span><br><span class="line">                count++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        log.debug(&quot;æ¸…ç†è¿‡æœŸWebSocketä¼šè¯å®Œæˆï¼Œå…±æ¸…ç†&#123;&#125;ä¸ªä¼šè¯&quot;, count);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // Redisç›¸å…³æ“ä½œæ–¹æ³•...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// WebSocketæ¶ˆæ¯å®ä½“</span><br><span class="line">@Data</span><br><span class="line">@Builder</span><br><span class="line">class WebSocketMessage &#123;</span><br><span class="line">    private String type;        // æ¶ˆæ¯ç±»å‹</span><br><span class="line">    private Map&lt;String, Object&gt; data;  // æ¶ˆæ¯æ•°æ®</span><br><span class="line">    private Long timestamp;     // æ—¶é—´æˆ³</span><br><span class="line">    private String requestId;   // è¯·æ±‚IDï¼ˆç”¨äºåŒ¹é…å“åº”ï¼‰</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// WebSocketä¼šè¯å®ä½“</span><br><span class="line">@Data</span><br><span class="line">@Builder</span><br><span class="line">class WebSocketSession &#123;</span><br><span class="line">    private String sessionId;           // ä¼šè¯ID</span><br><span class="line">    private Long userId;                // ç”¨æˆ·ID</span><br><span class="line">    private String username;            // ç”¨æˆ·å</span><br><span class="line">    private Channel channel;            // Nettyé€šé“</span><br><span class="line">    private LocalDateTime connectTime;  // è¿æ¥æ—¶é—´</span><br><span class="line">    private LocalDateTime lastHeartbeatTime; // æœ€åå¿ƒè·³æ—¶é—´</span><br><span class="line">    private Set&lt;String&gt; subscribedTopics = new HashSet&lt;&gt;(); // è®¢é˜…çš„ä¸»é¢˜</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-2-Spring-WebSocketå®ç°ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰"><a href="#4-2-Spring-WebSocketå®ç°ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰" class="headerlink" title="4.2 Spring WebSocketå®ç°ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰"></a>4.2 Spring WebSocketå®ç°ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰</h4><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.notification.websocket;</span><br><span class="line"></span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.web.socket.CloseStatus;</span><br><span class="line">import org.springframework.web.socket.TextMessage;</span><br><span class="line">import org.springframework.web.socket.WebSocketSession;</span><br><span class="line">import org.springframework.web.socket.config.annotation.EnableWebSocket;</span><br><span class="line">import org.springframework.web.socket.config.annotation.WebSocketConfigurer;</span><br><span class="line">import org.springframework.web.socket.config.annotation.WebSocketHandlerRegistry;</span><br><span class="line">import org.springframework.web.socket.handler.TextWebSocketHandler;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.util.Map;</span><br><span class="line">import java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Spring WebSocketé…ç½®ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰</span><br><span class="line"> */</span><br><span class="line">@Slf4j</span><br><span class="line">@Configuration</span><br><span class="line">@EnableWebSocket</span><br><span class="line">public class SpringWebSocketConfig implements WebSocketConfigurer &#123;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public void registerWebSocketHandlers(WebSocketHandlerRegistry registry) &#123;</span><br><span class="line">        registry.addHandler(new NotificationWebSocketHandler(), &quot;/ws/notification&quot;)</span><br><span class="line">                .setAllowedOrigins(&quot;*&quot;)</span><br><span class="line">                .addInterceptors(new WebSocketHandshakeInterceptor());</span><br><span class="line">        </span><br><span class="line">        registry.addHandler(new NotificationWebSocketHandler(), &quot;/ws/notification/sockjs&quot;)</span><br><span class="line">                .setAllowedOrigins(&quot;*&quot;)</span><br><span class="line">                .withSockJS()</span><br><span class="line">                .setInterceptors(new WebSocketHandshakeInterceptor());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// WebSocketæ¡æ‰‹æ‹¦æˆªå™¨</span><br><span class="line">class WebSocketHandshakeInterceptor implements HandshakeInterceptor &#123;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public boolean beforeHandshake(ServerHttpRequest request, </span><br><span class="line">                                  ServerHttpResponse response, </span><br><span class="line">                                  WebSocketHandler wsHandler, </span><br><span class="line">                                  Map&lt;String, Object&gt; attributes) throws Exception &#123;</span><br><span class="line">        </span><br><span class="line">        // ä»è¯·æ±‚å‚æ•°ä¸­è·å–token</span><br><span class="line">        if (request instanceof ServletServerHttpRequest) &#123;</span><br><span class="line">            ServletServerHttpRequest servletRequest = (ServletServerHttpRequest) request;</span><br><span class="line">            String token = servletRequest.getServletRequest().getParameter(&quot;token&quot;);</span><br><span class="line">            </span><br><span class="line">            if (token != null) &#123;</span><br><span class="line">                // éªŒè¯token</span><br><span class="line">                AuthUser user = authService.verifyToken(token);</span><br><span class="line">                if (user != null) &#123;</span><br><span class="line">                    attributes.put(&quot;userId&quot;, user.getUserId());</span><br><span class="line">                    attributes.put(&quot;username&quot;, user.getUsername());</span><br><span class="line">                    return true;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public void afterHandshake(ServerHttpRequest request, </span><br><span class="line">                              ServerHttpResponse response, </span><br><span class="line">                              WebSocketHandler wsHandler, </span><br><span class="line">                              Exception exception) &#123;</span><br><span class="line">        // æ¡æ‰‹åå¤„ç†</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// WebSocketå¤„ç†å™¨</span><br><span class="line">@Slf4j</span><br><span class="line">class NotificationWebSocketHandler extends TextWebSocketHandler &#123;</span><br><span class="line">    </span><br><span class="line">    private static final Map&lt;String, WebSocketSession&gt; sessions = new ConcurrentHashMap&lt;&gt;();</span><br><span class="line">    private static final Map&lt;Long, Set&lt;WebSocketSession&gt;&gt; userSessions = new ConcurrentHashMap&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public void afterConnectionEstablished(WebSocketSession session) throws Exception &#123;</span><br><span class="line">        Long userId = (Long) session.getAttributes().get(&quot;userId&quot;);</span><br><span class="line">        String username = (String) session.getAttributes().get(&quot;username&quot;);</span><br><span class="line">        </span><br><span class="line">        if (userId == null) &#123;</span><br><span class="line">            session.close(CloseStatus.NOT_ACCEPTABLE.withReason(&quot;è®¤è¯å¤±è´¥&quot;));</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // ä¿å­˜ä¼šè¯</span><br><span class="line">        sessions.put(session.getId(), session);</span><br><span class="line">        userSessions.computeIfAbsent(userId, k -&gt; ConcurrentHashMap.newKeySet())</span><br><span class="line">                .add(session);</span><br><span class="line">        </span><br><span class="line">        log.info(&quot;WebSocketè¿æ¥å»ºç«‹ï¼Œç”¨æˆ·IDï¼š&#123;&#125;ï¼Œä¼šè¯IDï¼š&#123;&#125;&quot;, userId, session.getId());</span><br><span class="line">        </span><br><span class="line">        // å‘é€è¿æ¥æˆåŠŸæ¶ˆæ¯</span><br><span class="line">        Map&lt;String, Object&gt; data = Map.of(</span><br><span class="line">                &quot;type&quot;, &quot;connect_success&quot;,</span><br><span class="line">                &quot;userId&quot;, userId,</span><br><span class="line">                &quot;timestamp&quot;, System.currentTimeMillis()</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        session.sendMessage(new TextMessage(JSON.toJSONString(data)));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    protected void handleTextMessage(WebSocketSession session, TextMessage message) throws Exception &#123;</span><br><span class="line">        String payload = message.getPayload();</span><br><span class="line">        log.debug(&quot;æ”¶åˆ°WebSocketæ¶ˆæ¯ï¼š&#123;&#125;&quot;, payload);</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            Map&lt;String, Object&gt; messageMap = JSON.parseObject(payload, Map.class);</span><br><span class="line">            String type = (String) messageMap.get(&quot;type&quot;);</span><br><span class="line">            </span><br><span class="line">            switch (type) &#123;</span><br><span class="line">                case &quot;heartbeat&quot;:</span><br><span class="line">                    handleHeartbeat(session, messageMap);</span><br><span class="line">                    break;</span><br><span class="line">                case &quot;subscribe&quot;:</span><br><span class="line">                    handleSubscribe(session, messageMap);</span><br><span class="line">                    break;</span><br><span class="line">                case &quot;message&quot;:</span><br><span class="line">                    handleMessage(session, messageMap);</span><br><span class="line">                    break;</span><br><span class="line">                default:</span><br><span class="line">                    log.warn(&quot;æœªçŸ¥çš„æ¶ˆæ¯ç±»å‹ï¼š&#123;&#125;&quot;, type);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;å¤„ç†WebSocketæ¶ˆæ¯å¤±è´¥&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public void afterConnectionClosed(WebSocketSession session, CloseStatus status) throws Exception &#123;</span><br><span class="line">        Long userId = (Long) session.getAttributes().get(&quot;userId&quot;);</span><br><span class="line">        </span><br><span class="line">        // ç§»é™¤ä¼šè¯</span><br><span class="line">        sessions.remove(session.getId());</span><br><span class="line">        if (userId != null) &#123;</span><br><span class="line">            Set&lt;WebSocketSession&gt; userSessionSet = userSessions.get(userId);</span><br><span class="line">            if (userSessionSet != null) &#123;</span><br><span class="line">                userSessionSet.remove(session);</span><br><span class="line">                if (userSessionSet.isEmpty()) &#123;</span><br><span class="line">                    userSessions.remove(userId);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        log.info(&quot;WebSocketè¿æ¥å…³é—­ï¼Œç”¨æˆ·IDï¼š&#123;&#125;ï¼Œå…³é—­åŸå› ï¼š&#123;&#125;&quot;, userId, status);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public void handleTransportError(WebSocketSession session, Throwable exception) throws Exception &#123;</span><br><span class="line">        log.error(&quot;WebSocketä¼ è¾“é”™è¯¯&quot;, exception);</span><br><span class="line">        session.close(CloseStatus.SERVER_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å¤„ç†å¿ƒè·³</span><br><span class="line">     */</span><br><span class="line">    private void handleHeartbeat(WebSocketSession session, Map&lt;String, Object&gt; message) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Map&lt;String, Object&gt; response = Map.of(</span><br><span class="line">                    &quot;type&quot;, &quot;heartbeat_response&quot;,</span><br><span class="line">                    &quot;timestamp&quot;, System.currentTimeMillis()</span><br><span class="line">            );</span><br><span class="line">            session.sendMessage(new TextMessage(JSON.toJSONString(response)));</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            log.error(&quot;å‘é€å¿ƒè·³å“åº”å¤±è´¥&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å‘é€æ¶ˆæ¯ç»™ç”¨æˆ·</span><br><span class="line">     */</span><br><span class="line">    public static void sendToUser(Long userId, String message) &#123;</span><br><span class="line">        Set&lt;WebSocketSession&gt; sessionSet = userSessions.get(userId);</span><br><span class="line">        if (sessionSet == null || sessionSet.isEmpty()) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        for (WebSocketSession session : sessionSet) &#123;</span><br><span class="line">            if (session.isOpen()) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    session.sendMessage(new TextMessage(message));</span><br><span class="line">                &#125; catch (IOException e) &#123;</span><br><span class="line">                    log.error(&quot;å‘é€WebSocketæ¶ˆæ¯å¤±è´¥&quot;, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å¹¿æ’­æ¶ˆæ¯</span><br><span class="line">     */</span><br><span class="line">    public static void broadcast(String message) &#123;</span><br><span class="line">        for (WebSocketSession session : sessions.values()) &#123;</span><br><span class="line">            if (session.isOpen()) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    session.sendMessage(new TextMessage(message));</span><br><span class="line">                &#125; catch (IOException e) &#123;</span><br><span class="line">                    log.error(&quot;å¹¿æ’­WebSocketæ¶ˆæ¯å¤±è´¥&quot;, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-çŸ­ä¿¡æœåŠ¡å®ç°"><a href="#5-çŸ­ä¿¡æœåŠ¡å®ç°" class="headerlink" title="5. çŸ­ä¿¡æœåŠ¡å®ç°"></a>5. çŸ­ä¿¡æœåŠ¡å®ç°</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.notification.sms;</span><br><span class="line"></span><br><span class="line">import com.aliyuncs.DefaultAcsClient;</span><br><span class="line">import com.aliyuncs.IAcsClient;</span><br><span class="line">import com.aliyuncs.dysmsapi.model.v20170525.SendSmsRequest;</span><br><span class="line">import com.aliyuncs.dysmsapi.model.v20170525.SendSmsResponse;</span><br><span class="line">import com.aliyuncs.exceptions.ClientException;</span><br><span class="line">import com.aliyuncs.profile.DefaultProfile;</span><br><span class="line">import com.aliyuncs.profile.IClientProfile;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.springframework.beans.factory.annotation.Value;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * çŸ­ä¿¡æœåŠ¡</span><br><span class="line"> */</span><br><span class="line">@Slf4j</span><br><span class="line">@Service</span><br><span class="line">public class SmsService &#123;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;sms.aliyun.access-key-id&#125;&quot;)</span><br><span class="line">    private String accessKeyId;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;sms.aliyun.access-key-secret&#125;&quot;)</span><br><span class="line">    private String accessKeySecret;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;sms.aliyun.sign-name&#125;&quot;)</span><br><span class="line">    private String signName;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;sms.aliyun.region-id&#125;&quot;)</span><br><span class="line">    private String regionId;</span><br><span class="line">    </span><br><span class="line">    private IAcsClient acsClient;</span><br><span class="line">    </span><br><span class="line">    @PostConstruct</span><br><span class="line">    public void init() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            IClientProfile profile = DefaultProfile.getProfile(regionId, accessKeyId, accessKeySecret);</span><br><span class="line">            acsClient = new DefaultAcsClient(profile);</span><br><span class="line">            log.info(&quot;åˆå§‹åŒ–é˜¿é‡Œäº‘çŸ­ä¿¡å®¢æˆ·ç«¯æˆåŠŸ&quot;);</span><br><span class="line">        &#125; catch (ClientException e) &#123;</span><br><span class="line">            log.error(&quot;åˆå§‹åŒ–é˜¿é‡Œäº‘çŸ­ä¿¡å®¢æˆ·ç«¯å¤±è´¥&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å‘é€çŸ­ä¿¡</span><br><span class="line">     */</span><br><span class="line">    public SmsSendResult sendSms(String phone, String templateCode, Map&lt;String, String&gt; params) &#123;</span><br><span class="line">        log.info(&quot;å‘é€çŸ­ä¿¡ï¼Œæ‰‹æœºå·ï¼š&#123;&#125;ï¼Œæ¨¡æ¿ï¼š&#123;&#125;&quot;, phone, templateCode);</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            SendSmsRequest request = new SendSmsRequest();</span><br><span class="line">            request.setPhoneNumbers(phone);</span><br><span class="line">            request.setSignName(signName);</span><br><span class="line">            request.setTemplateCode(templateCode);</span><br><span class="line">            </span><br><span class="line">            if (params != null &amp;&amp; !params.isEmpty()) &#123;</span><br><span class="line">                request.setTemplateParam(JSON.toJSONString(params));</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // å‘é€çŸ­ä¿¡</span><br><span class="line">            SendSmsResponse response = acsClient.getAcsResponse(request);</span><br><span class="line">            </span><br><span class="line">            SmsSendResult result = SmsSendResult.builder()</span><br><span class="line">                    .success(&quot;OK&quot;.equals(response.getCode()))</span><br><span class="line">                    .message(response.getMessage())</span><br><span class="line">                    .requestId(response.getRequestId())</span><br><span class="line">                    .bizId(response.getBizId())</span><br><span class="line">                    .code(response.getCode())</span><br><span class="line">                    .build();</span><br><span class="line">            </span><br><span class="line">            if (result.isSuccess()) &#123;</span><br><span class="line">                log.info(&quot;çŸ­ä¿¡å‘é€æˆåŠŸï¼Œæ‰‹æœºå·ï¼š&#123;&#125;ï¼Œè¯·æ±‚IDï¼š&#123;&#125;&quot;, phone, result.getRequestId());</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                log.warn(&quot;çŸ­ä¿¡å‘é€å¤±è´¥ï¼Œæ‰‹æœºå·ï¼š&#123;&#125;ï¼Œé”™è¯¯ç ï¼š&#123;&#125;ï¼Œé”™è¯¯ä¿¡æ¯ï¼š&#123;&#125;&quot;, </span><br><span class="line">                        phone, result.getCode(), result.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            return result;</span><br><span class="line">            </span><br><span class="line">        &#125; catch (ClientException e) &#123;</span><br><span class="line">            log.error(&quot;å‘é€çŸ­ä¿¡å¼‚å¸¸ï¼Œæ‰‹æœºå·ï¼š&#123;&#125;&quot;, phone, e);</span><br><span class="line">            return SmsSendResult.builder()</span><br><span class="line">                    .success(false)</span><br><span class="line">                    .message(e.getMessage())</span><br><span class="line">                    .code(e.getErrCode())</span><br><span class="line">                    .build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å‘é€éªŒè¯ç </span><br><span class="line">     */</span><br><span class="line">    public SmsSendResult sendVerificationCode(String phone, String code) &#123;</span><br><span class="line">        log.info(&quot;å‘é€éªŒè¯ç ï¼Œæ‰‹æœºå·ï¼š&#123;&#125;ï¼ŒéªŒè¯ç ï¼š&#123;&#125;&quot;, phone, code);</span><br><span class="line">        </span><br><span class="line">        // æ£€æŸ¥å‘é€é¢‘ç‡</span><br><span class="line">        if (!checkSendFrequency(phone)) &#123;</span><br><span class="line">            return SmsSendResult.builder()</span><br><span class="line">                    .success(false)</span><br><span class="line">                    .message(&quot;å‘é€é¢‘ç‡è¿‡é«˜ï¼Œè¯·ç¨åå†è¯•&quot;)</span><br><span class="line">                    .build();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // æ£€æŸ¥æ¯æ—¥å‘é€é™åˆ¶</span><br><span class="line">        if (!checkDailyLimit(phone)) &#123;</span><br><span class="line">            return SmsSendResult.builder()</span><br><span class="line">                    .success(false)</span><br><span class="line">                    .message(&quot;å·²è¾¾åˆ°ä»Šæ—¥å‘é€ä¸Šé™&quot;)</span><br><span class="line">                    .build();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        Map&lt;String, String&gt; params = Map.of(&quot;code&quot;, code);</span><br><span class="line">        SmsSendResult result = sendSms(phone, </span><br><span class="line">                smsProperties.getTemplateCodes().get(&quot;verification&quot;), </span><br><span class="line">                params);</span><br><span class="line">        </span><br><span class="line">        if (result.isSuccess()) &#123;</span><br><span class="line">            // ä¿å­˜éªŒè¯ç è®°å½•</span><br><span class="line">            saveVerificationCode(phone, code);</span><br><span class="line">            </span><br><span class="line">            // æ›´æ–°å‘é€ç»Ÿè®¡</span><br><span class="line">            updateSendStatistics(phone);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å‘é€è®¢å•æ”¯ä»˜æˆåŠŸçŸ­ä¿¡</span><br><span class="line">     */</span><br><span class="line">    public SmsSendResult sendOrderPaidSms(String phone, String orderNo, BigDecimal amount) &#123;</span><br><span class="line">        Map&lt;String, String&gt; params = Map.of(</span><br><span class="line">                &quot;orderNo&quot;, orderNo,</span><br><span class="line">                &quot;amount&quot;, amount.toString()</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        return sendSms(phone, </span><br><span class="line">                smsProperties.getTemplateCodes().get(&quot;order_paid&quot;), </span><br><span class="line">                params);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ£€æŸ¥å‘é€é¢‘ç‡</span><br><span class="line">     */</span><br><span class="line">    private boolean checkSendFrequency(String phone) &#123;</span><br><span class="line">        String key = &quot;sms:frequency:&quot; + phone;</span><br><span class="line">        Long count = redisTemplate.opsForValue().increment(key, 1);</span><br><span class="line">        </span><br><span class="line">        if (count == 1) &#123;</span><br><span class="line">            // ç¬¬ä¸€æ¬¡å‘é€ï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´</span><br><span class="line">            redisTemplate.expire(key, 60, TimeUnit.SECONDS);</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 60ç§’å†…æœ€å¤šå‘é€3æ¬¡</span><br><span class="line">        return count &lt;= 3;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ£€æŸ¥æ¯æ—¥å‘é€é™åˆ¶</span><br><span class="line">     */</span><br><span class="line">    private boolean checkDailyLimit(String phone) &#123;</span><br><span class="line">        String key = &quot;sms:daily:&quot; + phone + &quot;:&quot; + LocalDate.now().format(DateTimeFormatter.BASIC_ISO_DATE);</span><br><span class="line">        Long count = redisTemplate.opsForValue().increment(key, 1);</span><br><span class="line">        </span><br><span class="line">        if (count == 1) &#123;</span><br><span class="line">            redisTemplate.expire(key, 1, TimeUnit.DAYS);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        Integer dailyLimit = notificationProperties.getChannels().getSms().getDailyLimit();</span><br><span class="line">        return count &lt;= dailyLimit;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * ä¿å­˜éªŒè¯ç è®°å½•</span><br><span class="line">     */</span><br><span class="line">    private void saveVerificationCode(String phone, String code) &#123;</span><br><span class="line">        String key = &quot;sms:verification:&quot; + phone;</span><br><span class="line">        String value = code + &quot;:&quot; + System.currentTimeMillis();</span><br><span class="line">        </span><br><span class="line">        redisTemplate.opsForValue().set(key, value, 10, TimeUnit.MINUTES);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * éªŒè¯éªŒè¯ç </span><br><span class="line">     */</span><br><span class="line">    public boolean verifyCode(String phone, String code) &#123;</span><br><span class="line">        String key = &quot;sms:verification:&quot; + phone;</span><br><span class="line">        String value = (String) redisTemplate.opsForValue().get(key);</span><br><span class="line">        </span><br><span class="line">        if (value == null) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        String[] parts = value.split(&quot;:&quot;);</span><br><span class="line">        String storedCode = parts[0];</span><br><span class="line">        long timestamp = Long.parseLong(parts[1]);</span><br><span class="line">        </span><br><span class="line">        // éªŒè¯ç 10åˆ†é’Ÿæœ‰æ•ˆ</span><br><span class="line">        if (System.currentTimeMillis() - timestamp &gt; 10 * 60 * 1000) &#123;</span><br><span class="line">            redisTemplate.delete(key);</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        boolean verified = storedCode.equals(code);</span><br><span class="line">        </span><br><span class="line">        if (verified) &#123;</span><br><span class="line">            redisTemplate.delete(key);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return verified;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// çŸ­ä¿¡å‘é€ç»“æœ</span><br><span class="line">@Data</span><br><span class="line">@Builder</span><br><span class="line">class SmsSendResult &#123;</span><br><span class="line">    private boolean success;</span><br><span class="line">    private String message;</span><br><span class="line">    private String requestId;</span><br><span class="line">    private String bizId;</span><br><span class="line">    private String code;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-é‚®ä»¶æœåŠ¡å®ç°"><a href="#6-é‚®ä»¶æœåŠ¡å®ç°" class="headerlink" title="6. é‚®ä»¶æœåŠ¡å®ç°"></a>6. é‚®ä»¶æœåŠ¡å®ç°</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.notification.email;</span><br><span class="line"></span><br><span class="line">import freemarker.template.Configuration;</span><br><span class="line">import freemarker.template.Template;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.springframework.core.io.ByteArrayResource;</span><br><span class="line">import org.springframework.core.io.ClassPathResource;</span><br><span class="line">import org.springframework.mail.javamail.JavaMailSender;</span><br><span class="line">import org.springframework.mail.javamail.MimeMessageHelper;</span><br><span class="line">import org.springframework.scheduling.annotation.Async;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line">import org.springframework.ui.freemarker.FreeMarkerTemplateUtils;</span><br><span class="line"></span><br><span class="line">import javax.mail.internet.MimeMessage;</span><br><span class="line">import java.io.File;</span><br><span class="line">import java.nio.charset.StandardCharsets;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * é‚®ä»¶æœåŠ¡</span><br><span class="line"> */</span><br><span class="line">@Slf4j</span><br><span class="line">@Service</span><br><span class="line">public class EmailService &#123;</span><br><span class="line">    </span><br><span class="line">    private final JavaMailSender mailSender;</span><br><span class="line">    private final Configuration freemarkerConfig;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å‘é€ç®€å•é‚®ä»¶</span><br><span class="line">     */</span><br><span class="line">    @Async</span><br><span class="line">    public void sendSimpleEmail(String to, String subject, String content) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            MimeMessage message = mailSender.createMimeMessage();</span><br><span class="line">            MimeMessageHelper helper = new MimeMessageHelper(message, true);</span><br><span class="line">            </span><br><span class="line">            helper.setTo(to);</span><br><span class="line">            helper.setSubject(subject);</span><br><span class="line">            helper.setText(content, true); // trueè¡¨ç¤ºæ”¯æŒHTML</span><br><span class="line">            </span><br><span class="line">            mailSender.send(message);</span><br><span class="line">            </span><br><span class="line">            log.info(&quot;å‘é€ç®€å•é‚®ä»¶æˆåŠŸï¼Œæ”¶ä»¶äººï¼š&#123;&#125;ï¼Œä¸»é¢˜ï¼š&#123;&#125;&quot;, to, subject);</span><br><span class="line">            </span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;å‘é€ç®€å•é‚®ä»¶å¤±è´¥ï¼Œæ”¶ä»¶äººï¼š&#123;&#125;&quot;, to, e);</span><br><span class="line">            throw new RuntimeException(&quot;å‘é€é‚®ä»¶å¤±è´¥&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å‘é€æ¨¡æ¿é‚®ä»¶</span><br><span class="line">     */</span><br><span class="line">    @Async</span><br><span class="line">    public void sendTemplateEmail(String to, String subject, </span><br><span class="line">                                 String templateName, Map&lt;String, Object&gt; model) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            // åŠ è½½æ¨¡æ¿</span><br><span class="line">            Template template = freemarkerConfig.getTemplate(templateName + &quot;.ftl&quot;);</span><br><span class="line">            </span><br><span class="line">            // æ¸²æŸ“æ¨¡æ¿</span><br><span class="line">            String content = FreeMarkerTemplateUtils.processTemplateIntoString(template, model);</span><br><span class="line">            </span><br><span class="line">            // å‘é€é‚®ä»¶</span><br><span class="line">            sendSimpleEmail(to, subject, content);</span><br><span class="line">            </span><br><span class="line">            log.info(&quot;å‘é€æ¨¡æ¿é‚®ä»¶æˆåŠŸï¼Œæ”¶ä»¶äººï¼š&#123;&#125;ï¼Œæ¨¡æ¿ï¼š&#123;&#125;&quot;, to, templateName);</span><br><span class="line">            </span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;å‘é€æ¨¡æ¿é‚®ä»¶å¤±è´¥ï¼Œæ”¶ä»¶äººï¼š&#123;&#125;ï¼Œæ¨¡æ¿ï¼š&#123;&#125;&quot;, to, templateName, e);</span><br><span class="line">            throw new RuntimeException(&quot;å‘é€æ¨¡æ¿é‚®ä»¶å¤±è´¥&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å‘é€å¸¦é™„ä»¶çš„é‚®ä»¶</span><br><span class="line">     */</span><br><span class="line">    @Async</span><br><span class="line">    public void sendEmailWithAttachment(String to, String subject, String content, </span><br><span class="line">                                       String attachmentName, byte[] attachment) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            MimeMessage message = mailSender.createMimeMessage();</span><br><span class="line">            MimeMessageHelper helper = new MimeMessageHelper(message, true, </span><br><span class="line">                    StandardCharsets.UTF_8.name());</span><br><span class="line">            </span><br><span class="line">            helper.setTo(to);</span><br><span class="line">            helper.setSubject(subject);</span><br><span class="line">            helper.setText(content, true);</span><br><span class="line">            </span><br><span class="line">            // æ·»åŠ é™„ä»¶</span><br><span class="line">            ByteArrayResource resource = new ByteArrayResource(attachment);</span><br><span class="line">            helper.addAttachment(attachmentName, resource);</span><br><span class="line">            </span><br><span class="line">            mailSender.send(message);</span><br><span class="line">            </span><br><span class="line">            log.info(&quot;å‘é€å¸¦é™„ä»¶é‚®ä»¶æˆåŠŸï¼Œæ”¶ä»¶äººï¼š&#123;&#125;ï¼Œé™„ä»¶ï¼š&#123;&#125;&quot;, to, attachmentName);</span><br><span class="line">            </span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;å‘é€å¸¦é™„ä»¶é‚®ä»¶å¤±è´¥ï¼Œæ”¶ä»¶äººï¼š&#123;&#125;&quot;, to, e);</span><br><span class="line">            throw new RuntimeException(&quot;å‘é€å¸¦é™„ä»¶é‚®ä»¶å¤±è´¥&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å‘é€è®¢å•æ”¯ä»˜æˆåŠŸé‚®ä»¶</span><br><span class="line">     */</span><br><span class="line">    public void sendOrderPaidEmail(String email, String orderNo, BigDecimal amount) &#123;</span><br><span class="line">        Map&lt;String, Object&gt; model = Map.of(</span><br><span class="line">                &quot;orderNo&quot;, orderNo,</span><br><span class="line">                &quot;amount&quot;, amount,</span><br><span class="line">                &quot;date&quot;, LocalDateTime.now().format(DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm:ss&quot;))</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        sendTemplateEmail(email, &quot;è®¢å•æ”¯ä»˜æˆåŠŸé€šçŸ¥ - &quot; + orderNo, </span><br><span class="line">                &quot;order_paid&quot;, model);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å‘é€éªŒè¯ç é‚®ä»¶</span><br><span class="line">     */</span><br><span class="line">    public void sendVerificationCodeEmail(String email, String code) &#123;</span><br><span class="line">        Map&lt;String, Object&gt; model = Map.of(</span><br><span class="line">                &quot;code&quot;, code,</span><br><span class="line">                &quot;expireMinutes&quot;, 10</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        sendTemplateEmail(email, &quot;éªŒè¯ç é€šçŸ¥&quot;, &quot;verification_code&quot;, model);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ‰¹é‡å‘é€é‚®ä»¶</span><br><span class="line">     */</span><br><span class="line">    @Async</span><br><span class="line">    public void batchSendEmail(List&lt;String&gt; toList, String subject, </span><br><span class="line">                              String templateName, Map&lt;String, Object&gt; model) &#123;</span><br><span class="line">        log.info(&quot;å¼€å§‹æ‰¹é‡å‘é€é‚®ä»¶ï¼Œæ”¶ä»¶äººæ•°é‡ï¼š&#123;&#125;&quot;, toList.size());</span><br><span class="line">        </span><br><span class="line">        int successCount = 0;</span><br><span class="line">        int failCount = 0;</span><br><span class="line">        </span><br><span class="line">        for (String to : toList) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                sendTemplateEmail(to, subject, templateName, model);</span><br><span class="line">                successCount++;</span><br><span class="line">                </span><br><span class="line">                // æ§åˆ¶å‘é€é¢‘ç‡ï¼Œé¿å…è¢«å½“ä½œåƒåœ¾é‚®ä»¶</span><br><span class="line">                Thread.sleep(100);</span><br><span class="line">                </span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                log.error(&quot;æ‰¹é‡å‘é€é‚®ä»¶å¤±è´¥ï¼Œæ”¶ä»¶äººï¼š&#123;&#125;&quot;, to, e);</span><br><span class="line">                failCount++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        log.info(&quot;æ‰¹é‡å‘é€é‚®ä»¶å®Œæˆï¼ŒæˆåŠŸï¼š&#123;&#125;ï¼Œå¤±è´¥ï¼š&#123;&#125;&quot;, successCount, failCount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="7-é€šçŸ¥åˆ†å‘æœåŠ¡"><a href="#7-é€šçŸ¥åˆ†å‘æœåŠ¡" class="headerlink" title="7. é€šçŸ¥åˆ†å‘æœåŠ¡"></a>7. é€šçŸ¥åˆ†å‘æœåŠ¡</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.notification.core;</span><br><span class="line"></span><br><span class="line">import com.shophub.notification.channel.*;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line">import java.util.Arrays;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * é€šçŸ¥åˆ†å‘æœåŠ¡</span><br><span class="line"> */</span><br><span class="line">@Slf4j</span><br><span class="line">@Service</span><br><span class="line">public class NotificationDispatcher &#123;</span><br><span class="line">    </span><br><span class="line">    private final WebSocketNotificationChannel webSocketChannel;</span><br><span class="line">    private final SmsNotificationChannel smsChannel;</span><br><span class="line">    private final EmailNotificationChannel emailChannel;</span><br><span class="line">    private final AppPushNotificationChannel appPushChannel;</span><br><span class="line">    </span><br><span class="line">    private final NotificationTemplateService templateService;</span><br><span class="line">    private final UserNotificationConfigService configService;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å‘é€é€šçŸ¥</span><br><span class="line">     */</span><br><span class="line">    public NotificationSendResult sendNotification(NotificationRequest request) &#123;</span><br><span class="line">        log.info(&quot;å‘é€é€šçŸ¥ï¼Œè¯·æ±‚ï¼š&#123;&#125;&quot;, request);</span><br><span class="line">        </span><br><span class="line">        NotificationSendResult result = new NotificationSendResult();</span><br><span class="line">        result.setNotificationNo(request.getNotificationNo());</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            // 1. è·å–é€šçŸ¥æ¨¡æ¿</span><br><span class="line">            NotificationTemplate template = templateService.getByCode(request.getTemplateCode());</span><br><span class="line">            if (template == null) &#123;</span><br><span class="line">                throw new IllegalArgumentException(&quot;é€šçŸ¥æ¨¡æ¿ä¸å­˜åœ¨ï¼š&quot; + request.getTemplateCode());</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // 2. è·å–ç”¨æˆ·é€šçŸ¥é…ç½®</span><br><span class="line">            List&lt;UserNotificationConfig&gt; userConfigs = configService.getUserConfigs(</span><br><span class="line">                    request.getUserId(), request.getNotificationType());</span><br><span class="line">            </span><br><span class="line">            // 3. æ¸²æŸ“æ¨¡æ¿</span><br><span class="line">            String title = renderTemplate(template.getTitle(), request.getVariables());</span><br><span class="line">            String content = renderTemplate(template.getContent(), request.getVariables());</span><br><span class="line">            </span><br><span class="line">            // 4. å‘é€åˆ°å„ä¸ªæ¸ é“</span><br><span class="line">            List&lt;NotificationChannel&gt; channels = getEnabledChannels(template, userConfigs);</span><br><span class="line">            </span><br><span class="line">            for (NotificationChannel channel : channels) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    ChannelSendResult channelResult = channel.send(</span><br><span class="line">                            request.getUserId(), title, content, request.getVariables());</span><br><span class="line">                    </span><br><span class="line">                    result.addChannelResult(channelResult);</span><br><span class="line">                    </span><br><span class="line">                    if (channelResult.isSuccess()) &#123;</span><br><span class="line">                        log.info(&quot;æ¸ é“é€šçŸ¥å‘é€æˆåŠŸï¼Œæ¸ é“ï¼š&#123;&#125;ï¼Œç”¨æˆ·ï¼š&#123;&#125;&quot;, </span><br><span class="line">                                channel.getChannelType(), request.getUserId());</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        log.warn(&quot;æ¸ é“é€šçŸ¥å‘é€å¤±è´¥ï¼Œæ¸ é“ï¼š&#123;&#125;ï¼Œç”¨æˆ·ï¼š&#123;&#125;ï¼ŒåŸå› ï¼š&#123;&#125;&quot;,</span><br><span class="line">                                channel.getChannelType(), request.getUserId(), </span><br><span class="line">                                channelResult.getErrorMsg());</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    log.error(&quot;æ¸ é“é€šçŸ¥å‘é€å¼‚å¸¸ï¼Œæ¸ é“ï¼š&#123;&#125;ï¼Œç”¨æˆ·ï¼š&#123;&#125;&quot;, </span><br><span class="line">                            channel.getChannelType(), request.getUserId(), e);</span><br><span class="line">                    </span><br><span class="line">                    result.addChannelResult(ChannelSendResult.failure(</span><br><span class="line">                            channel.getChannelType(), e.getMessage()));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // 5. ä¿å­˜é€šçŸ¥è®°å½•</span><br><span class="line">            saveNotificationRecord(request, template, title, content, result);</span><br><span class="line">            </span><br><span class="line">            result.setSuccess(true);</span><br><span class="line">            log.info(&quot;é€šçŸ¥å‘é€å®Œæˆï¼Œé€šçŸ¥ç¼–å·ï¼š&#123;&#125;&quot;, request.getNotificationNo());</span><br><span class="line">            </span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;å‘é€é€šçŸ¥å¤±è´¥ï¼Œé€šçŸ¥ç¼–å·ï¼š&#123;&#125;&quot;, request.getNotificationNo(), e);</span><br><span class="line">            result.setSuccess(false);</span><br><span class="line">            result.setErrorMsg(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ‰¹é‡å‘é€é€šçŸ¥</span><br><span class="line">     */</span><br><span class="line">    public List&lt;NotificationSendResult&gt; batchSendNotifications(List&lt;NotificationRequest&gt; requests) &#123;</span><br><span class="line">        log.info(&quot;æ‰¹é‡å‘é€é€šçŸ¥ï¼Œæ•°é‡ï¼š&#123;&#125;&quot;, requests.size());</span><br><span class="line">        </span><br><span class="line">        return requests.parallelStream()</span><br><span class="line">                .map(this::sendNotification)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å‘é€ä¸šåŠ¡é€šçŸ¥ï¼ˆå¦‚è®¢å•æ”¯ä»˜æˆåŠŸï¼‰</span><br><span class="line">     */</span><br><span class="line">    @Async</span><br><span class="line">    public void sendBusinessNotification(String templateCode, Long userId, </span><br><span class="line">                                        String businessId, String businessType,</span><br><span class="line">                                        Map&lt;String, Object&gt; variables) &#123;</span><br><span class="line">        NotificationRequest request = NotificationRequest.builder()</span><br><span class="line">                .notificationNo(generateNotificationNo())</span><br><span class="line">                .userId(userId)</span><br><span class="line">                .templateCode(templateCode)</span><br><span class="line">                .notificationType(getNotificationTypeFromTemplate(templateCode))</span><br><span class="line">                .businessId(businessId)</span><br><span class="line">                .businessType(businessType)</span><br><span class="line">                .variables(variables)</span><br><span class="line">                .build();</span><br><span class="line">        </span><br><span class="line">        sendNotification(request);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ¸²æŸ“æ¨¡æ¿</span><br><span class="line">     */</span><br><span class="line">    private String renderTemplate(String template, Map&lt;String, Object&gt; variables) &#123;</span><br><span class="line">        if (variables == null || variables.isEmpty()) &#123;</span><br><span class="line">            return template;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        String result = template;</span><br><span class="line">        for (Map.Entry&lt;String, Object&gt; entry : variables.entrySet()) &#123;</span><br><span class="line">            String key = &quot;&#123;&quot; + entry.getKey() + &quot;&#125;&quot;;</span><br><span class="line">            String value = entry.getValue() != null ? entry.getValue().toString() : &quot;&quot;;</span><br><span class="line">            result = result.replace(key, value);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * è·å–å¯ç”¨çš„æ¸ é“</span><br><span class="line">     */</span><br><span class="line">    private List&lt;NotificationChannel&gt; getEnabledChannels(</span><br><span class="line">            NotificationTemplate template, </span><br><span class="line">            List&lt;UserNotificationConfig&gt; userConfigs) &#123;</span><br><span class="line">        </span><br><span class="line">        List&lt;String&gt; templateChannels = Arrays.asList(template.getChannels().split(&quot;,&quot;));</span><br><span class="line">        List&lt;NotificationChannel&gt; enabledChannels = new ArrayList&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        // æ£€æŸ¥WebSocketæ¸ é“</span><br><span class="line">        if (templateChannels.contains(&quot;websocket&quot;) &amp;&amp; </span><br><span class="line">                isChannelEnabled(userConfigs, &quot;websocket&quot;)) &#123;</span><br><span class="line">            enabledChannels.add(webSocketChannel);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // æ£€æŸ¥çŸ­ä¿¡æ¸ é“</span><br><span class="line">        if (templateChannels.contains(&quot;sms&quot;) &amp;&amp; </span><br><span class="line">                isChannelEnabled(userConfigs, &quot;sms&quot;)) &#123;</span><br><span class="line">            enabledChannels.add(smsChannel);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // æ£€æŸ¥é‚®ä»¶æ¸ é“</span><br><span class="line">        if (templateChannels.contains(&quot;email&quot;) &amp;&amp; </span><br><span class="line">                isChannelEnabled(userConfigs, &quot;email&quot;)) &#123;</span><br><span class="line">            enabledChannels.add(emailChannel);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // æ£€æŸ¥Appæ¨é€æ¸ é“</span><br><span class="line">        if (templateChannels.contains(&quot;app_push&quot;) &amp;&amp; </span><br><span class="line">                isChannelEnabled(userConfigs, &quot;app_push&quot;)) &#123;</span><br><span class="line">            enabledChannels.add(appPushChannel);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // æŒ‰ä¼˜å…ˆçº§æ’åº</span><br><span class="line">        enabledChannels.sort(Comparator.comparing(NotificationChannel::getPriority));</span><br><span class="line">        </span><br><span class="line">        return enabledChannels;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ£€æŸ¥æ¸ é“æ˜¯å¦å¯ç”¨</span><br><span class="line">     */</span><br><span class="line">    private boolean isChannelEnabled(List&lt;UserNotificationConfig&gt; userConfigs, String channel) &#123;</span><br><span class="line">        // å¦‚æœç”¨æˆ·æ²¡æœ‰é…ç½®ï¼Œä½¿ç”¨é»˜è®¤é…ç½®</span><br><span class="line">        return userConfigs.stream()</span><br><span class="line">                .filter(config -&gt; config.getChannel().equals(channel))</span><br><span class="line">                .findFirst()</span><br><span class="line">                .map(UserNotificationConfig::getEnabled)</span><br><span class="line">                .orElse(true);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// é€šçŸ¥è¯·æ±‚</span><br><span class="line">@Data</span><br><span class="line">@Builder</span><br><span class="line">class NotificationRequest &#123;</span><br><span class="line">    private String notificationNo;      // é€šçŸ¥ç¼–å·</span><br><span class="line">    private Long userId;                // ç”¨æˆ·ID</span><br><span class="line">    private String templateCode;        // æ¨¡æ¿ç¼–ç </span><br><span class="line">    private String notificationType;    // é€šçŸ¥ç±»å‹</span><br><span class="line">    private Map&lt;String, Object&gt; variables; // æ¨¡æ¿å˜é‡</span><br><span class="line">    private String businessId;          // ä¸šåŠ¡ID</span><br><span class="line">    private String businessType;        // ä¸šåŠ¡ç±»å‹</span><br><span class="line">    private Integer priority;           // ä¼˜å…ˆçº§</span><br><span class="line">    private LocalDateTime scheduleTime; // è®¡åˆ’å‘é€æ—¶é—´</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// é€šçŸ¥å‘é€ç»“æœ</span><br><span class="line">@Data</span><br><span class="line">class NotificationSendResult &#123;</span><br><span class="line">    private String notificationNo;</span><br><span class="line">    private boolean success;</span><br><span class="line">    private String errorMsg;</span><br><span class="line">    private List&lt;ChannelSendResult&gt; channelResults = new ArrayList&lt;&gt;();</span><br><span class="line">    private LocalDateTime sendTime = LocalDateTime.now();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æ¸ é“å‘é€ç»“æœ</span><br><span class="line">@Data</span><br><span class="line">@Builder</span><br><span class="line">class ChannelSendResult &#123;</span><br><span class="line">    private String channelType;</span><br><span class="line">    private boolean success;</span><br><span class="line">    private String messageId;</span><br><span class="line">    private String errorMsg;</span><br><span class="line">    private LocalDateTime sendTime;</span><br><span class="line">    </span><br><span class="line">    public static ChannelSendResult success(String channelType, String messageId) &#123;</span><br><span class="line">        return ChannelSendResult.builder()</span><br><span class="line">                .channelType(channelType)</span><br><span class="line">                .success(true)</span><br><span class="line">                .messageId(messageId)</span><br><span class="line">                .sendTime(LocalDateTime.now())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public static ChannelSendResult failure(String channelType, String errorMsg) &#123;</span><br><span class="line">        return ChannelSendResult.builder()</span><br><span class="line">                .channelType(channelType)</span><br><span class="line">                .success(false)</span><br><span class="line">                .errorMsg(errorMsg)</span><br><span class="line">                .sendTime(LocalDateTime.now())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// é€šçŸ¥æ¸ é“æ¥å£</span><br><span class="line">public interface NotificationChannel &#123;</span><br><span class="line">    </span><br><span class="line">    String getChannelType();</span><br><span class="line">    </span><br><span class="line">    Integer getPriority();</span><br><span class="line">    </span><br><span class="line">    ChannelSendResult send(Long userId, String title, String content, </span><br><span class="line">                          Map&lt;String, Object&gt; variables);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// WebSocketé€šçŸ¥æ¸ é“</span><br><span class="line">@Component</span><br><span class="line">@Slf4j</span><br><span class="line">class WebSocketNotificationChannel implements NotificationChannel &#123;</span><br><span class="line">    </span><br><span class="line">    private final WebSocketSessionManager sessionManager;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public String getChannelType() &#123;</span><br><span class="line">        return &quot;websocket&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public Integer getPriority() &#123;</span><br><span class="line">        return 1; // æœ€é«˜ä¼˜å…ˆçº§</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public ChannelSendResult send(Long userId, String title, String content, </span><br><span class="line">                                 Map&lt;String, Object&gt; variables) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            // æ„å»ºWebSocketæ¶ˆæ¯</span><br><span class="line">            Map&lt;String, Object&gt; data = Map.of(</span><br><span class="line">                    &quot;type&quot;, &quot;notification&quot;,</span><br><span class="line">                    &quot;notification&quot;, Map.of(</span><br><span class="line">                            &quot;title&quot;, title,</span><br><span class="line">                            &quot;content&quot;, content,</span><br><span class="line">                            &quot;timestamp&quot;, System.currentTimeMillis(),</span><br><span class="line">                            &quot;variables&quot;, variables</span><br><span class="line">                    )</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            String message = JSON.toJSONString(data);</span><br><span class="line">            </span><br><span class="line">            // å‘é€ç»™ç”¨æˆ·</span><br><span class="line">            sessionManager.sendToUser(userId, message);</span><br><span class="line">            </span><br><span class="line">            return ChannelSendResult.success(getChannelType(), </span><br><span class="line">                    &quot;ws_&quot; + System.currentTimeMillis());</span><br><span class="line">            </span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;WebSocketé€šçŸ¥å‘é€å¤±è´¥ï¼Œç”¨æˆ·IDï¼š&#123;&#125;&quot;, userId, e);</span><br><span class="line">            return ChannelSendResult.failure(getChannelType(), e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// çŸ­ä¿¡é€šçŸ¥æ¸ é“</span><br><span class="line">@Component</span><br><span class="line">@Slf4j</span><br><span class="line">class SmsNotificationChannel implements NotificationChannel &#123;</span><br><span class="line">    </span><br><span class="line">    private final SmsService smsService;</span><br><span class="line">    private final UserNotificationConfigService configService;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public String getChannelType() &#123;</span><br><span class="line">        return &quot;sms&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public Integer getPriority() &#123;</span><br><span class="line">        return 2;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public ChannelSendResult send(Long userId, String title, String content, </span><br><span class="line">                                 Map&lt;String, Object&gt; variables) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            // è·å–ç”¨æˆ·æ‰‹æœºå·</span><br><span class="line">            String phone = configService.getUserChannelConfig(userId, &quot;sms&quot;);</span><br><span class="line">            if (phone == null || phone.trim().isEmpty()) &#123;</span><br><span class="line">                return ChannelSendResult.failure(getChannelType(), &quot;ç”¨æˆ·æœªé…ç½®æ‰‹æœºå·&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // å‘é€çŸ­ä¿¡</span><br><span class="line">            SmsSendResult smsResult = smsService.sendSms(phone, content);</span><br><span class="line">            </span><br><span class="line">            if (smsResult.isSuccess()) &#123;</span><br><span class="line">                return ChannelSendResult.success(getChannelType(), smsResult.getBizId());</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                return ChannelSendResult.failure(getChannelType(), smsResult.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;çŸ­ä¿¡é€šçŸ¥å‘é€å¤±è´¥ï¼Œç”¨æˆ·IDï¼š&#123;&#125;&quot;, userId, e);</span><br><span class="line">            return ChannelSendResult.failure(getChannelType(), e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// é‚®ä»¶é€šçŸ¥æ¸ é“</span><br><span class="line">@Component</span><br><span class="line">@Slf4j</span><br><span class="line">class EmailNotificationChannel implements NotificationChannel &#123;</span><br><span class="line">    </span><br><span class="line">    private final EmailService emailService;</span><br><span class="line">    private final UserNotificationConfigService configService;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public String getChannelType() &#123;</span><br><span class="line">        return &quot;email&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public Integer getPriority() &#123;</span><br><span class="line">        return 3;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public ChannelSendResult send(Long userId, String title, String content, </span><br><span class="line">                                 Map&lt;String, Object&gt; variables) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            // è·å–ç”¨æˆ·é‚®ç®±</span><br><span class="line">            String email = configService.getUserChannelConfig(userId, &quot;email&quot;);</span><br><span class="line">            if (email == null || email.trim().isEmpty()) &#123;</span><br><span class="line">                return ChannelSendResult.failure(getChannelType(), &quot;ç”¨æˆ·æœªé…ç½®é‚®ç®±&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // å‘é€é‚®ä»¶</span><br><span class="line">            emailService.sendSimpleEmail(email, title, content);</span><br><span class="line">            </span><br><span class="line">            return ChannelSendResult.success(getChannelType(), </span><br><span class="line">                    &quot;email_&quot; + System.currentTimeMillis());</span><br><span class="line">            </span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;é‚®ä»¶é€šçŸ¥å‘é€å¤±è´¥ï¼Œç”¨æˆ·IDï¼š&#123;&#125;&quot;, userId, e);</span><br><span class="line">            return ChannelSendResult.failure(getChannelType(), e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="8-æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹è€…"><a href="#8-æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹è€…" class="headerlink" title="8. æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹è€…"></a>8. æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹è€…</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.notification.mq;</span><br><span class="line"></span><br><span class="line">import com.shophub.notification.core.NotificationDispatcher;</span><br><span class="line">import lombok.RequiredArgsConstructor;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * RabbitMQæ¶ˆæ¯æ¶ˆè´¹è€…</span><br><span class="line"> */</span><br><span class="line">@Slf4j</span><br><span class="line">@Component</span><br><span class="line">@RequiredArgsConstructor</span><br><span class="line">public class NotificationMessageConsumer &#123;</span><br><span class="line">    </span><br><span class="line">    private final NotificationDispatcher notificationDispatcher;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å¤„ç†è®¢å•æ”¯ä»˜æˆåŠŸé€šçŸ¥</span><br><span class="line">     */</span><br><span class="line">    @RabbitListener(queues = &quot;notification.order.paid&quot;)</span><br><span class="line">    public void handleOrderPaidNotification(OrderPaidMessage message) &#123;</span><br><span class="line">        log.info(&quot;æ”¶åˆ°è®¢å•æ”¯ä»˜æˆåŠŸé€šçŸ¥ï¼š&#123;&#125;&quot;, message);</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            Map&lt;String, Object&gt; variables = Map.of(</span><br><span class="line">                    &quot;orderNo&quot;, message.getOrderNo(),</span><br><span class="line">                    &quot;amount&quot;, message.getAmount(),</span><br><span class="line">                    &quot;payTime&quot;, message.getPayTime().format(DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm:ss&quot;))</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            notificationDispatcher.sendBusinessNotification(</span><br><span class="line">                    &quot;order_paid&quot;,</span><br><span class="line">                    message.getUserId(),</span><br><span class="line">                    message.getOrderNo(),</span><br><span class="line">                    &quot;order&quot;,</span><br><span class="line">                    variables</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;å¤„ç†è®¢å•æ”¯ä»˜æˆåŠŸé€šçŸ¥å¤±è´¥&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å¤„ç†è®¢å•å‘è´§é€šçŸ¥</span><br><span class="line">     */</span><br><span class="line">    @RabbitListener(queues = &quot;notification.order.shipped&quot;)</span><br><span class="line">    public void handleOrderShippedNotification(OrderShippedMessage message) &#123;</span><br><span class="line">        log.info(&quot;æ”¶åˆ°è®¢å•å‘è´§é€šçŸ¥ï¼š&#123;&#125;&quot;, message);</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            Map&lt;String, Object&gt; variables = Map.of(</span><br><span class="line">                    &quot;orderNo&quot;, message.getOrderNo(),</span><br><span class="line">                    &quot;deliveryCompany&quot;, message.getDeliveryCompany(),</span><br><span class="line">                    &quot;deliveryNo&quot;, message.getDeliveryNo(),</span><br><span class="line">                    &quot;shippingTime&quot;, message.getShippingTime().format(DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm:ss&quot;))</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            notificationDispatcher.sendBusinessNotification(</span><br><span class="line">                    &quot;order_shipped&quot;,</span><br><span class="line">                    message.getUserId(),</span><br><span class="line">                    message.getOrderNo(),</span><br><span class="line">                    &quot;order&quot;,</span><br><span class="line">                    variables</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;å¤„ç†è®¢å•å‘è´§é€šçŸ¥å¤±è´¥&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å¤„ç†éªŒè¯ç å‘é€è¯·æ±‚</span><br><span class="line">     */</span><br><span class="line">    @RabbitListener(queues = &quot;notification.verification.code&quot;)</span><br><span class="line">    public void handleVerificationCode(VerificationCodeMessage message) &#123;</span><br><span class="line">        log.info(&quot;æ”¶åˆ°éªŒè¯ç å‘é€è¯·æ±‚ï¼š&#123;&#125;&quot;, message.getPhone());</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            // ç”ŸæˆéªŒè¯ç </span><br><span class="line">            String code = generateVerificationCode();</span><br><span class="line">            </span><br><span class="line">            // å‘é€çŸ­ä¿¡éªŒè¯ç </span><br><span class="line">            smsService.sendVerificationCode(message.getPhone(), code);</span><br><span class="line">            </span><br><span class="line">            // ä¹Ÿå¯ä»¥åŒæ—¶å‘é€é‚®ä»¶éªŒè¯ç </span><br><span class="line">            if (message.getEmail() != null) &#123;</span><br><span class="line">                emailService.sendVerificationCodeEmail(message.getEmail(), code);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;å¤„ç†éªŒè¯ç å‘é€è¯·æ±‚å¤±è´¥&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å¤„ç†ç³»ç»Ÿå…¬å‘Š</span><br><span class="line">     */</span><br><span class="line">    @RabbitListener(queues = &quot;notification.system.announcement&quot;)</span><br><span class="line">    public void handleSystemAnnouncement(SystemAnnouncementMessage message) &#123;</span><br><span class="line">        log.info(&quot;æ”¶åˆ°ç³»ç»Ÿå…¬å‘Šé€šçŸ¥ï¼š&#123;&#125;&quot;, message.getTitle());</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            // æ‰¹é‡å‘é€ç»™æ‰€æœ‰ç”¨æˆ·</span><br><span class="line">            List&lt;Long&gt; userIds = userService.getAllActiveUserIds();</span><br><span class="line">            </span><br><span class="line">            for (Long userId : userIds) &#123;</span><br><span class="line">                Map&lt;String, Object&gt; variables = Map.of(</span><br><span class="line">                        &quot;title&quot;, message.getTitle(),</span><br><span class="line">                        &quot;content&quot;, message.getContent(),</span><br><span class="line">                        &quot;publishTime&quot;, message.getPublishTime().format(DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm:ss&quot;))</span><br><span class="line">                );</span><br><span class="line">                </span><br><span class="line">                notificationDispatcher.sendBusinessNotification(</span><br><span class="line">                        &quot;system_announcement&quot;,</span><br><span class="line">                        userId,</span><br><span class="line">                        null,</span><br><span class="line">                        &quot;system&quot;,</span><br><span class="line">                        variables</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;å¤„ç†ç³»ç»Ÿå…¬å‘Šé€šçŸ¥å¤±è´¥&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * æ­»ä¿¡é˜Ÿåˆ—å¤„ç†</span><br><span class="line">     */</span><br><span class="line">    @RabbitListener(queues = &quot;notification.dlq&quot;)</span><br><span class="line">    public void handleDeadLetterMessage(NotificationDeadLetterMessage message) &#123;</span><br><span class="line">        log.warn(&quot;æ”¶åˆ°æ­»ä¿¡é˜Ÿåˆ—æ¶ˆæ¯ï¼š&#123;&#125;&quot;, message);</span><br><span class="line">        </span><br><span class="line">        // è®°å½•æ—¥å¿—</span><br><span class="line">        log.error(&quot;æ¶ˆæ¯å¤„ç†å¤±è´¥ï¼ŒåŸå§‹æ¶ˆæ¯ï¼š&#123;&#125;ï¼Œå¤±è´¥åŸå› ï¼š&#123;&#125;&quot;, </span><br><span class="line">                message.getOriginalMessage(), message.getFailureReason());</span><br><span class="line">        </span><br><span class="line">        // å¯ä»¥å‘é€å‘Šè­¦é€šçŸ¥ç»™ç®¡ç†å‘˜</span><br><span class="line">        sendAlertToAdmin(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// è®¢å•æ”¯ä»˜æˆåŠŸæ¶ˆæ¯</span><br><span class="line">@Data</span><br><span class="line">class OrderPaidMessage &#123;</span><br><span class="line">    private String orderNo;</span><br><span class="line">    private Long userId;</span><br><span class="line">    private BigDecimal amount;</span><br><span class="line">    private LocalDateTime payTime;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// è®¢å•å‘è´§æ¶ˆæ¯</span><br><span class="line">@Data</span><br><span class="line">class OrderShippedMessage &#123;</span><br><span class="line">    private String orderNo;</span><br><span class="line">    private Long userId;</span><br><span class="line">    private String deliveryCompany;</span><br><span class="line">    private String deliveryNo;</span><br><span class="line">    private LocalDateTime shippingTime;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// éªŒè¯ç æ¶ˆæ¯</span><br><span class="line">@Data</span><br><span class="line">class VerificationCodeMessage &#123;</span><br><span class="line">    private String phone;</span><br><span class="line">    private String email;</span><br><span class="line">    private String bizType; // ä¸šåŠ¡ç±»å‹ï¼šregister, login, reset_password</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// ç³»ç»Ÿå…¬å‘Šæ¶ˆæ¯</span><br><span class="line">@Data</span><br><span class="line">class SystemAnnouncementMessage &#123;</span><br><span class="line">    private String title;</span><br><span class="line">    private String content;</span><br><span class="line">    private LocalDateTime publishTime;</span><br><span class="line">    private Integer priority; // ä¼˜å…ˆçº§</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="9-é€šçŸ¥æœåŠ¡Controller"><a href="#9-é€šçŸ¥æœåŠ¡Controller" class="headerlink" title="9. é€šçŸ¥æœåŠ¡Controller"></a>9. é€šçŸ¥æœåŠ¡Controller</h3><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line">package com.shophub.notification.controller;</span><br><span class="line"></span><br><span class="line">import com.shophub.common.result.Result;</span><br><span class="line">import com.shophub.notification.core.NotificationDispatcher;</span><br><span class="line">import com.shophub.notification.core.NotificationQueryService;</span><br><span class="line">import com.shophub.notification.vo.*;</span><br><span class="line">import io.swagger.annotations.Api;</span><br><span class="line">import io.swagger.annotations.ApiOperation;</span><br><span class="line">import lombok.RequiredArgsConstructor;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;/api/notification&quot;)</span><br><span class="line">@RequiredArgsConstructor</span><br><span class="line">@Api(tags = &quot;é€šçŸ¥æœåŠ¡&quot;)</span><br><span class="line">public class NotificationController &#123;</span><br><span class="line">    </span><br><span class="line">    private final NotificationDispatcher notificationDispatcher;</span><br><span class="line">    private final NotificationQueryService queryService;</span><br><span class="line">    private final UserNotificationConfigService configService;</span><br><span class="line">    private final WebSocketSessionManager sessionManager;</span><br><span class="line">    </span><br><span class="line">    @PostMapping(&quot;/send&quot;)</span><br><span class="line">    @ApiOperation(&quot;å‘é€é€šçŸ¥&quot;)</span><br><span class="line">    public Result&lt;NotificationSendResult&gt; sendNotification(@RequestBody NotificationRequest request) &#123;</span><br><span class="line">        NotificationSendResult result = notificationDispatcher.sendNotification(request);</span><br><span class="line">        return Result.success(result);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @GetMapping(&quot;/list&quot;)</span><br><span class="line">    @ApiOperation(&quot;è·å–ç”¨æˆ·é€šçŸ¥åˆ—è¡¨&quot;)</span><br><span class="line">    public Result&lt;PageResult&lt;NotificationRecordVo&gt;&gt; getNotificationList(</span><br><span class="line">            @RequestParam Long userId,</span><br><span class="line">            @RequestParam(required = false) String notificationType,</span><br><span class="line">            @RequestParam(required = false) Integer readStatus,</span><br><span class="line">            @RequestParam(defaultValue = &quot;1&quot;) Integer pageNum,</span><br><span class="line">            @RequestParam(defaultValue = &quot;20&quot;) Integer pageSize) &#123;</span><br><span class="line">        </span><br><span class="line">        PageResult&lt;NotificationRecordVo&gt; pageResult = queryService.getUserNotifications(</span><br><span class="line">                userId, notificationType, readStatus, pageNum, pageSize);</span><br><span class="line">        return Result.success(pageResult);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @GetMapping(&quot;/unread-count&quot;)</span><br><span class="line">    @ApiOperation(&quot;è·å–æœªè¯»é€šçŸ¥æ•°é‡&quot;)</span><br><span class="line">    public Result&lt;Long&gt; getUnreadCount(@RequestParam Long userId) &#123;</span><br><span class="line">        Long count = queryService.getUnreadCount(userId);</span><br><span class="line">        return Result.success(count);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @PostMapping(&quot;/mark-read&quot;)</span><br><span class="line">    @ApiOperation(&quot;æ ‡è®°é€šçŸ¥ä¸ºå·²è¯»&quot;)</span><br><span class="line">    public Result&lt;Boolean&gt; markAsRead(@RequestBody MarkReadRequest request) &#123;</span><br><span class="line">        boolean success = queryService.markAsRead(request.getUserId(), request.getNotificationIds());</span><br><span class="line">        </span><br><span class="line">        // å‘é€WebSocketæ¶ˆæ¯é€šçŸ¥å‰ç«¯æ›´æ–°</span><br><span class="line">        if (success) &#123;</span><br><span class="line">            Map&lt;String, Object&gt; data = Map.of(</span><br><span class="line">                    &quot;type&quot;, &quot;notification_read&quot;,</span><br><span class="line">                    &quot;notificationIds&quot;, request.getNotificationIds()</span><br><span class="line">            );</span><br><span class="line">            String message = JSON.toJSONString(data);</span><br><span class="line">            sessionManager.sendToUser(request.getUserId(), message);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return Result.success(success);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @PostMapping(&quot;/mark-all-read&quot;)</span><br><span class="line">    @ApiOperation(&quot;æ ‡è®°æ‰€æœ‰é€šçŸ¥ä¸ºå·²è¯»&quot;)</span><br><span class="line">    public Result&lt;Boolean&gt; markAllAsRead(@RequestParam Long userId) &#123;</span><br><span class="line">        boolean success = queryService.markAllAsRead(userId);</span><br><span class="line">        </span><br><span class="line">        if (success) &#123;</span><br><span class="line">            Map&lt;String, Object&gt; data = Map.of(</span><br><span class="line">                    &quot;type&quot;, &quot;notification_all_read&quot;</span><br><span class="line">            );</span><br><span class="line">            String message = JSON.toJSONString(data);</span><br><span class="line">            sessionManager.sendToUser(userId, message);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return Result.success(success);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @DeleteMapping(&quot;/delete&quot;)</span><br><span class="line">    @ApiOperation(&quot;åˆ é™¤é€šçŸ¥&quot;)</span><br><span class="line">    public Result&lt;Boolean&gt; deleteNotifications(@RequestBody DeleteNotificationsRequest request) &#123;</span><br><span class="line">        boolean success = queryService.deleteNotifications(request.getUserId(), request.getNotificationIds());</span><br><span class="line">        return Result.success(success);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @GetMapping(&quot;/config&quot;)</span><br><span class="line">    @ApiOperation(&quot;è·å–ç”¨æˆ·é€šçŸ¥é…ç½®&quot;)</span><br><span class="line">    public Result&lt;List&lt;UserNotificationConfigVo&gt;&gt; getUserConfig(@RequestParam Long userId) &#123;</span><br><span class="line">        List&lt;UserNotificationConfigVo&gt; configs = configService.getUserConfigsVo(userId);</span><br><span class="line">        return Result.success(configs);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @PutMapping(&quot;/config&quot;)</span><br><span class="line">    @ApiOperation(&quot;æ›´æ–°ç”¨æˆ·é€šçŸ¥é…ç½®&quot;)</span><br><span class="line">    public Result&lt;Boolean&gt; updateUserConfig(@RequestBody UpdateConfigRequest request) &#123;</span><br><span class="line">        boolean success = configService.updateUserConfig(</span><br><span class="line">                request.getUserId(), </span><br><span class="line">                request.getNotificationType(),</span><br><span class="line">                request.getChannel(),</span><br><span class="line">                request.getEnabled(),</span><br><span class="line">                request.getConfigValue()</span><br><span class="line">        );</span><br><span class="line">        return Result.success(success);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @PostMapping(&quot;/test-sms&quot;)</span><br><span class="line">    @ApiOperation(&quot;æµ‹è¯•çŸ­ä¿¡å‘é€&quot;)</span><br><span class="line">    public Result&lt;Boolean&gt; testSms(@RequestParam String phone, @RequestParam String content) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            smsService.sendSms(phone, content);</span><br><span class="line">            return Result.success(true);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;æµ‹è¯•çŸ­ä¿¡å‘é€å¤±è´¥&quot;, e);</span><br><span class="line">            return Result.error(&quot;çŸ­ä¿¡å‘é€å¤±è´¥: &quot; + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @PostMapping(&quot;/test-email&quot;)</span><br><span class="line">    @ApiOperation(&quot;æµ‹è¯•é‚®ä»¶å‘é€&quot;)</span><br><span class="line">    public Result&lt;Boolean&gt; testEmail(@RequestParam String email, </span><br><span class="line">                                     @RequestParam String subject,</span><br><span class="line">                                     @RequestParam String content) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            emailService.sendSimpleEmail(email, subject, content);</span><br><span class="line">            return Result.success(true);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;æµ‹è¯•é‚®ä»¶å‘é€å¤±è´¥&quot;, e);</span><br><span class="line">            return Result.error(&quot;é‚®ä»¶å‘é€å¤±è´¥: &quot; + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @GetMapping(&quot;/websocket/status&quot;)</span><br><span class="line">    @ApiOperation(&quot;è·å–WebSocketè¿æ¥çŠ¶æ€&quot;)</span><br><span class="line">    public Result&lt;WebSocketStatus&gt; getWebSocketStatus(@RequestParam Long userId) &#123;</span><br><span class="line">        WebSocketStatus status = sessionManager.getUserWebSocketStatus(userId);</span><br><span class="line">        return Result.success(status);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @GetMapping(&quot;/statistics&quot;)</span><br><span class="line">    @ApiOperation(&quot;è·å–é€šçŸ¥ç»Ÿè®¡&quot;)</span><br><span class="line">    public Result&lt;NotificationStatistics&gt; getNotificationStatistics(</span><br><span class="line">            @RequestParam(required = false) String startDate,</span><br><span class="line">            @RequestParam(required = false) String endDate) &#123;</span><br><span class="line">        </span><br><span class="line">        NotificationStatistics statistics = queryService.getStatistics(startDate, endDate);</span><br><span class="line">        return Result.success(statistics);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="10-Docker-Composeé…ç½®æ–‡ä»¶"><a href="#10-Docker-Composeé…ç½®æ–‡ä»¶" class="headerlink" title="10. Docker Composeé…ç½®æ–‡ä»¶"></a>10. Docker Composeé…ç½®æ–‡ä»¶</h3><p>yaml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"># docker-compose-notification.yml</span><br><span class="line">version: &#x27;3.8&#x27;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  rabbitmq:</span><br><span class="line">    image: rabbitmq:3.12-management</span><br><span class="line">    container_name: shophub-rabbitmq</span><br><span class="line">    environment:</span><br><span class="line">      - RABBITMQ_DEFAULT_USER=admin</span><br><span class="line">      - RABBITMQ_DEFAULT_PASS=admin123</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;5672:5672&quot;</span><br><span class="line">      - &quot;15672:15672&quot;</span><br><span class="line">    volumes:</span><br><span class="line">      - ./rabbitmq/data:/var/lib/rabbitmq</span><br><span class="line">    networks:</span><br><span class="line">      - shophub-network</span><br><span class="line">    healthcheck:</span><br><span class="line">      test: [&quot;CMD&quot;, &quot;rabbitmq-diagnostics&quot;, &quot;ping&quot;]</span><br><span class="line">      interval: 30s</span><br><span class="line">      timeout: 10s</span><br><span class="line">      retries: 3</span><br><span class="line"></span><br><span class="line">  notification-service:</span><br><span class="line">    build:</span><br><span class="line">      context: ./shophub-notification</span><br><span class="line">      dockerfile: Dockerfile</span><br><span class="line">    container_name: shophub-notification-service</span><br><span class="line">    environment:</span><br><span class="line">      - SPRING_PROFILES_ACTIVE=docker</span><br><span class="line">      - RABBITMQ_HOST=rabbitmq</span><br><span class="line">      - RABBITMQ_PORT=5672</span><br><span class="line">      - REDIS_HOST=redis</span><br><span class="line">      - REDIS_PORT=6379</span><br><span class="line">      - MYSQL_HOST=mysql</span><br><span class="line">      - MYSQL_PORT=3306</span><br><span class="line">      - NACOS_HOST=nacos</span><br><span class="line">      - NACOS_PORT=8848</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;8087:8087&quot;  # HTTPç«¯å£</span><br><span class="line">      - &quot;8088:8088&quot;  # WebSocketç«¯å£</span><br><span class="line">    networks:</span><br><span class="line">      - shophub-network</span><br><span class="line">    depends_on:</span><br><span class="line">      rabbitmq:</span><br><span class="line">        condition: service_healthy</span><br><span class="line">      redis:</span><br><span class="line">        condition: service_healthy</span><br><span class="line">      mysql:</span><br><span class="line">        condition: service_healthy</span><br><span class="line">    healthcheck:</span><br><span class="line">      test: [&quot;CMD&quot;, &quot;curl&quot;, &quot;-f&quot;, &quot;http://localhost:8087/notification/health&quot;]</span><br><span class="line">      interval: 30s</span><br><span class="line">      timeout: 10s</span><br><span class="line">      retries: 3</span><br><span class="line">    volumes:</span><br><span class="line">      - ./logs/notification:/app/logs</span><br><span class="line">      - ./templates:/app/templates</span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  shophub-network:</span><br><span class="line">    external: true</span><br></pre></td></tr></table></figure><h2 id="ğŸ¯-ç¬¬å…­é˜¶æ®µå®Œæˆæ€»ç»“"><a href="#ğŸ¯-ç¬¬å…­é˜¶æ®µå®Œæˆæ€»ç»“" class="headerlink" title="ğŸ¯ ç¬¬å…­é˜¶æ®µå®Œæˆæ€»ç»“"></a>ğŸ¯ ç¬¬å…­é˜¶æ®µå®Œæˆæ€»ç»“</h2><h3 id="å·²å®ç°çš„åŠŸèƒ½ï¼š-4"><a href="#å·²å®ç°çš„åŠŸèƒ½ï¼š-4" class="headerlink" title="å·²å®ç°çš„åŠŸèƒ½ï¼š"></a>å·²å®ç°çš„åŠŸèƒ½ï¼š</h3><ol><li><strong>WebSocketå®æ—¶é€šçŸ¥</strong>ï¼š<ul><li>Nettyé«˜æ€§èƒ½WebSocketæœåŠ¡å™¨</li><li>Spring WebSocketå¤‡ç”¨æ–¹æ¡ˆ</li><li>å¿ƒè·³æ£€æµ‹å’Œä¼šè¯ç®¡ç†</li><li>é›†ç¾¤æ”¯æŒå’Œå¹¿æ’­åŠŸèƒ½</li></ul></li><li><strong>å¤šæ¸ é“æ¨é€</strong>ï¼š<ul><li>çŸ­ä¿¡æœåŠ¡ï¼ˆé˜¿é‡Œäº‘é›†æˆï¼‰</li><li>é‚®ä»¶æœåŠ¡ï¼ˆæ¨¡æ¿+é™„ä»¶ï¼‰</li><li>Appæ¨é€ï¼ˆé¢„ç•™æ¥å£ï¼‰</li><li>WebSocketå®æ—¶æ¨é€</li></ul></li><li><strong>é€šçŸ¥ç®¡ç†ç³»ç»Ÿ</strong>ï¼š<ul><li>é€šçŸ¥æ¨¡æ¿ç®¡ç†</li><li>ç”¨æˆ·é€šçŸ¥é…ç½®</li><li>é€šçŸ¥è®°å½•å’Œç»Ÿè®¡</li><li>æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å¤„ç†</li></ul></li><li><strong>é«˜çº§ç‰¹æ€§</strong>ï¼š<ul><li>é€šçŸ¥å»é‡å’Œé¢‘ç‡æ§åˆ¶</li><li>æ‰¹é‡å‘é€å’Œå®šæ—¶å‘é€</li><li>å¤±è´¥é‡è¯•å’Œæ­»ä¿¡é˜Ÿåˆ—</li><li>å¤šè¯­è¨€æ¨¡æ¿æ”¯æŒ</li></ul></li></ol><h3 id="æŠ€æœ¯æ ˆå®è·µï¼š-4"><a href="#æŠ€æœ¯æ ˆå®è·µï¼š-4" class="headerlink" title="æŠ€æœ¯æ ˆå®è·µï¼š"></a>æŠ€æœ¯æ ˆå®è·µï¼š</h3><p>âœ… <strong>WebSocket</strong>ï¼šNetty + Spring WebSocket<br>âœ… <strong>æ¶ˆæ¯é˜Ÿåˆ—</strong>ï¼šRabbitMQï¼ˆå¼‚æ­¥é€šçŸ¥ï¼‰<br>âœ… <strong>çŸ­ä¿¡æœåŠ¡</strong>ï¼šé˜¿é‡Œäº‘çŸ­ä¿¡SDK<br>âœ… <strong>é‚®ä»¶æœåŠ¡</strong>ï¼šSpring Mail + Freemarker<br>âœ… <strong>æ¨¡æ¿å¼•æ“</strong>ï¼šFreemarker + Thymeleaf<br>âœ… <strong>ä¼šè¯ç®¡ç†</strong>ï¼šRedisé›†ç¾¤æ”¯æŒ</p><h3 id="æ€§èƒ½æŒ‡æ ‡ï¼š-1"><a href="#æ€§èƒ½æŒ‡æ ‡ï¼š-1" class="headerlink" title="æ€§èƒ½æŒ‡æ ‡ï¼š"></a>æ€§èƒ½æŒ‡æ ‡ï¼š</h3><ol><li><strong>WebSocketè¿æ¥</strong>ï¼šæ”¯æŒ10ä¸‡+å¹¶å‘è¿æ¥</li><li><strong>æ¶ˆæ¯å»¶è¿Ÿ</strong>ï¼šWebSocket &lt; 100msï¼Œå…¶ä»–æ¸ é“ &lt; 1s</li><li><strong>å‘é€æˆåŠŸç‡</strong>ï¼š&gt; 99.9%</li><li><strong>ç³»ç»Ÿå¯ç”¨æ€§</strong>ï¼š99.95% SLA</li></ol><h3 id="æ•´ä¸ªé¡¹ç›®æ¶æ„å®Œæˆæ€»ç»“ï¼š"><a href="#æ•´ä¸ªé¡¹ç›®æ¶æ„å®Œæˆæ€»ç»“ï¼š" class="headerlink" title="æ•´ä¸ªé¡¹ç›®æ¶æ„å®Œæˆæ€»ç»“ï¼š"></a>æ•´ä¸ªé¡¹ç›®æ¶æ„å®Œæˆæ€»ç»“ï¼š</h3><p>ç»è¿‡15å¤©çš„ç³»ç»Ÿå®ç°ï¼Œæˆ‘ä»¬å®Œæˆäº†<strong>ShopHubå…¨æ ˆç”µå•†å¹³å°</strong>çš„æ‰€æœ‰æ ¸å¿ƒæœåŠ¡ï¼š</p><ol><li><strong>âœ… ç¬¬ä¸€é˜¶æ®µ</strong>ï¼šåŸºç¡€æ¶æ„ + é€šç”¨æ¨¡å— + è®¤è¯æœåŠ¡</li><li><strong>âœ… ç¬¬äºŒé˜¶æ®µ</strong>ï¼šç½‘å…³æœåŠ¡ + æœåŠ¡æ³¨å†Œå‘ç°</li><li><strong>âœ… ç¬¬ä¸‰é˜¶æ®µ</strong>ï¼šå•†å“æœåŠ¡ + æ–‡ä»¶ä¸Šä¼  + ç¼“å­˜ç­–ç•¥</li><li><strong>âœ… ç¬¬å››é˜¶æ®µ</strong>ï¼šæœç´¢æœåŠ¡ + Elasticsearché›†æˆ</li><li><strong>âœ… ç¬¬äº”é˜¶æ®µ</strong>ï¼šè®¢å•æœåŠ¡ + åˆ†å¸ƒå¼äº‹åŠ¡ + åº“å­˜æ§åˆ¶</li><li><strong>âœ… ç¬¬å…­é˜¶æ®µ</strong>ï¼šæ”¯ä»˜æœåŠ¡ + é€šçŸ¥æœåŠ¡</li></ol><h3 id="é¡¹ç›®ç‰¹ç‚¹ï¼š"><a href="#é¡¹ç›®ç‰¹ç‚¹ï¼š" class="headerlink" title="é¡¹ç›®ç‰¹ç‚¹ï¼š"></a>é¡¹ç›®ç‰¹ç‚¹ï¼š</h3><ol><li><strong>å¾®æœåŠ¡æ¶æ„</strong>ï¼šSpring Cloud + Nacos + Dubbo</li><li><strong>é«˜å¹¶å‘å¤„ç†</strong>ï¼šRedis + Redisson + åˆ†åº“åˆ†è¡¨</li><li><strong>åˆ†å¸ƒå¼äº‹åŠ¡</strong>ï¼šSeata + æ¶ˆæ¯é˜Ÿåˆ—</li><li><strong>å®æ—¶é€šä¿¡</strong>ï¼šWebSocket + Netty</li><li><strong>æœç´¢ä¼˜åŒ–</strong>ï¼šElasticsearch + IKåˆ†è¯</li><li><strong>å®¹å™¨åŒ–éƒ¨ç½²</strong>ï¼šDocker + Kubernetes</li><li><strong>CI&#x2F;CDæµç¨‹</strong>ï¼šGitLab CI + Jenkins</li></ol><h3 id="åç»­æ‰©å±•æ–¹å‘ï¼š"><a href="#åç»­æ‰©å±•æ–¹å‘ï¼š" class="headerlink" title="åç»­æ‰©å±•æ–¹å‘ï¼š"></a>åç»­æ‰©å±•æ–¹å‘ï¼š</h3><ol><li><strong>å¤§æ•°æ®åˆ†æ</strong>ï¼šç”¨æˆ·è¡Œä¸ºåˆ†æã€å•†å“æ¨è</li><li><strong>AIé›†æˆ</strong>ï¼šæ™ºèƒ½å®¢æœã€å›¾åƒè¯†åˆ«</li><li><strong>åŒºå—é“¾</strong>ï¼šå•†å“æº¯æºã€é˜²ä¼ªéªŒè¯</li><li><strong>ç‰©è”ç½‘</strong>ï¼šæ™ºèƒ½ä»“å‚¨ã€ç‰©æµè·Ÿè¸ª</li><li><strong>å›½é™…åŒ–</strong>ï¼šå¤šè¯­è¨€ã€å¤šè´§å¸æ”¯æŒ</li></ol><p>è¿™ä¸ªé¡¹ç›®æ¶µç›–äº†åç«¯å¼€å‘çš„æ‰€æœ‰æ ¸å¿ƒæŠ€æœ¯å’Œæ¶æ„æ¨¡å¼ï¼Œå¯ä»¥ä½œä¸ºå­¦ä¹ å’Œå®è·µçš„ä¼˜ç§€æ¡ˆä¾‹ã€‚æ¯ä¸ªæ¨¡å—éƒ½å®ç°äº†ç”Ÿäº§çº§çš„ä»£ç è´¨é‡ï¼Œå…·æœ‰å¾ˆå¥½çš„æ‰©å±•æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚</p><p>éœ€è¦æˆ‘æä¾›é¡¹ç›®çš„éƒ¨ç½²æ–‡æ¡£ã€è¿ç»´æ‰‹å†Œæˆ–å…·ä½“çš„æµ‹è¯•ç”¨ä¾‹å—ï¼Ÿ</p><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Javaé¢è¯•ç¬”è®°</title>
      <link href="/post/f9ba3e83.html"/>
      <url>/post/f9ba3e83.html</url>
      
        <content type="html"><![CDATA[<h1 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h1><h2 id="åŸºç¡€"><a href="#åŸºç¡€" class="headerlink" title="åŸºç¡€"></a>åŸºç¡€</h2><p><strong>Java 9 ä¸ºä½•è¦å°† <code>String</code> çš„åº•å±‚å®ç°ç”± <code>char[]</code> æ”¹æˆäº† <code>byte[]</code> ?</strong></p><p>æ–°ç‰ˆçš„ String æ”¯æŒä¸¤ä¸ªç¼–ç æ–¹æ¡ˆï¼šLatin-1 å’Œ UTF-16ã€‚å¦‚æœå­—ç¬¦ä¸²ä¸­åŒ…å«çš„æ±‰å­—æ²¡æœ‰è¶…è¿‡ Latin-1 å¯è¡¨ç¤ºèŒƒå›´å†…çš„å­—ç¬¦ï¼Œå°±ä½¿ç”¨ Latin-1 ä½œä¸ºç¼–ç æ–¹æ¡ˆã€‚Latin-1 ç¼–ç æ–¹æ¡ˆä¸‹ï¼Œ<code>byte</code> å ä¸€ä¸ªå­—èŠ‚(8 ä½)ï¼Œ<code>char</code> å ç”¨ 2 ä¸ªå­—èŠ‚ï¼ˆ16ï¼‰ï¼Œ<code>byte</code> ç›¸è¾ƒ <code>char</code> èŠ‚çœä¸€åŠçš„å†…å­˜ç©ºé—´ã€‚</p><p><strong>ä¸è¦åœ¨ finally è¯­å¥å—ä¸­ä½¿ç”¨ return!</strong> </p><p>å½“ try è¯­å¥å’Œ finally è¯­å¥ä¸­éƒ½æœ‰ return è¯­å¥æ—¶ï¼Œtry è¯­å¥å—ä¸­çš„ return è¯­å¥ä¼šè¢«å¿½ç•¥ã€‚è¿™æ˜¯å› ä¸º try è¯­å¥ä¸­çš„ return è¿”å›å€¼ä¼šå…ˆè¢«æš‚å­˜åœ¨ä¸€ä¸ªæœ¬åœ°å˜é‡ä¸­ï¼Œå½“æ‰§è¡Œåˆ° finally è¯­å¥ä¸­çš„ return ä¹‹åï¼Œè¿™ä¸ªæœ¬åœ°å˜é‡çš„å€¼å°±å˜ä¸ºäº† finally è¯­å¥ä¸­çš„ return è¿”å›å€¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    System.out.println(f(<span class="number">2</span>)); <span class="comment">// è¾“å‡º0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">f</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> value * value;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (value == <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å¹¶å‘"><a href="#å¹¶å‘" class="headerlink" title="å¹¶å‘"></a>å¹¶å‘</h2><p><strong>synchronized åå‘é”ä¸ºä»€ä¹ˆè¢«åºŸå¼ƒ</strong></p><p>ä¸¤æ–¹é¢åŸå› ï¼š</p><ol><li>åå‘é”å¯ä»¥æå‡å•çº¿ç¨‹å¯¹åŒæ­¥ä»£ç å—çš„è®¿é—®æ€§èƒ½ï¼Œå—ç›Šäºåå‘é”çš„ç¨‹åºé€šå¸¸æ˜¯ä½¿ç”¨äº†æ—©æœŸçš„Javaé›†åˆï¼Œå¦‚HashTableã€Vectorï¼Œä½†æ˜¯éšç€JDKçš„å‘å±•ï¼Œè¿™äº›é›†åˆå·²è¢«åºŸå¼ƒï¼Œåå‘é”å¸¦æ¥çš„æ€§èƒ½æ”¶ç›Šä¸å†æ˜æ˜¾ï¼›æ’¤é”€åå‘é”æœ‰é¢å¤–å¼€é”€</li><li>JVMå†…éƒ¨ä»£ç ç»´æŠ¤æˆæœ¬å¤ªé«˜</li></ol><p><strong>çº¿ç¨‹æ± ä¸­çº¿ç¨‹å¼‚å¸¸åï¼šé”€æ¯è¿˜æ˜¯å¤ç”¨</strong></p><p>ä½¿ç”¨<code>execute()</code>æäº¤çš„ä»»åŠ¡ï¼Œå¦‚æœå¼‚å¸¸æ²¡æœ‰è¢«ä»»åŠ¡æ•è·å¹¶å¤„ç†ï¼Œå½“å‰çº¿ç¨‹åœæ­¢ï¼Œçº¿ç¨‹æ± é‡æ–°åˆ›å»ºçº¿ç¨‹ï¼›ä½¿ç”¨<code>submit()</code>æäº¤çš„ä»»åŠ¡ï¼Œå¼‚å¸¸ä¼šè¢«æ”¾å…¥<code>Future</code>ï¼Œçº¿ç¨‹ç»§ç»­å¤ç”¨ã€‚</p><p>è¿™ç§è®¾è®¡å…è®¸<code>submit()</code>æä¾›æ›´çµæ´»çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼Œå› ä¸ºå®ƒå…è®¸è°ƒç”¨è€…å†³å®šå¦‚ä½•å¤„ç†å¼‚å¸¸ï¼Œè€Œ<code>execute()</code>åˆ™é€‚ç”¨äºé‚£äº›ä¸éœ€è¦å…³æ³¨æ‰§è¡Œç»“æœçš„åœºæ™¯ã€‚</p><p>æºç åˆ†æï¼š<a href="https://mp.weixin.qq.com/s/9ODjdUU-EwQFF5PrnzOGfw">çº¿ç¨‹æ± ä¸­çº¿ç¨‹å¼‚å¸¸åï¼šé”€æ¯è¿˜æ˜¯å¤ç”¨ï¼Ÿ - äº¬ä¸œæŠ€æœ¯</a>ã€‚</p><h2 id="JVM"><a href="#JVM" class="headerlink" title="JVM"></a>JVM</h2><h1 id="ç³»ç»Ÿè®¾è®¡"><a href="#ç³»ç»Ÿè®¾è®¡" class="headerlink" title="ç³»ç»Ÿè®¾è®¡"></a>ç³»ç»Ÿè®¾è®¡</h1><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Javaé¢è¯•å¸¸è§é—®é¢˜</title>
      <link href="/post/720ca998.html"/>
      <url>/post/720ca998.html</url>
      
        <content type="html"><![CDATA[<table><thead><tr><th>æ•°æ®ç±»å‹</th><th>ç”¨é€”</th></tr></thead><tbody><tr><td><code>String</code></td><td>è®¡æ•°å™¨ï¼ˆæ–‡ç« é˜…è¯»é‡ã€ç‚¹èµæ•°ï¼‰ã€åˆ†å¸ƒå¼é”ï¼ˆSETNX å‘½ä»¤ï¼‰</td></tr><tr><td><code>Hash</code></td><td>å­˜å‚¨å¯¹è±¡ä¿¡æ¯ï¼ˆç”¨æˆ·èµ„æ–™ã€å•†å“è¯¦æƒ…ï¼‰</td></tr><tr><td><code>List</code></td><td>æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆLPUSH&#x2F;RPOPï¼‰ã€æœ€æ–°Næ¡è®°å½•ï¼ˆæœ‹å‹åœˆã€å¾®åšæ—¶é—´çº¿ï¼‰</td></tr><tr><td><code>Set</code></td><td>æ ‡ç­¾ç³»ç»Ÿï¼ˆæ–‡ç« æ ‡ç­¾ï¼‰ å…±åŒå¥½å‹&#x2F;å…³æ³¨ï¼ˆSINTERï¼‰</td></tr><tr><td><code>Sorted Set</code></td><td>å®æ—¶æ’è¡Œæ¦œï¼ˆæ¸¸æˆç§¯åˆ†ã€çƒ­æœæ¦œï¼‰</td></tr><tr><td><code>Bitmap</code></td><td>ç”¨æˆ·ç­¾åˆ°ç»Ÿè®¡ã€æ´»è·ƒç”¨æˆ·ç»Ÿè®¡</td></tr><tr><td><code>HyperLogLog</code></td><td></td></tr><tr><td><code>Geospatial</code></td><td>é™„è¿‘çš„äºº&#x2F;åœ°ç‚¹</td></tr></tbody></table><h2 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h2><h3 id="Java-åŸºç¡€"><a href="#Java-åŸºç¡€" class="headerlink" title="Java åŸºç¡€"></a><strong>Java åŸºç¡€</strong></h3><ol><li>Java ä¸­çš„å‡ ç§åŸºæœ¬æ•°æ®ç±»å‹æ˜¯ä»€ä¹ˆï¼Ÿå¯¹åº”çš„åŒ…è£…ç±»å‹æ˜¯ä»€ä¹ˆï¼Ÿå„è‡ªå ç”¨å¤šå°‘å­—èŠ‚å‘¢ï¼Ÿ</li><li>String ã€ StringBuffer å’Œ StringBuilder çš„åŒºåˆ«æ˜¯ä»€ä¹ˆ? String ä¸ºä»€ä¹ˆæ˜¯ä¸å¯å˜çš„?</li><li>String s1 &#x3D; new String(â€œabcâ€);è¿™æ®µä»£ç åˆ›å»ºäº†å‡ ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼Ÿ</li><li>&#x3D;&#x3D; ä¸ equals?hashCode ä¸ equals ?</li><li>åŒ…è£…ç±»å‹çš„ç¼“å­˜æœºåˆ¶äº†è§£ä¹ˆï¼Ÿ</li><li>è‡ªåŠ¨è£…ç®±ä¸æ‹†ç®±äº†è§£å—ï¼ŸåŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>æ·±æ‹·è´å’Œæµ…æ‹·è´åŒºåˆ«äº†è§£å—ï¼Ÿä»€ä¹ˆæ˜¯å¼•ç”¨æ‹·è´ï¼Ÿ</li><li>è°ˆè°ˆå¯¹ Java æ³¨è§£çš„ç†è§£ï¼Œè§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ</li><li>Exception å’Œ Error æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</li><li>Java åå°„ï¼Ÿåå°„æœ‰ä»€ä¹ˆç¼ºç‚¹ï¼Ÿä½ æ˜¯æ€ä¹ˆç†è§£åå°„çš„ï¼ˆä¸ºä»€ä¹ˆæ¡†æ¶éœ€è¦åå°„ï¼‰ï¼Ÿ</li><li>Java æ³›å‹äº†è§£ä¹ˆï¼Ÿä»€ä¹ˆæ˜¯ç±»å‹æ“¦é™¤ï¼Ÿä»‹ç»ä¸€ä¸‹å¸¸ç”¨çš„é€šé…ç¬¦ï¼Ÿ</li><li>å†…éƒ¨ç±»äº†è§£å—ï¼ŸåŒ¿åå†…éƒ¨ç±»äº†è§£å—ï¼Ÿ</li><li>BIO,NIO,AIO æœ‰ä»€ä¹ˆåŒºåˆ«?</li></ol><p>å‚è€ƒç­”æ¡ˆï¼š</p><ol><li><a href="https://javaguide.cn/java/basis/java-basic-questions-01.html">Java åŸºç¡€å¸¸è§é¢è¯•é¢˜æ€»ç»“ï¼ˆä¸Šï¼‰</a></li><li><a href="https://javaguide.cn/java/basis/java-basic-questions-02.html">Java åŸºç¡€å¸¸è§é¢è¯•é¢˜æ€»ç»“ï¼ˆä¸­ï¼‰</a></li><li><a href="https://javaguide.cn/java/basis/java-basic-questions-03.html">Java åŸºç¡€å¸¸è§é¢è¯•é¢˜æ€»ç»“ï¼ˆä¸‹ï¼‰</a></li></ol><h3 id="Java-é›†åˆæ¡†æ¶"><a href="#Java-é›†åˆæ¡†æ¶" class="headerlink" title="Java é›†åˆæ¡†æ¶"></a><strong>Java é›†åˆæ¡†æ¶</strong></h3><ol><li><p>è¯´è¯´ List,Set,Map ä¸‰è€…çš„åŒºåˆ«ï¼Ÿä¸‰è€…åº•å±‚çš„æ•°æ®ç»“æ„ï¼Ÿ</p></li><li><p>æœ‰å“ªäº›é›†åˆæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Ÿæ€ä¹ˆè§£å†³å‘¢ï¼Ÿ</p></li><li><p>æ¯”è¾ƒ HashSetã€LinkedHashSet å’Œ TreeSet ä¸‰è€…çš„å¼‚åŒ</p></li><li><p>HashMap å’Œ Hashtable çš„åŒºåˆ«ï¼ŸHashMap å’Œ HashSet åŒºåˆ«ï¼ŸHashMap å’Œ TreeMap åŒºåˆ«ï¼Ÿ</p></li><li><p>HashMap çš„åº•å±‚å®ç°</p><blockquote><p><code>HashMap</code> çš„é”®å’Œå€¼éƒ½å¯ä»¥ä¸º<code>null</code>ï¼Œä½†æ˜¯åªèƒ½æœ‰ä¸€ä¸ªä¸º<code>null</code>çš„é”®</p><table><thead><tr><th>JDKç‰ˆæœ¬</th><th>åº•å±‚æ•°æ®ç»“æ„</th><th>å†²çªè§£å†³</th></tr></thead><tbody><tr><td>JDK1.7</td><td>æ•°ç»„+é“¾è¡¨</td><td>æ‹‰é“¾æ³•</td></tr><tr><td>JDK1.8</td><td>æ•°ç»„+é“¾æ¥+çº¢é»‘æ ‘</td><td>å½“é“¾è¡¨é•¿åº¦å¤§äº8æ—¶ï¼Œå¦‚æœå½“å‰æ•°ç»„é•¿åº¦å°äº64ï¼Œå…ˆè¿›è¡Œæ‰©å®¹ï¼Œå¦åˆ™å°†é“¾è¡¨è½¬ä¸ºçº¢é»‘æ ‘</td></tr></tbody></table></blockquote></li><li><p>HashMap çš„é•¿åº¦ä¸ºä»€ä¹ˆæ˜¯ 2 çš„å¹‚æ¬¡æ–¹</p></li><li><p>ConcurrentHashMap å’Œ Hashtable çš„åŒºåˆ«ï¼Ÿ</p></li><li><p>ConcurrentHashMap çº¿ç¨‹å®‰å…¨çš„å…·ä½“å®ç°æ–¹å¼&#x2F;åº•å±‚å…·ä½“å®ç°</p></li></ol><p>å‚è€ƒç­”æ¡ˆï¼š</p><ol><li><a href="https://javaguide.cn/java/collection/java-collection-questions-01.html">Java é›†åˆå¸¸è§é¢è¯•é¢˜æ€»ç»“ï¼ˆä¸Šï¼‰</a></li><li><a href="https://javaguide.cn/java/collection/java-collection-questions-02.html">Java é›†åˆå¸¸è§é¢è¯•é¢˜æ€»ç»“ï¼ˆä¸­ï¼‰</a></li><li><a href="https://javaguide.cn/java/collection/java-collection-questions-01.html">Java é›†åˆå¸¸è§é¢è¯•é¢˜æ€»ç»“ï¼ˆä¸‹ï¼‰</a></li></ol><h3 id="Java-å¹¶å‘ï¼ˆè¿›é˜¶ï¼‰"><a href="#Java-å¹¶å‘ï¼ˆè¿›é˜¶ï¼‰" class="headerlink" title="Java å¹¶å‘ï¼ˆè¿›é˜¶ï¼‰"></a><strong>Java å¹¶å‘ï¼ˆè¿›é˜¶ï¼‰</strong></h3><ol><li>ä»€ä¹ˆæ˜¯çº¿ç¨‹å’Œè¿›ç¨‹?çº¿ç¨‹ä¸è¿›ç¨‹çš„å…³ç³»,åŒºåˆ«åŠä¼˜ç¼ºç‚¹ï¼Ÿ</li><li>ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å¤šçº¿ç¨‹å‘¢?</li><li>ä»€ä¹ˆæ˜¯ä¸Šä¸‹æ–‡åˆ‡æ¢?</li><li>ä»€ä¹ˆæ˜¯çº¿ç¨‹æ­»é”?å¦‚ä½•é¿å…æ­»é”?</li><li>ä¹è§‚é”å’Œæ‚²è§‚é”äº†è§£ä¹ˆï¼Ÿå¦‚ä½•å®ç°ä¹è§‚é”ï¼Ÿ</li><li>è¯´è¯´ sleep() æ–¹æ³•å’Œ wait() æ–¹æ³•åŒºåˆ«å’Œå…±åŒç‚¹?</li><li>è®²ä¸€ä¸‹ JMM(Java å†…å­˜æ¨¡å‹)ã€‚volatile å…³é”®å­—è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿè¯´è¯´ synchronized å…³é”®å­—å’Œ volatile å…³é”®å­—çš„åŒºåˆ«ã€‚</li><li>Java å†…å­˜åŒºåŸŸå’Œ JMM æœ‰ä½•åŒºåˆ«ï¼Ÿ</li><li>happens-before åŸåˆ™</li><li>synchronized å…³é”®å­—çš„ä½œç”¨</li><li>synchronized å’Œ ReentrantLock çš„åŒºåˆ«</li><li>synchronized å’Œ volatile çš„åŒºåˆ«ã€‚</li><li>ğŸ˜–synchronized å…³é”®å­—çš„åº•å±‚åŸç†</li><li>ThreadLocal å…³é”®å­—çš„ä½œç”¨ï¼Œå†…å­˜æ³„éœ²é—®é¢˜</li><li>çº¿ç¨‹æ± æœ‰ä»€ä¹ˆç”¨ï¼Ÿä¸ºä»€ä¹ˆä¸æ¨èä½¿ç”¨å†…ç½®çº¿ç¨‹æ± ï¼Ÿ</li><li>Java çº¿ç¨‹æ± æœ‰å“ªäº›å‚æ•°ï¼Ÿé˜»å¡é˜Ÿåˆ—æœ‰å‡ ç§ï¼Ÿæ‹’ç»ç­–ç•¥æœ‰å‡ ç§ï¼Ÿ</li><li>çº¿ç¨‹æ± å¤„ç†ä»»åŠ¡çš„æµç¨‹äº†è§£å—ï¼Ÿ</li><li>å®ç° Runnable æ¥å£å’Œ Callable æ¥å£çš„åŒºåˆ«ã€‚</li><li>å¦‚ä½•ç»™çº¿ç¨‹æ± å‘½åï¼Ÿä¸ºä»€ä¹ˆå»ºè®®ç»™çº¿ç¨‹æ± å‘½åï¼Ÿ</li><li>ğŸ˜– å¦‚ä½•åŠ¨æ€ä¿®æ”¹çº¿ç¨‹æ± å‚æ•°ï¼Ÿ</li><li>ğŸ˜–AQS åŸç†äº†è§£ä¹ˆï¼ŸAQS ç»„ä»¶æœ‰å“ªäº›ï¼Ÿ</li><li>Semaphore æœ‰ä»€ä¹ˆç”¨ï¼ŸåŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>CountDownLatch æœ‰ä»€ä¹ˆç”¨ï¼ŸåŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>CyclicBarrier æœ‰ä»€ä¹ˆç”¨ï¼ŸåŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>å¤šä¸ªä»»åŠ¡çš„ç¼–æ’å¯ä»¥æ€ä¹ˆåšï¼Ÿé¡¹ç›®ç”¨åˆ°äº† CompletableFuture å—ï¼Ÿ</li></ol><p>å‚è€ƒç­”æ¡ˆï¼š</p><ol><li><a href="https://javaguide.cn/java/concurrent/java-concurrent-questions-01.html">Java å¹¶å‘å¸¸è§é¢è¯•é¢˜æ€»ç»“ï¼ˆä¸Šï¼‰</a></li><li><a href="https://javaguide.cn/java/concurrent/java-concurrent-questions-02.html">Java å¹¶å‘å¸¸è§é¢è¯•é¢˜æ€»ç»“ï¼ˆä¸­ï¼‰</a></li><li><a href="https://javaguide.cn/java/concurrent/java-concurrent-questions-03.html">Java å¹¶å‘å¸¸è§é¢è¯•é¢˜æ€»ç»“ï¼ˆä¸‹ï¼‰</a></li><li><a href="https://javaguide.cn/java/concurrent/jmm.html">JMMï¼ˆJava å†…å­˜æ¨¡å‹ï¼‰è¯¦è§£</a></li><li><a href="https://javaguide.cn/java/concurrent/java-thread-pool-summary.html">Java çº¿ç¨‹æ± è¯¦è§£</a></li><li><a href="https://javaguide.cn/java/concurrent/java-thread-pool-best-practices.html">Java çº¿ç¨‹æ± æœ€ä½³å®è·µ</a></li><li><a href="https://javaguide.cn/java/concurrent/threadlocal.html">ThreadLocal è¯¦è§£</a></li><li><a href="https://javaguide.cn/java/concurrent/aqs.html">AQS è¯¦è§£</a></li><li><a href="https://javaguide.cn/java/concurrent/completablefuture-intro.html">CompletableFuture è¯¦è§£</a></li></ol><h3 id="JVMï¼ˆè¿›é˜¶ï¼‰"><a href="#JVMï¼ˆè¿›é˜¶ï¼‰" class="headerlink" title="JVMï¼ˆè¿›é˜¶ï¼‰"></a><strong>JVMï¼ˆè¿›é˜¶ï¼‰</strong></h3><p>JVM ç›¸å…³çš„çŸ¥è¯†ç‚¹ï¼Œä¸€èˆ¬æ˜¯å¤§å‚ï¼ˆä¾‹å¦‚ç¾å›¢ã€é˜¿é‡Œï¼‰å’Œä¸€äº›ä¸é”™çš„ä¸­å‚ï¼ˆä¾‹å¦‚æºç¨‹ã€é¡ºä¸°ã€æ‹›é“¶ç½‘ç»œï¼‰æ‰ä¼šé—®åˆ°ï¼Œé¢è¯•å›½ä¼ã€å·®ä¸€ç‚¹çš„ä¸­å‚å’Œå°å‚å°±æ²¡å¿…è¦å‡†å¤‡äº†ã€‚</p><ol><li>è¿è¡Œæ—¶æ•°æ®åŒºä¸­åŒ…å«å“ªäº›åŒºåŸŸï¼Ÿå“ªäº›çº¿ç¨‹å…±äº«ï¼Ÿå“ªäº›çº¿ç¨‹ç‹¬äº«ï¼Ÿå“ªäº›åŒºåŸŸå¯èƒ½ä¼šå‡ºç°OutOfMemoryErrorï¼Ÿå“ªäº›åŒºåŸŸä¸ä¼šå‡ºç°OutOfMemoryError?</li><li>æ–¹æ³•åŒºå’Œæ°¸ä¹…ä»£çš„å…³ç³»</li><li>æ ˆä¸­å­˜æ”¾ä»€ä¹ˆæ•°æ®ï¼Œå †ä¸­å‘¢ï¼Ÿ</li><li>ä¸ºä»€ä¹ˆè¦å°†æ°¸ä¹…ä»£ (PermGen) æ›¿æ¢ä¸ºå…ƒç©ºé—´ (MetaSpace) å‘¢?</li><li>å­—ç¬¦ä¸²å¸¸é‡æ± åœ¨ä»€ä¹ˆä½ç½®ï¼ˆJDK1.7 ä¹‹å‰åœ¨æ°¸ä¹…ä»£ï¼ŒJDK1.7 åœ¨å †ï¼‰ï¼ŸJDK 1.7 ä¸ºä»€ä¹ˆè¦å°†å­—ç¬¦ä¸²å¸¸é‡æ± ç§»åŠ¨åˆ°å †ä¸­ï¼Ÿ</li><li>å †ç©ºé—´çš„åŸºæœ¬ç»“æ„äº†è§£å—ï¼Ÿä»€ä¹ˆæƒ…å†µä¸‹å¯¹è±¡ä¼šè¿›å…¥è€å¹´ä»£ï¼Ÿ</li><li>å¤§å¯¹è±¡æ”¾åœ¨å“ªä¸ªå†…å­˜åŒºåŸŸï¼Ÿ</li><li>ç›´æ¥å†…å­˜æœ‰ä»€ä¹ˆç”¨ï¼Ÿå¦‚ä½•ä½¿ç”¨ï¼Ÿ</li><li>Java å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹ï¼ˆäº”æ­¥ï¼Œå»ºè®®èƒ½é»˜å†™å‡ºæ¥å¹¶ä¸”è¦çŸ¥é“æ¯ä¸€æ­¥è™šæ‹Ÿæœºåšäº†ä»€ä¹ˆï¼‰</li><li>å¯¹è±¡çš„è®¿é—®å®šä½çš„ä¸¤ç§æ–¹å¼ï¼ˆå¥æŸ„å’Œç›´æ¥æŒ‡é’ˆä¸¤ç§æ–¹å¼ï¼‰</li><li>ä¸ºä»€ä¹ˆéœ€è¦ GC?</li><li>æœ‰å“ªäº›å¸¸è§çš„ GC?è°ˆè°ˆä½ å¯¹ Minor GCã€è¿˜æœ‰ Full GC çš„ç†è§£ã€‚Minor GC ä¸ Full GC åˆ†åˆ«åœ¨ä»€ä¹ˆæ—¶å€™å‘ç”Ÿï¼Ÿ Minor GC ä¼šå‘ç”Ÿ stop the world ç°è±¡å—ï¼Ÿ</li><li>å¦‚ä½•åˆ¤æ–­å¯¹è±¡æ˜¯å¦æ­»äº¡ï¼ˆå¼•ç”¨è®¡æ•°æ³•å’Œå¯è¾¾æ€§åˆ†æç®—æ³•ä¸¤ç§æ–¹æ³•ï¼‰ï¼Ÿ</li><li>è®²ä¸€ä¸‹å¯è¾¾æ€§åˆ†æç®—æ³•çš„æµç¨‹ã€‚ å“ªäº›å¯¹è±¡å¯ä»¥ä½œä¸º GC Roots å‘¢ï¼Ÿ</li><li>å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå¸¸é‡æ˜¯åºŸå¼ƒå¸¸é‡?å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªç±»æ˜¯æ— ç”¨çš„ç±»?</li><li>åƒåœ¾æ”¶é›†æœ‰å“ªäº›ç®—æ³•ï¼Œå„è‡ªçš„ç‰¹ç‚¹ï¼Ÿ</li><li>é»˜è®¤çš„åƒåœ¾å›æ”¶å™¨æ˜¯å“ªä¸€ä¸ªï¼ŸZGC äº†è§£å—ï¼Ÿ</li><li>ğŸ˜– è®²ä¸€ä¸‹ CMS åƒåœ¾æ”¶é›†å™¨çš„å››ä¸ªæ­¥éª¤ã€‚CMS æœ‰ä»€ä¹ˆç¼ºç‚¹?</li><li>ğŸ˜– å¹¶å‘æ ‡è®°è¦è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿå¹¶å‘æ ‡è®°å¸¦æ¥äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿå¦‚ä½•è§£å†³å¹¶å‘æ‰«ææ—¶å¯¹è±¡æ¶ˆå¤±é—®é¢˜ï¼Ÿ</li><li>G1 åƒåœ¾æ”¶é›†å™¨çš„æ­¥éª¤ã€‚æœ‰ä»€ä¹ˆç¼ºç‚¹ï¼Ÿ</li><li>ğŸ˜–JVM ä¸­çš„å®‰å…¨ç‚¹å’Œå®‰å…¨åŒºå„ä»£è¡¨ä»€ä¹ˆï¼Ÿ</li><li>ä»€ä¹ˆæ˜¯ç±»åŠ è½½ï¼Ÿä½•æ—¶ç±»åŠ è½½ï¼Ÿç±»åŠ è½½æµç¨‹ï¼Ÿ</li><li>çŸ¥é“å“ªäº›ç±»åŠ è½½å™¨ã€‚ç±»åŠ è½½å™¨ä¹‹é—´çš„å…³ç³»ï¼Ÿ</li><li>ç±»åŠ è½½å™¨çš„åŒäº²å§”æ´¾äº†è§£ä¹ˆï¼Ÿ ç»“åˆ Tomcat è¯´ä¸€ä¸‹åŒäº²å§”æ´¾ï¼ˆTomcat å¦‚ä½•æ‰“ç ´åŒäº²å§”æ‰˜æœºåˆ¶ï¼Ÿâ€¦ï¼‰ã€‚</li><li>ä¸ºä»€ä¹ˆéœ€è¦åŒäº²å§”æ´¾?</li><li>ğŸ˜– å †å†…å­˜ç›¸å…³çš„ JVM å‚æ•°æœ‰å“ªäº›ï¼Ÿä½ åœ¨é¡¹ç›®ä¸­å®é™…é…ç½®è¿‡äº†å—ï¼Ÿ</li><li>ğŸ˜– ä½ åœ¨é¡¹ç›®ä¸­é‡åˆ°è¿‡ GC é—®é¢˜å—ï¼Ÿæ€ä¹ˆåˆ†æå’Œè§£å†³çš„ï¼Ÿ</li><li>ğŸ˜– å¦‚ä½•é™ä½ Full GC çš„é¢‘ç‡ï¼Ÿ</li><li>ğŸ˜– é¡¹ç›®ä¸­å®è·µè¿‡ JVM è°ƒä¼˜å—ï¼Ÿæ€ä¹ˆåšçš„ï¼Ÿ</li></ol><p>å‚è€ƒç­”æ¡ˆï¼š</p><ol><li><a href="https://javaguide.cn/java/jvm/memory-area.html">Java å†…å­˜åŒºåŸŸè¯¦è§£ï¼ˆé‡ç‚¹ï¼‰</a></li><li><a href="https://javaguide.cn/java/jvm/jvm-garbage-collection.html">JVM åƒåœ¾å›æ”¶è¯¦è§£ï¼ˆé‡ç‚¹ï¼‰</a></li><li><a href="https://javaguide.cn/java/jvm/class-file-structure.html">ç±»æ–‡ä»¶ç»“æ„è¯¦è§£</a></li><li><a href="https://javaguide.cn/java/jvm/class-loading-process.html">ç±»åŠ è½½è¿‡ç¨‹è¯¦è§£</a></li><li><a href="https://javaguide.cn/java/jvm/classloader.html">ç±»åŠ è½½å™¨è¯¦è§£ï¼ˆé‡ç‚¹ï¼‰</a></li><li><a href="https://juejin.cn/post/6844904070788939790">é¢è¯•å®˜:ä½ è¯´ä½ ç†Ÿæ‚‰ JVM?é‚£ä½ è®²ä¸€ä¸‹å¹¶å‘çš„å¯è¾¾æ€§åˆ†æ</a></li><li><a href="https://tech.meituan.com/2020/08/06/new-zgc-practice-in-meituan.html">æ–°ä¸€ä»£åƒåœ¾å›æ”¶å™¨ ZGC çš„æ¢ç´¢ä¸å®è·µ</a></li><li><a href="https://www.cnblogs.com/chenchuxin/p/15259439.html">æµ…è°ˆ JVM GC çš„å®‰å…¨ç‚¹ä¸å®‰å…¨åŒºåŸŸ</a></li><li><a href="https://javaguide.cn/java/jvm/jvm-in-action.html">JVM çº¿ä¸Šé—®é¢˜æ’æŸ¥å’Œæ€§èƒ½è°ƒä¼˜æ¡ˆä¾‹</a></li></ol><h2 id="æ•°æ®åº“"><a href="#æ•°æ®åº“" class="headerlink" title="æ•°æ®åº“"></a><strong>æ•°æ®åº“</strong></h2><h3 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a><strong>MySQL</strong></h3><h4 id="æ‰‹æ’•-SQL"><a href="#æ‰‹æ’•-SQL" class="headerlink" title="æ‰‹æ’• SQL"></a><strong>æ‰‹æ’• SQL</strong></h4><p>ç¬”è¯•å¯èƒ½ä¼šè€ƒå¯Ÿæ‰‹æ’• SQLï¼Œå»ºè®®æå‰å‡†å¤‡ä¸€ä¸‹ï¼Œå¯ä»¥çœ‹æˆ‘æ€»ç»“çš„ SQL è¯­æ³•åŸºç¡€çŸ¥è¯†å’Œ SQL å¸¸è§é¢è¯•é¢˜ï¼š</p><ol><li><a href="https://javaguide.cn/database/sql/sql-syntax-summary.html">SQL è¯­æ³•åŸºç¡€çŸ¥è¯†æ€»ç»“</a></li><li><a href="https://javaguide.cn/database/sql/sql-questions-01.html">SQL å¸¸è§é¢è¯•é¢˜æ€»ç»“</a></li></ol><h4 id="MySQL-å­˜å‚¨å¼•æ“"><a href="#MySQL-å­˜å‚¨å¼•æ“" class="headerlink" title="MySQL å­˜å‚¨å¼•æ“"></a><strong>MySQL å­˜å‚¨å¼•æ“</strong></h4><ol><li>MySQL æ”¯æŒå“ªäº›å­˜å‚¨å¼•æ“ï¼Ÿé»˜è®¤ä½¿ç”¨å“ªä¸ªï¼Ÿ</li><li>MyISAM å’Œ InnoDB æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</li></ol><h4 id="MySQL-äº‹åŠ¡"><a href="#MySQL-äº‹åŠ¡" class="headerlink" title="MySQL äº‹åŠ¡"></a><strong>MySQL äº‹åŠ¡</strong></h4><ol><li>äº‹åŠ¡çš„å››å¤§ç‰¹æ€§äº†è§£ä¹ˆ?</li><li>å¹¶å‘äº‹åŠ¡å¸¦æ¥äº†å“ªäº›é—®é¢˜?ä¸å¯é‡å¤è¯»å’Œå¹»è¯»æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</li><li>MySQL äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Ÿé»˜è®¤æ˜¯ä»€ä¹ˆçº§åˆ«ï¼Ÿ</li><li>MySQL çš„éš”ç¦»çº§åˆ«æ˜¯åŸºäºé”å®ç°çš„å—ï¼Ÿ</li><li>InnoDB å¯¹ MVCC çš„å…·ä½“å®ç°</li></ol><h4 id="MySQL-å­—æ®µç±»å‹"><a href="#MySQL-å­—æ®µç±»å‹" class="headerlink" title="MySQL å­—æ®µç±»å‹"></a><strong>MySQL å­—æ®µç±»å‹</strong></h4><ol><li>char å’Œ varchar çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>varchar(100)å’Œ varchar(10)çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>decimal å’Œ float&#x2F;double çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿå­˜å‚¨é‡‘é’±åº”è¯¥ç”¨å“ªä¸€ç§ï¼Ÿ</li><li>ä¸ºä»€ä¹ˆä¸æ¨èä½¿ç”¨ text å’Œ blobï¼Ÿ</li></ol><h4 id="MySQL-ç´¢å¼•"><a href="#MySQL-ç´¢å¼•" class="headerlink" title="MySQL ç´¢å¼•"></a><strong>MySQL ç´¢å¼•</strong></h4><ol><li>ä¸ºä»€ä¹ˆç´¢å¼•èƒ½æé«˜æŸ¥è¯¢é€Ÿåº¦?</li><li>èšé›†ç´¢å¼•å’Œéèšé›†ç´¢å¼•çš„åŒºåˆ«ï¼Ÿéèšé›†ç´¢å¼•ä¸€å®šå›è¡¨æŸ¥è¯¢å—?</li><li>ç´¢å¼•è¿™ä¹ˆå¤šä¼˜ç‚¹ï¼Œä¸ºä»€ä¹ˆä¸å¯¹è¡¨ä¸­çš„æ¯ä¸€ä¸ªåˆ—åˆ›å»ºä¸€ä¸ªç´¢å¼•å‘¢ï¼Ÿ(ä½¿ç”¨ç´¢å¼•ä¸€å®šèƒ½æé«˜æŸ¥è¯¢æ€§èƒ½å—?)</li><li>ç´¢å¼•åº•å±‚çš„æ•°æ®ç»“æ„äº†è§£ä¹ˆï¼ŸHash ç´¢å¼•å’Œ B+æ ‘ç´¢å¼•ä¼˜åŠ£åˆ†æ</li><li>B+æ ‘åšç´¢å¼•æ¯”çº¢é»‘æ ‘å¥½åœ¨å“ªé‡Œï¼Ÿ</li><li>æœ€å·¦å‰ç¼€åŒ¹é…åŸåˆ™äº†è§£ä¹ˆï¼Ÿ</li><li>ä»€ä¹ˆæ˜¯è¦†ç›–ç´¢å¼•</li><li>å¦‚ä½•æŸ¥çœ‹æŸæ¡ SQL è¯­å¥æ˜¯å¦ç”¨åˆ°äº†ç´¢å¼•ï¼Ÿ</li></ol><h4 id="MySQL-é”"><a href="#MySQL-é”" class="headerlink" title="MySQL é”"></a><strong>MySQL é”</strong></h4><ol><li>è¡¨çº§é”å’Œè¡Œçº§é”æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</li><li>å“ªäº›æ“ä½œä¼šåŠ è¡¨çº§é”ï¼Ÿå“ªäº›æ“ä½œä¼šåŠ è¡Œçº§é”ï¼Ÿè¯·ç®€å•ä¸¾ä¾‹è¯´ä¸€ä¸‹ã€‚</li><li>InnoDB æœ‰å“ªå‡ ç±»è¡Œé”ï¼Ÿ</li><li>ğŸ˜–Next-Key Lock çš„åŠ é”èŒƒå›´ï¼Ÿ</li><li>å½“å‰è¯»å’Œå¿«ç…§è¯»æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</li><li>MySQL å¦‚ä½•ä½¿ç”¨ä¹è§‚é”å’Œæ‚²è§‚é”ï¼Ÿ</li></ol><h4 id="MySQL-æ—¥å¿—"><a href="#MySQL-æ—¥å¿—" class="headerlink" title="MySQL æ—¥å¿—"></a><strong>MySQL æ—¥å¿—</strong></h4><ol><li>MySQL ä¸­å¸¸è§çš„æ—¥å¿—æœ‰å“ªäº›ï¼Ÿ</li><li>æ…¢æŸ¥è¯¢æ—¥å¿—æœ‰ä»€ä¹ˆç”¨ï¼Ÿ</li><li>binlog ä¸»è¦è®°å½•äº†ä»€ä¹ˆï¼Ÿ</li><li>redo log å¦‚ä½•ä¿è¯äº‹åŠ¡çš„æŒä¹…æ€§ï¼Ÿ</li><li>é¡µä¿®æ”¹ä¹‹åä¸ºä»€ä¹ˆä¸ç›´æ¥åˆ·ç›˜å‘¢ï¼Ÿ</li><li>binlog å’Œ redolog æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</li><li>undo log å¦‚ä½•ä¿è¯äº‹åŠ¡çš„åŸå­æ€§ï¼Ÿ</li><li>â€¦â€¦</li></ol><p>ä¸Šè¯‰é—®é¢˜çš„ç­”æ¡ˆå¯ä»¥åœ¨<a href="https://javaguide.cn/zhuanlan/java-mian-shi-zhi-bei.html">ã€ŠJava é¢è¯•æŒ‡åŒ—ã€‹</a> çš„ <strong>ã€ŒæŠ€æœ¯é¢è¯•é¢˜ç¯‡ã€</strong> ä¸­æ‰¾åˆ°ã€‚</p><p><img src="https://article-images.zsxq.com/FroGHuRFtMeYIHlbVgsz4LHJIT09" alt="img"></p><h4 id="MySQL-æ€§èƒ½ä¼˜åŒ–"><a href="#MySQL-æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="MySQL æ€§èƒ½ä¼˜åŒ–"></a><strong>MySQL æ€§èƒ½ä¼˜åŒ–</strong></h4><ol><li>èƒ½ç”¨ MySQL ç›´æ¥å­˜å‚¨æ–‡ä»¶ï¼ˆæ¯”å¦‚å›¾ç‰‡ï¼‰å—ï¼Ÿ</li><li>MySQL å¦‚ä½•å­˜å‚¨ IP åœ°å€ï¼Ÿ</li><li>å¦‚ä½•åˆ†æ SQL çš„æ€§èƒ½ï¼Ÿ</li><li>æœ‰å“ªäº›å¸¸è§çš„ SQL ä¼˜åŒ–æ‰‹æ®µï¼Ÿ</li><li>ç®€å•è¯´ä¸€ä¸‹å¤§è¡¨ä¼˜åŒ–çš„æ€è·¯ã€‚</li><li>è¯»å†™åˆ†ç¦»å¦‚ä½•å®ç°ï¼Ÿ</li><li>ä¸ºä»€ä¹ˆè¦åˆ†åº“åˆ†è¡¨ï¼Ÿæœ‰å“ªäº›å¸¸è§çš„åˆ†åº“åˆ†è¡¨å·¥å…·ï¼Ÿ</li><li>æ·±åº¦åˆ†é¡µå¦‚ä½•ä¼˜åŒ–ï¼Ÿ</li><li>æ•°æ®å†·çƒ­åˆ†ç¦»å¦‚ä½•åšï¼Ÿ</li><li>å¸¸è§çš„æ•°æ®åº“ä¼˜åŒ–æ–¹æ³•æœ‰å“ªäº›ï¼Ÿ</li></ol><h4 id="å‚è€ƒç­”æ¡ˆ"><a href="#å‚è€ƒç­”æ¡ˆ" class="headerlink" title="å‚è€ƒç­”æ¡ˆ"></a><strong>å‚è€ƒç­”æ¡ˆ</strong></h4><ol><li><a href="https://javaguide.cn/database/mysql/mysql-questions-01.html">MySQ å¸¸è§é¢è¯•é¢˜æ€»ç»“</a></li><li><a href="https://javaguide.cn/database/mysql/innodb-implementation-of-mvcc.html">InnoDB å­˜å‚¨å¼•æ“å¯¹ MVCC çš„å®ç°</a></li><li><a href="https://segmentfault.com/a/1190000040129107">MySQL next-key lock åŠ é”èŒƒå›´æ˜¯ä»€ä¹ˆï¼Ÿ</a></li><li><a href="https://javaguide.cn/database/mysql/mysql-index.html">MySQL ç´¢å¼•è¯¦è§£</a></li><li><a href="https://javaguide.cn/high-performance/read-and-write-separation-and-library-subtable.html">è¯»å†™åˆ†ç¦»å’Œåˆ†åº“åˆ†è¡¨è¯¦è§£</a></li><li><a href="https://javaguide.cn/high-performance/read-and-write-separation-and-library-subtable.html">è¯»å†™åˆ†ç¦»å’Œåˆ†åº“åˆ†è¡¨è¯¦è§£</a>ã€<a href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzAxNTM4NzAyNg==&action=getalbum&album_id=2987992825445416970&scene=173&from_msgid=2247502708&from_itemidx=1&count=3&nolastread=1#wechat_redirect">ShardingSphere5.x åˆ†åº“åˆ†è¡¨åŸç†ä¸å®æˆ˜</a></li><li><a href="https://javaguide.cn/high-performance/data-cold-hot-separation.html">æ•°æ®å†·çƒ­åˆ†ç¦»è¯¦è§£</a></li><li><a href="https://javaguide.cn/high-performance/sql-optimization.html">å¸¸è§ SQL ä¼˜åŒ–æ‰‹æ®µæ€»ç»“</a></li><li><a href="https://javaguide.cn/high-performance/deep-pagination-optimization.html">æ·±åº¦åˆ†é¡µä»‹ç»åŠä¼˜åŒ–å»ºè®®</a></li></ol><h3 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a><strong>Redis</strong></h3><h4 id="Redis-åŸºç¡€"><a href="#Redis-åŸºç¡€" class="headerlink" title="Redis åŸºç¡€"></a><strong>Redis åŸºç¡€</strong></h4><ol><li>Redis ä¸ºä»€ä¹ˆè¿™ä¹ˆå¿«ï¼Ÿ</li><li>åˆ†å¸ƒå¼ç¼“å­˜å¸¸è§çš„æŠ€æœ¯é€‰å‹æ–¹æ¡ˆæœ‰å“ªäº›ï¼Ÿè¯´ä¸€ä¸‹ Redis å’Œ Memcached çš„åŒºåˆ«å’Œå…±åŒç‚¹</li><li>æœ¬åœ°ç¼“å­˜å’Œåˆ†å¸ƒå¼ç¼“å­˜æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿå¦‚ä½•é€‰æ‹©ï¼Ÿ</li><li>è¯´ä¸€ä¸‹æœ‰ç¼“å­˜æƒ…å†µä¸‹æŸ¥è¯¢æ•°æ®å’Œä¿®æ”¹æ•°æ®çš„æµç¨‹ã€‚</li><li>å¸¸è§çš„ç¼“å­˜è¯»å†™ç­–ç•¥æœ‰å“ªäº›ï¼Ÿ</li><li>ä»€ä¹ˆæ˜¯ Redis Moduleï¼Ÿæœ‰ä»€ä¹ˆç”¨ï¼Ÿé¡¹ç›®ä½¿ç”¨è¿‡å—ï¼Ÿ</li></ol><h4 id="Redis-åº”ç”¨"><a href="#Redis-åº”ç”¨" class="headerlink" title="Redis åº”ç”¨"></a><strong>Redis åº”ç”¨</strong></h4><ol><li><p>Redis é™¤äº†åšç¼“å­˜ï¼Œè¿˜èƒ½åšä»€ä¹ˆï¼Ÿ</p><blockquote><table><thead><tr><th>æ•°æ®ç±»å‹</th><th>ç”¨é€”</th></tr></thead><tbody><tr><td><code>String</code></td><td>è®¡æ•°å™¨ï¼ˆæ–‡ç« é˜…è¯»é‡ã€ç‚¹èµæ•°ï¼‰ã€åˆ†å¸ƒå¼é”ï¼ˆSETNX å‘½ä»¤ï¼‰</td></tr><tr><td><code>Hash</code></td><td>å­˜å‚¨å¯¹è±¡ä¿¡æ¯ï¼ˆç”¨æˆ·èµ„æ–™ã€å•†å“è¯¦æƒ…ï¼‰</td></tr><tr><td><code>List</code></td><td>æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆLPUSH&#x2F;RPOPï¼‰ã€æœ€æ–°Næ¡è®°å½•ï¼ˆæœ‹å‹åœˆã€å¾®åšæ—¶é—´çº¿ï¼‰</td></tr><tr><td><code>Set</code></td><td>æ ‡ç­¾ç³»ç»Ÿï¼ˆæ–‡ç« æ ‡ç­¾ï¼‰ã€å…±åŒå¥½å‹&#x2F;å…³æ³¨ï¼ˆSINTERï¼‰</td></tr><tr><td><code>Sorted Set</code></td><td>å®æ—¶æ’è¡Œæ¦œï¼ˆæ¸¸æˆç§¯åˆ†ã€çƒ­æœæ¦œï¼‰</td></tr><tr><td><code>Bitmap</code></td><td>ç”¨æˆ·ç­¾åˆ°ç»Ÿè®¡ã€æ´»è·ƒç”¨æˆ·ç»Ÿè®¡</td></tr><tr><td><code>HyperLogLog</code></td><td></td></tr><tr><td><code>Geospatial</code></td><td>é™„è¿‘çš„äºº&#x2F;åœ°ç‚¹</td></tr><tr><td><code>Stream</code></td><td>æ¶ˆæ¯é˜Ÿåˆ—</td></tr></tbody></table><p>å…¶ä»–ï¼šé™æµ</p></blockquote></li><li><p>å¦‚ä½•åŸºäº Redis å®ç°åˆ†å¸ƒå¼é”ï¼Ÿ</p><blockquote><ul><li><p>æœ€ç®€æ˜“çš„åˆ†å¸ƒå¼é”ï¼š<code>SETNX key value</code></p></li><li><p>é˜²æ­¢è¯¯åˆ é”ï¼š</p></li></ul><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> redis.call(<span class="string">&quot;GET&quot;</span>, KEYS[<span class="number">1</span>] == ARGV[<span class="number">1</span>]) <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> redis.call(<span class="string">&quot;DEL&quot;</span>, KEYS[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><ul><li><p>é¿å…é”æ— æ³•é‡Šæ”¾ï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´ï¼š<code>SET key value EX 3 NX</code>ï¼Œéœ€ä¿è¯è®¾ç½®å€¼å’Œè®¾ç½®è¿‡æœŸæ—¶é—´æ˜¯åŸå­æ“ä½œ</p></li><li><p>é”ç»­æœŸï¼šçœ‹é—¨ç‹—æœºåˆ¶ã€‚Redissionä¸­çš„å®ç°</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> CompletionStage&lt;Boolean&gt; <span class="title function_">renewExpirationAsync</span><span class="params">(<span class="type">long</span> threadId)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> evalWriteAsync(getRawName(), LongCodec.INSTANCE, RedisCommands.EVAL_BOOLEAN,</span><br><span class="line">            <span class="comment">// åˆ¤æ–­æ˜¯å¦ä¸ºæŒé”çº¿ç¨‹ï¼Œå¦‚æœæ˜¯å°±æ‰§è¡Œç»­æœŸæ“ä½œï¼Œå°±é”çš„è¿‡æœŸæ—¶é—´è®¾ç½®ä¸º 30sï¼ˆé»˜è®¤ï¼‰</span></span><br><span class="line">            <span class="string">&quot;if (redis.call(&#x27;hexists&#x27;, KEYS[1], ARGV[2]) == 1) then &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;redis.call(&#x27;pexpire&#x27;, KEYS[1], ARGV[1]); &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;return 1; &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;end; &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;return 0;&quot;</span>,</span><br><span class="line">            Collections.singletonList(getRawName()),</span><br><span class="line">            internalLockLeaseTime, getLockName(threadId));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¦‚ä½•è§£å†³é›†ç¾¤ä¸­åˆ†å¸ƒå¼é”çš„å¯é æ€§ï¼Ÿ</li></ul></blockquote></li><li><p>Redis å¯ä»¥åšæ¶ˆæ¯é˜Ÿåˆ—ä¹ˆï¼Ÿ</p></li><li><p>Redis å¯ä»¥åšæœç´¢å¼•æ“ä¹ˆï¼Ÿ</p></li></ol><h4 id="Redis-æ•°æ®ç»“æ„"><a href="#Redis-æ•°æ®ç»“æ„" class="headerlink" title="Redis æ•°æ®ç»“æ„"></a><strong>Redis æ•°æ®ç»“æ„</strong></h4><ol><li>Redis æœ‰å“ªäº›æ•°æ®ç»“æ„ï¼Ÿ</li><li>String çš„åº•å±‚å®ç°æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆå®ç°äº† SDSï¼Ÿ</li><li>ğŸ˜–Redis ä¸ºä»€ä¹ˆç”¨è·³è¡¨ï¼Œè€Œä¸ç”¨å¹³è¡¡æ ‘ã€çº¢é»‘æ ‘æˆ–è€… B+æ ‘ï¼Ÿ</li><li>ğŸ˜–Redis ä¸ºä»€ä¹ˆä½¿ç”¨ ListPack æ›¿ä»£ ZipList?</li><li>Zset çš„åº”ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿé¡¹ç›®å“ªé‡Œç”¨åˆ°äº†ï¼Ÿ</li></ol><h4 id="Redis-æŒä¹…åŒ–æœºåˆ¶ï¼ˆé‡è¦ï¼‰"><a href="#Redis-æŒä¹…åŒ–æœºåˆ¶ï¼ˆé‡è¦ï¼‰" class="headerlink" title="Redis æŒä¹…åŒ–æœºåˆ¶ï¼ˆé‡è¦ï¼‰"></a><strong>Redis æŒä¹…åŒ–æœºåˆ¶ï¼ˆé‡è¦ï¼‰</strong></h4><ol><li>å®•æœºäº†ï¼ŒRedis å¦‚ä½•é¿å…æ•°æ®ä¸¢å¤±ï¼Ÿ</li><li>å¦‚ä½•é€‰æ‹© RDB å’Œ AOFï¼Ÿ</li></ol><h4 id="Redis-çº¿ç¨‹æ¨¡å‹ï¼ˆé‡è¦ï¼‰"><a href="#Redis-çº¿ç¨‹æ¨¡å‹ï¼ˆé‡è¦ï¼‰" class="headerlink" title="Redis çº¿ç¨‹æ¨¡å‹ï¼ˆé‡è¦ï¼‰"></a><strong>Redis çº¿ç¨‹æ¨¡å‹ï¼ˆé‡è¦ï¼‰</strong></h4><ol><li>Redis æ˜¯å•çº¿ç¨‹ï¼Œé‚£æ€ä¹ˆç›‘å¬å¤§é‡çš„å®¢æˆ·ç«¯è¿æ¥å‘¢ï¼Ÿ</li><li>Redis6.0 ä¹‹å‰ä¸ºä»€ä¹ˆä¸ä½¿ç”¨å¤šçº¿ç¨‹ï¼Ÿ</li><li>Redis6.0 ä¹‹åä¸ºä½•å¼•å…¥äº†å¤šçº¿ç¨‹ï¼Ÿ</li></ol><h4 id="Redis-å†…å­˜ç®¡ç†"><a href="#Redis-å†…å­˜ç®¡ç†" class="headerlink" title="Redis å†…å­˜ç®¡ç†"></a><strong>Redis å†…å­˜ç®¡ç†</strong></h4><ol><li>Redis ç»™ç¼“å­˜æ•°æ®è®¾ç½®è¿‡æœŸæ—¶é—´æœ‰å•¥ç”¨ï¼Ÿ Redis æ˜¯å¦‚ä½•åˆ¤æ–­æ•°æ®æ˜¯å¦è¿‡æœŸçš„å‘¢ï¼Ÿè¿‡æœŸæ•°æ®æ˜¯å¦‚ä½•è¢«åˆ é™¤çš„ï¼Ÿ</li><li>Redis å†…å­˜æ»¡äº†æ€ä¹ˆåŠï¼Ÿ</li><li>Redis å†…å­˜æ·˜æ±°ç®—æ³•é™¤äº† LRU è¿˜æœ‰å“ªäº›ï¼Ÿ</li></ol><h4 id="Redis-äº‹åŠ¡"><a href="#Redis-äº‹åŠ¡" class="headerlink" title="Redis äº‹åŠ¡"></a><strong>Redis äº‹åŠ¡</strong></h4><ol><li>Redis äº‹åŠ¡æ”¯æŒåŸå­æ€§å—ï¼Ÿ</li><li>Redis äº‹åŠ¡æ”¯æŒæŒä¹…æ€§å—ï¼Ÿ</li><li>Redis äº‹åŠ¡æœ‰ä»€ä¹ˆç¼ºé™·ï¼Ÿå¦‚ä½•è§£å†³ï¼Ÿ</li></ol><h4 id="Redis-æ€§èƒ½ä¼˜åŒ–ï¼ˆé‡è¦ï¼‰"><a href="#Redis-æ€§èƒ½ä¼˜åŒ–ï¼ˆé‡è¦ï¼‰" class="headerlink" title="Redis æ€§èƒ½ä¼˜åŒ–ï¼ˆé‡è¦ï¼‰"></a><strong>Redis æ€§èƒ½ä¼˜åŒ–ï¼ˆé‡è¦ï¼‰</strong></h4><ol><li>Redis æ‰¹é‡æ“ä½œçš„æ–¹å¼æœ‰å“ªäº›ï¼Ÿ</li><li>Redis å¤§ key æœ‰ä»€ä¹ˆå±å®³ï¼Ÿå¦‚ä½•æ’æŸ¥å’Œå¤„ç†ï¼Ÿ</li><li>å¦‚ä½•å‘ç° Redis çƒ­ Keyï¼Œæœ‰å“ªäº›è§£å†³æ–¹æ¡ˆï¼Ÿ</li><li>ä¸ºä»€ä¹ˆä¼šæœ‰ Redis å†…å­˜ç¢ç‰‡?å¦‚ä½•æ¸…ç† Redis å†…å­˜ç¢ç‰‡ï¼Ÿ</li><li>ä¸ºä»€ä¹ˆä¼šæœ‰æ…¢æŸ¥è¯¢å‘½ä»¤ï¼Ÿä¸ºä»€ä¹ˆä¼šæœ‰æ…¢æŸ¥è¯¢å‘½ä»¤ï¼Ÿ</li></ol><h4 id="Redis-ç”Ÿäº§é—®é¢˜ï¼ˆé‡è¦ï¼‰"><a href="#Redis-ç”Ÿäº§é—®é¢˜ï¼ˆé‡è¦ï¼‰" class="headerlink" title="Redis ç”Ÿäº§é—®é¢˜ï¼ˆé‡è¦ï¼‰"></a><strong>Redis ç”Ÿäº§é—®é¢˜ï¼ˆé‡è¦ï¼‰</strong></h4><ol><li>ä»€ä¹ˆæƒ…å†µä¼šå‡ºç°ç¼“å­˜ç©¿é€ï¼Ÿæœ‰å“ªäº›è§£å†³åŠæ³•ï¼Ÿ</li><li>ä»€ä¹ˆæƒ…å†µä¼šå‡ºç°ç¼“å­˜å‡»ç©¿ï¼Ÿæœ‰å“ªäº›è§£å†³åŠæ³•ï¼Ÿ</li><li>ä»€ä¹ˆæƒ…å†µä¼šå‡ºç°ç¼“å­˜é›ªå´©ï¼Ÿæœ‰å“ªäº›è§£å†³åŠæ³•ï¼Ÿ</li><li>ç¼“å­˜ç©¿é€å’Œç¼“å­˜å‡»ç©¿æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿç¼“å­˜é›ªå´©å’Œç¼“å­˜å‡»ç©¿æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</li><li>ç¼“å­˜é¢„çƒ­å¦‚ä½•å®ç°ï¼Ÿ</li></ol><h4 id="Redis-é›†ç¾¤"><a href="#Redis-é›†ç¾¤" class="headerlink" title="Redis é›†ç¾¤"></a><strong>Redis é›†ç¾¤</strong></h4><ol><li>ä»€ä¹ˆæ˜¯ Sentinelï¼Ÿ æœ‰ä»€ä¹ˆç”¨ï¼Ÿ</li><li>Sentinel å¦‚ä½•æ£€æµ‹èŠ‚ç‚¹æ˜¯å¦ä¸‹çº¿ï¼Ÿä¸»è§‚ä¸‹çº¿ä¸å®¢è§‚ä¸‹çº¿çš„åŒºåˆ«?</li><li>Sentinel æ˜¯å¦‚ä½•å®ç°æ•…éšœè½¬ç§»çš„ï¼Ÿ</li><li>Sentinel å¦‚ä½•é€‰æ‹©å‡ºæ–°çš„ masterï¼ˆé€‰ä¸¾æœºåˆ¶ï¼‰?</li><li>å¦‚ä½•ä» Sentinel é›†ç¾¤ä¸­é€‰æ‹©å‡º Leader ï¼Ÿ</li><li>Sentinel å¯ä»¥é˜²æ­¢è„‘è£‚å—ï¼Ÿ</li><li>ä¸ºä»€ä¹ˆéœ€è¦ Redis Clusterï¼Ÿè§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿæœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ</li><li>Redis Cluster æ˜¯å¦‚ä½•åˆ†ç‰‡çš„ï¼Ÿ</li><li>ä¸ºä»€ä¹ˆ Redis Cluster çš„å“ˆå¸Œæ§½æ˜¯ 16384 ä¸ª?</li><li>å¦‚ä½•ç¡®å®šç»™å®š key çš„åº”è¯¥åˆ†å¸ƒåˆ°å“ªä¸ªå“ˆå¸Œæ§½ä¸­ï¼Ÿ</li><li>Redis Cluster æ”¯æŒé‡æ–°åˆ†é…å“ˆå¸Œæ§½å—ï¼Ÿ</li><li>Redis Cluster æ‰©å®¹ç¼©å®¹æœŸé—´å¯ä»¥æä¾›æœåŠ¡å—ï¼Ÿ</li><li>Redis Cluster ä¸­çš„èŠ‚ç‚¹æ˜¯æ€ä¹ˆè¿›è¡Œé€šä¿¡çš„ï¼Ÿ</li></ol><h4 id="å‚è€ƒç­”æ¡ˆ-1"><a href="#å‚è€ƒç­”æ¡ˆ-1" class="headerlink" title="å‚è€ƒç­”æ¡ˆ"></a><strong>å‚è€ƒç­”æ¡ˆ</strong></h4><ol><li><a href="https://javaguide.cn/database/redis/redis-questions-01.html">Redis å¸¸è§é¢è¯•é¢˜æ€»ç»“</a></li><li><a href="https://javaguide.cn/database/redis/cache-basics.html">ç¼“å­˜åŸºç¡€å¸¸è§é¢è¯•é¢˜æ€»ç»“</a></li><li><a href="https://mp.weixin.qq.com/s/vyOpCmD92KS8g5LY6L3sjA">æœ¬åœ°ç¼“å­˜å’Œåˆ†å¸ƒå¼ç¼“å­˜æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿå¦‚ä½•é€‰æ‹©ï¼Ÿ</a></li><li><a href="https://javaguide.cn/database/redis/3-commonly-used-cache-read-and-write-strategies.html">3 ç§å¸¸ç”¨çš„ç¼“å­˜è¯»å†™ç­–ç•¥è¯¦è§£</a></li><li><a href="https://mp.weixin.qq.com/s/c4KjLtZYBVNDTmrjyizVZA">Redis ä¸ºä»€ä¹ˆç”¨è·³è¡¨ï¼Œè€Œä¸ç”¨å¹³è¡¡æ ‘ï¼Ÿ</a></li><li><a href="https://time.geekbang.org/column/article/405387">06 | ä» ziplist åˆ° quicklistï¼Œå†åˆ° listpack çš„å¯å‘ - ã€ŠRedis æºç å‰–æä¸å®æˆ˜ã€‹</a></li><li><a href="https://javaguide.cn/database/redis/redis-persistence.html">Redis æŒä¹…åŒ–æœºåˆ¶è¯¦è§£</a></li><li><a href="https://javaguide.cn/database/redis/redis-cluster.html">Redis é›†ç¾¤è¯¦è§£</a></li></ol><h3 id="ES"><a href="#ES" class="headerlink" title="ES"></a><strong>ES</strong></h3><ol><li>é¡¹ç›®ä¸­ç”¨ ES åšäº†ä»€ä¹ˆï¼ŸES å¯ä»¥å¸®åŠ©æˆ‘ä»¬åšä»€ä¹ˆï¼Ÿ</li><li>Lucene æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨ Luceneï¼Ÿ</li><li>ä¸ºä»€ä¹ˆç”¨ ES ä¸ç”¨ MySQLï¼Ÿï¼ˆä¸¤è€…åº”ç”¨åœºæ™¯ä¸åŒï¼‰</li><li>ä¸ºä»€ä¹ˆç”¨ ES ä¸ç”¨ Hbaseï¼Ÿ(ä¸¤è€…åº”ç”¨åœºæ™¯ä¸åŒ)</li><li>ä¸ºä»€ä¹ˆ ES æ£€ç´¢æ¯”è¾ƒå¿«ï¼Ÿå€’æ’ç´¢å¼•å’Œæ­£æ’ç´¢å¼•æ˜¯ä»€ä¹ˆï¼Ÿå€’æ’ç´¢å¼•ç”±ä»€ä¹ˆç»„æˆï¼Ÿä¸¤è€…åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>åˆ†è¯å™¨ä»€ä¹ˆç”¨ï¼Ÿé¡¹ç›®ç”¨çš„æ˜¯ä»€ä¹ˆåˆ†è¯å™¨ï¼Ÿå¦‚æœæˆ‘ä»¬è¦åŸºäºæ‹¼éŸ³æœç´¢åº”è¯¥å¦‚ä½•åšï¼Ÿ</li><li>é¡¹ç›®ä¸­ ES å’Œ MySQL çš„æ•°æ®æ˜¯å¦‚ä½•è¿›è¡ŒåŒæ­¥çš„ï¼Ÿ</li><li>ES é›†ç¾¤ä¸­çš„æ•°æ®æ˜¯å¦‚ä½•è¢«åˆ†é…çš„ï¼ˆåˆ†ç‰‡ï¼‰ï¼Ÿè‡ªå®šä¹‰è·¯ç”±æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ</li></ol><p>å‚è€ƒç­”æ¡ˆï¼š<a href="https://javaguide.cn/database/elasticsearch/elasticsearch-questions-01.html">Elasticsearch å¸¸è§é¢è¯•é¢˜æ€»ç»“</a></p><h2 id="ç½‘ç»œ"><a href="#ç½‘ç»œ" class="headerlink" title="ç½‘ç»œ"></a><strong>ç½‘ç»œ</strong></h2><h3 id="ç½‘ç»œåˆ†å±‚"><a href="#ç½‘ç»œåˆ†å±‚" class="headerlink" title="ç½‘ç»œåˆ†å±‚"></a><strong>ç½‘ç»œåˆ†å±‚</strong></h3><ol><li>OSI ä¸ TCP&#x2F;IP å„å±‚çš„ç»“æ„ä¸åŠŸèƒ½ã€‚</li><li>ä¸ºä»€ä¹ˆç½‘ç»œè¦åˆ†å±‚ï¼Ÿ</li><li>OSI ä¸ TCP&#x2F;IP å„å±‚éƒ½æœ‰å“ªäº›åè®®?</li></ol><h3 id="TCP-ä¸-UDPï¼ˆé‡è¦ï¼‰"><a href="#TCP-ä¸-UDPï¼ˆé‡è¦ï¼‰" class="headerlink" title="TCP ä¸ UDPï¼ˆé‡è¦ï¼‰"></a><strong>TCP ä¸ UDPï¼ˆé‡è¦ï¼‰</strong></h3><ol><li>TCP çš„ä¸‰æ¬¡æ¡æ‰‹ä¸å››æ¬¡æŒ¥æ‰‹çš„å†…å®¹ï¼Ÿ TCP ä¸ºä»€ä¹ˆè¿æ¥æ˜¯ä¸‰æ¬¡æ¡æ‰‹è€Œæ–­å¼€æ˜¯å››æ¬¡æ¡æ‰‹ï¼Ÿ</li><li>TCP ä¸ UDP çš„åŒºåˆ«åŠä½¿ç”¨åœºæ™¯ï¼Ÿ</li><li>ä¸ºä»€ä¹ˆ DNS åè®®ä½¿ç”¨ UDPï¼Ÿåªä½¿ç”¨äº† UDP å—ï¼Ÿ</li><li>TCP æ˜¯å¦‚ä½•ä¿è¯ä¼ è¾“çš„å¯é æ€§ï¼Ÿï¼ˆé‡Œé¢æ¶‰åŠåˆ°çš„çŸ¥è¯†ç‚¹éå¸¸å¤šï¼Œæ¯ä¸ªéƒ½èƒ½æŒ–æ˜ä¸å°‘é—®é¢˜ï¼Œä¾‹å¦‚é‡ä¼ æœºåˆ¶ã€æµé‡æ§åˆ¶ã€æ‹¥å¡æ§åˆ¶ã€‚å¦‚æœç›®æ ‡æ˜¯å¤§å‚çš„è¯ï¼Œä¸€å®šè¦åƒé€ï¼Œé¢è¯•ç»å¸¸ä¼šé—®çš„ï¼‰</li><li>ä½¿ç”¨ TCP çš„åè®®æœ‰å“ªäº›?ä½¿ç”¨ UDP çš„åè®®æœ‰å“ªäº›?HTTP åŸºäº TCP è¿˜æ˜¯ UDPï¼Ÿ</li></ol><h3 id="HTTPï¼ˆé‡è¦ï¼‰"><a href="#HTTPï¼ˆé‡è¦ï¼‰" class="headerlink" title="HTTPï¼ˆé‡è¦ï¼‰"></a><strong>HTTPï¼ˆé‡è¦ï¼‰</strong></h3><ol><li>HTTP çŠ¶æ€ç æœ‰å“ªäº›ï¼Ÿ</li><li>ä¸€æ¬¡å®Œæ•´çš„ HTTP è¯·æ±‚æ‰€ç»çš„æ­¥éª¤</li><li>HTTP åè®®äº†è§£ä¹ˆï¼ŸHTTP æ˜¯åŸºäº TCP è¿˜æ˜¯ UDP çš„ï¼Ÿ</li><li>HTTP æŠ¥æ–‡çš„å†…å®¹ç®€å•è¯´ä¸€ä¸‹ï¼ HTTP è¯·æ±‚æŠ¥æ–‡å’Œå“åº”æŠ¥æ–‡ä¸­æœ‰å“ªäº›æ•°æ®ï¼Ÿ</li><li>HTTP å’Œ HTTPS çš„åŒºåˆ«äº†è§£ä¹ˆï¼Ÿ</li><li>ğŸ˜–HTTPS çš„å®‰å…¨æ€§ä½“ç°åœ¨ä»€ä¹ˆæ–¹é¢ï¼Ÿï¼ˆæœ¬è´¨è¿˜æ˜¯åœ¨é—® HTTPS åŸç†ï¼‰</li><li>ğŸ˜–HTTPS åŠ å¯†è¿‡ç¨‹æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ</li><li>HTTP&#x2F;1.0 å’Œ HTTP&#x2F;1.1 æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</li><li>HTTP&#x2F;1.1 å’Œ HTTP&#x2F;2.0 æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</li><li>HTTP&#x2F;2.0 å’Œ HTTP&#x2F;3.0 æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</li><li>HTTP è¯·æ±‚æœ‰å“ªäº›å¸¸è§çš„çŠ¶æ€ç ï¼Ÿ</li><li>HTTP é•¿è¿æ¥å’ŒçŸ­è¿æ¥äº†è§£ä¹ˆï¼Ÿ</li><li>Cookie å’Œ Session çš„å…³ç³»</li><li>URI å’Œ URL çš„åŒºåˆ«æ˜¯ä»€ä¹ˆ?</li><li>GET å’Œ POST çš„åŒºåˆ«ï¼Ÿ</li></ol><h3 id="WebSocket"><a href="#WebSocket" class="headerlink" title="WebSocket"></a><strong>WebSocket</strong></h3><ol><li>ä»€ä¹ˆæ˜¯ WebSocket?ä¸€èˆ¬ç”¨æ¥åšä»€ä¹ˆï¼Ÿ</li><li>WebSocket å’Œ HTTP æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</li><li>WebSocket çš„å·¥ä½œè¿‡ç¨‹æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ</li><li>SSE ä¸ WebSocket è¯¥å¦‚ä½•é€‰æ‹©ï¼Ÿï¼ˆSSE ä¸ WebSocket ä½œç”¨ç›¸ä¼¼ï¼Œéƒ½å¯ä»¥å»ºç«‹æœåŠ¡ç«¯ä¸æµè§ˆå™¨ä¹‹é—´çš„é€šä¿¡ï¼Œå®ç°æœåŠ¡ç«¯å‘å®¢æˆ·ç«¯æ¨é€æ¶ˆæ¯ï¼Œå…·ä½“åŒºåˆ«å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š<a href="https://javaguide.cn/system-design/web-real-time-message-push.html">Web å®æ—¶æ¶ˆæ¯æ¨é€è¯¦è§£</a>ï¼‰</li></ol><h3 id="PING"><a href="#PING" class="headerlink" title="PING"></a><strong>PING</strong></h3><ol><li>PING å‘½ä»¤çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>ğŸ˜–PING å‘½ä»¤çš„å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</li></ol><h3 id="DNSï¼ˆé‡è¦ï¼‰"><a href="#DNSï¼ˆé‡è¦ï¼‰" class="headerlink" title="DNSï¼ˆé‡è¦ï¼‰"></a><strong>DNSï¼ˆé‡è¦ï¼‰</strong></h3><ol><li>DNS æ˜¯ä»€ä¹ˆï¼Ÿè§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ</li><li>DNS èƒ½è§£æç«¯å£å—ï¼Ÿ</li><li>DNS æœåŠ¡å™¨æœ‰å“ªäº›ï¼Ÿ</li><li>ğŸ˜–DNS è§£æçš„è¿‡ç¨‹æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ</li><li>ğŸ˜–DNS åŠ«æŒäº†è§£å—ï¼Ÿå¦‚ä½•åº”å¯¹ï¼Ÿ</li></ol><h3 id="IP"><a href="#IP" class="headerlink" title="IP"></a><strong>IP</strong></h3><ol><li>IP åè®®çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>ä»€ä¹ˆæ˜¯ IP åœ°å€ï¼ŸIP å¯»å€å¦‚ä½•å·¥ä½œï¼Ÿ</li><li>IPv4 å’Œ IPv6 æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</li></ol><h3 id="å‚è€ƒç­”æ¡ˆ-2"><a href="#å‚è€ƒç­”æ¡ˆ-2" class="headerlink" title="å‚è€ƒç­”æ¡ˆ"></a><strong>å‚è€ƒç­”æ¡ˆ</strong></h3><ol><li><a href="https://javaguide.cn/cs-basics/network/other-network-questions.html">è®¡ç®—æœºç½‘ç»œå¸¸è§é¢è¯•é¢˜æ€»ç»“</a></li><li><a href="https://zhuanlan.zhihu.com/p/101702312">è¯¦è§£ TCP è¶…æ—¶ä¸é‡ä¼ æœºåˆ¶</a></li><li><a href="https://cloud.tencent.com/developer/article/1818152">ä¸ºä»€ä¹ˆ DNS åè®®ä½¿ç”¨ UDPï¼Ÿåªä½¿ç”¨äº† UDP å—ï¼Ÿ</a></li><li><a href="https://cloud.tencent.com/developer/article/1197474">é»‘å®¢æŠ€æœ¯ï¼Ÿæ²¡ä½ æƒ³è±¡çš„é‚£ä¹ˆéš¾ï¼â€”â€”DNS åŠ«æŒç¯‡</a></li></ol><h2 id="æ“ä½œç³»ç»Ÿ"><a href="#æ“ä½œç³»ç»Ÿ" class="headerlink" title="æ“ä½œç³»ç»Ÿ"></a><strong>æ“ä½œç³»ç»Ÿ</strong></h2><h3 id="è¿›ç¨‹å’Œçº¿ç¨‹"><a href="#è¿›ç¨‹å’Œçº¿ç¨‹" class="headerlink" title="è¿›ç¨‹å’Œçº¿ç¨‹"></a><strong>è¿›ç¨‹å’Œçº¿ç¨‹</strong></h3><ol><li>è¿›ç¨‹å’Œçº¿ç¨‹çš„åŒºåˆ«</li><li>è¿›ç¨‹æœ‰å“ªå‡ ç§çŠ¶æ€?</li><li>è¿›ç¨‹é—´çš„é€šä¿¡æ–¹å¼</li><li>çº¿ç¨‹é—´çš„åŒæ­¥çš„æ–¹å¼</li><li>PCB</li><li>è¿›ç¨‹çš„è°ƒåº¦ç®—æ³•</li></ol><h3 id="æ­»é”"><a href="#æ­»é”" class="headerlink" title="æ­»é”"></a><strong>æ­»é”</strong></h3><ol><li>ä»€ä¹ˆæ˜¯æ­»é”ï¼Ÿ</li><li>èƒ½åˆ—ä¸¾ä¸€ä¸ªæ“ä½œç³»ç»Ÿå‘ç”Ÿæ­»é”çš„ä¾‹å­å—ï¼Ÿ</li><li>æ­»é”çš„å››ä¸ªå¿…è¦æ¡ä»¶ï¼Œè§£å†³æ­»é”çš„æ–¹æ³•</li></ol><h3 id="å†…å­˜ç®¡ç†"><a href="#å†…å­˜ç®¡ç†" class="headerlink" title="å†…å­˜ç®¡ç†"></a><strong>å†…å­˜ç®¡ç†</strong></h3><ol><li>å¸¸è§çš„å†…å­˜ç®¡ç†æœºåˆ¶</li><li>å†…å­˜ç¢ç‰‡</li><li>åˆ†æ®µæœºåˆ¶å’Œåˆ†é¡µæœºåˆ¶çš„åŒºåˆ«å’Œå…±åŒç‚¹</li><li>åˆ†æ®µæœºåˆ¶å’Œåˆ†é¡µæœºåˆ¶ä¸‹çš„åœ°å€ç¿»è¯‘è¿‡ç¨‹åˆ†åˆ«æ˜¯æ€æ ·çš„</li><li>å•çº§é¡µè¡¨æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿä¸ºä»€ä¹ˆéœ€è¦å¤šçº§é¡µè¡¨ï¼Ÿ</li><li>TLB æœ‰ä»€ä¹ˆç”¨ï¼Ÿä½¿ç”¨ TLB ä¹‹åçš„åœ°å€ç¿»è¯‘æµç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ</li><li>é¡µç¼ºå¤±ï¼Œå¸¸è§çš„é¡µé¢ç½®æ¢ç®—æ³•æœ‰å“ªäº›?</li></ol><h3 id="æ–‡ä»¶ç³»ç»Ÿ"><a href="#æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="æ–‡ä»¶ç³»ç»Ÿ"></a><strong>æ–‡ä»¶ç³»ç»Ÿ</strong></h3><ol><li>ç¡¬é“¾æ¥å’Œè½¯é“¾æ¥æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</li><li>ç¡¬é“¾æ¥ä¸ºä»€ä¹ˆä¸èƒ½è·¨æ–‡ä»¶ç³»ç»Ÿï¼Ÿ</li><li>æé«˜æ–‡ä»¶ç³»ç»Ÿæ€§èƒ½çš„æ–¹å¼æœ‰å“ªäº›ï¼Ÿ</li><li>å¸¸è§çš„ç£ç›˜è°ƒåº¦ç®—æ³•æœ‰å“ªäº›ï¼Ÿ</li></ol><h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a><strong>Linux</strong></h3><p>æŒæ¡ Linux çš„ä¸€äº›é‡è¦æ¦‚å¿µä»¥åŠå¸¸è§å‘½ä»¤å³å¯ã€‚</p><h3 id="å‚è€ƒç­”æ¡ˆ-3"><a href="#å‚è€ƒç­”æ¡ˆ-3" class="headerlink" title="å‚è€ƒç­”æ¡ˆ"></a><strong>å‚è€ƒç­”æ¡ˆ</strong></h3><ol><li><a href="https://javaguide.cn/cs-basics/operating-system/operating-system-basic-questions-01.html">æ“ä½œç³»ç»Ÿå¸¸è§é¢è¯•é¢˜æ€»ç»“</a></li><li><a href="https://javaguide.cn/cs-basics/operating-system/linux-intro.html">Linux åŸºç¡€çŸ¥è¯†æ€»ç»“</a></li></ol><h2 id="ç®—æ³•å’Œæ•°æ®ç»“æ„"><a href="#ç®—æ³•å’Œæ•°æ®ç»“æ„" class="headerlink" title="ç®—æ³•å’Œæ•°æ®ç»“æ„"></a><strong>ç®—æ³•å’Œæ•°æ®ç»“æ„</strong></h2><h3 id="ç®—æ³•"><a href="#ç®—æ³•" class="headerlink" title="ç®—æ³•"></a><strong>ç®—æ³•</strong></h3><ol><li>å†™å‡ºä¸‰ç§å•ä¾‹æ¨¡å¼çš„å®ç°ï¼Ÿä½ æ¨èå“ªä¸€ç§ï¼Ÿ</li><li>LRU ç®—æ³•äº†è§£å—ï¼Ÿä½ èƒ½å®ç°ä¸€ä¸ªå—ï¼Ÿ</li><li>å†™æ’åºç®—æ³•ï¼ˆå¿«æ’ã€å †æ’ï¼‰</li><li>ä½¿ç”¨æ•°ç»„å®ç°ä¸€ä¸ªæ ˆ</li><li>ä½¿ç”¨æ•°ç»„å®ç°ä¸€ä¸ªé˜Ÿåˆ—</li><li>å®ç°ä¸€ä¸ªé“¾è¡¨ã€åè½¬é“¾è¡¨</li><li>åŠ æƒè½®è¯¢ç®—æ³•å®ç°</li><li>å®ç°ä¸€ä¸ªæ­»é”</li><li>ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…å®ç°</li><li>â€¦â€¦</li></ol><p>å‚è€ƒç­”æ¡ˆï¼š<a href="https://mp.weixin.qq.com/s/lznqhe5PFzPFzk38HISDQw">åç«¯é«˜é¢‘ç¬”è¯•é¢˜ï¼ˆéå¸¸è§„ Leetcode ç±»å‹ï¼‰æ€»ç»“</a></p><p>ç®—æ³•åˆ·é¢˜èµ„æºæ¨èï¼š</p><ol><li><a href="https://javaguide.cn/cs-basics/algorithms/classical-algorithm-problems-recommendations.html">ç»å…¸ç®—æ³•æ€æƒ³æ€»ç»“ï¼ˆå« LeetCode é¢˜ç›®æ¨èï¼‰</a></li><li><a href="https://javaguide.cn/cs-basics/algorithms/common-data-structures-leetcode-recommendations.html#%E5%9B%BE">å¸¸è§æ•°æ®ç»“æ„ç»å…¸ LeetCode é¢˜ç›®æ¨è</a></li><li><a href="https://t.zsxq.com/112NOhdQ5">æœ‰å“ªäº›ç®—æ³•é¢˜å€¼å¾—ä¸€åˆ·ï¼Ÿ</a>ï¼ˆ<a href="https://javaguide.cn/about-the-author/zhishixingqiu-two-years.html">JavaGuide å®˜æ–¹çŸ¥è¯†æ˜Ÿçƒ</a>ä¸“å±ï¼‰</li></ol><h3 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a><strong>æ•°æ®ç»“æ„</strong></h3><ol><li>æ•°ç»„ vs é“¾è¡¨</li><li>æ ˆçš„åº”ç”¨åœºæ™¯</li><li>é˜Ÿåˆ—çš„åˆ†ç±»ã€åº”ç”¨åœºæ™¯</li><li>çº¢é»‘æ ‘çš„ç‰¹ç‚¹ã€çº¢é»‘æ ‘ vs äºŒå‰æŸ¥æ‰¾æ ‘</li><li>å“ˆå¸Œè¡¨åº”ç”¨åœºæ™¯</li><li>å¸ƒéš†è¿‡æ»¤å™¨åº”ç”¨åœºæ™¯</li><li>â€¦â€¦</li></ol><p>å‚è€ƒç­”æ¡ˆï¼š</p><ol><li><a href="https://javaguide.cn/cs-basics/data-structure/graph.html">ä¸€æ–‡ææ‡‚æ•°ç»„ã€é“¾è¡¨ã€æ ˆå’Œé˜Ÿåˆ—</a></li><li><a href="https://javaguide.cn/cs-basics/data-structure/graph.html">ä¸€æ–‡ææ‡‚å›¾</a></li><li><a href="https://javaguide.cn/cs-basics/data-structure/heap.html">ä¸€æ–‡ææ‡‚å †</a></li><li><a href="https://javaguide.cn/cs-basics/data-structure/tree.html">ä¸€æ–‡ææ‡‚æ ‘</a></li><li><a href="https://javaguide.cn/cs-basics/data-structure/red-black-tree.html">ä¸€æ–‡ææ‡‚çº¢é»‘æ ‘</a></li><li><a href="https://javaguide.cn/cs-basics/data-structure/bloom-filter.html">ä¸€æ–‡ææ‡‚å¸ƒéš†è¿‡æ»¤å™¨</a></li></ol><h2 id="ç³»ç»Ÿè®¾è®¡"><a href="#ç³»ç»Ÿè®¾è®¡" class="headerlink" title="ç³»ç»Ÿè®¾è®¡"></a><strong>ç³»ç»Ÿè®¾è®¡</strong></h2><h3 id="è®¾è®¡æ¨¡å¼"><a href="#è®¾è®¡æ¨¡å¼" class="headerlink" title="è®¾è®¡æ¨¡å¼"></a><strong>è®¾è®¡æ¨¡å¼</strong></h3><ol><li>ä½•ä¸ºè®¾è®¡æ¨¡å¼ï¼Ÿæœ‰å“ªäº›å¸¸è§çš„è®¾è®¡æ¨¡å¼ï¼Ÿ</li><li>å•ä¾‹æ¨¡å¼äº†è§£ä¹ˆï¼Ÿè¯´ä¸€ä¸‹å•ä¾‹æ¨¡å¼çš„ä½¿ç”¨åœºæ™¯ã€‚æ‰‹å†™ä¸€ä¸ªå•ä¾‹æ¨¡å¼çš„å®ç°ã€‚</li><li>è§‚å¯Ÿè€…æ¨¡å¼äº†è§£ä¹ˆï¼Ÿè¯´ä¸€ä¸‹è§‚å¯Ÿè€…æ¨¡å¼çš„ä½¿ç”¨åœºæ™¯ã€‚</li><li>å·¥å‚æ¨¡å¼äº†è§£ä¹ˆï¼Ÿè¯´ä¸€ä¸‹å·¥å‚æ¨¡å¼çš„ä½¿ç”¨åœºæ™¯ã€‚</li><li>è´£ä»»é“¾æ¨¡å¼äº†è§£ä¹ˆï¼Ÿå“ªäº›å¼€æºé¡¹ç›®ï¼ˆNettyã€MyBatis â€¦ï¼‰ä¸­ç”¨åˆ°äº†è´£ä»»é“¾æ¨¡å¼ï¼Ÿæ€ä¹ˆç”¨çš„ï¼Ÿ</li><li>SOLID åŸåˆ™äº†è§£ä¹ˆï¼Ÿç®€å•è°ˆè°ˆè‡ªå·±å¯¹äºå•ä¸€èŒè´£åŸåˆ™å’Œå¼€é—­åŸåˆ™çš„ç†è§£ã€‚</li><li>é˜…è¯» Spring æºç çš„æ—¶å€™ä»€ä¹ˆè®¾è®¡æ¨¡å¼æœ€è®©ä½ å½±å“æ·±åˆ»ï¼Ÿèƒ½ç®€å•è®²è®²å—ï¼Ÿ</li></ol><p>å‚è€ƒç­”æ¡ˆï¼š<a href="https://javaguide.cn/system-design/design-pattern.html">è®¾è®¡æ¨¡å¼å¸¸è§é¢è¯•é¢˜æ€»ç»“</a></p><h3 id="å¸¸è§æ¡†æ¶"><a href="#å¸¸è§æ¡†æ¶" class="headerlink" title="å¸¸è§æ¡†æ¶"></a><strong>å¸¸è§æ¡†æ¶</strong></h3><h4 id="Spring"><a href="#Spring" class="headerlink" title="Spring"></a><strong>Spring</strong></h4><ol><li>ä»€ä¹ˆæ˜¯ Spring æ¡†æ¶?</li><li>åˆ—ä¸¾ä¸€äº›é‡è¦çš„ Spring æ¨¡å—ï¼Ÿ</li><li>è°ˆè°ˆè‡ªå·±å¯¹äº Spring IoC å’Œ AOP çš„ç†è§£</li><li>Spring Bean çš„ç”Ÿå‘½å‘¨æœŸè¯´ä¸€ä¸‹</li><li>Spring ä¸­çš„ bean çš„ä½œç”¨åŸŸæœ‰å“ªäº›?</li><li>æ‹¦æˆªå™¨å’Œè¿‡æ»¤å™¨äº†è§£ä¹ˆï¼Ÿ</li><li>Spring åŠ¨æ€ä»£ç†é»˜è®¤ç”¨å“ªä¸€ç§</li><li>hibernate å’Œ mybatis åŒºåˆ«</li><li>Spring Boot å’Œ Spring çš„åŒºåˆ«</li><li>è¯´å‡ºä½¿ç”¨ Spring Boot çš„ä¸»è¦ä¼˜ç‚¹</li><li>ä»€ä¹ˆæ˜¯ Spring Boot Starter?</li><li>ä»‹ç»ä¸€ä¸‹@SpringBootApplication æ³¨è§£</li><li>Spring Boot çš„è‡ªåŠ¨é…ç½®æ˜¯å¦‚ä½•å®ç°çš„?</li><li>Spring Boot æ”¯æŒå“ªäº›åµŒå…¥å¼ web å®¹å™¨ï¼Ÿ</li></ol><p>å‚è€ƒç­”æ¡ˆï¼š<a href="https://javaguide.cn/system-design/framework/spring/spring-knowledge-and-questions-summary.html">Spring å¸¸è§é¢è¯•é¢˜æ€»ç»“</a></p><h4 id="Netty"><a href="#Netty" class="headerlink" title="Netty"></a><strong>Netty</strong></h4><p>é¢è¯•ä¸­é—®çš„ä¸å¤šï¼Œå¦‚æœæ—¶é—´ä¸å¤Ÿçš„è¯ï¼Œå¯ä»¥ç›´æ¥è·³è¿‡ã€‚ä¸è¿‡ï¼Œå¦‚æœä½ çš„é¡¹ç›®ä¸­ç”¨åˆ°çš„è¯ï¼Œä¸ªäººå»ºè®®è¿˜æ˜¯è®¤çœŸå‡†å¤‡ä¸€ä¸‹ã€‚</p><ol><li>BIO,NIO å’Œ AIO æœ‰å•¥åŒºåˆ«ï¼Ÿ</li><li>Netty æ˜¯ä»€ä¹ˆï¼Ÿä¸ºå•¥ä¸ç›´æ¥ç”¨ NIO å‘¢?</li><li>ä¸ºä»€ä¹ˆè¦ç”¨ Nettyï¼ŸNetty åº”ç”¨åœºæ™¯äº†è§£ä¹ˆï¼Ÿ</li><li>ä»‹ç»ä¸€ä¸‹ Netty çš„æ ¸å¿ƒç»„ä»¶ï¼Ÿ</li><li>Bootstrap å’Œ ServerBootstrap äº†è§£ä¹ˆï¼Ÿ</li><li>NioEventLoopGroup é»˜è®¤çš„æ„é€ å‡½æ•°ä¼šèµ·å¤šå°‘çº¿ç¨‹ï¼Ÿ</li><li>Netty çº¿ç¨‹æ¨¡å‹äº†è§£ä¹ˆï¼Ÿ</li><li>ä»€ä¹ˆæ˜¯ TCP ç²˜åŒ…&#x2F;æ‹†åŒ…?æœ‰ä»€ä¹ˆè§£å†³åŠæ³•å‘¢ï¼Ÿ</li><li>Netty é•¿è¿æ¥ã€å¿ƒè·³æœºåˆ¶äº†è§£ä¹ˆï¼Ÿ</li></ol><p>å‚è€ƒç­”æ¡ˆï¼š<a href="https://javaguide.cn/system-design/framework/netty.html">Netty å¸¸è§é¢è¯•é¢˜æ€»ç»“</a></p><h3 id="æƒé™è®¤è¯"><a href="#æƒé™è®¤è¯" class="headerlink" title="æƒé™è®¤è¯"></a><strong>æƒé™è®¤è¯</strong></h3><ol><li>è®¤è¯ (Authentication) å’Œæˆæƒ (Authorization)çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>ä»€ä¹ˆæ˜¯ Cookie ? Cookie çš„ä½œç”¨æ˜¯ä»€ä¹ˆ?å¦‚ä½•åœ¨æœåŠ¡ç«¯ä½¿ç”¨ Cookie ?</li><li>Cookie å’Œ Session æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿå¦‚ä½•ä½¿ç”¨ Session è¿›è¡Œèº«ä»½éªŒè¯ï¼Ÿ</li><li>å¦‚æœæ²¡æœ‰ Cookie çš„è¯ Session è¿˜èƒ½ç”¨å—ï¼Ÿ</li><li>ä¸ºä»€ä¹ˆ Cookie æ— æ³•é˜²æ­¢ CSRF æ”»å‡»ï¼Œè€Œ token å¯ä»¥ï¼Ÿ</li><li>ä»€ä¹ˆæ˜¯ Token?ä»€ä¹ˆæ˜¯ JWT?å¦‚ä½•åŸºäº Token è¿›è¡Œèº«ä»½éªŒè¯ï¼Ÿ</li><li>ä»€ä¹ˆæ˜¯ OAuth 2.0ï¼Ÿ</li><li>ä»€ä¹ˆæ˜¯ SSO(å•ç‚¹ç™»å½•)ï¼ŸSSO æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ</li><li>RBAC æƒé™æ¨¡å‹äº†è§£å—ï¼Ÿå’Œ ABAC æƒé™æ¨¡å‹æœ‰ä½•åŒºåˆ«ï¼Ÿå¦‚ä½•é€‰æ‹©ï¼Ÿ</li></ol><p>å‚è€ƒç­”æ¡ˆï¼š</p><ol><li><a href="https://javaguide.cn/system-design/security/basis-of-authority-certification.html">è®¤è¯æˆæƒåŸºç¡€æ¦‚å¿µè¯¦è§£</a></li><li><a href="https://javaguide.cn/system-design/security/jwt-intro.html">JWT åŸºç¡€æ¦‚å¿µè¯¦è§£</a></li><li><a href="https://javaguide.cn/system-design/security/advantages&disadvantages-of-jwt.html">JWT èº«ä»½è®¤è¯ä¼˜ç¼ºç‚¹åˆ†æ</a></li><li><a href="https://javaguide.cn/system-design/security/design-of-authority-system.html">æƒé™ç³»ç»Ÿè®¾è®¡è¯¦è§£</a></li></ol><h2 id="åˆ†å¸ƒå¼"><a href="#åˆ†å¸ƒå¼" class="headerlink" title="åˆ†å¸ƒå¼"></a><strong>åˆ†å¸ƒå¼</strong></h2><h3 id="åˆ†å¸ƒå¼ç†è®º"><a href="#åˆ†å¸ƒå¼ç†è®º" class="headerlink" title="åˆ†å¸ƒå¼ç†è®º"></a><strong>åˆ†å¸ƒå¼ç†è®º</strong></h3><p>è¿™éƒ¨åˆ†å†…å®¹å±äºæ˜¯åŠ åˆ†é¡¹ï¼Œä¸€èˆ¬é¢è¯•ä¸ä¼šé—®çš„å¤ªéš¾ã€‚</p><ol><li><a href="https://javaguide.cn/distributed-system/theorem&algorithm&protocol/cap&base-theorem.html">CAP &amp; BASE ç†è®ºè¯¦è§£</a></li><li><a href="https://javaguide.cn/distributed-system/theorem&algorithm&protocol/paxos-algorithm.html">Paxos ç®—æ³•è¯¦è§£</a></li><li><a href="https://javaguide.cn/distributed-system/theorem&algorithm&protocol/raft-algorithm.html">Raft ç®—æ³•è¯¦è§£</a></li><li><a href="https://javaguide.cn/distributed-system/protocol/gossip-protocl.html">Gossip åè®®è¯¦è§£</a></li></ol><h3 id="RPC"><a href="#RPC" class="headerlink" title="RPC"></a><strong>RPC</strong></h3><p><strong>RPC åŸºç¡€ï¼š</strong></p><ol><li>äº†è§£ RPC å—ï¼Ÿæœ‰å“ªäº›å¸¸è§çš„ RPC æ¡†æ¶ï¼Ÿ</li><li>å¦‚æœè®©ä½ è‡ªå·±è®¾è®¡ RPC æ¡†æ¶ä½ ä¼šå¦‚ä½•è®¾è®¡ï¼Ÿ</li><li>æœåŠ¡ä¹‹é—´çš„è°ƒç”¨ä¸ºå•¥ä¸ç›´æ¥ç”¨ HTTP è€Œç”¨ RPCï¼Ÿ</li></ol><p>å‚è€ƒç­”æ¡ˆï¼š<a href="https://javaguide.cn/distributed-system/rpc/rpc-intro.html">RPC åŸºç¡€å¸¸è§é¢è¯•é¢˜æ€»ç»“</a></p><p><strong>Dubbo:</strong></p><ol><li>Dubbo äº†è§£å—ï¼Ÿ</li><li>Dubbo çš„å·¥ä½œåŸç†äº†è§£ä¹ˆï¼Ÿæ³¨å†Œä¸­å¿ƒæ‰®æ¼”äº†ä»€ä¹ˆè§’è‰²ï¼Ÿæ³¨å†Œä¸­å¿ƒæŒ‚äº†å¯ä»¥ç»§ç»­é€šä¿¡å—ï¼Ÿ</li><li>Dubbo çš„è´Ÿè½½å‡è¡¡ç­–ç•¥äº†è§£ä¹ˆï¼Ÿ</li><li>Dubbo çš„ SPI æœºåˆ¶äº†è§£ä¹ˆï¼Ÿå¸¦æ¥äº†å•¥å¥½å¤„ï¼Ÿ</li></ol><p>å‚è€ƒç­”æ¡ˆï¼š<a href="https://javaguide.cn/distributed-system/rpc/dubbo.html">Dubbo å¸¸è§é¢è¯•é¢˜æ€»ç»“</a></p><h3 id="åˆ†å¸ƒå¼-ID"><a href="#åˆ†å¸ƒå¼-ID" class="headerlink" title="åˆ†å¸ƒå¼ ID"></a><strong>åˆ†å¸ƒå¼ ID</strong></h3><ol><li>ä½•ä¸º IDï¼Ÿ</li><li>ä½•ä¸ºåˆ†å¸ƒå¼ IDï¼Ÿ</li><li>ä¸€ä¸ªåˆæ ¼çš„åˆ†å¸ƒå¼ ID éœ€è¦æ»¡è¶³ä»€ä¹ˆè¦æ±‚?</li><li>åˆ†å¸ƒå¼ ID å¸¸è§çš„ç”Ÿæˆæ–¹æ³•æœ‰å“ªäº›ï¼Ÿï¼ˆæ•°æ®åº“ä¸»é”®è‡ªå¢ã€æ•°æ®åº“çš„å·æ®µæ¨¡å¼ã€UUIDã€SNOWFLAKE ç­‰ç­‰ï¼‰</li><li>å¦‚ä½•è®¾è®¡åˆ†å¸ƒå¼ IDï¼Ÿï¼ˆä¼šç»“åˆå…·ä½“çš„åœºæ™¯è®©ä½ å›ç­”è‡ªå·±çš„æ€è€ƒä¾‹å¦‚è®¢å•å·ï¼‰</li></ol><p>å‚è€ƒç­”æ¡ˆï¼š</p><ol><li><a href="https://javaguide.cn/distributed-system/distributed-id.html">åˆ†å¸ƒå¼ ID å¸¸è§é¢è¯•é¢˜æ€»ç»“</a></li><li><a href="https://javaguide.cn/distributed-system/distributed-id-design.html">åˆ†å¸ƒå¼ ID è®¾è®¡æŒ‡å—</a></li></ol><h3 id="API-ç½‘å…³"><a href="#API-ç½‘å…³" class="headerlink" title="API ç½‘å…³"></a><strong>API ç½‘å…³</strong></h3><ol><li>ä»€ä¹ˆæ˜¯ç½‘å…³ï¼Ÿ</li><li>ç½‘å…³èƒ½æä¾›å“ªäº›åŠŸèƒ½ï¼Ÿ</li><li>æœ‰å“ªäº›å¸¸è§çš„ç½‘å…³ç³»ç»Ÿï¼Ÿå¦‚ä½•é€‰æ‹©ï¼Ÿ</li></ol><p>å‚è€ƒç­”æ¡ˆï¼š</p><ol><li><a href="https://javaguide.cn/distributed-system/api-gateway.html">API ç½‘å…³åŸºç¡€çŸ¥è¯†æ€»ç»“</a></li><li><a href="https://javaguide.cn/distributed-system/spring-cloud-gateway-questions.html">Spring Cloud Gateway å¸¸è§é—®é¢˜æ€»ç»“</a></li></ol><h3 id="åˆ†å¸ƒå¼é”"><a href="#åˆ†å¸ƒå¼é”" class="headerlink" title="åˆ†å¸ƒå¼é”"></a><strong>åˆ†å¸ƒå¼é”</strong></h3><p>åˆ†å¸ƒå¼é”åŸºç¡€ï¼š</p><ol><li>ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”ï¼Ÿ</li><li>åˆ†å¸ƒå¼é”åº”è¯¥å…·å¤‡å“ªäº›æ¡ä»¶ï¼Ÿ</li></ol><p>åŸºäº Redis å®ç°åˆ†å¸ƒå¼é”ï¼š</p><ol><li>å¦‚ä½•åŸºäº Redis å®ç°ä¸€ä¸ªæœ€ç®€æ˜“çš„åˆ†å¸ƒå¼é”ï¼Ÿ</li><li>ä¸ºä»€ä¹ˆè¦ç»™é”è®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´ï¼Ÿ</li><li>å¦‚ä½•å®ç°é”çš„ä¼˜é›…ç»­æœŸï¼Ÿ</li><li>å¦‚ä½•å®ç°å¯é‡å…¥é”ï¼Ÿ</li><li>Redis å¦‚ä½•è§£å†³é›†ç¾¤æƒ…å†µä¸‹åˆ†å¸ƒå¼é”çš„å¯é æ€§ï¼Ÿ</li></ol><p>åŸºäº ZooKeeper å®ç°åˆ†å¸ƒå¼é”ï¼š</p><ol><li>å¦‚ä½•åŸºäº ZooKeeper å®ç°åˆ†å¸ƒå¼é”ï¼Ÿ</li><li>ä¸ºä»€ä¹ˆè¦ç”¨ä¸´æ—¶é¡ºåºèŠ‚ç‚¹ï¼Ÿ</li><li>ä¸ºä»€ä¹ˆè¦è®¾ç½®å¯¹å‰ä¸€ä¸ªèŠ‚ç‚¹çš„ç›‘å¬ï¼Ÿ</li><li>å¦‚ä½•å®ç°å¯é‡å…¥é”ï¼Ÿ</li></ol><p>å‚è€ƒç­”æ¡ˆï¼š</p><ol><li><a href="https://javaguide.cn/distributed-system/distributed-lock.html">åˆ†å¸ƒå¼é”ä»‹ç»</a></li><li><a href="https://javaguide.cn/distributed-system/distributed-lock-implementations.html">åˆ†å¸ƒå¼é”å¸¸è§å®ç°æ–¹æ¡ˆæ€»ç»“</a></li></ol><h2 id="é«˜å¹¶å‘"><a href="#é«˜å¹¶å‘" class="headerlink" title="é«˜å¹¶å‘"></a><strong>é«˜å¹¶å‘</strong></h2><h3 id="æ¶ˆæ¯é˜Ÿåˆ—"><a href="#æ¶ˆæ¯é˜Ÿåˆ—" class="headerlink" title="æ¶ˆæ¯é˜Ÿåˆ—"></a><strong>æ¶ˆæ¯é˜Ÿåˆ—</strong></h3><p>é¢è¯•ä¸­ä¼šç»“åˆä½ é¡¹ç›®ä½¿ç”¨çš„æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œæé—®ï¼Œè®°å¾—é’ˆå¯¹æ€§å‡†å¤‡å³å¯ã€‚</p><p>é€šç”¨ï¼ˆä¸ç®¡æ˜¯ç”¨çš„å“ªä¸€ç§æ¶ˆæ¯é˜Ÿåˆ—éƒ½å¯èƒ½ä¼šé—®åˆ°ï¼‰ï¼š</p><ol><li>ä¸ºä»€ä¹ˆè¦ç”¨æ¶ˆæ¯é˜Ÿåˆ—?</li><li>æœ‰å“ªäº›å¸¸è§çš„æ¶ˆæ¯é˜Ÿåˆ—?å¦‚ä½•é€‰æ‹©ï¼Ÿ</li><li>ğŸ˜– å¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸è¢«é‡å¤æ¶ˆè´¹?</li><li>ğŸ˜– å¦‚ä½•ä¿è¯æ¶ˆæ¯æ¶ˆè´¹çš„é¡ºåºæ€§?</li><li>ğŸ˜– å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„æ¶ˆè´¹é¡ºåºï¼Ÿ</li><li>ğŸ˜– å¦‚ä½•è§£å†³æ¶ˆæ¯å †ç§¯é—®é¢˜ï¼Ÿ</li></ol><p>RocketMQï¼š</p><ol><li>RocketMQ ä¸­çš„æ¶ˆæ¯æ¨¡å‹æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>RocketMQ å¦‚ä½•å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ï¼Ÿ</li><li>RocketMQ å»¶æ—¶æ¶ˆæ¯ç”¨è¿‡å—ï¼Ÿ</li><li>RocketMQ é‡è¯•æœºåˆ¶ï¼Ÿ</li><li>ğŸ˜–RocketMQ åˆ·ç›˜æœºåˆ¶ï¼Ÿ</li><li>ğŸ˜–RocketMQ å¦‚ä½•ä¿è¯é«˜å¯ç”¨ï¼Ÿ</li><li>ğŸ˜–RocketMQ å¦‚ä½•ä¿è¯é«˜æ€§èƒ½è¯»å†™ï¼Ÿ</li></ol><p>Kafkaï¼š</p><ol><li>Kafka ä¸­çš„æ¶ˆæ¯æ¨¡å‹æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>Kafka çš„å¤šå‰¯æœ¬æœºåˆ¶äº†è§£å—ï¼Ÿå¸¦æ¥äº†ä»€ä¹ˆå¥½å¤„ï¼Ÿ</li><li>Zookeeper åœ¨ Kafka ä¸­çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿä½¿ç”¨ Kafka èƒ½å¦ä¸å¼•å…¥ Zookeeper?</li><li>Kafka é‡è¯•æœºåˆ¶ï¼Ÿ</li><li>ğŸ˜–Kafka åˆ·ç›˜æœºåˆ¶ï¼Ÿ</li><li>ğŸ˜–Kafka å¦‚ä½•ä¿è¯é«˜å¯ç”¨ï¼Ÿ</li><li>ğŸ˜–Kafka å¦‚ä½•ä¿è¯é«˜æ€§èƒ½è¯»å†™ï¼Ÿ</li></ol><p>å‚è€ƒç­”æ¡ˆï¼š</p><ol><li><a href="https://javaguide.cn/high-performance/message-queue/message-queue.html">æ¶ˆæ¯é˜Ÿåˆ—åŸºç¡€çŸ¥è¯†æ€»ç»“</a></li><li><a href="https://javaguide.cn/high-performance/message-queue/disruptor-questions.html">Disruptor å¸¸è§çŸ¥è¯†ç‚¹&amp;é¢è¯•é¢˜æ€»ç»“</a></li><li><a href="https://javaguide.cn/high-performance/message-queue/rabbitmq-questions.html">RabbitMQ å¸¸è§çŸ¥è¯†ç‚¹&amp;é¢è¯•é¢˜æ€»ç»“</a></li><li><a href="https://javaguide.cn/high-performance/message-queue/rocketmq-questions.html">RocketMQ å¸¸è§çŸ¥è¯†ç‚¹&amp;é¢è¯•é¢˜æ€»ç»“</a></li><li><a href="https://javaguide.cn/high-performance/message-queue/kafka-questions-01.html">Kafka å¸¸å¸¸è§çŸ¥è¯†ç‚¹&amp;é¢è¯•é¢˜æ€»ç»“</a></li></ol><h3 id="CDNï¼ˆå†…å®¹åˆ†å‘ç½‘ç»œï¼‰"><a href="#CDNï¼ˆå†…å®¹åˆ†å‘ç½‘ç»œï¼‰" class="headerlink" title="CDNï¼ˆå†…å®¹åˆ†å‘ç½‘ç»œï¼‰"></a><strong>CDNï¼ˆå†…å®¹åˆ†å‘ç½‘ç»œï¼‰</strong></h3><ol><li>ä»€ä¹ˆæ˜¯ CDN ï¼Ÿ</li><li>ğŸ˜–CDN çš„å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</li></ol><p>å‚è€ƒç­”æ¡ˆï¼š<a href="https://javaguide.cn/high-performance/cdn.html">CDNï¼ˆå†…å®¹åˆ†å‘ç½‘ç»œï¼‰è¯¦è§£</a></p><h3 id="è¯»å†™åˆ†ç¦»å’Œåˆ†åº“åˆ†è¡¨"><a href="#è¯»å†™åˆ†ç¦»å’Œåˆ†åº“åˆ†è¡¨" class="headerlink" title="è¯»å†™åˆ†ç¦»å’Œåˆ†åº“åˆ†è¡¨"></a><strong>è¯»å†™åˆ†ç¦»å’Œåˆ†åº“åˆ†è¡¨</strong></h3><ol><li>ä»€ä¹ˆæ˜¯è¯»å†™åˆ†ç¦»ï¼Ÿ</li><li>ä¸»åº“å’Œä»åº“çš„æ•°æ®å­˜åœ¨å»¶è¿Ÿçš„é—®é¢˜å¦‚ä½•è§£å†³ï¼Ÿ</li><li>å¦‚ä½•å®ç°è¯»å†™åˆ†ç¦»ï¼Ÿä¸»ä»å¤åˆ¶åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>ä»€ä¹ˆæ˜¯åˆ†åº“ï¼Ÿä»€ä¹ˆæ˜¯åˆ†è¡¨ï¼Ÿä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦åˆ†åº“åˆ†è¡¨ï¼Ÿ</li><li>å¸¸è§çš„åˆ†ç‰‡ç®—æ³•æœ‰å“ªäº›ï¼Ÿ</li><li>åˆ†åº“åˆ†è¡¨ä¼šå¸¦æ¥ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ</li><li>åˆ†åº“åˆ†è¡¨åï¼Œæ•°æ®æ€ä¹ˆè¿ç§»å‘¢ï¼Ÿ</li></ol><p>å‚è€ƒç­”æ¡ˆï¼š<a href="https://javaguide.cn/high-performance/read-and-write-separation-and-library-subtable.html">è¯»å†™åˆ†ç¦»å’Œåˆ†åº“åˆ†è¡¨è¯¦è§£</a></p><h2 id="ç³»ç»Ÿè®¾è®¡-åœºæ™¯é¢˜"><a href="#ç³»ç»Ÿè®¾è®¡-åœºæ™¯é¢˜" class="headerlink" title="ç³»ç»Ÿè®¾è®¡&#x2F;åœºæ™¯é¢˜"></a><strong>ç³»ç»Ÿè®¾è®¡&#x2F;åœºæ™¯é¢˜</strong></h2><ol><li>å‡å¦‚æœ‰ 10 äº¿ä¸ªæ•°ï¼Œåªæœ‰ä¸€ä¸ªé‡å¤ï¼Œå†…å­˜åªèƒ½æ”¾ä¸‹ 5 äº¿ä¸ªæ•°ï¼Œæ€ä¹ˆæ‰¾åˆ°è¿™ä¸ªé‡å¤çš„æ•°å­—ï¼Ÿ</li><li>å¦‚ä½•è®¾è®¡ä¸€ä¸ªç§’æ€ç³»ç»Ÿï¼Ÿ</li><li>æœ‰ä¸€ä¸ªæœåŠ¡å™¨ä¸“é—¨æ¥æ”¶å¤§é‡è¯·æ±‚ï¼Œæ€ä¹ˆè®¾è®¡ï¼Ÿ</li><li>å¦‚æœè®©ä½ è‡ªå·±è®¾è®¡ RPC æ¡†æ¶ä½ ä¼šå¦‚ä½•è®¾è®¡ï¼Ÿ</li><li>æ€ä¹ˆå¿«é€Ÿå‡ºç°ä¸€ä¸ª stackoverflow é”™è¯¯ï¼Ÿ</li><li>å¦‚ä½•è®¾è®¡ä¸€ä¸ªå¾®åš Feed æµ&#x2F;ä¿¡æ¯æµç³»ç»Ÿï¼Ÿ</li><li>å¦‚ä½•è®¾è®¡ä¸€ä¸ªçŸ­é“¾ç³»ç»Ÿï¼Ÿ</li><li>å¦‚ä½•å®ç°ç¬¬ä¸‰æ–¹æˆæƒç™»å½•ï¼Ÿ</li><li>è®¢å•è¶…æ—¶è‡ªåŠ¨å–æ¶ˆå¦‚ä½•å®ç°ï¼Ÿ</li><li>å¤šä½éª‘æ‰‹æŠ¢ä¸€ä¸ªå¤–å–è®¢å•ï¼Œå¦‚ä½•ä¿è¯åªæœ‰ä¸€ä¸ªéª‘æ‰‹å¯ä»¥æ¥åˆ°å•å­ï¼Ÿ</li><li>å¦‚ä½•å®ç° IP å½’å±åœ°åŠŸèƒ½ï¼Ÿ</li><li>å¤šæ¬¡è¾“é”™å¯†ç ä¹‹åå¦‚ä½•é™åˆ¶ç”¨æˆ·è§„å®šæ—¶é—´å†…ç¦æ­¢å†æ¬¡ç™»å½•ï¼Ÿ</li></ol><p>å‚è€ƒç­”æ¡ˆï¼š<a href="https://javaguide.cn/zhuanlan/back-end-interview-high-frequency-system-design-and-scenario-questions.html">ã€Šåç«¯é¢è¯•é«˜é¢‘ç³»ç»Ÿè®¾è®¡&amp;åœºæ™¯é¢˜ã€‹</a></p><h2 id="é¡¹ç›®ç»å†"><a href="#é¡¹ç›®ç»å†" class="headerlink" title="é¡¹ç›®ç»å†"></a><strong>é¡¹ç›®ç»å†</strong></h2><ol><li>è¯´è¯´ä½ çš„é¡¹ç›®ä¸­çš„äº®ç‚¹æœ‰å“ªäº›ï¼Ÿ</li><li>é¡¹ç›®ç”¨æˆ·äººæ•°æœ‰å¤šå°‘ï¼Ÿæœ€å¤§åœ¨çº¿äººæ•°å¤šå°‘ï¼Ÿ</li><li>ç”»ä¸€ä¸‹ä½ çš„é¡¹ç›®çš„æ¶æ„å›¾ã€‚</li><li>é¡¹ç›®ä¸­é‡åˆ°çš„å›°éš¾æœ‰å“ªäº›ï¼Ÿæ€ä¹ˆè§£å†³çš„ï¼Ÿ</li><li>xx æŸå—çš„æ•°æ®åº“è¡¨æ˜¯å¦‚ä½•è®¾è®¡çš„ï¼Ÿ</li></ol><h2 id="HR-é¢"><a href="#HR-é¢" class="headerlink" title="HR é¢"></a><strong>HR é¢</strong></h2><ol><li>ä¸ªäººä»‹ç»</li><li>å¹³æ—¶çš„å…´è¶£çˆ±å¥½</li><li>å¯¹æˆ‘ä»¬å…¬å¸çš„äº†è§£</li><li>ä¸‰ä¸ªè¯å½¢å®¹è‡ªå·±</li><li>èŒä¸šè§„åˆ’</li><li>å¹³æ—¶çš„å­¦ä¹ æ–¹å¼</li><li>å¤§å­¦é‡Œåšè¿‡æ¯”è¾ƒæœ‰æ„ä¹‰çš„äº‹æƒ…</li><li>æ‰‹é‡Œè¿˜æœ‰å“ªäº› offer</li><li>é€‰æ‹©å·¥ä½œçš„ç†ç”±æ’åºï¼ˆè–ªèµ„ã€åŠ ç­æƒ…å†µä¹‹ç±»çš„ï¼‰ã€‚</li></ol><p>å‚è€ƒç­”æ¡ˆï¼š<a href="https://t.zsxq.com/15OaOnmVR">15 é“ HR é¢çš„å¸¸è§é—®é¢˜ï¼ˆç¨‹åºå‘˜æ–¹å‘ï¼‰</a> ï¼ˆ <a href="https://javaguide.cn/about-the-author/zhishixingqiu-two-years.html">JavaGuide å®˜æ–¹çŸ¥è¯†æ˜Ÿçƒ</a>ä¸“å±ï¼‰</p><h2 id="ç»éªŒæ€»ç»“"><a href="#ç»éªŒæ€»ç»“" class="headerlink" title="ç»éªŒæ€»ç»“"></a><strong>ç»éªŒæ€»ç»“</strong></h2><ol><li>å°½æ—©å‡†å¤‡ï¼Œä¸è®ºæ˜¯æ‰¾å·¥ä½œå‰ã€é¢è¯•å‰è¿˜æ˜¯é¢è¯•åã€‚</li><li>ä¸€å®šè¦æå‰å‡†å¤‡é¢è¯•ï¼æŠ€æœ¯é¢è¯•ä¸åŒäºç¼–ç¨‹ï¼Œç¼–ç¨‹å‰å®³ä¸ä»£è¡¨æŠ€æœ¯é¢è¯•å°±ä¸€å®šèƒ½è¿‡ã€‚</li><li>å­¦å®Œäº†æŸä¸ªçŸ¥è¯†ç‚¹ä¹‹åï¼Œä½ å¯ä»¥å»çœ‹çœ‹å¯¹åº”çš„å…«è‚¡æ–‡å’ŒçŸ¥è¯†ç‚¹æ€»ç»“ã€‚å¤šçœ‹çœ‹ <a href="https://javaguide.cn/home.html">JavaGuide</a> å’Œ <a href="https://javaguide.cn/zhuanlan/java-mian-shi-zhi-bei.html">ã€ŠJava é¢è¯•æŒ‡åŒ—ã€‹</a>ï¼Œè¿™æ˜¯å…¨ç½‘è´¨é‡æœ€é«˜çš„åŸåˆ›é¢è¯•èµ„æ–™ã€‚</li><li>å¤šé¢è¯•ï¼Œä¸è¦å®³æ€•å¤±è´¥ï¼Œå¤šæ€»ç»“ç»éªŒã€‚</li><li>å¦‚æœæ˜¯æ±‚èŒç›®æ ‡æ˜¯å›½ä¼ã€å·®ä¸€ç‚¹çš„ä¸­å‚å’Œå°å‚çš„è¯ï¼Œè®¡ç®—æœºåŸºç¡€ç›¸å¯¹æ¥è¯´ä¸æ˜¯é‚£ä¹ˆé‡è¦ã€‚</li><li>å¦‚æœä½ çš„å­¦å†æ¯”è¾ƒä¸€èˆ¬çš„è¯ï¼Œæ ¼å¤–æ³¨æ„è¦æŠŠé‡å¿ƒæ”¾åœ¨è‡ªå·±çš„é¡¹ç›®ç»å†ä¸Šã€‚</li><li>ä¸€å®šè¦ç†Ÿæ‚‰è‡ªå·±çš„ç®€å†ï¼Œå°¤å…¶æ˜¯è‡ªå·±çš„é¡¹ç›®ç»å†ã€‚</li><li>ç”µè¯å’Œè§†é¢‘é¢è¯•å¾ˆå¹³å¸¸ï¼Œé¢è¯•å‰æå‰å‡†å¤‡ä¸€ä¸‹ã€‚</li><li>é¢è¯•ä¹‹ååŠæ—¶å¤ç›˜ã€‚é¢è¯•å°±åƒæ˜¯ä¸€åœºå…¨æ–°çš„å¾ç¨‹ï¼Œå¤±è´¥å’Œèƒœåˆ©éƒ½æ˜¯å¹³å¸¸ä¹‹äº‹ã€‚æ‰€ä»¥ï¼ŒåŠå„ä½ä¸è¦å› ä¸ºé¢è¯•å¤±è´¥è€Œç°å¿ƒã€ä¸§å¤±æ–—å¿—ã€‚ä¹Ÿä¸è¦å› ä¸ºé¢è¯•é€šè¿‡è€Œæ²¾æ²¾è‡ªå–œï¼Œç­‰å¾…ä½ çš„å°†æ˜¯æ›´ç¾å¥½çš„æœªæ¥ï¼Œç»§ç»­åŠ æ²¹ï¼</li></ol><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>å‘½ä»¤é€ŸæŸ¥è¡¨</title>
      <link href="/post/1aa6cbcd.html"/>
      <url>/post/1aa6cbcd.html</url>
      
        <content type="html"><![CDATA[<h1 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h1><h1 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h1><ul><li>æŸ¥çœ‹äº‹åŠ¡çº§åˆ«</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 8.0ä¹‹å‰</span><br><span class="line">&gt; SELECT @@tx_isolation;</span><br><span class="line"># 8.0åŠä¹‹å</span><br><span class="line">&gt; SELECT @@transaction_isolation;</span><br></pre></td></tr></table></figure><ul><li>æŸ¥çœ‹MySQLæ”¯æŒçš„å¼•æ“ï¼š<code>show engines</code></li><li>æŸ¥çœ‹MySQLç‰ˆæœ¬ï¼š<code>select version()</code></li><li>æŸ¥çœ‹é¡µçš„å¤§å°ï¼š<code>select @@innodb_page_size</code>æˆ–<code>show variables like &#39;%innodb_page_size%&#39;</code></li></ul><h1 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h1><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>ç®—æ³•</title>
      <link href="/post/b7e144d1.html"/>
      <url>/post/b7e144d1.html</url>
      
        <content type="html"><![CDATA[<h2 id="æ’åº"><a href="#æ’åº" class="headerlink" title="æ’åº"></a>æ’åº</h2><h3 id="å †æ’åº"><a href="#å †æ’åº" class="headerlink" title="å †æ’åº"></a>å †æ’åº</h3><p>é¢˜ç›®æè¿°ï¼šæœ‰ä¸€ä¸ªå‡ ä¹æœ‰åºçš„æ•°ç»„ï¼Œæ„æ€æ˜¯æ¯ä¸ªå…ƒç´ æœ€å¤šåªéœ€è¦ç§»åŠ¨ä¸è¶…è¿‡kä¸ªä½ç½®å°±å¯ä»¥åˆ°è¾¾æ’åºåçš„ä½ç½®ï¼Œä¸”kè¿œå°äºæ•°ç»„å¤§å°ã€‚</p><p>è¦æ±‚ï¼šç”¨æœ€é«˜æ•ˆçš„ç®—æ³•æ’åºã€‚</p><p>è¦é«˜æ•ˆåœ°å¯¹å‡ ä¹æœ‰åºçš„æ•°ç»„ï¼ˆæ¯ä¸ªå…ƒç´ æœ€å¤šåªéœ€ç§»åŠ¨kä¸ªä½ç½®ï¼Œä¸”kè¿œå°äºæ•°ç»„å¤§å°ï¼‰è¿›è¡Œæ’åºï¼Œå¯ä»¥ä½¿ç”¨æœ€å°å †ï¼ˆä¼˜å…ˆé˜Ÿåˆ—ï¼‰ä¼˜åŒ–ç®—æ³•ã€‚æ ¸å¿ƒæ€è·¯æ˜¯åˆ©ç”¨æ•°ç»„çš„ç‰¹æ€§ï¼šæœ€å°å…ƒç´ ä¸€å®šä½äºå‰k+1ä¸ªå…ƒç´ å†…ã€‚é€šè¿‡ç»´æŠ¤å¤§å°ä¸ºk+1çš„æœ€å°å †ï¼Œæ¯æ¬¡å¼¹å‡ºæœ€å°å€¼å¹¶åŠ å…¥æ–°å…ƒç´ ï¼Œå®ç°O(n log k)çš„æ—¶é—´å¤æ‚åº¦ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AlmostSortedArraySorter</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sortAlmostSorted</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> k)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (arr == <span class="literal">null</span> || arr.length == <span class="number">0</span> || k &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> arr.length;</span><br><span class="line">        <span class="comment">// åˆ›å»ºæœ€å°å †ï¼Œå¤§å°ä¸ºk+1ï¼ˆé˜²æ­¢kè¿‡å¤§å¯¼è‡´å †è¿‡å¤§ï¼‰</span></span><br><span class="line">        PriorityQueue&lt;Integer&gt; minHeap = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(Math.min(k + <span class="number">1</span>, n));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åˆå§‹å¡«å……å †ï¼šå‰min(k+1, n)ä¸ªå…ƒç´ </span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; Math.min(k + <span class="number">1</span>, n); i++) &#123;</span><br><span class="line">            minHeap.offer(arr[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>; <span class="comment">// å½“å‰æ’åºä½ç½®</span></span><br><span class="line">        <span class="comment">// å¤„ç†å‰©ä½™å…ƒç´ ï¼šæ¯å¼¹å‡ºä¸€ä¸ªæœ€å°å€¼ï¼ŒåŠ å…¥ä¸€ä¸ªæ–°å…ƒç´ </span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> k + <span class="number">1</span>; i &lt; n; i++) &#123;</span><br><span class="line">            arr[index++] = minHeap.poll(); <span class="comment">// å¼¹å‡ºæœ€å°å€¼æ”¾å…¥æ•°ç»„</span></span><br><span class="line">            minHeap.offer(arr[i]);         <span class="comment">// åŠ å…¥æ–°å…ƒç´ </span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¤„ç†å †ä¸­å‰©ä½™å…ƒç´ </span></span><br><span class="line">        <span class="keyword">while</span> (!minHeap.isEmpty()) &#123;</span><br><span class="line">            arr[index++] = minHeap.poll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">int</span>[] arr = &#123;<span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">4</span>&#125;; <span class="comment">// k=2æ—¶å‡ ä¹æœ‰åº</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">    sortAlmostSorted(arr, k);</span><br><span class="line">    System.out.println(java.util.Arrays.toString(arr)); <span class="comment">// è¾“å‡º: [1, 2, 3, 4, 5, 6]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>è®¡ç®—æœºç½‘ç»œ</title>
      <link href="/post/e255a10a.html"/>
      <url>/post/e255a10a.html</url>
      
        <content type="html"><![CDATA[<ol><li>TCPä¸‰æ¬¡æ¡æ‰‹ä¸å››æ¬¡æŒ¥æ‰‹çš„çŠ¶æ€å˜è¿å›¾</li><li>TIME_WAITçŠ¶æ€è¿‡å¤šå¦‚ä½•ä¼˜åŒ–ï¼Ÿ</li><li>HTTPSåŒå‘è®¤è¯æµç¨‹ä¸ä¸­é—´äººæ”»å‡»é˜²èŒƒ</li><li>QUICåè®®å¦‚ä½•è§£å†³é˜Ÿå¤´é˜»å¡é—®é¢˜ï¼Ÿ</li><li>TCPæ‹¥å¡æ§åˆ¶ç®—æ³•ï¼ˆCUBIC&#x2F;BBRï¼‰</li><li>HTTP&#x2F;2å¤šè·¯å¤ç”¨ä¸é˜Ÿå¤´é˜»å¡è§£å†³æ–¹æ¡ˆ</li><li>Websocketæ¡æ‰‹åè®®ä¸å¿ƒè·³æœºåˆ¶å®ç°</li><li>DNSè§£æè¿‡ç¨‹ï¼ˆé€’å½’æŸ¥è¯¢ä¸è¿­ä»£æŸ¥è¯¢ï¼‰</li><li>CDNåŠ¨æ€åŠ é€Ÿä¸é™æ€åŠ é€ŸæŠ€æœ¯åŸç†</li><li>å¦‚ä½•è®¾è®¡ä¸€ä¸ªé«˜å¹¶å‘è¿æ¥çš„æœåŠ¡ç«¯ï¼Ÿ</li><li>é•¿è¿æ¥ä¿æ´»ç­–ç•¥ï¼ˆTCP Keepalive vs åº”ç”¨å±‚å¿ƒè·³ï¼‰</li><li>ç½‘ç»œæŠ“åŒ…åˆ†æå®æˆ˜ï¼ˆWiresharkè¿‡æ»¤æŠ€å·§ï¼‰</li><li>å•æœºç™¾ä¸‡è¿æ¥çš„å®ç°ä¸ä¼˜åŒ–</li><li>HTTP Rangeè¯·æ±‚ä¸æ–­ç‚¹ç»­ä¼ å®ç°</li><li>5å±‚åè®®æ ˆä¸­æ¯å±‚çš„å…¸å‹è®¾å¤‡</li><li>VLANä¸VXLANçš„åŒºåˆ«åŠä½¿ç”¨åœºæ™¯</li><li>å¦‚ä½•å®ç°UDPå¯é ä¼ è¾“ï¼Ÿ</li><li>MTUä¸MSSçš„å…³ç³»åŠåˆ†ç‰‡é—®é¢˜</li><li>SYN Floodæ”»å‡»åŸç†ä¸é˜²å¾¡æ–¹æ¡ˆ</li><li>TLS1.3ç›¸æ¯”1.2çš„æ ¸å¿ƒæ”¹è¿›ç‚¹</li></ol><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      <categories>
          
          <category> è®¡ç®—æœºç½‘ç»œ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>æ“ä½œç³»ç»Ÿ</title>
      <link href="/post/d04bd5bc.html"/>
      <url>/post/d04bd5bc.html</url>
      
        <content type="html"><![CDATA[<ol><li>ç”¨æˆ·æ€ä¸å†…æ ¸æ€åˆ‡æ¢çš„å¼€é”€æ¥æºï¼Ÿ</li><li>è¿›ç¨‹é—´é€šä¿¡IPCçš„5ç§æ–¹å¼å¯¹æ¯”</li><li>è™šæ‹Ÿå†…å­˜ä¸ç‰©ç†å†…å­˜æ˜ å°„åŸç†ï¼ˆé¡µè¡¨å¯»å€ï¼‰</li><li>æ­»é”çš„å¿…è¦æ¡ä»¶åŠé“¶è¡Œå®¶ç®—æ³•å®ç°</li><li>è‡ªæ—‹é”ä¸äº’æ–¥é”çš„ä½¿ç”¨åœºæ™¯å·®å¼‚</li><li>é›¶æ‹·è´æŠ€æœ¯å®ç°åŸç†ï¼ˆsendfile&#x2F;mmapï¼‰</li><li>å­¤å„¿è¿›ç¨‹ä¸åƒµå°¸è¿›ç¨‹çš„åŒºåˆ«åŠå¤„ç†</li><li>CPUè½¯ä¸­æ–­ä¸ç¡¬ä¸­æ–­å¤„ç†æœºåˆ¶</li><li>å¦‚ä½•ç”¨topå‘½ä»¤åˆ†æCPUè´Ÿè½½å¼‚å¸¸ï¼Ÿ</li><li>å†…å­˜æ³„æ¼ä¸å†…å­˜æº¢å‡ºçš„å®šä½æ–¹æ³•</li><li>å¤§é¡µå†…å­˜ï¼ˆHugePageï¼‰ä¼˜åŒ–åŸç†</li><li>åç¨‹ä¸çº¿ç¨‹çš„è°ƒåº¦æ•ˆç‡å·®å¼‚</li><li>æ–‡ä»¶æè¿°ç¬¦ï¼ˆfdï¼‰è€—å°½å¦‚ä½•å¤„ç†ï¼Ÿ</li><li>CPUç¼“å­˜è¡Œä¼ªå…±äº«é—®é¢˜è§£å†³æ–¹æ¡ˆ</li><li>NUMAæ¶æ„ä¸‹çš„æ€§èƒ½è°ƒä¼˜è¦ç‚¹</li><li>ç³»ç»Ÿè°ƒç”¨è¿‡ç¨‹è¯¦è§£ï¼ˆint 0x80&#x2F;syscallï¼‰</li><li>å®æ—¶æ“ä½œç³»ç»Ÿä¸éå®æ—¶ç³»ç»Ÿçš„è°ƒåº¦å·®å¼‚</li><li>å®¹å™¨ä¸è™šæ‹Ÿæœºçš„èµ„æºéš”ç¦»åŸç†å¯¹æ¯”</li><li>å¦‚ä½•å®ç°ä¸€ä¸ªç®€å•çš„çº¿ç¨‹æ± ï¼Ÿ</li><li>ç³»ç»Ÿå¹³å‡è´Ÿè½½ï¼ˆLoad Averageï¼‰çš„æ·±å±‚å«ä¹‰</li></ol><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      <categories>
          
          <category> æ“ä½œç³»ç»Ÿ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Dubbo</title>
      <link href="/post/f6253398.html"/>
      <url>/post/f6253398.html</url>
      
        <content type="html"><![CDATA[<h2 id="ä»€ä¹ˆæ˜¯SPIæœºåˆ¶"><a href="#ä»€ä¹ˆæ˜¯SPIæœºåˆ¶" class="headerlink" title="ä»€ä¹ˆæ˜¯SPIæœºåˆ¶"></a>ä»€ä¹ˆæ˜¯SPIæœºåˆ¶</h2><p><strong>SPI</strong> æ˜¯ Java æä¾›çš„ä¸€ç§<strong>æœåŠ¡å‘ç°æœºåˆ¶</strong>ï¼Œé€šè¿‡<strong>æ¥å£ä¸å®ç°è§£è€¦</strong>å®ç°åŠ¨æ€æ‰©å±•ã€‚æ ¸å¿ƒæµç¨‹å¦‚ä¸‹ï¼š</p><ol><li><strong>å®šä¹‰æœåŠ¡æ¥å£</strong>ï¼ˆå¦‚ <code>PaymentService</code>ï¼‰</li><li><strong>æä¾›å®ç°ç±»</strong>ï¼ˆå¦‚ <code>AlipayService</code>, <code>WechatPayService</code>ï¼‰</li><li><strong>æ³¨å†Œå®ç°</strong>ï¼šåœ¨ <code>META-INF/services/</code> ä¸‹åˆ›å»ºä»¥æ¥å£å…¨é™å®šåå‘½åçš„æ–‡ä»¶ï¼Œå†™å…¥å®ç°ç±»å…¨é™å®šå</li><li><strong>åŠ¨æ€åŠ è½½</strong>ï¼šé€šè¿‡ <code>ServiceLoader</code> åŠ è½½æ‰€æœ‰æ³¨å†Œçš„å®ç°</li></ol><p><strong>ä¼˜åŠ¿ï¼š</strong></p><ul><li><strong>å¼€é—­åŸåˆ™</strong>ï¼šæ–°å¢å®ç°æ— éœ€ä¿®æ”¹æ ¸å¿ƒä»£ç </li><li><strong>è§£è€¦</strong>ï¼šæ¥å£ä¸å®ç°åˆ†ç¦»</li><li><strong>å¯æ’æ‹”</strong>ï¼šé€šè¿‡é…ç½®æ–‡ä»¶åŠ¨æ€æ›¿æ¢å®ç°</li></ul><p><strong>Java SPI å®Œæ•´ Demo</strong></p><ol><li>å®šä¹‰æœåŠ¡æ¥å£</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PaymentService.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PaymentService</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">pay</span><span class="params">(<span class="type">double</span> amount)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>å®ç°æœåŠ¡æ¥å£</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AlipayService.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AlipayService</span> <span class="keyword">implements</span> <span class="title class_">PaymentService</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">pay</span><span class="params">(<span class="type">double</span> amount)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;[æ”¯ä»˜å®] æ”¯ä»˜: Â¥&quot;</span> + amount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// WechatPayService.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WechatPayService</span> <span class="keyword">implements</span> <span class="title class_">PaymentService</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">pay</span><span class="params">(<span class="type">double</span> amount)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;[å¾®ä¿¡æ”¯ä»˜] æ”¯ä»˜: Â¥&quot;</span> + amount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>æ³¨å†ŒæœåŠ¡å®ç°</li></ol><p>åˆ›å»ºèµ„æºæ–‡ä»¶ï¼š<br><code>src/main/resources/META-INF/services/com.example.PaymentService</code><br>å†…å®¹ï¼š</p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">com.example.AlipayService</span><br><span class="line">com.example.WechatPayService</span><br></pre></td></tr></table></figure><ol start="4"><li>ä½¿ç”¨ SPI åŠ è½½æœåŠ¡</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPIDemo.java</span></span><br><span class="line"><span class="keyword">import</span> java.util.ServiceLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SPIDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// åŠ è½½æ‰€æœ‰ PaymentService å®ç°</span></span><br><span class="line">        ServiceLoader&lt;PaymentService&gt; services = </span><br><span class="line">            ServiceLoader.load(PaymentService.class);</span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">&quot;=== å‘ç° &quot;</span> + getServiceCount(services) + <span class="string">&quot; ä¸ªæ”¯ä»˜æœåŠ¡ ===&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è°ƒç”¨æ‰€æœ‰å®ç°</span></span><br><span class="line">        <span class="keyword">for</span> (PaymentService service : services) &#123;</span><br><span class="line">            service.pay(<span class="number">100.0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getServiceCount</span><span class="params">(ServiceLoader&lt;PaymentService&gt; services)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (PaymentService ignored : services) &#123;</span><br><span class="line">            count++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="5"><li>é¡¹ç›®ç»“æ„</li></ol><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">src/</span><br><span class="line">â”œâ”€â”€ main/</span><br><span class="line">â”‚   â”œâ”€â”€ java/</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ com/example/</span><br><span class="line">â”‚   â”‚   â”‚   â”œâ”€â”€ PaymentService.java</span><br><span class="line">â”‚   â”‚   â”‚   â”œâ”€â”€ AlipayService.java</span><br><span class="line">â”‚   â”‚   â”‚   â”œâ”€â”€ WechatPayService.java</span><br><span class="line">â”‚   â”‚   â”‚   â””â”€â”€ SPIDemo.java</span><br><span class="line">â”‚   â”‚</span><br><span class="line">â”‚   â””â”€â”€ resources/</span><br><span class="line">â”‚       â””â”€â”€ META-INF/services/</span><br><span class="line">â”‚           â””â”€â”€ com.example.PaymentService  &lt;-- å…³é”®é…ç½®æ–‡ä»¶</span><br></pre></td></tr></table></figure><ol start="6"><li>è¿è¡Œç»“æœ</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">=== å‘ç° 2 ä¸ªæ”¯ä»˜æœåŠ¡ ===</span><br><span class="line">[æ”¯ä»˜å®] æ”¯ä»˜: Â¥100.0</span><br><span class="line">[å¾®ä¿¡æ”¯ä»˜] æ”¯ä»˜: Â¥100.0</span><br></pre></td></tr></table></figure><p><strong>å…³é”®ç‚¹è§£æï¼š</strong></p><ol><li><strong>é…ç½®æ–‡ä»¶è·¯å¾„</strong>ï¼š<code>META-INF/services/æ¥å£å…¨é™å®šå</code></li><li><strong>æ–‡ä»¶å†…å®¹</strong>ï¼šå®ç°ç±»çš„å…¨é™å®šåï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</li><li><strong>ServiceLoader</strong>ï¼šæ ¸å¿ƒåŠ è½½å·¥å…·ï¼Œå®ç°æ‡’åŠ è½½</li><li><strong>è¿­ä»£é¡ºåº</strong>ï¼šæŒ‰é…ç½®æ–‡ä»¶ä¸­å®šä¹‰çš„é¡ºåºåŠ è½½</li></ol><p><strong>å®é™…åº”ç”¨åœºæ™¯ï¼š</strong></p><ul><li>JDBC é©±åŠ¨åŠ è½½ï¼ˆ<code>DriverManager</code>ï¼‰</li><li>æ—¥å¿—é—¨é¢ï¼ˆSLF4Jï¼‰</li><li>åºåˆ—åŒ–æ¡†æ¶ï¼ˆJacksonï¼‰</li><li>Spring Boot è‡ªåŠ¨é…ç½®</li></ul><blockquote><p>é€šè¿‡ SPI æœºåˆ¶ï¼ŒJava å®ç°äº†çœŸæ­£çš„é¢å‘æ¥å£ç¼–ç¨‹ï¼Œä½¿ç³»ç»Ÿå…·å¤‡é«˜åº¦å¯æ‰©å±•æ€§ï¼Œç¬¦åˆã€Œå¼€é—­åŸåˆ™ã€ã€‚</p></blockquote><h2 id="Javaçš„SPIæœºåˆ¶æœ‰ä»€ä¹ˆé—®é¢˜"><a href="#Javaçš„SPIæœºåˆ¶æœ‰ä»€ä¹ˆé—®é¢˜" class="headerlink" title="Javaçš„SPIæœºåˆ¶æœ‰ä»€ä¹ˆé—®é¢˜"></a>Javaçš„SPIæœºåˆ¶æœ‰ä»€ä¹ˆé—®é¢˜</h2><ol><li><strong>æ•ˆç‡ä½ä¸‹ï¼ˆå…¨é‡åŠ è½½ï¼‰</strong>ï¼š<ul><li><code>ServiceLoader</code> åœ¨åŠ è½½ä¸€ä¸ªæ¥å£çš„å®ç°æ—¶ï¼Œä¼š<strong>éå†å¹¶å®ä¾‹åŒ–</strong> <code>META-INF/services/</code> ç›®å½•ä¸‹å¯¹åº”é…ç½®æ–‡ä»¶ä¸­çš„æ‰€æœ‰å®ç°ç±»ã€‚</li><li><strong>é—®é¢˜ï¼š</strong> å¦‚æœæŸä¸ªæ‰©å±•ç‚¹æœ‰å¾ˆå¤šå®ç°ï¼ˆæˆ–è€…æŸäº›å®ç°ç±»åˆå§‹åŒ–æˆæœ¬å¾ˆé«˜ï¼‰ï¼Œä½†å®é™…è¿è¡Œæ—¶åªéœ€è¦ç”¨åˆ°å…¶ä¸­ä¸€ä¸ªæˆ–å‡ ä¸ªï¼Œè¿™ç§å…¨é‡åŠ è½½ä¼šé€ æˆ<strong>ä¸å¿…è¦çš„èµ„æºæ¶ˆè€—ï¼ˆå†…å­˜ã€CPUï¼‰å’Œå¯åŠ¨å»¶è¿Ÿ</strong>ã€‚</li></ul></li><li><strong>ç¼ºä¹æŒ‰éœ€è·å–èƒ½åŠ›ï¼ˆä¸çµæ´»ï¼‰</strong>ï¼š<ul><li>Java SPI åªèƒ½è·å–æ‰€æœ‰å®ç°ï¼Œç„¶åç”±è°ƒç”¨è€…éå†æŸ¥æ‰¾éœ€è¦çš„é‚£ä¸ªã€‚æ²¡æœ‰å†…ç½®çš„æœºåˆ¶æ ¹æ®åç§°ã€å‚æ•°æˆ–å…¶ä»–æ¡ä»¶ç›´æ¥è·å–ç‰¹å®šçš„å®ç°å®ä¾‹ã€‚</li><li><strong>é—®é¢˜ï¼š</strong> ä½¿ç”¨èµ·æ¥ä¸å¤Ÿæ–¹ä¾¿å’Œç›´è§‚ï¼Œéœ€è¦é¢å¤–çš„ç­›é€‰é€»è¾‘ã€‚</li></ul></li><li><strong>ä¸æ”¯æŒä¾èµ–æ³¨å…¥</strong>ï¼š<ul><li>é€šè¿‡ SPI åŠ è½½çš„å®ç°ç±»å®ä¾‹ï¼Œå…¶æ„é€ å‡½æ•°æˆ–æˆå‘˜å˜é‡å¦‚æœä¾èµ–å…¶ä»–å¯¹è±¡ï¼Œéœ€è¦è°ƒç”¨è€…æ‰‹åŠ¨è®¾ç½®ã€‚</li><li><strong>é—®é¢˜ï¼š</strong> åœ¨å¤æ‚çš„æ¡†æ¶ä¸­ï¼Œæ‰©å±•ç‚¹å®ç°ç±»å¯èƒ½éœ€è¦ä¾èµ–æ¡†æ¶å†…éƒ¨çš„æ ¸å¿ƒç»„ä»¶ï¼ˆå¦‚é…ç½®ä¸­å¿ƒã€æ³¨å†Œä¸­å¿ƒã€åºåˆ—åŒ–å™¨ç­‰ï¼‰ï¼Œæ‰‹åŠ¨ç®¡ç†è¿™äº›ä¾èµ–éå¸¸ç¹çä¸”å®¹æ˜“å‡ºé”™ï¼Œç ´åäº†æ‰©å±•ç‚¹çš„å°è£…æ€§ã€‚</li></ul></li><li><strong>ä¸æ”¯æŒæ‰©å±•ç‚¹è‡ªé€‚åº”&#x2F;IoC&#x2F;AOP</strong>ï¼š<ul><li>Java SPI æ˜¯é™æ€çš„ï¼ŒåŠ è½½å“ªä¸ªå®ç°åœ¨é…ç½®æ–‡ä»¶ä¸­æ˜¯å†™æ­»çš„ã€‚å®ƒæ— æ³•æ ¹æ®è¿è¡Œæ—¶çš„å‚æ•°ï¼ˆå¦‚æ–¹æ³•å‚æ•°ã€URL å‚æ•°ã€é…ç½®é¡¹ï¼‰åŠ¨æ€é€‰æ‹©ä¸åŒçš„å®ç°ã€‚</li><li><strong>é—®é¢˜ï¼š</strong> ç¼ºä¹åŠ¨æ€æ€§ï¼Œéš¾ä»¥å®ç°æ›´é«˜çº§çš„åŠŸèƒ½å¦‚é€‚é…å™¨ã€åŒ…è£…å™¨ï¼ˆAOPï¼‰ã€æ¡ä»¶é€‰æ‹©ç­‰ã€‚</li></ul></li><li><strong>é…ç½®ä¸å‹å¥½ï¼ˆæ— åç§°æ ‡è¯†ï¼‰</strong>ï¼š<ul><li>é…ç½®æ–‡ä»¶é‡Œç›´æ¥å†™å®ç°ç±»çš„å…¨é™å®šåã€‚æ²¡æœ‰ä¸ºæ¯ä¸ªå®ç°å®šä¹‰ä¸€ä¸ªæ˜“äºç†è§£å’Œä½¿ç”¨çš„åç§°ï¼ˆKeyï¼‰ã€‚</li><li><strong>é—®é¢˜ï¼š</strong> é…ç½®å’Œå¼•ç”¨ä¸å¤Ÿç›´è§‚ï¼Œå®¹æ˜“å‡ºé”™ï¼Œä¸åˆ©äºé€šè¿‡é…ç½®ä¸­å¿ƒåŠ¨æ€ä¿®æ”¹ã€‚</li></ul></li><li><strong>ç¼ºä¹ç”Ÿå‘½å‘¨æœŸç®¡ç†</strong>ï¼š<ul><li>Java SPI æ²¡æœ‰æä¾›æ ‡å‡†çš„åˆå§‹åŒ–å’Œé”€æ¯å›è°ƒæœºåˆ¶ã€‚</li></ul></li></ol><h2 id="Dubbo-SPI"><a href="#Dubbo-SPI" class="headerlink" title="Dubbo SPI"></a>Dubbo SPI</h2><p>Dubbo è®¾è®¡äº†ä¸€å¥—åŠŸèƒ½æ›´å¼ºå¤§ã€æ›´çµæ´»çš„ SPI æœºåˆ¶ï¼ˆæ ¸å¿ƒåœ¨ <code>org.apache.dubbo.common.extension</code> åŒ…ï¼‰ï¼Œå®Œç¾è§£å†³äº†ä¸Šè¿°é—®é¢˜ï¼š</p><ol><li><strong>æŒ‰éœ€åŠ è½½ï¼ˆæ ¸å¿ƒæ”¹è¿›ï¼‰</strong>ï¼š<ul><li>Dubbo SPI ä¸ä¼šä¸€æ¬¡æ€§åŠ è½½å’Œå®ä¾‹åŒ–æ‰€æœ‰å®ç°ç±»ã€‚</li><li>å®ƒç»´æŠ¤äº†ä¸€ä¸ªæ˜ å°„å…³ç³»ï¼š<code>æ‰©å±•ç‚¹åç§° (Key) -&gt; å®ç°ç±»å…¨é™å®šå</code>ã€‚</li><li>åªæœ‰å½“é€šè¿‡åç§° (<code>key</code>) æ˜ç¡®è¯·æ±‚æŸä¸ªæ‰©å±•ç‚¹æ—¶ï¼Œæ‰ä¼šåŠ è½½å¹¶å®ä¾‹åŒ–å¯¹åº”çš„å®ç°ç±»ã€‚<strong>å¤§å¤§æé«˜äº†æ•ˆç‡å’Œèµ„æºåˆ©ç”¨ç‡ï¼ŒåŠ å¿«äº†å¯åŠ¨é€Ÿåº¦ã€‚</strong></li></ul></li><li><strong>æ”¯æŒæ‰©å±•ç‚¹å‘½åä¸é…ç½®åŒ–</strong>ï¼š<ul><li>é…ç½®æ–‡ä»¶è·¯å¾„ï¼š<code>META-INF/dubbo/</code> æˆ– <code>META-INF/dubbo/internal/</code> æˆ– <code>META-INF/services/</code>ï¼ˆå…¼å®¹ Java SPIï¼‰ï¼Œæ–‡ä»¶åä¸ºæ¥å£å…¨é™å®šåã€‚</li><li>æ–‡ä»¶å†…å®¹æ ¼å¼ï¼š<code>key=implementation.class.name</code> (ä¾‹å¦‚ï¼š<code>dubbo=org.apache.dubbo.rpc.protocol.dubbo.DubboProtocol</code>)ã€‚è¿™ä¸ºæ¯ä¸ªå®ç°èµ‹äºˆäº†æ˜ç¡®çš„æ ‡è¯†ç¬¦ (<code>key</code>)ã€‚</li></ul></li><li>**å¼ºå¤§çš„ä¾èµ–æ³¨å…¥ (IoC)**ï¼š<ul><li>Dubbo SPI åœ¨å®ä¾‹åŒ–æ‰©å±•ç‚¹å®ç°æ—¶ï¼Œä¼šè‡ªåŠ¨æ‰«æå…¶ setter æ–¹æ³•ã€‚</li><li>å¦‚æœ setter æ–¹æ³•çš„å‚æ•°ç±»å‹æ˜¯å¦ä¸€ä¸ª<strong>å·²çŸ¥çš„æ‰©å±•ç‚¹ç±»å‹</strong>ï¼ŒDubbo ä¼šè‡ªåŠ¨æ³¨å…¥è¯¥æ‰©å±•ç‚¹çš„<strong>é€‚é…å®ä¾‹</strong>ï¼ˆé€šå¸¸æ˜¯è‡ªé€‚åº”æ‰©å±•ç‚¹å®ä¾‹ï¼Œè§ä¸‹ä¸€ç‚¹ï¼‰ã€‚</li><li>ä¹Ÿæ”¯æŒæ³¨å…¥æ¡†æ¶å†…éƒ¨çš„æ ¸å¿ƒç»„ä»¶ï¼ˆå¦‚ <code>ApplicationModel</code>, <code>ModuleModel</code>, <code>ScopeModel</code> ç­‰ï¼‰ã€‚</li><li><strong>ä¼˜åŠ¿ï¼š</strong> è§£è€¦æ‰©å±•ç‚¹å®ç°ä¸æ¡†æ¶å†…éƒ¨ä¾èµ–ï¼Œå¼€å‘è€…åªéœ€å…³æ³¨ä¸šåŠ¡é€»è¾‘ï¼Œä¾èµ–ç”±æ¡†æ¶è‡ªåŠ¨æ³¨å…¥ã€‚</li></ul></li><li>**è‡ªé€‚åº”æ‰©å±•ç‚¹ (Adaptive Extension - æ ¸å¿ƒç‰¹æ€§)**ï¼š<ul><li><strong>æ¦‚å¿µï¼š</strong> ä¸€ç§ç‰¹æ®Šçš„æ‰©å±•ç‚¹ï¼Œå®ƒæœ¬èº«é€šå¸¸ä¸åŒ…å«å…·ä½“é€»è¾‘ï¼Œè€Œæ˜¯ä¸€ä¸ª<strong>åŠ¨æ€ç”Ÿæˆçš„ä»£ç†</strong>ï¼ˆç¼–è¯‘æ—¶ç”Ÿæˆæˆ–è¿è¡Œæ—¶ç”Ÿæˆï¼‰ã€‚</li><li><strong>ä½œç”¨ï¼š</strong> åœ¨<strong>æ–¹æ³•è¢«è°ƒç”¨æ—¶</strong>ï¼Œæ ¹æ®ä¼ å…¥çš„<strong>è¿è¡Œæ—¶å‚æ•°</strong>ï¼ˆé€šå¸¸æ˜¯åŒ…å«é…ç½®ä¿¡æ¯çš„ <code>URL</code> å¯¹è±¡æˆ– <code>@Adaptive</code> æ³¨è§£æŒ‡å®šçš„å‚æ•°ï¼‰ï¼ŒåŠ¨æ€å†³å®šå°†è°ƒç”¨<strong>å§”æ‰˜</strong>ç»™å“ªä¸ªçœŸæ­£çš„æ‰©å±•ç‚¹å®ç° (<code>key</code> å¯¹åº”çš„å®ç°)ã€‚</li><li><strong>å®ç°æ–¹å¼ï¼š</strong><ul><li><strong>ç¼–è¯‘æ—¶ç”Ÿæˆï¼š</strong> Dubbo ç¼–è¯‘å™¨ä¼šä¸ºæ ‡è®°äº† <code>@Adaptive</code> æ³¨è§£çš„æ¥å£æ–¹æ³•ç”Ÿæˆä»£ç†ç±»ä»£ç ï¼ˆå¦‚ <code>Protocol$Adaptive</code>ï¼‰ã€‚</li><li><strong>è¿è¡Œæ—¶ç”Ÿæˆï¼š</strong> å¦‚æœæ¥å£æ²¡æœ‰ä»»ä½•æ–¹æ³•æ ‡è®° <code>@Adaptive</code>ï¼ŒDubbo ä¼šæŸ¥æ‰¾è¯¥æ¥å£çš„é»˜è®¤å®ç°ï¼ˆé€šè¿‡ <code>@SPI</code> çš„ <code>value</code> æŒ‡å®šï¼‰ã€‚å¦‚æœéœ€è¦åœ¨è¿è¡Œæ—¶æ ¹æ®æ–¹æ³•å‚æ•°é€‰æ‹©ï¼Œä¹Ÿå¯ä»¥åœ¨å…·ä½“å®ç°ç±»çš„æ–¹æ³•ä¸Šä½¿ç”¨ <code>@Adaptive</code>ï¼ˆè¾ƒå°‘è§ï¼‰ã€‚</li></ul></li><li><strong>ä¼˜åŠ¿ï¼š</strong> å®ç°äº†çœŸæ­£çš„è¿è¡Œæ—¶åŠ¨æ€æ‰©å±•é€‰æ‹©ã€‚ä¾‹å¦‚ï¼Œ<code>Protocol</code> æ¥å£çš„è‡ªé€‚åº”æ‰©å±•ç‚¹ï¼Œæ ¹æ® URL ä¸­çš„ <code>protocol</code> å‚æ•°å€¼ (<code>dubbo</code>, <code>hessian</code>, <code>http</code>, <code>injvm</code> ç­‰ï¼‰å†³å®šä½¿ç”¨å“ªä¸ªå…·ä½“çš„åè®®å®ç°ã€‚è¿™æ˜¯ Dubbo é«˜åº¦å¯æ‰©å±•æ€§çš„åŸºçŸ³ã€‚</li></ul></li><li>**è‡ªåŠ¨åŒ…è£… (Wrapper - AOP)**ï¼š<ul><li>å¦‚æœæ‰©å±•ç‚¹å®ç°ç±»çš„æ„é€ å‡½æ•°æ¥å—<strong>å•ä¸ªå‚æ•°</strong>ä¸”æ˜¯è¯¥æ‰©å±•ç‚¹æ¥å£ç±»å‹ï¼ŒDubbo ä¼šè¯†åˆ«å®ƒä¸º Wrapper ç±»ã€‚</li><li>åœ¨åŠ è½½çœŸæ­£çš„æ‰©å±•ç‚¹å®ç°ï¼ˆç§°ä¸º <code>instance</code>ï¼‰æ—¶ï¼ŒDubbo ä¼šåƒâ€œæ´‹è‘±â€ä¸€æ ·ï¼Œç”¨æ‰€æœ‰æ‰¾åˆ°çš„ Wrapper ç±»<strong>å±‚å±‚åŒ…è£¹</strong>è¿™ä¸ª <code>instance</code>ï¼š<code>new Wrapper1(new Wrapper2(new Wrapper3(instance)))</code>ã€‚</li><li><strong>ä½œç”¨ï¼š</strong> åœ¨ä¸ä¿®æ”¹åŸå§‹å®ç°ç±»ä»£ç çš„å‰æä¸‹ï¼Œå®ç° AOP åŠŸèƒ½ã€‚Wrapper å¯ä»¥åœ¨è°ƒç”¨çœŸæ­£å®ç°çš„å‰åæ·»åŠ é€»è¾‘ï¼Œå¦‚æ—¥å¿—è®°å½•ã€ç›‘æ§ç»Ÿè®¡ã€æƒé™æ ¡éªŒã€å¤±è´¥é‡è¯•ã€è´Ÿè½½å‡è¡¡ï¼ˆéƒ¨åˆ†ç­–ç•¥ï¼‰ç­‰ã€‚Dubbo è‡ªèº«çš„å¾ˆå¤šåŠŸèƒ½ï¼ˆå¦‚ Filter Chainï¼‰éƒ½æ˜¯é€šè¿‡ Wrapper æœºåˆ¶å®ç°çš„ã€‚</li></ul></li><li>**è‡ªåŠ¨æ¿€æ´»æ‰©å±•ç‚¹ (Activate)**ï¼š<ul><li>é€šè¿‡ <code>@Activate</code> æ³¨è§£æ ‡è®°æ‰©å±•ç‚¹å®ç°ã€‚</li><li>å¯ä»¥æ ¹æ®ç»™å®šçš„æ¡ä»¶ï¼ˆå¦‚ URL ä¸­çš„ç‰¹å®šå‚æ•°å€¼ã€æ¶ˆè´¹è€…&#x2F;æä¾›è€…ç«¯è§’è‰²ï¼‰<strong>è‡ªåŠ¨æ¿€æ´»å¹¶ç»„åˆ</strong>ä¸€ç»„ç¬¦åˆæ¡ä»¶çš„æ‰©å±•ç‚¹å®ç°ã€‚</li><li><strong>å…¸å‹åº”ç”¨ï¼š</strong> Dubbo çš„ Filter é“¾ã€‚å¼€å‘è€…å¯ä»¥æ–¹ä¾¿åœ°æ·»åŠ è‡ªå®šä¹‰ Filterï¼Œå¹¶é€šè¿‡ <code>@Activate</code> æ³¨è§£æ§åˆ¶å®ƒåœ¨å“ªäº›æ¡ä»¶ä¸‹è‡ªåŠ¨ç”Ÿæ•ˆï¼ˆå¦‚æ‰€æœ‰è°ƒç”¨ã€ç‰¹å®šåˆ†ç»„ã€ç‰¹å®šæœåŠ¡ç­‰ï¼‰ã€‚</li></ul></li><li><strong>æ”¯æŒé»˜è®¤æ‰©å±•ç‚¹å’Œè¦†ç›–</strong>ï¼š<ul><li>åœ¨ <code>@SPI</code> æ³¨è§£ä¸­å¯ä»¥æŒ‡å®šé»˜è®¤æ‰©å±•ç‚¹çš„ <code>key</code> (å¦‚ <code>@SPI(&quot;dubbo&quot;)</code>)ã€‚</li><li>Dubbo æ”¯æŒé€šè¿‡é…ç½®ï¼ˆç³»ç»Ÿå±æ€§ã€å¤–éƒ¨é…ç½®ï¼‰è¦†ç›–é»˜è®¤å®ç°æˆ–å·²åŠ è½½çš„å®ç°ã€‚</li></ul></li><li><strong>ç¼“å­˜ä¼˜åŒ–</strong>ï¼š<ul><li>Dubbo å¯¹åŠ è½½çš„æ‰©å±•ç‚¹å®šä¹‰ã€å®ä¾‹ï¼ˆå•ä¾‹æˆ–åŸå‹ï¼‰ã€è‡ªé€‚åº”æ‰©å±•ç‚¹å®ä¾‹ç­‰è¿›è¡Œäº†ç»†è‡´çš„ç¼“å­˜ç®¡ç†ï¼Œé¿å…é‡å¤åŠ è½½å’Œåˆ›å»ºï¼Œæå‡æ€§èƒ½ã€‚</li></ul></li></ol><p><strong>æ€»ç»“å¯¹æ¯”è¡¨</strong></p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">Java SPI</th><th align="left">Dubbo SPI</th><th align="left">Dubbo æ”¹è¿›ç‚¹&#x2F;ä¼˜åŠ¿</th></tr></thead><tbody><tr><td align="left"><strong>åŠ è½½æ–¹å¼</strong></td><td align="left">å…¨é‡åŠ è½½å¹¶å®ä¾‹åŒ–æ‰€æœ‰å®ç°</td><td align="left"><strong>æŒ‰éœ€åŠ è½½</strong>ï¼Œä»…åœ¨ä½¿ç”¨æ—¶åŠ è½½å¹¶å®ä¾‹åŒ–æŒ‡å®š <code>key</code></td><td align="left"><strong>é«˜æ•ˆã€èŠ‚çœèµ„æºã€å¯åŠ¨å¿«</strong></td></tr><tr><td align="left"><strong>æ ‡è¯†ä¸é…ç½®</strong></td><td align="left">ä»…å®ç°ç±»å…¨å</td><td align="left"><code>key=implementation.class.name</code></td><td align="left"><strong>é…ç½®çµæ´»ã€å¯è¯»æ€§å¥½ã€æ˜“äºé€šè¿‡ <code>key</code> å¼•ç”¨</strong></td></tr><tr><td align="left"><strong>ä¾èµ–æ³¨å…¥ (IoC)</strong></td><td align="left">ä¸æ”¯æŒ</td><td align="left"><strong>å¼ºæœ‰åŠ›æ”¯æŒ</strong>ï¼Œè‡ªåŠ¨æ³¨å…¥å…¶ä»–æ‰©å±•ç‚¹æˆ–æ¡†æ¶ç»„ä»¶</td><td align="left"><strong>è§£è€¦ã€ç®€åŒ–æ‰©å±•å¼€å‘ã€å¢å¼ºå°è£…æ€§</strong></td></tr><tr><td align="left"><strong>åŠ¨æ€æ‰©å±•é€‰æ‹©</strong></td><td align="left">ä¸æ”¯æŒ</td><td align="left"><strong>è‡ªé€‚åº”æ‰©å±•ç‚¹ (Adaptive)</strong></td><td align="left"><strong>è¿è¡Œæ—¶æ ¹æ®å‚æ•°åŠ¨æ€é€‰æ‹©å®ç°ï¼Œæ ¸å¿ƒçµæ´»æ€§æ¥æº</strong></td></tr><tr><td align="left"><strong>AOP&#x2F;åŒ…è£…</strong></td><td align="left">ä¸æ”¯æŒ</td><td align="left"><strong>è‡ªåŠ¨åŒ…è£… (Wrapper)</strong></td><td align="left"><strong>æ— ä¾µå…¥æ·»åŠ å…¬å…±é€»è¾‘ (Filter, ç›‘æ§, æ ¡éªŒç­‰)</strong></td></tr><tr><td align="left"><strong>æ¡ä»¶æ¿€æ´»</strong></td><td align="left">ä¸æ”¯æŒ</td><td align="left"><code>@Activate</code> <strong>è‡ªåŠ¨æ¿€æ´»</strong></td><td align="left"><strong>ç®€åŒ–æ‰©å±•ç»„åˆï¼ŒæŒ‰æ¡ä»¶åŠ¨æ€å¯ç”¨æ‰©å±•é“¾ (å¦‚ Filter)</strong></td></tr><tr><td align="left"><strong>é»˜è®¤å®ç°ä¸è¦†ç›–</strong></td><td align="left">æ— æ˜ç¡®æœºåˆ¶</td><td align="left"><code>@SPI(&quot;defaultKey&quot;)</code> + é…ç½®è¦†ç›–</td><td align="left"><strong>çµæ´»æŒ‡å®šå’Œä¿®æ”¹é»˜è®¤è¡Œä¸º</strong></td></tr><tr><td align="left"><strong>ç¼“å­˜</strong></td><td align="left">åŸºç¡€ç¼“å­˜</td><td align="left"><strong>ç²¾ç»†åŒ–çš„å¤šçº§ç¼“å­˜ç®¡ç†</strong></td><td align="left"><strong>æ€§èƒ½ä¼˜åŒ–</strong></td></tr><tr><td align="left"><strong>ç”Ÿå‘½å‘¨æœŸ</strong></td><td align="left">æ— </td><td align="left">(é—´æ¥é€šè¿‡ Spring ç­‰æˆ–è‡ªå®šä¹‰å®ç°)</td><td align="left">Dubbo SPI æœ¬èº«æœªå¼ºå®šä¹‰ï¼Œä½†å¸¸ä¸å…¶ä»–ç”Ÿå‘½å‘¨æœŸç®¡ç†é›†æˆ</td></tr></tbody></table><p><strong>ç»“è®ºï¼š</strong></p><p>Dubbo çš„ SPI æœºåˆ¶å¹¶éå¯¹ Java SPI çš„ç®€å•æ›¿æ¢ï¼Œè€Œæ˜¯ä¸ºäº†è§£å†³ Java SPI åœ¨<strong>æ•ˆç‡ã€çµæ´»æ€§ã€åŠ¨æ€æ€§ã€ä¾èµ–ç®¡ç†ã€åŠŸèƒ½å¢å¼ºï¼ˆAOPï¼‰</strong> ç­‰æ–¹é¢çš„ä¸¥é‡ä¸è¶³ï¼Œä¸ºæ„å»ºé«˜åº¦å¯æ‰©å±•ã€é«˜æ€§èƒ½ã€æ˜“äºé›†æˆçš„åˆ†å¸ƒå¼æœåŠ¡æ¡†æ¶é‡èº«æ‰“é€ çš„ä¸€å¥—å¼ºå¤§çš„æ‰©å±•ç‚¹åŠ è½½ä¸ç®¡ç†ä½“ç³»ã€‚Dubbo è‡ªèº«çš„å‡ ä¹æ‰€æœ‰æ ¸å¿ƒç»„ä»¶ï¼ˆProtocol, Cluster, LoadBalance, Serialization, Transport, Registry, Monitor, Filter ç­‰ï¼‰éƒ½é€šè¿‡è¿™å¥— SPI æœºåˆ¶å®ç°ï¼Œè¿™ä¹Ÿæ˜¯ Dubbo èƒ½å¤Ÿä¿æŒå¼ºå¤§ç”Ÿå‘½åŠ›å’Œé«˜åº¦å¯å®šåˆ¶æ€§çš„å…³é”®è®¾è®¡ä¹‹ä¸€ã€‚</p><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      <categories>
          
          <category> Dubbo </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>ElasticSearch</title>
      <link href="/post/d48132d3.html"/>
      <url>/post/d48132d3.html</url>
      
        <content type="html"><![CDATA[<h2 id="Elasticsearch-çš„æ ¸å¿ƒæ¦‚å¿µ"><a href="#Elasticsearch-çš„æ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="Elasticsearch çš„æ ¸å¿ƒæ¦‚å¿µ"></a><strong>Elasticsearch çš„æ ¸å¿ƒæ¦‚å¿µ</strong></h2><ul><li><strong>æ–‡æ¡£ï¼š</strong> æ•°æ®çš„åŸºæœ¬å•ä½ï¼Œé€šå¸¸æ˜¯ JSON æ ¼å¼ã€‚ç›¸å½“äºæ•°æ®åº“ä¸­çš„ä¸€è¡Œè®°å½•ã€‚</li><li><strong>ç´¢å¼•ï¼š</strong> å…·æœ‰ç›¸ä¼¼ç‰¹å¾çš„æ–‡æ¡£é›†åˆã€‚ç›¸å½“äºæ•°æ®åº“ä¸­çš„ä¸€ä¸ªè¡¨ã€‚ä¸€ä¸ªç´¢å¼•å¯¹åº”ä¸€ä¸ªæˆ–å¤šä¸ªåˆ†ç‰‡ã€‚</li><li><strong>ç±»å‹ï¼š</strong> (7.x ä¹‹å‰) ç´¢å¼•å†…éƒ¨çš„é€»è¾‘åˆ†åŒºï¼Œå…è®¸åœ¨åŒä¸€ç´¢å¼•ä¸­å­˜å‚¨ä¸åŒç±»å‹çš„æ–‡æ¡£ï¼ˆå¦‚ <code>user</code>, <code>product</code>ï¼‰ã€‚(<strong>æ³¨æ„ï¼š</strong> åœ¨ 7.x ä¸­ç±»å‹è¢«åºŸå¼ƒï¼Œ8.x ä¸­å®Œå…¨ç§»é™¤ã€‚ç°åœ¨ä¸€ä¸ªç´¢å¼•é€šå¸¸åªåŒ…å«ä¸€ç§æ–‡æ¡£ç±»å‹)ã€‚</li><li><strong>åˆ†ç‰‡ï¼š</strong> ç´¢å¼•è¢«æ°´å¹³åˆ†å‰²æˆçš„å­é›†ã€‚æ¯ä¸ªåˆ†ç‰‡æœ¬èº«å°±æ˜¯ä¸€ä¸ªåŠŸèƒ½å®Œæ•´ä¸”ç‹¬ç«‹çš„â€œç´¢å¼•â€ã€‚<ul><li><strong>ä¸»åˆ†ç‰‡ï¼š</strong> å­˜å‚¨æ–‡æ¡£æ•°æ®å’Œå¤„ç†ç´¢å¼•&#x2F;æ›´æ–°æ“ä½œã€‚ç´¢å¼•åˆ›å»ºæ—¶æŒ‡å®šæ•°é‡ï¼Œåç»­ä¸å¯æ›´æ”¹ï¼ˆé™¤é Reindexï¼‰ã€‚</li><li><strong>å‰¯æœ¬åˆ†ç‰‡ï¼š</strong> ä¸»åˆ†ç‰‡çš„æ‹·è´ã€‚æä¾›é«˜å¯ç”¨æ€§ï¼ˆä¸»åˆ†ç‰‡æ•…éšœæ—¶å‰¯æœ¬å¯æå‡ä¸ºä¸»ï¼‰å’Œè¯»å–ååé‡ï¼ˆæŸ¥è¯¢å¯è´Ÿè½½å‡è¡¡åˆ°æ‰€æœ‰å‰¯æœ¬ï¼‰ã€‚</li></ul></li><li><strong>èŠ‚ç‚¹ï¼š</strong> è¿è¡Œä¸­çš„ Elasticsearch å®ä¾‹ã€‚</li><li><strong>é›†ç¾¤ï¼š</strong> ä¸€ä¸ªæˆ–å¤šä¸ªèŠ‚ç‚¹ååŒå·¥ä½œçš„é›†åˆï¼Œå…±åŒæŒæœ‰æ•´ä¸ªæ•°æ®å¹¶æä¾›è”åˆç´¢å¼•å’Œæœç´¢èƒ½åŠ›ã€‚</li><li><strong>å€’æ’ç´¢å¼•ï¼š</strong> ES å®ç°å¿«é€Ÿå…¨æ–‡æœç´¢çš„æ ¸å¿ƒæ•°æ®ç»“æ„ã€‚å®ƒå­˜å‚¨äº†è¯é¡¹ï¼ˆTokenï¼‰åˆ°åŒ…å«è¯¥è¯é¡¹çš„æ–‡æ¡£ ID åˆ—è¡¨çš„æ˜ å°„ã€‚ç›¸æ¯”ä¼ ç»Ÿæ•°æ®åº“çš„æ­£æ’ç´¢å¼•ï¼ˆæ–‡æ¡£ ID åˆ°å­—æ®µå€¼ï¼‰ï¼Œå®ƒæ›´æ“…é•¿å›ç­”â€œå“ªäº›æ–‡æ¡£åŒ…å«æŸä¸ªè¯ï¼Ÿâ€çš„é—®é¢˜ã€‚</li></ul><h2 id="ä»€ä¹ˆæ˜¯å€’æ’ç´¢å¼•ï¼Ÿä¸ºä»€ä¹ˆå®ƒå¯¹æœç´¢å¾ˆé‡è¦ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯å€’æ’ç´¢å¼•ï¼Ÿä¸ºä»€ä¹ˆå®ƒå¯¹æœç´¢å¾ˆé‡è¦ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯å€’æ’ç´¢å¼•ï¼Ÿä¸ºä»€ä¹ˆå®ƒå¯¹æœç´¢å¾ˆé‡è¦ï¼Ÿ"></a><strong>ä»€ä¹ˆæ˜¯å€’æ’ç´¢å¼•ï¼Ÿä¸ºä»€ä¹ˆå®ƒå¯¹æœç´¢å¾ˆé‡è¦ï¼Ÿ</strong></h2><ul><li><strong>å®šä¹‰ï¼š</strong> å€’æ’ç´¢å¼•æ˜¯ä¸€ç§å°†æ–‡æ¡£ä¸­çš„è¯é¡¹ï¼ˆTokenï¼‰æ˜ å°„åˆ°åŒ…å«è¯¥è¯é¡¹çš„æ–‡æ¡£åˆ—è¡¨çš„æ•°æ®ç»“æ„ã€‚å®ƒåŒ…å«ä¸¤ä¸ªæ ¸å¿ƒéƒ¨åˆ†ï¼š<ul><li><strong>è¯é¡¹å­—å…¸ï¼š</strong> åŒ…å«æ‰€æœ‰ä¸é‡å¤çš„è¯é¡¹ï¼ˆTokenï¼‰ï¼Œé€šå¸¸æŒ‰å­—å…¸åºæ’åºã€‚</li><li><strong>å€’æ’åˆ—è¡¨ï¼š</strong> å¯¹äºæ¯ä¸ªè¯é¡¹ï¼Œè®°å½•åŒ…å«è¯¥è¯é¡¹çš„æ‰€æœ‰æ–‡æ¡£ ID åˆ—è¡¨ï¼ˆPostings Listï¼‰ï¼Œä»¥åŠè¯é¡¹åœ¨æ–‡æ¡£ä¸­å‡ºç°çš„ä½ç½®ï¼ˆPositionï¼‰ã€é¢‘ç‡ï¼ˆTerm Frequencyï¼‰ç­‰ä¿¡æ¯ï¼ˆç”¨äºç›¸å…³æ€§è¯„åˆ†ï¼‰ã€‚</li></ul></li><li><strong>é‡è¦æ€§ï¼š</strong><ul><li><strong>å¿«é€Ÿå®šä½ï¼š</strong> ç›´æ¥é€šè¿‡è¯é¡¹æ‰¾åˆ°åŒ…å«å®ƒçš„æ–‡æ¡£ï¼Œé¿å…äº†æ‰«ææ‰€æœ‰æ–‡æ¡£ã€‚</li><li><strong>é«˜æ•ˆå¸ƒå°”æŸ¥è¯¢ï¼š</strong> AND&#x2F;OR&#x2F;NOT æ“ä½œå¯ä»¥é€šè¿‡å¯¹å€’æ’åˆ—è¡¨è¿›è¡Œäº¤&#x2F;å¹¶&#x2F;å·®é›†è¿ç®—é«˜æ•ˆå®Œæˆã€‚</li><li><strong>ç›¸å…³æ€§è¯„åˆ†åŸºç¡€ï¼š</strong> TF-IDFã€BM25 ç­‰ç»å…¸è¯„åˆ†æ¨¡å‹ä¸¥é‡ä¾èµ–å€’æ’ç´¢å¼•ä¸­å­˜å‚¨çš„è¯é¢‘ï¼ˆTFï¼‰ã€æ–‡æ¡£é¢‘ç‡ï¼ˆDF&#x2F;IDFï¼‰ä¿¡æ¯ã€‚</li><li><strong>æ”¯æŒçŸ­è¯­æŸ¥è¯¢ï¼š</strong> åˆ©ç”¨å­˜å‚¨çš„ä½ç½®ä¿¡æ¯ï¼Œå¯ä»¥ç²¾ç¡®æŸ¥æ‰¾ç›¸é‚»å‡ºç°çš„è¯ç»„ã€‚</li></ul></li></ul><h2 id="åˆ†ç‰‡ï¼ˆShardï¼‰å’Œå‰¯æœ¬ï¼ˆReplicaï¼‰æ˜¯ä»€ä¹ˆ"><a href="#åˆ†ç‰‡ï¼ˆShardï¼‰å’Œå‰¯æœ¬ï¼ˆReplicaï¼‰æ˜¯ä»€ä¹ˆ" class="headerlink" title="åˆ†ç‰‡ï¼ˆShardï¼‰å’Œå‰¯æœ¬ï¼ˆReplicaï¼‰æ˜¯ä»€ä¹ˆ"></a>åˆ†ç‰‡ï¼ˆShardï¼‰å’Œå‰¯æœ¬ï¼ˆReplicaï¼‰æ˜¯ä»€ä¹ˆ</h2><p>åˆ†ç‰‡æ˜¯ç´¢å¼•çš„ç‰©ç†ç»„æˆéƒ¨åˆ†ï¼ˆä¸€ä¸ª Lucene ç´¢å¼•ï¼‰ï¼Œç”¨äº<strong>æ°´å¹³åˆ†å‰²æ•°æ®</strong>ï¼Œä½¿ç´¢å¼•å¯ä»¥åˆ†å¸ƒåœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šï¼Œå®ç°<strong>æ°´å¹³æ‰©å±•å’Œå¹¶è¡Œå¤„ç†</strong>ã€‚</p><p>å‰¯æœ¬æ˜¯ä¸»åˆ†ç‰‡çš„å®Œæ•´æ‹·è´ï¼Œä½œç”¨æ˜¯<strong>æä¾›é«˜å¯ç”¨æ€§</strong>ï¼ˆä¸»åˆ†ç‰‡æ•…éšœæ—¶å‰¯æœ¬å¯æ¥ç®¡ï¼‰å’Œ<strong>æé«˜æŸ¥è¯¢ååé‡&#x2F;æ€§èƒ½</strong>ï¼ˆæŸ¥è¯¢å¯ä»¥åœ¨å‰¯æœ¬ä¸Šæ‰§è¡Œï¼Œåˆ†æ‹…è´Ÿè½½ï¼‰ã€‚ä¸»åˆ†ç‰‡æ•°é‡åœ¨ç´¢å¼•åˆ›å»ºæ—¶æŒ‡å®šä¸”åç»­ä¸å¯å˜ï¼Œå‰¯æœ¬æ•°é‡å¯ä»¥åŠ¨æ€è°ƒæ•´ã€‚</p><h2 id="Elasticsearch-å¦‚ä½•ä¿è¯å†™å…¥æ•°æ®çš„å¯é æ€§ï¼Ÿ"><a href="#Elasticsearch-å¦‚ä½•ä¿è¯å†™å…¥æ•°æ®çš„å¯é æ€§ï¼Ÿ" class="headerlink" title="Elasticsearch å¦‚ä½•ä¿è¯å†™å…¥æ•°æ®çš„å¯é æ€§ï¼Ÿ"></a>Elasticsearch å¦‚ä½•ä¿è¯å†™å…¥æ•°æ®çš„å¯é æ€§ï¼Ÿ</h2><ul><li><strong>äº‹åŠ¡æ—¥å¿—ï¼š</strong> æ‰€æœ‰å†™å…¥æ“ä½œåœ¨å†™å…¥å†…å­˜ç¼“å†²åŒºï¼ˆIn-memory Bufferï¼‰çš„åŒæ—¶ï¼Œä¼šç«‹å³è¿½åŠ å†™å…¥åˆ°äº‹åŠ¡æ—¥å¿—ï¼ˆTranslogï¼‰ä¸­ã€‚Translog æ˜¯æŒä¹…åŒ–çš„ã€‚</li><li><strong>Refreshï¼š</strong> å®šæœŸï¼ˆé»˜è®¤ 1 ç§’ï¼‰å°†å†…å­˜ç¼“å†²åŒºä¸­çš„å†…å®¹ç”Ÿæˆä¸€ä¸ªæ–°çš„ã€å¯æœç´¢çš„ Lucene æ®µï¼ˆSegmentï¼‰ï¼Œå¹¶æ¸…ç©ºç¼“å†²åŒºã€‚è¿™ä¸ªè¿‡ç¨‹ä½¿æ–°å†™å…¥çš„æ•°æ®å¯¹æœç´¢å¯è§ã€‚<strong>æ³¨æ„ï¼š</strong> æ­¤æ—¶æ•°æ®è¿˜åœ¨æ“ä½œç³»ç»Ÿçš„æ–‡ä»¶ç³»ç»Ÿç¼“å­˜ï¼ˆPage Cacheï¼‰ä¸­ï¼Œå¹¶æœªç‰©ç†åˆ·ç›˜ï¼ˆ<code>fsync</code>ï¼‰ã€‚</li><li><strong>Flushï¼š</strong> å®šæœŸï¼ˆé»˜è®¤ 30 åˆ†é’Ÿï¼Œæˆ– Translog å¤§å°è¾¾åˆ°é˜ˆå€¼ï¼‰æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š<ol><li>è§¦å‘ä¸€æ¬¡ Refreshï¼Œå°†æ‰€æœ‰åœ¨å†…å­˜ç¼“å†²åŒºä¸­çš„æ•°æ®ç”Ÿæˆæ–°çš„æ®µã€‚</li><li>å°†æ–‡ä»¶ç³»ç»Ÿç¼“å­˜ä¸­çš„æ®µæ•°æ®ç‰©ç† <code>fsync</code> åˆ°ç£ç›˜ã€‚</li><li>æ¸…ç©ºï¼ˆæˆªæ–­ï¼‰æ—§çš„ã€å·²æŒä¹…åŒ–çš„ Translogã€‚</li></ol></li><li><strong>å‰¯æœ¬æœºåˆ¶ï¼š</strong> å†™å…¥æ“ä½œåœ¨ä¸»åˆ†ç‰‡æ‰§è¡ŒæˆåŠŸåï¼Œå¿…é¡»ç­‰å¾…æ‰€æœ‰é…ç½®çš„å‰¯æœ¬åˆ†ç‰‡ä¹Ÿå†™å…¥æˆåŠŸæ‰è¿”å›å®¢æˆ·ç«¯ç¡®è®¤ï¼ˆé™¤éä½¿ç”¨ <code>wait_for_active_shards</code> é™ä½è¦æ±‚ï¼‰ã€‚è¿™ç¡®ä¿äº†æ•°æ®å†—ä½™ã€‚</li><li><strong>æ•…éšœæ¢å¤ï¼š</strong> èŠ‚ç‚¹é‡å¯æ—¶ï¼Œä¼šé‡æ”¾ Translog ä¸­å°šæœªåˆ·ç›˜çš„æ“ä½œæ¥æ¢å¤æ•°æ®ã€‚å‰¯æœ¬åˆ†ç‰‡çš„å­˜åœ¨ä¿è¯äº†ä¸»åˆ†ç‰‡ä¸¢å¤±æ—¶æ•°æ®ä¸ä¸¢ã€‚</li></ul><h2 id="è§£é‡Šä¸€ä¸‹-Elasticsearch-ä¸­çš„-refresh-å’Œ-flush-æ“ä½œçš„åŒºåˆ«"><a href="#è§£é‡Šä¸€ä¸‹-Elasticsearch-ä¸­çš„-refresh-å’Œ-flush-æ“ä½œçš„åŒºåˆ«" class="headerlink" title="è§£é‡Šä¸€ä¸‹ Elasticsearch ä¸­çš„ refresh å’Œ flush æ“ä½œçš„åŒºåˆ«"></a>è§£é‡Šä¸€ä¸‹ Elasticsearch ä¸­çš„ <code>refresh</code> å’Œ <code>flush</code> æ“ä½œçš„åŒºåˆ«</h2><ul><li><strong><code>refresh</code>ï¼š</strong><ul><li><strong>ç›®çš„ï¼š</strong> ä½¿æ–°å†™å…¥çš„æ•°æ®å¯¹æœç´¢å¯è§ã€‚</li><li><strong>æ“ä½œï¼š</strong> å°†å†…å­˜ç¼“å†²åŒºä¸­çš„æ–‡æ¡£ç”Ÿæˆæ–°çš„ã€å¯æœç´¢çš„ Lucene æ®µï¼ˆSegmentï¼‰ã€‚æ®µå†™å…¥æ–‡ä»¶ç³»ç»Ÿç¼“å­˜ï¼ˆPage Cacheï¼‰ï¼Œ<strong>ä¸</strong>ç«‹å³ <code>fsync</code> åˆ°ç£ç›˜ã€‚</li><li><strong>é¢‘ç‡ï¼š</strong> é»˜è®¤æ¯ç§’ä¸€æ¬¡ï¼ˆå¯é€šè¿‡ <code>index.refresh_interval</code> é…ç½®ï¼‰ã€‚</li><li><strong>å¼€é”€ï¼š</strong> ç›¸å¯¹è¾ƒä½ï¼Œå› ä¸ºåªå†™å…¥ Page Cacheã€‚é¢‘ç¹ Refresh ä¼šäº§ç”Ÿå¤§é‡å°æ®µï¼Œå¢åŠ åˆå¹¶ï¼ˆMergeï¼‰å‹åŠ›ã€‚</li></ul></li><li><strong><code>flush</code>ï¼š</strong><ul><li><strong>ç›®çš„ï¼š</strong> å°†æ–‡ä»¶ç³»ç»Ÿç¼“å­˜ä¸­çš„æ•°æ®å®‰å…¨æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œå¹¶æ¸…ç† Translogã€‚</li><li><strong>æ“ä½œï¼š</strong><ol><li>æ‰§è¡Œä¸€æ¬¡ Refreshï¼ˆç¡®ä¿æ‰€æœ‰æ•°æ®éƒ½åœ¨æ®µé‡Œï¼‰ã€‚</li><li>è°ƒç”¨ <code>fsync</code> å°†æ–‡ä»¶ç³»ç»Ÿç¼“å­˜ä¸­çš„æ‰€æœ‰æ®µæ•°æ®å¼ºåˆ¶å†™å…¥ç£ç›˜å­˜å‚¨è®¾å¤‡ã€‚</li><li>æ¸…ç©ºï¼ˆæˆªæ–­ï¼‰å½“å‰ Translogï¼ˆå› ä¸ºæ•°æ®å·²å®‰å…¨è½ç›˜ï¼‰ã€‚</li></ol></li><li><strong>è§¦å‘æ¡ä»¶ï¼š</strong><ul><li>å®šæ—¶ï¼ˆé»˜è®¤ 30 åˆ†é’Ÿï¼Œ<code>index.translog.sync_interval</code> &#x2F; <code>index.translog.durability</code>ï¼‰ã€‚</li><li>Translog å¤§å°è¾¾åˆ°é˜ˆå€¼ï¼ˆé»˜è®¤ 512MBï¼Œ<code>index.translog.flush_threshold_size</code>ï¼‰ã€‚</li><li>æ˜¾å¼è°ƒç”¨ <code>_flush</code> APIã€‚</li></ul></li><li><strong>å¼€é”€ï¼š</strong> ç›¸å¯¹è¾ƒé«˜ï¼Œå› ä¸ºæ¶‰åŠç£ç›˜ I&#x2F;O (<code>fsync</code>)ã€‚</li></ul></li></ul><h2 id="é›†ç¾¤çŠ¶æ€-Yellow-æˆ–-Red-æ„å‘³ç€ä»€ä¹ˆï¼Ÿå¦‚ä½•æ’æŸ¥"><a href="#é›†ç¾¤çŠ¶æ€-Yellow-æˆ–-Red-æ„å‘³ç€ä»€ä¹ˆï¼Ÿå¦‚ä½•æ’æŸ¥" class="headerlink" title="é›†ç¾¤çŠ¶æ€ Yellow æˆ– Red æ„å‘³ç€ä»€ä¹ˆï¼Ÿå¦‚ä½•æ’æŸ¥?"></a>é›†ç¾¤çŠ¶æ€ Yellow æˆ– Red æ„å‘³ç€ä»€ä¹ˆï¼Ÿå¦‚ä½•æ’æŸ¥?</h2><ul><li><strong>Yellowï¼š</strong><ul><li><strong>å«ä¹‰ï¼š</strong> æ‰€æœ‰ä¸»åˆ†ç‰‡éƒ½å·²åˆ†é…ï¼Œä½†<strong>è‡³å°‘æœ‰ä¸€ä¸ªå‰¯æœ¬åˆ†ç‰‡æ²¡æœ‰åˆ†é…</strong>ã€‚</li><li><strong>å¸¸è§åŸå› ï¼š</strong><ul><li>èŠ‚ç‚¹æ•°é‡ä¸è¶³ï¼ˆä¾‹å¦‚ï¼Œç´¢å¼•é…ç½®äº† <code>number_of_replicas=1</code>ï¼Œä½†é›†ç¾¤åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ï¼‰ã€‚</li><li>æ–°åˆ›å»ºçš„ç´¢å¼•å‰¯æœ¬åˆ†ç‰‡æ­£åœ¨åˆå§‹åŒ–ï¼ˆçŸ­æš‚çŠ¶æ€ï¼‰ã€‚</li><li>æœ‰èŠ‚ç‚¹æ•…éšœï¼Œå¯¼è‡´éƒ¨åˆ†å‰¯æœ¬åˆ†ç‰‡ä¸¢å¤±ï¼ˆä½†ä¸»åˆ†ç‰‡è¿˜åœ¨ï¼‰ã€‚</li></ul></li><li><strong>å½±å“ï¼š</strong> é«˜å¯ç”¨æ€§é™ä½ï¼ˆä¸¢å¤±ä¸€ä¸ªèŠ‚ç‚¹å¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤±&#x2F;ä¸å¯ç”¨ï¼‰ï¼ŒæŸ¥è¯¢ååé‡å¯èƒ½ä¸‹é™ï¼ˆå‰¯æœ¬å°‘ï¼‰ã€‚</li><li><strong>æ’æŸ¥ï¼š</strong> <code>GET _cluster/allocation/explain</code> API æŸ¥çœ‹æœªåˆ†é…åˆ†ç‰‡çš„å…·ä½“åŸå› ï¼›æ£€æŸ¥èŠ‚ç‚¹æ•°ã€èŠ‚ç‚¹çŠ¶æ€ã€ç£ç›˜ç©ºé—´ã€åˆ†ç‰‡åˆ†é…è®¾ç½®ã€‚</li></ul></li><li><strong>Redï¼š</strong><ul><li><strong>å«ä¹‰ï¼š</strong> <strong>è‡³å°‘æœ‰ä¸€ä¸ªä¸»åˆ†ç‰‡æ²¡æœ‰åˆ†é…</strong>ï¼ˆå¯èƒ½è¿å¸¦å…¶å‰¯æœ¬ä¹Ÿç¼ºå¤±ï¼‰ã€‚</li><li><strong>å¸¸è§åŸå› ï¼š</strong><ul><li>æŒæœ‰ä¸»åˆ†ç‰‡çš„èŠ‚ç‚¹æ°¸ä¹…ä¸¢å¤±ï¼Œä¸”æ²¡æœ‰å¯ç”¨çš„å‰¯æœ¬åˆ†ç‰‡å¯ä»¥æå‡ä¸ºä¸»åˆ†ç‰‡ã€‚</li><li>ç£ç›˜ç©ºé—´ä¸è¶³å¯¼è‡´åˆ†ç‰‡æ— æ³•åˆ†é…ã€‚</li><li>é…ç½®é”™è¯¯ï¼ˆå¦‚åˆ†ç‰‡åˆ†é…è§„åˆ™ exclude äº†æ‰€æœ‰èŠ‚ç‚¹ï¼‰ã€‚</li></ul></li><li><strong>å½±å“ï¼š</strong> <strong>æ•°æ®éƒ¨åˆ†ä¸¢å¤±æˆ–å®Œå…¨ä¸å¯ç”¨ï¼</strong> æ¶‰åŠè¯¥ä¸»åˆ†ç‰‡çš„ç´¢å¼•å’Œæœç´¢æ“ä½œéƒ½ä¼šå¤±è´¥ã€‚</li><li><strong>æ’æŸ¥ï¼š</strong> ç´§æ€¥ï¼ç«‹å³æ£€æŸ¥ <code>_cluster/health</code> å’Œ <code>_cat/shards?v</code> ç¡®è®¤å“ªäº›ç´¢å¼•&#x2F;åˆ†ç‰‡æ˜¯ <code>red</code>ã€‚ä½¿ç”¨ <code>GET _cluster/allocation/explain</code> åˆ†ææœªåˆ†é…åŸå› ã€‚æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€ã€ç£ç›˜ç©ºé—´ã€æ—¥å¿—ã€‚å¯èƒ½éœ€è¦ä»å¤‡ä»½æ¢å¤æˆ–æ‰‹åŠ¨åˆ†é…åˆ†ç‰‡ï¼ˆé£é™©æ“ä½œï¼‰ã€‚</li></ul></li><li><strong>ç›®æ ‡ï¼š</strong> å§‹ç»ˆè¿½æ±‚ <code>Green</code> çŠ¶æ€ã€‚</li></ul><h2 id="è§£é‡Šä¸€ä¸‹ä»€ä¹ˆæ˜¯è„‘è£‚ï¼ˆSplit-Brainï¼‰é—®é¢˜ï¼ŸElasticsearch-å¦‚ä½•é˜²æ­¢è„‘è£‚ï¼Ÿ"><a href="#è§£é‡Šä¸€ä¸‹ä»€ä¹ˆæ˜¯è„‘è£‚ï¼ˆSplit-Brainï¼‰é—®é¢˜ï¼ŸElasticsearch-å¦‚ä½•é˜²æ­¢è„‘è£‚ï¼Ÿ" class="headerlink" title="è§£é‡Šä¸€ä¸‹ä»€ä¹ˆæ˜¯è„‘è£‚ï¼ˆSplit-Brainï¼‰é—®é¢˜ï¼ŸElasticsearch å¦‚ä½•é˜²æ­¢è„‘è£‚ï¼Ÿ"></a>è§£é‡Šä¸€ä¸‹ä»€ä¹ˆæ˜¯è„‘è£‚ï¼ˆSplit-Brainï¼‰é—®é¢˜ï¼ŸElasticsearch å¦‚ä½•é˜²æ­¢è„‘è£‚ï¼Ÿ</h2><ul><li><strong>å®šä¹‰ï¼š</strong> åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå½“ç½‘ç»œåˆ†åŒºï¼ˆNetwork Partitionï¼‰å‘ç”Ÿæ—¶ï¼Œé›†ç¾¤çš„ä¸åŒéƒ¨åˆ†ï¼ˆèŠ‚ç‚¹ç»„ï¼‰å¯èƒ½æ— æ³•äº’ç›¸é€šä¿¡ã€‚å¦‚æœæ¯ä¸ªéƒ¨åˆ†éƒ½è®¤ä¸ºè‡ªå·±æ˜¯å”¯ä¸€å¯ç”¨çš„éƒ¨åˆ†å¹¶é€‰ä¸¾å‡ºæ–°çš„ä¸»èŠ‚ç‚¹ï¼Œå°±ä¼šå¯¼è‡´é›†ç¾¤åˆ†è£‚æˆä¸¤ä¸ªæˆ–å¤šä¸ªç‹¬ç«‹è¿ä½œçš„â€œè„‘â€ï¼Œå„è‡ªæ¥å—å†™å…¥æ“ä½œï¼Œé€ æˆ<strong>æ•°æ®ä¸ä¸€è‡´</strong>å’Œ<strong>å†²çª</strong>ã€‚</li><li><strong>ES é˜²æ­¢æœºåˆ¶ï¼š</strong> ä¸»è¦é€šè¿‡ <strong><code>discovery.zen.minimum_master_nodes</code></strong> è®¾ç½®ï¼ˆåœ¨ 7.x ä¹‹å‰æ˜¾å¼é…ç½®ï¼‰æˆ– <strong><code>cluster.initial_master_nodes</code></strong> + <strong>Quorum</strong> æœºåˆ¶ï¼ˆ7.x+ å°¤å…¶æ˜¯åŸºäº Raft çš„é€‰ä¸¾ï¼‰ï¼š<ul><li><strong>æ ¸å¿ƒæ€æƒ³ï¼š</strong> ç¡®ä¿åªæœ‰æ‹¥æœ‰<strong>å¤šæ•°</strong>ï¼ˆQuorum, &gt; N&#x2F;2ï¼‰<strong>ä¸»èŠ‚ç‚¹èµ„æ ¼èŠ‚ç‚¹</strong>çš„èŠ‚ç‚¹ç»„æ‰èƒ½æˆåŠŸé€‰ä¸¾ä¸»èŠ‚ç‚¹æˆ–ç»´æŒä¸»èŠ‚ç‚¹ã€‚å‡è®¾æœ‰ <code>N</code> ä¸ªä¸»èŠ‚ç‚¹èµ„æ ¼èŠ‚ç‚¹ï¼š<ul><li>è®¾ç½® <code>discovery.zen.minimum_master_nodes = (N/2) + 1</code> ï¼ˆä¾‹å¦‚ï¼Œ3èŠ‚ç‚¹é›†ç¾¤è®¾ä¸º2ï¼‰ã€‚</li><li>åœ¨ 7.x+ ä¸­ï¼Œä½¿ç”¨ <code>cluster.initial_master_nodes</code> åˆ—å‡ºåˆå§‹ä¸»èŠ‚ç‚¹ï¼Œæ–°é€‰ä¸¾åè®®è‡ªåŠ¨ç¡®ä¿éœ€è¦å¤šæ•°æŠ•ç¥¨ã€‚</li></ul></li><li><strong>æ•ˆæœï¼š</strong> åœ¨ç½‘ç»œåˆ†åŒºæ—¶ï¼Œä»»ä½•èŠ‚ç‚¹ç»„å¦‚æœåŒ…å«çš„ä¸»èŠ‚ç‚¹èµ„æ ¼èŠ‚ç‚¹æ•°ä¸è¶³å¤šæ•°ï¼ˆ&lt;&#x3D; N&#x2F;2ï¼‰ï¼Œå°±æ— æ³•é€‰ä¸¾æ–°ä¸»èŠ‚ç‚¹æˆ–ç»´æŒç°æœ‰ä¸»èŠ‚ç‚¹çŠ¶æ€ï¼ˆå› ä¸ºå®ƒæ— æ³•è·å¾—å¤šæ•°ç¡®è®¤ï¼‰ï¼Œä»è€Œ<strong>æ— æ³•æä¾›æœåŠ¡æˆ–æ¥å—å†™æ“ä½œ</strong>ï¼Œé¿å…äº†â€œåŒä¸»â€å¯¼è‡´çš„è„‘è£‚ã€‚åªæœ‰æ‹¥æœ‰å¤šæ•°èŠ‚ç‚¹çš„åˆ†åŒºæ‰èƒ½æ­£å¸¸è¿ä½œã€‚</li></ul></li></ul><h2 id="ä»€ä¹ˆæ˜¯æ˜ å°„çˆ†ç‚¸ï¼Ÿå¦‚ä½•é¿å…ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯æ˜ å°„çˆ†ç‚¸ï¼Ÿå¦‚ä½•é¿å…ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯æ˜ å°„çˆ†ç‚¸ï¼Ÿå¦‚ä½•é¿å…ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯æ˜ å°„çˆ†ç‚¸ï¼Ÿå¦‚ä½•é¿å…ï¼Ÿ</h2><ul><li><strong>å®šä¹‰ï¼š</strong> å½“ç´¢å¼•ä¸­åŒ…å«å¤§é‡<strong>å”¯ä¸€</strong>å­—æ®µï¼ˆé€šå¸¸æ˜¯åŠ¨æ€æ˜ å°„äº§ç”Ÿçš„ï¼‰æ—¶ï¼Œå¯¼è‡´é›†ç¾¤çŠ¶æ€ï¼ˆCluster Stateï¼‰å˜å¾—æå…¶åºå¤§ï¼ˆå¯èƒ½è¶…è¿‡æ•°ç™¾MBç”šè‡³GBï¼‰ï¼Œä¸»èŠ‚ç‚¹åœ¨å¹¿æ’­å’Œç»´æŒé›†ç¾¤çŠ¶æ€æ—¶å‹åŠ›å·¨å¤§ï¼Œä¸¥é‡å½±å“é›†ç¾¤ç¨³å®šæ€§å’Œæ€§èƒ½ã€‚</li><li><strong>åŸå› ï¼š</strong> å¸¸è§äºç´¢å¼•äº†ç±»ä¼¼æ—¥å¿—æ•°æ®ï¼Œå…¶ä¸­æ¯ä¸ªæ–‡æ¡£éƒ½æœ‰å¤§é‡ä¸åŒçš„ã€ä¸å¯é¢„æµ‹çš„å­—æ®µï¼ˆå¦‚åŒ…å«ç”¨æˆ·IDæˆ–è¯·æ±‚IDçš„å­—æ®µåï¼‰ã€‚</li><li><strong>é¿å…ï¼š</strong><ul><li><strong>ä¸¥æ ¼æ§åˆ¶åŠ¨æ€æ˜ å°„ï¼š</strong> è®¾ç½® <code>&quot;dynamic&quot;: &quot;strict&quot;</code>ï¼ˆç¦æ­¢æœªçŸ¥å­—æ®µï¼‰æˆ– <code>&quot;dynamic&quot;: &quot;false&quot;</code>ï¼ˆå¿½ç•¥æœªçŸ¥å­—æ®µï¼Œä½†ä¸ç´¢å¼•ï¼‰ã€‚ä¼˜å…ˆä½¿ç”¨<strong>æ˜¾å¼æ˜ å°„</strong>ã€‚</li><li><strong>ä½¿ç”¨ <code>flattened</code> ç±»å‹ï¼š</strong> å°†æ•´ä¸ª JSON å¯¹è±¡æ˜ å°„ä¸ºå•ä¸ª <code>flattened</code> å­—æ®µï¼Œé¿å…ä¸ºæ¯ä¸ªå†…éƒ¨é”®åˆ›å»ºç‹¬ç«‹å­—æ®µã€‚é€‚ç”¨äºä¸éœ€è¦ç‹¬ç«‹æŸ¥è¯¢&#x2F;èšåˆçš„å…ƒæ•°æ®ã€‚</li><li><strong>ä½¿ç”¨ <code>object</code>&#x2F;<code>nested</code> ä½†é™åˆ¶æ·±åº¦ï¼š</strong> ä½¿ç”¨ <code>index.mapping.depth.limit</code> æ§åˆ¶åµŒå¥—æ·±åº¦ã€‚</li><li><strong>å­—æ®µåˆ«åï¼š</strong> å¦‚æœä¸åŒæ¥æºçš„å­—æ®µè¯­ä¹‰ç›¸åŒï¼Œç”¨åˆ«åç»Ÿä¸€æ˜ å°„åˆ°ä¸€ä¸ªå­—æ®µã€‚</li><li><strong>åˆç†çš„ç´¢å¼•è®¾è®¡ï¼š</strong> é¿å…å°†å·®å¼‚å·¨å¤§çš„æ–‡æ¡£ç±»å‹å¡è¿›åŒä¸€ä¸ªç´¢å¼•ã€‚</li></ul></li></ul><h2 id="ä»€ä¹ˆæƒ…å†µä¸‹ä½ ä¼šè€ƒè™‘ä½¿ç”¨-keyword-ç±»å‹è€Œä¸æ˜¯-text-ç±»å‹ï¼Ÿ"><a href="#ä»€ä¹ˆæƒ…å†µä¸‹ä½ ä¼šè€ƒè™‘ä½¿ç”¨-keyword-ç±»å‹è€Œä¸æ˜¯-text-ç±»å‹ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæƒ…å†µä¸‹ä½ ä¼šè€ƒè™‘ä½¿ç”¨ keyword ç±»å‹è€Œä¸æ˜¯ text ç±»å‹ï¼Ÿ"></a>ä»€ä¹ˆæƒ…å†µä¸‹ä½ ä¼šè€ƒè™‘ä½¿ç”¨ <code>keyword</code> ç±»å‹è€Œä¸æ˜¯ <code>text</code> ç±»å‹ï¼Ÿ</h2><ul><li>ä½¿ç”¨ <code>keyword</code> ç±»å‹å½“ï¼š<ul><li>éœ€è¦<strong>ç²¾ç¡®åŒ¹é…</strong>ï¼ˆe.g., çŠ¶æ€ç ã€æ ‡ç­¾ã€IDã€æšä¸¾å€¼ï¼‰ã€‚</li><li>éœ€è¦<strong>èšåˆ</strong>ï¼ˆAggregations - Terms, Significant Termsï¼‰ã€‚</li><li>éœ€è¦<strong>æ’åº</strong>ï¼ˆSortingï¼‰ã€‚</li><li>ä¸éœ€è¦å…¨æ–‡åˆ†è¯æœç´¢ã€‚</li></ul></li><li>ä½¿ç”¨ <code>text</code> ç±»å‹å½“ï¼š<ul><li>å­—æ®µå†…å®¹æ˜¯éœ€è¦è¢«<strong>å…¨æ–‡æœç´¢</strong>çš„è‡ªç„¶è¯­è¨€æ–‡æœ¬ï¼ˆe.g., é‚®ä»¶æ­£æ–‡ã€äº§å“æè¿°ï¼‰ã€‚</li><li>éœ€è¦è¢«<strong>åˆ†è¯å™¨</strong>å¤„ç†ï¼ˆTokenization, Normalizationï¼‰ã€‚</li></ul></li><li><strong>æ³¨æ„ï¼š</strong> é€šå¸¸å¯¹åŒä¸€ä¸ªå­—æ®µä¼šåŒæ—¶å®šä¹‰ <code>text</code>ï¼ˆç”¨äºæœç´¢ï¼‰å’Œ <code>keyword</code>ï¼ˆç”¨äºèšåˆ&#x2F;æ’åºï¼‰å¤šå­—æ®µï¼ˆMulti-fieldsï¼‰ã€‚</li></ul><h2 id="ä¸ºä»€ä¹ˆéœ€è¦æ®µåˆå¹¶ï¼ˆSegment-Mergingï¼‰ï¼Ÿå®ƒæœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆéœ€è¦æ®µåˆå¹¶ï¼ˆSegment-Mergingï¼‰ï¼Ÿå®ƒæœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦æ®µåˆå¹¶ï¼ˆSegment Mergingï¼‰ï¼Ÿå®ƒæœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ï¼Ÿ"></a>ä¸ºä»€ä¹ˆéœ€è¦æ®µåˆå¹¶ï¼ˆSegment Mergingï¼‰ï¼Ÿå®ƒæœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ï¼Ÿ</h2><ul><li><strong>ä¸ºä»€ä¹ˆéœ€è¦ï¼š</strong> é¢‘ç¹çš„ refresh ä¼šäº§ç”Ÿå¤§é‡å°çš„ Lucene æ®µã€‚å°æ®µè¿‡å¤šä¼šé™ä½æŸ¥è¯¢æ€§èƒ½ï¼ˆéœ€è¦æ‰“å¼€æ›´å¤šæ–‡ä»¶å¥æŸ„ï¼‰ä¸”å ç”¨æ›´å¤šèµ„æºï¼ˆæ–‡ä»¶æè¿°ç¬¦ã€å†…å­˜ï¼‰ã€‚åˆ é™¤æ“ä½œåªæ˜¯æ ‡è®°æ–‡æ¡£ä¸ºåˆ é™¤ï¼Œç©ºé—´ä¸ä¼šç«‹å³é‡Šæ”¾ã€‚</li><li><strong>ä¼˜ç‚¹ï¼š</strong><ul><li>å‡å°‘æ®µæ•°é‡ï¼Œ<strong>æå‡æŸ¥è¯¢é€Ÿåº¦</strong>ï¼ˆå‡å°‘æ–‡ä»¶æ‰“å¼€å’Œæœç´¢èŒƒå›´ï¼‰ã€‚</li><li><strong>çœŸæ­£åˆ é™¤</strong>è¢«æ ‡è®°åˆ é™¤çš„æ–‡æ¡£ï¼Œ<strong>å›æ”¶ç£ç›˜ç©ºé—´</strong>ã€‚</li><li>åˆå¹¶è¿‡ç¨‹ä¸­ä¼˜åŒ–ç´¢å¼•ç»“æ„ï¼ˆå¦‚å‹ç¼©ï¼‰ã€‚</li></ul></li><li><strong>ç¼ºç‚¹ï¼š</strong><ul><li>æ˜¯ <strong>I&#x2F;O å’Œ CPU å¯†é›†å‹æ“ä½œ</strong>ï¼Œåœ¨åˆå¹¶æœŸé—´å¯èƒ½<strong>æ˜¾è‘—å½±å“é›†ç¾¤æ€§èƒ½</strong>ï¼ˆå†™å…¥å»¶è¿Ÿã€æŸ¥è¯¢å»¶è¿Ÿå¢åŠ ï¼‰ã€‚</li><li>éœ€è¦é¢å¤–çš„ä¸´æ—¶ç£ç›˜ç©ºé—´ã€‚</li></ul></li></ul><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      <categories>
          
          <category> ElasticSearch </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Redis</title>
      <link href="/post/bae4ff13.html"/>
      <url>/post/bae4ff13.html</url>
      
        <content type="html"><![CDATA[<p>æ·±å…¥ç†è§£æ•°æ®ç±»å‹åŠé€‚ç”¨åœºæ™¯ã€æŒä¹…åŒ–æœºåˆ¶ï¼ˆRDB&#x2F;AOFï¼‰ã€å†…å­˜æ·˜æ±°ç­–ç•¥ã€é›†ç¾¤æ¨¡å¼ï¼ˆä¸»ä»ã€å“¨å…µã€Clusterï¼‰ã€åˆ†å¸ƒå¼é”å®ç°ï¼ˆRedlock äº‰è®®åŠæ›¿ä»£æ–¹æ¡ˆï¼‰ã€ç¼“å­˜ç©¿é€&#x2F;å‡»ç©¿&#x2F;é›ªå´©è§£å†³æ–¹æ¡ˆã€ä¸æ•°æ®åº“ä¸€è‡´æ€§ç­–ç•¥ã€‚äº†è§£åº•å±‚æ•°æ®ç»“æ„ï¼ˆSDS, è·³è·ƒè¡¨, å­—å…¸, å‹ç¼©åˆ—è¡¨ç­‰ï¼‰ã€‚</p><h2 id="åŸºç¡€"><a href="#åŸºç¡€" class="headerlink" title="åŸºç¡€"></a>åŸºç¡€</h2><h3 id="Redis-æœ‰å“ªäº›æ•°æ®ç±»å‹ï¼Œåˆ†åˆ«ç”¨äºå“ªäº›åœºæ™¯"><a href="#Redis-æœ‰å“ªäº›æ•°æ®ç±»å‹ï¼Œåˆ†åˆ«ç”¨äºå“ªäº›åœºæ™¯" class="headerlink" title="Redis æœ‰å“ªäº›æ•°æ®ç±»å‹ï¼Œåˆ†åˆ«ç”¨äºå“ªäº›åœºæ™¯"></a>Redis æœ‰å“ªäº›æ•°æ®ç±»å‹ï¼Œåˆ†åˆ«ç”¨äºå“ªäº›åœºæ™¯</h3><img src="/post/bae4ff13/image-20251103210359642.png" class="" title="image-20251103210359642"><p><strong>Stringï¼ˆå­—ç¬¦ä¸²ï¼‰</strong></p><ul><li><strong>æè¿°</strong>ï¼šæœ€åŸºæœ¬çš„æ•°æ®ç±»å‹ï¼Œå¯å­˜å‚¨æ–‡æœ¬ã€äºŒè¿›åˆ¶æ•°æ®ï¼ˆå¦‚å›¾ç‰‡ï¼‰ã€æ•°å­—ï¼ˆæ•´æ•°æˆ–æµ®ç‚¹æ•°ï¼‰ã€‚</li><li><strong>å…¸å‹åœºæ™¯</strong>ï¼š<ul><li><strong>ç¼“å­˜</strong>ï¼šå­˜å‚¨ç”¨æˆ·ä¼šè¯ä¿¡æ¯ï¼ˆSessionï¼‰ã€HTMLç‰‡æ®µã€APIå“åº”ç­‰ã€‚</li><li><strong>è®¡æ•°å™¨</strong>ï¼šç½‘ç«™è®¿é—®é‡ã€ç‚¹èµæ•°ã€åº“å­˜æ•°é‡ï¼ˆåˆ©ç”¨ <code>INCR/DECR</code>ï¼‰ã€‚</li><li><strong>åˆ†å¸ƒå¼é”</strong>ï¼šé€šè¿‡ <code>SET key value NX EX</code> å®ç°ç®€å•é”ã€‚</li><li><strong>ä½æ“ä½œï¼ˆBitmapsï¼‰</strong>ï¼šåˆ©ç”¨ <code>SETBIT</code>, <code>GETBIT</code>, <code>BITCOUNT</code> ç­‰å‘½ä»¤å®ç°ç”¨æˆ·åœ¨çº¿çŠ¶æ€ã€ç­¾åˆ°è®°å½•ã€å¸ƒéš†è¿‡æ»¤å™¨ç­‰ï¼ˆæœ¬è´¨ä¸Šæ˜¯æ“ä½œå­—ç¬¦ä¸²çš„ä½ï¼‰ã€‚</li></ul></li></ul><p><strong>Listï¼ˆåˆ—è¡¨ï¼‰</strong></p><ul><li><strong>æè¿°</strong>ï¼šæœ‰åºçš„å­—ç¬¦ä¸²é›†åˆï¼Œå…ƒç´ å¯é‡å¤ã€‚æŒ‰ç…§æ’å…¥é¡ºåºæ’åºï¼Œå¯åœ¨å¤´éƒ¨(<code>LPUSH</code>)æˆ–å°¾éƒ¨(<code>RPUSH</code>)æ’å…¥å…ƒç´ ã€‚</li><li><strong>å…¸å‹åœºæ™¯</strong>ï¼š<ul><li><strong>æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆç®€å•ç‰ˆï¼‰</strong>ï¼šç”Ÿäº§è€… <code>LPUSH</code> æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€… <code>RPOP</code>&#x2F;<code>BRPOP</code> æ¶ˆæ¯ï¼ˆFIFOï¼‰ã€‚ä¹Ÿå¯å®ç°æ ˆï¼ˆLIFOï¼‰ã€‚</li><li><strong>æœ€æ–°æ¶ˆæ¯&#x2F;åŠ¨æ€æµï¼ˆTimelineï¼‰</strong>ï¼š<code>LPUSH</code> æœ€æ–°å†…å®¹ï¼Œ<code>LRANGE</code> è·å–æœ€è¿‘ N æ¡ã€‚</li><li><strong>è®°å½•æ“ä½œæ—¥å¿—</strong>ã€‚</li></ul></li></ul><p><strong>Setï¼ˆé›†åˆï¼‰</strong></p><ul><li><strong>æè¿°</strong>ï¼šæ— åºçš„å­—ç¬¦ä¸²é›†åˆï¼Œå…ƒç´ <strong>ä¸å¯é‡å¤</strong>ï¼Œæ”¯æŒé›†åˆè¿ç®—ï¼ˆäº¤é›†ã€å¹¶é›†ã€å·®é›†ï¼‰ã€‚</li><li><strong>å…¸å‹åœºæ™¯</strong>ï¼š<ul><li><strong>æ ‡ç­¾ï¼ˆTaggingï¼‰</strong>ï¼šå­˜å‚¨æ–‡ç« ã€å•†å“çš„æ ‡ç­¾ï¼ˆè‡ªåŠ¨å»é‡ï¼‰ã€‚</li><li><strong>å…±åŒå…³æ³¨&#x2F;å¥½å‹ï¼ˆç¤¾äº¤å…³ç³»ï¼‰</strong>ï¼šåˆ©ç”¨ <code>SINTER</code> æ±‚äº¤é›†ã€‚</li></ul></li></ul><p><strong>Hashï¼ˆå“ˆå¸Œ &#x2F; å­—å…¸ï¼‰</strong></p><ul><li><strong>æè¿°</strong>ï¼šé”®å€¼å¯¹é›†åˆï¼Œç”¨äºå­˜å‚¨å¯¹è±¡ï¼ˆå¦‚ç”¨æˆ·ä¿¡æ¯ï¼‰ã€‚<code>field-value</code> æ˜ å°„è¡¨ã€‚</li><li><strong>å…¸å‹åœºæ™¯</strong>ï¼š<ul><li><strong>å­˜å‚¨å¯¹è±¡</strong>ï¼šç”¨æˆ·ä¿¡æ¯ï¼ˆ<code>user:1000 &#123;name: &quot;Alice&quot;, age: 30, email: ...&#125;</code>ï¼‰ã€å•†å“è¯¦æƒ…ã€é…ç½®é¡¹ã€‚</li><li><strong>é¢‘ç¹ä¿®æ”¹éƒ¨åˆ†å±æ€§çš„å¯¹è±¡</strong>ï¼šå¦‚åªæ›´æ–°ç”¨æˆ·ç§¯åˆ†ï¼Œé¿å…è¯»å–æ•´ä¸ªå­—ç¬¦ä¸²å†å†™å›ã€‚</li></ul></li></ul><p><strong>Sorted Setï¼ˆæœ‰åºé›†åˆ &#x2F; ZSetï¼‰</strong></p><ul><li><strong>æè¿°</strong>ï¼šSet çš„å‡çº§ç‰ˆï¼Œå…ƒç´ <strong>å”¯ä¸€</strong>ï¼Œä½†æ¯ä¸ªå…ƒç´ å…³è”ä¸€ä¸ª <code>score</code>ï¼ˆåˆ†æ•°ï¼‰ã€‚å…ƒç´ <strong>æŒ‰ <code>score</code> æ’åº</strong>ï¼ˆä»å°åˆ°å¤§ï¼‰ã€‚<code>score</code> å¯ç›¸åŒï¼Œæ­¤æ—¶æŒ‰å…ƒç´ å­—å…¸åºæ’åºã€‚</li><li><strong>å…¸å‹åœºæ™¯</strong>ï¼š<ul><li><strong>æ’è¡Œæ¦œ</strong>ï¼šæ¸¸æˆç§¯åˆ†æ¦œï¼ˆ<code>score</code> ä¸ºç§¯åˆ†ï¼‰ã€çƒ­æœæ¦œï¼ˆ<code>score</code> ä¸ºçƒ­åº¦å€¼ï¼‰ã€‚<code>ZREVRANGE</code> è·å– Top Nã€‚</li></ul></li></ul><p><strong>Bitmaps</strong></p><ul><li><strong>æœ¬è´¨</strong>ï¼šString ç±»å‹çš„ä½æ“ä½œæ‰©å±•ã€‚</li><li><strong>åœºæ™¯</strong>ï¼šæçœç©ºé—´çš„å¸ƒå°”å€¼ç»Ÿè®¡ï¼ˆç”¨æˆ·åœ¨çº¿çŠ¶æ€ã€æ¯æ—¥ç­¾åˆ°ã€æ´»è·ƒç”¨æˆ·ç»Ÿè®¡ã€å¸ƒéš†è¿‡æ»¤å™¨ï¼‰ã€‚</li></ul><p><strong>HyperLogLogï¼ˆHLLï¼‰</strong></p><ul><li><strong>æœ¬è´¨</strong>ï¼šç‰¹æ®Šçš„ String ç±»å‹ã€‚</li><li><strong>åœºæ™¯</strong>ï¼šæµ·é‡æ•°æ®çš„å»é‡è®¡æ•°ï¼ˆç½‘ç«™ UVã€ç‹¬ç«‹ IP è®¿é—®æ•°ã€æœç´¢è¯å»é‡ç»Ÿè®¡ï¼‰ï¼Œä¸éœ€è¦ç²¾ç¡®ç»“æœæ—¶ã€‚</li></ul><p><strong>Geospatialï¼ˆåœ°ç†ç©ºé—´ï¼‰</strong></p><ul><li><strong>æœ¬è´¨</strong>ï¼šåŸºäº Sorted Setï¼ˆZSetï¼‰å®ç°ï¼Œ<code>member</code> æ˜¯ä½ç½®æ ‡è¯†ç¬¦ï¼Œ<code>score</code> æ˜¯ç»åº¦+çº¬åº¦ç¼–ç æˆçš„ 52 ä½æ•´æ•°ï¼ˆGeoHashï¼‰ã€‚</li><li><strong>åœºæ™¯</strong>ï¼šé™„è¿‘çš„äºº&#x2F;åœ°ç‚¹ï¼ˆå¦‚æ»´æ»´æ‰“è½¦ï¼‰ã€åŸºäºä½ç½®çš„æœåŠ¡ï¼ˆLBSï¼‰ã€åœ°ç†å›´æ ã€‚</li></ul><p><strong>Streams</strong></p><ul><li><strong>æè¿°</strong>ï¼šRedis 5.0 å¼•å…¥ã€‚ä¸º<strong>æ¶ˆæ¯é˜Ÿåˆ—</strong>è®¾è®¡çš„åŠŸèƒ½æ›´å®Œå–„çš„æ•°æ®ç±»å‹ã€‚ç±»ä¼¼ Kafka æˆ– RabbitMQ çš„ topicã€‚</li><li><strong>åœºæ™¯</strong>ï¼š<strong>å¯é çš„æ¶ˆæ¯é˜Ÿåˆ—</strong>ã€äº‹ä»¶æº¯æºï¼ˆEvent Sourcingï¼‰ã€å®æ—¶æ•°æ®ç®¡é“ã€‚</li></ul><h3 id="Redisæ•°æ®ç±»å‹åº•å±‚çš„æ•°æ®ç»“æ„"><a href="#Redisæ•°æ®ç±»å‹åº•å±‚çš„æ•°æ®ç»“æ„" class="headerlink" title="Redisæ•°æ®ç±»å‹åº•å±‚çš„æ•°æ®ç»“æ„"></a>Redisæ•°æ®ç±»å‹åº•å±‚çš„æ•°æ®ç»“æ„</h3><table><thead><tr><th align="left">æ•°æ®ç±»å‹</th><th align="left">åº•å±‚æ•°æ®ç»“æ„ï¼ˆå†å²&#x2F;å…¶ä»–å®ç°ï¼‰</th><th align="left">åº•å±‚æ•°æ®ç»“æ„ï¼ˆæœ€æ–°è¶‹åŠ¿ï¼‰</th></tr></thead><tbody><tr><td align="left"><strong>Stringï¼ˆå­—ç¬¦ä¸²ï¼‰</strong></td><td align="left">int, embstr, raw</td><td align="left">(é€šå¸¸ä¸å˜)</td></tr><tr><td align="left"><strong>Listï¼ˆåˆ—è¡¨ï¼‰</strong></td><td align="left">QuickList (ç”±LinkedListå’ŒZiplistç»„æˆ)</td><td align="left">QuickList (èŠ‚ç‚¹å†…éƒ¨ä½¿ç”¨Listpack)</td></tr><tr><td align="left"><strong>Hashï¼ˆå“ˆå¸Œï¼‰</strong></td><td align="left">ZipList, HashTable</td><td align="left"><strong>Listpack</strong>, HashTable</td></tr><tr><td align="left"><strong>Setï¼ˆé›†åˆï¼‰</strong></td><td align="left">IntSet, HashTable</td><td align="left">(é€šå¸¸ä¸å˜)</td></tr><tr><td align="left"><strong>ZSetï¼ˆæœ‰åºé›†åˆï¼‰</strong></td><td align="left">ZipList, SkipList + HashTable</td><td align="left"><strong>Listpack</strong>, SkipList + HashTable</td></tr><tr><td align="left"><strong>Streamï¼ˆæµï¼‰</strong></td><td align="left">Rax (åŸºæ•°æ ‘) + Listpack</td><td align="left">(ä½¿ç”¨Listpackå­˜å‚¨æ¶ˆæ¯å†…å®¹)</td></tr></tbody></table><p>Listpack è¢«è®¾è®¡ç”¨æ¥æ›¿ä»£ <strong>Ziplistï¼ˆå‹ç¼©åˆ—è¡¨ï¼‰</strong>ï¼Œä¸»è¦ä¸ºäº†è§£å†³Ziplistçš„<strong>è¿é”æ›´æ–°é—®é¢˜</strong>ã€‚</p><ul><li><strong>Ziplistçš„ç¼ºé™·</strong>ï¼šZiplistä¸­æ¯ä¸ªå…ƒç´ éƒ½è®°å½•äº†<strong>å‰ä¸€ä¸ªå…ƒç´ çš„é•¿åº¦</strong>ã€‚å½“åœ¨ä¸€ä¸ªå…ƒç´ å‰æ’å…¥ä¸€ä¸ªæ–°å…ƒç´ ï¼Œå¯¼è‡´è¯¥å…ƒç´ çš„â€å‰ä¸€ä¸ªå…ƒç´ é•¿åº¦â€å­—æ®µéœ€è¦æ‰©å®¹æ—¶ï¼Œå®ƒè‡ªå·±æœ¬èº«çš„å¤§å°ä¹Ÿä¼šæ”¹å˜ã€‚è¿™å¯èƒ½ä¼šå¼•å‘é“¾å¼ååº”ï¼Œå¯¼è‡´åç»­å¤šä¸ªå…ƒç´ éƒ½éœ€è¦è¢«æ›´æ–°ï¼Œåœ¨æœ€åæƒ…å†µä¸‹ï¼Œä¸€æ¬¡æ’å…¥æ“ä½œå¯èƒ½éœ€è¦é‡æ–°åˆ†é…æ•´ä¸ªZiplistçš„å†…å­˜ï¼Œæ€§èƒ½æŸè€—å¾ˆå¤§ã€‚</li><li><strong>Listpackçš„è§£å†³æ–¹æ¡ˆ</strong>ï¼šListpackç§»é™¤äº†å¯¹å‰ä¸€ä¸ªå…ƒç´ é•¿åº¦çš„ä¾èµ–ã€‚æ¯ä¸ªå…ƒç´ åªè®°å½•<strong>è‡ªèº«çš„ç¼–ç ã€å®é™…æ•°æ®å’Œå½“å‰å…ƒç´ çš„æ€»é•¿åº¦</strong>ï¼Œå¹¶ä¸”è¿™ä¸ªæ€»é•¿åº¦ä¿¡æ¯è¢«æ”¾åœ¨äº†å…ƒç´ çš„<strong>å°¾éƒ¨</strong>ã€‚è¿™ä¸ªå·§å¦™çš„è®¾è®¡ä½¿å¾—ä»»ä½•å…ƒç´ çš„ä¿®æ”¹éƒ½åªå½±å“è‡ªèº«ï¼Œå®Œå…¨<strong>é¿å…äº†è¿é”æ›´æ–°</strong>ã€‚</li></ul><h3 id="Redisä¸ºä»€ä¹ˆå¿«"><a href="#Redisä¸ºä»€ä¹ˆå¿«" class="headerlink" title="Redisä¸ºä»€ä¹ˆå¿«"></a>Redisä¸ºä»€ä¹ˆå¿«</h3><p>å¯¹äºRedisçš„é«˜æ€§èƒ½è®¾è®¡ï¼Œæˆ‘çš„ç†è§£ä¸»è¦å¾—ç›Šäºä»¥ä¸‹å‡ ç‚¹ï¼š</p><ul><li><p><strong>å†…å­˜æ“ä½œ</strong>ï¼šRedisæ•°æ®å­˜å‚¨åœ¨å†…å­˜ï¼Œç›¸æ¯”äºç£ç›˜æ•°æ®åº“ï¼Œå‡å°‘äº†IOå¼€é”€</p></li><li><p><strong>é«˜æ•ˆçš„æ•°æ®ç»“æ„</strong>ï¼šRedisé’ˆå¯¹ä¸åŒåœºæ™¯è®¾è®¡äº†ä¸åŒçš„æ•°æ®ç»“æ„ï¼Œä¼˜åŒ–äº†ç©ºé—´å’Œè®¿é—®æ•ˆç‡</p></li><li><p><strong>å•çº¿ç¨‹</strong>ï¼šRedisä½¿ç”¨å•çº¿ç¨‹å¤„ç†å‘½ä»¤ï¼Œé¿å…äº†å¤šçº¿ç¨‹ä¹‹é—´çš„ç«äº‰å’Œä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€</p></li><li><p><strong>IOå¤šè·¯å¤ç”¨</strong>ï¼šRedisåŸºäºepoll&#x2F;kqueueå®ç°äº†éé˜»å¡çš„ç½‘ç»œæ¨¡å‹ï¼Œé€šè¿‡äº‹ä»¶æœºåˆ¶å¾ªç¯å¤„ç†è¯·æ±‚</p></li></ul><img src="/post/bae4ff13/why-redis-so-fast-TbWX24ja.png" class=""><h3 id="Rediså•çº¿ç¨‹å¤„ç†IOè¯·æ±‚æ€§èƒ½ç“¶é¢ˆ"><a href="#Rediså•çº¿ç¨‹å¤„ç†IOè¯·æ±‚æ€§èƒ½ç“¶é¢ˆ" class="headerlink" title="Rediså•çº¿ç¨‹å¤„ç†IOè¯·æ±‚æ€§èƒ½ç“¶é¢ˆ"></a>Rediså•çº¿ç¨‹å¤„ç†IOè¯·æ±‚æ€§èƒ½ç“¶é¢ˆ</h3><p>ä¸»è¦åŒ…æ‹¬2ä¸ªæ–¹é¢ï¼š</p><p> 1ã€ä»»æ„ä¸€ä¸ªè¯·æ±‚åœ¨serverä¸­ä¸€æ—¦å‘ç”Ÿè€—æ—¶ï¼Œéƒ½ä¼šå½±å“æ•´ä¸ªserverçš„æ€§èƒ½ï¼Œä¹Ÿå°±æ˜¯è¯´åé¢çš„è¯·æ±‚éƒ½è¦ç­‰å‰é¢è¿™ä¸ªè€—æ—¶è¯·æ±‚å¤„ç†å®Œæˆï¼Œè‡ªå·±æ‰èƒ½è¢«å¤„ç†åˆ°ã€‚è€—æ—¶çš„æ“ä½œåŒ…æ‹¬ä»¥ä¸‹å‡ ç§ï¼š </p><ul><li><p>æ“ä½œbigkeyï¼šå†™å…¥ä¸€ä¸ªbigkeyåœ¨åˆ†é…å†…å­˜æ—¶éœ€è¦æ¶ˆè€—æ›´å¤šçš„æ—¶é—´ï¼ŒåŒæ ·ï¼Œåˆ é™¤bigkeyé‡Šæ”¾å†…å­˜åŒæ ·ä¼šäº§ç”Ÿè€—æ—¶ï¼›</p></li><li><p>ä½¿ç”¨å¤æ‚åº¦è¿‡é«˜çš„å‘½ä»¤ï¼šä¾‹å¦‚SORT&#x2F;SUNION&#x2F;ZUNIONSTOREï¼Œæˆ–è€…O(N)å‘½ä»¤ï¼Œä½†æ˜¯Nå¾ˆå¤§ï¼Œä¾‹å¦‚lrange key 0 -1ä¸€æ¬¡æŸ¥è¯¢å…¨é‡æ•°æ®ï¼›</p></li><li><p>å¤§é‡keyé›†ä¸­è¿‡æœŸï¼šRedisçš„è¿‡æœŸæœºåˆ¶ä¹Ÿæ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œçš„ï¼Œå¤§é‡keyé›†ä¸­è¿‡æœŸä¼šå¯¼è‡´å¤„ç†ä¸€ä¸ªè¯·æ±‚æ—¶ï¼Œè€—æ—¶éƒ½åœ¨åˆ é™¤è¿‡æœŸkeyï¼Œè€—æ—¶å˜é•¿ï¼›</p></li><li><p>æ·˜æ±°ç­–ç•¥ï¼šæ·˜æ±°ç­–ç•¥ä¹Ÿæ˜¯åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œçš„ï¼Œå½“å†…å­˜è¶…è¿‡Rediså†…å­˜ä¸Šé™åï¼Œæ¯æ¬¡å†™å…¥éƒ½éœ€è¦æ·˜æ±°ä¸€äº›keyï¼Œä¹Ÿä¼šé€ æˆè€—æ—¶å˜é•¿ï¼› </p></li><li><p>AOFåˆ·ç›˜å¼€å¯alwaysæœºåˆ¶ï¼šæ¯æ¬¡å†™å…¥éƒ½éœ€è¦æŠŠè¿™ä¸ªæ“ä½œåˆ·åˆ°ç£ç›˜ï¼Œå†™ç£ç›˜çš„é€Ÿåº¦è¿œæ¯”å†™å†…å­˜æ…¢ï¼Œä¼šæ‹–æ…¢Redisçš„æ€§èƒ½ï¼› </p></li><li><p>ä¸»ä»å…¨é‡åŒæ­¥ç”ŸæˆRDBï¼šè™½ç„¶é‡‡ç”¨forkå­è¿›ç¨‹ç”Ÿæˆæ•°æ®å¿«ç…§ï¼Œä½†forkè¿™ä¸€ç¬é—´ä¹Ÿæ˜¯ä¼šé˜»å¡æ•´ä¸ªçº¿ç¨‹çš„ï¼Œå®ä¾‹è¶Šå¤§ï¼Œé˜»å¡æ—¶é—´è¶Šä¹…ï¼›</p></li></ul><p>2ã€å¹¶å‘é‡éå¸¸å¤§æ—¶ï¼Œå•çº¿ç¨‹è¯»å†™å®¢æˆ·ç«¯IOæ•°æ®å­˜åœ¨æ€§èƒ½ç“¶é¢ˆï¼Œè™½ç„¶é‡‡ç”¨IOå¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œä½†æ˜¯è¯»å†™å®¢æˆ·ç«¯æ•°æ®ä¾æ—§æ˜¯åŒæ­¥IOï¼Œåªèƒ½å•çº¿ç¨‹ä¾æ¬¡è¯»å–å®¢æˆ·ç«¯çš„æ•°æ®ï¼Œæ— æ³•åˆ©ç”¨åˆ°CPUå¤šæ ¸ã€‚ </p><p>é’ˆå¯¹é—®é¢˜1ï¼Œä¸€æ–¹é¢éœ€è¦ä¸šåŠ¡äººå‘˜å»è§„é¿ï¼Œä¸€æ–¹é¢Redisåœ¨4.0æ¨å‡ºäº†lazy-freeæœºåˆ¶ï¼ŒæŠŠbigkeyé‡Šæ”¾å†…å­˜çš„è€—æ—¶æ“ä½œæ”¾åœ¨äº†å¼‚æ­¥çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œé™ä½å¯¹ä¸»çº¿ç¨‹çš„å½±å“ã€‚ </p><p>é’ˆå¯¹é—®é¢˜2ï¼ŒRedisåœ¨6.0æ¨å‡ºäº†å¤šçº¿ç¨‹ï¼Œå¯ä»¥åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹åˆ©ç”¨CPUå¤šæ ¸å¤šçº¿ç¨‹è¯»å†™å®¢æˆ·ç«¯æ•°æ®ï¼Œè¿›ä¸€æ­¥æå‡serveræ€§èƒ½ï¼Œå½“ç„¶ï¼Œåªæ˜¯é’ˆå¯¹å®¢æˆ·ç«¯çš„è¯»å†™æ˜¯å¹¶è¡Œçš„ï¼Œæ¯ä¸ªå‘½ä»¤çš„çœŸæ­£æ“ä½œä¾æ—§æ˜¯å•çº¿ç¨‹çš„ã€‚</p><h3 id="Rediså’ŒMySQLçš„åŒºåˆ«"><a href="#Rediså’ŒMySQLçš„åŒºåˆ«" class="headerlink" title="Rediså’ŒMySQLçš„åŒºåˆ«"></a>Rediså’ŒMySQLçš„åŒºåˆ«</h3><table><thead><tr><th></th><th>Redis</th><th>MySQL</th></tr></thead><tbody><tr><td>æ•°æ®ç»“æ„</td><td>éç»“æ„åŒ–</td><td>ç»“æ„åŒ–</td></tr><tr><td>æŒä¹…åŒ–</td><td>å¯é€‰æŒä¹…åŒ–</td><td>é»˜è®¤æŒä¹…åŒ–</td></tr><tr><td>äº‹åŠ¡æ”¯æŒ</td><td>ç®€å•æ”¯æŒ</td><td>æ”¯æŒå®Œæ•´çš„ACID</td></tr><tr><td>æ‰©å±•æ€§</td><td>é€šè¿‡åˆ†ç‰‡æ°´å¹³æ‰©å±•</td><td>å¤æ‚ï¼Œéœ€åˆ†åº“åˆ†è¡¨æˆ–ä¸­é—´ä»¶</td></tr><tr><td>æ•°æ®ä¸€è‡´æ€§</td><td>æœ€ç»ˆä¸€è‡´æ€§</td><td>å¼ºä¸€è‡´æ€§</td></tr></tbody></table><p>æ€»ç»“ï¼š</p><ul><li>å½“éœ€è¦å¤æ‚æŸ¥è¯¢å’Œäº‹åŠ¡æ”¯æŒï¼Œå¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚è¾ƒé«˜ï¼Œéœ€è¦é•¿æœŸæŒä¹…åŒ–å­˜å‚¨çš„åœºæ™¯ï¼Œé€‰æ‹©MySQL</li><li>å½“éœ€è¦è¶…é«˜æ€§èƒ½å’Œçµæ´»æ•°æ®ç±»å‹ï¼Œå¯¹æ•°æ®çš„ä¸€è‡´æ€§è¦æ±‚ä¸é‚£ä¹ˆé«˜ï¼Œä¸”å®¹å¿ä¸€å®šçš„æ•°æ®ä¸¢å¤±çš„æƒ…å†µä¸‹ï¼Œé€‰æ‹©Redis</li></ul><h3 id="Rediså’Œmemchahedçš„åŒºåˆ«"><a href="#Rediså’Œmemchahedçš„åŒºåˆ«" class="headerlink" title="Rediså’Œmemchahedçš„åŒºåˆ«"></a>Rediså’Œmemchahedçš„åŒºåˆ«</h3><table><thead><tr><th></th><th>Redis</th><th>Memcached</th></tr></thead><tbody><tr><td>æ•°æ®ç±»å‹</td><td>ä¸°å¯Œçš„æ•°æ®ç±»å‹ï¼šstringã€hashã€listç­‰</td><td>åªæ”¯æŒstring</td></tr><tr><td>æŒä¹…åŒ–</td><td>æ”¯æŒï¼ˆRDBã€AOFï¼‰</td><td>ä¸æ”¯æŒ</td></tr><tr><td>äº‹åŠ¡</td><td>ç®€å•æ”¯æŒï¼ˆMULTI&#x2F;EXECï¼‰</td><td>ä¸æ”¯æŒ</td></tr><tr><td>åˆ†å¸ƒå¼</td><td>æ”¯æŒï¼Œé›†ç¾¤è‡ªåŠ¨åˆ†ç‰‡</td><td>ä¾èµ–å®¢æˆ·ç«¯ä¸€è‡´æ€§å“ˆå¸Œæˆ–ç¬¬ä¸‰æ–¹å·¥å…·å®ç°åˆ†å¸ƒå¼</td></tr><tr><td>å‘½ä»¤</td><td>æ”¯æŒä¸°å¯Œçš„å‘½ä»¤</td><td>ä»…æ”¯æŒSETã€GETã€ADDã€DELTEç­‰åŸºç¡€æ“ä½œ</td></tr><tr><td>å†…å­˜å ç”¨</td><td>å¤æ‚æ•°æ®ç»“æ„å¯èƒ½å¯¼è‡´å†…å­˜æ¶ˆè€—è¾ƒé«˜</td><td>å†…å­˜åˆ©ç”¨ç‡é«˜ï¼Œä½†çµæ´»æ€§è¾ƒä½</td></tr></tbody></table><p>æ€»ç»“ï¼š</p><ul><li>éœ€è¦å¤æ‚æ•°æ®ç»“æ„ã€æŒä¹…åŒ–ã€äº‹åŠ¡æ”¯æŒå’Œé«˜å¯ç”¨æ€§çš„åœºæ™¯ï¼Œé€‰æ‹©Redis</li><li>è¿½æ±‚æè‡´çš„æ€§èƒ½å’Œç®€å•æ€§ï¼Œæ•°æ®ç»“æ„ç®€å•ä¸”æ— éœ€æŒä¹…åŒ–çš„åœºæ™¯ï¼Œå¯ä»¥é€‰æ‹©Memcached</li></ul><h2 id="çº¿ç¨‹æ¨¡å‹"><a href="#çº¿ç¨‹æ¨¡å‹" class="headerlink" title="çº¿ç¨‹æ¨¡å‹"></a>çº¿ç¨‹æ¨¡å‹</h2><h3 id="Redis-IOå¤šè·¯å¤ç”¨"><a href="#Redis-IOå¤šè·¯å¤ç”¨" class="headerlink" title="Redis IOå¤šè·¯å¤ç”¨"></a>Redis IOå¤šè·¯å¤ç”¨</h3><p>å¸¸è§çš„ I&#x2F;O å¤šè·¯å¤ç”¨æœºåˆ¶åŒ…æ‹¬ selectã€poll å’Œ epoll ç­‰ã€‚</p><table><thead><tr><th>ç‰¹æ€§</th><th><code>select</code></th><th><code>poll</code></th><th><code>epoll</code></th></tr></thead><tbody><tr><td>æ–‡ä»¶æè¿°ç¬¦é™åˆ¶</td><td>å— <code>FD_SETSIZE</code> é™åˆ¶</td><td>æ— é™åˆ¶</td><td>æ— é™åˆ¶</td></tr><tr><td>æ—¶é—´å¤æ‚åº¦</td><td>O(n)</td><td>O(n)</td><td>O(1)</td></tr><tr><td>æ•°æ®å¤åˆ¶</td><td>éœ€è¦</td><td>éœ€è¦</td><td>ä¸éœ€è¦</td></tr><tr><td>å·¥ä½œæ–¹å¼</td><td>çº¿æ€§æ‰«æ</td><td>çº¿æ€§æ‰«æ</td><td>äº‹ä»¶é€šçŸ¥</td></tr><tr><td>å†…æ ¸æ”¯æŒ</td><td>æ‰€æœ‰ UNIX ç³»ç»Ÿ</td><td>æ‰€æœ‰ UNIX ç³»ç»Ÿ</td><td>Linux 2.6 åŠä»¥ä¸Šç‰ˆæœ¬</td></tr><tr><td>é€‚ç”¨åœºæ™¯</td><td>å°‘é‡è¿æ¥</td><td>ä¸­ç­‰è¿æ¥</td><td>å¤§é‡å¹¶å‘è¿æ¥</td></tr></tbody></table><p><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20240918114125.png" alt="æœ‰ç›å…ˆç”Ÿï¼šIO å¤šè·¯å¤ç”¨"></p><h3 id="Redis-6-0-å¤šçº¿ç¨‹"><a href="#Redis-6-0-å¤šçº¿ç¨‹" class="headerlink" title="Redis 6.0 å¤šçº¿ç¨‹"></a>Redis 6.0 å¤šçº¿ç¨‹</h3><p>åœ¨ Redis 6.0 ä¸­ï¼Œå¤šçº¿ç¨‹ä¸»è¦ç”¨æ¥å¤„ç†ç½‘ç»œ IO æ“ä½œï¼Œå‘½ä»¤è§£æå’Œæ‰§è¡Œä»ç„¶æ˜¯å•çº¿ç¨‹å®Œæˆï¼Œè¿™æ ·æ—¢å¯ä»¥å‘æŒ¥å¤šæ ¸ CPU çš„ä¼˜åŠ¿ï¼Œåˆèƒ½é¿å…é”å’Œä¸Šä¸‹æ–‡åˆ‡æ¢å¸¦æ¥çš„æ€§èƒ½æŸè€—ã€‚</p><p><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-b7b24e25-d2dc-4457-994f-95bdb3674b8e.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šRedis6.0å¤šçº¿ç¨‹"></p><h2 id="ç¼“å­˜"><a href="#ç¼“å­˜" class="headerlink" title="ç¼“å­˜"></a>ç¼“å­˜</h2><h3 id="ä»€ä¹ˆæ˜¯ç¼“å­˜ç©¿é€-é›ªå´©-å‡»ç©¿ï¼Œå¯¹åº”çš„è§£å†³æ–¹æ¡ˆæ˜¯ä»€ä¹ˆ"><a href="#ä»€ä¹ˆæ˜¯ç¼“å­˜ç©¿é€-é›ªå´©-å‡»ç©¿ï¼Œå¯¹åº”çš„è§£å†³æ–¹æ¡ˆæ˜¯ä»€ä¹ˆ" class="headerlink" title="ä»€ä¹ˆæ˜¯ç¼“å­˜ç©¿é€&#x2F;é›ªå´©&#x2F;å‡»ç©¿ï¼Œå¯¹åº”çš„è§£å†³æ–¹æ¡ˆæ˜¯ä»€ä¹ˆ"></a>ä»€ä¹ˆæ˜¯ç¼“å­˜ç©¿é€&#x2F;é›ªå´©&#x2F;å‡»ç©¿ï¼Œå¯¹åº”çš„è§£å†³æ–¹æ¡ˆæ˜¯ä»€ä¹ˆ</h3><p><strong>ç¼“å­˜ç©¿é€</strong>æ˜¯æŒ‡æŸ¥è¯¢æ•°æ®åº“ä¸­ä¸å­˜åœ¨çš„æ•°æ®ï¼Œå¯¼è‡´è¯·æ±‚æ¯æ¬¡éƒ½ç©¿è¿‡ç¼“å­˜æŸ¥è¯¢æ•°æ®åº“ã€‚</p><p>è§£å†³æ–¹æ¡ˆï¼š</p><ul><li><strong>å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆBloom Filterï¼‰</strong></li></ul><p>æœåŠ¡å¯åŠ¨æ—¶åŠ è½½å…¨é‡æœ‰æ•ˆkeyï¼Œæ ‡è®°æ•°æ®æ˜¯å¦å­˜åœ¨ï¼›æ–°å¢æ•°æ®æ—¶åŒæ­¥æ›´æ–°è¿‡æ»¤å™¨</p><p>ç¼ºç‚¹ï¼šå­˜åœ¨ä¸€å®šçš„è¯¯åˆ¤ç‡</p><ul><li><strong>ç¼“å­˜ç©ºå€¼</strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">getData</span><span class="params">(String key)</span> &#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> redis.get(key);</span><br><span class="line">    <span class="keyword">if</span> (value != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (value <span class="keyword">instanceof</span> NullValue) &#123; <span class="comment">// ç©ºå€¼æ ‡è®°</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    value = db.query(key);</span><br><span class="line">    <span class="keyword">if</span> (value == <span class="literal">null</span>) &#123;</span><br><span class="line">        redis.setex(key, <span class="number">300</span>, <span class="keyword">new</span> <span class="title class_">NullValue</span>()); <span class="comment">// ç¼“å­˜ç©ºå€¼5åˆ†é’Ÿ</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        redis.setex(key, <span class="number">3600</span>, value); <span class="comment">// æ­£å¸¸ç¼“å­˜1å°æ—¶</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¢å¼ºè¯·æ±‚å‚æ•°çš„å¤æ‚åº¦ï¼Œé¿å…è¢«çŒœæµ‹ï¼ŒåŒæ—¶åšå¥½æ•°æ®çš„åŸºç¡€æ ¼å¼æ ¡éªŒ</li></ul><p><strong>ç¼“å­˜é›ªå´©</strong>æ˜¯æŒ‡<strong>å¤§é‡key</strong>åŒæ—¶å¤±æ•ˆï¼Œå¯¼è‡´å¤§é‡è¯·æ±‚éƒ½å»æŸ¥è¯¢æ•°æ®åº“ï¼Œé€ æˆæ•°æ®åº“å‹åŠ›éª¤å¢ã€‚</p><p>è§£å†³æ–¹æ¡ˆï¼š</p><ul><li><strong>å·®å¼‚åŒ–è¿‡æœŸæ—¶é—´</strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŸºç¡€è¿‡æœŸæ—¶é—´ï¼Œ1å°æ—¶</span></span><br><span class="line"><span class="type">int</span> <span class="variable">baseExpire</span> <span class="operator">=</span> <span class="number">3600</span>;</span><br><span class="line"><span class="comment">// éšæœº0-5åˆ†é’Ÿ</span></span><br><span class="line"><span class="type">int</span> <span class="variable">randomExpire</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">300</span>);</span><br><span class="line">redis.setex(key, baseExpire + randomExpire, value);</span><br></pre></td></tr></table></figure><ul><li><strong>æ°¸ä¸è¿‡æœŸ+å¼‚æ­¥æ›´æ–°</strong></li><li><strong>æ·»åŠ é™çº§é™æµç­–ç•¥</strong></li><li><strong>æ·»åŠ å¤šçº§ç¼“å­˜</strong></li></ul><p><strong>ç¼“å­˜å‡»ç©¿</strong>æ˜¯æŒ‡æŸä¸ª<strong>çƒ­ç‚¹key</strong>å¤±æ•ˆçš„ç¬é—´ï¼Œæœ‰å¤§é‡è¯·æ±‚åŒæ—¶è®¿é—®è¿™ä¸ªkeyï¼Œå¯¼è‡´æ‰€æœ‰è¯·æ±‚éƒ½å»æŸ¥è¯¢æ•°æ®åº“ã€‚</p><p>è§£å†³æ–¹æ¡ˆï¼š</p><ul><li><strong>äº’æ–¥é”</strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> Redission.getLock(<span class="string">&quot;PREFIX:&quot;</span> + key);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (lock.tryLock(<span class="number">3</span>, <span class="number">30</span>, TimeUnit.SECONDS)) &#123;</span><br><span class="line">        <span class="comment">// æŸ¥åº“å¹¶é‡å»ºç¼“å­˜</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    lock.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>é€»è¾‘è¿‡æœŸ</strong></li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="string">&quot;çœŸå®æ•°æ®&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;expire_ts&quot;</span><span class="punctuation">:</span> <span class="number">1672502400</span> <span class="comment">// é€»è¾‘è¿‡æœŸæ—¶é—´æˆ³</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>å¤„ç†æµç¨‹ï¼š</p><ol><li>åˆ¤æ–­é€»è¾‘è¿‡æœŸæ—¶é—´<ol><li>æœªè¿‡æœŸï¼Œç›´æ¥è¿”å›æ•°æ®</li><li>å·²è¿‡æœŸï¼Œåˆ›å»ºå­çº¿ç¨‹ï¼Œå¼‚æ­¥é‡å»ºç¼“å­˜</li></ol></li></ol><table><thead><tr><th>è§£å†³æ–¹æ¡ˆ</th><th>ä¼˜ç‚¹</th><th>ç¼ºç‚¹</th></tr></thead><tbody><tr><td>äº’æ–¥é”</td><td>å®ç°ç®€å•ï¼›ä¿è¯ä¸€è‡´æ€§ï¼›æ— éœ€æ¶ˆè€—é¢å¤–å†…å­˜</td><td>çº¿ç¨‹éœ€ç­‰å¾…ï¼Œå½±å“æ€§èƒ½</td></tr><tr><td>é€»è¾‘è¿‡æœŸ</td><td>çº¿ç¨‹æ— éœ€ç­‰å¾…ï¼Œæ€§èƒ½è¾ƒå¥½</td><td>å­˜åœ¨ä¸ä¸€è‡´æ€§ï¼›æ¶ˆè€—é¢å¤–å†…å­˜ï¼›å®ç°å¤æ‚</td></tr></tbody></table><h3 id="å¸ƒéš†è¿‡æ»¤å™¨"><a href="#å¸ƒéš†è¿‡æ»¤å™¨" class="headerlink" title="å¸ƒéš†è¿‡æ»¤å™¨"></a>å¸ƒéš†è¿‡æ»¤å™¨</h3><p>å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆBloom Filterï¼‰æ˜¯ä¸€ç§ç©ºé—´é«˜æ•ˆã€å¿«é€Ÿåˆ¤æ–­æŸä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨äºé›†åˆä¸­çš„æ•°æ®ç»“æ„ã€‚å®ƒç”±å¸ƒéš†äº1970å¹´æå‡ºï¼Œä¸»è¦ç”¨äºå¤§è§„æ¨¡æ•°æ®é›†åˆçš„å¿«é€ŸæŸ¥æ‰¾å’Œå»é‡ã€‚</p><p>å¸ƒéš†è¿‡æ»¤å™¨çš„åŸºæœ¬æ€æƒ³æ˜¯ä½¿ç”¨å¤šä¸ªç‹¬ç«‹çš„å“ˆå¸Œå‡½æ•°å°†å…ƒç´ æ˜ å°„åˆ°ä¸€ä¸ªä½æ•°ç»„ï¼ˆæˆ–ç§°ä¸ºå¸ƒéš†è¿‡æ»¤å™¨çš„ä½å‘é‡ï¼‰ä¸­ï¼Œå¹¶å°†è¿™äº›ä½æ•°ç»„åˆå§‹åŒ–ä¸º0ã€‚å½“è¦æ’å…¥ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œé€šè¿‡è¿™äº›å“ˆå¸Œå‡½æ•°è®¡ç®—å¾—åˆ°çš„å¤šä¸ªå“ˆå¸Œå€¼å¯¹åº”çš„ä½éƒ½è¢«è®¾ç½®ä¸º1ã€‚å½“è¦æŸ¥è¯¢ä¸€ä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨æ—¶ï¼ŒåŒæ ·é€šè¿‡è¿™äº›å“ˆå¸Œå‡½æ•°è®¡ç®—å¾—åˆ°çš„å¤šä¸ªå“ˆå¸Œå€¼å¯¹åº”çš„ä½éƒ½è¢«æ£€æŸ¥ï¼Œå¦‚æœå…¶ä¸­æœ‰ä»»æ„ä¸€ä¸ªä½ä¸º0ï¼Œåˆ™è¡¨ç¤ºå…ƒç´ ä¸€å®šä¸å­˜åœ¨ï¼›å¦‚æœæ‰€æœ‰ä½éƒ½ä¸º1ï¼Œåˆ™è¡¨ç¤ºå…ƒç´ å¯èƒ½å­˜åœ¨ï¼Œä½†å¹¶ä¸ä¸€å®šå­˜åœ¨ï¼Œå¯èƒ½ä¼šå­˜åœ¨ä¸€å®šçš„è¯¯åˆ¤ç‡ã€‚</p><p>å¸ƒéš†è¿‡æ»¤å™¨çš„ä¼˜ç‚¹æ˜¯å ç”¨ç©ºé—´å°ï¼Œæ’å…¥å’ŒæŸ¥è¯¢æ“ä½œçš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯O(k)ï¼Œå…¶ä¸­kæ˜¯å“ˆå¸Œå‡½æ•°çš„æ•°é‡ã€‚æ­¤å¤–ï¼Œå¸ƒéš†è¿‡æ»¤å™¨å¯ä»¥å¤„ç†éå¸¸å¤§çš„æ•°æ®é›†åˆï¼Œè€Œä¸”å¯¹äºæ’å…¥å’ŒæŸ¥è¯¢æ“ä½œçš„å“åº”é€Ÿåº¦éå¸¸å¿«ã€‚ç„¶è€Œï¼Œå¸ƒéš†è¿‡æ»¤å™¨çš„ç¼ºç‚¹æ˜¯å­˜åœ¨ä¸€å®šçš„è¯¯åˆ¤ç‡ï¼Œå³åœ¨æŸ¥è¯¢æ—¶å¯èƒ½ä¼šå‡ºç°â€è¯¯åˆ¤ä¸ºå­˜åœ¨â€çš„æƒ…å†µï¼Œå› æ­¤åœ¨ä½¿ç”¨æ—¶éœ€è¦æ³¨æ„é€‰æ‹©åˆé€‚çš„å“ˆå¸Œå‡½æ•°æ•°é‡å’Œä½æ•°ç»„å¤§å°ï¼Œä»¥åŠåˆç†è®¾ç½®è¯¯åˆ¤ç‡çš„é˜ˆå€¼ã€‚</p><p>å¸ƒéš†è¿‡æ»¤å™¨åœ¨å®é™…åº”ç”¨ä¸­æœ‰å¾ˆå¤šç”¨é€”ï¼Œä¾‹å¦‚åœ¨æ•°æ®åº“ã€ç¼“å­˜ã€ç½‘ç»œè·¯ç”±å™¨ã€çˆ¬è™«ç­‰é¢†åŸŸä¸­éƒ½æœ‰å¹¿æ³›çš„åº”ç”¨ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†å¤§è§„æ¨¡æ•°æ®é›†åˆæ—¶ï¼Œå¯ä»¥æ˜¾è‘—å‡å°‘å­˜å‚¨å’ŒæŸ¥è¯¢çš„å¼€é”€ã€‚ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¸ƒéš†è¿‡æ»¤å™¨å¹¶ä¸é€‚ç”¨äºæ‰€æœ‰æƒ…å†µï¼Œå› ä¸ºå®ƒå­˜åœ¨ä¸€å®šçš„è¯¯åˆ¤ç‡ï¼Œå¹¶ä¸”æ— æ³•åˆ é™¤å·²æ’å…¥çš„å…ƒç´ ï¼Œå› æ­¤åœ¨é€‰æ‹©ä½¿ç”¨æ—¶éœ€è¦æ ¹æ®å…·ä½“åº”ç”¨åœºæ™¯è¿›è¡Œè¯„ä¼°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.BitSet;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.security.MessageDigest;</span><br><span class="line"><span class="keyword">import</span> java.security.NoSuchAlgorithmException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BloomFilter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> BitSet bitArray;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> m; <span class="comment">// ä½æ•°ç»„çš„å¤§å°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> k; <span class="comment">// å“ˆå¸Œå‡½æ•°çš„æ•°é‡</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BloomFilter</span><span class="params">(<span class="type">int</span> m, <span class="type">int</span> k)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.m = m;</span><br><span class="line">        <span class="built_in">this</span>.k = k;</span><br><span class="line">        <span class="built_in">this</span>.bitArray = <span class="keyword">new</span> <span class="title class_">BitSet</span>(m);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span>[] hash(String data) &#123;</span><br><span class="line">        <span class="type">int</span>[] hashValues = <span class="keyword">new</span> <span class="title class_">int</span>[k];</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">MessageDigest</span> <span class="variable">md</span> <span class="operator">=</span> MessageDigest.getInstance(<span class="string">&quot;SHA-256&quot;</span>);</span><br><span class="line">            <span class="type">byte</span>[] hashBytes = md.digest(data.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; k; i++) &#123;</span><br><span class="line">                hashValues[i] = Math.abs((<span class="type">int</span>) (hashBytes[(i * <span class="number">4</span>) % hashBytes.length]) % m);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> hashValues;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(String data)</span> &#123;</span><br><span class="line">        <span class="type">int</span>[] hashValues = hash(data);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> hashValue : hashValues) &#123;</span><br><span class="line">            bitArray.set(hashValue);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">query</span><span class="params">(String data)</span> &#123;</span><br><span class="line">        <span class="type">int</span>[] hashValues = hash(data);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> hashValue : hashValues) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!bitArray.get(hashValue)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºå¸ƒéš†è¿‡æ»¤å™¨ï¼Œä½æ•°ç»„å¤§å°ä¸º100ï¼Œå“ˆå¸Œå‡½æ•°æ•°é‡ä¸º3</span></span><br><span class="line">        <span class="type">BloomFilter</span> <span class="variable">bloomFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BloomFilter</span>(<span class="number">100</span>, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ’å…¥å…ƒç´ </span></span><br><span class="line">        bloomFilter.insert(<span class="string">&quot;apple&quot;</span>);</span><br><span class="line">        bloomFilter.insert(<span class="string">&quot;banana&quot;</span>);</span><br><span class="line">        bloomFilter.insert(<span class="string">&quot;cherry&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æŸ¥è¯¢å…ƒç´ æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">        System.out.println(bloomFilter.query(<span class="string">&quot;apple&quot;</span>)); <span class="comment">// true</span></span><br><span class="line">        System.out.println(bloomFilter.query(<span class="string">&quot;grape&quot;</span>)); <span class="comment">// false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç¼“å­˜æ·˜æ±°ç­–ç•¥"><a href="#ç¼“å­˜æ·˜æ±°ç­–ç•¥" class="headerlink" title="ç¼“å­˜æ·˜æ±°ç­–ç•¥"></a>ç¼“å­˜æ·˜æ±°ç­–ç•¥</h3><table><thead><tr><th align="left"><strong>æ•°æ®èŒƒå›´</strong></th><th align="left"><strong>ç­–ç•¥</strong></th><th align="left"><strong>è¯´æ˜</strong></th></tr></thead><tbody><tr><td align="left"><strong>æ‰€æœ‰Key</strong></td><td align="left"><code>allkeys-lru</code></td><td align="left">ä»æ‰€æœ‰Keyä¸­æ·˜æ±°æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„</td></tr><tr><td align="left"></td><td align="left"><code>allkeys-lfu</code></td><td align="left">ä»æ‰€æœ‰Keyä¸­æ·˜æ±°æœ€ä¸ç»å¸¸ä½¿ç”¨çš„ï¼ˆRedis 4.0+ï¼‰</td></tr><tr><td align="left"></td><td align="left"><code>allkeys-random</code></td><td align="left">ä»æ‰€æœ‰Keyä¸­éšæœºæ·˜æ±°</td></tr><tr><td align="left"><strong>è¿‡æœŸKey</strong></td><td align="left"><code>volatile-lru</code></td><td align="left">ä»è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„Keyä¸­æ·˜æ±°æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„</td></tr><tr><td align="left"></td><td align="left"><code>volatile-lfu</code></td><td align="left">ä»è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„Keyä¸­æ·˜æ±°æœ€ä¸ç»å¸¸ä½¿ç”¨çš„</td></tr><tr><td align="left"></td><td align="left"><code>volatile-random</code></td><td align="left">ä»è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„Keyä¸­éšæœºæ·˜æ±°</td></tr><tr><td align="left"></td><td align="left"><code>volatile-ttl</code></td><td align="left">æ·˜æ±°å‰©ä½™å­˜æ´»æ—¶é—´ï¼ˆTTLï¼‰æœ€çŸ­çš„Key</td></tr><tr><td align="left"><strong>ä¸æ·˜æ±°</strong></td><td align="left"><code>noeviction</code>ï¼ˆé»˜è®¤ï¼‰</td><td align="left">å†…å­˜ä¸è¶³æ—¶æ‹’ç»å†™å…¥ï¼Œè¿”å›é”™è¯¯</td></tr></tbody></table><h3 id="ç¼“å­˜ä¸æ•°æ®çš„æ›´æ–°ç­–ç•¥"><a href="#ç¼“å­˜ä¸æ•°æ®çš„æ›´æ–°ç­–ç•¥" class="headerlink" title="ç¼“å­˜ä¸æ•°æ®çš„æ›´æ–°ç­–ç•¥"></a>ç¼“å­˜ä¸æ•°æ®çš„æ›´æ–°ç­–ç•¥</h3><p><strong>æ–¹æ¡ˆä¸€ï¼šå…ˆåˆ ç¼“å­˜ â†’ æ›´æ–°æ•°æ®åº“ â†’ é‡å»ºç¼“å­˜</strong></p><p><strong>é—®é¢˜é£é™©</strong>ï¼š</p><ol><li><strong>å¹¶å‘è„è¯»ï¼ˆä¸¥é‡é—®é¢˜ï¼‰</strong><ul><li>çº¿ç¨‹Aåˆ é™¤ç¼“å­˜åï¼Œå°šæœªæ›´æ–°æ•°æ®åº“</li><li>çº¿ç¨‹Bè¯»å–ç¼“å­˜æœªå‘½ä¸­ï¼Œ<strong>ä»æ•°æ®åº“è¯»åˆ°æ—§å€¼</strong>å¹¶é‡å»ºç¼“å­˜</li><li>çº¿ç¨‹Aæ›´æ–°æ•°æ®åº“åï¼Œç¼“å­˜ä¸­é—ç•™<strong>æ—§æ•°æ®</strong>ï¼ˆç›´åˆ°ä¸‹æ¬¡æ›´æ–°&#x2F;è¿‡æœŸï¼‰<br><em>ğŸ‘‰ ç¼“å­˜ä¸æ•°æ®åº“é•¿æœŸä¸ä¸€è‡´</em></li></ul></li><li><strong>ç¼“å­˜å‡»ç©¿å‹åŠ›</strong><ul><li>åˆ é™¤ç¼“å­˜åï¼Œå¤§é‡è¯·æ±‚ç¬é—´ç©¿é€åˆ°æ•°æ®åº“ï¼ˆå°¤å…¶çƒ­ç‚¹æ•°æ®ï¼‰</li><li>è‹¥é‡å»ºç¼“å­˜æ…¢ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®åº“é›ªå´©</li></ul></li></ol><p><strong>æ–¹æ¡ˆäºŒï¼šå…ˆæ›´æ–°æ•°æ®åº“ â†’ åˆ é™¤ç¼“å­˜ï¼ˆæ¨èæ–¹æ¡ˆï¼‰</strong></p><p><strong>é—®é¢˜é£é™©ï¼š</strong></p><ol><li><strong>æå°æ¦‚ç‡çš„æ—§æ•°æ®æ®‹ç•™</strong><ul><li>çº¿ç¨‹Aè¯»ç¼“å­˜<strong>å‘½ä¸­æ—§å€¼</strong>ï¼ˆæ­¤æ—¶ç¼“å­˜æœªå¤±æ•ˆï¼‰</li><li>çº¿ç¨‹Bæ›´æ–°æ•°æ®åº“å¹¶<strong>åˆ é™¤ç¼“å­˜</strong></li><li>çº¿ç¨‹Aä»ä½¿ç”¨æ—§æ•°æ®ï¼ˆçŸ­æš‚ä¸ä¸€è‡´ï¼Œé€šå¸¸æ¯«ç§’çº§ï¼‰<br><em>ğŸ‘‰ æ¦‚ç‡ä½ï¼Œä¸”æ—§æ•°æ®å¾ˆå¿«è¢«æ·˜æ±°</em></li></ul></li><li><strong>ç¼“å­˜åˆ é™¤å¤±è´¥</strong><ul><li>æ•°æ®åº“æ›´æ–°æˆåŠŸï¼Œä½†ç¼“å­˜åˆ é™¤å¤±è´¥ â†’ <strong>æ°¸ä¹…ä¸ä¸€è‡´</strong><br><em>ğŸ‘‰ éœ€å¼•å…¥é‡è¯•æˆ–è¡¥å¿æœºåˆ¶</em></li></ul></li></ol><p><strong>ä¸šç•Œé€šç”¨æ–¹æ¡ˆï¼šCache-Aside + å»¶è¿ŸåŒåˆ </strong></p><p>ç»“åˆå¯é æ€§è®¾è®¡ï¼Œæ ¸å¿ƒæµç¨‹ï¼š</p><p><strong>å…³é”®ä¼˜åŒ–æªæ–½</strong>ï¼š</p><ol><li><strong>å»¶è¿ŸåŒåˆ  (Double Delete)</strong><ul><li>æ›´æ–°æ•°æ®åº“å<strong>ç«‹å³åˆ é™¤ç¼“å­˜</strong></li><li><strong>é¢å¤–å¯åŠ¨å¼‚æ­¥ä»»åŠ¡</strong>ï¼ˆå¦‚å»¶è¿Ÿ500msï¼‰<strong>å†æ¬¡åˆ é™¤ç¼“å­˜</strong><br><em>ğŸ‘‰ è§£å†³å¹¶å‘å¯¼è‡´çš„æ—§æ•°æ®é‡å»ºé—®é¢˜</em></li></ul></li><li><strong>ç¼“å­˜æ“ä½œå¤±è´¥é‡è¯•</strong><ul><li>å°†åˆ é™¤æ“ä½œå‘åˆ°<strong>æ¶ˆæ¯é˜Ÿåˆ—</strong>ï¼ˆå¦‚Kafka&#x2F;RabbitMQï¼‰</li><li>æ¶ˆè´¹å¤±è´¥è‡ªåŠ¨é‡è¯•ï¼Œç›´è‡³æˆåŠŸ<br><em>ğŸ‘‰ ç¡®ä¿æœ€ç»ˆä¸€è‡´æ€§</em></li></ul></li><li><strong>çŸ­è¿‡æœŸæ—¶é—´å…œåº•</strong><ul><li>æ‰€æœ‰ç¼“å­˜è®¾ç½® <strong>TTLï¼ˆå¦‚1-5ç§’ï¼‰</strong><br><em>ğŸ‘‰ å³ä½¿åŒåˆ å¤±è´¥ï¼Œæ—§æ•°æ®ä¹Ÿä¼šå¿«é€Ÿè¿‡æœŸ</em></li></ul></li></ol><h2 id="æŒä¹…åŒ–"><a href="#æŒä¹…åŒ–" class="headerlink" title="æŒä¹…åŒ–"></a>æŒä¹…åŒ–</h2><h3 id="RDBå’ŒAOFæŒä¹…åŒ–åŸç†åŠä¼˜åŠ£å¯¹æ¯”"><a href="#RDBå’ŒAOFæŒä¹…åŒ–åŸç†åŠä¼˜åŠ£å¯¹æ¯”" class="headerlink" title="RDBå’ŒAOFæŒä¹…åŒ–åŸç†åŠä¼˜åŠ£å¯¹æ¯”"></a>RDBå’ŒAOFæŒä¹…åŒ–åŸç†åŠä¼˜åŠ£å¯¹æ¯”</h3><p>RDBï¼Œå­˜å‚¨æŸä¸€æ—¶åˆ»å†…å­˜ä¸­æ‰€æœ‰çš„æ•°æ®ï¼Œè§¦å‘å‘½ä»¤<code>save</code>ã€<code>bgsave</code>ï¼Œä¸»è¿›ç¨‹<code>fork</code>å­è¿›ç¨‹ï¼Œé˜»å¡ã€‚</p><p>è§¦å‘æ¡ä»¶ï¼š</p><ol><li>å®¢æˆ·ç«¯å‘é€<code>shutdown</code></li><li>ä»èŠ‚ç‚¹è¦è¿›è¡Œå…¨é‡å¤åˆ¶</li><li>è¾¾åˆ°<code>redis.conf</code>æ–‡ä»¶ä¸­é…ç½®çš„æ¡ä»¶</li><li>å®¢æˆ·ç«¯æ‰§è¡Œ<code>flushall</code>ï¼ˆç”Ÿæˆç©ºçš„<code>dump.rdb</code>ï¼Œæ…ç”¨ï¼‰</li></ol><p>ä¸èƒ½é¢‘ç¹ç”Ÿæˆ RBD å¿«ç…§ï¼ŒåŸå› ï¼š</p><ul><li>å¤šæ¬¡ RDB ä¼šç«äº‰ç£ç›˜å¸¦å®½</li><li><code>fork</code> å­è¿›ç¨‹ä¼šé˜»å¡ä¸»è¿›ç¨‹</li></ul><p>å†™æ—¶å¤åˆ¶<code>copy-on-write</code>ï¼š</p><ul><li><strong>å…±äº«å†…å­˜åˆå§‹åŒ–</strong>ï¼šå­è¿›ç¨‹åˆšåˆ›å»ºæ—¶ï¼Œ<strong>ä¸çˆ¶è¿›ç¨‹å…±äº«å…¨éƒ¨å†…å­˜é¡µ</strong>ï¼Œæ­¤æ—¶å†…å­˜å ç”¨å‡ ä¹æ— é¢å¤–å¼€é”€ã€‚</li><li><strong>å†™æ“ä½œè§¦å‘å¤åˆ¶</strong>ï¼šè‹¥çˆ¶è¿›ç¨‹æ”¶åˆ°å†™è¯·æ±‚ï¼ˆä¿®æ”¹æ•°æ®ï¼‰ï¼Œæ“ä½œç³»ç»Ÿä¼š<strong>å°†è¢«ä¿®æ”¹çš„å†…å­˜é¡µå¤åˆ¶ä¸€ä»½</strong>ï¼Œçˆ¶è¿›ç¨‹åœ¨å‰¯æœ¬ä¸Šä¿®æ”¹ï¼Œå­è¿›ç¨‹ä»è¯»å–åŸå§‹é¡µã€‚</li><li><strong>å­è¿›ç¨‹è§†è§’å›ºå®š</strong>ï¼šå­è¿›ç¨‹çœ‹åˆ°çš„æ•°æ®å§‹ç»ˆæ˜¯ <code>fork()</code> ç¬é—´çš„çŠ¶æ€ï¼Œç¡®ä¿å¿«ç…§ä¸€è‡´æ€§ã€‚</li></ul><p>AOFï¼Œæ‰€æœ‰å†™å‘½ä»¤è¿½åŠ åˆ° <code>aof_buf</code>ï¼Œåˆ·ç›˜ç­–ç•¥ç”± <code>appendfsync</code> å†³å®šã€‚</p><p>å¦‚æœæœ‰ AOF æ–‡ä»¶ï¼ŒåŠ è½½ AOFï¼›å¦åˆ™ï¼ŒåŠ è½½ RDB æ–‡ä»¶ã€‚AOF æœ€å¤šä¸¢å¤± 1s æ•°æ®ã€‚</p><p>AOFé‡å†™æ˜¯ç›´æ¥ä¸ºå½“å‰å†…å­˜çš„æ•°æ®ç”Ÿæˆå¯¹åº”å‘½ä»¤ï¼Œå¹¶ä¸æ˜¯è¯»å–æ—§AOFæ–‡ä»¶è¿›è¡Œå‘½ä»¤åˆå¹¶</p><ul><li>çˆ¶å­è¿›ç¨‹å†™åŒä¸€ä¸ªæ–‡ä»¶ä¼šäº§ç”Ÿç«äº‰é—®é¢˜ï¼Œå½±å“çˆ¶è¿›ç¨‹çš„æ€§èƒ½ã€‚</li><li>å¦‚æœAOFé‡å†™è¿‡ç¨‹ä¸­å¤±è´¥äº†ï¼Œç›¸å½“äºæ±¡æŸ“äº†åŸæœ¬çš„AOFæ–‡ä»¶ï¼Œæ— æ³•åšæ¢å¤æ•°æ®ä½¿ç”¨</li></ul><p>ä¿®å¤å·²æŸå®³çš„AOFæ–‡ä»¶ï¼š<code>redis-check-aof --fix appendonly.aof</code></p><table><thead><tr><th></th><th>RDB</th><th>AOF</th></tr></thead><tbody><tr><td>å¯åŠ¨åŠ è½½ä¼˜å…ˆçº§</td><td>ä½</td><td>é«˜</td></tr><tr><td>ä½“ç§¯</td><td>å°</td><td>å¤§</td></tr><tr><td>æ¢å¤é€Ÿåº¦</td><td>æ…¢</td><td>å¿«</td></tr></tbody></table><p>æ€»ç»“ï¼šRDBé€‚åˆç”¨ä½œæ•°æ®å¤‡ä»½ï¼ŒAOFé€‚åˆç”¨ä½œæ•°æ®æ¢å¤ã€‚</p><h3 id="å…¨é‡åŒæ­¥å’Œå¢é‡åŒæ­¥çš„åŒºåˆ«"><a href="#å…¨é‡åŒæ­¥å’Œå¢é‡åŒæ­¥çš„åŒºåˆ«" class="headerlink" title="å…¨é‡åŒæ­¥å’Œå¢é‡åŒæ­¥çš„åŒºåˆ«"></a>å…¨é‡åŒæ­¥å’Œå¢é‡åŒæ­¥çš„åŒºåˆ«</h3><p>å…¨é‡åŒæ­¥ï¼šmasterç”Ÿæˆå½“å‰å†…å­˜ä¸­æ‰€æœ‰æ•°æ®çš„RDBæ–‡ä»¶ï¼Œå°†RDBå‘é€ç»™slaveã€‚åœ¨æ­¤è¿‡ç¨‹ä¸­ï¼Œmasterå°†æ–°çš„å‘½ä»¤è®°å½•åœ¨<code>repl_backlog</code>ä¸­ï¼Œåç»­å†å‘é€ç»™slaveã€‚</p><p>æ‰§è¡Œæ—¶æœºï¼š</p><ol><li>slaveç¬¬ä¸€æ¬¡è¿æ¥åˆ°master</li><li>slaveå®•æœºå¤ªä¹…ï¼Œå¯¼è‡´å®ƒåœ¨<code>repl_backlog</code>ä¸­çš„<code>offset</code>å·²ç»è¢«è¦†ç›–æ‰äº†</li></ol><p>å¢é‡åŒæ­¥ï¼šsalveå°†è‡ªå·±çš„<code>offset</code>å‘é€åˆ°masterï¼Œmasterå°†<code>repl_backlog</code>ä¸­<code>offset</code>ä¹‹åçš„å‘½ä»¤å‘é€ç»™slave</p><p>æ‰§è¡Œæ—¶æœºï¼š</p><ol><li>slaveæ–­å¼€é‡è¿ä¹‹åï¼Œ<code>repl_backlog</code>ä¸­çš„<code>offset</code>å°šæœªè¢«è¦†ç›–</li></ol><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      <categories>
          
          <category> Redis </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>è„šæœ¬åº“</title>
      <link href="/post/7ad2e472.html"/>
      <url>/post/7ad2e472.html</url>
      
        <content type="html"><![CDATA[<h1 id="Pythonè„šæœ¬"><a href="#Pythonè„šæœ¬" class="headerlink" title="Pythonè„šæœ¬"></a>Pythonè„šæœ¬</h1><h2 id="æŠ½å–jsonæ–‡ä»¶å­—æ®µå¹¶å†™å…¥excel"><a href="#æŠ½å–jsonæ–‡ä»¶å­—æ®µå¹¶å†™å…¥excel" class="headerlink" title="æŠ½å–jsonæ–‡ä»¶å­—æ®µå¹¶å†™å…¥excel"></a>æŠ½å–jsonæ–‡ä»¶å­—æ®µå¹¶å†™å…¥excel</h2><p>jsonæ ·ä¾‹</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;migrations&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;up&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;ADD_OR_UPDATE&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                    <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;targetService&quot;</span><span class="punctuation">:</span> <span class="string">&quot;targetService&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GET&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;endpointId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;endpointId&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;targetUri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;targetUri&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;readTimout&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;targetProtocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uri&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;seqId&quot;</span><span class="punctuation">:</span> <span class="number">5661418</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">]</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;endpointId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;endpintId&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">MigrationExtractor.py</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_data</span>(<span class="params">json_data</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    ä» JSON æ•°æ®ä¸­æå–æŒ‡å®šå­—æ®µ</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    extracted_data = []</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ£€æŸ¥æ•°æ®ç»“æ„æ˜¯å¦æœ‰æ•ˆ</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;migrations&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> json_data:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;é”™è¯¯ï¼šJSON æ•°æ®ä¸­ç¼ºå°‘ &#x27;migrations&#x27; å­—æ®µ&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> extracted_data</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> migration <span class="keyword">in</span> json_data[<span class="string">&quot;migrations&quot;</span>]:</span><br><span class="line">        <span class="comment"># æ£€æŸ¥æ˜¯å¦æœ‰ &quot;up&quot; éƒ¨åˆ†</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;up&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> migration:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">        <span class="comment"># æ£€æŸ¥æ˜¯å¦æœ‰ &quot;ADD_OR_UPDATE&quot; æ•°ç»„</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;ADD_OR_UPDATE&quot;</span> <span class="keyword">in</span> migration[<span class="string">&quot;up&quot;</span>]:</span><br><span class="line">            <span class="keyword">for</span> item <span class="keyword">in</span> migration[<span class="string">&quot;up&quot;</span>][<span class="string">&quot;ADD_OR_UPDATE&quot;</span>]:</span><br><span class="line">                <span class="comment"># æå–æ‰€éœ€å­—æ®µï¼Œå¤„ç†ç¼ºå¤±å€¼</span></span><br><span class="line">                row = &#123;</span><br><span class="line">                    <span class="string">&quot;targetService&quot;</span>: item.get(<span class="string">&quot;targetService&quot;</span>, <span class="string">&quot;N/A&quot;</span>),</span><br><span class="line">                    <span class="string">&quot;uri&quot;</span>: item.get(<span class="string">&quot;uri&quot;</span>, <span class="string">&quot;N/A&quot;</span>),</span><br><span class="line">                    <span class="string">&quot;method&quot;</span>: item.get(<span class="string">&quot;method&quot;</span>, <span class="string">&quot;N/A&quot;</span>),</span><br><span class="line">                    <span class="string">&quot;targetUri&quot;</span>: item.get(<span class="string">&quot;targetUri&quot;</span>, <span class="string">&quot;N/A&quot;</span>)</span><br><span class="line">                &#125;</span><br><span class="line">                extracted_data.append(row)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> extracted_data</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">export_to_excel</span>(<span class="params">data, output_file</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    å°†æå–çš„æ•°æ®å¯¼å‡ºåˆ° Excel æ–‡ä»¶</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;è­¦å‘Šï¼šæ²¡æœ‰æå–åˆ°æ•°æ®ï¼Œä¸åˆ›å»º Excel æ–‡ä»¶&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># åˆ›å»º DataFrame</span></span><br><span class="line">    df = pd.DataFrame(data)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ç¡®ä¿åˆ—é¡ºåºæ­£ç¡®</span></span><br><span class="line">    df = df[[<span class="string">&quot;targetService&quot;</span>, <span class="string">&quot;uri&quot;</span>, <span class="string">&quot;method&quot;</span>, <span class="string">&quot;targetUri&quot;</span>]]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># å¯¼å‡ºåˆ° Excel</span></span><br><span class="line">        df.to_excel(output_file, index=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;å¯¼å‡ºåˆ° Excel æ—¶å‡ºé”™: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment"># è®¾ç½®å‘½ä»¤è¡Œå‚æ•°</span></span><br><span class="line">    parser = argparse.ArgumentParser(</span><br><span class="line">        description=<span class="string">&quot;MigrationExtractor - ä» JSON è¿ç§»æ–‡ä»¶ä¸­æå– ADD_OR_UPDATE æ•°æ®å¹¶å¯¼å‡ºåˆ° Excel&quot;</span>,</span><br><span class="line">        formatter_class=argparse.ArgumentDefaultsHelpFormatter</span><br><span class="line">    )</span><br><span class="line">    parser.add_argument(<span class="string">&quot;input&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;è¾“å…¥ JSON æ–‡ä»¶è·¯å¾„&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;-o&quot;</span>, <span class="string">&quot;--output&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;è¾“å‡º Excel æ–‡ä»¶è·¯å¾„&quot;</span>, default=<span class="string">&quot;&quot;</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># éªŒè¯è¾“å…¥æ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(args.<span class="built_in">input</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;é”™è¯¯ï¼šè¾“å…¥æ–‡ä»¶ä¸å­˜åœ¨ - <span class="subst">&#123;args.<span class="built_in">input</span>&#125;</span>&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è®¾ç½®é»˜è®¤è¾“å‡ºæ–‡ä»¶å</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> args.output:</span><br><span class="line">        timestamp = datetime.now().strftime(<span class="string">&quot;%Y%m%d_%H%M%S&quot;</span>)</span><br><span class="line">        args.output = <span class="string">f&quot;migration_data_<span class="subst">&#123;timestamp&#125;</span>.xlsx&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è¯»å– JSON æ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(args.<span class="built_in">input</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            json_data = json.load(f)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;è¯»å– JSON æ–‡ä»¶æ—¶å‡ºé”™: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æå–æ•°æ®</span></span><br><span class="line">    extracted_data = extract_data(json_data)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> extracted_data:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;è­¦å‘Šï¼šæœªæå–åˆ°ä»»ä½•æ•°æ®ï¼Œè¯·æ£€æŸ¥ JSON æ–‡ä»¶ç»“æ„&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å¯¼å‡ºåˆ° Excel</span></span><br><span class="line">    <span class="keyword">if</span> export_to_excel(extracted_data, args.output):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;æˆåŠŸå¯¼å‡º <span class="subst">&#123;<span class="built_in">len</span>(extracted_data)&#125;</span> æ¡è®°å½•åˆ° <span class="subst">&#123;args.output&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;å¯¼å‡ºå¤±è´¥&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">50</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;MigrationExtractor - JSON è¿ç§»æ•°æ®æå–å·¥å…·&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">50</span>)</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p><strong>è„šæœ¬åŠŸèƒ½è¯´æ˜</strong></p><ol><li><strong>è„šæœ¬åç§°</strong>ï¼šMigrationExtractor</li><li><strong>æ ¸å¿ƒåŠŸèƒ½</strong>ï¼š<ul><li>ä» JSON æ–‡ä»¶ä¸­è¯»å–è¿ç§»æ•°æ®</li><li>æå– ADD_OR_UPDATE åˆ—è¡¨ä¸­çš„æŒ‡å®šå­—æ®µ</li><li>å°†æå–çš„æ•°æ®å¯¼å‡ºåˆ° Excel æ–‡ä»¶</li></ul></li><li><strong>æå–å­—æ®µ</strong>ï¼ˆæŒ‰æŒ‡å®šé¡ºåºï¼‰ï¼š<ul><li>targetService</li><li>uri</li><li>method</li><li>targetUri</li></ul></li><li><strong>é«˜çº§ç‰¹æ€§</strong>ï¼š<ul><li>å‘½ä»¤è¡Œå‚æ•°æ”¯æŒ</li><li>è‡ªåŠ¨ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„è¾“å‡ºæ–‡ä»¶å</li><li>å¥å£®çš„é”™è¯¯å¤„ç†</li><li>ç¼ºå¤±å€¼å¤„ç†ï¼ˆç”¨ â€œN&#x2F;Aâ€ æ›¿ä»£ï¼‰</li><li>è¯¦ç»†çš„çŠ¶æ€åé¦ˆ</li></ul></li></ol><p><strong>ä½¿ç”¨ç¤ºä¾‹</strong></p><p><strong>åŸºæœ¬ç”¨æ³•</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python MigrationExtractor.py input.json</span><br></pre></td></tr></table></figure><p><strong>æŒ‡å®šè¾“å‡ºæ–‡ä»¶å</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python MigrationExtractor.py input.json -o output.xlsx</span><br></pre></td></tr></table></figure><h2 id="æ‰¹é‡é‡å‘½åæ–‡ä»¶"><a href="#æ‰¹é‡é‡å‘½åæ–‡ä»¶" class="headerlink" title="æ‰¹é‡é‡å‘½åæ–‡ä»¶"></a>æ‰¹é‡é‡å‘½åæ–‡ä»¶</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">æ‰¹é‡é‡å‘½åæ–‡ä»¶å·¥å…·</span></span><br><span class="line"><span class="string">æ”¯æŒåŠŸèƒ½ï¼š</span></span><br><span class="line"><span class="string">1. æ·»åŠ å‰ç¼€</span></span><br><span class="line"><span class="string">2. æ·»åŠ åç¼€</span></span><br><span class="line"><span class="string">3. æ›¿æ¢æ–‡æœ¬</span></span><br><span class="line"><span class="string">4. æ­£åˆ™è¡¨è¾¾å¼é‡å‘½å</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">batch_rename</span>(<span class="params">path, prefix=<span class="string">&quot;&quot;</span>, suffix=<span class="string">&quot;&quot;</span>, find_str=<span class="string">&quot;&quot;</span>, replace_str=<span class="string">&quot;&quot;</span>, use_regex=<span class="literal">False</span>, dry_run=<span class="literal">False</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    æ‰¹é‡é‡å‘½åæ–‡ä»¶</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        path: ç›®å½•è·¯å¾„</span></span><br><span class="line"><span class="string">        prefix: è¦æ·»åŠ çš„å‰ç¼€</span></span><br><span class="line"><span class="string">        suffix: è¦æ·»åŠ çš„åç¼€</span></span><br><span class="line"><span class="string">        find_str: è¦æŸ¥æ‰¾çš„æ–‡æœ¬</span></span><br><span class="line"><span class="string">        replace_str: è¦æ›¿æ¢çš„æ–‡æœ¬</span></span><br><span class="line"><span class="string">        use_regex: æ˜¯å¦ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼</span></span><br><span class="line"><span class="string">        dry_run: è¯•è¿è¡Œï¼Œåªæ˜¾ç¤ºå°†è¦é‡å‘½åçš„æ–‡ä»¶ï¼Œä¸å®é™…æ‰§è¡Œ</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(path):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;é”™è¯¯ï¼šè·¯å¾„ &#x27;<span class="subst">&#123;path&#125;</span>&#x27; ä¸å­˜åœ¨&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è·å–æ–‡ä»¶åˆ—è¡¨</span></span><br><span class="line">    files = [f <span class="keyword">for</span> f <span class="keyword">in</span> os.listdir(path) <span class="keyword">if</span> os.path.isfile(os.path.join(path, f))]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> files:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;æŒ‡å®šç›®å½•ä¸­æ²¡æœ‰æ–‡ä»¶&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;æ‰¾åˆ° <span class="subst">&#123;<span class="built_in">len</span>(files)&#125;</span> ä¸ªæ–‡ä»¶&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># é‡å‘½åè®¡æ•°å™¨</span></span><br><span class="line">    renamed_count = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> filename <span class="keyword">in</span> files:</span><br><span class="line">        new_name = filename</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ›¿æ¢æ–‡æœ¬</span></span><br><span class="line">        <span class="keyword">if</span> find_str:</span><br><span class="line">            <span class="keyword">if</span> use_regex:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    new_name = re.sub(find_str, replace_str, new_name)</span><br><span class="line">                <span class="keyword">except</span> re.error <span class="keyword">as</span> e:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;æ­£åˆ™è¡¨è¾¾å¼é”™è¯¯: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                new_name = new_name.replace(find_str, replace_str)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ·»åŠ å‰ç¼€</span></span><br><span class="line">        <span class="keyword">if</span> prefix:</span><br><span class="line">            new_name = prefix + new_name</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ·»åŠ åç¼€ï¼ˆåœ¨æ‰©å±•åä¹‹å‰ï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> suffix:</span><br><span class="line">            name, ext = os.path.splitext(new_name)</span><br><span class="line">            new_name = name + suffix + ext</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å¦‚æœæ–‡ä»¶åæœ‰å˜åŒ–ï¼Œåˆ™é‡å‘½å</span></span><br><span class="line">        <span class="keyword">if</span> new_name != filename:</span><br><span class="line">            old_path = os.path.join(path, filename)</span><br><span class="line">            new_path = os.path.join(path, new_name)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ£€æŸ¥æ–°æ–‡ä»¶åæ˜¯å¦å·²å­˜åœ¨</span></span><br><span class="line">            <span class="keyword">if</span> os.path.exists(new_path):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;è­¦å‘Šï¼šç›®æ ‡æ–‡ä»¶å·²å­˜åœ¨ï¼Œè·³è¿‡: <span class="subst">&#123;new_name&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">                </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;é‡å‘½å: <span class="subst">&#123;filename&#125;</span> -&gt; <span class="subst">&#123;new_name&#125;</span>&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> dry_run:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    os.rename(old_path, new_path)</span><br><span class="line">                    renamed_count += <span class="number">1</span></span><br><span class="line">                <span class="keyword">except</span> OSError <span class="keyword">as</span> e:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;é”™è¯¯ï¼šé‡å‘½åå¤±è´¥: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;æ— å˜åŒ–: <span class="subst">&#123;filename&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;æ“ä½œå®Œæˆã€‚æˆåŠŸé‡å‘½å <span class="subst">&#123;renamed_count&#125;</span> ä¸ªæ–‡ä»¶&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">&quot;æ‰¹é‡é‡å‘½åæ–‡ä»¶å·¥å…·&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;path&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;ç›®å½•è·¯å¾„&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;-p&quot;</span>, <span class="string">&quot;--prefix&quot;</span>, default=<span class="string">&quot;&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;æ·»åŠ å‰ç¼€&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;-s&quot;</span>, <span class="string">&quot;--suffix&quot;</span>, default=<span class="string">&quot;&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;æ·»åŠ åç¼€ï¼ˆåœ¨æ‰©å±•åä¹‹å‰ï¼‰&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;-f&quot;</span>, <span class="string">&quot;--find&quot;</span>, default=<span class="string">&quot;&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;è¦æŸ¥æ‰¾çš„æ–‡æœ¬&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;-r&quot;</span>, <span class="string">&quot;--replace&quot;</span>, default=<span class="string">&quot;&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;è¦æ›¿æ¢çš„æ–‡æœ¬&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--regex&quot;</span>, action=<span class="string">&quot;store_true&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--dry-run&quot;</span>, action=<span class="string">&quot;store_true&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;è¯•è¿è¡Œï¼Œä¸å®é™…é‡å‘½åæ–‡ä»¶&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    </span><br><span class="line">    batch_rename(</span><br><span class="line">        path=args.path,</span><br><span class="line">        prefix=args.prefix,</span><br><span class="line">        suffix=args.suffix,</span><br><span class="line">        find_str=args.find,</span><br><span class="line">        replace_str=args.replace,</span><br><span class="line">        use_regex=args.regex,</span><br><span class="line">        dry_run=args.dry_run</span><br><span class="line">    )</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ·»åŠ å‰ç¼€</span></span><br><span class="line">./rename_files.py /path/to/files -p <span class="string">&quot;vacation_&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ åç¼€</span></span><br><span class="line">./rename_files.py /path/to/files -s <span class="string">&quot;_2023&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ›¿æ¢æ–‡æœ¬</span></span><br><span class="line">./rename_files.py /path/to/files -f <span class="string">&quot;IMG&quot;</span> -r <span class="string">&quot;Photo&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼</span></span><br><span class="line">./rename_files.py /path/to/files -f <span class="string">&quot;\d+&quot;</span> -r <span class="string">&quot;NUM&quot;</span> --regex</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯•è¿è¡Œï¼ˆä¸å®é™…é‡å‘½åï¼‰</span></span><br><span class="line">./rename_files.py /path/to/files -f <span class="string">&quot;old&quot;</span> -r <span class="string">&quot;new&quot;</span> --dry-run</span><br></pre></td></tr></table></figure><h1 id="Shellè„šæœ¬"><a href="#Shellè„šæœ¬" class="headerlink" title="Shellè„šæœ¬"></a>Shellè„šæœ¬</h1><h2 id="æœç´¢å¯æ‰§è¡Œæ–‡ä»¶"><a href="#æœç´¢å¯æ‰§è¡Œæ–‡ä»¶" class="headerlink" title="æœç´¢å¯æ‰§è¡Œæ–‡ä»¶"></a>æœç´¢å¯æ‰§è¡Œæ–‡ä»¶</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># finding files in the PATH</span></span><br><span class="line"></span><br><span class="line">IFS=:</span><br><span class="line"><span class="keyword">for</span> <span class="built_in">dir</span> <span class="keyword">in</span> <span class="variable">$PATH</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="comment"># æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> [ -d <span class="variable">$dir</span> ]; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$dir</span>:&quot;</span></span><br><span class="line">    <span class="keyword">for</span> file <span class="keyword">in</span> <span class="variable">$dir</span>/*:</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">            <span class="comment"># æ£€æŸ¥æ˜¯å¦æ˜¯å¯æ‰§è¡Œæ–‡ä»¶ä¸”ä¸æ˜¯ç›®å½•</span></span><br><span class="line">            <span class="keyword">if</span> [ -x <span class="variable">$file</span> ] &amp;&amp; [ ! -d <span class="variable">$file</span> ]; <span class="keyword">then</span> <span class="comment"># ä¸­æ‹¬å·ä¸æ¡ä»¶è¡¨è¾¾å¼éœ€ç©ºæ ¼éš”å¼€</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&quot;    <span class="variable">$file</span>&quot;</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$dir</span>: [Not a valid directory]&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><h2 id="æ‰“å°æŒ‡å®šæ—¶é—´æ®µçš„æ—¥å¿—"><a href="#æ‰“å°æŒ‡å®šæ—¶é—´æ®µçš„æ—¥å¿—" class="headerlink" title="æ‰“å°æŒ‡å®šæ—¶é—´æ®µçš„æ—¥å¿—"></a>æ‰“å°æŒ‡å®šæ—¶é—´æ®µçš„æ—¥å¿—</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹æŒ‡å®šæ—¶é—´æ®µå†…çš„æ—¥å¿—</span></span><br><span class="line">$ sed -n <span class="string">&#x27;/2022-11-25T14:15:*/,/2022-11-25T15:*/p&#x27;</span> filename</span><br><span class="line">$ sed -n <span class="string">&#x27;/2024-01-25 08:54:*/,/2024-01-25 08:55:*/p&#x27;</span> filename</span><br></pre></td></tr></table></figure><h2 id="å€’åºè¾“å‡ºæ–‡æœ¬å†…å®¹"><a href="#å€’åºè¾“å‡ºæ–‡æœ¬å†…å®¹" class="headerlink" title="å€’åºè¾“å‡ºæ–‡æœ¬å†…å®¹"></a>å€’åºè¾“å‡ºæ–‡æœ¬å†…å®¹</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sed -n <span class="string">&#x27;1!G; h; $p&#x27;</span> data.txt</span><br><span class="line">This is the last line.</span><br><span class="line">This is the second data line.</span><br><span class="line">This is the first data line.</span><br><span class="line">This is the header line.</span><br></pre></td></tr></table></figure><p>å‘½ä»¤åˆ†è§£ï¼š</p><ul><li><code>-n</code>ï¼šç¦æ­¢è‡ªåŠ¨æ‰“å°æ¨¡å¼ç©ºé—´çš„å†…å®¹</li><li><code>1!G</code>ï¼šé™¤äº†ç¬¬ä¸€è¡Œå¤–ï¼Œå°†ä¿æŒç©ºé—´çš„å†…å®¹è¿½åŠ åˆ°æ¨¡å¼ç©ºé—´</li><li><code>h</code>ï¼šå°†æ¨¡å¼ç©ºé—´çš„å†…å®¹å¤åˆ¶åˆ°ä¿æŒç©ºé—´</li><li><code>$p</code>ï¼šåœ¨æœ€åä¸€è¡Œæ—¶æ‰“å°æ¨¡å¼ç©ºé—´çš„å†…å®¹</li></ul><h2 id="ç»™æ–‡ä»¶çš„è¡Œç¼–å·"><a href="#ç»™æ–‡ä»¶çš„è¡Œç¼–å·" class="headerlink" title="ç»™æ–‡ä»¶çš„è¡Œç¼–å·"></a>ç»™æ–‡ä»¶çš„è¡Œç¼–å·</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ sed <span class="string">&#x27;=&#x27;</span> data.txt</span><br><span class="line">1</span><br><span class="line">This is the header line.</span><br><span class="line">2</span><br><span class="line">This is the first data line.</span><br><span class="line">3</span><br><span class="line">This is the second data line.</span><br><span class="line">4</span><br><span class="line">This is the last line.</span><br></pre></td></tr></table></figure><p>sedç¼–è¾‘å™¨çš„<code>=</code>å‘½ä»¤ä¼šåœ¨æ¯ä¸€è¡Œæ–‡æœ¬å‰è¾“å‡ºä¸€ä¸ªè¡Œå·ï¼Œä½†æ˜¯è¡Œå·ä¸æ–‡æœ¬è·¨è¡Œï¼Œéœ€è¦è¿›è¡Œåˆå¹¶å¤„ç†ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sed <span class="string">&#x27;=&#x27;</span> data.txt | sed <span class="string">&#x27;N; s/\n/ /g&#x27;</span></span><br><span class="line">1 This is the header line.</span><br><span class="line">2 This is the first data line.</span><br><span class="line">3 This is the second data line.</span><br><span class="line">4 This is the last line.</span><br></pre></td></tr></table></figure><p>å‘½ä»¤åˆ†è§£ï¼š</p><ul><li><code>N</code> å‘½ä»¤ï¼šå°†ä¸‹ä¸€è¡Œè¯»å–åˆ°æ¨¡å¼ç©ºé—´ï¼Œä¸å½“å‰è¡Œåˆå¹¶ï¼ˆç”¨æ¢è¡Œç¬¦åˆ†éš”ï¼‰</li><li><code>s/\n/ /g</code>ï¼šå°†æ¨¡å¼ç©ºé—´ä¸­çš„æ¢è¡Œç¬¦æ›¿æ¢ä¸ºç©ºæ ¼</li></ul><h2 id="æ’å…¥ç©ºç™½è¡Œ"><a href="#æ’å…¥ç©ºç™½è¡Œ" class="headerlink" title="æ’å…¥ç©ºç™½è¡Œ"></a>æ’å…¥ç©ºç™½è¡Œ</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sed <span class="string">&#x27;$!G&#x27;</span> data.txt</span><br><span class="line">This is the header line.</span><br><span class="line"></span><br><span class="line">This is the first data line.</span><br><span class="line"></span><br><span class="line">This is the second data line.</span><br><span class="line"></span><br><span class="line">This is the last line.</span><br></pre></td></tr></table></figure><p>å‘½ä»¤åˆ†è§£ï¼š</p><ul><li><code>$!</code>ï¼šè¡¨ç¤ºâ€é™¤äº†æœ€åä¸€è¡Œâ€</li><li><code>G</code>ï¼šå°†ä¿æŒç©ºé—´çš„å†…å®¹è¿½åŠ åˆ°æ¨¡å¼ç©ºé—´ï¼ˆé»˜è®¤ä¸ºç©ºè¡Œï¼‰</li></ul><p>ä¸Šé¢è¿™ä¸ªå‘½ä»¤ä¼šæœ‰ä¸€ç‚¹å°é—®é¢˜ï¼Œå¦‚æœæ–‡æœ¬è¡Œä¹‹é—´å·²ç»æœ‰ç©ºè¡Œï¼Œç©ºè¡Œä¼šåŠ å€ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># data.txt</span></span><br><span class="line">$ <span class="built_in">cat</span> data.txt</span><br><span class="line">This is the header line.</span><br><span class="line">This is the first data line.</span><br><span class="line"></span><br><span class="line">This is the second data line.</span><br><span class="line">This is the last line.</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ sed <span class="string">&#x27;$!G&#x27;</span> data.txt</span><br><span class="line">This is the header line.</span><br><span class="line"></span><br><span class="line">This is the first data line.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">This is the second data line.</span><br><span class="line"></span><br><span class="line">This is the last line.</span><br></pre></td></tr></table></figure><p>è§£å†³åŠæ³•æ˜¯å…ˆåˆ é™¤æ‰€æœ‰ç©ºç™½è¡Œå†æ’å…¥ç©ºç™½è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ sed <span class="string">&#x27;/^$/d; $!G&#x27;</span> data.txt</span><br><span class="line">This is the header line.</span><br><span class="line"></span><br><span class="line">This is the first data line.</span><br><span class="line"></span><br><span class="line">This is the second data line.</span><br><span class="line"></span><br><span class="line">This is the last line.</span><br></pre></td></tr></table></figure><h2 id="åˆ é™¤å¤šä½™çš„ç©ºç™½è¡Œ"><a href="#åˆ é™¤å¤šä½™çš„ç©ºç™½è¡Œ" class="headerlink" title="åˆ é™¤å¤šä½™çš„ç©ºç™½è¡Œ"></a>åˆ é™¤å¤šä½™çš„ç©ºç™½è¡Œ</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># data.txt</span></span><br><span class="line">$ <span class="built_in">cat</span> data.txt</span><br><span class="line">This is line one.</span><br><span class="line"></span><br><span class="line">This is line two.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">This is line three.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">This is line four.</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ sed <span class="string">&#x27;/./,/^$/!d&#x27;</span> data.txt</span><br><span class="line">This is line one.</span><br><span class="line"></span><br><span class="line">This is line two.</span><br><span class="line"></span><br><span class="line">This is line three.</span><br><span class="line"></span><br><span class="line">This is line four.</span><br></pre></td></tr></table></figure><p>å‘½ä»¤åˆ†è§£ï¼š</p><ul><li><code>/./,/^$/</code>ï¼šè¿™æ˜¯ä¸€ä¸ªåœ°å€èŒƒå›´ï¼ŒåŒ¹é…ä»éç©ºè¡Œï¼ˆåŒ…å«è‡³å°‘ä¸€ä¸ªå­—ç¬¦çš„è¡Œï¼‰åˆ°ç©ºè¡Œï¼ˆä¸åŒ…å«ä»»ä½•å­—ç¬¦çš„è¡Œï¼‰ä¹‹é—´çš„æ‰€æœ‰è¡Œ</li><li><code>!d</code>ï¼šå¯¹ä¸åŒ¹é…ä¸Šè¿°åœ°å€èŒƒå›´çš„è¡Œæ‰§è¡Œåˆ é™¤æ“ä½œï¼ˆ<code>d</code> å‘½ä»¤ï¼‰</li></ul><h2 id="åˆ é™¤ç»“å°¾çš„ç©ºç™½è¡Œ"><a href="#åˆ é™¤ç»“å°¾çš„ç©ºç™½è¡Œ" class="headerlink" title="åˆ é™¤ç»“å°¾çš„ç©ºç™½è¡Œ"></a>åˆ é™¤ç»“å°¾çš„ç©ºç™½è¡Œ</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># data.txt</span></span><br><span class="line">$ <span class="built_in">cat</span> data.txt</span><br><span class="line">This is the first line.</span><br><span class="line">This is the second line.</span><br><span class="line"><span class="comment"># ç©ºè¡Œ</span></span><br><span class="line"><span class="comment"># ç©ºè¡Œ</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ sed <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">&gt; :start</span></span><br><span class="line"><span class="string">&gt; /^\n*$/&#123;$d; N; b start&#125;</span></span><br><span class="line"><span class="string">&gt; &#125;&#x27;</span> data.txt</span><br><span class="line">This is the first line.</span><br><span class="line">This is the second line.</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸åŒLinuxç³»ç»Ÿï¼Œsedå‘½ä»¤å®ç°æ–¹å¼å¯èƒ½ç•¥å¾®æœ‰ç‚¹å·®å¼‚</span></span><br><span class="line">$ sed <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">:start</span></span><br><span class="line"><span class="string">/^\n*$/&#123;</span></span><br><span class="line"><span class="string">$d</span></span><br><span class="line"><span class="string">N</span></span><br><span class="line"><span class="string">b start</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span> data.txt</span><br><span class="line">This is the first line.</span><br><span class="line">This is the second line.</span><br></pre></td></tr></table></figure><h2 id="åˆ é™¤HMTLæ ‡ç­¾"><a href="#åˆ é™¤HMTLæ ‡ç­¾" class="headerlink" title="åˆ é™¤HMTLæ ‡ç­¾"></a>åˆ é™¤HMTLæ ‡ç­¾</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># data.txt</span></span><br><span class="line">$ <span class="built_in">cat</span> data.txt</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">&lt;title&gt;This is the page title&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;p&gt;</span><br><span class="line">This is the &lt;b&gt;first&lt;/b&gt; line <span class="keyword">in</span> the Web page.</span><br><span class="line">This should provide some &lt;i&gt;useful&lt;/i&gt;</span><br><span class="line">information to use <span class="keyword">in</span> our sed script.</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ sed <span class="string">&#x27;s/&lt;.*&gt;//g&#x27;</span> data13.txt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">This is the  line <span class="keyword">in</span> the Web page.</span><br><span class="line">This should provide some</span><br><span class="line">information to use <span class="keyword">in</span> our sed script.</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>/&lt;.*&gt;/</code>æ¨¡å¼ä¼šåŒ¹é…åˆ°<code>&lt;head&gt;</code>ã€<code>&lt;b&gt;first&lt;/b&gt;</code>ç­‰ï¼Œå› æ­¤ä¼šæŠŠ<code>&lt;head&gt;</code>ã€<code>&lt;b&gt;first&lt;/b&gt;</code>éƒ½æ›¿æ¢æˆç©ºå­—ç¬¦ã€‚ä¸ºäº†æ­£ç¡®åœ°åŒ¹é…æ ‡ç­¾ï¼Œ<code>&lt;</code>å’Œ<code>&gt;</code>ä¹‹é—´çš„å†…å®¹ä¸èƒ½åŒ…å«<code>&lt;</code>å’Œ<code>&gt;</code>ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ sed <span class="string">&#x27;s/&lt;[^&gt;]*&gt;//g&#x27;</span> data.txt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">This is the page title</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">This is the first line <span class="keyword">in</span> the Web page.</span><br><span class="line">This should provide some useful</span><br><span class="line">information to use <span class="keyword">in</span> our sed script.</span><br><span class="line"></span><br><span class="line">$ sed <span class="string">&#x27;s/&lt;[^&lt;]*&gt;//g&#x27;</span> data.txt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">This is the page title</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">This is the first line <span class="keyword">in</span> the Web page.</span><br><span class="line">This should provide some useful</span><br><span class="line">information to use <span class="keyword">in</span> our sed script.</span><br></pre></td></tr></table></figure><p>è¿›ä¸€æ­¥å¯ä»¥åˆ é™¤å¤šä½™çš„ç©ºç™½è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ sed <span class="string">&#x27;s/&lt;[^&lt;]*&gt;//g; /./,/^$/!d&#x27;</span> data.txt</span><br><span class="line">This is the page title</span><br><span class="line"></span><br><span class="line">This is the first line <span class="keyword">in</span> the Web page.</span><br><span class="line">This should provide some useful</span><br><span class="line">information to use <span class="keyword">in</span> our sed script.</span><br></pre></td></tr></table></figure><h2 id="æ‰“å°æœ«å°¾nè¡Œ"><a href="#æ‰“å°æœ«å°¾nè¡Œ" class="headerlink" title="æ‰“å°æœ«å°¾nè¡Œ"></a>æ‰“å°æœ«å°¾nè¡Œ</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> data.txt</span><br><span class="line">This is line 1.</span><br><span class="line">This is line 2.</span><br><span class="line">This is line 3.</span><br><span class="line">This is line 4.</span><br><span class="line">This is line 5.</span><br><span class="line">This is line 6.</span><br><span class="line">This is line 7.</span><br><span class="line">This is line 8.</span><br><span class="line">This is line 9.</span><br><span class="line">This is line 10.</span><br><span class="line">This is line 11.</span><br><span class="line">This is line 12.</span><br><span class="line">This is line 13.</span><br><span class="line">This is line 14.</span><br><span class="line">This is line 15.</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ sed <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">&gt; :start</span></span><br><span class="line"><span class="string">&gt; $q; N; 11,$D</span></span><br><span class="line"><span class="string">&gt; b start</span></span><br><span class="line"><span class="string">&gt; &#125;&#x27;</span> data.txt</span><br><span class="line">This is line 6.</span><br><span class="line">This is line 7.</span><br><span class="line">This is line 8.</span><br><span class="line">This is line 9.</span><br><span class="line">This is line 10.</span><br><span class="line">This is line 11.</span><br><span class="line">This is line 12.</span><br><span class="line">This is line 13.</span><br><span class="line">This is line 14.</span><br><span class="line">This is line 15.</span><br></pre></td></tr></table></figure><p>å‘½ä»¤åˆ†è§£ï¼š</p><ul><li><code>:start</code>ï¼šå®šä¹‰ä¸€ä¸ªæ ‡ç­¾ â€œstartâ€</li><li><code>$q</code>ï¼šå¦‚æœæ˜¯æœ€åä¸€è¡Œï¼Œåˆ™é€€å‡ºï¼ˆquitï¼‰</li><li><code>N</code>ï¼šå°†ä¸‹ä¸€è¡Œè¯»å–åˆ°æ¨¡å¼ç©ºé—´ï¼Œä¸å½“å‰è¡Œåˆå¹¶</li><li><code>11,$D</code>ï¼šå¯¹äºç¬¬11è¡Œåˆ°æœ€åä¸€è¡Œçš„èŒƒå›´ï¼Œåˆ é™¤æ¨¡å¼ç©ºé—´çš„ç¬¬ä¸€è¡Œï¼ˆç›´åˆ°æ¢è¡Œç¬¦ï¼‰</li><li><code>b start</code>ï¼šæ— æ¡ä»¶è·³è½¬ï¼ˆbranchï¼‰åˆ° â€œstartâ€ æ ‡ç­¾</li></ul><h2 id="æ‰¹é‡é‡å‘½åæ–‡ä»¶-1"><a href="#æ‰¹é‡é‡å‘½åæ–‡ä»¶-1" class="headerlink" title="æ‰¹é‡é‡å‘½åæ–‡ä»¶"></a>æ‰¹é‡é‡å‘½åæ–‡ä»¶</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># æ‰¹é‡é‡å‘½åæ–‡ä»¶å·¥å…·</span></span><br><span class="line"><span class="comment"># æ”¯æŒåŠŸèƒ½ï¼š</span></span><br><span class="line"><span class="comment"># 1. æ·»åŠ å‰ç¼€</span></span><br><span class="line"><span class="comment"># 2. æ·»åŠ åç¼€</span></span><br><span class="line"><span class="comment"># 3. æ›¿æ¢æ–‡æœ¬</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯</span></span><br><span class="line"><span class="function"><span class="title">show_help</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;ç”¨æ³•: <span class="variable">$0</span> [é€‰é¡¹] ç›®å½•è·¯å¾„&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;é€‰é¡¹:&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  -p, --prefix PREFIX    æ·»åŠ å‰ç¼€&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  -s, --suffix SUFFIX    æ·»åŠ åç¼€ï¼ˆåœ¨æ‰©å±•åä¹‹å‰ï¼‰&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  -f, --find TEXT        è¦æŸ¥æ‰¾çš„æ–‡æœ¬&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  -r, --replace TEXT     è¦æ›¿æ¢çš„æ–‡æœ¬&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  -d, --dry-run          è¯•è¿è¡Œï¼Œåªæ˜¾ç¤ºå°†è¦é‡å‘½åçš„æ–‡ä»¶ï¼Œä¸å®é™…æ‰§è¡Œ&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  -h, --help             æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯&quot;</span></span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;ç¤ºä¾‹:&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  <span class="variable">$0</span> -p \&quot;vacation_\&quot; -s \&quot;_2023\&quot; /path/to/photos&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  <span class="variable">$0</span> -f \&quot;IMG\&quot; -r \&quot;Photo\&quot; --dry-run /path/to/files&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆå§‹åŒ–å˜é‡</span></span><br><span class="line">PREFIX=<span class="string">&quot;&quot;</span></span><br><span class="line">SUFFIX=<span class="string">&quot;&quot;</span></span><br><span class="line">FIND_TEXT=<span class="string">&quot;&quot;</span></span><br><span class="line">REPLACE_TEXT=<span class="string">&quot;&quot;</span></span><br><span class="line">DRY_RUN=<span class="literal">false</span></span><br><span class="line">TARGET_DIR=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è§£æå‘½ä»¤è¡Œå‚æ•°</span></span><br><span class="line"><span class="keyword">while</span> [[ <span class="variable">$#</span> -gt 0 ]]; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">        -p|--prefix)</span><br><span class="line">            PREFIX=<span class="string">&quot;<span class="variable">$2</span>&quot;</span></span><br><span class="line">            <span class="built_in">shift</span></span><br><span class="line">            <span class="built_in">shift</span></span><br><span class="line">            ;;</span><br><span class="line">        -s|--suffix)</span><br><span class="line">            SUFFIX=<span class="string">&quot;<span class="variable">$2</span>&quot;</span></span><br><span class="line">            <span class="built_in">shift</span></span><br><span class="line">            <span class="built_in">shift</span></span><br><span class="line">            ;;</span><br><span class="line">        -f|--find)</span><br><span class="line">            FIND_TEXT=<span class="string">&quot;<span class="variable">$2</span>&quot;</span></span><br><span class="line">            <span class="built_in">shift</span></span><br><span class="line">            <span class="built_in">shift</span></span><br><span class="line">            ;;</span><br><span class="line">        -r|--replace)</span><br><span class="line">            REPLACE_TEXT=<span class="string">&quot;<span class="variable">$2</span>&quot;</span></span><br><span class="line">            <span class="built_in">shift</span></span><br><span class="line">            <span class="built_in">shift</span></span><br><span class="line">            ;;</span><br><span class="line">        -d|--dry-run)</span><br><span class="line">            DRY_RUN=<span class="literal">true</span></span><br><span class="line">            <span class="built_in">shift</span></span><br><span class="line">            ;;</span><br><span class="line">        -h|--<span class="built_in">help</span>)</span><br><span class="line">            show_help</span><br><span class="line">            <span class="built_in">exit</span> 0</span><br><span class="line">            ;;</span><br><span class="line">        -*)</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;æœªçŸ¥é€‰é¡¹: <span class="variable">$1</span>&quot;</span></span><br><span class="line">            show_help</span><br><span class="line">            <span class="built_in">exit</span> 1</span><br><span class="line">            ;;</span><br><span class="line">        *)</span><br><span class="line">            TARGET_DIR=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">            <span class="built_in">shift</span></span><br><span class="line">            ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥ç›®æ ‡ç›®å½•</span></span><br><span class="line"><span class="keyword">if</span> [[ -z <span class="string">&quot;<span class="variable">$TARGET_DIR</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;é”™è¯¯ï¼šå¿…é¡»æŒ‡å®šç›®å½•è·¯å¾„&quot;</span></span><br><span class="line">    show_help</span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ ! -d <span class="string">&quot;<span class="variable">$TARGET_DIR</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;é”™è¯¯ï¼šç›®å½• &#x27;<span class="variable">$TARGET_DIR</span>&#x27; ä¸å­˜åœ¨&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿›å…¥ç›®æ ‡ç›®å½•</span></span><br><span class="line"><span class="built_in">cd</span> <span class="string">&quot;<span class="variable">$TARGET_DIR</span>&quot;</span> || <span class="built_in">exit</span> 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¡æ•°å™¨</span></span><br><span class="line">count=0</span><br><span class="line">total=0</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ç›®æ ‡ç›®å½•: <span class="variable">$TARGET_DIR</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;æ¨¡å¼: å‰ç¼€=&#x27;<span class="variable">$PREFIX</span>&#x27;, åç¼€=&#x27;<span class="variable">$SUFFIX</span>&#x27;, æŸ¥æ‰¾=&#x27;<span class="variable">$FIND_TEXT</span>&#x27;, æ›¿æ¢=&#x27;<span class="variable">$REPLACE_TEXT</span>&#x27;&quot;</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$DRY_RUN</span>&quot;</span> = <span class="literal">true</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;æ¨¡å¼: è¯•è¿è¡Œ&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤„ç†æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> *; <span class="keyword">do</span></span><br><span class="line">    <span class="comment"># è·³è¿‡ç›®å½•</span></span><br><span class="line">    <span class="keyword">if</span> [[ -d <span class="string">&quot;<span class="variable">$file</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">continue</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    total=$((total + <span class="number">1</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è·å–æ–‡ä»¶åå’Œæ‰©å±•å</span></span><br><span class="line">    filename=<span class="string">&quot;<span class="variable">$file</span>&quot;</span></span><br><span class="line">    extension=<span class="string">&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å¤„ç†åç¼€æ—¶ï¼Œéœ€è¦åˆ†ç¦»æ‰©å±•å</span></span><br><span class="line">    <span class="keyword">if</span> [[ -n <span class="string">&quot;<span class="variable">$SUFFIX</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        base_name=<span class="string">&quot;<span class="variable">$&#123;file%.*&#125;</span>&quot;</span></span><br><span class="line">        extension=<span class="string">&quot;<span class="variable">$&#123;file##*.&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å¦‚æœæ–‡ä»¶æ²¡æœ‰æ‰©å±•åæˆ–è€…æ‰©å±•åä¸æ–‡ä»¶åç›¸åŒï¼ˆå¦‚ç‚¹æ–‡ä»¶ï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$base_name</span>&quot;</span> = <span class="string">&quot;&quot;</span> || <span class="string">&quot;<span class="variable">$base_name</span>&quot;</span> = <span class="string">&quot;<span class="variable">$file</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">            base_name=<span class="string">&quot;<span class="variable">$file</span>&quot;</span></span><br><span class="line">            extension=<span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            extension=<span class="string">&quot;.<span class="variable">$extension</span>&quot;</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        base_name=<span class="string">&quot;<span class="variable">$file</span>&quot;</span></span><br><span class="line">        extension=<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ›¿æ¢æ–‡æœ¬</span></span><br><span class="line">    new_base_name=<span class="string">&quot;<span class="variable">$base_name</span>&quot;</span></span><br><span class="line">    <span class="keyword">if</span> [[ -n <span class="string">&quot;<span class="variable">$FIND_TEXT</span>&quot;</span> &amp;&amp; -n <span class="string">&quot;<span class="variable">$REPLACE_TEXT</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        new_base_name=<span class="string">&quot;<span class="variable">$&#123;base_name//$FIND_TEXT/$REPLACE_TEXT&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ·»åŠ å‰ç¼€å’Œåç¼€</span></span><br><span class="line">    new_name=<span class="string">&quot;<span class="variable">$&#123;PREFIX&#125;</span><span class="variable">$&#123;new_base_name&#125;</span><span class="variable">$&#123;SUFFIX&#125;</span><span class="variable">$&#123;extension&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å¦‚æœæ–‡ä»¶åæœ‰å˜åŒ–ï¼Œåˆ™é‡å‘½å</span></span><br><span class="line">    <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$new_name</span>&quot;</span> != <span class="string">&quot;<span class="variable">$file</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;é‡å‘½å: <span class="variable">$file</span> -&gt; <span class="variable">$new_name</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ£€æŸ¥æ–°æ–‡ä»¶åæ˜¯å¦å·²å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span> [[ -e <span class="string">&quot;<span class="variable">$new_name</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;è­¦å‘Šï¼šç›®æ ‡æ–‡ä»¶å·²å­˜åœ¨ï¼Œè·³è¿‡: <span class="variable">$new_name</span>&quot;</span></span><br><span class="line">            <span class="built_in">continue</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$DRY_RUN</span>&quot;</span> = <span class="literal">false</span> ]]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">mv</span> -- <span class="string">&quot;<span class="variable">$file</span>&quot;</span> <span class="string">&quot;<span class="variable">$new_name</span>&quot;</span></span><br><span class="line">            <span class="keyword">if</span> [[ $? -eq 0 ]]; <span class="keyword">then</span></span><br><span class="line">                count=$((count + <span class="number">1</span>))</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&quot;é”™è¯¯ï¼šé‡å‘½åå¤±è´¥: <span class="variable">$file</span>&quot;</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;æ— å˜åŒ–: <span class="variable">$file</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;æ“ä½œå®Œæˆã€‚å…±å¤„ç† <span class="variable">$total</span> ä¸ªæ–‡ä»¶ï¼ŒæˆåŠŸé‡å‘½å <span class="variable">$count</span> ä¸ªæ–‡ä»¶&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ·»åŠ å‰ç¼€</span></span><br><span class="line">./rename_files.sh -p <span class="string">&quot;vacation_&quot;</span> /path/to/files</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ åç¼€</span></span><br><span class="line">./rename_files.sh -s <span class="string">&quot;_2023&quot;</span> /path/to/files</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ›¿æ¢æ–‡æœ¬</span></span><br><span class="line">./rename_files.sh -f <span class="string">&quot;IMG&quot;</span> -r <span class="string">&quot;Photo&quot;</span> /path/to/files</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯•è¿è¡Œï¼ˆä¸å®é™…é‡å‘½åï¼‰</span></span><br><span class="line">./rename_files.sh -f <span class="string">&quot;old&quot;</span> -r <span class="string">&quot;new&quot;</span> -d /path/to/files</span><br></pre></td></tr></table></figure><h1 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h1><h2 id="æ‰¹é‡åˆ é™¤åˆ†æ”¯"><a href="#æ‰¹é‡åˆ é™¤åˆ†æ”¯" class="headerlink" title="æ‰¹é‡åˆ é™¤åˆ†æ”¯"></a>æ‰¹é‡åˆ é™¤åˆ†æ”¯</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git branch | grep <span class="string">&#x27;feature_&#x27;</span> | xargs git branch -d/-D</span><br></pre></td></tr></table></figure><h2 id="ç»Ÿè®¡ä»£ç é‡"><a href="#ç»Ÿè®¡ä»£ç é‡" class="headerlink" title="ç»Ÿè®¡ä»£ç é‡"></a>ç»Ÿè®¡ä»£ç é‡</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">log</span> --since=<span class="string">&quot;2021-08-01&quot;</span> --<span class="keyword">until</span>==<span class="string">&quot;2023-05-31&quot;</span> --author=<span class="string">&quot;linfeng&quot;</span> --pretty=format: --numstat | awk <span class="string">&#x27; &#123; add += $1; subs += $2; loc += $1 - $2 &#125; END &#123; printf &quot;added lines: %s, removed lines: %s, total lines: %sn&quot;, add, subs, loc &#125;&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="æ¸…ç†åŒ…å«æ•æ„Ÿä¿¡æ¯çš„æäº¤"><a href="#æ¸…ç†åŒ…å«æ•æ„Ÿä¿¡æ¯çš„æäº¤" class="headerlink" title="æ¸…ç†åŒ…å«æ•æ„Ÿä¿¡æ¯çš„æäº¤"></a>æ¸…ç†åŒ…å«æ•æ„Ÿä¿¡æ¯çš„æäº¤</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">1. åˆ—å‡ºæ‰€æœ‰åŒ…å«æ•æ„Ÿä¿¡æ¯æäº¤çš„åˆ†æ”¯æˆ–tagï¼š`git branch(tag) -a --contains commitID`</span><br><span class="line"></span><br><span class="line">2. ç¼–å†™replacements.txtï¼Œå†…å®¹ï¼šæ•æ„Ÿä¿¡æ¯==&gt;æ›¿æ¢æ–‡æœ¬</span><br><span class="line"></span><br><span class="line">3. åˆ©ç”¨replacements.txtæ›¿æ¢æœ¬åœ°ä»“åº“æ‰€æœ‰çš„æ•æ„Ÿä¿¡æ¯ï¼š`git filter-repo --replace-text replacements.txt(å®Œæ•´è·¯å¾„) --replace-refs delete-no-add --force`</span><br><span class="line"></span><br><span class="line">4. ä¸Šä¸€æ­¥ä¼šåˆ é™¤å¯¹è¿œç¨‹ä»“åº“çš„è·Ÿè¸ªï¼Œæ‰§è¡Œ `git remote add origin ä»“åº“åœ°å€` é‡æ–°è·Ÿè¸ª</span><br><span class="line"></span><br><span class="line">5. `git push origin åˆ†æ”¯ï¼ˆç¬¬1æ­¥æŸ¥å‡ºæ¥çš„åˆ†æ”¯ï¼‰ --force`</span><br><span class="line"></span><br><span class="line">   å¦‚æœåˆ†æ”¯æœ‰å…±æ€§ï¼Œæ¯”å¦‚éƒ½ä»¥featureå¼€å¤´ï¼Œå¯ä»¥ç”¨ä»¥ä¸‹è„šæœ¬å¿«é€Ÿpushï¼ˆéœ€åœ¨æœ¬åœ°ä»“åº“çš„æ ¹ç›®å½•ä¸‹æ‰§è¡Œï¼‰</span><br><span class="line"></span><br><span class="line">```bash</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="keyword">for</span> branch <span class="keyword">in</span> $(git for-each-ref --format=<span class="string">&quot;%(refname:short)&quot;</span> refs/heads/feature/*)</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;å¼ºåˆ¶æ¨é€åˆ†æ”¯:<span class="variable">$branch</span>&quot;</span></span><br><span class="line">  git push origin <span class="string">&quot;<span class="variable">$branch</span>:<span class="variable">$branch</span>&quot;</span> --force</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">```</span><br><span class="line"></span><br><span class="line">å¦‚æœå†å²æäº¤çš„æ•æ„Ÿä¿¡æ¯æ‰€åœ¨æ–‡ä»¶ä¸ºconfig.ymlï¼Œä½†æ˜¯åæ¥æ–‡ä»¶é‡å‘½åä¸ºconf.ymlï¼Œä»¥ä¸Šå‘½ä»¤å°±æ— æ³•æœ‰æ•ˆæ¸…ç†é‚£äº›åŒ…å«æ•æ„Ÿä¿¡æ¯çš„å†å²æäº¤ã€‚å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç›´æ¥åˆ é™¤å†å²æäº¤ä¸­çš„æ•æ„Ÿæ–‡ä»¶ï¼š</span><br><span class="line"></span><br><span class="line">`git filter-repo --path æ–‡ä»¶å --invert-paths --replace-refs delete-no-add --force` </span><br></pre></td></tr></table></figure><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>è®¾è®¡æ¨¡å¼</title>
      <link href="/post/8f20a568.html"/>
      <url>/post/8f20a568.html</url>
      
        <content type="html"><![CDATA[<h2 id="åˆ›å»ºå‹æ¨¡å¼"><a href="#åˆ›å»ºå‹æ¨¡å¼" class="headerlink" title="åˆ›å»ºå‹æ¨¡å¼"></a>åˆ›å»ºå‹æ¨¡å¼</h2><h2 id="ç»“æ„å‹æ¨¡å¼"><a href="#ç»“æ„å‹æ¨¡å¼" class="headerlink" title="ç»“æ„å‹æ¨¡å¼"></a>ç»“æ„å‹æ¨¡å¼</h2><h2 id="è¡Œä¸ºå‹æ¨¡å¼"><a href="#è¡Œä¸ºå‹æ¨¡å¼" class="headerlink" title="è¡Œä¸ºå‹æ¨¡å¼"></a>è¡Œä¸ºå‹æ¨¡å¼</h2><h3 id="ç­–ç•¥æ¨¡å¼-Strategy-Pattern"><a href="#ç­–ç•¥æ¨¡å¼-Strategy-Pattern" class="headerlink" title="ç­–ç•¥æ¨¡å¼ (Strategy Pattern)"></a><strong>ç­–ç•¥æ¨¡å¼ (Strategy Pattern)</strong></h3><ul><li><strong>æ„å›¾ï¼š</strong> å®šä¹‰ä¸€ç³»åˆ—ç®—æ³•ï¼Œå°†å®ƒä»¬å°è£…èµ·æ¥ï¼Œå¹¶ä¸”ä½¿å®ƒä»¬å¯ä»¥ç›¸äº’æ›¿æ¢ã€‚ç­–ç•¥æ¨¡å¼è®©ç®—æ³•çš„å˜åŒ–ç‹¬ç«‹äºä½¿ç”¨å®ƒçš„å®¢æˆ·ã€‚</li><li><strong>å¦‚ä½•å·¥ä½œï¼š</strong><ul><li>å®šä¹‰ä¸€ä¸ª<code>Strategy</code>æ¥å£ï¼Œå£°æ˜æ‰€æœ‰æ”¯æŒçš„ç®—æ³•çš„å…¬å…±æ–¹æ³•ã€‚</li><li>åˆ›å»ºå¤šä¸ªå…·ä½“çš„ç­–ç•¥ç±»(<code>ConcreteStrategyA</code>, <code>ConcreteStrategyB</code>ç­‰)ï¼Œæ¯ä¸ªç±»å®ç°<code>Strategy</code>æ¥å£å¹¶æä¾›è¯¥ç®—æ³•çš„å…·ä½“å®ç°ã€‚</li><li>å®šä¹‰ä¸€ä¸ª<code>Context</code>ç±»ã€‚å®ƒåŒ…å«ä¸€ä¸ªå¯¹<code>Strategy</code>å¯¹è±¡çš„å¼•ç”¨(<code>strategy</code>)ã€‚<code>Context</code>å¯ä»¥å®šä¹‰ä¸€ä¸ªæ¥å£è®©å¤–éƒ¨è®¾ç½®å®ƒæ‰€ä½¿ç”¨çš„ç­–ç•¥å¯¹è±¡ï¼ˆé€šå¸¸é€šè¿‡æ„é€ å‡½æ•°æˆ–setteræ–¹æ³•æ³¨å…¥ï¼‰ã€‚</li><li><code>Context</code>ç±»å°†å®¢æˆ·ç«¯çš„è¯·æ±‚<strong>å§”æ‰˜</strong>ç»™å®ƒæŒæœ‰çš„<code>Strategy</code>å¯¹è±¡æ¥æ‰§è¡Œå…·ä½“çš„ç®—æ³•ã€‚<code>Context</code>å¹¶ä¸å…³å¿ƒå½“å‰ä½¿ç”¨çš„æ˜¯å“ªä¸ªå…·ä½“ç­–ç•¥ï¼Œå®ƒåªé€šè¿‡æ¥å£ä¸ç­–ç•¥äº¤äº’ã€‚</li></ul></li><li><strong>é€‚ç”¨åœºæ™¯ï¼š</strong><ul><li><strong>éœ€è¦åœ¨è¿è¡Œæ—¶åŠ¨æ€é€‰æ‹©ç®—æ³•æ—¶ï¼š</strong> ä¾‹å¦‚ï¼Œæ ¹æ®ç”¨æˆ·é€‰æ‹©ã€é…ç½®ã€ç³»ç»ŸçŠ¶æ€ç­‰åˆ‡æ¢ä¸åŒçš„æ’åºç®—æ³•ï¼ˆå¿«é€Ÿæ’åºã€å½’å¹¶æ’åºã€å†’æ³¡æ’åºï¼‰ã€ä¸åŒçš„æ”¯ä»˜æ–¹å¼ï¼ˆä¿¡ç”¨å¡ã€PayPalã€åŠ å¯†è´§å¸ï¼‰ã€ä¸åŒçš„å‹ç¼©ç®—æ³•ï¼ˆZIPã€RARã€7zï¼‰ã€ä¸åŒçš„æŠ˜æ‰£è®¡ç®—è§„åˆ™ç­‰ã€‚</li><li><strong>ä¸€ä¸ªç±»å®šä¹‰äº†å¤šç§è¡Œä¸ºï¼Œå¹¶ä¸”è¿™äº›è¡Œä¸ºåœ¨ç±»ä¸­ä»¥å¤šä¸ªæ¡ä»¶è¯­å¥çš„å½¢å¼å‡ºç°ï¼š</strong> å¯ä»¥å°†æ¯ä¸ªåˆ†æ”¯ç§»å…¥å®ƒä»¬å„è‡ªçš„ç­–ç•¥ç±»ä¸­ï¼Œæ¶ˆé™¤å¤æ‚çš„æ¡ä»¶é€»è¾‘ã€‚</li><li><strong>éœ€è¦éš”ç¦»ç®—æ³•é€»è¾‘å’Œä½¿ç”¨ç®—æ³•çš„ä»£ç ï¼š</strong> ç®—æ³•å®ç°ç»†èŠ‚è¢«å°è£…åœ¨å…·ä½“çš„ç­–ç•¥ç±»ä¸­ï¼Œ<code>Context</code>åªä¾èµ–æ¥å£ï¼Œç¬¦åˆä¾èµ–å€’ç½®åŸåˆ™ã€‚</li><li><strong>æœ‰å¤§é‡ç›¸å…³çš„ç±»ï¼Œä»…åœ¨è¡Œä¸ºä¸Šæœ‰æ‰€ä¸åŒï¼š</strong> ç­–ç•¥æ¨¡å¼æä¾›äº†ä¸€ç§ç”¨å¤šä¸ªè¡Œä¸ºé…ç½®ä¸€ä¸ªç±»çš„æ–¹æ³•ã€‚</li><li><strong>éœ€è¦æä¾›ç®—æ³•çš„å¤šç§å®ç°ï¼Œå¹¶ä¸”å¸Œæœ›å®¢æˆ·ç«¯èƒ½å¤Ÿè½»æ¾åœ°åœ¨å®ƒä»¬ä¹‹é—´åˆ‡æ¢ã€‚</strong></li></ul></li><li><strong>ä¼˜ç‚¹ï¼š</strong> ç®—æ³•å¯è‡ªç”±åˆ‡æ¢ï¼›é¿å…ä½¿ç”¨å¤šé‡æ¡ä»¶åˆ¤æ–­ï¼›æ‰©å±•æ€§å¥½ï¼ˆæ–°å¢ç­–ç•¥å®¹æ˜“ï¼‰ï¼›ç¬¦åˆå¼€é—­åŸåˆ™ï¼›ç®—æ³•å¤ç”¨ï¼ˆå¦‚æœå¤šä¸ªä¸Šä¸‹æ–‡éœ€è¦ç›¸åŒç®—æ³•ï¼‰ã€‚</li><li><strong>ç¼ºç‚¹ï¼š</strong> å®¢æˆ·ç«¯å¿…é¡»äº†è§£ä¸åŒç­–ç•¥çš„åŒºåˆ«ä»¥é€‰æ‹©åˆé€‚çš„ç­–ç•¥ï¼ˆå¯èƒ½å¼•å…¥é€‰æ‹©é€»è¾‘ï¼‰ï¼›å¢åŠ äº†ç­–ç•¥ç±»å’Œå¯¹è±¡çš„æ•°é‡ï¼›ç­–ç•¥é—´çš„é€šä¿¡å¯èƒ½éœ€è¦é€šè¿‡<code>Context</code>ä¼ é€’æ•°æ®ï¼Œæˆ–è€…ç­–ç•¥æœ¬èº«éœ€è¦è®¿é—®<code>Context</code>çš„çŠ¶æ€ï¼ˆå¯èƒ½å¢åŠ è€¦åˆï¼‰ã€‚</li></ul><h3 id="æ¨¡æ¿æ–¹æ³•æ¨¡å¼-Template-Method-Pattern"><a href="#æ¨¡æ¿æ–¹æ³•æ¨¡å¼-Template-Method-Pattern" class="headerlink" title="æ¨¡æ¿æ–¹æ³•æ¨¡å¼ (Template Method Pattern)"></a><strong>æ¨¡æ¿æ–¹æ³•æ¨¡å¼ (Template Method Pattern)</strong></h3><ul><li><strong>æ„å›¾ï¼š</strong> å®šä¹‰ä¸€ä¸ªæ“ä½œä¸­çš„ç®—æ³•éª¨æ¶ï¼Œè€Œå°†ä¸€äº›æ­¥éª¤å»¶è¿Ÿåˆ°å­ç±»ä¸­å®ç°ã€‚æ¨¡æ¿æ–¹æ³•ä½¿å¾—å­ç±»å¯ä»¥ä¸æ”¹å˜ä¸€ä¸ªç®—æ³•çš„ç»“æ„å³å¯é‡æ–°å®šä¹‰è¯¥ç®—æ³•çš„æŸäº›ç‰¹å®šæ­¥éª¤ã€‚</li><li><strong>å¦‚ä½•å·¥ä½œï¼š</strong><ul><li>å®šä¹‰ä¸€ä¸ª<code>AbstractClass</code>ï¼ˆæŠ½è±¡ç±»ï¼‰ã€‚å®ƒåŒ…å«ï¼š<ul><li><strong>æ¨¡æ¿æ–¹æ³•(<code>templateMethod()</code>):</strong> è¿™æ˜¯ä¸€ä¸ª<strong>å…·ä½“æ–¹æ³•</strong>ï¼Œå®šä¹‰äº†ç®—æ³•çš„éª¨æ¶&#x2F;æ­¥éª¤é¡ºåºã€‚å®ƒæŒ‰é¡ºåºè°ƒç”¨å…¶ä»–æ–¹æ³•ï¼ˆåŒ…æ‹¬æŠ½è±¡æ–¹æ³•ã€å…·ä½“æ–¹æ³•å’Œé’©å­æ–¹æ³•ï¼‰ã€‚</li><li><strong>åŸè¯­æ“ä½œ(<code>primitiveOperationX()</code>):</strong> è¿™äº›æ˜¯<strong>æŠ½è±¡æ–¹æ³•</strong>ï¼Œä»£è¡¨ç®—æ³•ä¸­éœ€è¦å­ç±»æä¾›å…·ä½“å®ç°çš„<strong>å¯å˜æ­¥éª¤</strong>ã€‚å®ƒä»¬æ˜¯ç®—æ³•éª¨æ¶ä¸­çš„â€œå ä½ç¬¦â€ã€‚</li><li><strong>å…·ä½“æ–¹æ³•(<code>concreteOperation()</code>):</strong> åœ¨æŠ½è±¡ç±»ä¸­å·²ç»å®ç°çš„æ–¹æ³•ï¼Œä»£è¡¨ç®—æ³•éª¨æ¶ä¸­<strong>å›ºå®šä¸å˜</strong>çš„æ­¥éª¤ï¼Œæ‰€æœ‰å­ç±»å…±äº«ã€‚æ¨¡æ¿æ–¹æ³•ä¼šè°ƒç”¨å®ƒä»¬ã€‚</li><li><strong>é’©å­æ–¹æ³•(<code>hook()</code>):</strong> ï¼ˆå¯é€‰ï¼‰åœ¨æŠ½è±¡ç±»ä¸­æä¾›<strong>é»˜è®¤å®ç°</strong>ï¼ˆé€šå¸¸æ˜¯ç©ºå®ç°æˆ–è¿”å›é»˜è®¤å€¼ï¼‰çš„<strong>å…·ä½“æ–¹æ³•</strong>ã€‚å­ç±»å¯ä»¥é€‰æ‹©æ€§åœ°è¦†ç›–å®ƒä»¬ä»¥åœ¨ç®—æ³•æµç¨‹çš„ç‰¹å®šç‚¹æ’å…¥è‡ªå·±çš„é€»è¾‘ï¼Œä½†ä¸æ”¹å˜ä¸»è¦æµç¨‹ã€‚å®ƒä»¬ä¸ºå­ç±»æä¾›é¢å¤–çš„æ‰©å±•ç‚¹ã€‚</li></ul></li><li>åˆ›å»ºå…·ä½“çš„å­ç±»(<code>ConcreteClassA</code>, <code>ConcreteClassB</code>ç­‰)ï¼Œç»§æ‰¿è‡ª<code>AbstractClass</code>ã€‚</li><li>å­ç±»<strong>å¿…é¡»</strong>å®ç°çˆ¶ç±»ä¸­å®šä¹‰çš„æ‰€æœ‰<strong>æŠ½è±¡æ–¹æ³•ï¼ˆåŸè¯­æ“ä½œï¼‰</strong>ã€‚å®ƒä»¬<strong>å¯ä»¥</strong>é€‰æ‹©è¦†ç›–çˆ¶ç±»çš„<strong>å…·ä½“æ–¹æ³•</strong>æˆ–<strong>é’©å­æ–¹æ³•</strong>ï¼ˆä½†é€šå¸¸ä¸é¼“åŠ±è¦†ç›–å…·ä½“æ–¹æ³•ï¼Œé™¤éæ˜ç¡®è®¾è®¡ä¸ºå¯è¦†ç›–ï¼‰ã€‚</li></ul></li><li><strong>é€‚ç”¨åœºæ™¯ï¼š</strong><ul><li><strong>æœ‰å¤šä¸ªå­ç±»å…±æœ‰ç›¸åŒçš„è¡Œä¸ºé€»è¾‘ï¼ˆç®—æ³•éª¨æ¶ï¼‰ï¼Œä½†å…¶ä¸­æŸäº›å…·ä½“æ­¥éª¤çš„å®ç°ä¸åŒæ—¶ï¼š</strong> ä¾‹å¦‚ï¼Œä¸åŒç±»å‹çš„æ–‡æ¡£å¯¼å‡ºï¼ˆPDFExport, WordExportï¼‰éƒ½æœ‰å›ºå®šçš„æµç¨‹ï¼ˆå‡†å¤‡æ•°æ®ã€ç”Ÿæˆå†…å®¹ã€æ·»åŠ é¡µçœ‰é¡µè„šã€ä¿å­˜æ–‡ä»¶ï¼‰ï¼Œä½†â€œç”Ÿæˆå†…å®¹â€å’Œâ€œä¿å­˜æ–‡ä»¶â€çš„å…·ä½“æ­¥éª¤ä¸åŒã€‚</li><li><strong>éœ€è¦æ§åˆ¶å­ç±»æ‰©å±•çš„ç‚¹æ—¶ï¼š</strong> çˆ¶ç±»é€šè¿‡å®šä¹‰åŸè¯­æ“ä½œå’Œé’©å­æ–¹æ³•ï¼Œç²¾ç¡®åœ°æŒ‡å®šäº†å­ç±»å¯ä»¥æ”¹å˜ç®—æ³•çš„å“ªäº›éƒ¨åˆ†ï¼ˆæ­¥éª¤å®ç°ï¼‰ï¼Œå“ªäº›éƒ¨åˆ†ä¸èƒ½æ”¹å˜ï¼ˆæ­¥éª¤é¡ºåºå’Œå›ºå®šæ­¥éª¤ï¼‰ã€‚</li><li><strong>ä»£ç å¤ç”¨ï¼š</strong> å°†å…¬å…±çš„ã€ä¸å˜çš„è¡Œä¸ºæå‡åˆ°çˆ¶ç±»ä¸­ï¼Œé¿å…ä»£ç é‡å¤ã€‚</li><li><strong>æ¡†æ¶è®¾è®¡ï¼š</strong> æ¡†æ¶å®šä¹‰æ ¸å¿ƒæµç¨‹ï¼ˆæ¨¡æ¿æ–¹æ³•ï¼‰ï¼Œç”¨æˆ·é€šè¿‡å®ç°ç‰¹å®šçš„æ­¥éª¤ï¼ˆåŸè¯­æ“ä½œï¼‰æ¥å®šåˆ¶æ¡†æ¶è¡Œä¸ºã€‚å¦‚Servletä¸­çš„<code>service()</code>æ–¹æ³•è°ƒç”¨<code>doGet()</code>&#x2F;<code>doPost()</code>ï¼ŒJUnitçš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•(<code>setUp()</code>, <code>testX()</code>, <code>tearDown()</code>)ã€‚</li></ul></li><li><strong>ä¼˜ç‚¹ï¼š</strong> ä»£ç å¤ç”¨åº¦é«˜ï¼ˆå…¬å…±éƒ¨åˆ†åœ¨çˆ¶ç±»ï¼‰ï¼›å°è£…ä¸å˜éƒ¨åˆ†ï¼Œæ‰©å±•å¯å˜éƒ¨åˆ†ï¼›çˆ¶ç±»æ§åˆ¶ç®—æ³•ç»“æ„ï¼Œå­ç±»ä¸“æ³¨äºç‰¹å®šæ­¥éª¤ï¼›é€šè¿‡é’©å­æ–¹æ³•æä¾›çµæ´»æ‰©å±•ç‚¹ã€‚</li><li><strong>ç¼ºç‚¹ï¼š</strong> å¯¹æ¯ä¸ªä¸åŒçš„å®ç°éƒ½éœ€è¦ä¸€ä¸ªå­ç±»ï¼Œå¯èƒ½å¯¼è‡´ç±»æ•°é‡å¢åŠ ï¼›å­ç±»å¯¹çˆ¶ç±»äº§ç”Ÿäº†ä¾èµ–ï¼ˆç»§æ‰¿çš„å¼ºè€¦åˆï¼‰ï¼›é€šè¿‡è¦†ç›–å…·ä½“æ–¹æ³•æ”¹å˜è¡Œä¸ºå¯èƒ½å¯¼è‡´æ„å¤–ç»“æœï¼ˆè¿åé‡Œæ°æ›¿æ¢åŸåˆ™ï¼‰ï¼›éª¨æ¶çš„ä¿®æ”¹å¯èƒ½å½±å“æ‰€æœ‰å­ç±»ã€‚</li></ul><h2 id="æ¨¡å¼æ¯”è¾ƒ"><a href="#æ¨¡å¼æ¯”è¾ƒ" class="headerlink" title="æ¨¡å¼æ¯”è¾ƒ"></a>æ¨¡å¼æ¯”è¾ƒ</h2><h3 id="ç­–ç•¥æ¨¡å¼vsæ¨¡æ¿æ–¹æ³•æ¨¡å¼"><a href="#ç­–ç•¥æ¨¡å¼vsæ¨¡æ¿æ–¹æ³•æ¨¡å¼" class="headerlink" title="ç­–ç•¥æ¨¡å¼vsæ¨¡æ¿æ–¹æ³•æ¨¡å¼"></a>ç­–ç•¥æ¨¡å¼vsæ¨¡æ¿æ–¹æ³•æ¨¡å¼</h3><p>ç­–ç•¥æ¨¡å¼å’Œæ¨¡æ¿æ–¹æ³•æ¨¡å¼éƒ½æ˜¯è¡Œä¸ºå‹è®¾è®¡æ¨¡å¼ï¼Œç”¨äºå°è£…å˜åŒ–çš„éƒ¨åˆ†ï¼Œä½†å®ƒä»¬è§£å†³é—®é¢˜çš„è§’åº¦å’Œå®ç°æ–¹å¼æœ‰æœ¬è´¨åŒºåˆ«ã€‚</p><p><strong>æ ¸å¿ƒåŒºåˆ«æ€»ç»“ï¼š</strong></p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">ç­–ç•¥æ¨¡å¼ (Strategy Pattern)</th><th align="left">æ¨¡æ¿æ–¹æ³•æ¨¡å¼ (Template Method Pattern)</th></tr></thead><tbody><tr><td align="left"><strong>æ ¸å¿ƒæ€æƒ³</strong></td><td align="left"><strong>å°è£…å¯äº’æ¢çš„ç®—æ³•æ—</strong>ï¼Œè®©å®¢æˆ·ç«¯æ ¹æ®éœ€è¦<strong>åŠ¨æ€é€‰æ‹©</strong>å…·ä½“ç®—æ³•ã€‚</td><td align="left"><strong>å®šä¹‰ç®—æ³•çš„éª¨æ¶</strong>ï¼Œå°†<strong>æŸäº›æ­¥éª¤</strong>å»¶è¿Ÿåˆ°å­ç±»ä¸­å®ç°ã€‚</td></tr><tr><td align="left"><strong>å…³æ³¨ç‚¹</strong></td><td align="left"><strong>ç®—æ³•å®ç°çš„å®Œæ•´æ›¿æ¢</strong>ã€‚</td><td align="left"><strong>ç®—æ³•ç»“æ„ï¼ˆæ­¥éª¤é¡ºåºï¼‰çš„å›ºå®šï¼Œæ­¥éª¤å®ç°çš„æ‰©å±•</strong>ã€‚</td></tr><tr><td align="left"><strong>å…³ç³»</strong></td><td align="left">**ç»„åˆ (Composition)**ï¼šä¸Šä¸‹æ–‡æŒæœ‰ç­–ç•¥æ¥å£å¼•ç”¨ã€‚</td><td align="left">**ç»§æ‰¿ (Inheritance)**ï¼šå­ç±»ç»§æ‰¿æŠ½è±¡çˆ¶ç±»ã€‚</td></tr><tr><td align="left"><strong>å˜åŒ–ç‚¹</strong></td><td align="left">æ•´ä¸ªç®—æ³•çš„<strong>å®ç°é€»è¾‘</strong>å¯ä»¥å®Œå…¨æ”¹å˜ã€‚</td><td align="left">ç®—æ³•<strong>éª¨æ¶ä¸å˜</strong>ï¼Œ<strong>ç‰¹å®šæ­¥éª¤çš„å®ç°</strong>å¯ä»¥æ”¹å˜ã€‚</td></tr><tr><td align="left"><strong>çµæ´»æ€§</strong></td><td align="left">è¿è¡Œæ—¶åŠ¨æ€åˆ‡æ¢ç­–ç•¥ï¼Œ<strong>æ›´çµæ´»</strong>ã€‚</td><td align="left">ç¼–è¯‘æ—¶é€šè¿‡å­ç±»ç¡®å®šè¡Œä¸ºï¼Œç›¸å¯¹é™æ€ã€‚</td></tr><tr><td align="left"><strong>å¼€é—­åŸåˆ™</strong></td><td align="left">æ·»åŠ æ–°ç­–ç•¥ä¸å½±å“ä¸Šä¸‹æ–‡ï¼Œ<strong>å¯¹æ‰©å±•å¼€æ”¾</strong>ã€‚</td><td align="left">ä¿®æ”¹æ­¥éª¤å®ç°éœ€åˆ›å»ºæ–°å­ç±»ï¼Œéª¨æ¶ä¿®æ”¹å¯èƒ½è¿åå¼€é—­åŸåˆ™ã€‚</td></tr><tr><td align="left"><strong>ä»£ç å¤ç”¨</strong></td><td align="left">ç­–ç•¥ä¹‹é—´é€šå¸¸<strong>æ— å¤ç”¨</strong>ï¼ˆé™¤éå…±äº«å…¬å…±é€»è¾‘ï¼‰ã€‚</td><td align="left"><strong>å¤ç”¨çˆ¶ç±»å®šä¹‰çš„ç®—æ³•éª¨æ¶</strong>ã€‚</td></tr><tr><td align="left"><strong>å…¸å‹ç»“æ„</strong></td><td align="left">Context + Strategy Interface + Concrete Strategies</td><td align="left">AbstractClass + ConcreteSubclasses (<code>templateMethod()</code> + <code>primitiveOperationX()</code>)</td></tr></tbody></table><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      <categories>
          
          <category> è®¾è®¡æ¨¡å¼ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>å­¦ä¹ &amp;é¢è¯•-é¡¹ç›®</title>
      <link href="/post/9811b68b.html"/>
      <url>/post/9811b68b.html</url>
      
        <content type="html"><![CDATA[<h1 id="DolphinçŸ¥è¯†åº“"><a href="#DolphinçŸ¥è¯†åº“" class="headerlink" title="DolphinçŸ¥è¯†åº“"></a>DolphinçŸ¥è¯†åº“</h1><p>æ—¶é—´ï¼š2025.4ï½è‡³ä»Š</p><h2 id="æ–‡ä»¶ä¸Šä¼ çš„å®ç°ç»†èŠ‚"><a href="#æ–‡ä»¶ä¸Šä¼ çš„å®ç°ç»†èŠ‚" class="headerlink" title="æ–‡ä»¶ä¸Šä¼ çš„å®ç°ç»†èŠ‚"></a>æ–‡ä»¶ä¸Šä¼ çš„å®ç°ç»†èŠ‚</h2><h2 id="æœ‰æ²¡æœ‰å†å²ç‰ˆæœ¬çš„diffèƒ½åŠ›ï¼Œåº”è¯¥æ€ä¹ˆè®¾è®¡"><a href="#æœ‰æ²¡æœ‰å†å²ç‰ˆæœ¬çš„diffèƒ½åŠ›ï¼Œåº”è¯¥æ€ä¹ˆè®¾è®¡" class="headerlink" title="æœ‰æ²¡æœ‰å†å²ç‰ˆæœ¬çš„diffèƒ½åŠ›ï¼Œåº”è¯¥æ€ä¹ˆè®¾è®¡"></a>æœ‰æ²¡æœ‰å†å²ç‰ˆæœ¬çš„diffèƒ½åŠ›ï¼Œåº”è¯¥æ€ä¹ˆè®¾è®¡</h2><h2 id="ç†”æ–­é™çº§æ€ä¹ˆå®ç°"><a href="#ç†”æ–­é™çº§æ€ä¹ˆå®ç°" class="headerlink" title="ç†”æ–­é™çº§æ€ä¹ˆå®ç°"></a>ç†”æ–­é™çº§æ€ä¹ˆå®ç°</h2><h2 id="ååŒç¼–è¾‘æ€ä¹ˆå®ç°çš„"><a href="#ååŒç¼–è¾‘æ€ä¹ˆå®ç°çš„" class="headerlink" title="ååŒç¼–è¾‘æ€ä¹ˆå®ç°çš„"></a>ååŒç¼–è¾‘æ€ä¹ˆå®ç°çš„</h2><h2 id="å¾®æœåŠ¡ä¹‹é—´å¦‚ä½•é€šä¿¡"><a href="#å¾®æœåŠ¡ä¹‹é—´å¦‚ä½•é€šä¿¡" class="headerlink" title="å¾®æœåŠ¡ä¹‹é—´å¦‚ä½•é€šä¿¡"></a>å¾®æœåŠ¡ä¹‹é—´å¦‚ä½•é€šä¿¡</h2><h1 id="AIå·¥ä½œå°"><a href="#AIå·¥ä½œå°" class="headerlink" title="AIå·¥ä½œå°"></a>AIå·¥ä½œå°</h1><p>æ—¶é—´ï¼š2024.6ï½2025.4</p><h1 id="æ•ˆèƒ½æ´å¯Ÿ"><a href="#æ•ˆèƒ½æ´å¯Ÿ" class="headerlink" title="æ•ˆèƒ½æ´å¯Ÿ"></a>æ•ˆèƒ½æ´å¯Ÿ</h1><p>æ—¶é—´ï¼š2023.6ï½2024.6</p><h1 id="ç›®æ ‡ç»©æ•ˆç³»ç»Ÿ"><a href="#ç›®æ ‡ç»©æ•ˆç³»ç»Ÿ" class="headerlink" title="ç›®æ ‡ç»©æ•ˆç³»ç»Ÿ"></a>ç›®æ ‡ç»©æ•ˆç³»ç»Ÿ</h1><p>æ—¶é—´ï¼š2021.8ï½2023.6</p><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      <categories>
          
          <category> é¢è¯• </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>é€»è¾‘æ€ç»´é¢˜</title>
      <link href="/post/181e3e1b.html"/>
      <url>/post/181e3e1b.html</url>
      
        <content type="html"><![CDATA[<h2 id="å°ç™½é¼ è¯•æ¯’è¯"><a href="#å°ç™½é¼ è¯•æ¯’è¯" class="headerlink" title="å°ç™½é¼ è¯•æ¯’è¯"></a>å°ç™½é¼ è¯•æ¯’è¯</h2><h2 id="100ä¸ªäººæŒ‰ç¯"><a href="#100ä¸ªäººæŒ‰ç¯" class="headerlink" title="100ä¸ªäººæŒ‰ç¯"></a>100ä¸ªäººæŒ‰ç¯</h2><blockquote><p>æœ‰100ç›ç¯,ç¼–å·ä¾æ¬¡ä¸º1,2,3â€¦100,ç”µç¯å…¨éƒ¨å…³ç€ã€‚ç°åœ¨æ¥äº†100ä¸ªäºº,ç¬¬ä¸€ä¸ªäººæŠŠæ‰€æœ‰çš„ç¯å¼€å…³æŒ‰ä¸‹ï¼›ç¬¬äºŒä¸ªäººéš”ä¸€ä¸ªç¯æŒ‰ä¸‹ï¼ˆ2,4,6â€¦ï¼‰ï¼›ç¬¬ä¸‰ä¸ªäººæ¯éš”ä¸¤ä¸ªç¯æŒ‰ä¸‹ï¼ˆ3,6,9â€¦ï¼‰.ç¬¬100ä¸ªäººéš”99ä¸ªç¯æŒ‰ä¸‹ï¼ˆ100ï¼‰,æœ€åè¿˜æœ‰å‡ ç›ç¯ï¼Œé‚£å‡ ç›ç¯äº®ç€ï¼Ÿ</p></blockquote><h2 id="100çš„é˜¶ä¹˜æœ‰å‡ ä¸ª0"><a href="#100çš„é˜¶ä¹˜æœ‰å‡ ä¸ª0" class="headerlink" title="100çš„é˜¶ä¹˜æœ‰å‡ ä¸ª0"></a>100çš„é˜¶ä¹˜æœ‰å‡ ä¸ª0</h2><p>100çš„é˜¶ä¹˜ï¼ˆ100!ï¼‰æœ‰å¤šå°‘ä¸ªæœ«å°¾çš„é›¶ï¼Œå¯ä»¥é€šè¿‡è®¡ç®—å…¶å› å¼åˆ†è§£ä¸­10çš„å› å­ä¸ªæ•°æ¥ç¡®å®šï¼Œå› ä¸ºæœ«å°¾çš„é›¶æ˜¯ç”±2å’Œ5ç›¸ä¹˜å¾—åˆ°çš„ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬å°†100!è¿›è¡Œå› å¼åˆ†è§£ã€‚100!è¡¨ç¤ºä»1ä¹˜åˆ°100çš„è¿ç»­æ•´æ•°çš„ä¹˜ç§¯ï¼Œå¯ä»¥å†™æˆï¼š</p><p>100! &#x3D; 1 Ã— 2 Ã— 3 Ã— 4 Ã— â€¦ Ã— 99 Ã— 100</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è§‚å¯Ÿä¹˜æ³•ä¸­æ¯ä¸€é¡¹çš„å› å­ä¸­2å’Œ5çš„ä¸ªæ•°ã€‚</p><p>åœ¨100!ä¸­ï¼Œå¶æ•°çš„å› å­2çš„ä¸ªæ•°æ˜æ˜¾æ¯”5å¤šï¼Œå› ä¸ºæ¯éš”ä¸€ä¸ªæ•°å°±ä¼šæœ‰ä¸€ä¸ªå¶æ•°å‡ºç°ï¼Œè€Œå¶æ•°éƒ½åŒ…å«å› å­2ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬åªéœ€è¦å…³æ³¨100!ä¸­5çš„å› å­ä¸ªæ•°ã€‚</p><p>åœ¨100!ä¸­ï¼Œ5ã€10ã€15ã€20ã€â€¦ã€95ã€100è¿™äº›æ•°éƒ½åŒ…å«å› å­5ï¼Œå…±æœ‰20ä¸ªæ•°ã€‚è€Œ25ã€50ã€75ã€100è¿™äº›æ•°åŒ…å«ä¸¤ä¸ªå› å­5ï¼Œæ‰€ä»¥éœ€è¦å°†å…¶è®¡ç®—åœ¨å†…ã€‚</p><p>å› æ­¤ï¼Œ100!ä¸­æ€»å…±æœ‰20 + 4 &#x3D; 24ä¸ªå› å­5ã€‚</p><p>ç»¼ä¸Šæ‰€è¿°ï¼Œ100!æœ«å°¾å…±æœ‰24ä¸ªé›¶ã€‚</p><h2 id="ç”¨å¤©å¹³æ‰¾æœ€è½»-é‡çš„çƒ"><a href="#ç”¨å¤©å¹³æ‰¾æœ€è½»-é‡çš„çƒ" class="headerlink" title="ç”¨å¤©å¹³æ‰¾æœ€è½»&#x2F;é‡çš„çƒ"></a>ç”¨å¤©å¹³æ‰¾æœ€è½»&#x2F;é‡çš„çƒ</h2><blockquote><p>8ä¸ªçƒï¼Œä¸€ä¸ªè½»ï¼Œå¤©å¹³2æ¬¡æ‰¾å‡ºæ¥</p></blockquote><p>ç¬¬ä¸€æ¬¡ç§°é‡ï¼šå°†ä»»æ„ä¸‰ä¸ªçƒæ”¾åœ¨å¤©å¹³çš„ä¸€è¾¹ï¼Œå†å°†å¦å¤–ä¸‰ä¸ªçƒæ”¾åœ¨å¦ä¸€è¾¹ï¼Œå‰©ä¸‹çš„ä¸¤ä¸ªçƒä¸æ”¾åœ¨å¤©å¹³ä¸Šã€‚å¦‚æœå¤©å¹³å¹³è¡¡ï¼Œåˆ™è½»çš„çƒåœ¨å‰©ä¸‹çš„ä¸¤ä¸ªçƒä¸­ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡ç›®æµ‹æˆ–è€…æ‰‹æ„Ÿæ¥æ‰¾å‡ºè½»çš„çƒã€‚å¦‚æœå¤©å¹³ä¸å¹³è¡¡ï¼Œé‚£ä¹ˆè½»çš„çƒä¸€å®šåœ¨è½»çš„é‚£ä¸€è¾¹ã€‚</p><p>ç¬¬äºŒæ¬¡ç§°é‡ï¼šå°†è½»çš„é‚£ä¸€è¾¹çš„ä¸‰ä¸ªçƒä¸­çš„ä¸¤ä¸ªçƒæ”¾åœ¨å¤©å¹³çš„ä¸€è¾¹ï¼Œå°†å‰©ä¸‹çš„ä¸€ä¸ªçƒæ”¾åœ¨å¦ä¸€è¾¹ã€‚å¦‚æœå¤©å¹³å¹³è¡¡ï¼Œåˆ™å‰©ä¸‹çš„é‚£ä¸ªçƒå°±æ˜¯è½»çš„çƒï¼›å¦‚æœå¤©å¹³ä¸å¹³è¡¡ï¼Œé‚£ä¹ˆè½»çš„çƒå°±æ˜¯è½»çš„é‚£ä¸€è¾¹çš„çƒã€‚</p><h2 id="2017çš„2017-æ¬¡æ–¹çš„æœ€åä¸€ä½æ•°"><a href="#2017çš„2017-æ¬¡æ–¹çš„æœ€åä¸€ä½æ•°" class="headerlink" title="2017çš„2017 æ¬¡æ–¹çš„æœ€åä¸€ä½æ•°"></a>2017çš„2017 æ¬¡æ–¹çš„æœ€åä¸€ä½æ•°</h2><p>è®¡ç®—2017çš„2017æ¬¡æ–¹çš„æœ€åä¸€ä½æ•°ï¼Œå¯ä»¥ä½¿ç”¨æ•°è®ºä¸­çš„æ•°å­¦æ€§è´¨æ¥ç®€åŒ–è®¡ç®—ã€‚æ ¹æ®æ•°å­¦æ€§è´¨ï¼Œä¸€ä¸ªæ•´æ•°çš„æœ«ä½æ•°åªå’Œè¯¥æ•´æ•°çš„ä¸ªä½æ•°æœ‰å…³ï¼Œè€Œä¸å…¶ä»–ä½æ•°æ— å…³ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬è§‚å¯Ÿ2017çš„ä¸ªä½æ•°æ˜¯ä»€ä¹ˆã€‚2017é™¤ä»¥10çš„ä½™æ•°æ˜¯7ï¼Œå› æ­¤2017çš„ä¸ªä½æ•°æ˜¯7ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è§‚å¯Ÿ7çš„å¹‚çš„ä¸ªä½æ•°çš„è§„å¾‹ã€‚æˆ‘ä»¬å¯ä»¥åˆ—ä¸¾ä¸€äº›7çš„å¹‚ï¼Œçœ‹çœ‹ä¸ªä½æ•°çš„å˜åŒ–ï¼š</p><p>7^1 &#x3D; 7 7^2 &#x3D; 49 7^3 &#x3D; 343 7^4 &#x3D; 2401 7^5 &#x3D; 16807 â€¦</p><p>å¯ä»¥è§‚å¯Ÿåˆ°ï¼Œ7çš„å¹‚çš„ä¸ªä½æ•°ä¼šåœ¨7ã€9ã€3ã€1è¿™å››ä¸ªæ•°å­—ä¹‹é—´å¾ªç¯ã€‚å…·ä½“åœ°ï¼Œ7^1çš„ä¸ªä½æ•°æ˜¯7ï¼Œ7^2çš„ä¸ªä½æ•°æ˜¯9ï¼Œ7^3çš„ä¸ªä½æ•°æ˜¯3ï¼Œ7^4çš„ä¸ªä½æ•°æ˜¯1ï¼Œ7^5çš„ä¸ªä½æ•°åˆæ˜¯7ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p><p>å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªè§„å¾‹æ¥ç®€åŒ–è®¡ç®—2017çš„2017æ¬¡æ–¹çš„ä¸ªä½æ•°ã€‚2017é™¤ä»¥4çš„ä½™æ•°æ˜¯1ï¼Œæ‰€ä»¥2017çš„2017æ¬¡æ–¹çš„ä¸ªä½æ•°ä¹Ÿæ˜¯1ã€‚</p><p>ç»¼ä¸Šæ‰€è¿°ï¼Œ2017çš„2017æ¬¡æ–¹çš„æœ€åä¸€ä½æ•°æ˜¯1ã€‚</p><h2 id="25åŒ¹é©¬ï¼Œ5ä¸ªè·‘é“ï¼Œæœ€å°‘æ¯”å¤šå°‘æ¬¡èƒ½æ¯”å‡ºå‰3å"><a href="#25åŒ¹é©¬ï¼Œ5ä¸ªè·‘é“ï¼Œæœ€å°‘æ¯”å¤šå°‘æ¬¡èƒ½æ¯”å‡ºå‰3å" class="headerlink" title="25åŒ¹é©¬ï¼Œ5ä¸ªè·‘é“ï¼Œæœ€å°‘æ¯”å¤šå°‘æ¬¡èƒ½æ¯”å‡ºå‰3å"></a>25åŒ¹é©¬ï¼Œ5ä¸ªè·‘é“ï¼Œæœ€å°‘æ¯”å¤šå°‘æ¬¡èƒ½æ¯”å‡ºå‰3å</h2><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      <categories>
          
          <category> é¢è¯• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ€ç»´é€»è¾‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ•°æ®åº“</title>
      <link href="/post/caa317df.html"/>
      <url>/post/caa317df.html</url>
      
        <content type="html"><![CDATA[<h3 id="å€™é€‰ç "><a href="#å€™é€‰ç " class="headerlink" title="å€™é€‰ç "></a>å€™é€‰ç </h3><p>å…³ç³»æ¨¡å¼ä¸­ï¼Œèƒ½å¤Ÿå”¯ä¸€æ ‡è¯†æ¯ä¸€è¡Œæ•°æ®çš„æœ€å°å±æ€§é›†ã€‚åœ¨å¤šä¸ªå€™é€‰ç ä¸­ï¼Œå¯ä»¥é€‰æ‹©ä¸€ä¸ªä½œä¸ºè¡¨çš„ä¸»é”®ï¼ˆPrimary Keyï¼‰ï¼Œä¸€ä¸ªå…³ç³»åªèƒ½æœ‰ä¸€ä¸ªä¸»é”®ã€‚</p><h3 id="å‡½æ•°ä¾èµ–"><a href="#å‡½æ•°ä¾èµ–" class="headerlink" title="å‡½æ•°ä¾èµ–"></a>å‡½æ•°ä¾èµ–</h3><p>ç»™å®šå…³ç³»æ¨¡å¼Rï¼Œå¦‚æœå±æ€§é›†Xçš„å€¼ç¡®å®šå±æ€§é›†Yçš„å€¼ï¼Œåˆ™æˆYä¾èµ–äºXï¼Œè®°ä½œï¼šXâ†’Yã€‚</p><p>å¯¹äºXâ†’Yï¼Œå¦‚æœå­˜åœ¨Xçš„çœŸå­é›†ä½¿å¾—Xâ€™â†’Yï¼Œé‚£ä¹ˆXâ†’Yå°±æ˜¯éƒ¨åˆ†å‡½æ•°ä¾èµ–ï¼Œå¦åˆ™å°±æ˜¯å®Œå…¨å‡½æ•°ä¾èµ–ã€‚</p><p>å¦‚æœXâ†’Yï¼ŒYâ†’Zï¼Œé‚£ä¹ˆXâ†’Zå°±æ˜¯ä¼ é€’å‡½æ•°ä¾èµ–ã€‚</p><h3 id="å¼‚å¸¸"><a href="#å¼‚å¸¸" class="headerlink" title="å¼‚å¸¸"></a>å¼‚å¸¸</h3><p>å‡è®¾æœ‰ä¸€ä¸ªå­¦ç”Ÿè¯¾ç¨‹å…³ç³»æ¨¡å¼å¦‚ä¸‹ï¼š</p><table><thead><tr><th>Sno</th><th>Sname</th><th>Sdept</th><th>Mname</th><th>Cname</th><th>Grade</th></tr></thead><tbody><tr><td>1</td><td>å­¦ç”Ÿ-1</td><td>å­¦é™¢-1</td><td>é™¢é•¿-1</td><td>è¯¾ç¨‹-1</td><td>90</td></tr><tr><td>2</td><td>å­¦ç”Ÿ-2</td><td>å­¦é™¢-2</td><td>é™¢é•¿-2</td><td>è¯¾ç¨‹-2</td><td>80</td></tr><tr><td>2</td><td>å­¦ç”Ÿ-2</td><td>å­¦é™¢-2</td><td>é™¢é•¿-2</td><td>è¯¾ç¨‹-1</td><td>100</td></tr><tr><td>3</td><td>å­¦ç”Ÿ-3</td><td>å­¦é™¢-2</td><td>é™¢é•¿-2</td><td>è¯¾ç¨‹-2</td><td>95</td></tr></tbody></table><p>å¯ä»¥çœ‹å‡ºè¿™ä¸ªå…³ç³»æ¨¡å¼çš„å€™é€‰ç æ˜¯{Sno, Cname}ï¼Œå› ä¸º{Sno, Cname}æ˜¯å¯ä»¥å”¯ä¸€æ ‡è¯†æ¯ä¸€è¡Œæ•°æ®çš„æœ€å°æ•°æ®é›†ã€‚</p><p>è¿™æ˜¯ä¸€ä¸ªä¸ç¬¦åˆèŒƒå¼çš„å…³ç³»æ¨¡å¼ï¼Œå­˜åœ¨å¦‚ä¸‹å¼‚å¸¸ï¼š</p><ul><li>æ•°æ®å†—ä½™ï¼šä¾‹å¦‚å­¦ç”Ÿ-2ã€è¯¾ç¨‹-1ã€è¯¾ç¨‹-2éƒ½å‡ºç°äº†å¤šæ¬¡</li><li>æ’å…¥å¼‚å¸¸ï¼šå¦‚æœå…³ç³»æ¨¡å¼è¦æ±‚è¯¾ç¨‹ä¸èƒ½ä¸ºç©ºï¼Œé‚£ä¹ˆåœ¨å­¦ç”Ÿå°šæœªé€‰è¯¾çš„æƒ…å†µä¸‹å°±æ— æ³•å•ç‹¬æ’å…¥å­¦ç”Ÿæ•°æ®</li><li>ä¿®æ”¹å¼‚å¸¸ï¼šå‡ºç°å¤šæ¬¡çš„æ•°æ®åªä¿®æ”¹äº†å…¶ä¸­ä¸€éƒ¨åˆ†ï¼Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´</li><li>åˆ é™¤å¼‚å¸¸ï¼šä¾‹å¦‚åˆ é™¤æ‰€æœ‰è¯¾ç¨‹-1ç›¸å…³æ•°æ®ä¼šå¯¼è‡´å­¦ç”Ÿ-1ä¿¡æ¯ä¸¢å¤±</li></ul><h3 id="èŒƒå¼vsåèŒƒå¼"><a href="#èŒƒå¼vsåèŒƒå¼" class="headerlink" title="èŒƒå¼vsåèŒƒå¼"></a>èŒƒå¼vsåèŒƒå¼</h3><p>ä¸ºäº†è§£å†³ä¸Šé¢æåˆ°çš„è¿™äº›å¼‚å¸¸ï¼Œå…³ç³»æ¨¡å¼çš„è®¾è®¡å°±éœ€è¦è§„èŒƒåŒ–ã€‚</p><p><strong>ç¬¬ä¸€èŒƒå¼ï¼ˆ1NFï¼‰</strong>ï¼šå±æ€§ä¸å¯åˆ†å‰²ï¼Œå³æ¯ä¸ªå±æ€§éƒ½æ˜¯ä¸å¯åˆ†å‰²çš„åŸå­é¡¹ã€‚</p><p><strong>ç¬¬äºŒèŒƒå¼ï¼ˆ2NFï¼‰</strong>ï¼šæ»¡è¶³ç¬¬ä¸€èŒƒå¼ï¼Œä¸”ä¸å­˜åœ¨éƒ¨åˆ†å‡½æ•°ä¾èµ–ï¼Œå³ä»»æ„éä¸»å±æ€§å®Œå…¨ä¾èµ–äºä¸»é”®ã€‚</p><p><strong>ç¬¬ä¸‰èŒƒå¼ï¼ˆ3NFï¼‰</strong>ï¼šæ»¡è¶³ç¬¬äºŒèŒƒå¼ï¼Œä¸”ä¸å­˜åœ¨ä¼ é€’å‡½æ•°ä¾èµ–ï¼Œå³ä»»æ„éä¸»å±æ€§ç›´æ¥ä¾èµ–äºä¸»é”®ã€‚</p><p><strong>åèŒƒå¼</strong>ï¼šå®Œå…¨éµå¾ªèŒƒå¼çš„æ•°æ®åº“è®¾è®¡å¯èƒ½æ€§èƒ½è¾ƒå·®ï¼Œå› ä¸ºéœ€è¦å¤§é‡çš„è¿è¡¨æŸ¥è¯¢ã€‚åèŒƒå¼æ˜¯ç‰ºç‰²éƒ¨åˆ†èŒƒå¼ä»¥æé«˜æ€§èƒ½çš„ä¸€ç§è®¾è®¡æ–¹å¼ï¼Œå…·ä½“æœ‰ä»¥ä¸‹æ–¹å¼ï¼š</p><ul><li>å¢åŠ å†—ä½™åˆ—ï¼šåœ¨å¤šä¸ªè¡¨ä¸­å…·æœ‰ç›¸åŒçš„åˆ—ï¼Œé€šå¸¸ç”¨æ¥é¿å…æŸ¥è¯¢æ—¶çš„è¿è¡¨æ“ä½œã€‚</li><li>å¢åŠ æ´¾ç”Ÿåˆ—ï¼šå¢åŠ çš„åˆ—å¯ä»¥é€šè¿‡è¡¨ä¸­å…¶ä»–æ•°æ®è®¡ç®—èƒœåœºï¼Œä½œç”¨æ˜¯å‡å°‘æŸ¥è¯¢æ—¶çš„è®¡ç®—é‡ï¼Œä»è€ŒåŠ å¿«æŸ¥è¯¢é€Ÿåº¦ã€‚</li><li>é‡æ–°ç»„è¡¨ï¼šå¦‚æœè®¸å¤šç”¨æˆ·éœ€è¦æŸ¥çœ‹ä¸¤ä¸ªè¡¨è¿æ¥å‡ºæ¥çš„ç»“æœæ•°æ®ï¼Œåˆ™æŠŠè¿™ä¸¤ä¸ªè¡¨é‡æ–°ç»„æˆä¸€ä¸ªè¡¨æ¥å‡å°‘è¿æ¥ä»è€Œæé«˜æ€§èƒ½ã€‚</li><li>åˆ†å‰²è¡¨ï¼šå‚ç›´åˆ†å‰²ã€æ°´å¹³åˆ†å‰²</li></ul><p>å¾ˆæ˜¾ç„¶ï¼Œç‰ºç‰²èŒƒå¼ä»¥æé«˜æ€§èƒ½çš„åèŒƒå¼è®¾è®¡ä¼šå¸¦æ¥ä¸€äº›é—®é¢˜ï¼Œå¦‚ï¼š</p><ul><li>æ•°æ®å†—ä½™ï¼Œæµªè´¹å­˜å‚¨ç©ºé—´</li><li>æ•°æ®ä¸ä¸€è‡´</li><li>å¢ã€åˆ ã€æ”¹æ•ˆç‡é™ä½</li><li>å¯èƒ½å¯¼è‡´æ’å…¥å¼‚å¸¸ã€åˆ é™¤å¼‚å¸¸ã€ä¿®æ”¹å¼‚å¸¸</li></ul><p>å› æ­¤åœ¨å®é™…çš„è®¾è®¡ä¸­ï¼Œéœ€è¦æ ¹æ®å…·ä½“åº”ç”¨åœºæ™¯è¿›è¡Œæƒè¡¡ã€‚</p><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      <categories>
          
          <category> æ•°æ®åº“ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Mavenä¾èµ–ç®¡ç†</title>
      <link href="/post/924495ff.html"/>
      <url>/post/924495ff.html</url>
      
        <content type="html"><![CDATA[<h2 id="Maven"><a href="#Maven" class="headerlink" title="Maven"></a>Maven</h2><p>Maven æ˜¯ä¸€ä¸ª <strong>é¡¹ç›®ç®¡ç†å’Œæ„å»ºå·¥å…·</strong>ï¼Œä¸»è¦ç”¨äº Java é¡¹ç›®çš„ä¾èµ–ç®¡ç†ã€æ„å»ºè‡ªåŠ¨åŒ–ä»¥åŠé¡¹ç›®ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚</p><h3 id="ä¾èµ–èŒƒå›´"><a href="#ä¾èµ–èŒƒå›´" class="headerlink" title="ä¾èµ–èŒƒå›´"></a>ä¾èµ–èŒƒå›´</h3><table><thead><tr><th>ä¾èµ–èŒƒå›´</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>compile</code></td><td><code>scope</code>å…ƒç´ çš„ç¼ºçœå€¼ã€‚ç¼–è¯‘ã€æµ‹è¯•ã€è¿è¡Œé˜¶æ®µéƒ½ä¼šå¼•å…¥</td></tr><tr><td><code>test</code></td><td>æµ‹è¯•é˜¶æ®µå¼•å…¥</td></tr><tr><td><code>provided</code></td><td>ç¼–è¯‘ã€æµ‹è¯•é˜¶æ®µå¼•å…¥</td></tr><tr><td><code>runtime</code></td><td>æµ‹è¯•ã€è¿è¡Œé˜¶æ®µå¼•å…¥</td></tr><tr><td><code>system</code></td><td>ç”¨äºæ·»åŠ æœ¬åœ°ä¾èµ–ï¼Œä¸æ¨èä½¿ç”¨</td></tr><tr><td><code>import</code></td><td>ä¸ <code>dependencyManagement</code> å…ƒç´ é…åˆä½¿â½¤ï¼Œå…¶åŠŸèƒ½æ˜¯å°†â½¬æ ‡ <code>pom.xml</code> â½‚ä»¶ä¸­ <code>dependencyManagement</code> çš„é…ç½®å¯¼â¼Šåˆå¹¶åˆ°å½“å‰ <code>pom.xml</code> çš„ <code>dependencyManagement</code> ä¸­</td></tr></tbody></table><h3 id="ä¾èµ–ä¼ é€’"><a href="#ä¾èµ–ä¼ é€’" class="headerlink" title="ä¾èµ–ä¼ é€’"></a>ä¾èµ–ä¼ é€’</h3><p>æœ‰ä¸‰ä¸ªæ¨¡å—Aã€Bã€Cï¼ŒAä¾èµ–Bï¼ŒBä¾èµ–Cï¼ŒCæ˜¯å¦èƒ½ä¼ é€’åˆ°Aï¼Œå–å†³äºBä¾èµ–Cæ—¶ä½¿ç”¨çš„ä¾èµ–èŒƒå›´å’Œé…ç½®ã€‚</p><ul><li><code>compile</code>æˆ–<code>runtime</code>ä¾èµ–å¯ä»¥ä¼ é€’ï¼Œå…¶ä»–ä¾èµ–èŒƒå›´ä¸èƒ½ä¼ é€’</li></ul><img src="/post/924495ff/image-20241201105858259.png" class="" title="compileä¾èµ–"><img src="/post/924495ff/image-20241201110755516.png" class="" title="runtimeä¾èµ–"><img src="/post/924495ff/image-20241201110400431.png" class="" title="testä¾èµ–"><img src="/post/924495ff/image-20241201110500022.png" class="" title="providedä¾èµ–"><ul><li><code>optional</code>ä¸º<code>true</code>çš„ä¾èµ–ä¸èƒ½ä¼ é€’</li></ul><img src="/post/924495ff/image-20241201111836452.png" class="" title="optionalä¾èµ–"><h3 id="ä¾èµ–å†²çª"><a href="#ä¾èµ–å†²çª" class="headerlink" title="ä¾èµ–å†²çª"></a>ä¾èµ–å†²çª</h3><p>å½“ç›´æ¥å’Œé—´æ¥å¼•ç”¨äº†åŒä¸€ä¸ªä¾èµ–ï¼Œæœ€ç»ˆçš„ä¾èµ–ç‰ˆæœ¬å–å†³äºä¾èµ–çš„è·¯å¾„å’Œé¡ºåºã€‚</p><ul><li>æœ€çŸ­è·¯å¾„åŸåˆ™</li></ul><p>åœ¨ä¸‹é¢çš„æˆªå›¾ä¸­ï¼Œ<code>A</code>åˆ°<code>jackson-bind</code>æœ‰ä¸¤æ¡ä¾èµ–è·¯å¾„<code>A-&gt;B-&gt;C-&gt;jackson-databind</code>å’Œ<code>A-&gt;jackson-databind</code>ï¼Œæ ¹æ®æœ€çŸ­è·¯å¾„åŸåˆ™ï¼Œæœ€ç»ˆ<code>A</code>ä¼šä¾èµ–<code>jackson-databind</code>çš„<code>2.15.0</code>ç‰ˆæœ¬</p><img src="/post/924495ff/image-20241201113454944.png" class="" title="æœ€çŸ­è·¯å¾„åŸåˆ™"><ul><li>å£°æ˜é¡ºåºåŸåˆ™</li></ul><p>åœ¨ä¸‹é¢æˆªå›¾ä¸­ï¼Œ<code>A</code>åˆ°<code>jackson-bind</code>çš„ä¾èµ–è·¯å¾„åŒ…æ‹¬<code>A-&gt;B-&gt;jackson-databind</code>å’Œ<code>A-&gt;C-&gt;jsckson-databind</code>ï¼Œä¾èµ–è·¯å¾„é•¿åº¦ä¸€æ ·ï¼Œæ‰€ä»¥æœ€çŸ­è·¯å¾„ä¾èµ–åŸåˆ™ä¸é€‚ç”¨ã€‚æ­¤æ—¶å°±éœ€è¦æ ¹æ®<code>B</code>å’Œ<code>C</code>çš„å£°æ˜é¡ºåºæ¥å†³å®š<code>jackson-databind</code>çš„ä¾èµ–ç‰ˆæœ¬ã€‚</p><img src="/post/924495ff/image-20241201113752360-3024301.png" class="" title="Bå£°æ˜åœ¨å…ˆ"><img src="/post/924495ff/image-20241201114225143.png" class="" title="Cå£°æ˜åœ¨å…ˆ"><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>å­¦ä¹ &amp;é¢è¯•-ç³»ç»Ÿè®¾è®¡</title>
      <link href="/post/53a2d197.html"/>
      <url>/post/53a2d197.html</url>
      
        <content type="html"><![CDATA[<h1 id="DDD"><a href="#DDD" class="headerlink" title="DDD"></a>DDD</h1><h2 id="DDDçš„ä¸€äº›æ ¸å¿ƒæ¦‚å¿µ"><a href="#DDDçš„ä¸€äº›æ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="DDDçš„ä¸€äº›æ ¸å¿ƒæ¦‚å¿µ"></a>DDDçš„ä¸€äº›æ ¸å¿ƒæ¦‚å¿µ</h2><p><strong>æˆ˜ç•¥è®¾è®¡ï¼ˆStrategic Designï¼‰ï¼šåˆ’åˆ†é¢†åŸŸè¾¹ç•Œï¼Œæ˜ç¡®æ ¸å¿ƒé—®é¢˜</strong></p><ul><li><strong>é¢†åŸŸï¼ˆDomainï¼‰</strong>ï¼šä¸šåŠ¡é—®é¢˜çš„èŒƒå›´ï¼ˆå¦‚ç”µå•†é¢†åŸŸçš„â€œè®¢å•â€ã€â€œæ”¯ä»˜â€ï¼‰ã€‚</li><li><strong>å­åŸŸï¼ˆSubdomainï¼‰</strong>ï¼šé¢†åŸŸçš„ç»†åˆ†ï¼Œåˆ†ä¸ºï¼š<ul><li><strong>æ ¸å¿ƒå­åŸŸ</strong>ï¼ˆæ ¸å¿ƒç«äº‰åŠ›ï¼Œå¦‚ç”µå•†çš„â€œäº¤æ˜“ç³»ç»Ÿâ€ï¼‰ã€‚</li><li><strong>æ”¯æ’‘å­åŸŸ</strong>ï¼ˆè¾…åŠ©ä¸šåŠ¡ï¼Œå¦‚â€œç‰©æµè·Ÿè¸ªâ€ï¼‰ã€‚</li><li><strong>é€šç”¨å­åŸŸ</strong>ï¼ˆé€šç”¨åŠŸèƒ½ï¼Œå¦‚â€œç”¨æˆ·è®¤è¯â€ï¼‰ã€‚</li></ul></li><li><strong>é™ç•Œä¸Šä¸‹æ–‡ï¼ˆBounded Contextï¼‰</strong>ï¼š<ul><li>é¢†åŸŸæ¨¡å‹çš„<strong>æ˜ç¡®è¾¹ç•Œ</strong>ï¼Œæ¯ä¸ªä¸Šä¸‹æ–‡æœ‰ç‹¬ç«‹çš„<strong>ç»Ÿä¸€è¯­è¨€</strong>å’Œæ¨¡å‹ã€‚</li><li>ä¾‹å¦‚ï¼šç”µå•†ä¸­â€œè®¢å•ä¸Šä¸‹æ–‡â€å’Œâ€œåº“å­˜ä¸Šä¸‹æ–‡â€çš„â€œå•†å“â€æ¨¡å‹å¯èƒ½ä¸åŒã€‚</li></ul></li><li><strong>ä¸Šä¸‹æ–‡æ˜ å°„ï¼ˆContext Mappingï¼‰</strong>ï¼š<ul><li>æè¿°é™ç•Œä¸Šä¸‹æ–‡é—´çš„äº¤äº’æ–¹å¼ï¼Œå¦‚ï¼š<ul><li><strong>åˆä½œå…³ç³»ï¼ˆPartnershipï¼‰</strong>ï¼šä¸¤ä¸ªä¸Šä¸‹æ–‡ååŒå®Œæˆç›®æ ‡ã€‚</li><li><strong>é˜²è…å±‚ï¼ˆAnti-Corruption Layer, ACLï¼‰</strong>ï¼šéš”ç¦»å¤–éƒ¨ä¸Šä¸‹æ–‡çš„ä¸åˆç†æ¨¡å‹ã€‚</li><li><strong>å¼€æ”¾ä¸»æœºæœåŠ¡ï¼ˆOpen Host Serviceï¼‰</strong>ï¼šé€šè¿‡æ ‡å‡†åŒ–åè®®ï¼ˆå¦‚APIï¼‰æš´éœ²åŠŸèƒ½ã€‚</li></ul></li></ul></li></ul><p><strong>æˆ˜æœ¯è®¾è®¡ï¼ˆTactical Designï¼‰ï¼šåœ¨é™ç•Œä¸Šä¸‹æ–‡å†…æ„å»ºé¢†åŸŸæ¨¡å‹</strong></p><ul><li><strong>å®ä½“ï¼ˆEntityï¼‰</strong>ï¼š<ul><li>å…·æœ‰å”¯ä¸€æ ‡è¯†çš„å¯¹è±¡ï¼ˆå¦‚<code>Order</code>é€šè¿‡<code>orderId</code>åŒºåˆ†ï¼‰ã€‚</li><li>æ ‡è¯†ä¸å˜ï¼Œå±æ€§å¯å˜ã€‚</li></ul></li><li><strong>å€¼å¯¹è±¡ï¼ˆValue Objectï¼‰</strong>ï¼š<ul><li>é€šè¿‡å±æ€§å€¼å®šä¹‰çš„æ— æ ‡è¯†å¯¹è±¡ï¼ˆå¦‚<code>Money</code>åŒ…å«é‡‘é¢å’Œè´§å¸ç±»å‹ï¼‰ã€‚</li><li>é€šå¸¸ä¸å¯å˜ï¼ˆImmutableï¼‰ã€‚</li></ul></li><li><strong>èšåˆï¼ˆAggregateï¼‰</strong>ï¼š<ul><li><strong>ä¸€ç»„å…³è”å¯¹è±¡çš„é›†åˆ</strong>ï¼Œæ ¹å®ä½“ï¼ˆAggregate Rootï¼‰æ˜¯å”¯ä¸€è®¿é—®å…¥å£ã€‚</li><li>ä¾‹å¦‚ï¼š<code>Order</code>ï¼ˆèšåˆæ ¹ï¼‰åŒ…å«<code>OrderItem</code>å’Œ<code>Address</code>ï¼Œå¤–éƒ¨åªèƒ½é€šè¿‡<code>Order</code>ä¿®æ”¹å…¶å†…éƒ¨å¯¹è±¡ã€‚</li><li>ä¿è¯ä¸šåŠ¡ä¸€è‡´æ€§ï¼ˆäº‹åŠ¡è¾¹ç•Œï¼‰ã€‚</li></ul></li><li><strong>é¢†åŸŸæœåŠ¡ï¼ˆDomain Serviceï¼‰</strong>ï¼š<ul><li>å¤„ç†<strong>è·¨èšåˆ</strong>æˆ–<strong>ä¸å¤–éƒ¨äº¤äº’</strong>çš„é€»è¾‘ï¼ˆå¦‚<code>PaymentService</code>å¤„ç†æ”¯ä»˜ï¼‰ã€‚</li><li>é€šå¸¸æ˜¯æ— çŠ¶æ€çš„ã€‚</li></ul></li><li><strong>é¢†åŸŸäº‹ä»¶ï¼ˆDomain Eventï¼‰</strong>ï¼š<ul><li>è¡¨ç¤ºé¢†åŸŸä¸­å‘ç”Ÿçš„é‡è¦äº‹ä»¶ï¼ˆå¦‚<code>OrderPaidEvent</code>ï¼‰ã€‚</li><li>ç”¨äºè§£è€¦ç³»ç»Ÿï¼ˆäº‹ä»¶é©±åŠ¨æ¶æ„ï¼‰ã€‚</li></ul></li><li><strong>ä»“å‚¨ï¼ˆRepositoryï¼‰</strong>ï¼š<ul><li>å°è£…èšåˆçš„æŒä¹…åŒ–é€»è¾‘ï¼ˆå¦‚<code>OrderRepository</code>ï¼‰ã€‚</li><li>éš”ç¦»é¢†åŸŸæ¨¡å‹ä¸åŸºç¡€è®¾æ–½ã€‚</li></ul></li><li><strong>å·¥å‚ï¼ˆFactoryï¼‰</strong>ï¼š<ul><li>è´Ÿè´£å¤æ‚å¯¹è±¡çš„åˆ›å»ºé€»è¾‘ï¼ˆå¦‚<code>OrderFactory</code>å¤„ç†è®¢å•åˆå§‹åŒ–ï¼‰ã€‚</li></ul></li></ul><p><strong>å…¶ä»–å…³é”®æ¦‚å¿µ</strong></p><ul><li><strong>ç»Ÿä¸€è¯­è¨€ï¼ˆUbiquitous Languageï¼‰</strong>ï¼š<ul><li>å¼€å‘äººå‘˜ä¸ä¸šåŠ¡ä¸“å®¶å…±åŒå®šä¹‰çš„æœ¯è¯­ï¼Œè´¯ç©¿ä»£ç ã€æ–‡æ¡£ã€å¯¹è¯ã€‚</li></ul></li><li><strong>åˆ†å±‚æ¶æ„ï¼ˆLayered Architectureï¼‰</strong>ï¼š<ul><li>å…¸å‹åˆ†å±‚ï¼š<ul><li><strong>ç”¨æˆ·ç•Œé¢å±‚ï¼ˆPresentationï¼‰</strong></li><li><strong>åº”ç”¨å±‚ï¼ˆApplicationï¼‰</strong>ï¼šåè°ƒé¢†åŸŸå¯¹è±¡ï¼Œå¤„ç†ç”¨ä¾‹æµç¨‹ã€‚</li><li><strong>é¢†åŸŸå±‚ï¼ˆDomainï¼‰</strong>ï¼šæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ã€‚</li><li><strong>åŸºç¡€è®¾æ–½å±‚ï¼ˆInfrastructureï¼‰</strong>ï¼šæŠ€æœ¯å®ç°ï¼ˆæ•°æ®åº“ã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰ï¼‰ã€‚</li></ul></li></ul></li></ul><p><strong>æŠ€æœ¯å®ç°æ¨¡å¼</strong></p><ul><li><strong>CQRSï¼ˆCommand Query Responsibility Segregationï¼‰</strong>ï¼š<ul><li>åˆ†ç¦»è¯»å†™æ¨¡å‹ï¼Œä¼˜åŒ–æŸ¥è¯¢å’Œå‘½ä»¤å¤„ç†ï¼ˆå¦‚ç”¨ä¸åŒæ•°æ®åº“ï¼‰ã€‚</li></ul></li><li><strong>äº‹ä»¶æº¯æºï¼ˆEvent Sourcingï¼‰</strong>ï¼š<ul><li>é€šè¿‡å­˜å‚¨äº‹ä»¶ï¼ˆè€ŒéçŠ¶æ€ï¼‰é‡å»ºèšåˆçŠ¶æ€ã€‚</li></ul></li><li><strong>å…­è¾¹å½¢æ¶æ„ï¼ˆHexagonal Architectureï¼‰</strong>ï¼š<ul><li>é¢†åŸŸæ¨¡å‹ä½äºæ ¸å¿ƒï¼Œé€šè¿‡ç«¯å£&#x2F;é€‚é…å™¨ä¸å¤–éƒ¨äº¤äº’ã€‚</li></ul></li></ul><p><strong>æ ¸å¿ƒæ€æƒ³æ€»ç»“</strong></p><ol><li><strong>èšç„¦æ ¸å¿ƒé¢†åŸŸ</strong>ï¼Œé€šè¿‡é™ç•Œä¸Šä¸‹æ–‡åˆ’åˆ†è¾¹ç•Œã€‚</li><li><strong>æ¨¡å‹é©±åŠ¨è®¾è®¡</strong>ï¼Œç»Ÿä¸€è¯­è¨€æ¶ˆé™¤æ­§ä¹‰ã€‚</li><li><strong>æˆ˜æœ¯æ¨¡å¼</strong>ï¼ˆå®ä½“&#x2F;å€¼å¯¹è±¡&#x2F;èšåˆç­‰ï¼‰å®ç°é«˜å†…èšã€ä½è€¦åˆã€‚</li></ol><p><strong>é€‚ç”¨åœºæ™¯</strong></p><ul><li>ä¸šåŠ¡é€»è¾‘å¤æ‚ã€éœ€é•¿æœŸæ¼”åŒ–çš„ç³»ç»Ÿï¼ˆå¦‚é‡‘èã€ç”µå•†ã€SaaSå¹³å°ï¼‰ã€‚</li><li>å›¢é˜Ÿéœ€ä¸ä¸šåŠ¡ä¸“å®¶ç´§å¯†åä½œçš„åœºæ™¯ã€‚</li></ul><p>DDDé€šè¿‡æ¸…æ™°çš„æ¨¡å‹å’Œè¾¹ç•Œï¼Œå¸®åŠ©å¼€å‘è€…åº”å¯¹å¤æ‚æ€§ï¼Œé¿å…ä»£ç è…åŒ–ã€‚</p><ol><li>æœåŠ¡æ³¨å†Œå‘ç°APä¸CPæ¶æ„å¯¹æ¯”</li><li>ç†”æ–­é™çº§ç­–ç•¥ï¼ˆæ»‘åŠ¨çª—å£å®ç°ï¼‰</li><li>åˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒæ¨æ‹‰æ¨¡å¼å¯¹æ¯”</li><li>ç°åº¦å‘å¸ƒå®ç°æ–¹æ¡ˆ</li><li>åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªåŸç†ï¼ˆSpanæ ‘ï¼‰</li><li>Seata ATæ¨¡å¼å®ç°åŸç†</li><li>æ¥å£æ€§èƒ½çªå¢çš„é™æµç­–ç•¥</li><li>å¦‚ä½•è®¾è®¡æœåŠ¡æ²»ç†å¹³å°ï¼Ÿ</li><li>è®¾è®¡å¾®ä¿¡æœ‹å‹åœˆçš„å­˜å‚¨æ¶æ„</li><li>çŸ­é“¾ç³»ç»Ÿå¦‚ä½•å®ç°é«˜å¹¶å‘å†™å…¥ï¼Ÿ</li><li>åˆ†å¸ƒå¼å”¯ä¸€IDç”Ÿæˆæ–¹æ¡ˆï¼ˆSnowflakeä¼˜åŒ–ï¼‰</li><li>å¦‚ä½•è®¾è®¡ä¸€ä¸ªåˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡ç³»ç»Ÿï¼Ÿ</li><li>å®ç°è·¨æ•°æ®ä¸­å¿ƒçš„æ•°æ®åŒæ­¥æ–¹æ¡ˆ</li><li>è®¾è®¡æ”¯æŒåƒä¸‡çº§ç”¨æˆ·çš„æ¨é€ç³»ç»Ÿ</li><li>å¾®åšçƒ­æœæ¦œå®æ—¶è®¡ç®—æ¶æ„è®¾è®¡</li><li>ç”µå•†åº“å­˜æ‰£å‡çš„é˜²è¶…å–æ–¹æ¡ˆ</li><li>å¤šçº§ç¼“å­˜æ¶æ„è®¾è®¡ï¼ˆæœ¬åœ°ç¼“å­˜+Redis+JVMï¼‰</li><li>è®¾è®¡æ”¯æŒPBçº§æ•°æ®çš„æ—¥å¿—åˆ†æç³»ç»Ÿ</li><li>å®ç°ä¸€ä¸ªåˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒ</li><li>è®¾è®¡æ”¯æŒåŠ¨æ€æ‰©å®¹çš„åˆ†åº“åˆ†è¡¨æ–¹æ¡ˆ</li><li>å¦‚ä½•è®¾è®¡APIç½‘å…³çš„é™æµç†”æ–­åŠŸèƒ½ï¼Ÿ</li><li>å®æ—¶èŠå¤©ç³»ç»Ÿçš„æ¶ˆæ¯å¯é æŠ•é€’æ–¹æ¡ˆ</li><li>è®¾è®¡æ”¯æŒç‰ˆæœ¬å›æ»šçš„é…ç½®ç®¡ç†ç³»ç»Ÿ</li><li>å®ç°è·¨è¯­è¨€æœåŠ¡è°ƒç”¨ï¼ˆThrift&#x2F;gRPCé€‰å‹ï¼‰</li><li>è®¾è®¡æ”¯æŒå¼¹æ€§ä¼¸ç¼©çš„å¾®æœåŠ¡æ¶æ„</li><li>å®ç°åˆ†å¸ƒå¼Sessionä¸€è‡´æ€§æ–¹æ¡ˆ</li><li>è®¾è®¡ä¸€ä¸ªé«˜æ€§èƒ½çš„æ—¥å¿—é‡‡é›†ç³»ç»Ÿ</li><li>å¦‚ä½•è®¾è®¡å¯è¿½æº¯çš„æ“ä½œæ—¥å¿—ç³»ç»Ÿï¼Ÿ</li><li>å¦‚ä½•å®ç°ç†”æ–­å™¨æ¨¡å¼ï¼ˆCircuit Breakerï¼‰ï¼Ÿ</li><li>CQRSæ¨¡å¼åœ¨ç”µå•†ç³»ç»Ÿä¸­çš„åº”ç”¨</li><li>äº‹ä»¶æº¯æºï¼ˆEvent Sourcingï¼‰çš„ä¼˜ç¼ºç‚¹åˆ†æ</li><li>Sidecaræ¨¡å¼åœ¨æœåŠ¡æ²»ç†ä¸­çš„åº”ç”¨</li><li>ç½‘å…³æ¨¡å¼ä¸­çš„è·¯ç”±ç­–ç•¥è®¾è®¡</li><li>é˜²è…å±‚ï¼ˆAnti-Corruption Layerï¼‰è®¾è®¡å®è·µ</li><li>é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDDDï¼‰ä¸­çš„èšåˆæ ¹è®¾è®¡</li><li>é‡è¯•æ¨¡å¼ä¸­çš„æŒ‡æ•°é€€é¿ç®—æ³•å®ç°</li><li>å‰ç«¯çš„åç«¯æ¨¡å¼ï¼ˆBFFï¼‰é€‚ç”¨åœºæ™¯</li><li>åˆ†ç‰‡æ¨¡å¼ï¼ˆShardingï¼‰çš„æ•°æ®è¿ç§»æ–¹æ¡ˆ</li><li>ç®¡é“è¿‡æ»¤å™¨æ¨¡å¼åœ¨ETLä¸­çš„åº”ç”¨</li><li>ç‰©åŒ–è§†å›¾æ¨¡å¼ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½æ¡ˆä¾‹</li><li>ç­–ç•¥æ¨¡å¼åœ¨æ”¯ä»˜æ¸ é“é€‰æ‹©ä¸­çš„åº”ç”¨</li><li>è§‚å¯Ÿè€…æ¨¡å¼å®ç°é…ç½®åŠ¨æ€æ›´æ–°</li><li>ä»£ç†æ¨¡å¼åœ¨ç¼“å­˜ç©¿é€é˜²æŠ¤ä¸­çš„åº”ç”¨</li><li>å·¥å‚æ–¹æ³•æ¨¡å¼åœ¨è¿æ¥æ± åˆ›å»ºä¸­çš„åº”ç”¨</li><li>è£…é¥°å™¨æ¨¡å¼å®ç°APIé™æµåŠŸèƒ½</li><li>çŠ¶æ€æ¨¡å¼åœ¨è®¢å•çŠ¶æ€æµè½¬ä¸­çš„åº”ç”¨</li><li>ç»„åˆæ¨¡å¼å®ç°æƒé™æ ‘ç»“æ„è®¾è®¡</li><li>æ¨¡æ¿æ–¹æ³•æ¨¡å¼åœ¨äº‹åŠ¡ç®¡ç†ä¸­çš„åº”ç”¨</li><li>HTTPSæ¡æ‰‹è¿‡ç¨‹ä¼˜åŒ–ç­–ç•¥</li><li>é›¶æ‹·è´æŠ€æœ¯å®ç°åŸç†</li><li>ç™¾ä¸‡è¿æ¥æœåŠ¡å™¨æ¶æ„è®¾è®¡</li><li>çº¿ä¸ŠCPUé£™é«˜æ’æŸ¥æµç¨‹</li><li>è®¾è®¡ä¸€ä¸ªçŸ­é“¾ç³»ç»Ÿ</li><li>æ¥å£æ€§èƒ½ä¼˜åŒ–å…¨é“¾è·¯æ–¹æ¡ˆ</li><li>æµ·é‡æ•°æ®åˆ¤é‡æ–¹æ¡ˆï¼ˆå¸ƒéš†è¿‡æ»¤å™¨ï¼‰</li><li>å¦‚ä½•è®¾è®¡ç§’æ€ç³»ç»Ÿï¼Ÿ</li><li>å¤§å‹é¡¹ç›®ä»£ç è§„èŒƒè½åœ°å®è·µ</li><li>çº¿ä¸Šé—®é¢˜æ’æŸ¥å·¥å…·ç®±ï¼ˆarthas+prometheusï¼‰</li></ol><h1 id="é«˜æ€§èƒ½"><a href="#é«˜æ€§èƒ½" class="headerlink" title="é«˜æ€§èƒ½"></a>é«˜æ€§èƒ½</h1><h1 id="é«˜å¯ç”¨"><a href="#é«˜å¯ç”¨" class="headerlink" title="é«˜å¯ç”¨"></a>é«˜å¯ç”¨</h1><h2 id="é™æµ"><a href="#é™æµ" class="headerlink" title="é™æµ"></a>é™æµ</h2><p>æ ¸å¿ƒæ€æƒ³ï¼š<strong>åœ¨å•ä½æ—¶é—´å†…ï¼Œåªå…è®¸ç‰¹å®šæ•°é‡çš„è¯·æ±‚é€šè¿‡ï¼Œè¶…è¿‡é˜ˆå€¼çš„è¯·æ±‚å°†è¢«æ‹’ç»ã€æ’é˜Ÿç­‰å¾…æˆ–é™çº§å¤„ç†ã€‚</strong> ç›®çš„æ˜¯ä¿æŠ¤ç³»ç»Ÿä¸è¢«çªå‘æµé‡å‹å®ï¼Œç¡®ä¿ç³»ç»Ÿåœ¨æœ€å¤§æ‰¿å—èƒ½åŠ›å†…ç¨³å®šè¿è¡Œã€‚</p><h3 id="å¸¸è§çš„é™æµç®—æ³•ä¸å®ç°"><a href="#å¸¸è§çš„é™æµç®—æ³•ä¸å®ç°" class="headerlink" title="å¸¸è§çš„é™æµç®—æ³•ä¸å®ç°"></a>å¸¸è§çš„é™æµç®—æ³•ä¸å®ç°</h3><h4 id="è®¡æ•°å™¨å›ºå®šçª—å£ç®—æ³•"><a href="#è®¡æ•°å™¨å›ºå®šçª—å£ç®—æ³•" class="headerlink" title="è®¡æ•°å™¨å›ºå®šçª—å£ç®—æ³•"></a>è®¡æ•°å™¨å›ºå®šçª—å£ç®—æ³•</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FixedWindowLimiter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> maxRequests;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> windowMillis;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> windowStart;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FixedWindowLimiter</span><span class="params">(<span class="type">int</span> maxRequests, <span class="type">long</span> windowMillis)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.maxRequests = maxRequests;</span><br><span class="line">        <span class="built_in">this</span>.windowMillis = windowMillis;</span><br><span class="line">        <span class="built_in">this</span>.windowStart = System.currentTimeMillis();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">boolean</span> <span class="title function_">allow</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">if</span> (now - windowStart &gt; windowMillis) &#123;</span><br><span class="line">            count = <span class="number">0</span>; <span class="comment">// é‡ç½®è®¡æ•°å™¨</span></span><br><span class="line">            windowStart = now;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (count &lt; maxRequests) &#123;</span><br><span class="line">            count++;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>é—®é¢˜</strong>ï¼šçª—å£åˆ‡æ¢æ—¶å¯èƒ½ç¬é—´æ¶Œå…¥2å€æµé‡ï¼ˆä¸´ç•Œé—®é¢˜ï¼‰ã€‚</p><h4 id="æ»‘åŠ¨æ—¥å¿—ç®—æ³•ï¼ˆè§£å†³ä¸´ç•Œé—®é¢˜ï¼‰"><a href="#æ»‘åŠ¨æ—¥å¿—ç®—æ³•ï¼ˆè§£å†³ä¸´ç•Œé—®é¢˜ï¼‰" class="headerlink" title="æ»‘åŠ¨æ—¥å¿—ç®—æ³•ï¼ˆè§£å†³ä¸´ç•Œé—®é¢˜ï¼‰"></a>æ»‘åŠ¨æ—¥å¿—ç®—æ³•ï¼ˆè§£å†³ä¸´ç•Œé—®é¢˜ï¼‰</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SlidingLogLimiter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> maxRequests;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> windowMillis;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Queue&lt;Long&gt; timestamps = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SlidingLogLimiter</span><span class="params">(<span class="type">int</span> maxRequests, <span class="type">long</span> windowMillis)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.maxRequests = maxRequests;</span><br><span class="line">        <span class="built_in">this</span>.windowMillis = windowMillis;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">boolean</span> <span class="title function_">allow</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// ç§»é™¤è¶…æ—¶è¯·æ±‚</span></span><br><span class="line">        <span class="keyword">while</span> (!timestamps.isEmpty() &amp;&amp; now - timestamps.peek() &gt; windowMillis) &#123;</span><br><span class="line">            timestamps.poll();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (timestamps.size() &lt; maxRequests) &#123;</span><br><span class="line">            timestamps.add(now);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ¼æ¡¶ç®—æ³•ï¼ˆå¹³æ»‘æµé‡ï¼‰"><a href="#æ¼æ¡¶ç®—æ³•ï¼ˆå¹³æ»‘æµé‡ï¼‰" class="headerlink" title="æ¼æ¡¶ç®—æ³•ï¼ˆå¹³æ»‘æµé‡ï¼‰"></a>æ¼æ¡¶ç®—æ³•ï¼ˆå¹³æ»‘æµé‡ï¼‰</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LeakyBucketLimiter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> capacity;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">water</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> lastLeakTime;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> leakRateMillis; <span class="comment">// æ¼å‡ºé—´éš”ï¼ˆæ¯«ç§’/è¯·æ±‚ï¼‰</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LeakyBucketLimiter</span><span class="params">(<span class="type">int</span> capacity, <span class="type">long</span> leakRateMillis)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.capacity = capacity;</span><br><span class="line">        <span class="built_in">this</span>.leakRateMillis = leakRateMillis;</span><br><span class="line">        <span class="built_in">this</span>.lastLeakTime = System.currentTimeMillis();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">boolean</span> <span class="title function_">allow</span><span class="params">()</span> &#123;</span><br><span class="line">        leakWater();</span><br><span class="line">        <span class="keyword">if</span> (water &lt; capacity) &#123;</span><br><span class="line">            water++;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">leakWater</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">long</span> <span class="variable">elapsed</span> <span class="operator">=</span> now - lastLeakTime;</span><br><span class="line">        <span class="type">long</span> <span class="variable">leaks</span> <span class="operator">=</span> elapsed / leakRateMillis;</span><br><span class="line">        <span class="keyword">if</span> (leaks &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            water = Math.max(<span class="number">0</span>, water - leaks);</span><br><span class="line">            lastLeakTime = now;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ä»¤ç‰Œæ¡¶ç®—æ³•ï¼ˆå…è®¸çªå‘æµé‡ï¼‰"><a href="#ä»¤ç‰Œæ¡¶ç®—æ³•ï¼ˆå…è®¸çªå‘æµé‡ï¼‰" class="headerlink" title="ä»¤ç‰Œæ¡¶ç®—æ³•ï¼ˆå…è®¸çªå‘æµé‡ï¼‰"></a>ä»¤ç‰Œæ¡¶ç®—æ³•ï¼ˆå…è®¸çªå‘æµé‡ï¼‰</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TokenBucketLimiter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> capacity;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> tokens;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> lastRefillTime;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">double</span> refillRate; <span class="comment">// ä»¤ç‰Œ/æ¯«ç§’</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TokenBucketLimiter</span><span class="params">(<span class="type">long</span> capacity, <span class="type">double</span> refillPerSecond)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.capacity = capacity;</span><br><span class="line">        <span class="built_in">this</span>.refillRate = refillPerSecond / <span class="number">1000.0</span>;</span><br><span class="line">        <span class="built_in">this</span>.tokens = capacity;</span><br><span class="line">        <span class="built_in">this</span>.lastRefillTime = System.currentTimeMillis();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">boolean</span> <span class="title function_">allow</span><span class="params">()</span> &#123;</span><br><span class="line">        refillTokens();</span><br><span class="line">        <span class="keyword">if</span> (tokens &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">            tokens--;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">refillTokens</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">double</span> <span class="variable">elapsed</span> <span class="operator">=</span> now - lastRefillTime;</span><br><span class="line">        tokens = Math.min(capacity, tokens + elapsed * refillRate);</span><br><span class="line">        lastRefillTime = now;</span><br><span class="line">    </span><br></pre></td></tr></table></figure><h3 id="ä¸šç•Œé™æµå·¥å…·"><a href="#ä¸šç•Œé™æµå·¥å…·" class="headerlink" title="ä¸šç•Œé™æµå·¥å…·"></a>ä¸šç•Œé™æµå·¥å…·</h3><h4 id="å•æœºé™æµ"><a href="#å•æœºé™æµ" class="headerlink" title="å•æœºé™æµ"></a>å•æœºé™æµ</h4><ul><li><p><strong>Guava RateLimiter</strong></p><ul><li>åŸºäºä»¤ç‰Œæ¡¶ï¼Œæ”¯æŒé¢„çƒ­æ¨¡å¼ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RateLimiter</span> <span class="variable">limiter</span> <span class="operator">=</span> RateLimiter.create(<span class="number">10.0</span>); <span class="comment">// æ¯ç§’10ä¸ªè¯·æ±‚</span></span><br><span class="line"><span class="keyword">if</span> (limiter.tryAcquire()) &#123;</span><br><span class="line">    <span class="comment">// æ‰§è¡Œä¸šåŠ¡</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h4 id="åˆ†å¸ƒå¼é™æµ"><a href="#åˆ†å¸ƒå¼é™æµ" class="headerlink" title="åˆ†å¸ƒå¼é™æµ"></a>åˆ†å¸ƒå¼é™æµ</h4><ul><li><p><strong>Redis Cell</strong></p><ul><li>é€šè¿‡ <code>CL.THROTTLE</code> å‘½ä»¤å®ç°æ¼æ¡¶ç®—æ³•ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CL.THROTTLE user123 15 30 60 1</span><br><span class="line"><span class="comment"># å«ä¹‰ï¼š15å®¹é‡ï¼Œ30ç§’å†…60ä¸ªè¯·æ±‚ï¼Œ1æ¬¡è¯·æ±‚</span></span><br></pre></td></tr></table></figure></li><li><p><strong>Sentinel</strong>ï¼ˆé˜¿é‡Œå¼€æºï¼‰</p><ul><li>æ”¯æŒQPS&#x2F;çº¿ç¨‹æ•°é™æµã€ç³»ç»Ÿè‡ªé€‚åº”ä¿æŠ¤ã€å®æ—¶ç›‘æ§ã€‚</li><li>é›†æˆDubbo&#x2F;Spring Cloud&#x2F;Gatewayã€‚</li></ul></li><li><p><strong>Resilience4j</strong></p><ul><li>è½»é‡çº§å®¹é”™åº“ï¼Œæä¾›é™æµã€ç†”æ–­ç­‰åŠŸèƒ½ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RateLimiter</span> <span class="variable">limiter</span> <span class="operator">=</span> RateLimiter.of(<span class="string">&quot;serviceA&quot;</span>, RateLimiterConfig.custom()</span><br><span class="line">    .limitForPeriod(<span class="number">100</span>)</span><br><span class="line">    .limitRefreshPeriod(Duration.ofSeconds(<span class="number">1</span>))</span><br><span class="line">    .build());</span><br></pre></td></tr></table></figure></li></ul><h4 id="ç½‘å…³å±‚é™æµ"><a href="#ç½‘å…³å±‚é™æµ" class="headerlink" title="ç½‘å…³å±‚é™æµ"></a>ç½‘å…³å±‚é™æµ</h4><ul><li><p><strong>Spring Cloud Gateway</strong></p><ul><li>å†…ç½®RedisRateLimiterã€‚</li></ul></li><li><p><strong>Nginx</strong></p><ul><li><p>é€šè¿‡ <code>limit_req_zone</code> å®ç°æ¼æ¡¶ç®—æ³•ï¼š</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">limit_req_zone</span> <span class="variable">$binary_remote_addr</span> zone=api:<span class="number">10m</span> rate=10r/s;</span><br><span class="line"><span class="section">location</span> /api &#123;</span><br><span class="line">    <span class="attribute">limit_req</span> zone=api burst=<span class="number">20</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li></ul><p><strong>é€‰å‹å»ºè®®</strong></p><table><thead><tr><th align="left">åœºæ™¯</th><th align="left">æ¨èæ–¹æ¡ˆ</th></tr></thead><tbody><tr><td align="left">å•æœºé™æµ</td><td align="left">Guava RateLimiter</td></tr><tr><td align="left">åˆ†å¸ƒå¼æœåŠ¡é™æµ</td><td align="left">Sentinel &#x2F; Resilience4j</td></tr><tr><td align="left">APIç½‘å…³å±‚é™æµ</td><td align="left">Nginx &#x2F; Spring Cloud Gateway</td></tr><tr><td align="left">é«˜ç²¾åº¦åˆ†å¸ƒå¼é™æµ</td><td align="left">Redis + Lua</td></tr></tbody></table><h2 id="é™çº§-ç†”æ–­"><a href="#é™çº§-ç†”æ–­" class="headerlink" title="é™çº§&amp;ç†”æ–­"></a>é™çº§&amp;ç†”æ–­</h2><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      <categories>
          
          <category> é¢è¯• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DDD </tag>
            
            <tag> é™æµ </tag>
            
            <tag> é™çº§ </tag>
            
            <tag> ç†”æ–­ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å­¦ä¹ &amp;é¢è¯•-åˆ†å¸ƒå¼</title>
      <link href="/post/9787b587.html"/>
      <url>/post/9787b587.html</url>
      
        <content type="html"><![CDATA[<h2 id="åŸºæœ¬ç†è®º"><a href="#åŸºæœ¬ç†è®º" class="headerlink" title="åŸºæœ¬ç†è®º"></a>åŸºæœ¬ç†è®º</h2><ul><li><strong>æ ¸å¿ƒæ¦‚å¿µ:</strong> CAP å®šç†ã€BASE ç†è®ºã€ä¸€è‡´æ€§åè®®ï¼ˆRaft, Paxos äº†è§£ï¼‰ã€åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆ2PC, 3PC, TCC, Saga, æœ¬åœ°æ¶ˆæ¯è¡¨ã€Seataï¼‰ã€æœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ã€ç†”æ–­é™çº§ã€é™æµã€‚</li><li><strong>æœåŠ¡æ²»ç†:</strong><ul><li><strong>Spring Cloud Alibaba&#x2F;Netflix:</strong> æ·±å…¥ç†è§£ Nacos&#x2F;Eurekaï¼ˆæœåŠ¡å‘ç°ã€é…ç½®ä¸­å¿ƒï¼‰ã€Ribbon&#x2F;LoadBalancerï¼ˆè´Ÿè½½å‡è¡¡ï¼‰ã€Feign&#x2F;OpenFeignï¼ˆå£°æ˜å¼è°ƒç”¨ï¼‰ã€Hystrix&#x2F;Sentinelï¼ˆç†”æ–­é™æµï¼‰ã€Gateway&#x2F;Zuulï¼ˆAPI ç½‘å…³ï¼‰ã€Sleuth&#x2F;Zipkinï¼ˆé“¾è·¯è¿½è¸ªï¼‰çš„åŸç†ã€é…ç½®å’Œæœ€ä½³å®è·µã€‚</li></ul></li><li><strong>RPC æ¡†æ¶:</strong> ç†è§£ Dubbo æˆ– gRPC çš„æ ¸å¿ƒåŸç†ï¼ˆæœåŠ¡æš´éœ²ä¸å¼•ç”¨ã€é›†ç¾¤å®¹é”™ã€è´Ÿè½½å‡è¡¡ã€ç½‘ç»œé€šä¿¡åè®®ã€åºåˆ—åŒ–ï¼‰ã€‚</li></ul><h3 id="ä»€ä¹ˆæ˜¯CAP"><a href="#ä»€ä¹ˆæ˜¯CAP" class="headerlink" title="ä»€ä¹ˆæ˜¯CAP"></a>ä»€ä¹ˆæ˜¯CAP</h3><p>CAPå®šç†æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡ä¸­çš„ä¸€ä¸ªæ ¸å¿ƒåŸåˆ™ï¼Œç”±è®¡ç®—æœºç§‘å­¦å®¶Eric Breweråœ¨2000å¹´æå‡ºï¼Œåäº2002å¹´è¢«è¯æ˜ã€‚å®ƒæŒ‡å‡ºï¼Œåœ¨å­˜åœ¨<strong>ç½‘ç»œåˆ†åŒºï¼ˆPartition Toleranceï¼‰</strong>çš„æƒ…å†µä¸‹ï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿæ— æ³•åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸‰ä¸ªç‰¹æ€§ï¼š</p><ol><li><strong>ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰</strong><br>æ‰€æœ‰èŠ‚ç‚¹åœ¨åŒä¸€æ—¶åˆ»çœ‹åˆ°çš„æ•°æ®å®Œå…¨ç›¸åŒã€‚å†™å…¥æ“ä½œåï¼Œæ‰€æœ‰è¯»å–è¯·æ±‚éƒ½ä¼šç«‹å³è·å¾—æœ€æ–°æ•°æ®ï¼Œä¸ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µã€‚</li><li><strong>å¯ç”¨æ€§ï¼ˆAvailabilityï¼‰</strong><br>æ¯ä¸ªè¯·æ±‚ï¼ˆæ— è®ºè¯»å†™ï¼‰éƒ½èƒ½åœ¨åˆç†æ—¶é—´å†…è·å¾—éé”™è¯¯å“åº”ï¼Œä½†ä¸ä¿è¯è¿”å›çš„æ•°æ®æ˜¯æœ€æ–°ç‰ˆæœ¬ã€‚å³ä½¿éƒ¨åˆ†èŠ‚ç‚¹æ•…éšœï¼Œç³»ç»Ÿä»èƒ½æ­£å¸¸å“åº”ã€‚</li><li><strong>åˆ†åŒºå®¹å¿æ€§ï¼ˆPartition Toleranceï¼‰</strong><br>ç³»ç»Ÿåœ¨ç½‘ç»œåˆ†åŒºï¼ˆèŠ‚ç‚¹é—´é€šä¿¡ä¸­æ–­ï¼Œå½¢æˆå­¤å²›ï¼‰æ—¶ä»èƒ½ç»§ç»­è¿è¡Œã€‚ç½‘ç»œåˆ†åŒºæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„å®¢è§‚ç°å®ï¼Œå› æ­¤è¿™ä¸€ç‰¹æ€§é€šå¸¸è¢«è§†ä¸ºå¿…é¡»æ”¯æŒçš„åŸºç¡€ã€‚</li></ol><img src="/post/9787b587/image-20250505093121422-6167231.png" class="" title="image-20250505093121422"><h3 id="ä»€ä¹ˆæ˜¯BASE"><a href="#ä»€ä¹ˆæ˜¯BASE" class="headerlink" title="ä»€ä¹ˆæ˜¯BASE"></a>ä»€ä¹ˆæ˜¯BASE</h3><p>BASE æ˜¯åŸºæœ¬å¯ç”¨ï¼ˆBasically Availableï¼‰ã€è½¯çŠ¶æ€ï¼ˆSoft Stateï¼‰å’Œæœ€ç»ˆä¸€è‡´æ€§ï¼ˆEventually Consistentï¼‰ä¸‰ä¸ªçŸ­è¯­çš„ç¼©å†™ã€‚</p><p>BASE ç†è®ºæ˜¯å¯¹ CAP ä¸­ä¸€è‡´æ€§å’Œå¯ç”¨æ€§æƒè¡¡çš„ç»“æœï¼Œå®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šå³ä½¿æ— æ³•åšåˆ°å¼ºä¸€è‡´æ€§ï¼Œä½†æ¯ä¸ªåº”ç”¨éƒ½å¯ä»¥æ ¹æ®è‡ªèº«ä¸šåŠ¡ç‰¹ç‚¹ï¼Œé‡‡ç”¨é€‚å½“çš„æ–¹å¼æ¥ä½¿ç³»ç»Ÿè¾¾åˆ°æœ€ç»ˆä¸€è‡´æ€§ã€‚</p><p><strong>åŸºæœ¬å¯ç”¨</strong></p><p>æŒ‡åˆ†å¸ƒå¼ç³»ç»Ÿåœ¨å‡ºç°æ•…éšœçš„æ—¶å€™ï¼Œä¿è¯æ ¸å¿ƒå¯ç”¨ï¼Œå…è®¸æŸå¤±éƒ¨åˆ†å¯ç”¨æ€§ã€‚</p><p>ä¾‹å¦‚ï¼Œç”µå•†åœ¨åšä¿ƒé”€æ—¶ï¼Œä¸ºäº†ä¿è¯è´­ç‰©ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œéƒ¨åˆ†æ¶ˆè´¹è€…å¯èƒ½ä¼šè¢«å¼•å¯¼åˆ°ä¸€ä¸ªé™çº§çš„é¡µé¢ã€‚</p><p><strong>è½¯çŠ¶æ€</strong></p><p>æŒ‡å…è®¸ç³»ç»Ÿä¸­çš„æ•°æ®å­˜åœ¨ä¸­é—´çŠ¶æ€ï¼Œå¹¶è®¤ä¸ºè¯¥ä¸­é—´çŠ¶æ€ä¸ä¼šå½±å“ç³»ç»Ÿæ•´ä½“å¯ç”¨æ€§ï¼Œå³å…è®¸ç³»ç»Ÿä¸åŒèŠ‚ç‚¹çš„æ•°æ®å‰¯æœ¬ä¹‹é—´è¿›è¡ŒåŒæ­¥çš„è¿‡ç¨‹å­˜åœ¨æ—¶å»¶ã€‚</p><p><strong>æœ€ç»ˆä¸€è‡´æ€§</strong></p><p>æœ€ç»ˆä¸€è‡´æ€§å¼ºè°ƒçš„æ˜¯ç³»ç»Ÿä¸­æ‰€æœ‰çš„æ•°æ®å‰¯æœ¬ï¼Œåœ¨ç»è¿‡ä¸€æ®µæ—¶é—´çš„åŒæ­¥åï¼Œæœ€ç»ˆèƒ½è¾¾åˆ°ä¸€è‡´çš„çŠ¶æ€ã€‚</p><p>ACID è¦æ±‚å¼ºä¸€è‡´æ€§ï¼Œé€šå¸¸è¿ç”¨åœ¨ä¼ ç»Ÿçš„æ•°æ®åº“ç³»ç»Ÿä¸Šã€‚è€Œ BASE è¦æ±‚æœ€ç»ˆä¸€è‡´æ€§ï¼Œé€šè¿‡ç‰ºç‰²å¼ºä¸€è‡´æ€§æ¥è¾¾åˆ°å¯ç”¨æ€§ï¼Œé€šå¸¸è¿ç”¨åœ¨å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ã€‚</p><p>åœ¨å®é™…çš„åˆ†å¸ƒå¼åœºæ™¯ä¸­ï¼Œä¸åŒä¸šåŠ¡å•å…ƒå’Œç»„ä»¶å¯¹ä¸€è‡´æ€§çš„è¦æ±‚æ˜¯ä¸åŒçš„ï¼Œå› æ­¤ ACID å’Œ BASE å¾€å¾€ä¼šç»“åˆåœ¨ä¸€èµ·ä½¿ç”¨ã€‚</p><h3 id="ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼äº‹åŠ¡"><a href="#ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼äº‹åŠ¡" class="headerlink" title="ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼äº‹åŠ¡"></a>ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼äº‹åŠ¡</h3><p>åˆ†å¸ƒå¼äº‹åŠ¡æ˜¯æŒ‡<strong>æ¶‰åŠå¤šä¸ªç‹¬ç«‹æœåŠ¡æˆ–æ•°æ®åº“èµ„æºçš„ä¸€ä¸ªæ“ä½œå•å…ƒ</strong>ï¼Œè¿™äº›æœåŠ¡æˆ–èµ„æºé€šå¸¸åˆ†å¸ƒåœ¨ç½‘ç»œçš„ä¸åŒèŠ‚ç‚¹ä¸Šã€‚å…¶æ ¸å¿ƒç›®æ ‡æ˜¯ä¿è¯æ•´ä¸ªæ“ä½œè¦ä¹ˆåœ¨æ‰€æœ‰å‚ä¸çš„èŠ‚ç‚¹ä¸Š<strong>å…¨éƒ¨æˆåŠŸæäº¤</strong>ï¼Œè¦ä¹ˆåœ¨å‘ç”Ÿä»»ä½•å¤±è´¥æ—¶<strong>å…¨éƒ¨å›æ»š</strong>ï¼Œä»¥ç»´æŠ¤æ•°æ®çš„<strong>ACIDç‰¹æ€§</strong>ï¼ˆåŸå­æ€§ã€ä¸€è‡´æ€§ã€éš”ç¦»æ€§ã€æŒä¹…æ€§ï¼‰ï¼Œå°¤å…¶æ˜¯åœ¨è·¨ç³»ç»Ÿè¾¹ç•Œå’Œç½‘ç»œä¸å¯é çš„ç¯å¢ƒä¸‹ã€‚</p><p><strong>ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼äº‹åŠ¡ï¼Ÿ</strong></p><p>éšç€ç³»ç»Ÿæ¶æ„ä»å•ä½“åº”ç”¨å‘å¾®æœåŠ¡ã€åˆ†å¸ƒå¼æ•°æ®åº“æ¼”è¿›ï¼š</p><ol><li><strong>æ•°æ®&#x2F;æœåŠ¡æ‹†åˆ†ï¼š</strong> ä¸šåŠ¡é€»è¾‘æ¶‰åŠå¤šä¸ªç‹¬ç«‹çš„æ•°æ®åº“æˆ–æœåŠ¡ã€‚</li><li><strong>è·¨ç³»ç»Ÿè°ƒç”¨ï¼š</strong> å®Œæˆä¸€ä¸ªä¸šåŠ¡ç›®æ ‡éœ€è¦è°ƒç”¨å¤šä¸ªä¸åŒçš„æœåŠ¡ã€‚</li><li><strong>åŸå­æ€§æŒ‘æˆ˜ï¼š</strong> åœ¨å•ä¸ªæ•°æ®åº“å†…ï¼Œäº‹åŠ¡ç”±æ•°æ®åº“å¼•æ“ä¿è¯ã€‚ä½†å½“æ“ä½œè·¨è¶Šå¤šä¸ªç‹¬ç«‹èµ„æºï¼ˆæœåŠ¡&#x2F;æ•°æ®åº“ï¼‰æ—¶ï¼Œéœ€è¦é¢å¤–çš„æœºåˆ¶æ¥åè°ƒå®ƒä»¬ï¼Œç¡®ä¿æ•´ä½“åŸå­æ€§ã€‚</li></ol><p><strong>å®ç°åˆ†å¸ƒå¼äº‹åŠ¡çš„ä¸»è¦æ¨¡å¼ä¸æŠ€æœ¯ï¼š</strong></p><p>æ²¡æœ‰ä¸€ç§â€œé“¶å¼¹â€æ–¹æ¡ˆé€‚ç”¨äºæ‰€æœ‰åœºæ™¯ï¼Œé€‰æ‹©å–å†³äºä¸šåŠ¡éœ€æ±‚ï¼ˆå¦‚å¯¹å¼ºä¸€è‡´æ€§çš„è¦æ±‚ã€æ€§èƒ½å®¹å¿åº¦ã€å¤æ‚åº¦ï¼‰å’Œç³»ç»Ÿæ¶æ„ã€‚ä¸»è¦æ¨¡å¼åŒ…æ‹¬ï¼š</p><ol><li><strong>ä¸¤é˜¶æ®µæäº¤ï¼š</strong><ul><li><strong>åŸç†ï¼š</strong> å¼•å…¥ä¸€ä¸ªç‹¬ç«‹çš„<strong>åè°ƒè€…</strong>æ¥ç®¡ç†äº‹åŠ¡çš„æäº¤è¿‡ç¨‹ï¼Œåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š<ul><li><strong>å‡†å¤‡é˜¶æ®µï¼š</strong> åè°ƒè€…è¯¢é—®æ‰€æœ‰å‚ä¸è€…æ˜¯å¦å¯ä»¥æäº¤äº‹åŠ¡ã€‚å‚ä¸è€…æ‰§è¡Œäº‹åŠ¡æ“ä½œï¼ˆé”å®šèµ„æºã€å†™Redo&#x2F;Undoæ—¥å¿—ï¼‰ï¼Œä½†<strong>ä¸å®é™…æäº¤</strong>ï¼Œç„¶åå‘åè°ƒè€…æŠ•ç¥¨ï¼ˆâ€œåŒæ„â€æˆ–â€œä¸­æ­¢â€ï¼‰ã€‚</li><li><strong>æäº¤&#x2F;å›æ»šé˜¶æ®µï¼š</strong><ul><li>å¦‚æœæ‰€æœ‰å‚ä¸è€…éƒ½æŠ•ç¥¨â€œåŒæ„â€ï¼Œåè°ƒè€…å‘é€<strong>æäº¤</strong>æŒ‡ä»¤ç»™æ‰€æœ‰å‚ä¸è€…ã€‚å‚ä¸è€…æ”¶åˆ°å<strong>æ­£å¼æäº¤</strong>äº‹åŠ¡å¹¶é‡Šæ”¾èµ„æºï¼Œç„¶åå‘åè°ƒè€…å‘é€â€œå®Œæˆâ€ç¡®è®¤ã€‚</li><li>å¦‚æœ<strong>ä»»ä½•ä¸€ä¸ª</strong>å‚ä¸è€…æŠ•ç¥¨â€œä¸­æ­¢â€ï¼Œæˆ–è€…åè°ƒè€…åœ¨ç­‰å¾…æŠ•ç¥¨æ—¶è¶…æ—¶ï¼Œåè°ƒè€…å‘é€<strong>å›æ»š</strong>æŒ‡ä»¤ç»™æ‰€æœ‰å‚ä¸è€…ã€‚å‚ä¸è€…æ”¶åˆ°ååˆ©ç”¨Undoæ—¥å¿—<strong>å›æ»š</strong>äº‹åŠ¡å¹¶é‡Šæ”¾èµ„æºã€‚</li></ul></li></ul></li><li><strong>ä¼˜ç‚¹ï¼š</strong> ç†è®ºä¸Šæä¾›å¼ºä¸€è‡´æ€§ï¼ˆACIDï¼‰ï¼Œå®ç°ç›¸å¯¹æ ‡å‡†ï¼ˆå¦‚XAåè®®ï¼‰ã€‚</li><li><strong>ç¼ºç‚¹ï¼š</strong><ul><li><strong>æ€§èƒ½ç“¶é¢ˆï¼š</strong> åŒæ­¥é˜»å¡ï¼ˆå‚ä¸è€…åœ¨å‡†å¤‡é˜¶æ®µé”å®šèµ„æºç›´åˆ°æ”¶åˆ°ç¬¬äºŒé˜¶æ®µæŒ‡ä»¤ï¼‰ã€å¤šè½®ç½‘ç»œé€šä¿¡ã€‚</li><li><strong>åè°ƒè€…å•ç‚¹æ•…éšœï¼š</strong> å¦‚æœåè°ƒè€…å´©æºƒï¼Œå‚ä¸è€…å¯èƒ½ä¸€ç›´æŒæœ‰é”ï¼Œé˜»å¡å…¶ä»–æ“ä½œã€‚</li><li><strong>æ•°æ®ä¸ä¸€è‡´é£é™©ï¼ˆè„‘è£‚ï¼‰ï¼š</strong> åœ¨ç¬¬äºŒé˜¶æ®µï¼Œå¦‚æœåè°ƒè€…å‘å‡ºæäº¤æŒ‡ä»¤åéƒ¨åˆ†å‚ä¸è€…å´©æºƒæˆ–ç½‘ç»œä¸­æ–­ï¼Œå¯èƒ½å¯¼è‡´éƒ¨åˆ†æäº¤ã€éƒ¨åˆ†æœªæäº¤çš„æ•°æ®ä¸ä¸€è‡´çŠ¶æ€ï¼ˆéœ€è¦äººå·¥å¹²é¢„ï¼‰ã€‚</li></ul></li><li><strong>é€‚ç”¨åœºæ™¯ï¼š</strong> å¯¹å¼ºä¸€è‡´æ€§è¦æ±‚æé«˜ä¸”æ€§èƒ½è¦æ±‚ä¸é«˜ã€å‚ä¸æ–¹è¾ƒå°‘çš„å†…éƒ¨ç³»ç»Ÿï¼ˆå¦‚ä¼ ç»Ÿé“¶è¡Œæ ¸å¿ƒç³»ç»Ÿï¼‰ã€‚å¸¸ç”¨åè®®ï¼š<strong>XA</strong> (ç”±æ•°æ®åº“&#x2F;ä¸­é—´ä»¶å®ç°ï¼Œå¦‚Java JTA)ã€‚</li></ul></li><li><strong>è¡¥å¿äº‹åŠ¡ï¼š</strong><ul><li><strong>åŸç†ï¼š</strong> æ”¾å¼ƒå…¨å±€é”å’Œå¼ºä¸€è‡´æ€§ï¼Œé‡‡ç”¨â€œäº‹åè¡¥å¿â€çš„æ€è·¯å®ç°æœ€ç»ˆä¸€è‡´æ€§ã€‚æ ¸å¿ƒæ€æƒ³æ˜¯ä¸ºæ¯ä¸ªæ­£å‘ä¸šåŠ¡æ“ä½œå®šä¹‰ä¸€ä¸ªå¯¹åº”çš„ã€å¯é€†çš„<strong>è¡¥å¿æ“ä½œ</strong>ã€‚<ul><li>é¡ºåºæ‰§è¡Œå„ä¸ªæœåŠ¡è°ƒç”¨ï¼ˆT1, T2, T3â€¦ï¼‰ã€‚</li><li>å¦‚æœæŸä¸ªæ­¥éª¤ï¼ˆå¦‚Tnï¼‰å¤±è´¥ï¼Œåˆ™<strong>æŒ‰ç›¸åé¡ºåº</strong>æ‰§è¡Œå‰é¢æ‰€æœ‰å·²æˆåŠŸæ­¥éª¤çš„è¡¥å¿æ“ä½œï¼ˆCn-1, â€¦, C1ï¼‰ã€‚</li><li>è¡¥å¿æ“ä½œéœ€è¦æ˜¯å¹‚ç­‰çš„ï¼ˆå¯é‡å¤æ‰§è¡Œæ— å‰¯ä½œç”¨ï¼‰ã€‚</li></ul></li><li><strong>å¸¸è§å®ç°ï¼š</strong><ul><li><strong>TCCï¼š</strong> æœ€å…¸å‹çš„è¡¥å¿æ¨¡å¼ã€‚æ¯ä¸ªä¸šåŠ¡æœåŠ¡éœ€è¦å®ç°ä¸‰ä¸ªæ¥å£ï¼š<ul><li><strong>Tryï¼š</strong> é¢„ç•™ä¸šåŠ¡èµ„æºï¼ˆå†»ç»“åº“å­˜ã€æ‰£å‡ä¿¡ç”¨é¢åº¦ç­‰ï¼‰ã€‚å®Œæˆæ‰€æœ‰æ£€æŸ¥ï¼Œä¸ºæœ€ç»ˆæ“ä½œåšå‡†å¤‡ã€‚</li><li><strong>Confirmï¼š</strong> çœŸæ­£æäº¤ä¸šåŠ¡ï¼ˆç¡®è®¤æ‰£æ¬¾ã€ç¡®è®¤åº“å­˜ï¼‰ã€‚TryæˆåŠŸæ‰ä¼šæ‰§è¡Œï¼Œé€šå¸¸å¿…é¡»æˆåŠŸã€‚</li><li><strong>Cancelï¼š</strong> è¡¥å¿æ“ä½œï¼ˆé‡Šæ”¾å†»ç»“çš„åº“å­˜ã€æ¢å¤ä¿¡ç”¨é¢åº¦ï¼‰ã€‚TryæˆåŠŸåï¼Œå¦‚æœæ•´ä½“äº‹åŠ¡éœ€è¦å›æ»šï¼Œåˆ™æ‰§è¡ŒCancelã€‚</li></ul></li><li><strong>Sagaï¼š</strong><ul><li><strong>åè°ƒæ–¹å¼ï¼š</strong><ul><li><em>ç¼–æ’ï¼š</em> æ²¡æœ‰ä¸­å¿ƒåè°ƒè€…ï¼Œæ¯ä¸ªæœåŠ¡æ‰§è¡Œåå‘å¸ƒäº‹ä»¶ï¼Œä¸‹ä¸€ä¸ªæœåŠ¡ç›‘å¬äº‹ä»¶å¹¶æ‰§è¡Œè‡ªå·±çš„æ“ä½œæˆ–è¡¥å¿æ“ä½œã€‚</li><li><em>ç¼–æ’ï¼š</em> ä¸€ä¸ªä¸­å¿ƒåè°ƒå™¨è´Ÿè´£æŒ‰é¡ºåºè°ƒç”¨æœåŠ¡ï¼Œå¹¶åœ¨å¤±è´¥æ—¶è§¦å‘è¡¥å¿æµç¨‹ã€‚</li></ul></li><li><strong>æ‰§è¡Œæ¨¡å¼ï¼š</strong><ul><li><em>å‘å‰æ¢å¤ï¼š</em> æŸä¸ªæ­¥éª¤å¤±è´¥ï¼Œåˆ™é‡è¯•è¯¥æ­¥éª¤ï¼ˆé€‚ç”¨äºå¯é‡è¯•çš„ä¸´æ—¶é”™è¯¯ï¼‰ã€‚</li><li><em>å‘åæ¢å¤ï¼š</em> æŸä¸ªæ­¥éª¤å¤±è´¥ï¼Œåˆ™è§¦å‘è¡¥å¿æµç¨‹ã€‚</li></ul></li></ul></li></ul></li><li><strong>ä¼˜ç‚¹ï¼š</strong><ul><li>é¿å…äº†å…¨å±€é”ï¼Œæ€§èƒ½è¾ƒé«˜ï¼Œååé‡å¥½ã€‚</li><li>æœåŠ¡è®¾è®¡æ›´æ¾è€¦åˆã€‚</li><li>é€‚ç”¨äºé•¿äº‹åŠ¡ã€‚</li></ul></li><li><strong>ç¼ºç‚¹ï¼š</strong><ul><li>å®ç°å¤æ‚ï¼šæ¯ä¸ªæœåŠ¡éƒ½éœ€è¦è®¾è®¡Try&#x2F;Confirm&#x2F;Cancelæ¥å£ï¼ˆTCCï¼‰æˆ–è¡¥å¿é€»è¾‘ï¼ˆSagaï¼‰ã€‚</li><li>æœ€ç»ˆä¸€è‡´æ€§ï¼šå­˜åœ¨ä¸­é—´çŠ¶æ€ï¼ˆå¦‚åº“å­˜å†»ç»“ä½†æœªæ‰£å‡ï¼‰ï¼Œä¸šåŠ¡éœ€è¦å®¹å¿çŸ­æš‚ä¸ä¸€è‡´ã€‚</li><li>è¡¥å¿æ“ä½œçš„è®¾è®¡å’Œå®ç°æŒ‘æˆ˜ï¼šéœ€è¦ä¿è¯å¹‚ç­‰æ€§ã€å¯é‡è¯•ï¼›è¡¥å¿å¯èƒ½å¤±è´¥ï¼Œéœ€è¦é‡è¯•ç­–ç•¥ã€‚</li></ul></li><li><strong>é€‚ç”¨åœºæ™¯ï¼š</strong> é«˜å¹¶å‘ã€æ€§èƒ½è¦æ±‚é«˜ã€ä¸šåŠ¡ä¸Šå¯ä»¥æ¥å—çŸ­æš‚æœ€ç»ˆä¸€è‡´æ€§çš„åœºæ™¯ï¼ˆç”µå•†ä¸‹å•ã€æ”¯ä»˜ã€è®¢å•ç®¡ç†ç­‰ï¼‰ã€‚TCCé€‚ç”¨äºé‡‘èç­‰å¯¹éš”ç¦»æ€§è¦æ±‚ç¨é«˜çš„åœºæ™¯ï¼ŒSagaæ›´é€šç”¨ã€‚</li></ul></li><li><strong>åŸºäºå¯é æ¶ˆæ¯çš„æœ€ç»ˆä¸€è‡´æ€§ï¼š</strong><ul><li><strong>åŸç†ï¼š</strong> åˆ©ç”¨<strong>æ¶ˆæ¯é˜Ÿåˆ—</strong>çš„å¯é æŠ•é€’ç‰¹æ€§æ¥è§£è€¦æœåŠ¡å’Œä¿è¯æœ€ç»ˆä¸€è‡´æ€§ã€‚<ul><li>äº‹åŠ¡å‘èµ·æ–¹ï¼ˆæœåŠ¡Aï¼‰åœ¨æœ¬åœ°äº‹åŠ¡ä¸­æ‰§è¡Œæ“ä½œï¼Œå¹¶<strong>åŒæ—¶</strong>å‘æ¶ˆæ¯é˜Ÿåˆ—å‘é€ä¸€æ¡â€œå¾…ç¡®è®¤â€çš„æ¶ˆæ¯ï¼ˆè®°å½•æ“ä½œçŠ¶æ€ï¼‰ã€‚è¿™éœ€è¦æœ¬åœ°æ•°æ®åº“å’Œæ¶ˆæ¯é˜Ÿåˆ—æ”¯æŒ<strong>æœ¬åœ°æ¶ˆæ¯è¡¨</strong>æˆ–<strong>äº‹åŠ¡æ€§å‘ä»¶ç®±</strong>æ¨¡å¼ã€‚</li><li>æœ¬åœ°äº‹åŠ¡æäº¤æˆåŠŸåï¼Œç”±ä¸€ä¸ªç‹¬ç«‹çš„<strong>æ¶ˆæ¯è½¬å‘å™¨</strong>å°†â€œå¾…ç¡®è®¤â€æ¶ˆæ¯å¯é åœ°å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li><li>æ¶ˆæ¯é˜Ÿåˆ—å°†æ¶ˆæ¯æŠ•é€’ç»™æ¶ˆè´¹è€…ï¼ˆæœåŠ¡Bï¼‰ã€‚</li><li>æœåŠ¡Bæ‰§è¡Œæœ¬åœ°æ“ä½œã€‚</li><li>æœåŠ¡Bæ“ä½œæˆåŠŸåï¼Œå‘æ¶ˆæ¯é˜Ÿåˆ—å‘é€ACKç¡®è®¤æ¶ˆè´¹æˆåŠŸã€‚å¦‚æœå¤±è´¥æˆ–è¶…æ—¶ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä¼šé‡æŠ•ã€‚</li><li>ï¼ˆå¯é€‰ï¼‰æœåŠ¡Bæ‰§è¡ŒæˆåŠŸåï¼Œå¯ä»¥å†å‘é€æ¶ˆæ¯é©±åŠ¨åç»­æ“ä½œã€‚</li></ul></li><li><strong>å…³é”®æœºåˆ¶ï¼š</strong><ul><li><strong>æœ¬åœ°æ¶ˆæ¯è¡¨&#x2F;äº‹åŠ¡å‘ä»¶ç®±ï¼š</strong> ä¿è¯æœåŠ¡Aæœ¬åœ°äº‹åŠ¡æ‰§è¡Œå’Œæ¶ˆæ¯è®°å½•å­˜å‚¨çš„åŸå­æ€§ã€‚</li><li><strong>æ¶ˆæ¯é˜Ÿåˆ—çš„æŒä¹…åŒ–ä¸é‡è¯•ï¼š</strong> ä¿è¯æ¶ˆæ¯è‡³å°‘è¢«æŠ•é€’ä¸€æ¬¡ã€‚</li><li><strong>æ¶ˆè´¹è€…å¹‚ç­‰æ€§ï¼š</strong> æœåŠ¡Bçš„æ“ä½œå¿…é¡»æ˜¯å¹‚ç­‰çš„ï¼Œä»¥åº”å¯¹æ¶ˆæ¯å¯èƒ½é‡å¤æŠ•é€’çš„æƒ…å†µã€‚</li></ul></li><li><strong>ä¼˜ç‚¹ï¼š</strong><ul><li>ç³»ç»Ÿè§£è€¦ï¼Œå®¹é”™æ€§å¥½ã€‚</li><li>æ€§èƒ½è¾ƒå¥½ã€‚</li><li>å®ç°ç›¸å¯¹ç®€å•ï¼ˆåˆ©ç”¨æˆç†Ÿçš„æ¶ˆæ¯ä¸­é—´ä»¶ï¼‰ã€‚</li></ul></li><li><strong>ç¼ºç‚¹ï¼š</strong><ul><li><strong>æœ€ç»ˆä¸€è‡´æ€§ï¼š</strong> å­˜åœ¨å»¶è¿Ÿï¼ŒAæˆåŠŸåˆ°BæˆåŠŸä¹‹é—´æ•°æ®ä¸ä¸€è‡´ã€‚</li><li><strong>æ¶ˆæ¯ç§¯å‹é£é™©ï¼š</strong> å¦‚æœBå¤„ç†èƒ½åŠ›ä¸è¶³ã€‚</li><li><strong>ä¾èµ–æ¶ˆæ¯é˜Ÿåˆ—çš„å¯é æ€§ã€‚</strong></li><li><strong>è¦æ±‚æ¶ˆè´¹è€…å¹‚ç­‰ã€‚</strong></li></ul></li><li><strong>é€‚ç”¨åœºæ™¯ï¼š</strong> å¼‚æ­¥å¤„ç†ã€äº‹ä»¶é©±åŠ¨æ¶æ„ã€å¯¹å®æ—¶ä¸€è‡´æ€§è¦æ±‚ä¸é«˜çš„åœºæ™¯ï¼ˆå¦‚ç”¨æˆ·æ³¨å†Œåå‘é€æ¬¢è¿é‚®ä»¶ã€ç§¯åˆ†å¢å‡ã€çŠ¶æ€æ›´æ–°é€šçŸ¥ç­‰ï¼‰ã€‚</li></ul></li></ol><p><strong>å¦‚ä½•é€‰æ‹©ï¼Ÿ</strong></p><ul><li><strong>å¼ºä¸€è‡´æ€§è¦æ±‚æé«˜ï¼Œæ€§èƒ½è¦æ±‚ä¸é«˜ï¼Œå‚ä¸æ–¹å°‘ä¸”å¯æ§ï¼š</strong> è€ƒè™‘ <strong>2PC&#x2F;XA</strong> (ä½†è¦éå¸¸æ¸…æ¥šå…¶ä»£ä»·å’Œé£é™©)ã€‚</li><li><strong>é«˜å¹¶å‘ã€æ€§èƒ½è¦æ±‚é«˜ã€å¯æ¥å—æœ€ç»ˆä¸€è‡´æ€§ã€ä¸šåŠ¡é€»è¾‘å¯è¡¥å¿ï¼š</strong> <strong>TCC</strong> æˆ– <strong>Saga</strong> æ˜¯ä¸»æµé€‰æ‹©ã€‚TCCéš”ç¦»æ€§æ›´å¥½ä½†å®ç°æ›´é‡ï¼ŒSagaæ›´çµæ´»ã€‚</li><li><strong>å¼‚æ­¥è§£è€¦ã€å¯¹å»¶è¿Ÿå®¹å¿åº¦é«˜ã€éœ€è¦é«˜å¯ç”¨ï¼š</strong> <strong>åŸºäºå¯é æ¶ˆæ¯çš„æœ€ç»ˆä¸€è‡´æ€§</strong> æ˜¯æœ€å¸¸ç”¨ã€æœ€æ¨èçš„æ–¹å¼ä¹‹ä¸€ï¼Œå®ç°ç›¸å¯¹ç®€å•å¯é ã€‚</li><li><strong>é•¿ä¸šåŠ¡æµç¨‹ã€äº‹ä»¶é©±åŠ¨ï¼š</strong> <strong>Saga</strong> (å°¤å…¶æ˜¯Choreographyæ¨¡å¼) æˆ– <strong>åŸºäºäº‹ä»¶+å¯é æ¶ˆæ¯</strong>ã€‚</li></ul><p><strong>æ€»ç»“ï¼š</strong></p><p>åˆ†å¸ƒå¼äº‹åŠ¡çš„æ ¸å¿ƒæŒ‘æˆ˜æ˜¯åœ¨ç½‘ç»œåˆ†åŒºå’ŒèŠ‚ç‚¹æ•…éšœçš„æƒ…å†µä¸‹ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚æ²¡æœ‰å®Œç¾çš„è§£å†³æ–¹æ¡ˆï¼Œéƒ½æ˜¯åœ¨<strong>ä¸€è‡´æ€§(C)ã€å¯ç”¨æ€§(A)ã€åˆ†åŒºå®¹å¿æ€§(P)<strong>ï¼ˆCAPå®šç†ï¼‰å’Œ</strong>æ€§èƒ½ã€å¤æ‚åº¦</strong>ä¹‹é—´è¿›è¡Œæƒè¡¡ã€‚ç°ä»£åˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡ä¸­ï¼Œ<strong>åŸºäºå¯é æ¶ˆæ¯çš„æœ€ç»ˆä¸€è‡´æ€§</strong>å’Œ<strong>è¡¥å¿äº‹åŠ¡(TCC&#x2F;Saga)</strong> å› å…¶æ›´å¥½çš„æ‰©å±•æ€§å’Œå¯ç”¨æ€§ï¼Œæ¯”ä¼ ç»Ÿçš„2PCä½¿ç”¨å¾—æ›´å¹¿æ³›ã€‚ç†è§£ä¸šåŠ¡éœ€æ±‚ï¼ˆå¯¹ä¸€è‡´æ€§å’Œå»¶è¿Ÿçš„å®¹å¿åº¦ï¼‰æ˜¯é€‰æ‹©åˆé€‚æ–¹æ¡ˆçš„å…³é”®ã€‚</p><ol><li>åˆ†å¸ƒå¼IDç”Ÿæˆæ–¹æ¡ˆï¼ˆé›ªèŠ±ç®—æ³•ä¼˜åŒ–ï¼‰</li><li>ä¸€è‡´æ€§Hashç®—æ³•è™šæ‹ŸèŠ‚ç‚¹è®¾è®¡</li><li>åˆ†å¸ƒå¼é”çš„ä¸‰ç§å®ç°æ–¹å¼å¯¹æ¯”</li><li>åˆ†å¸ƒå¼Sessionè§£å†³æ–¹æ¡ˆ</li><li>å¦‚ä½•å®ç°æœ€ç»ˆä¸€è‡´æ€§ï¼ˆæ¶ˆæ¯è¡¨+é‡è¯•ï¼‰</li><li>åˆ†åº“åˆ†è¡¨ååˆ†é¡µæŸ¥è¯¢æ–¹æ¡ˆ</li><li>åˆ†å¸ƒå¼äº‹åŠ¡æœ€å¤§åŠªåŠ›é€šçŸ¥å‹å®ç°</li><li>æ•°æ®åŒæ­¥æ–¹æ¡ˆï¼ˆcanal+MQï¼‰</li><li>é«˜å¹¶å‘ä¸‹å•ç³»ç»Ÿè®¾è®¡ï¼ˆåº“å­˜æ‰£å‡ï¼‰</li><li>åˆ†å¸ƒå¼ç¼“å­˜æ›´æ–°ç­–ç•¥ï¼ˆCache Asideï¼‰</li><li>åˆ†å¸ƒå¼ç³»ç»Ÿæ—¶é’ŸåŒæ­¥é—®é¢˜</li><li>è„‘è£‚é—®é¢˜è§£å†³æ–¹æ¡ˆ</li></ol><h2 id="ä¸€è‡´æ€§åè®®"><a href="#ä¸€è‡´æ€§åè®®" class="headerlink" title="ä¸€è‡´æ€§åè®®"></a>ä¸€è‡´æ€§åè®®</h2><h3 id="Paxos"><a href="#Paxos" class="headerlink" title="Paxos"></a>Paxos</h3><h3 id="Raft"><a href="#Raft" class="headerlink" title="Raft"></a>Raft</h3><h2 id="åˆ†å¸ƒå¼é”"><a href="#åˆ†å¸ƒå¼é”" class="headerlink" title="åˆ†å¸ƒå¼é”"></a>åˆ†å¸ƒå¼é”</h2><h2 id="åˆ†å¸ƒå¼IDç”Ÿæˆ"><a href="#åˆ†å¸ƒå¼IDç”Ÿæˆ" class="headerlink" title="åˆ†å¸ƒå¼IDç”Ÿæˆ"></a>åˆ†å¸ƒå¼IDç”Ÿæˆ</h2><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      <categories>
          
          <category> é¢è¯• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åˆ†å¸ƒå¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring&amp;SpringBoot</title>
      <link href="/post/18f2748c.html"/>
      <url>/post/18f2748c.html</url>
      
        <content type="html"><![CDATA[<ul><li><strong>IoC&#x2F;DI:</strong> æ·±å…¥ç†è§£å…¶å®ç°åŸç†ï¼ˆåå°„ã€å·¥å‚æ¨¡å¼ï¼‰ã€Bean ç”Ÿå‘½å‘¨æœŸã€ä½œç”¨åŸŸã€å¾ªç¯ä¾èµ–è§£å†³æœºåˆ¶ï¼ˆä¸‰çº§ç¼“å­˜ï¼‰ã€AOP åº•å±‚ï¼ˆåŠ¨æ€ä»£ç† - JDK vs CGLIBï¼‰ã€äº‹åŠ¡ç®¡ç†åŸç†ï¼ˆä¼ æ’­è¡Œä¸ºã€éš”ç¦»çº§åˆ«ã€å®ç°æœºåˆ¶ï¼‰ã€‚</li><li><strong>Spring MVC:</strong> æ·±å…¥ç†è§£è¯·æ±‚å¤„ç†æµç¨‹ï¼ˆDispatcherServlet, HandlerMapping, HandlerAdapter, ViewResolverï¼‰ã€å¸¸ç”¨æ³¨è§£åŸç†ã€RESTful è®¾è®¡æœ€ä½³å®è·µã€‚</li><li><strong>Spring Boot:</strong> è‡ªåŠ¨é…ç½®åŸç†ï¼ˆ<code>spring.factories</code>, <code>@Conditional</code>ï¼‰ã€å¯åŠ¨è¿‡ç¨‹ã€å¤–éƒ¨åŒ–é…ç½®ã€Actuator æ·±åº¦ä½¿ç”¨ä¸å®šåˆ¶ã€‚</li><li><strong>Spring Data:</strong> JPA&#x2F;Hibernate åŸç†ï¼ˆä¸€çº§&#x2F;äºŒçº§ç¼“å­˜ã€è„æ£€æŸ¥ã€å»¶è¿ŸåŠ è½½ã€N+1é—®é¢˜ï¼‰ã€Spring Data JPA æŠ½è±¡ä¸å®ç°ã€‚MyBatis æ ¸å¿ƒåŸç†ï¼ˆSqlSession, Mapper ä»£ç†ã€æ’ä»¶æœºåˆ¶ï¼‰ã€‚</li><li><strong>Spring Security&#x2F;OAuth2:</strong> è®¤è¯æˆæƒæµç¨‹ã€è¿‡æ»¤å™¨é“¾ã€RBAC&#x2F;ABACã€OAuth2 æˆæƒæ¨¡å¼ã€JWT æ·±åº¦åº”ç”¨ä¸å®‰å…¨è€ƒé‡ã€‚</li><li><strong>æºç é˜…è¯»:</strong> è¿™æ˜¯è¿›é˜¶çš„å…³é”®ï¼é€‰æ‹©å¸¸ç”¨æ¨¡å—ï¼ˆå¦‚ <code>BeanFactory</code>, <code>AOP</code>, <code>Transaction</code>ï¼‰é˜…è¯»æºç ï¼Œç†è§£è®¾è®¡æ¨¡å¼çš„åº”ç”¨å’Œæ ¸å¿ƒå®ç°é€»è¾‘ã€‚ğŸ“š</li></ul><h2 id="å¾ªç¯ä¾èµ–è§£å†³åŸç†"><a href="#å¾ªç¯ä¾èµ–è§£å†³åŸç†" class="headerlink" title="å¾ªç¯ä¾èµ–è§£å†³åŸç†"></a>å¾ªç¯ä¾èµ–è§£å†³åŸç†</h2><h2 id="FactoryBean-çš„ä½œç”¨ä¸åº”ç”¨"><a href="#FactoryBean-çš„ä½œç”¨ä¸åº”ç”¨" class="headerlink" title="FactoryBean çš„ä½œç”¨ä¸åº”ç”¨"></a><code>FactoryBean</code> çš„ä½œç”¨ä¸åº”ç”¨</h2><p><code>FactoryBean</code> æ˜¯ Spring æ¡†æ¶ä¸­ç”¨äº <strong>å°è£…å¤æ‚å¯¹è±¡åˆ›å»ºé€»è¾‘</strong> çš„ç‰¹æ®Šæ¥å£ï¼Œå…¶æ ¸å¿ƒä½œç”¨å¦‚ä¸‹ï¼š</p><ul><li><strong>éšè—å¤æ‚æ„é€ è¿‡ç¨‹</strong>ï¼šå°†åˆå§‹åŒ–ç¹ççš„å¯¹è±¡ï¼ˆå¦‚ç¬¬ä¸‰æ–¹åº“ç»„ä»¶ï¼‰çš„åˆ›å»ºç»†èŠ‚å°è£…åœ¨ <code>FactoryBean</code> ä¸­ã€‚</li><li><strong>åŠ¨æ€å†³å®šå¯¹è±¡ç±»å‹</strong>ï¼šæ ¹æ®æ¡ä»¶è¿”å›ä¸åŒç±»å‹çš„ Bean å®ä¾‹ã€‚</li><li><strong>å»¶è¿Ÿåˆå§‹åŒ–</strong>ï¼šæ§åˆ¶å¯¹è±¡çš„åˆ›å»ºæ—¶æœºï¼Œå®ç°æŒ‰éœ€åŠ è½½ã€‚</li><li><strong>ç»Ÿä¸€ç®¡ç†ä¾èµ–</strong>ï¼šé›†ä¸­å¤„ç†å¯¹è±¡åˆ›å»ºæ—¶çš„ä¾èµ–æ³¨å…¥åŠé…ç½®ã€‚</li></ul><p>å®ç° <code>FactoryBean</code> æ¥å£éœ€é‡å†™ä»¥ä¸‹æ–¹æ³•ï¼š</p><table><thead><tr><th align="left">æ–¹æ³•å</th><th align="left">ä½œç”¨</th></tr></thead><tbody><tr><td align="left"><code>T getObject()</code></td><td align="left">è¿”å›ç”± <code>FactoryBean</code> åˆ›å»ºçš„å®é™…å¯¹è±¡å®ä¾‹ã€‚</td></tr><tr><td align="left"><code>Class&lt;?&gt; getObjectType()</code></td><td align="left">è¿”å›åˆ›å»ºçš„å¯¹è±¡ç±»å‹ï¼Œç”¨äº Spring å®¹å™¨ç±»å‹æ£€æŸ¥ã€‚</td></tr><tr><td align="left"><code>boolean isSingleton()</code></td><td align="left">å†³å®šå¯¹è±¡æ˜¯å¦ä¸ºå•ä¾‹ã€‚é»˜è®¤ <code>true</code>ï¼Œè‹¥è¿”å› <code>false</code> åˆ™æ¯æ¬¡è¯·æ±‚åˆ›å»ºæ–°å®ä¾‹ã€‚</td></tr></tbody></table><p><strong>åº”ç”¨ç¤ºä¾‹ï¼šè‡ªå®šä¹‰åŠ å¯†å·¥å…· FactoryBean</strong><br>å‡è®¾éœ€åˆ›å»ºä¸€ä¸ªæ ¹æ®é…ç½®åŠ¨æ€é€‰æ‹©åŠ å¯†ç®—æ³•çš„å·¥å…·ç±»ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š</p><p><strong>1ï¼šå®šä¹‰åŠ å¯†æ¥å£åŠå®ç°ç±»</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">EncryptionTool</span> &#123;</span><br><span class="line">    String <span class="title function_">encrypt</span><span class="params">(String text)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AES åŠ å¯†å®ç°</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AesEncryptionTool</span> <span class="keyword">implements</span> <span class="title class_">EncryptionTool</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">encrypt</span><span class="params">(String text)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;AESåŠ å¯†åçš„æ•°æ®: &quot;</span> + text;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RSA åŠ å¯†å®ç°</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RsaEncryptionTool</span> <span class="keyword">implements</span> <span class="title class_">EncryptionTool</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">encrypt</span><span class="params">(String text)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;RSAåŠ å¯†åçš„æ•°æ®: &quot;</span> + text;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>2ï¼šå®ç° EncryptionToolFactoryBean</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.FactoryBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EncryptionToolFactoryBean</span> <span class="keyword">implements</span> <span class="title class_">FactoryBean</span>&lt;EncryptionTool&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> String algorithm; <span class="comment">// é…ç½®å±æ€§ï¼Œå†³å®šåŠ å¯†ç®—æ³•</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®ç®—æ³•ç±»å‹ï¼ˆé€šè¿‡Springå±æ€§æ³¨å…¥ï¼‰</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAlgorithm</span><span class="params">(String algorithm)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.algorithm = algorithm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> EncryptionTool <span class="title function_">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;AES&quot;</span>.equalsIgnoreCase(algorithm)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AesEncryptionTool</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;RSA&quot;</span>.equalsIgnoreCase(algorithm)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RsaEncryptionTool</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;ä¸æ”¯æŒçš„åŠ å¯†ç®—æ³•: &quot;</span> + algorithm);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; getObjectType() &#123;</span><br><span class="line">        <span class="keyword">return</span> EncryptionTool.class;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isSingleton</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">// å•ä¾‹æ¨¡å¼</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>3ï¼šé…ç½® Spring Bean</strong></p><p>xmlé…ç½®ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- XML é…ç½®æ–¹å¼ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;encryptionTool&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.example.EncryptionToolFactoryBean&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;algorithm&quot;</span> <span class="attr">value</span>=<span class="string">&quot;AES&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Java é…ç½®ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> FactoryBean&lt;EncryptionTool&gt; <span class="title function_">encryptionTool</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">EncryptionToolFactoryBean</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EncryptionToolFactoryBean</span>();</span><br><span class="line">        factory.setAlgorithm(<span class="string">&quot;RSA&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> factory;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>4ï¼šåœ¨ä¸šåŠ¡ç±»ä¸­æ³¨å…¥ä½¿ç”¨</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EncryptionTool encryptionTool;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveUser</span><span class="params">(String password)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">encrypted</span> <span class="operator">=</span> encryptionTool.encrypt(password);</span><br><span class="line">        System.out.println(<span class="string">&quot;åŠ å¯†åçš„å¯†ç : &quot;</span> + encrypted);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‹¥éœ€ç›´æ¥è·å– <code>FactoryBean</code> è€Œéå…¶åˆ›å»ºçš„å¯¹è±¡ï¼Œå¯åœ¨ Bean åç§°å‰åŠ  <code>&amp;</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FactoryBean&lt;?&gt; factory = context.getBean(<span class="string">&quot;&amp;encryptionTool&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id="Beanç”Ÿå‘½å‘¨æœŸæ‰©å±•ç‚¹å®æˆ˜"><a href="#Beanç”Ÿå‘½å‘¨æœŸæ‰©å±•ç‚¹å®æˆ˜" class="headerlink" title="Beanç”Ÿå‘½å‘¨æœŸæ‰©å±•ç‚¹å®æˆ˜"></a>Beanç”Ÿå‘½å‘¨æœŸæ‰©å±•ç‚¹å®æˆ˜</h2><p>Spring Bean ç”Ÿå‘½å‘¨æœŸçš„æ ¸å¿ƒé˜¶æ®µå’Œæ‰©å±•ç‚¹é¡ºåºï¼š</p><ol><li><strong>å®ä¾‹åŒ–</strong>ï¼ˆè°ƒç”¨æ„é€ å‡½æ•°ï¼‰</li><li><strong>å±æ€§èµ‹å€¼</strong>ï¼ˆä¾èµ–æ³¨å…¥ï¼‰</li><li><strong>BeanPostProcessor å‰ç½®å¤„ç†</strong>ï¼ˆ<code>postProcessBeforeInitialization</code>ï¼‰</li><li><strong>åˆå§‹åŒ–æ–¹æ³•</strong>ï¼ˆ<code>@PostConstruct</code> â†’ <code>InitializingBean</code> â†’ <code>init-method</code>ï¼‰</li><li><strong>BeanPostProcessor åç½®å¤„ç†</strong>ï¼ˆ<code>postProcessAfterInitialization</code>ï¼‰</li><li><strong>Bean å°±ç»ªï¼Œè¿›å…¥è¿è¡ŒæœŸ</strong></li><li><strong>é”€æ¯æ–¹æ³•</strong>ï¼ˆ<code>@PreDestroy</code> â†’ <code>DisposableBean</code> â†’ <code>destroy-method</code>ï¼‰</li></ol><p><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/spring-942a927a-86e4-4a01-8f52-9addd89642ff.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šSpring Beanç”Ÿå‘½å‘¨æœŸ"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AbstractAutowireCapableBeanFactory</span></span><br><span class="line"><span class="keyword">protected</span> Object <span class="title function_">doCreateBean</span><span class="params">(String beanName, RootBeanDefinition mbd, <span class="meta">@Nullable</span> Object[] args)</span></span><br><span class="line">        <span class="keyword">throws</span> BeanCreationException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®ä¾‹åŒ–bean</span></span><br><span class="line">    <span class="type">BeanWrapper</span> <span class="variable">instanceWrapper</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (mbd.isSingleton()) &#123;</span><br><span class="line">        instanceWrapper = <span class="built_in">this</span>.factoryBeanInstanceCache.remove(beanName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (instanceWrapper == <span class="literal">null</span>) &#123;</span><br><span class="line">        instanceWrapper = createBeanInstance(beanName, mbd, args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">bean</span> <span class="operator">=</span> instanceWrapper.getWrappedInstance();</span><br><span class="line">    Class&lt;?&gt; beanType = instanceWrapper.getWrappedClass();</span><br><span class="line">    <span class="keyword">if</span> (beanType != NullBean.class) &#123;</span><br><span class="line">        mbd.resolvedTargetType = beanType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…è®¸åç½®å¤„ç†å™¨ä¿®æ”¹beanå®šä¹‰</span></span><br><span class="line">    <span class="keyword">synchronized</span> (mbd.postProcessingLock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mbd.postProcessed) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(mbd.getResourceDescription(), beanName,</span><br><span class="line">                        <span class="string">&quot;Post-processing of merged bean definition failed&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">            mbd.postProcessed = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æš´éœ²æ—©æœŸå¼•ç”¨ï¼Œè§£å†³å¾ªç¯å¼•ç”¨é—®é¢˜</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">earlySingletonExposure</span> <span class="operator">=</span> (mbd.isSingleton() &amp;&amp; <span class="built_in">this</span>.allowCircularReferences &amp;&amp;</span><br><span class="line">            isSingletonCurrentlyInCreation(beanName));</span><br><span class="line">    <span class="keyword">if</span> (earlySingletonExposure) &#123;</span><br><span class="line">        <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">            logger.trace(<span class="string">&quot;Eagerly caching bean &#x27;&quot;</span> + beanName +</span><br><span class="line">                    <span class="string">&quot;&#x27; to allow for resolving potential circular references&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–bean</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">exposedObject</span> <span class="operator">=</span> bean;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// å¡«å……å±æ€§</span></span><br><span class="line">        populateBean(beanName, mbd, instanceWrapper);</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–</span></span><br><span class="line">        exposedObject = initializeBean(beanName, exposedObject, mbd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> BeanCreationException &amp;&amp; beanName.equals(((BeanCreationException) ex).getBeanName())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> (BeanCreationException) ex;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(</span><br><span class="line">                    mbd.getResourceDescription(), beanName, <span class="string">&quot;Initialization of bean failed&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register bean as disposable.</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        registerDisposableBeanIfNecessary(beanName, bean, mbd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (BeanDefinitionValidationException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(</span><br><span class="line">                mbd.getResourceDescription(), beanName, <span class="string">&quot;Invalid destruction signature&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> exposedObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="SpringBootè‡ªåŠ¨é…ç½®åŸç†"><a href="#SpringBootè‡ªåŠ¨é…ç½®åŸç†" class="headerlink" title="SpringBootè‡ªåŠ¨é…ç½®åŸç†"></a>SpringBootè‡ªåŠ¨é…ç½®åŸç†</h2><p>Spring Bootçš„è‡ªåŠ¨é…ç½®æ˜¯å…¶æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€ï¼Œæ—¨åœ¨ç®€åŒ–åº”ç”¨çš„é…ç½®è¿‡ç¨‹ã€‚ä»¥ä¸‹æ˜¯å…¶å®ç°æœºåˆ¶çš„è¯¦ç»†æ­¥éª¤è§£æï¼š</p><p><strong><code>@SpringBootApplication</code> æ³¨è§£ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootConfiguration</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="meta">@ComponentScan(excludeFilters = &#123; @Filter(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class),</span></span><br><span class="line"><span class="meta">@Filter(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SpringBootApplication &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong><code>@EnableAutoConfiguration</code>æ³¨è§£ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Import(AutoConfigurationImportSelector.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableAutoConfiguration &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»<code>META-INF/spring.factories</code>æˆ–<code>META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports</code>è·å–é…ç½®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AutoConfigurationImportSelector</span> <span class="keyword">implements</span> <span class="title class_">DeferredImportSelector</span>, BeanClassLoaderAware,</span><br><span class="line">ResourceLoaderAware, BeanFactoryAware, EnvironmentAware, Ordered &#123;</span><br><span class="line">            <span class="keyword">protected</span> List&lt;String&gt; <span class="title function_">getCandidateConfigurations</span><span class="params">(AnnotationMetadata metadata, AnnotationAttributes attributes)</span> &#123;</span><br><span class="line">List&lt;String&gt; configurations = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(</span><br><span class="line">SpringFactoriesLoader.loadFactoryNames(getSpringFactoriesLoaderFactoryClass(), getBeanClassLoader()));</span><br><span class="line">ImportCandidates.load(AutoConfiguration.class, getBeanClassLoader()).forEach(configurations::add);</span><br><span class="line">Assert.notEmpty(configurations,</span><br><span class="line"><span class="string">&quot;No auto configuration classes found in META-INF/spring.factories nor in META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports. If you &quot;</span></span><br><span class="line">+ <span class="string">&quot;are using a custom packaging, make sure that file is correct.&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> configurations;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šè¿°æœºåˆ¶æ‰¾åˆ°çš„å€™é€‰ç±»éƒ½æ˜¯æ ‡æœ‰ <code>@Configuration</code> æ³¨è§£çš„ Spring é…ç½®ç±»ã€‚</p><p>è¿™äº›é…ç½®ç±»å†…éƒ¨ä½¿ç”¨ <code>@Bean</code> æ³¨è§£å®šä¹‰äº†å¤§é‡<strong>æ¡ä»¶åŒ–</strong>çš„ Beanã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(&#123;DataSource.class, EmbeddedDatabaseType.class&#125;)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(DataSourceProperties.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSourceAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">(DataSourceProperties properties)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> properties.initializeDataSourceBuilder().build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>@EnableConfigurationProperties</code>å°†é…ç½®å±æ€§ç±»ï¼ˆå¦‚<code>DataSourceProperties</code>ï¼‰ä¸é…ç½®æ–‡ä»¶ï¼ˆå¦‚<code>application.yml</code>ï¼‰ç»‘å®šï¼Œå…è®¸é€šè¿‡å±æ€§åŠ¨æ€é…ç½®Beanã€‚</p><p><strong>application.ymlç¤ºä¾‹</strong></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/mydb</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">secret</span></span><br></pre></td></tr></table></figure><p><strong>æ€»ç»“æµç¨‹ï¼š</strong></p><ol><li>å¯åŠ¨ <code>main</code> æ–¹æ³•ï¼ŒåŠ è½½æ ‡æ³¨äº† <code>@SpringBootApplication</code> çš„ä¸»ç±»ã€‚</li><li><code>@SpringBootApplication</code> ä¸­çš„ <code>@EnableAutoConfiguration</code> æ¿€æ´»è‡ªåŠ¨è£…é…ã€‚</li><li><code>@EnableAutoConfiguration</code> é€šè¿‡ <code>@Import</code> å¼•å…¥ <code>AutoConfigurationImportSelector</code>ã€‚</li><li><code>AutoConfigurationImportSelector</code> åœ¨é€‚å½“çš„æ—¶å€™æ‰§è¡Œï¼š<ul><li>è¯»å– <code>spring-autoconfigure-metadata.properties</code> è¿›è¡Œ<strong>å¿«é€Ÿè¿‡æ»¤</strong>ã€‚</li><li>è¯»å– <code>META-INF/spring.factories</code> æˆ– <code>META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports</code> æ–‡ä»¶ï¼Œè·å–<strong>æ‰€æœ‰å€™é€‰è‡ªåŠ¨é…ç½®ç±»</strong>çš„å…¨ååˆ—è¡¨ã€‚</li><li><strong>åº”ç”¨è‡ªåŠ¨é…ç½®å…ƒæ•°æ®è¿‡æ»¤å™¨</strong>ï¼Œå‰”é™¤æ˜æ˜¾ä¸æ»¡è¶³æ¡ä»¶çš„å€™é€‰ç±»ã€‚</li></ul></li><li>éå†å‰©ä¸‹çš„å€™é€‰è‡ªåŠ¨é…ç½®ç±»ï¼š<ul><li>ä½¿ç”¨åå°„åŠ è½½ç±»ã€‚</li><li><strong>è¯¦ç»†è¯„ä¼°ç±»ä¸Šçš„ <code>@Conditional</code> åŠå…¶è¡ç”Ÿæ³¨è§£</strong>ã€‚</li><li>å¦‚æœç±»çº§åˆ«çš„æ¡ä»¶æ»¡è¶³ï¼Œåˆ™å°†è¯¥é…ç½®ç±»ä½œä¸ºä¸€ä¸ª <code>@Configuration</code> ç±»å¤„ç†ã€‚</li><li>å¤„ç†é…ç½®ç±»å†…éƒ¨çš„ <code>@Bean</code> æ–¹æ³•ï¼ŒåŒæ ·è¯„ä¼°æ–¹æ³•ä¸Šçš„æ¡ä»¶æ³¨è§£ï¼Œæ»¡è¶³æ¡ä»¶çš„æ‰æ³¨å†Œä¸º Beanã€‚</li></ul></li><li>æœ€ç»ˆï¼Œæ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„è‡ªåŠ¨é…ç½®ç±»ä¸­å®šä¹‰çš„ Bean è¢«æ³¨å†Œåˆ° Spring IoC å®¹å™¨ä¸­ï¼Œåº”ç”¨å°±æ‹¥æœ‰äº†æ‰€éœ€çš„åŸºç¡€è®¾æ–½ Beanã€‚</li></ol><h2 id="è‡ªå®šä¹‰Starterå¼€å‘è¦ç‚¹"><a href="#è‡ªå®šä¹‰Starterå¼€å‘è¦ç‚¹" class="headerlink" title="è‡ªå®šä¹‰Starterå¼€å‘è¦ç‚¹"></a>è‡ªå®šä¹‰Starterå¼€å‘è¦ç‚¹</h2><p><strong>1. Starter çš„æ ¸å¿ƒç»„æˆ</strong></p><p>ä¸€ä¸ªå®Œæ•´çš„ Starter åŒ…å«ä¸¤ä¸ªæ¨¡å—ï¼ˆå¯åˆå¹¶ï¼‰ï¼š</p><ol><li><strong><code>xxx-spring-boot-starter</code></strong><br>ç©ºæ¨¡å—ï¼Œä»…å£°æ˜ä¾èµ–ï¼ˆå¦‚è‡ªåŠ¨é…ç½®æ¨¡å—å’Œå…¶ä»–å¿…è¦ä¾èµ–ï¼‰ï¼Œä¾›ç”¨æˆ·ç›´æ¥å¼•å…¥ã€‚</li><li><strong><code>xxx-spring-boot-autoconfigure</code></strong><br>æ ¸å¿ƒå®ç°æ¨¡å—ï¼ŒåŒ…å«è‡ªåŠ¨é…ç½®ç±»ã€æ¡ä»¶æ³¨è§£ã€é…ç½®å±æ€§ç»‘å®šç­‰ã€‚</li></ol><p><strong>2. å¼€å‘æ­¥éª¤ä¸å…³é”®ä»£ç </strong></p><p><strong>åˆ›å»ºé¡¹ç›®ç»“æ„</strong></p><p>ä½¿ç”¨ Maven æˆ– Gradle åˆ›å»ºæ¨¡å—ï¼Œå»ºè®®ç»“æ„ï¼š</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">my-starter/</span><br><span class="line">  â”œâ”€â”€ my-starter-spring-boot-autoconfigure/  # è‡ªåŠ¨é…ç½®æ¨¡å—</span><br><span class="line">  â”‚   â”œâ”€â”€ src/main/java</span><br><span class="line">  â”‚   â”‚   â””â”€â”€ com/example/autoconfigure</span><br><span class="line">  â”‚   â”‚       â”œâ”€â”€ MyServiceAutoConfiguration.java  # è‡ªåŠ¨é…ç½®ç±»</span><br><span class="line">  â”‚   â”‚       â””â”€â”€ MyServiceProperties.java         # é…ç½®å±æ€§ç±»</span><br><span class="line">  â”‚   â””â”€â”€ src/main/resources/META-INF</span><br><span class="line">  â”‚       â”œâ”€â”€ spring.factories                    # è‡ªåŠ¨é…ç½®æ³¨å†Œ</span><br><span class="line">  â”‚       â””â”€â”€ additional-spring-configuration-metadata.json  # é…ç½®æç¤ºï¼ˆå¯é€‰ï¼‰</span><br><span class="line">  â”‚</span><br><span class="line">  â””â”€â”€ my-starter-spring-boot-starter/         # Starter å…¥å£æ¨¡å—</span><br><span class="line">      â””â”€â”€ pom.xml                             # ä»…ä¾èµ–è‡ªåŠ¨é…ç½®æ¨¡å—</span><br></pre></td></tr></table></figure><p><strong>ç¼–å†™è‡ªåŠ¨é…ç½®ç±»</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(MyServiceProperties.class)</span>  <span class="comment">// å¯ç”¨é…ç½®å±æ€§ç»‘å®š</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(MyService.class)</span>  <span class="comment">// ç±»è·¯å¾„å­˜åœ¨ MyService æ—¶ç”Ÿæ•ˆ</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyServiceAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span>  <span class="comment">// ç”¨æˆ·æœªè‡ªå®šä¹‰æ—¶æ³¨å†Œ Bean</span></span><br><span class="line">    <span class="keyword">public</span> MyService <span class="title function_">myService</span><span class="params">(MyServiceProperties properties)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyService</span>(properties.getUrl(), properties.getTimeout());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å®šä¹‰é…ç½®å±æ€§ç±»</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;my.service&quot;)</span>  <span class="comment">// é…ç½®å‰ç¼€</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyServiceProperties</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://default-url&quot;</span>;  <span class="comment">// é»˜è®¤å€¼</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">timeout</span> <span class="operator">=</span> <span class="number">5000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Getter å’Œ Setter å¿…é¡»æä¾›</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUrl</span><span class="params">()</span> &#123; <span class="keyword">return</span> url; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUrl</span><span class="params">(String url)</span> &#123; <span class="built_in">this</span>.url = url; &#125;</span><br><span class="line">    <span class="comment">// ... å…¶ä»–å±æ€§</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ³¨å†Œè‡ªåŠ¨é…ç½®ç±»</strong></p><p>åœ¨ <code>resources/META-INF/spring.factories</code> ä¸­å£°æ˜ï¼š</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span>=<span class="string">\</span></span><br><span class="line"><span class="string">com.example.autoconfigure.MyServiceAutoConfiguration</span></span><br></pre></td></tr></table></figure><p><strong>é…ç½®æç¤ºï¼ˆå¯é€‰ï¼‰</strong></p><p>åœ¨ <code>resources/META-INF/additional-spring-configuration-metadata.json</code> ä¸­ä¸ºé…ç½®é¡¹æ·»åŠ æè¿°ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;my.service.url&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.String&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;æœåŠ¡ URL åœ°å€&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;defaultValue&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://default-url&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;my.service.timeout&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.Integer&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;defaultValue&quot;</span><span class="punctuation">:</span> <span class="number">5000</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><strong>æ‰“åŒ…å¹¶å‘å¸ƒ</strong></p><ul><li><strong>Maven</strong>ï¼šé€šè¿‡ <code>mvn clean install</code> å®‰è£…åˆ°æœ¬åœ°ä»“åº“ï¼Œæˆ–éƒ¨ç½²åˆ° Nexus ç§æœã€‚</li><li><strong>Gradle</strong>ï¼šä½¿ç”¨ <code>publishToMavenLocal</code> æˆ–é…ç½®å‘å¸ƒä»»åŠ¡ã€‚</li></ul><p><strong>3. ä½¿ç”¨è‡ªå®šä¹‰ Starter</strong></p><p>ç”¨æˆ·å¼•å…¥ä¾èµ–åï¼Œå¯ç›´æ¥é€šè¿‡é…ç½®æ–‡ä»¶ï¼ˆå¦‚ <code>application.yml</code>ï¼‰é…ç½®å‚æ•°ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">my:</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">http://custom-url</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">3000</span></span><br></pre></td></tr></table></figure><p><strong>4. æœ€ä½³å®è·µ</strong></p><ul><li><strong>æ¨¡å—åŒ–è®¾è®¡</strong>ï¼šå°†è‡ªåŠ¨é…ç½®ä¸ Starter åˆ†ç¦»ï¼Œæ–¹ä¾¿å…¶ä»–æ¨¡å—å¤ç”¨ã€‚</li><li><strong>é˜²å¾¡æ€§ç¼–ç¨‹</strong>ï¼šåœ¨è‡ªåŠ¨é…ç½®ç±»ä¸­æ£€æŸ¥ä¾èµ–æ˜¯å¦å­˜åœ¨ï¼ˆå¦‚é€šè¿‡ <code>@ConditionalOnClass</code>ï¼‰ã€‚</li><li><strong>é»˜è®¤é…ç½®åˆç†</strong>ï¼šæä¾›å®‰å…¨ã€é€šç”¨çš„é»˜è®¤å€¼ï¼Œå‡å°‘ç”¨æˆ·é…ç½®è´Ÿæ‹…ã€‚</li></ul><h2 id="ç»Ÿä¸€å¼‚å¸¸å¤„ç†çš„æœ€ä½³å®è·µ"><a href="#ç»Ÿä¸€å¼‚å¸¸å¤„ç†çš„æœ€ä½³å®è·µ" class="headerlink" title="ç»Ÿä¸€å¼‚å¸¸å¤„ç†çš„æœ€ä½³å®è·µ"></a>ç»Ÿä¸€å¼‚å¸¸å¤„ç†çš„æœ€ä½³å®è·µ</h2><p>ä»¥ä¸‹æ˜¯ <strong>Spring Boot ç»Ÿä¸€å¼‚å¸¸å¤„ç†çš„æœ€ä½³å®è·µ</strong>ï¼Œæ¶µç›–å¼‚å¸¸åˆ†ç±»ã€å…¨å±€å¤„ç†ã€æ—¥å¿—è®°å½•ã€é”™è¯¯å“åº”è§„èŒƒç­‰å…³é”®ç¯èŠ‚ï¼Œå¸®åŠ©å¼€å‘è€…æ„å»ºå¥å£®ä¸”æ˜“ç»´æŠ¤çš„åº”ç”¨ç¨‹åºï¼š</p><p><strong>æ ¸å¿ƒåŸåˆ™</strong></p><ol><li><strong>ç»Ÿä¸€å…¥å£</strong>ï¼šæ‰€æœ‰å¼‚å¸¸ç”±å…¨å±€å¤„ç†å™¨æ•è·ï¼Œé¿å…åˆ†æ•£åœ¨å„å¤„ã€‚</li><li><strong>å‹å¥½å“åº”</strong>ï¼šå‰ç«¯æ¥æ”¶ç»“æ„åŒ–é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚JSONï¼‰ï¼ŒåŒ…å«é”™è¯¯ç ã€æç¤ºæ¶ˆæ¯ç­‰ã€‚</li><li><strong>åˆ†ç±»å¤„ç†</strong>ï¼šåŒºåˆ†ä¸šåŠ¡å¼‚å¸¸ã€ç³»ç»Ÿå¼‚å¸¸ã€å‚æ•°æ ¡éªŒå¼‚å¸¸ç­‰ï¼Œé’ˆå¯¹æ€§å¤„ç†ã€‚</li><li><strong>å®‰å…¨æ—¥å¿—</strong>ï¼šæ•æ„Ÿä¿¡æ¯è„±æ•ï¼Œå¼‚å¸¸æ—¥å¿—è¯¦ç»†è®°å½•ï¼Œä½†é¿å…æš´éœ²ç»™å®¢æˆ·ç«¯ã€‚</li></ol><p><strong>å®ç°æ­¥éª¤ä¸ä»£ç ç¤ºä¾‹</strong></p><ol><li><strong>å®šä¹‰ç»Ÿä¸€å“åº”æ ¼å¼</strong></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Result</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> code;    <span class="comment">// çŠ¶æ€ç ï¼ˆå¦‚200æˆåŠŸï¼Œ500ç³»ç»Ÿé”™è¯¯ï¼‰</span></span><br><span class="line">    <span class="keyword">private</span> String msg;  <span class="comment">// æç¤ºä¿¡æ¯ï¼ˆç”¨æˆ·å‹å¥½ï¼‰</span></span><br><span class="line">    <span class="keyword">private</span> T data;      <span class="comment">// å“åº”æ•°æ®</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æˆåŠŸå“åº”</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Result&lt;T&gt; <span class="title function_">success</span><span class="params">(T data)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>&lt;&gt;(<span class="number">200</span>, <span class="string">&quot;æ“ä½œæˆåŠŸ&quot;</span>, data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤±è´¥å“åº”</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Result&lt;T&gt; <span class="title function_">error</span><span class="params">(<span class="type">int</span> code, String msg)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>&lt;&gt;(code, msg, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ„é€ æ–¹æ³•ã€Getter/Setterçœç•¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li><strong>åˆ›å»ºå…¨å±€å¼‚å¸¸å¤„ç†å™¨</strong></li></ol><p>ä½¿ç”¨ <code>@ControllerAdvice</code> + <code>@ExceptionHandler</code> æ•è·å…¨å±€å¼‚å¸¸ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GlobalExceptionHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤„ç†ä¸šåŠ¡å¼‚å¸¸</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(BusinessException.class)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Void&gt; <span class="title function_">handleBusinessException</span><span class="params">(BusinessException e)</span> &#123;</span><br><span class="line">        log.warn(<span class="string">&quot;ä¸šåŠ¡å¼‚å¸¸: &#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">        <span class="keyword">return</span> Result.error(e.getCode(), e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤„ç†å‚æ•°æ ¡éªŒå¼‚å¸¸ï¼ˆJSR-303ï¼‰</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(MethodArgumentNotValidException.class)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Void&gt; <span class="title function_">handleValidationException</span><span class="params">(MethodArgumentNotValidException e)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> e.getBindingResult().getFieldErrors().stream()</span><br><span class="line">                .map(fieldError -&gt; fieldError.getField() + <span class="string">&quot;: &quot;</span> + fieldError.getDefaultMessage())</span><br><span class="line">                .collect(Collectors.joining(<span class="string">&quot;; &quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> Result.error(<span class="number">400</span>, <span class="string">&quot;å‚æ•°æ ¡éªŒå¤±è´¥: &quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤„ç†å…¶ä»–æœªæ•è·å¼‚å¸¸</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(Exception.class)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Void&gt; <span class="title function_">handleException</span><span class="params">(Exception e)</span> &#123;</span><br><span class="line">        log.error(<span class="string">&quot;ç³»ç»Ÿå¼‚å¸¸: &quot;</span>, e);  <span class="comment">// è®°å½•å®Œæ•´å †æ ˆ</span></span><br><span class="line">        <span class="keyword">return</span> Result.error(<span class="number">500</span>, <span class="string">&quot;ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li><strong>è‡ªå®šä¹‰ä¸šåŠ¡å¼‚å¸¸</strong></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BusinessException</span> <span class="keyword">extends</span> <span class="title class_">RuntimeException</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> code;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BusinessException</span><span class="params">(<span class="type">int</span> code, String message)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(message);</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¿«é€Ÿåˆ›å»ºå¸¸ç”¨å¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> BusinessException <span class="title function_">of</span><span class="params">(<span class="type">int</span> code, String msg)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(code, msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getCode</span><span class="params">()</span> &#123; <span class="keyword">return</span> code; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="4"><li><strong>å‚æ•°æ ¡éªŒè§„èŒƒåŒ–</strong></li></ol><p>åœ¨ DTO ä¸­ä½¿ç”¨æ ¡éªŒæ³¨è§£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDTO</span> &#123;</span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;ç”¨æˆ·åä¸èƒ½ä¸ºç©º&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Email(message = &quot;é‚®ç®±æ ¼å¼ä¸æ­£ç¡®&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Getter/Setterçœç•¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="5"><li><strong>HTTPçŠ¶æ€ç ä¸é”™è¯¯ç æ˜ å°„</strong></li></ol><table><thead><tr><th align="left">å¼‚å¸¸ç±»å‹</th><th align="left">HTTPçŠ¶æ€ç </th><th align="left">é”™è¯¯ç </th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left"><code>BusinessException</code></td><td align="left">200</td><td align="left">è‡ªå®šä¹‰</td><td align="left">ä¸šåŠ¡é€»è¾‘é”™è¯¯ï¼ˆå¦‚è®¢å•çŠ¶æ€å¼‚å¸¸ï¼‰</td></tr><tr><td align="left"><code>MethodArgumentNotValid</code></td><td align="left">400</td><td align="left">400</td><td align="left">å‚æ•°æ ¡éªŒå¤±è´¥</td></tr><tr><td align="left"><code>AuthenticationException</code></td><td align="left">401</td><td align="left">401</td><td align="left">æœªç™»å½•æˆ–Tokenè¿‡æœŸ</td></tr><tr><td align="left"><code>AccessDeniedException</code></td><td align="left">403</td><td align="left">403</td><td align="left">æ— æƒé™è®¿é—®</td></tr><tr><td align="left"><code>å…¶ä»–æœªæ•è·å¼‚å¸¸</code></td><td align="left">500</td><td align="left">500</td><td align="left">ç³»ç»Ÿå†…éƒ¨é”™è¯¯</td></tr></tbody></table><p><strong>ä¸‰ã€æœ€ä½³å®è·µ</strong></p><ol><li><strong>å¼‚å¸¸åˆ†ç±»åˆ†å±‚å¤„ç†</strong></li></ol><ul><li><strong>ä¸šåŠ¡å¼‚å¸¸</strong>ï¼šç”±å¼€å‘è€…ä¸»åŠ¨æŠ›å‡ºï¼ˆå¦‚åº“å­˜ä¸è¶³ï¼‰ï¼Œæ˜ç¡®æç¤ºç”¨æˆ·ã€‚</li><li><strong>ç³»ç»Ÿå¼‚å¸¸</strong>ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥ç­‰ï¼Œæç¤ºå‹å¥½ä¿¡æ¯ï¼Œè®°å½•è¯¦ç»†æ—¥å¿—ã€‚</li><li><strong>ç¬¬ä¸‰æ–¹æœåŠ¡å¼‚å¸¸</strong>ï¼šå°è£…ä¸ºç‰¹å®šå¼‚å¸¸ï¼ˆå¦‚ <code>ThirdPartyException</code>ï¼‰ï¼Œé¿å…æ±¡æŸ“æ ¸å¿ƒé€»è¾‘ã€‚</li></ul><ol start="2"><li><strong>æ—¥å¿—è®°å½•è§„èŒƒ</strong></li></ol><ul><li><strong>ä¸šåŠ¡å¼‚å¸¸</strong>ï¼šè®°å½• <code>WARN</code> çº§åˆ«ï¼ŒåŒ…å«å…³é”®å‚æ•°ã€‚</li><li><strong>ç³»ç»Ÿå¼‚å¸¸</strong>ï¼šè®°å½• <code>ERROR</code> çº§åˆ«ï¼Œè¾“å‡ºå®Œæ•´å †æ ˆã€‚</li><li><strong>æ•æ„Ÿä¿¡æ¯è„±æ•</strong>ï¼šå¦‚èº«ä»½è¯å·ã€æ‰‹æœºå·åœ¨æ—¥å¿—ä¸­æ©ç å¤„ç†ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExceptionHandler(PaymentException.class)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Void&gt; <span class="title function_">handlePaymentException</span><span class="params">(PaymentException e)</span> &#123;</span><br><span class="line">    log.warn(<span class="string">&quot;æ”¯ä»˜å¤±è´¥, è®¢å•å·: &#123;&#125;, åŸå› : &#123;&#125;&quot;</span>, e.getOrderId(), e.getMessage());</span><br><span class="line">    <span class="keyword">return</span> Result.error(<span class="number">1001</span>, <span class="string">&quot;æ”¯ä»˜å¤±è´¥ï¼Œè¯·é‡è¯•&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li><strong>é”™è¯¯ç è§„èŒƒ</strong></li></ol><ul><li><strong>æ¨¡å—åˆ’åˆ†</strong>ï¼šæŒ‰æ¨¡å—å®šä¹‰é”™è¯¯ç èŒƒå›´ï¼ˆå¦‚ç”¨æˆ·æ¨¡å—1000-1999ï¼‰ã€‚</li><li><strong>æ–‡æ¡£ç»´æŠ¤</strong>ï¼šæä¾›é”™è¯¯ç å¯¹ç…§è¡¨ï¼Œæ–¹ä¾¿å‰åç«¯åä½œã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é”™è¯¯ç å¸¸é‡ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ErrorCode</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">USER_NOT_FOUND</span> <span class="operator">=</span> <span class="number">1001</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">ORDER_EXPIRED</span> <span class="operator">=</span> <span class="number">2001</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="4"><li><strong>å‰ç«¯å‹å¥½æç¤º</strong></li></ol><ul><li><strong>ç”¨æˆ·å¯è§æ¶ˆæ¯</strong>ï¼šç®€æ´æ˜ç¡®ï¼Œå¦‚â€œå¯†ç å¼ºåº¦ä¸è¶³ï¼Œè‡³å°‘åŒ…å«å¤§å°å†™å­—æ¯â€ã€‚</li><li><strong>æŠ€æœ¯ç»†èŠ‚éš”ç¦»</strong>ï¼šä¸è¿”å›Javaå¼‚å¸¸ç±»åã€å †æ ˆä¿¡æ¯ã€‚</li></ul><ol start="5"><li><strong>æµ‹è¯•è¦†ç›–</strong></li></ol><p>éªŒè¯å¼‚å¸¸å¤„ç†é€»è¾‘ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExceptionHandlerTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MockMvc mockMvc;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testBusinessException</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        mockMvc.perform(get(<span class="string">&quot;/api/order/123&quot;</span>))</span><br><span class="line">               .andExpect(status().isOk())</span><br><span class="line">               .andExpect(jsonPath(<span class="string">&quot;$.code&quot;</span>).value(<span class="number">1001</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å››ã€å¸¸è§é—®é¢˜ä¸è§£å†³</strong></p><ol><li><strong>å¼‚å¸¸æœªè¢«æ•è·</strong><ul><li>æ£€æŸ¥ <code>@ControllerAdvice</code> æ˜¯å¦åœ¨ç»„ä»¶æ‰«æè·¯å¾„å†…ã€‚</li><li>ç¡®è®¤æ²¡æœ‰å…¶ä»–å¼‚å¸¸å¤„ç†å™¨å†²çªã€‚</li></ul></li><li><strong>å¾ªç¯ä¾èµ–å¯¼è‡´å¤„ç†å™¨å¤±æ•ˆ</strong><ul><li>ç¡®ä¿å…¨å±€å¤„ç†å™¨ä¸ä¾èµ–å¯èƒ½æŠ›å‡ºå¼‚å¸¸çš„Beanã€‚</li></ul></li><li><strong>å¼‚æ­¥çº¿ç¨‹å¼‚å¸¸ä¸¢å¤±</strong><ul><li>ä½¿ç”¨ <code>AsyncUncaughtExceptionHandler</code> å¤„ç†å¼‚æ­¥ä»»åŠ¡å¼‚å¸¸ã€‚</li></ul></li></ol><p><strong>äº”ã€æ€»ç»“</strong></p><p>é€šè¿‡ç»Ÿä¸€å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼Œå¯ä»¥å®ç°ï¼š</p><ul><li><strong>ä»£ç ç®€æ´æ€§</strong>ï¼šæ¶ˆé™¤é‡å¤çš„ <code>try-catch</code> å—ã€‚</li><li><strong>ç»´æŠ¤ä¾¿æ·æ€§</strong>ï¼šé›†ä¸­ç®¡ç†é”™è¯¯å“åº”é€»è¾‘ã€‚</li><li><strong>æ¥å£è§„èŒƒæ€§</strong>ï¼šå‰åç«¯éµå¾ªç»Ÿä¸€çš„é”™è¯¯åè®®ã€‚</li><li><strong>ç³»ç»Ÿå¥å£®æ€§</strong>ï¼šå…³é”®å¼‚å¸¸ä¸æ¼å¤„ç†ï¼Œæ—¥å¿—å¯è¿½æº¯ã€‚</li></ul><h2 id="é…ç½®åŠ è½½ä¼˜å…ˆçº§ï¼ˆå‘½ä»¤è¡Œ-ç¯å¢ƒå˜é‡ï¼‰"><a href="#é…ç½®åŠ è½½ä¼˜å…ˆçº§ï¼ˆå‘½ä»¤è¡Œ-ç¯å¢ƒå˜é‡ï¼‰" class="headerlink" title="é…ç½®åŠ è½½ä¼˜å…ˆçº§ï¼ˆå‘½ä»¤è¡Œ&gt;ç¯å¢ƒå˜é‡ï¼‰"></a>é…ç½®åŠ è½½ä¼˜å…ˆçº§ï¼ˆå‘½ä»¤è¡Œ&gt;ç¯å¢ƒå˜é‡ï¼‰</h2><table><thead><tr><th align="left">ä¼˜å…ˆçº§</th><th align="left">é…ç½®æº</th><th align="left">ç¤ºä¾‹</th></tr></thead><tbody><tr><td align="left"><strong>1</strong></td><td align="left"><strong>å‘½ä»¤è¡Œå‚æ•°</strong></td><td align="left"><code>--server.port=8081</code></td></tr><tr><td align="left"><strong>2</strong></td><td align="left">Java ç³»ç»Ÿå±æ€§ (<code>-D</code>)</td><td align="left"><code>-Dspring.datasource.url=jdbc:mysql://...</code></td></tr><tr><td align="left"><strong>3</strong></td><td align="left"><strong>æ“ä½œç³»ç»Ÿç¯å¢ƒå˜é‡</strong></td><td align="left"><code>export SERVER_PORT=8081</code> (Linux)</td></tr><tr><td align="left"><strong>4</strong></td><td align="left">é…ç½®æ–‡ä»¶ï¼ˆå¦‚ <code>application.yml</code>ï¼‰</td><td align="left"><code>server.port: 8080</code></td></tr></tbody></table><h2 id="è¿‡æ»¤å™¨ã€æ‹¦æˆªå™¨ã€AOPçš„åŒºåˆ«"><a href="#è¿‡æ»¤å™¨ã€æ‹¦æˆªå™¨ã€AOPçš„åŒºåˆ«" class="headerlink" title="è¿‡æ»¤å™¨ã€æ‹¦æˆªå™¨ã€AOPçš„åŒºåˆ«"></a>è¿‡æ»¤å™¨ã€æ‹¦æˆªå™¨ã€AOPçš„åŒºåˆ«</h2><table><thead><tr><th align="left"><strong>ç»´åº¦</strong></th><th align="left"><strong>è¿‡æ»¤å™¨ï¼ˆFilterï¼‰</strong></th><th align="left"><strong>æ‹¦æˆªå™¨ï¼ˆInterceptorï¼‰</strong></th><th align="left"><strong>AOPï¼ˆAspectï¼‰</strong></th></tr></thead><tbody><tr><td align="left"><strong>è§„èŒƒ&#x2F;æ¡†æ¶</strong></td><td align="left">Servlet è§„èŒƒï¼ˆJava EEï¼‰</td><td align="left">Spring MVC æ¡†æ¶</td><td align="left">Spring AOP &#x2F; AspectJ</td></tr><tr><td align="left"><strong>ä½œç”¨é˜¶æ®µ</strong></td><td align="left">è¯·æ±‚è¿›å…¥ Servlet å‰&#x2F;å“åº”è¿”å›å®¢æˆ·ç«¯å‰</td><td align="left">Controller æ–¹æ³•æ‰§è¡Œå‰å</td><td align="left">ä»»æ„ Bean æ–¹æ³•æ‰§è¡Œå‰å</td></tr><tr><td align="left"><strong>ä½œç”¨èŒƒå›´</strong></td><td align="left">æ‰€æœ‰ HTTP è¯·æ±‚ï¼ˆåŒ…æ‹¬é™æ€èµ„æºï¼‰</td><td align="left">Spring MVC å¤„ç†çš„è¯·æ±‚ï¼ˆåŠ¨æ€èµ„æºï¼‰</td><td align="left">Spring ç®¡ç†çš„ Bean æ–¹æ³•</td></tr><tr><td align="left"><strong>ä¾èµ–å…³ç³»</strong></td><td align="left">ä¾èµ– Servlet å®¹å™¨ï¼ˆTomcat&#x2F;Jettyï¼‰</td><td align="left">ä¾èµ– Spring å®¹å™¨</td><td align="left">ä¾èµ– Spring å®¹å™¨</td></tr><tr><td align="left"><strong>å…¸å‹åœºæ™¯</strong></td><td align="left">å­—ç¬¦ç¼–ç ã€è·¨åŸŸå¤„ç†ã€è¯·æ±‚æ—¥å¿—</td><td align="left">æƒé™æ ¡éªŒã€å‚æ•°é¢„å¤„ç†ã€æ—¥å¿—è®°å½•</td><td align="left">äº‹åŠ¡ç®¡ç†ã€æ€§èƒ½ç›‘æ§ã€ç¼“å­˜æ§åˆ¶</td></tr></tbody></table><p><strong>æ‰§è¡Œæµç¨‹ä¸é¡ºåº</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// HTTP è¯·æ±‚å¤„ç†æµç¨‹</span><br><span class="line">HTTP Request â†’ Filter Chain â†’ DispatcherServlet â†’ Interceptor Chain â†’ Controller â†’ AOP Advice â†’ Response</span><br></pre></td></tr></table></figure><ol><li><strong>è¿‡æ»¤å™¨ï¼ˆFilterï¼‰</strong>ï¼šæœ€å…ˆæ‰§è¡Œï¼Œå¯æ‹¦æˆªæ‰€æœ‰è¯·æ±‚ï¼ˆå¦‚é™æ€èµ„æºï¼‰ã€‚</li><li><strong>æ‹¦æˆªå™¨ï¼ˆInterceptorï¼‰</strong>ï¼šåœ¨ <code>DispatcherServlet</code> ä¹‹åã€Controller æ–¹æ³•ä¹‹å‰æ‰§è¡Œã€‚</li><li><strong>AOP åˆ‡é¢ï¼ˆAspectï¼‰</strong>ï¼šåœ¨ Controller æˆ– Service æ–¹æ³•æ‰§è¡Œå‰åè§¦å‘ã€‚</li></ol><p><strong>å®è·µåœºæ™¯ä¸ä»£ç ç¤ºä¾‹</strong></p><p><strong>åœºæ™¯ 1ï¼šå…¨å±€è¯·æ±‚æ—¥å¿—ï¼ˆè·¨æ‰€æœ‰è¯·æ±‚ï¼‰</strong></p><ul><li><p><strong>é€‰æ‹©æ–¹æ¡ˆ</strong>ï¼š<strong>è¿‡æ»¤å™¨ï¼ˆFilterï¼‰</strong><br><strong>åŸå› </strong>ï¼šéœ€è®°å½•æ‰€æœ‰è¯·æ±‚ï¼ˆåŒ…æ‹¬é™æ€èµ„æºï¼‰çš„åŸå§‹ä¿¡æ¯ï¼ˆå¦‚ IPã€URLï¼‰ã€‚<br><strong>ç¤ºä¾‹</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebFilter(urlPatterns = &quot;/*&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest req, ServletResponse res, FilterChain chain)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        chain.doFilter(req, res); <span class="comment">// æ”¾è¡Œè¯·æ±‚</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">cost</span> <span class="operator">=</span> System.currentTimeMillis() - start;</span><br><span class="line">        System.out.println(<span class="string">&quot;è¯·æ±‚è€—æ—¶: &quot;</span> + cost + <span class="string">&quot;ms&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p><strong>åœºæ™¯ 2ï¼šç”¨æˆ·ç™»å½•æ ¡éªŒï¼ˆä»…åŠ¨æ€è¯·æ±‚ï¼‰</strong></p><ul><li><p><strong>é€‰æ‹©æ–¹æ¡ˆ</strong>ï¼š<strong>æ‹¦æˆªå™¨ï¼ˆInterceptorï¼‰</strong><br><strong>åŸå› </strong>ï¼šéœ€è®¿é—® Spring ä¸Šä¸‹æ–‡ï¼ˆå¦‚è·å–ç”¨æˆ· Sessionï¼‰ï¼Œä¸”ä»…éœ€æ‹¦æˆªåŠ¨æ€è¯·æ±‚ã€‚<br><strong>ç¤ºä¾‹</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest req, HttpServletResponse res, Object handler)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (req.getSession().getAttribute(<span class="string">&quot;user&quot;</span>) == <span class="literal">null</span>) &#123;</span><br><span class="line">            res.sendRedirect(<span class="string">&quot;/login&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// ä¸­æ–­è¯·æ±‚</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ³¨å†Œæ‹¦æˆªå™¨</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> <span class="title class_">AuthInterceptor</span>()).addPathPatterns(<span class="string">&quot;/api/**&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p><strong>åœºæ™¯ 3ï¼šæ¥å£è€—æ—¶ç»Ÿè®¡</strong></p><ul><li><p><strong>é€‰æ‹©æ–¹æ¡ˆ</strong>ï¼š<strong>AOPï¼ˆç¯ç»•é€šçŸ¥ï¼‰</strong><br><strong>åŸå› </strong>ï¼šéœ€ç»Ÿè®¡ä»»æ„æ–¹æ³•çš„æ‰§è¡Œæ—¶é—´ï¼Œçµæ´»ä½œç”¨äº Service å±‚æˆ– Controller å±‚ã€‚<br><strong>ç¤ºä¾‹</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PerformanceAspect</span> &#123;</span><br><span class="line">    <span class="meta">@Around(&quot;execution(* com.example.service.*.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">logTime</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> pjp.proceed();</span><br><span class="line">        System.out.println(<span class="string">&quot;æ–¹æ³•æ‰§è¡Œè€—æ—¶: &quot;</span> + (System.currentTimeMillis() - start) + <span class="string">&quot;ms&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p><strong>å¦‚ä½•é€‰æ‹©ï¼Ÿ</strong></p><table><thead><tr><th align="left"><strong>æŠ€æœ¯</strong></th><th align="left"><strong>ä¼˜å…ˆä½¿ç”¨åœºæ™¯</strong></th></tr></thead><tbody><tr><td align="left"><strong>è¿‡æ»¤å™¨</strong></td><td align="left">å¤„ç†åŸå§‹è¯·æ±‚&#x2F;å“åº”ï¼ˆå¦‚è·¨åŸŸã€å‹ç¼©ï¼‰ã€å…¨å±€æ—¥å¿—ã€å®‰å…¨è¿‡æ»¤ï¼ˆXSS&#x2F;SQL æ³¨å…¥é˜²å¾¡ï¼‰</td></tr><tr><td align="left"><strong>æ‹¦æˆªå™¨</strong></td><td align="left">éœ€è¦ Spring ä¸Šä¸‹æ–‡æ”¯æŒã€åŠ¨æ€è¯·æ±‚æ‹¦æˆªï¼ˆå¦‚æƒé™æ ¡éªŒã€å‚æ•°é¢„å¤„ç†ï¼‰</td></tr><tr><td align="left"><strong>AOP</strong></td><td align="left">ä¸ä¸šåŠ¡é€»è¾‘è§£è€¦çš„æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼ˆå¦‚äº‹åŠ¡ã€æ—¥å¿—ã€ç¼“å­˜ã€æ€§èƒ½ç›‘æ§ï¼‰</td></tr></tbody></table><p><strong>æœ€ä½³å®è·µ</strong></p><ol><li><strong>é¿å…åŠŸèƒ½é‡å </strong>ï¼š<ul><li>è‹¥è¿‡æ»¤å™¨ä¸æ‹¦æˆªå™¨å®ç°ç›¸ä¼¼åŠŸèƒ½ï¼ˆå¦‚æ—¥å¿—ï¼‰ï¼Œé€‰æ‹©æ›´é è¿‘è¯·æ±‚å…¥å£çš„ç»„ä»¶ï¼ˆè¿‡æ»¤å™¨ï¼‰ã€‚</li></ul></li><li><strong>æ…ç”¨ AOP æ‹¦æˆª Controller</strong>ï¼š<ul><li>Controller æ–¹æ³•é€šå¸¸å·²ç”±æ‹¦æˆªå™¨å¤„ç†ï¼ŒAOP æ›´é€‚åˆ Service å±‚ã€‚</li></ul></li><li><strong>æ€§èƒ½ä¼˜åŒ–</strong>ï¼š<ul><li>è¿‡æ»¤å™¨é“¾å’Œæ‹¦æˆªå™¨é“¾è¾ƒé•¿æ—¶ï¼Œå¯èƒ½å½±å“ååé‡ï¼Œéœ€åˆç†è®¾è®¡ã€‚</li></ul></li></ol><h2 id="MapperScan-çš„å®ç°åŸç†"><a href="#MapperScan-çš„å®ç°åŸç†" class="headerlink" title="@MapperScan çš„å®ç°åŸç†"></a><code>@MapperScan</code> çš„å®ç°åŸç†</h2><p><code>@MapperScan</code> æ˜¯ MyBatis-Spring æ•´åˆä¸­çš„æ ¸å¿ƒæ³¨è§£ï¼Œç”¨äºè‡ªåŠ¨æ‰«æå¹¶æ³¨å†Œ Mapper æ¥å£ä¸º Spring Beanã€‚å…¶å®ç°åŸç†åŸºäº Spring çš„æ‰©å±•æœºåˆ¶å’Œ MyBatis çš„åŠ¨æ€ä»£ç†ï¼Œä»¥ä¸‹æ˜¯è¯¦ç»†æ­¥éª¤å’Œæ ¸å¿ƒé€»è¾‘ï¼š</p><p><strong>1. æ³¨è§£å®šä¹‰ä¸å…¥å£</strong></p><p><code>@MapperScan</code> é€šè¿‡ <code>@Import</code> å¼•å…¥ <code>MapperScannerRegistrar</code>ï¼Œè§¦å‘æ‰«æå’Œæ³¨å†Œé€»è¾‘ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Import(MapperScannerRegistrar.class)</span> <span class="comment">// å…³é”®ï¼šå¼•å…¥æ³¨å†Œå™¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> MapperScan &#123;</span><br><span class="line">    String[] value() <span class="keyword">default</span> &#123;&#125;; <span class="comment">// æ‰«æçš„åŒ…è·¯å¾„</span></span><br><span class="line">    Class&lt;? <span class="keyword">extends</span> <span class="title class_">Annotation</span>&gt; annotationClass() <span class="keyword">default</span> Annotation.class;</span><br><span class="line">    <span class="comment">// å…¶ä»–é…ç½®å±æ€§...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>2. MapperScannerRegistrar æ³¨å†Œ Bean å®šä¹‰</strong></p><p><code>MapperScannerRegistrar</code> å®ç° <code>ImportBeanDefinitionRegistrar</code> æ¥å£ï¼Œåœ¨ Spring å®¹å™¨å¯åŠ¨æ—¶åŠ¨æ€æ³¨å†Œ Beanï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MapperScannerRegistrar</span> <span class="keyword">implements</span> <span class="title class_">ImportBeanDefinitionRegistrar</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerBeanDefinitions</span><span class="params">(AnnotationMetadata metadata, BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">        <span class="comment">// è§£æ @MapperScan æ³¨è§£çš„å±æ€§ï¼ˆå¦‚åŒ…è·¯å¾„ï¼‰</span></span><br><span class="line">        <span class="type">AnnotationAttributes</span> <span class="variable">attrs</span> <span class="operator">=</span> AnnotationAttributes.fromMap(metadata.getAnnotationAttributes(MapperScan.class.getName()));</span><br><span class="line">        <span class="comment">// åˆ›å»ºå¹¶é…ç½® ClassPathMapperScanner</span></span><br><span class="line">        <span class="type">ClassPathMapperScanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathMapperScanner</span>(registry);</span><br><span class="line">        scanner.scan(attrs.getStringArray(<span class="string">&quot;value&quot;</span>)); <span class="comment">// æ‰§è¡Œæ‰«æ</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>3. ClassPathMapperScanner æ‰«ææ¥å£</strong></p><p><code>ClassPathMapperScanner</code> ç»§æ‰¿è‡ª Spring çš„ <code>ClassPathBeanDefinitionScanner</code>ï¼Œè‡ªå®šä¹‰æ‰«æè§„åˆ™ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassPathMapperScanner</span> <span class="keyword">extends</span> <span class="title class_">ClassPathBeanDefinitionScanner</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Set&lt;BeanDefinitionHolder&gt; <span class="title function_">doScan</span><span class="params">(String... basePackages)</span> &#123;</span><br><span class="line">        <span class="comment">// è°ƒç”¨çˆ¶ç±»æ‰«ææ–¹æ³•ï¼Œç­›é€‰å‡ºç¬¦åˆæ¡ä»¶çš„æ¥å£</span></span><br><span class="line">        Set&lt;BeanDefinitionHolder&gt; beanDefinitions = <span class="built_in">super</span>.doScan(basePackages);</span><br><span class="line">        <span class="comment">// ä¸ºæ¯ä¸ªæ¥å£ç”Ÿæˆ BeanDefinitionï¼Œç»‘å®šåˆ° MapperFactoryBean</span></span><br><span class="line">        <span class="keyword">for</span> (BeanDefinitionHolder holder : beanDefinitions) &#123;</span><br><span class="line">            <span class="type">GenericBeanDefinition</span> <span class="variable">definition</span> <span class="operator">=</span> (GenericBeanDefinition) holder.getBeanDefinition();</span><br><span class="line">            <span class="comment">// è®¾ç½® Bean çš„å·¥å‚ç±»ä¸º MapperFactoryBean</span></span><br><span class="line">            definition.getConstructorArgumentValues().addGenericArgumentValue(definition.getBeanClassName());</span><br><span class="line">            definition.setBeanClass(MapperFactoryBean.class); <span class="comment">// å…³é”®ï¼šä»£ç†å·¥å‚</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> beanDefinitions;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">isCandidateComponent</span><span class="params">(AnnotatedBeanDefinition beanDefinition)</span> &#123;</span><br><span class="line">        <span class="comment">// ä»…é€‰æ‹©æ¥å£ä½œä¸ºå€™é€‰ç»„ä»¶ï¼ˆæ’é™¤ç±»ï¼‰</span></span><br><span class="line">        <span class="keyword">return</span> beanDefinition.getMetadata().isInterface();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>4. MapperFactoryBean åˆ›å»ºä»£ç†å¯¹è±¡</strong></p><p><code>MapperFactoryBean</code> æ˜¯ Spring çš„ <code>FactoryBean</code> å®ç°ï¼Œè´Ÿè´£ç”Ÿæˆ Mapper æ¥å£çš„ä»£ç†å®ä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MapperFactoryBean</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">SqlSessionDaoSupport</span> <span class="keyword">implements</span> <span class="title class_">FactoryBean</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> Class&lt;T&gt; mapperInterface;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// é€šè¿‡ SqlSession è·å– Mapper åŠ¨æ€ä»£ç†</span></span><br><span class="line">        <span class="keyword">return</span> getSqlSession().getMapper(<span class="built_in">this</span>.mapperInterface);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;T&gt; <span class="title function_">getObjectType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.mapperInterface;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>5. åŠ¨æ€ä»£ç†ä¸ SQL æ‰§è¡Œ</strong></p><p>MyBatis é€šè¿‡ <code>MapperProxy</code> ç”Ÿæˆæ¥å£çš„ JDK åŠ¨æ€ä»£ç†å¯¹è±¡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MapperProxy</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span>, Serializable &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="comment">// å°†æ–¹æ³•è°ƒç”¨è½¬æ¢ä¸º MappedStatement æ‰§è¡Œ</span></span><br><span class="line">        <span class="type">MapperMethod</span> <span class="variable">mapperMethod</span> <span class="operator">=</span> cachedMapperMethod(method);</span><br><span class="line">        <span class="keyword">return</span> mapperMethod.execute(sqlSession, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>6. æ•´åˆ Spring å®¹å™¨</strong></p><ul><li><strong>SqlSessionTemplate æ³¨å…¥</strong>ï¼š<br>MyBatis-Spring é…ç½® <code>SqlSessionTemplate</code>ï¼ˆçº¿ç¨‹å®‰å…¨çš„ SqlSession å®ç°ï¼‰ï¼Œç”± Spring ç®¡ç†æ•°æ®åº“è¿æ¥å’Œäº‹åŠ¡ã€‚</li><li><strong>ä¾èµ–å…³ç³»</strong>ï¼š<br><code>MapperFactoryBean</code> ä¾èµ– <code>SqlSessionTemplate</code>ï¼Œç¡®ä¿æ‰€æœ‰ Mapper ä»£ç†ä½¿ç”¨åŒä¸€äº‹åŠ¡ä¸Šä¸‹æ–‡ã€‚</li></ul><p><strong>7. è‡ªåŠ¨é…ç½®ä¸ Spring Boot é›†æˆ</strong></p><p>åœ¨ Spring Boot ä¸­ï¼Œ<code>@MapperScan</code> é€šå¸¸ä¸è‡ªåŠ¨é…ç½®ç±» <code>MyBatisAutoConfiguration</code> é…åˆï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoConfiguration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(&#123; SqlSessionFactory.class, SqlSessionFactoryBean.class &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBatisAutoConfiguration</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="keyword">public</span> SqlSessionFactory <span class="title function_">sqlSessionFactory</span><span class="params">(DataSource dataSource)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»º SqlSessionFactory</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ€»ç»“æµç¨‹</strong></p><ol><li><strong>æ³¨è§£è§¦å‘</strong>ï¼š<code>@MapperScan</code> å¼•å…¥ <code>MapperScannerRegistrar</code>ã€‚</li><li><strong>åŠ¨æ€æ³¨å†Œ</strong>ï¼š<code>MapperScannerRegistrar</code> ä½¿ç”¨ <code>ClassPathMapperScanner</code> æ‰«ææŒ‡å®šåŒ…ä¸‹çš„æ¥å£ã€‚</li><li><strong>Bean å®šä¹‰ç”Ÿæˆ</strong>ï¼šä¸ºæ¯ä¸ª Mapper æ¥å£åˆ›å»ºç»‘å®šåˆ° <code>MapperFactoryBean</code> çš„ Bean å®šä¹‰ã€‚</li><li><strong>ä»£ç†å®ä¾‹åŒ–</strong>ï¼šSpring å®¹å™¨å®ä¾‹åŒ–æ—¶ï¼Œ<code>MapperFactoryBean</code> é€šè¿‡ <code>SqlSessionTemplate</code> åˆ›å»ºåŠ¨æ€ä»£ç†å¯¹è±¡ã€‚</li><li><strong>æ–¹æ³•æ‹¦æˆª</strong>ï¼šè°ƒç”¨ Mapper æ–¹æ³•æ—¶ï¼Œä»£ç†å¯¹è±¡å°†è¯·æ±‚è½¬å‘ç»™ MyBatis æ‰§è¡Œ SQLã€‚</li></ol><p><strong>å…³é”®è®¾è®¡ç‚¹</strong></p><ul><li><strong>è§£è€¦ä¸æ‰©å±•</strong>ï¼šé€šè¿‡ Spring çš„ <code>FactoryBean</code> å’Œ <code>ImportBeanDefinitionRegistrar</code> å®ç°æ— ç¼æ•´åˆã€‚</li><li><strong>æ€§èƒ½ä¼˜åŒ–</strong>ï¼šåŠ¨æ€ä»£ç†å’Œç¼“å­˜æœºåˆ¶ï¼ˆå¦‚ <code>MapperMethod</code> ç¼“å­˜ï¼‰å‡å°‘åå°„å¼€é”€ã€‚</li><li><strong>äº‹åŠ¡ä¸€è‡´æ€§</strong>ï¼šä¾èµ– Spring ç®¡ç†çš„äº‹åŠ¡ï¼Œç¡®ä¿ Mapper æ“ä½œåœ¨åŒä¸€ä¸ª <code>SqlSession</code> ä¸­æ‰§è¡Œã€‚</li></ul><p>é€šè¿‡ <code>@MapperScan</code>ï¼Œå¼€å‘è€…æ— éœ€æ‰‹åŠ¨é…ç½®æ¯ä¸ª Mapperï¼Œæ¡†æ¶è‡ªåŠ¨å®Œæˆæ¥å£åˆ° Bean çš„æ˜ å°„åŠä»£ç†ç”Ÿæˆï¼Œæå¤§ç®€åŒ–äº† MyBatis åœ¨ Spring ä¸­çš„ä½¿ç”¨ã€‚</p><h2 id="Autowired-çš„å®ç°åŸç†"><a href="#Autowired-çš„å®ç°åŸç†" class="headerlink" title="@Autowired çš„å®ç°åŸç†"></a><code>@Autowired</code> çš„å®ç°åŸç†</h2><p><code>@Autowired</code> æ˜¯ Spring æ¡†æ¶ä¸­å®ç°ä¾èµ–æ³¨å…¥çš„æ ¸å¿ƒæ³¨è§£ï¼Œå…¶åº•å±‚åŸç†åŸºäº <strong>Bean ç”Ÿå‘½å‘¨æœŸç®¡ç†</strong>ã€<strong>åå°„æœºåˆ¶</strong> å’Œ <strong>BeanPostProcessor</strong> çš„åä½œã€‚ä»¥ä¸‹æ˜¯å…¶å®ç°åŸç†çš„è¯¦ç»†åˆ†æï¼š</p><p><strong>1. æ ¸å¿ƒæµç¨‹</strong></p><p><code>@Autowired</code> çš„ä¾èµ–æ³¨å…¥å‘ç”Ÿåœ¨ Bean çš„å±æ€§å¡«å……é˜¶æ®µï¼Œå…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š</p><p><strong>1.1 Bean å®ä¾‹åŒ–</strong></p><p>Spring å®¹å™¨é€šè¿‡åå°„è°ƒç”¨æ„é€ å‡½æ•°åˆ›å»º Bean å®ä¾‹ï¼ˆè‹¥å­˜åœ¨å¤šä¸ªæ„é€ å‡½æ•°ï¼Œä¼˜å…ˆé€‰æ‹©æ— å‚æ„é€ å‡½æ•°ï¼Œæˆ–æ ‡è®° <code>@Autowired</code> çš„æ„é€ å‡½æ•°ï¼‰ã€‚</p><p><strong>1.2 å±æ€§å¡«å……ï¼ˆä¾èµ–æ³¨å…¥ï¼‰</strong></p><ul><li><strong>è§¦å‘æ—¶æœº</strong>ï¼šåœ¨ <code>AbstractAutowireCapableBeanFactory</code> çš„ <code>populateBean()</code> æ–¹æ³•ä¸­ã€‚</li><li><strong>å¤„ç†ç»„ä»¶</strong>ï¼š<code>AutowiredAnnotationBeanPostProcessor</code>ï¼ˆç»§æ‰¿è‡ª <code>BeanPostProcessor</code>ï¼‰ã€‚</li></ul><p><strong>1.3 ä¾èµ–è§£æä¸æ³¨å…¥</strong></p><ol><li><strong>æ‰«ææ³¨è§£</strong>ï¼š<br>é€šè¿‡åå°„æ£€æŸ¥ Bean çš„å­—æ®µã€æ–¹æ³•å’Œæ„é€ å‡½æ•°ä¸Šçš„ <code>@Autowired</code> æ³¨è§£ã€‚</li><li><strong>è§£æä¾èµ–</strong>ï¼š<ul><li><strong>æŒ‰ç±»å‹åŒ¹é…</strong>ï¼šæŸ¥æ‰¾ä¸ä¾èµ–ç±»å‹åŒ¹é…çš„å€™é€‰ Beanã€‚</li><li><strong>æŒ‰åç§°åŒ¹é…</strong>ï¼šè‹¥å­˜åœ¨å¤šä¸ªåŒç±»å‹ Beanï¼ŒæŒ‰å­—æ®µ&#x2F;æ–¹æ³•å‚æ•°åç§°åŒ¹é…ï¼ˆéœ€ç»“åˆ <code>@Qualifier</code> æˆ– <code>@Primary</code> è§£å†³æ­§ä¹‰ï¼‰ã€‚</li></ul></li><li><strong>æ³¨å…¥ä¾èµ–</strong>ï¼š<ul><li><strong>å­—æ®µæ³¨å…¥</strong>ï¼šé€šè¿‡åå°„ <code>Field.setAccessible(true)</code> è®¾ç½®ç§æœ‰å­—æ®µå€¼ã€‚</li><li><strong>æ–¹æ³•æ³¨å…¥</strong>ï¼šåå°„è°ƒç”¨ Setter æ–¹æ³•ã€‚</li><li><strong>æ„é€ å‡½æ•°æ³¨å…¥</strong>ï¼šåœ¨å®ä¾‹åŒ–æ—¶é€šè¿‡æ„é€ å‡½æ•°å‚æ•°æ³¨å…¥ã€‚</li></ul></li></ol><p><strong>2. å…³é”®ç»„ä»¶è§£æ</strong></p><p><strong>2.1 AutowiredAnnotationBeanPostProcessor</strong></p><p>Spring å†…ç½®çš„ <code>BeanPostProcessor</code>ï¼Œè´Ÿè´£å¤„ç† <code>@Autowired</code> å’Œ <code>@Value</code> æ³¨è§£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AutowiredAnnotationBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title class_">BeanPostProcessor</span>, MergedBeanDefinitionPostProcessor &#123;</span><br><span class="line">    <span class="comment">// å­˜å‚¨å¾…æ³¨å…¥çš„å…ƒæ•°æ®ï¼ˆå­—æ®µã€æ–¹æ³•ï¼‰</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InjectionMetadata metadata;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> PropertyValues <span class="title function_">postProcessProperties</span><span class="params">(PropertyValues pvs, Object bean, String beanName)</span> &#123;</span><br><span class="line">        <span class="comment">// æŸ¥æ‰¾å¹¶æ³¨å…¥ä¾èµ–</span></span><br><span class="line">        <span class="type">InjectionMetadata</span> <span class="variable">metadata</span> <span class="operator">=</span> findAutowiringMetadata(bean.getClass());</span><br><span class="line">        metadata.inject(bean, beanName, pvs);</span><br><span class="line">        <span class="keyword">return</span> pvs;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>2.2 ä¾èµ–è§£ææµç¨‹</strong></p><p>åœ¨ <code>DefaultListableBeanFactory</code> ä¸­è§£æä¾èµ–ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">resolveDependency</span><span class="params">(DependencyDescriptor descriptor, String beanName, Set&lt;String&gt; autowiredBeanNames, TypeConverter typeConverter)</span> &#123;</span><br><span class="line">    <span class="comment">// æŒ‰ç±»å‹è·å–å€™é€‰ Bean åç§°</span></span><br><span class="line">    String[] candidateNames = findAutowireCandidates(beanName, type, descriptor);</span><br><span class="line">    <span class="comment">// ç­›é€‰å”¯ä¸€å€™é€‰ Bean</span></span><br><span class="line">    <span class="keyword">if</span> (candidateNames.length == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> getBean(candidateNames[<span class="number">0</span>]);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (candidateNames.length &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// æŒ‰åç§°æˆ– @Primary/@Priority è§£å†³å†²çª</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">primaryCandidate</span> <span class="operator">=</span> determinePrimaryCandidate(candidateNames);</span><br><span class="line">        <span class="keyword">return</span> primaryCandidate != <span class="literal">null</span> ? primaryCandidate : determineHighestPriorityCandidate(candidateNames);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æŠ›å‡º NoUniqueBeanDefinitionException å¼‚å¸¸</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>3. æ³¨å…¥æ–¹å¼ä¸ä¼˜å…ˆçº§</strong></p><p><strong>3.1 æ„é€ å‡½æ•°æ³¨å…¥</strong></p><ul><li><p><strong>è§¦å‘æ¡ä»¶</strong>ï¼šè‹¥ç±»ä¸­å­˜åœ¨å”¯ä¸€æ„é€ å‡½æ•°ï¼Œæˆ–æ„é€ å‡½æ•°æ ‡è®°äº† <code>@Autowired</code>ã€‚</p></li><li><p><strong>ä¼˜åŠ¿</strong>ï¼šä¿è¯ä¾èµ–ä¸å¯å˜ï¼Œç¬¦åˆä¸å¯å˜å¯¹è±¡è®¾è®¡ã€‚</p></li><li><p><strong>ç¤ºä¾‹</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserRepository userRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserService</span><span class="params">(UserRepository userRepository)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userRepository = userRepository;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p><strong>3.2 Setter æ–¹æ³•æ³¨å…¥</strong></p><ul><li><p><strong>è§¦å‘æ¡ä»¶</strong>ï¼šSetter æ–¹æ³•æ ‡è®° <code>@Autowired</code>ã€‚</p></li><li><p><strong>ä¼˜åŠ¿</strong>ï¼šå…è®¸å¯é€‰ä¾èµ–æˆ–åŠ¨æ€æ›´æ–°ä¾èµ–ã€‚</p></li><li><p><strong>ç¤ºä¾‹</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> PaymentService paymentService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPaymentService</span><span class="params">(PaymentService paymentService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.paymentService = paymentService;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p><strong>3.3 å­—æ®µæ³¨å…¥</strong></p><ul><li><p><strong>è§¦å‘æ¡ä»¶</strong>ï¼šå­—æ®µç›´æ¥æ ‡è®° <code>@Autowired</code>ã€‚</p></li><li><p><strong>åŠ£åŠ¿</strong>ï¼šéš¾ä»¥å®ç°ä¸å¯å˜æ€§ï¼Œæµ‹è¯•æ—¶éœ€é€šè¿‡åå°„æ³¨å…¥ã€‚</p></li><li><p><strong>ç¤ºä¾‹</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> InventoryService inventoryService;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p><strong>4. è§£å†³ä¾èµ–å†²çª</strong></p><p><strong>4.1 @Qualifier</strong></p><p>é€šè¿‡åç§°æŒ‡å®šæ³¨å…¥çš„ Beanï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="meta">@Qualifier(&quot;mysqlDataSource&quot;)</span></span><br><span class="line"><span class="keyword">private</span> DataSource dataSource;</span><br></pre></td></tr></table></figure><p><strong>4.2 @Primary</strong></p><p>æ ‡è®°ä¼˜å…ˆé€‰æ‹©çš„ Beanï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@Primary</span></span><br><span class="line"><span class="keyword">public</span> DataSource <span class="title function_">primaryDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HikariDataSource</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>5. æ€»ç»“ä¸æœ€ä½³å®è·µ</strong></p><ul><li><strong>åŸç†æœ¬è´¨</strong>ï¼š<code>@Autowired</code> é€šè¿‡ <code>BeanPostProcessor</code> åœ¨ Bean ç”Ÿå‘½å‘¨æœŸä¸­åŠ¨æ€è§£æå¹¶æ³¨å…¥ä¾èµ–ã€‚</li><li><strong>æ¨èæ–¹å¼</strong>ï¼šä¼˜å…ˆä½¿ç”¨ <strong>æ„é€ å‡½æ•°æ³¨å…¥</strong> ä¿è¯ä¾èµ–ä¸å¯å˜ã€‚</li><li><strong>é¿å…é™·é˜±</strong>ï¼š<ul><li><strong>å¾ªç¯ä¾èµ–</strong>ï¼šé¿å… A ä¾èµ– Bï¼ŒB åˆä¾èµ– Aï¼Œå¯é€šè¿‡ <code>@Lazy</code> å»¶è¿ŸåŠ è½½è§£å†³ã€‚</li><li><strong>å¤šå®ä¾‹å†²çª</strong>ï¼šä½¿ç”¨ <code>@Qualifier</code> æˆ– <code>@Primary</code> æ˜ç¡®æŒ‡å®š Beanã€‚</li></ul></li><li><strong>æ€§èƒ½ä¼˜åŒ–</strong>ï¼šåå°„æ“ä½œæœ‰ä¸€å®šå¼€é”€ï¼Œä½† Spring é€šè¿‡ç¼“å­˜å…ƒæ•°æ®ï¼ˆå¦‚ <code>InjectionMetadata</code>ï¼‰å‡å°‘é‡å¤è§£æã€‚</li></ul><h2 id="SpringMVC-å·¥ä½œæµç¨‹"><a href="#SpringMVC-å·¥ä½œæµç¨‹" class="headerlink" title="SpringMVC å·¥ä½œæµç¨‹"></a>SpringMVC å·¥ä½œæµç¨‹</h2><p><strong>æ ¸å¿ƒç»„ä»¶</strong></p><ol><li><strong>DispatcherServlet</strong>ï¼šå‰ç½®æ§åˆ¶å™¨ï¼Œæ˜¯æ•´ä¸ªæµç¨‹æ§åˆ¶çš„<strong>æ ¸å¿ƒ</strong>ï¼Œæ§åˆ¶å…¶ä»–ç»„ä»¶çš„æ‰§è¡Œï¼Œè¿›è¡Œç»Ÿä¸€è°ƒåº¦ï¼Œé™ä½ç»„ä»¶ä¹‹é—´çš„è€¦åˆæ€§ï¼Œç›¸å½“äºæ€»æŒ‡æŒ¥ã€‚</li><li><strong>Handler</strong>ï¼šå¤„ç†å™¨ï¼Œå®Œæˆå…·ä½“çš„ä¸šåŠ¡é€»è¾‘ï¼Œç›¸å½“äº Servlet æˆ– Actionã€‚</li><li><strong>HandlerMapping</strong>ï¼šDispatcherServlet æ¥æ”¶åˆ°è¯·æ±‚ä¹‹åï¼Œé€šè¿‡ HandlerMapping å°†ä¸åŒçš„è¯·æ±‚æ˜ å°„åˆ°ä¸åŒçš„ Handlerã€‚</li><li><strong>HandlerInterceptor</strong>ï¼šå¤„ç†å™¨æ‹¦æˆªå™¨ï¼Œæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå¦‚æœéœ€è¦å®Œæˆä¸€äº›æ‹¦æˆªå¤„ç†ï¼Œå¯ä»¥å®ç°è¯¥æ¥å£ã€‚</li><li><strong>HandlerExecutionChain</strong>ï¼šå¤„ç†å™¨æ‰§è¡Œé“¾ï¼ŒåŒ…æ‹¬ä¸¤éƒ¨åˆ†å†…å®¹ï¼šHandler å’Œ HandlerInterceptorï¼ˆç³»ç»Ÿä¼šæœ‰ä¸€ä¸ªé»˜è®¤çš„ HandlerInterceptorï¼Œå¦‚æœéœ€è¦é¢å¤–è®¾ç½®æ‹¦æˆªï¼Œå¯ä»¥æ·»åŠ æ‹¦æˆªå™¨ï¼‰ã€‚</li><li><strong>HandlerAdapter</strong>ï¼šå¤„ç†å™¨é€‚é…å™¨ï¼ŒHandler æ‰§è¡Œä¸šåŠ¡æ–¹æ³•ä¹‹å‰ï¼Œéœ€è¦è¿›è¡Œä¸€ç³»åˆ—çš„æ“ä½œï¼ŒåŒ…æ‹¬è¡¨å•æ•°æ®çš„éªŒè¯ã€æ•°æ®ç±»å‹çš„è½¬æ¢ã€å°†è¡¨å•æ•°æ®å°è£…åˆ° JavaBean ç­‰ï¼Œè¿™äº›æ“ä½œéƒ½æ˜¯ç”± HandlerApater æ¥å®Œæˆï¼Œå¼€å‘è€…åªéœ€å°†æ³¨æ„åŠ›é›†ä¸­ä¸šåŠ¡é€»è¾‘çš„å¤„ç†ä¸Šï¼ŒDispatcherServlet é€šè¿‡ HandlerAdapter æ‰§è¡Œä¸åŒçš„ Handlerã€‚</li><li><strong>ModelAndView</strong>ï¼šè£…è½½äº†æ¨¡å‹æ•°æ®å’Œè§†å›¾ä¿¡æ¯ï¼Œä½œä¸º Handler çš„å¤„ç†ç»“æœï¼Œè¿”å›ç»™ DispatcherServletã€‚</li><li><strong>ViewResolver</strong>ï¼šè§†å›¾è§£æå™¨ï¼ŒDispatcheServlet é€šè¿‡å®ƒå°†é€»è¾‘è§†å›¾è§£æä¸ºç‰©ç†è§†å›¾ï¼Œæœ€ç»ˆå°†æ¸²æŸ“ç»“æœå“åº”ç»™å®¢æˆ·ç«¯ã€‚</li></ol><p><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/spring-e29a122b-db07-48b8-8289-7251032e87a1.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šSpring MVCçš„å·¥ä½œæµç¨‹"></p><h2 id="AOP-å“ªäº›æƒ…å†µä¸‹ä¼šå¤±æ•ˆ"><a href="#AOP-å“ªäº›æƒ…å†µä¸‹ä¼šå¤±æ•ˆ" class="headerlink" title="AOP å“ªäº›æƒ…å†µä¸‹ä¼šå¤±æ•ˆ"></a>AOP å“ªäº›æƒ…å†µä¸‹ä¼šå¤±æ•ˆ</h2><p><strong>AOP ç”Ÿæ•ˆçš„å…³é”®æ¡ä»¶</strong></p><table><thead><tr><th align="left">æ¡ä»¶</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">ç›®æ ‡å¯¹è±¡æ˜¯ Spring Bean</td><td align="left">éœ€é€šè¿‡å®¹å™¨è·å–å®ä¾‹</td></tr><tr><td align="left">æ–¹æ³•éœ€ä¸º public</td><td align="left">é public æ–¹æ³•æ— æ³•è¢«ä»£ç†</td></tr><tr><td align="left">é¿å…ç±»å†…éƒ¨è‡ªè°ƒç”¨</td><td align="left">å¿…é¡»é€šè¿‡ä»£ç†å¯¹è±¡è°ƒç”¨æ–¹æ³•</td></tr><tr><td align="left">é final ç±»&#x2F;æ–¹æ³•</td><td align="left">CGLIB è¦æ±‚æ–¹æ³•å¯è¢«é‡å†™</td></tr><tr><td align="left">æ­£ç¡®é…ç½®åˆ‡ç‚¹</td><td align="left">è¡¨è¾¾å¼éœ€åŒ¹é…åˆ°ç›®æ ‡æ–¹</td></tr></tbody></table><h2 id="spring-beanæ˜¯çº¿ç¨‹å®‰å…¨çš„å—"><a href="#spring-beanæ˜¯çº¿ç¨‹å®‰å…¨çš„å—" class="headerlink" title="spring beanæ˜¯çº¿ç¨‹å®‰å…¨çš„å—"></a>spring beanæ˜¯çº¿ç¨‹å®‰å…¨çš„å—</h2><p>Spring Bean çš„çº¿ç¨‹å®‰å…¨æ€§<strong>ä¸æ˜¯ç”± Spring æ¡†æ¶æœ¬èº«ä¿è¯çš„</strong>ï¼Œè€Œæ˜¯<strong>å–å†³äº Bean çš„ä½œç”¨åŸŸï¼ˆScopeï¼‰å’Œä½ å¦‚ä½•ç¼–å†™è¯¥ Bean çš„ä»£ç </strong>ã€‚</p><p><strong>ä½œç”¨åŸŸï¼š</strong></p><ul><li><strong>å•ä¾‹ï¼ˆSingletonï¼‰ - é»˜è®¤ä½œç”¨åŸŸï¼š</strong> è¿™æ˜¯æœ€å¸¸ç”¨çš„ä½œç”¨åŸŸã€‚Spring IoC å®¹å™¨åœ¨æ•´ä¸ªåº”ç”¨ä¸­åªåˆ›å»ºè¯¥ Bean çš„ä¸€ä¸ªå®ä¾‹ã€‚<strong>è¿™ä¸ªå•ä¾‹å®ä¾‹ä¼šè¢«æ‰€æœ‰è¯·æ±‚å®ƒçš„çº¿ç¨‹å…±äº«ã€‚</strong><ul><li><strong>çº¿ç¨‹å®‰å…¨é£é™©ï¼š</strong> å¦‚æœè¿™ä¸ªå•ä¾‹ Bean æ˜¯<strong>æœ‰çŠ¶æ€çš„ï¼ˆStatefulï¼‰</strong>ï¼Œå³å®ƒåŒ…å«å¯å˜çš„æˆå‘˜å˜é‡ï¼ˆå­—æ®µï¼‰ï¼Œé‚£ä¹ˆå¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®å’Œä¿®æ”¹è¿™äº›çŠ¶æ€æ—¶ï¼Œ<strong>å°±ææœ‰å¯èƒ½å‘ç”Ÿç«æ€æ¡ä»¶ï¼ˆRace Conditionï¼‰å’Œæ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œå¯¼è‡´çº¿ç¨‹ä¸å®‰å…¨ã€‚</strong></li><li><strong>çº¿ç¨‹å®‰å…¨æ¡ä»¶ï¼š</strong> å¦‚æœè¿™ä¸ªå•ä¾‹ Bean æ˜¯<strong>æ— çŠ¶æ€çš„ï¼ˆStatelessï¼‰</strong>ï¼Œå³å®ƒ<strong>ä¸åŒ…å«ä»»ä½•å¯å˜çš„æˆå‘˜å˜é‡</strong>ï¼Œæˆ–è€…å®ƒåªåŒ…å« <code>final</code> æˆ–ä¸å¯å˜å¯¹è±¡ï¼ˆå¦‚ <code>String</code>ã€<code>Integer</code> ç­‰ï¼‰ä½œä¸ºæˆå‘˜å˜é‡ï¼Œå¹¶ä¸”å…¶æ‰€æœ‰æ–¹æ³•éƒ½æ˜¯åŸºäºä¼ å…¥å‚æ•°è¿›è¡Œè®¡ç®—è€Œä¸ä¾èµ–æˆ–ä¿®æ”¹å†…éƒ¨çŠ¶æ€ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯<strong>çº¿ç¨‹å®‰å…¨çš„</strong>ã€‚è¿™æ˜¯ç¼–å†™çº¿ç¨‹å®‰å…¨å•ä¾‹ Bean çš„æœ€ä½³å®è·µã€‚</li></ul></li><li><strong>åŸå‹ï¼ˆPrototypeï¼‰ï¼š</strong> æ¯æ¬¡è¯·æ±‚è¯¥ Bean æ—¶ï¼ŒSpring å®¹å™¨éƒ½ä¼šåˆ›å»ºä¸€ä¸ªå…¨æ–°çš„å®ä¾‹ã€‚å› æ­¤ï¼Œæ¯ä¸ªçº¿ç¨‹é€šå¸¸æ“ä½œçš„æ˜¯è‡ªå·±çš„ Bean å®ä¾‹ã€‚<ul><li><strong>çº¿ç¨‹å®‰å…¨ï¼š</strong> <strong>é€šå¸¸è¢«è®¤ä¸ºæ˜¯çº¿ç¨‹å®‰å…¨çš„</strong>ï¼Œå› ä¸ºçŠ¶æ€ä¸å…±äº«ã€‚ä½†æ˜¯ï¼Œå¦‚æœæŸä¸ªçº¿ç¨‹å°†å®ƒçš„åŸå‹ Bean å®ä¾‹å¼•ç”¨ä¼ é€’ç»™å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶ä¸”è¿™ä¸ª Bean æ˜¯æœ‰çŠ¶æ€çš„ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªçº¿ç¨‹æ“ä½œåŒä¸€ä¸ªå®ä¾‹æ—¶ï¼ŒåŒæ ·ä¼šå¯¼è‡´çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚</li></ul></li><li><strong>è¯·æ±‚ï¼ˆRequestï¼‰ã€ä¼šè¯ï¼ˆSessionï¼‰ã€åº”ç”¨ï¼ˆApplicationï¼‰ã€WebSocketï¼ˆWebSocketï¼‰ï¼š</strong> è¿™äº›ä½œç”¨åŸŸä¸»è¦ç”¨äº Web åº”ç”¨ã€‚<code>Request</code> ä½œç”¨åŸŸä¸ºæ¯ä¸ª HTTP è¯·æ±‚åˆ›å»ºä¸€ä¸ªæ–°å®ä¾‹ï¼Œ<code>Session</code> ä½œç”¨åŸŸä¸ºæ¯ä¸ªç”¨æˆ·ä¼šè¯åˆ›å»ºä¸€ä¸ªå®ä¾‹ï¼Œç­‰ç­‰ã€‚åœ¨è¿™äº›ä½œç”¨åŸŸå†…ï¼Œå•ä¸ªå®ä¾‹é€šå¸¸åªè¢«ä¸€ä¸ªçº¿ç¨‹ï¼ˆå¤„ç†è¯¥è¯·æ±‚&#x2F;ä¼šè¯çš„çº¿ç¨‹ï¼‰è®¿é—®ï¼Œå› æ­¤<strong>åœ¨è¯¥ä½œç”¨åŸŸå®šä¹‰çš„è¾¹ç•Œå†…é€šå¸¸æ˜¯çº¿ç¨‹å®‰å…¨çš„</strong>ã€‚ä½†è·¨è¯·æ±‚&#x2F;ä¼šè¯å…±äº«è¿™äº› Bean çš„å¼•ç”¨ä¼šå¯¼è‡´é—®é¢˜ã€‚</li></ul><p><strong>ä»£ç è®¾è®¡ï¼š</strong></p><ul><li><strong>æ— çŠ¶æ€è®¾è®¡ï¼š</strong> è¿™æ˜¯å®ç°çº¿ç¨‹å®‰å…¨æœ€æ¨èçš„æ–¹å¼ã€‚ç¡®ä¿ä½ çš„ Beanï¼ˆå°¤å…¶æ˜¯å•ä¾‹ Beanï¼‰<strong>ä¸åŒ…å«ä»»ä½•å¯å˜çš„æˆå‘˜å˜é‡</strong>ã€‚æ‰€æœ‰æ“ä½œæ‰€éœ€çš„æ•°æ®éƒ½é€šè¿‡æ–¹æ³•å‚æ•°ä¼ å…¥ã€‚</li><li><strong>ä½¿ç”¨å±€éƒ¨å˜é‡ï¼š</strong> åœ¨æ–¹æ³•å†…éƒ¨ä½¿ç”¨å±€éƒ¨å˜é‡æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå› ä¸ºæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„æ–¹æ³•è°ƒç”¨æ ˆã€‚</li><li><strong>ä½¿ç”¨åŒæ­¥ï¼ˆSynchronizationï¼‰ï¼š</strong> å¦‚æœ Bean å¿…é¡»æœ‰çŠ¶æ€ï¼Œä½ éœ€è¦ä½¿ç”¨åŒæ­¥æœºåˆ¶ï¼ˆå¦‚ <code>synchronized</code> å…³é”®å­—ã€<code>ReentrantLock</code>ã€<code>Atomic</code> ç±»ç­‰ï¼‰æ¥ä¿æŠ¤å¯¹å…±äº«å¯å˜çŠ¶æ€çš„è®¿é—®ã€‚ä½†è¿™ä¼šå¢åŠ å¤æ‚æ€§å’Œå¯èƒ½é™ä½æ€§èƒ½ã€‚</li><li><strong>ä½¿ç”¨å¹¶å‘é›†åˆï¼š</strong> å¦‚æœéœ€è¦å…±äº«é›†åˆï¼Œä¼˜å…ˆä½¿ç”¨ <code>java.util.concurrent</code> åŒ…ä¸‹çš„çº¿ç¨‹å®‰å…¨é›†åˆç±»ï¼ˆå¦‚ <code>ConcurrentHashMap</code>, <code>CopyOnWriteArrayList</code> ç­‰ï¼‰ã€‚</li><li><strong>ä½¿ç”¨ ThreadLocalï¼š</strong> å¯¹äºéœ€è¦ä¸ºæ¯ä¸ªçº¿ç¨‹ä¿å­˜ç‹¬ç«‹çŠ¶æ€çš„æƒ…å†µï¼ˆä¾‹å¦‚ï¼Œç”¨æˆ·èº«ä»½éªŒè¯ä¿¡æ¯ï¼‰ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ <code>ThreadLocal</code>ã€‚ä½†éœ€è¦éå¸¸å°å¿ƒåœ°ç®¡ç†å…¶ç”Ÿå‘½å‘¨æœŸï¼Œé¿å…å†…å­˜æ³„æ¼ï¼ˆå°¤å…¶æ˜¯åœ¨ä½¿ç”¨çº¿ç¨‹æ± æ—¶ï¼‰ã€‚</li></ul><p><strong>ç¤ºä¾‹ï¼ˆå±é™©çš„å•ä¾‹ï¼‰ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span> <span class="comment">// é»˜è®¤æ˜¯ Singleton</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UnsafeCounterService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>; <span class="comment">// å¯å˜çŠ¶æ€ï¼å±é™©ï¼</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">increment</span><span class="params">()</span> &#123;</span><br><span class="line">        count++; <span class="comment">// éåŸå­æ“ä½œï¼Œå¤šçº¿ç¨‹ä¸‹ä¼šå‡ºé”™</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getCount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç¤ºä¾‹ï¼ˆå®‰å…¨çš„å•ä¾‹ - æ— çŠ¶æ€ï¼‰ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SafeCalculatorService</span> &#123;</span><br><span class="line">    <span class="comment">// æ²¡æœ‰æˆå‘˜å˜é‡ -&gt; æ— çŠ¶æ€</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> a + b; <span class="comment">// åªæ“ä½œå‚æ•°å’Œå±€éƒ¨å˜é‡ï¼Œçº¿ç¨‹å®‰å…¨</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç¤ºä¾‹ï¼ˆå®‰å…¨çš„å•ä¾‹ - ä½¿ç”¨ Atomic ç±»ï¼‰ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SafeCounterService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">count</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>); <span class="comment">// ä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„åŸå­ç±»</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">increment</span><span class="params">()</span> &#123;</span><br><span class="line">        count.incrementAndGet(); <span class="comment">// åŸå­æ“ä½œï¼Œçº¿ç¨‹å®‰å…¨</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getCount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> count.get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      <categories>
          
          <category> é¢è¯• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MyBatis </tag>
            
            <tag> Spring </tag>
            
            <tag> SpringBoot </tag>
            
            <tag> JPA </tag>
            
            <tag> æ—¥å¿—æ¡†æ¶ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ¶ˆæ¯é˜Ÿåˆ—ä¹‹Kafka</title>
      <link href="/post/688e2513.html"/>
      <url>/post/688e2513.html</url>
      
        <content type="html"><![CDATA[<h1 id="Kafka"><a href="#Kafka" class="headerlink" title="Kafka"></a>Kafka</h1><ul><li><strong>Kafka&#x2F;RocketMQ&#x2F;RabbitMQ:</strong> æ·±å…¥ç†è§£å…¶æ ¸å¿ƒæ¦‚å¿µï¼ˆTopic&#x2F;Queue, Producer, Consumer, Broker, Partition&#x2F;Shardingï¼‰ã€æ¶ˆæ¯å­˜å‚¨æœºåˆ¶ï¼ˆKafka çš„ Log Segment, RocketMQ çš„ Commit Logï¼‰ã€é«˜å¯ç”¨ä¸å¯é æ€§ä¿è¯ï¼ˆå‰¯æœ¬æœºåˆ¶ã€ACK æœºåˆ¶ã€äº‹åŠ¡æ¶ˆæ¯ï¼‰ã€é¡ºåºæ¶ˆæ¯ã€å»¶è¿Ÿæ¶ˆæ¯ã€æ¶ˆæ¯ç§¯å‹å¤„ç†ç­–ç•¥ã€‚ç†è§£é€‰å‹è€ƒé‡ã€‚</li></ul><h2 id="åŸºæœ¬æ¦‚å¿µ"><a href="#åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h2><ul><li><strong>Topic</strong> æ˜¯æ¶ˆæ¯å‘å¸ƒçš„ç±»åˆ«æˆ–ä¸»é¢˜ã€‚</li><li><strong>Partition</strong>ï¼šä¸€ä¸ª <strong>Topic</strong> è¢«åˆ’åˆ†ä¸ºä¸€ä¸ªæˆ–å¤šä¸ª <strong>Partition</strong>ï¼Œåˆ†å¸ƒåœ¨ä¸åŒçš„ Broker ä¸Šã€‚</li><li><strong>Replica</strong>ï¼šæ¯ä¸ª <strong>Partition</strong> å¯ä»¥æœ‰å¤šä¸ª <strong>Replica</strong> (å‰¯æœ¬)ã€‚å…¶ä¸­ä¸€ä¸ª Replica æ˜¯ <strong>Leader</strong>ï¼Œè´Ÿè´£è¯»å†™ï¼›å…¶ä»–æ˜¯ <strong>Follower</strong>ï¼Œåªè´Ÿè´£ä» Leader åŒæ­¥æ•°æ®ã€‚Replica ä¹Ÿåˆ†å¸ƒåœ¨ä¸åŒçš„ Broker ä¸Šï¼Œæä¾›å®¹é”™èƒ½åŠ›ã€‚</li><li><strong>Consumer Group (CG):</strong> ä¸€ç»„ Consumer å®ä¾‹çš„é›†åˆï¼Œå®ƒä»¬å…±åŒæ¶ˆè´¹ä¸€ä¸ªæˆ–å¤šä¸ª Topicã€‚ç»„å†…æ¶ˆè´¹å®ä¾‹<strong>åä½œæ¶ˆè´¹</strong>è®¢é˜… Topic çš„æ‰€æœ‰ Partitionã€‚ä¸€ä¸ª Partition åªèƒ½è¢«ç»„å†…<strong>ä¸€ä¸ª</strong> Consumer å®ä¾‹æ¶ˆè´¹ï¼Œå®ç°è´Ÿè½½å‡è¡¡ã€‚</li><li><strong>Rebalance (é‡å¹³è¡¡):</strong> å½“ä»¥ä¸‹æƒ…å†µå‘ç”Ÿæ—¶ï¼ŒKafka ä¼šé‡æ–°åˆ†é… CG å†… Consumer è´Ÿè´£çš„ Partitionï¼š<ul><li>ç»„å†… Consumer æ•°é‡å˜åŒ– (æ–° Consumer åŠ å…¥ã€Consumer å´©æºƒæˆ–ä¸»åŠ¨ç¦»å¼€)ã€‚</li><li>è®¢é˜…çš„ Topic Partition æ•°é‡å˜åŒ– (å¦‚ Topic è¢«ä¿®æ”¹å¢åŠ äº† Partition)ã€‚</li><li>è®¢é˜…çš„ Topic æœ¬èº«å˜åŒ–ã€‚</li><li><strong>å½±å“:</strong> Rebalance æœŸé—´ï¼Œæ•´ä¸ª CG ä¼š<strong>çŸ­æš‚åœæ­¢æ¶ˆè´¹</strong>ï¼Œç›´åˆ°åˆ†é…å®Œæˆã€‚é¢‘ç¹æˆ–é•¿æ—¶é—´çš„ Rebalance ä¼šå½±å“æ¶ˆè´¹è¿›åº¦å’Œç³»ç»Ÿç¨³å®šæ€§ã€‚</li></ul></li></ul><ol><li>æ¶ˆæ¯å †ç§¯å¤„ç†ç­–ç•¥</li><li>RocketMQäº‹åŠ¡æ¶ˆæ¯æµç¨‹</li><li>Brokeré€‰ä¸¾æœºåˆ¶å¯¹æ¯”ï¼ˆKafka vs RocketMQï¼‰</li></ol><h2 id="Kafka-å¦‚ä½•å®ç°é«˜ååé‡"><a href="#Kafka-å¦‚ä½•å®ç°é«˜ååé‡" class="headerlink" title="Kafka å¦‚ä½•å®ç°é«˜ååé‡"></a>Kafka å¦‚ä½•å®ç°é«˜ååé‡</h2><ul><li><strong>é¡ºåºè¯»å†™ç£ç›˜:</strong> æ¶ˆæ¯æŒ‰é¡ºåºè¿½åŠ åˆ° Partition æ–‡ä»¶æœ«å°¾ï¼Œå……åˆ†åˆ©ç”¨ç£ç›˜é¡ºåº I&#x2F;O çš„é«˜æ€§èƒ½ï¼ˆè¿œé«˜äºéšæœº I&#x2F;Oï¼‰ã€‚</li><li><strong>Page Cache:</strong> åˆ©ç”¨æ“ä½œç³»ç»Ÿ Page Cache ç¼“å­˜æ•°æ®ï¼Œå‡å°‘ç›´æ¥ç£ç›˜è®¿é—®ã€‚</li><li><strong>é›¶æ‹·è´ (Zero-Copy):</strong> ä½¿ç”¨ <code>sendfile</code> å’Œ <code>mmap</code> ç­‰æŠ€æœ¯ï¼Œå‡å°‘æ•°æ®åœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´ä¹‹é—´çš„æ‹·è´æ¬¡æ•°ï¼Œé™ä½ CPU å¼€é”€å’Œä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚</li><li><strong>æ‰¹é‡å¤„ç† (Batching):</strong> Producer æ‰¹é‡å‘é€æ¶ˆæ¯ï¼ŒBroker æ‰¹é‡å†™å…¥ç£ç›˜å’Œæ‰¹é‡å‘é€ç»™ Consumerï¼Œå‡å°‘ç½‘ç»œå’Œ I&#x2F;O å¼€é”€ã€‚</li><li><strong>æ¶ˆæ¯å‹ç¼©:</strong> Producer ç«¯å¯é…ç½®å‹ç¼©ç®—æ³• (Snappy, LZ4, Gzip, Zstd)ï¼Œå‡å°‘ç½‘ç»œä¼ è¾“å’Œç£ç›˜å­˜å‚¨å¼€é”€ã€‚</li><li><strong>Partition å¹¶è¡Œ:</strong> Topic è¢«åˆ†æˆå¤šä¸ª Partitionï¼Œåˆ†å¸ƒåœ¨å¤šä¸ª Broker ä¸Šï¼Œè¯»å†™æ“ä½œå¯ä»¥å¹¶è¡Œå‘ç”Ÿåœ¨ä¸åŒ Partitionï¼Œå……åˆ†åˆ©ç”¨å¤š Brokerã€å¤šç£ç›˜ã€å¤šæ ¸ CPUã€‚</li></ul><h2 id="Producer-çš„-acks-ä¸åŒå–å€¼çš„å«ä¹‰"><a href="#Producer-çš„-acks-ä¸åŒå–å€¼çš„å«ä¹‰" class="headerlink" title="Producer çš„ acks ä¸åŒå–å€¼çš„å«ä¹‰"></a>Producer çš„ <code>acks</code> ä¸åŒå–å€¼çš„å«ä¹‰</h2><ul><li><code>acks=0</code>: Producer å‘é€æ¶ˆæ¯å<strong>ä¸ç­‰å¾…</strong> Broker çš„ä»»ä½•ç¡®è®¤ã€‚<strong>æœ€é«˜ååï¼Œæœ€ä½å»¶è¿Ÿï¼Œæœ€ä½å¯é æ€§</strong> (å¯èƒ½ä¸¢å¤±æ•°æ®)ã€‚</li><li><code>acks=1</code>: Producer å‘é€æ¶ˆæ¯åï¼Œç­‰å¾… <strong>Leader å‰¯æœ¬æˆåŠŸå†™å…¥æœ¬åœ°æ—¥å¿—</strong> çš„ç¡®è®¤ã€‚<strong>æŠ˜ä¸­æ–¹æ¡ˆ</strong>ã€‚Leader æ•…éšœä½†æ•°æ®æœªåŒæ­¥åˆ° Follower æ—¶å¯èƒ½ä¸¢å¤±æ•°æ®ã€‚</li><li><code>acks=all</code> <strong>(æˆ–</strong> <code>acks=-1</code><strong>)</strong>: Producer å‘é€æ¶ˆæ¯åï¼Œç­‰å¾… <strong>Leader æ”¶åˆ°æ¶ˆæ¯å¹¶ç¡®è®¤è¯¥æ¶ˆæ¯å·²è¢«å½“å‰ ISR é›†åˆä¸­çš„æ‰€æœ‰å‰¯æœ¬æˆåŠŸå†™å…¥æœ¬åœ°æ—¥å¿—</strong>ã€‚<strong>æœ€é«˜å¯é æ€§</strong>ï¼Œæœ€ä½ä¸¢å¤±é£é™©ï¼Œä½†å»¶è¿Ÿæœ€é«˜ï¼Œååå¯èƒ½æœ€ä½ã€‚éœ€è¦é…åˆ <code>min.insync.replicas</code> å‚æ•°ä½¿ç”¨ã€‚</li></ul><h2 id="å¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±"><a href="#å¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±" class="headerlink" title="å¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±"></a>å¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±</h2><p>æ¶ˆæ¯ä¸¢å¤±å¯èƒ½å‘ç”Ÿåœ¨ç”Ÿäº§è€…ã€Broker æˆ–æ¶ˆè´¹è€…ç¯èŠ‚ï¼š</p><ol><li><strong>ç”Ÿäº§è€…å‘é€æ¶ˆæ¯æ—¶ä¸¢å¤±ï¼š</strong><ul><li><strong>åŸå› ï¼š</strong><ul><li><strong>å¼‚æ­¥å‘é€ + ä¸å¤„ç†å›è°ƒï¼š</strong> ç”Ÿäº§è€…ä½¿ç”¨å¼‚æ­¥å‘é€ï¼ˆ<code>send()</code> è¿”å› Futureï¼‰ä½†æœªæ­£ç¡®å¤„ç†å›è°ƒï¼ˆ<code>Future.get()</code> æˆ– <code>Callback</code>ï¼‰ï¼Œç½‘ç»œæŠ–åŠ¨æˆ– Broker æš‚æ—¶ä¸å¯ç”¨å¯¼è‡´å‘é€å¤±è´¥ï¼Œä½†ç”Ÿäº§è€…ä¸çŸ¥æƒ…ã€‚</li><li><strong><code>acks</code> é…ç½®è¿‡ä½ï¼š</strong> <code>acks=0</code>ï¼ˆç”Ÿäº§è€…ä¸ç­‰å¾…ä»»ä½•ç¡®è®¤ï¼‰æˆ– <code>acks=1</code>ï¼ˆåªç­‰å¾… Leader å†™å…¥æœ¬åœ°æ—¥å¿—ï¼‰æ—¶ï¼Œå¦‚æœ Leader åˆšå†™å…¥å°±æŒ‚æ‰ä¸”æ•°æ®æœªåŒæ­¥åˆ° Followerï¼Œæ–° Leader å¯èƒ½æ²¡æœ‰è¿™æ¡æ¶ˆæ¯ã€‚</li></ul></li><li><strong>è§£å†³æ–¹æ¡ˆï¼š</strong><ul><li><strong>ä½¿ç”¨åŒæ­¥å‘é€æˆ–æ­£ç¡®å¤„ç†å¼‚æ­¥å›è°ƒï¼š</strong> è°ƒç”¨ <code>future.get()</code> é˜»å¡ç­‰å¾…ç»“æœï¼Œæˆ–åœ¨ <code>Callback</code> ä¸­æ£€æŸ¥å¼‚å¸¸å¹¶å®ç°é‡è¯•é€»è¾‘ï¼ˆæ³¨æ„å¹‚ç­‰æ€§ï¼‰ã€‚</li><li><strong>è®¾ç½® <code>acks=all</code>ï¼š</strong> è¦æ±‚ Leader æ”¶åˆ°æ¶ˆæ¯åï¼Œå¿…é¡»ç­‰å¾…æ‰€æœ‰ <strong>ISR (In-Sync Replica)</strong> åˆ—è¡¨ä¸­çš„ Follower éƒ½æˆåŠŸå¤åˆ¶äº†æ¶ˆæ¯åæ‰å‘ç”Ÿäº§è€…å‘é€ç¡®è®¤ã€‚è¿™æ˜¯é˜²æ­¢ç”Ÿäº§è€…ç«¯ä¸¢å¤±çš„æœ€å¼ºä¿è¯ã€‚</li><li><strong>é…ç½®åˆç†çš„ <code>retries</code> å’Œ <code>retry.backoff.ms</code>ï¼š</strong> å¯¹äºå¯é‡è¯•çš„å¼‚å¸¸ï¼ˆå¦‚ç½‘ç»œé—®é¢˜ã€<code>NOT_ENOUGH_REPLICAS</code>ï¼‰ï¼Œç”Ÿäº§è€…åº”è‡ªåŠ¨é‡è¯•ã€‚å¢å¤§é‡è¯•æ¬¡æ•°å’Œé‡è¯•é—´éš”ã€‚</li><li><strong>å¯ç”¨ç”Ÿäº§è€…å¹‚ç­‰æ€§ï¼š</strong> è®¾ç½® <code>enable.idempotence=true</code>ã€‚è¿™ä¼šè‡ªåŠ¨è®¾ç½® <code>acks=all</code>ï¼Œå¹¶å¼•å…¥ç”Ÿäº§è€… ID å’Œåºåˆ—å·ï¼Œé˜²æ­¢åœ¨é‡è¯•æ—¶å› ç½‘ç»œé—®é¢˜å¯¼è‡´ Broker æ”¶åˆ°é‡å¤æ¶ˆæ¯ï¼ˆè§£å†³äº†é‡è¯•å¯èƒ½å¯¼è‡´é‡å¤çš„é—®é¢˜ï¼Œä½†ä¸»è¦ç›®æ ‡æ˜¯ä¿è¯ç²¾ç¡®ä¸€æ¬¡ç”Ÿäº§è¯­ä¹‰çš„åŸºç¡€ï¼‰ã€‚</li></ul></li></ul></li><li><strong>Broker å­˜å‚¨æ¶ˆæ¯æ—¶ä¸¢å¤±ï¼š</strong><ul><li><strong>åŸå› ï¼š</strong><ul><li><strong>å‰¯æœ¬æ•°é‡ä¸è¶³ä¸” Leader æŒ‚æ‰ï¼š</strong> å‡è®¾ <code>replication.factor=1</code>ï¼ˆåªæœ‰ Leader å‰¯æœ¬ï¼‰ï¼Œå¦‚æœè¯¥ Broker ç£ç›˜æŸåæˆ–æ°¸ä¹…å®•æœºï¼Œæ¶ˆæ¯æ°¸ä¹…ä¸¢å¤±ã€‚å³ä½¿ <code>replication.factor&gt;1</code>ï¼Œä½†å¦‚æœ <code>min.insync.replicas=1</code> ä¸” <code>acks=all</code>ï¼Œåªè¦æœ‰ä¸€ä¸ªå‰¯æœ¬ï¼ˆLeaderï¼‰å†™å…¥æˆåŠŸå°±ç®—æˆåŠŸï¼Œå¦‚æœè¯¥ Leader ç«‹åˆ»æŒ‚æ‰ä¸”æ•°æ®æœªåŒæ­¥åˆ°å…¶ä»–å‰¯æœ¬ï¼Œæ¶ˆæ¯ä¹Ÿä¼šä¸¢å¤±ã€‚</li><li><strong>ä¸å¹²å‡€çš„ Leader é€‰ä¸¾ï¼š</strong> å½“æ‰€æœ‰ ISR å‰¯æœ¬éƒ½ä¸å¯ç”¨æ—¶ï¼ˆä¾‹å¦‚å…¨æŒ‚äº†ï¼‰ï¼Œå¦‚æœ <code>unclean.leader.election.enable=true</code>ï¼ŒKafka ä¼šä»é ISRï¼ˆå¯èƒ½è½åå¾ˆå¤šï¼‰çš„å‰¯æœ¬ä¸­é€‰ä¸¾æ–° Leaderã€‚è¿™ä¸ªæ–° Leader ä¼šä¸¢å¤±æ‰å®ƒæœªå¤åˆ¶åˆ°çš„æ‰€æœ‰æ¶ˆæ¯ã€‚</li></ul></li><li><strong>è§£å†³æ–¹æ¡ˆï¼š</strong><ul><li><strong>è®¾ç½®è¶³å¤Ÿçš„ <code>replication.factor</code>ï¼š</strong> è‡³å°‘è®¾ç½®ä¸º 3ã€‚è¿™æ˜¯ç”Ÿäº§ç¯å¢ƒçš„æ ‡å‡†é…ç½®ï¼Œç¡®ä¿å³ä½¿ä¸€ä¸ª Broker æ°¸ä¹…æ•…éšœï¼Œæ•°æ®ä¹Ÿä¸ä¸¢å¤±ã€‚</li><li><strong>è®¾ç½® <code>min.insync.replicas</code>ï¼š</strong> é€šå¸¸è®¾ç½®ä¸º <code>replication.factor - 1</code>ï¼ˆä¾‹å¦‚ RF&#x3D;3 æ—¶ min.isr&#x3D;2ï¼‰ã€‚è¿™å®šä¹‰äº†å½“ç”Ÿäº§è€…ä½¿ç”¨ <code>acks=all</code> æ—¶ï¼ŒLeader å¿…é¡»ç­‰å¾…å¤šå°‘ä¸ª ISR å‰¯æœ¬æˆåŠŸå†™å…¥åæ‰è¿”å›ç¡®è®¤ã€‚ç»“åˆ <code>acks=all</code> å’Œ <code>min.insync.replicas</code>ï¼Œå¯ä»¥ç¡®ä¿å†™å…¥æˆåŠŸçš„æ¶ˆæ¯è‡³å°‘å­˜åœ¨äº <code>min.insync.replicas</code> ä¸ªå‰¯æœ¬ä¸Šï¼Œå¤§å¤§æé«˜äº†æ•°æ®æŒä¹…æ€§ã€‚</li><li><strong>è®¾ç½® <code>unclean.leader.election.enable=false</code>ï¼š</strong> <strong>å¼ºçƒˆå»ºè®®ç”Ÿäº§ç¯å¢ƒå…³é—­ï¼</strong> è¿™é˜»æ­¢äº†ä»é ISR å‰¯æœ¬é€‰ä¸¾ Leaderï¼Œå®å¯è®©åˆ†åŒºä¸å¯ç”¨ï¼ˆå½±å“å¯ç”¨æ€§ï¼‰ï¼Œä¹Ÿè¦ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼ˆä¸ä¸¢å¤±å·²ç¡®è®¤çš„æ¶ˆæ¯ï¼‰ã€‚éœ€è¦é€šè¿‡ç›‘æ§å’Œè¿ç»´æ‰‹æ®µå¿«é€Ÿæ¢å¤ ISR å‰¯æœ¬ä»¥ä¿è¯å¯ç”¨æ€§ã€‚</li></ul></li></ul></li><li><strong>æ¶ˆè´¹è€…æ‹‰å–æ¶ˆæ¯æ—¶ä¸¢å¤±ï¼š</strong><ul><li><strong>åŸå› ï¼š</strong><ul><li><strong>è‡ªåŠ¨æäº¤åç§»é‡ + æ¶ˆæ¯å¤„ç†å¤±è´¥ï¼š</strong> æ¶ˆè´¹è€…é»˜è®¤æˆ–åœ¨å¤„ç†æ¶ˆæ¯å‰è‡ªåŠ¨æäº¤åç§»é‡ã€‚å¦‚æœæ¶ˆæ¯åœ¨å¤„ç†è¿‡ç¨‹ä¸­ï¼ˆä¾‹å¦‚ä¸šåŠ¡é€»è¾‘å‡ºé”™ã€æ¶ˆè´¹è€…å´©æºƒï¼‰å¤±è´¥ï¼Œä½†åç§»é‡å·²ç»æäº¤ï¼Œé‚£ä¹ˆè¿™æ¡æ¶ˆæ¯å¯¹äºè¯¥æ¶ˆè´¹è€…ç»„æ¥è¯´å°±â€œä¸¢å¤±â€äº†ï¼ˆå› ä¸ºä¸‹æ¬¡æ‹‰å–ä¼šä»å·²æäº¤çš„åç§»é‡ä¹‹åå¼€å§‹ï¼‰ã€‚è™½ç„¶æ¶ˆæ¯è¿˜åœ¨ Broker ä¸Šï¼Œä½†æ²¡æœ‰æ¶ˆè´¹è€…ä¼šå†å¤„ç†å®ƒã€‚</li></ul></li><li><strong>è§£å†³æ–¹æ¡ˆï¼š</strong><ul><li><strong>å…³é—­è‡ªåŠ¨æäº¤ï¼Œé‡‡ç”¨æ‰‹åŠ¨æäº¤åç§»é‡ï¼š</strong> è®¾ç½® <code>enable.auto.commit=false</code>ã€‚</li><li><strong>åœ¨å¤„ç†å®Œæ¶ˆæ¯åæ‰‹åŠ¨æäº¤åç§»é‡ï¼š</strong> åœ¨ä¸šåŠ¡é€»è¾‘æˆåŠŸæ‰§è¡Œå®Œæ¯•åï¼Œå†è°ƒç”¨ <code>consumer.commitSync()</code> æˆ– <code>consumer.commitAsync()</code> æäº¤åç§»é‡ã€‚è¿™ä¿è¯äº†â€œè‡³å°‘ä¸€æ¬¡â€è¯­ä¹‰ï¼ˆæ¶ˆæ¯å¯èƒ½è¢«å¤„ç†å¤šæ¬¡ï¼Œä½†è‡³å°‘å¤„ç†ä¸€æ¬¡ï¼‰ã€‚</li><li><strong>æ³¨æ„æäº¤çš„åŸå­æ€§ï¼š</strong> å°½é‡ä¿è¯å¤„ç†å•æ¡æ¶ˆæ¯åç«‹å³æäº¤å…¶åç§»é‡ã€‚æ‰¹é‡å¤„ç†æ—¶ï¼Œéœ€è¦åœ¨æˆåŠŸå¤„ç†å®Œä¸€ä¸ªæ‰¹æ¬¡åå†æäº¤è¯¥æ‰¹æ¬¡ä¸­æœ€åä¸€æ¡æ¶ˆæ¯çš„åç§»é‡ã€‚å¦‚æœå¤„ç†å¤±è´¥ï¼Œä¸è¦æäº¤åç§»é‡ï¼Œè¿™æ ·æ¶ˆè´¹è€…é‡å¯åä¼šé‡æ–°æ‹‰å–å¤±è´¥çš„æ¶ˆæ¯ã€‚</li><li><strong>å¤„ç†å¥½å†å¹³è¡¡ï¼š</strong> åœ¨æ¶ˆè´¹è€…å‘ç”Ÿå†å¹³è¡¡ï¼ˆConsumer Rebalance - æ¶ˆè´¹è€…åŠ å…¥æˆ–ç¦»å¼€ç»„ï¼‰æ—¶ï¼Œç¡®ä¿åœ¨å¤±å»åˆ†åŒºæ‰€æœ‰æƒå‰æäº¤å·²å¤„ç†æ¶ˆæ¯çš„åç§»é‡ã€‚ç›‘å¬ <code>ConsumerRebalanceListener</code> æ¥å£ï¼Œåœ¨ <code>onPartitionsRevoked</code> æ–¹æ³•ä¸­è¿›è¡Œæäº¤ã€‚</li></ul></li></ul></li></ol><h2 id="å¦‚ä½•è§£å†³æ¶ˆæ¯é‡å¤æ¶ˆè´¹çš„é—®é¢˜"><a href="#å¦‚ä½•è§£å†³æ¶ˆæ¯é‡å¤æ¶ˆè´¹çš„é—®é¢˜" class="headerlink" title="å¦‚ä½•è§£å†³æ¶ˆæ¯é‡å¤æ¶ˆè´¹çš„é—®é¢˜"></a>å¦‚ä½•è§£å†³æ¶ˆæ¯é‡å¤æ¶ˆè´¹çš„é—®é¢˜</h2><p>æ¶ˆæ¯é‡å¤æ¶ˆè´¹ä¸»è¦å‘ç”Ÿåœ¨æ¶ˆè´¹è€…ç«¯ï¼š</p><ol><li><strong>åŸå› ï¼š</strong><ul><li><strong>æ¶ˆè´¹è€…å¤„ç†æˆåŠŸä½†æäº¤åç§»é‡å¤±è´¥ï¼š</strong> è¿™æ˜¯æœ€å¸¸è§çš„åŸå› ã€‚æ¶ˆè´¹è€…æˆåŠŸå¤„ç†äº†æ¶ˆæ¯ï¼Œä½†åœ¨æäº¤åç§»é‡æ—¶å¤±è´¥ï¼ˆä¾‹å¦‚ç½‘ç»œé—®é¢˜ã€æ¶ˆè´¹è€…å´©æºƒã€å†å¹³è¡¡ï¼‰ã€‚å½“æ¶ˆè´¹è€…æ¢å¤æˆ–æ–°æ¶ˆè´¹è€…æ¥ç®¡åˆ†åŒºåï¼Œä¼šä»ä¸Šä¸€æ¬¡æˆåŠŸæäº¤çš„åç§»é‡å¼€å§‹æ¶ˆè´¹ï¼Œå¯¼è‡´å·²å¤„ç†ä½†æœªæäº¤åç§»é‡çš„æ¶ˆæ¯è¢«å†æ¬¡å¤„ç†ã€‚</li><li><strong>ç”Ÿäº§è€…é‡è¯•å¯¼è‡´æ¶ˆæ¯é‡å¤å†™å…¥ï¼š</strong> åœ¨æœªå¯ç”¨å¹‚ç­‰æ€§æ—¶ï¼Œç”Ÿäº§è€…å‘é€æ¶ˆæ¯åæœªæ”¶åˆ° Broker ç¡®è®¤ï¼ˆå¯èƒ½ Broker å·²å†™å…¥ä½†ç¡®è®¤ä¸¢å¤±ï¼‰ï¼Œç”Ÿäº§è€…é‡è¯•å¯èƒ½å¯¼è‡´ Broker æ”¶åˆ°ä¸¤æ¡ç›¸åŒçš„æ¶ˆæ¯ï¼ˆå…·æœ‰ä¸åŒçš„åç§»é‡ï¼‰ã€‚</li><li><strong>æ¶ˆè´¹è€…å†å¹³è¡¡ï¼š</strong> å†å¹³è¡¡è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæ¶ˆè´¹è€…åœ¨æäº¤åç§»é‡å‰è¢«æ’¤é”€åˆ†åŒºï¼Œä¸”æ–°æ¶ˆè´¹è€…åœ¨æ—§æ¶ˆè´¹è€…å®Œæˆå¤„ç†å‰æ¥ç®¡ï¼Œå¯èƒ½å¯¼è‡´æ¶ˆæ¯è¢«ä¸åŒæ¶ˆè´¹è€…é‡å¤å¤„ç†ï¼ˆå°¤å…¶æ˜¯å¤„ç†æ—¶é—´è¾ƒé•¿æ—¶ï¼‰ã€‚</li><li><strong>æ¶ˆè´¹è€… Seekï¼š</strong> æ‰‹åŠ¨å°†æ¶ˆè´¹è€…åç§»é‡é‡ç½®åˆ°ä¹‹å‰çš„ä½ç½®ä¼šå¯¼è‡´é‡å¤æ¶ˆè´¹ã€‚</li></ul></li><li><strong>è§£å†³æ–¹æ¡ˆï¼š</strong><ul><li><strong>å¯ç”¨ç”Ÿäº§è€…å¹‚ç­‰æ€§ï¼š</strong> è®¾ç½® <code>enable.idempotence=true</code>ã€‚è¿™æ˜¯è§£å†³ç”Ÿäº§è€…é‡è¯•å¯¼è‡´ Broker ç«¯æ¶ˆæ¯é‡å¤çš„æ ¹æœ¬æ–¹æ³•ã€‚å®ƒç¡®ä¿å•ä¸ªç”Ÿäº§è€…ä¼šè¯å†…å‘é€åˆ°åŒä¸€åˆ†åŒºçš„æ¶ˆæ¯æ˜¯å¹‚ç­‰çš„ã€‚</li><li><strong>å¯ç”¨ Kafka çš„äº‹åŠ¡ï¼š</strong> å¯¹äºéœ€è¦è·¨ Kafka Topic å’Œå¤–éƒ¨ç³»ç»Ÿï¼ˆå¦‚æ•°æ®åº“ï¼‰ä¿è¯â€œç²¾ç¡®ä¸€æ¬¡â€è¯­ä¹‰çš„åœºæ™¯ï¼Œéœ€è¦ä½¿ç”¨ Kafka äº‹åŠ¡ APIã€‚ç”Ÿäº§è€…ä½¿ç”¨äº‹åŠ¡å‘é€æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…åœ¨äº‹åŠ¡å†…è¯»å–æ¶ˆæ¯å¹¶æäº¤åç§»é‡ï¼ˆè®¾ç½® <code>isolation.level=read_committed</code>ï¼‰ã€‚è¿™éœ€è¦å¤–éƒ¨ç³»ç»Ÿä¹Ÿæ”¯æŒäº‹åŠ¡æ€§å‚ä¸ï¼ˆé€šå¸¸é€šè¿‡ä¸¤é˜¶æ®µæäº¤æˆ–äº‹åŠ¡æ€§å‡ºç«™ï¼‰ã€‚</li><li><strong>æ¶ˆè´¹è€…ç«¯å®ç°å¹‚ç­‰æ€§ï¼š</strong> <strong>è¿™æ˜¯æœ€å¸¸ç”¨ã€æœ€çµæ´»ã€é€‚ç”¨èŒƒå›´æœ€å¹¿çš„è§£å†³æ–¹æ¡ˆï¼</strong> æ—¢ç„¶ Kafka æ¶ˆè´¹è€…ç«¯é»˜è®¤æ˜¯â€œè‡³å°‘ä¸€æ¬¡â€è¯­ä¹‰ï¼Œé‚£ä¹ˆå°±éœ€è¦ä½ çš„æ¶ˆè´¹é€»è¾‘èƒ½å¤Ÿå®¹å¿é‡å¤ã€‚æ ¸å¿ƒæ€æƒ³æ˜¯è®©å¤„ç†æ“ä½œæœ¬èº«å…·æœ‰å¹‚ç­‰æ€§ï¼š<ul><li><strong>å”¯ä¸€æ ‡è¯†ï¼š</strong> åœ¨æ¶ˆæ¯ä½“ä¸­æºå¸¦ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„ä¸šåŠ¡æ ‡è¯†ç¬¦ï¼ˆå¦‚è®¢å•IDã€æ”¯ä»˜æµæ°´å·ï¼‰ã€‚</li><li><strong>çŠ¶æ€æ£€æŸ¥ï¼š</strong> åœ¨å¤„ç†æ¶ˆæ¯å‰ï¼Œå…ˆæ ¹æ®è¿™ä¸ªå”¯ä¸€æ ‡è¯†å»æ£€æŸ¥ç›®æ ‡ç³»ç»Ÿï¼ˆé€šå¸¸æ˜¯æ•°æ®åº“ï¼‰ä¸­æ˜¯å¦å·²ç»å­˜åœ¨ç›¸åŒæ ‡è¯†çš„å¤„ç†ç»“æœã€‚</li><li><strong>å¹‚ç­‰æ“ä½œï¼š</strong> å¦‚æœå­˜åœ¨ï¼Œåˆ™è·³è¿‡å¤„ç†æˆ–æ‰§è¡Œæ›´æ–°æ“ä½œï¼ˆç¡®ä¿æ›´æ–°æ“ä½œæœ¬èº«ä¹Ÿæ˜¯å¹‚ç­‰çš„ï¼Œä¾‹å¦‚ <code>UPDATE table SET status=&#39;paid&#39; WHERE order_id=123 AND status=&#39;unpaid&#39;</code>ï¼‰ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™æ­£å¸¸å¤„ç†ã€‚</li><li><strong>æ•°æ®åº“å”¯ä¸€çº¦æŸï¼š</strong> åœ¨æ•°æ®åº“è¡¨ä¸­ï¼Œåˆ©ç”¨å”¯ä¸€é”®çº¦æŸæ¥é˜²æ­¢é‡å¤æ’å…¥æ˜¯æœ€æœ‰æ•ˆçš„æ‰‹æ®µã€‚å°è¯•æ’å…¥å¸¦æœ‰å”¯ä¸€æ ‡è¯†çš„è®°å½•ï¼Œå¦‚æœè¿åå”¯ä¸€çº¦æŸåˆ™è§†ä¸ºé‡å¤æ¶ˆæ¯ï¼Œè¿›è¡Œæ›´æ–°æˆ–å¿½ç•¥ã€‚</li></ul></li></ul></li></ol><h2 id="Kafka-å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„é¡ºåºæ€§"><a href="#Kafka-å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„é¡ºåºæ€§" class="headerlink" title="Kafka å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„é¡ºåºæ€§"></a>Kafka å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„é¡ºåºæ€§</h2><ul><li><strong>Kafka ä»…ä¿è¯å•ä¸ª Partition å†…æ¶ˆæ¯çš„ä¸¥æ ¼é¡ºåº (FIFO)ã€‚</strong> è¿™æ˜¯ç”±å…¶è¿½åŠ å†™å…¥å’Œå•çº¿ç¨‹æ¶ˆè´¹åˆ†åŒºçš„ç‰¹æ€§ä¿è¯çš„ã€‚</li><li><strong>æ— æ³•ä¿è¯è·¨ Partition çš„æ¶ˆæ¯å…¨å±€é¡ºåºã€‚</strong></li><li><strong>éœ€è¦å…¨å±€é¡ºåºæ€ä¹ˆåŠï¼Ÿ</strong> å°†æ‰€æœ‰éœ€è¦ä¿è¯é¡ºåºçš„æ¶ˆæ¯å‘é€åˆ°<strong>åŒä¸€ä¸ª Partition</strong>ã€‚é€šå¸¸é€šè¿‡ä¸ºè¿™äº›æ¶ˆæ¯æŒ‡å®š<strong>ç›¸åŒçš„ Key</strong> æ¥å®ç° (Producer æ ¹æ® Key çš„å“ˆå¸Œå€¼å†³å®š Partition)ã€‚</li><li><strong>éœ€è¦åˆ†åŒºé¡ºåºæ€ä¹ˆåŠï¼Ÿ</strong> ç¡®ä¿åŒä¸€ä¸ª Key çš„æ¶ˆæ¯æ€»æ˜¯å‘åˆ°åŒä¸€ä¸ª Partition (åŒæ ·é€šè¿‡ Key å“ˆå¸Œ)ï¼Œåˆ™è¯¥ Key ç›¸å…³çš„æ¶ˆæ¯åœ¨è¯¥ Partition å†…æ˜¯é¡ºåºçš„ã€‚</li></ul><h2 id="ISR-æœºåˆ¶åŠå…¶åœ¨-Leader-é€‰ä¸¾ä¸­çš„ä½œç”¨"><a href="#ISR-æœºåˆ¶åŠå…¶åœ¨-Leader-é€‰ä¸¾ä¸­çš„ä½œç”¨" class="headerlink" title="ISR æœºåˆ¶åŠå…¶åœ¨ Leader é€‰ä¸¾ä¸­çš„ä½œç”¨"></a>ISR æœºåˆ¶åŠå…¶åœ¨ Leader é€‰ä¸¾ä¸­çš„ä½œç”¨</h2><p><strong>ISR (In-Sync Replicas):</strong> æŒ‡ä¸ Partition Leader å‰¯æœ¬<strong>ä¿æŒåŒæ­¥</strong>çš„ Follower å‰¯æœ¬é›†åˆã€‚Leader ç»´æŠ¤ ISR åˆ—è¡¨ã€‚</p><p><strong>åŒæ­¥æ ‡å‡†:</strong> Follower å‰¯æœ¬åœ¨ <code>replica.lag.time.max.ms</code> æ—¶é—´å†…æˆåŠŸä» Leader æ‹‰å–åˆ°æœ€æ–°æ•°æ®ã€‚</p><p><strong>Leader é€‰ä¸¾:</strong> å½“ Leader å‰¯æœ¬æ‰€åœ¨ Broker å®•æœºæ—¶ï¼ŒController ä¼š<strong>ä»å½“å‰ ISR é›†åˆä¸­é€‰æ‹©ä¸€ä¸ªå‰¯æœ¬</strong>ä½œä¸ºæ–°çš„ Leaderã€‚è¿™æ˜¯ä¸ºäº†ä¿è¯æ–° Leader æ‹¥æœ‰æœ€æ–°çš„å·²æäº¤æ•°æ®ï¼Œé¿å…æ•°æ®ä¸¢å¤±æˆ–ä¸ä¸€è‡´ã€‚</p><h2 id="Zookeeper-å’Œ-KRaft-çš„åŒºåˆ«ï¼Œä¸ºä»€ä¹ˆ-Kafka-è¦å»-Zookeeper-åŒ–"><a href="#Zookeeper-å’Œ-KRaft-çš„åŒºåˆ«ï¼Œä¸ºä»€ä¹ˆ-Kafka-è¦å»-Zookeeper-åŒ–" class="headerlink" title="Zookeeper å’Œ KRaft çš„åŒºåˆ«ï¼Œä¸ºä»€ä¹ˆ Kafka è¦å» Zookeeper åŒ–"></a>Zookeeper å’Œ KRaft çš„åŒºåˆ«ï¼Œä¸ºä»€ä¹ˆ Kafka è¦å» Zookeeper åŒ–</h2><ul><li><strong>Zookeeper (ZK)ï¼š</strong> æ˜¯ Kafka 2.7 åŠä¹‹å‰ç‰ˆæœ¬çš„æ ¸å¿ƒå¤–éƒ¨ä¾èµ–ã€‚è´Ÿè´£ï¼š<ul><li>Broker æ³¨å†Œä¸å‘ç°</li><li>Controller é€‰ä¸¾</li><li>Topic é…ç½®å­˜å‚¨</li><li>ACL æƒé™å­˜å‚¨</li><li>(æ—§ç‰ˆ) Consumer Offset å­˜å‚¨</li></ul></li><li><strong>KRaftï¼š</strong> æ˜¯ Kafka å†…éƒ¨å®ç°çš„åŸºäº Raft å…±è¯†åè®®çš„å…ƒæ•°æ®ç®¡ç†ç³»ç»Ÿï¼Œä» Kafka 2.8 (é¢„è§ˆ) &#x2F; 3.0+ (ç”Ÿäº§å¯ç”¨) å¼€å§‹å¼•å…¥ï¼Œæ—¨åœ¨å®Œå…¨å–ä»£ Zookeeperã€‚</li><li><strong>å» ZK åŒ–åŸå›  (KRaft ä¼˜åŠ¿)ï¼š</strong><ul><li><strong>ç®€åŒ–æ¶æ„ä¸éƒ¨ç½²ï¼š</strong> ç§»é™¤å¤–éƒ¨ä¾èµ–ï¼ŒKafka è‡ªåŒ…å«ï¼Œéƒ¨ç½²ã€é…ç½®ã€ç›‘æ§æ›´ç®€å•ã€‚</li><li><strong>æå‡æ€§èƒ½ä¸å¯ä¼¸ç¼©æ€§ï¼š</strong> å…ƒæ•°æ®æ“ä½œç›´æ¥åœ¨ Kafka åè®®ä¸Šå¤„ç†ï¼Œå‡å°‘ä¸€æ¬¡ç½‘ç»œè·³è½¬å’Œåºåˆ—åŒ–å¼€é”€ã€‚KRaft è®¾è®¡ä¸Šèƒ½æ›´å¥½åœ°æ”¯æŒå¤§è§„æ¨¡é›†ç¾¤ï¼ˆæ•°ä¸‡ä¸ª Partitionï¼‰ã€‚</li><li><strong>æ›´å¼ºçš„å…ƒæ•°æ®ä¸€è‡´æ€§æ¨¡å‹ï¼š</strong> KRaft ä½¿ç”¨ Raft å¼ºä¸€è‡´æ€§åè®®ç®¡ç†å…ƒæ•°æ®çŠ¶æ€æœºã€‚</li><li><strong>æ›´ç›´æ¥çš„è¿ç»´ï¼š</strong> æ‰€æœ‰æ“ä½œé€šè¿‡ Kafka API æˆ– <code>kafka-metadata-shell</code> å®Œæˆï¼Œæ— éœ€å•ç‹¬ç®¡ç† ZKã€‚</li><li><strong>ç»Ÿä¸€å®‰å…¨æ¨¡å‹ï¼š</strong> å…ƒæ•°æ®é€šä¿¡å¤ç”¨ Kafka çš„å®‰å…¨æœºåˆ¶ (SSL&#x2F;SASL)ï¼Œæ— éœ€å•ç‹¬é…ç½® ZK å®‰å…¨ã€‚</li><li><strong>ç°çŠ¶ï¼š</strong> KRaft å·²æˆä¸ºç”Ÿäº§æ¨èæ¨¡å¼ï¼Œæ–°é›†ç¾¤åº”ä¼˜å…ˆä½¿ç”¨ KRaftã€‚Zookeeper æ¨¡å¼åœ¨é€æ­¥æ·˜æ±°ã€‚</li></ul></li></ul><h2 id="ä»€ä¹ˆæ˜¯-Consumer-Lag"><a href="#ä»€ä¹ˆæ˜¯-Consumer-Lag" class="headerlink" title="ä»€ä¹ˆæ˜¯ Consumer Lag"></a>ä»€ä¹ˆæ˜¯ Consumer Lag</h2><ul><li><strong>å®šä¹‰ï¼š</strong> Consumer Lag æŒ‡ Consumer Group åœ¨æŸä¸ª Partition ä¸Š<strong>æœ€æ–°æäº¤çš„ Offset</strong> ä¸ <strong>Partition å½“å‰æœ€æ–°æ¶ˆæ¯çš„ Offset (LEO)</strong> ä¹‹é—´çš„å·®å€¼ã€‚å³ <strong>æœªæ¶ˆè´¹çš„æ¶ˆæ¯æ•°é‡</strong>ã€‚</li><li><strong>ç›‘æ§é‡è¦æ€§ï¼š</strong> Lag æ˜¯è¡¡é‡æ¶ˆè´¹å¥åº·çŠ¶å†µçš„å…³é”®æŒ‡æ ‡ã€‚æŒç»­å¢é•¿çš„ Lag æ„å‘³ç€æ¶ˆè´¹é€Ÿåº¦è·Ÿä¸ä¸Šç”Ÿäº§é€Ÿåº¦ï¼Œå¯èƒ½å¯¼è‡´å»¶è¿Ÿå’Œæ•°æ®ç§¯å‹</li><li><strong>åŸå› ï¼š</strong><ul><li>æ¶ˆè´¹è€…å¤„ç†èƒ½åŠ›ä¸è¶³ (CPU, å†…å­˜, é€»è¾‘å¤æ‚, I&#x2F;O æ…¢)ã€‚</li><li>æ¶ˆè´¹è€…å®ä¾‹æ•°é‡ä¸è¶³ (Partition æ•° &gt; Consumer å®ä¾‹æ•°)ã€‚</li><li>ä¸‹æ¸¸ç³»ç»Ÿæ•…éšœæˆ–æ…¢ã€‚</li><li>æ¶ˆè´¹è€…ä»£ç  Bug æˆ–é…ç½®é—®é¢˜ (å¦‚ <code>max.poll.records</code> å¤ªå¤§å¯¼è‡´å•æ¬¡å¤„ç†æ—¶é—´è¿‡é•¿)ã€‚</li><li>ç½‘ç»œé—®é¢˜ã€‚</li></ul></li><li><strong>å¤„ç†ï¼š</strong><ul><li><strong>ç›‘æ§:</strong> ä½¿ç”¨ Kafka è‡ªå¸¦å·¥å…· (<code>kafka-consumer-groups.sh</code>)ï¼ŒJMX æŒ‡æ ‡ï¼Œæˆ–ç¬¬ä¸‰æ–¹ç›‘æ§ç³»ç»Ÿ (Prometheus+Grafana, Confluent Control Center)ã€‚</li><li><strong>æ‰©å®¹ï¼š</strong> å¢åŠ  Consumer Group å†…çš„ Consumer å®ä¾‹æ•° (ç¡®ä¿ &lt;&#x3D; Partition æ•°)ã€‚</li><li><strong>ä¼˜åŒ–æ¶ˆè´¹è€…ï¼š</strong> æå‡å• Consumer å¤„ç†èƒ½åŠ› (ä¼˜åŒ–ä»£ç é€»è¾‘ã€å¼‚æ­¥å¤„ç†ã€æ‰¹å¤„ç†ã€è°ƒä¼˜ JVM)ã€‚</li><li><strong>è°ƒæ•´å‚æ•°ï¼š</strong> é€‚å½“å¢åŠ  <code>fetch.min.bytes</code>, <code>fetch.max.wait.ms</code> æé«˜æ‹‰å–æ•ˆç‡ï¼›è°ƒæ•´ <code>max.poll.records</code> é¿å…å•æ¬¡å¤„ç†è¿‡å¤šæ¶ˆæ¯è¶…æ—¶ï¼›æ£€æŸ¥ <code>session.timeout.ms</code> å’Œ <code>max.poll.interval.ms</code> é¿å…è¯¯åˆ¤ç¦»çº¿è§¦å‘ Rebalanceã€‚</li><li><strong>æ’æŸ¥ä¸‹æ¸¸ä¾èµ–ã€‚</strong></li></ul></li></ul><h2 id="å¼‚æ­¥ã€å‰Šå³°ã€è§£è€¦"><a href="#å¼‚æ­¥ã€å‰Šå³°ã€è§£è€¦" class="headerlink" title="å¼‚æ­¥ã€å‰Šå³°ã€è§£è€¦"></a>å¼‚æ­¥ã€å‰Šå³°ã€è§£è€¦</h2><h3 id="å¼‚æ­¥å¤„ç†"><a href="#å¼‚æ­¥å¤„ç†" class="headerlink" title="å¼‚æ­¥å¤„ç†"></a>å¼‚æ­¥å¤„ç†</h3><p><strong>æ ¸å¿ƒæ€æƒ³</strong>ï¼šå°†è€—æ—¶çš„æ“ä½œä»ä¸»æµç¨‹ä¸­å‰¥ç¦»ï¼Œé€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—<strong>å»¶åæ‰§è¡Œ</strong>ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚<br><strong>åœºæ™¯ä¸¾ä¾‹</strong>ï¼š<br>ç”¨æˆ·æ³¨å†Œåéœ€è¦ï¼š</p><ol><li>å†™å…¥æ•°æ®åº“ï¼ˆ10msï¼‰</li><li>å‘é€æ¬¢è¿é‚®ä»¶ï¼ˆ100msï¼‰</li><li>åˆå§‹åŒ–ç”¨æˆ·ç”»åƒï¼ˆ200msï¼‰</li></ol><ul><li><p><strong>æ— æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆåŒæ­¥ï¼‰</strong>ï¼š<br>ç”¨æˆ·éœ€ç­‰å¾…æ‰€æœ‰æ­¥éª¤å®Œæˆï¼ˆ310msï¼‰ï¼Œå“åº”ç¼“æ…¢ã€‚</p><p>plaintext</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ç”¨æˆ· â†’ æ³¨å†Œ â†’ [ å†™åº“10ms â†’ å‘é‚®ä»¶100ms â†’ åˆå§‹åŒ–ç”»åƒ200ms ] â†’ è¿”å›ç»“æœï¼ˆ310msï¼‰</span><br></pre></td></tr></table></figure></li><li><p><strong>ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆå¼‚æ­¥ï¼‰</strong>ï¼š<br>ä¸»æµç¨‹ä»…å¤„ç†æ ¸å¿ƒé€»è¾‘ï¼ˆå†™åº“ï¼‰ï¼Œå…¶ä»–æ“ä½œé€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥æ‰§è¡Œï¼š</p><p>plaintext</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ç”¨æˆ· â†’ æ³¨å†Œ â†’ [ å†™åº“10ms ] â†’ è¿”å›ç»“æœï¼ˆ10msï¼‰</span><br><span class="line">              â†“</span><br><span class="line">          æ¶ˆæ¯é˜Ÿåˆ— â†’ [ å‘é‚®ä»¶ | åˆå§‹åŒ–ç”»åƒ ]ï¼ˆåå°å¼‚æ­¥æ‰§è¡Œï¼‰</span><br></pre></td></tr></table></figure></li></ul><p><strong>ä¼˜åŠ¿</strong>ï¼š<br>âœ… ç”¨æˆ·å¿«é€Ÿè·å¾—å“åº”ï¼ˆ10msï¼‰<br>âœ… é¿å…éå…³é”®ä»»åŠ¡é˜»å¡æ ¸å¿ƒæµç¨‹<br>âœ… æå‡ç³»ç»Ÿååé‡</p><hr><h3 id="æµé‡å‰Šå³°"><a href="#æµé‡å‰Šå³°" class="headerlink" title="æµé‡å‰Šå³°"></a>æµé‡å‰Šå³°</h3><p><strong>æ ¸å¿ƒæ€æƒ³</strong>ï¼šç”¨æ¶ˆæ¯é˜Ÿåˆ—ä½œä¸º<strong>ç¼“å†²å±‚</strong>ï¼Œå¸æ”¶çªå‘æµé‡ï¼Œä¿æŠ¤ä¸‹æ¸¸ç³»ç»Ÿä¸è¢«å‹å®ã€‚<br><strong>åœºæ™¯ä¸¾ä¾‹</strong>ï¼š<br>ç”µå•†ç§’æ€æ´»åŠ¨ï¼Œç¬é—´æ¶Œå…¥10ä¸‡è¯·æ±‚ï¼Œä½†æ•°æ®åº“ä»…èƒ½å¤„ç†1ä¸‡&#x2F;ç§’ã€‚</p><ul><li><p><strong>æ— æ¶ˆæ¯é˜Ÿåˆ—</strong>ï¼š<br>æ•°æ®åº“ç›´æ¥è¢«æ‰“å´©ï¼Œè¯·æ±‚è¶…æ—¶ï¼Œç”¨æˆ·çœ‹åˆ°é”™è¯¯é¡µé¢ã€‚</p><p>plaintext</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10ä¸‡è¯·æ±‚ â†’ æ•°æ®åº“ï¼ˆå´©æºƒï¼‰</span><br></pre></td></tr></table></figure></li><li><p><strong>ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—</strong>ï¼š<br>è¯·æ±‚å…ˆè¿›å…¥æ¶ˆæ¯é˜Ÿåˆ—æ’é˜Ÿï¼Œæ•°æ®åº“æŒ‰å¤„ç†èƒ½åŠ›æ¶ˆè´¹ï¼š</p><p>plaintext</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10ä¸‡è¯·æ±‚ â†’ æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆè“„æ´ªæ± ï¼‰ â†’ æ•°æ®åº“æŒ‰1ä¸‡/ç§’å¤„ç†</span><br></pre></td></tr></table></figure></li></ul><p><strong>ä¼˜åŠ¿</strong>ï¼š<br>âœ… é¿å…ä¸‹æ¸¸ç³»ç»Ÿï¼ˆå¦‚æ•°æ®åº“ï¼‰å› çªå‘æµé‡å´©æºƒ<br>âœ… å¹³æ»‘æµé‡æ³¢åŠ¨ï¼Œå°†ç¬æ—¶é«˜å³°è½¬ä¸ºåŒ€é€Ÿæ¶ˆè´¹<br>âœ… ç»“åˆé‡è¯•æœºåˆ¶æå‡ç³»ç»Ÿå®¹é”™æ€§</p><hr><h3 id="ç³»ç»Ÿè§£è€¦"><a href="#ç³»ç»Ÿè§£è€¦" class="headerlink" title="ç³»ç»Ÿè§£è€¦"></a>ç³»ç»Ÿè§£è€¦</h3><p><strong>æ ¸å¿ƒæ€æƒ³</strong>ï¼šé€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—<strong>åˆ‡æ–­æœåŠ¡é—´çš„ç›´æ¥ä¾èµ–</strong>ï¼ŒæœåŠ¡åªéœ€å…³å¿ƒæ¶ˆæ¯æ ¼å¼ï¼Œäº’ä¸æ„ŸçŸ¥å­˜åœ¨ã€‚<br><strong>åœºæ™¯ä¸¾ä¾‹</strong>ï¼š<br>è®¢å•ç³»ç»Ÿéœ€è¦é€šçŸ¥ï¼šåº“å­˜ç³»ç»Ÿæ‰£åº“å­˜ã€ç§¯åˆ†ç³»ç»ŸåŠ ç§¯åˆ†ã€ç‰©æµç³»ç»Ÿåˆ›å»ºè¿å•ã€‚</p><ul><li><p><strong>å¼ºè€¦åˆæ¶æ„</strong>ï¼š<br>è®¢å•ç³»ç»Ÿéœ€ç›´æ¥è°ƒç”¨å…¶ä»–ç³»ç»Ÿçš„APIï¼š</p><p>plaintext</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">è®¢å•ç³»ç»Ÿ â†’ è°ƒç”¨ â†’ [åº“å­˜ç³»ç»Ÿã€ç§¯åˆ†ç³»ç»Ÿã€ç‰©æµç³»ç»Ÿ]</span><br></pre></td></tr></table></figure><p><strong>é—®é¢˜</strong>ï¼š<br>âŒ ä»»ä¸€ç³»ç»Ÿæ•…éšœå¯¼è‡´è®¢å•å¤±è´¥<br>âŒ æ–°å¢ä¸€ä¸ªé€šçŸ¥ï¼ˆå¦‚çŸ­ä¿¡ç³»ç»Ÿï¼‰éœ€ä¿®æ”¹è®¢å•ç³»ç»Ÿä»£ç </p></li><li><p><strong>æ¶ˆæ¯é˜Ÿåˆ—è§£è€¦</strong>ï¼š<br>è®¢å•ç³»ç»Ÿåªå‘ä¸€æ¡æ¶ˆæ¯åˆ°é˜Ÿåˆ—ï¼Œä¸‹æ¸¸ç³»ç»Ÿå„è‡ªè®¢é˜…ï¼š</p><p>plaintext</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">è®¢å•ç³»ç»Ÿ â†’ æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆè®¢å•åˆ›å»ºäº‹ä»¶ï¼‰</span><br><span class="line">                 â†“</span><br><span class="line">   åº“å­˜ç³»ç»Ÿ  ç§¯åˆ†ç³»ç»Ÿ  ç‰©æµç³»ç»Ÿ  ï¼ˆå„è‡ªç‹¬ç«‹æ¶ˆè´¹ï¼‰</span><br></pre></td></tr></table></figure></li></ul><p><strong>ä¼˜åŠ¿</strong>ï¼š<br>âœ… è®¢å•ç³»ç»Ÿæ— éœ€çŸ¥é“ä¸‹æ¸¸æ˜¯è°<br>âœ… æ–°å¢æ¶ˆè´¹è€…ï¼ˆå¦‚çŸ­ä¿¡ç³»ç»Ÿï¼‰æ— éœ€ä¿®æ”¹è®¢å•ä»£ç <br>âœ… ä¸‹æ¸¸æ•…éšœä¸å½±å“ä¸»æµç¨‹ï¼ˆæ¶ˆæ¯å †ç§¯åœ¨é˜Ÿåˆ—ï¼‰</p><h2 id="ä»€ä¹ˆæ˜¯æ­»ä¿¡é˜Ÿåˆ—"><a href="#ä»€ä¹ˆæ˜¯æ­»ä¿¡é˜Ÿåˆ—" class="headerlink" title="ä»€ä¹ˆæ˜¯æ­»ä¿¡é˜Ÿåˆ—"></a>ä»€ä¹ˆæ˜¯æ­»ä¿¡é˜Ÿåˆ—</h2><p>æ­»ä¿¡é˜Ÿåˆ—ï¼ˆDead Letter Queueï¼Œç®€ç§° <strong>DLQ</strong>ï¼‰æ˜¯æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿï¼ˆå¦‚ RabbitMQã€Kafkaã€ActiveMQã€AWS SQS ç­‰ï¼‰ä¸­çš„ä¸€ä¸ª<strong>æ ¸å¿ƒå®¹é”™æœºåˆ¶</strong>ã€‚å®ƒçš„æ ¸å¿ƒä½œç”¨åœ¨äºå¤„ç†é‚£äº›<strong>æ— æ³•è¢«æ­£å¸¸æ¶ˆè´¹æˆ–ä¼ é€’çš„æ¶ˆæ¯</strong>ï¼Œä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆä¸€ä¸ªä¸“é—¨æ”¶å®¹â€œå¤±è´¥ä»»åŠ¡â€çš„éš”ç¦»åŒºã€‚</p><p>ç®€å•æ¥è¯´ï¼Œå½“ä¸€ä¸ªæ¶ˆæ¯åœ¨ç³»ç»Ÿä¸­â€œæ­»æ‰â€ï¼ˆæ— æ³•è¢«æˆåŠŸå¤„ç†ï¼‰æ—¶ï¼Œå®ƒå°±ä¼šè¢«è½¬ç§»åˆ°è¿™ä¸ªç‰¹æ®Šçš„é˜Ÿåˆ—ï¼ˆDLQï¼‰ä¸­ï¼Œè€Œä¸æ˜¯è¢«ç›´æ¥ä¸¢å¼ƒæˆ–æ— é™æ¬¡é‡è¯•å¯¼è‡´ç³»ç»Ÿé˜»å¡ã€‚</p><p><strong>æ¶ˆæ¯ä¸ºä»€ä¹ˆä¼šâ€œæ­»â€ï¼ˆè¿›å…¥æ­»ä¿¡é˜Ÿåˆ—ï¼‰ï¼Ÿ</strong></p><p>é€šå¸¸æœ‰ä»¥ä¸‹å‡ ç§å¸¸è§åŸå› ï¼š</p><ol><li><strong>æ¶ˆæ¯è¢«æ‹’ç»ä¸”æœªé‡æ–°å…¥é˜Ÿï¼š</strong><ul><li>æ¶ˆè´¹è€…åœ¨å¤„ç†æ¶ˆæ¯æ—¶é‡åˆ°æ— æ³•å¤„ç†çš„é”™è¯¯ï¼ˆå¦‚ä¸šåŠ¡é€»è¾‘é”™è¯¯ã€æ•°æ®æ ¼å¼ä¸åˆæ³•ã€ä¾èµ–æœåŠ¡ä¸å¯ç”¨ç­‰ï¼‰ã€‚</li><li>æ¶ˆè´¹è€…æ˜¾å¼åœ°å‘é€äº†å¦å®šç¡®è®¤ï¼ˆNACKï¼‰å¹¶ä¸”è®¾ç½®äº† <code>requeue=false</code>ï¼ˆæˆ–è€…åœ¨æŸäº›ç³»ç»Ÿä¸­æ˜¯æ˜¾å¼æ‹’ç»ï¼‰ï¼Œè¡¨ç¤ºæ­¤æ¶ˆæ¯ä¸åº”å†æ”¾å›åŸé˜Ÿåˆ—å°è¯•æ¶ˆè´¹ã€‚</li></ul></li><li><strong>æ¶ˆæ¯è¿‡æœŸï¼ˆTTL è¿‡æœŸï¼‰ï¼š</strong><ul><li>æ¶ˆæ¯åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…çš„æ—¶é—´è¶…è¿‡äº†é¢„è®¾çš„ç”Ÿå­˜æ—¶é—´ï¼ˆTime-To-Liveï¼Œ TTLï¼‰ã€‚</li><li>æ¶ˆæ¯åœ¨ç­‰å¾…æŠ•é€’ç»™æ¶ˆè´¹è€…æ—¶è¶…è¿‡äº†å…¶é¢„è®¾çš„ TTLï¼ˆæŸäº›ç³»ç»Ÿæ”¯æŒï¼‰ã€‚</li></ul></li><li><strong>é˜Ÿåˆ—è¾¾åˆ°æœ€å¤§é•¿åº¦é™åˆ¶ï¼š</strong><ul><li>å½“ç›®æ ‡é˜Ÿåˆ—å·²æ»¡ï¼ˆè¾¾åˆ°äº†é…ç½®çš„æœ€å¤§æ¶ˆæ¯æ•°é‡é™åˆ¶ï¼‰ï¼Œæ–°åˆ°è¾¾çš„æ¶ˆæ¯æ— æ³•å…¥é˜Ÿæ—¶ï¼Œè¿™äº›æ¶ˆæ¯å¯èƒ½ä¼šè¢«è½¬ç§»åˆ° DLQï¼ˆå–å†³äºé…ç½®ï¼‰ã€‚</li></ul></li><li><strong>æŠ•é€’å¤±è´¥æ¬¡æ•°è¶…é™ï¼š</strong><ul><li>æ¶ˆæ¯è¢«æ¶ˆè´¹è€…å¤šæ¬¡å°è¯•æ¶ˆè´¹ï¼ˆä¾‹å¦‚ï¼Œé…ç½®äº†é‡è¯•æœºåˆ¶ï¼‰ï¼Œä½†å‡å‘Šå¤±è´¥ï¼Œè¾¾åˆ°äº†æœ€å¤§é‡è¯•æ¬¡æ•°ä¸Šé™ã€‚æ­¤æ—¶ç³»ç»Ÿä¼šè®¤ä¸ºè¯¥æ¶ˆæ¯æ— æ³•è¢«æˆåŠŸå¤„ç†ï¼Œå°†å…¶æ”¾å…¥ DLQã€‚</li></ul></li></ol><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      
        <tags>
            
            <tag> Kafka </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQL</title>
      <link href="/post/32511a71.html"/>
      <url>/post/32511a71.html</url>
      
        <content type="html"><![CDATA[<ul><li><strong>SQL ä¼˜åŒ–:</strong> æ·±å…¥ç†è§£æ‰§è¡Œè®¡åˆ’ï¼ˆEXPLAINï¼‰ã€ç´¢å¼•åŸç†ï¼ˆB+æ ‘, å“ˆå¸Œ, è¦†ç›–ç´¢å¼•, æœ€å·¦å‰ç¼€ï¼‰ã€é”æœºåˆ¶ï¼ˆè¡Œé”ã€è¡¨é”ã€é—´éš™é”ã€MVCCï¼‰ã€äº‹åŠ¡éš”ç¦»çº§åˆ«å®ç°åŸç†ã€‚</li><li><strong>åˆ†åº“åˆ†è¡¨:</strong> ç†è§£åˆ†ç‰‡ç­–ç•¥ï¼ˆæ°´å¹³&#x2F;å‚ç›´ï¼‰ã€è·¯ç”±ç®—æ³•ã€åˆ†å¸ƒå¼ ID ç”Ÿæˆæ–¹æ¡ˆï¼ˆSnowflake ç­‰ï¼‰ã€é¢ä¸´çš„æŒ‘æˆ˜ï¼ˆè·¨åº“æŸ¥è¯¢ã€äº‹åŠ¡ï¼‰ã€‚</li><li><strong>NoSQL é€‰å‹:</strong> äº†è§£ MongoDB, Elasticsearch, Cassandra ç­‰é€‚ç”¨åœºæ™¯å’Œæ ¸å¿ƒç‰¹æ€§ã€‚</li></ul><h2 id="SQL"><a href="#SQL" class="headerlink" title="SQL"></a>SQL</h2><h3 id="æŸ¥è¯¢è¯­å¥çš„æ‰§è¡Œé¡ºåº"><a href="#æŸ¥è¯¢è¯­å¥çš„æ‰§è¡Œé¡ºåº" class="headerlink" title="æŸ¥è¯¢è¯­å¥çš„æ‰§è¡Œé¡ºåº"></a>æŸ¥è¯¢è¯­å¥çš„æ‰§è¡Œé¡ºåº</h3><p>MySQL åˆ†ä¸º server å±‚å’Œå­˜å‚¨å¼•æ“å±‚ã€‚</p><p>server å±‚æ¶µç›– MySQL å¤§å¤šæ•°æ ¸å¿ƒåŠŸèƒ½ï¼ˆå¦‚å­˜å‚¨è¿‡ç¨‹ã€è§¦å‘å™¨ã€è§†å›¾ç­‰ï¼‰å’Œæ‰€æœ‰å†…ç½®å‡½æ•°ï¼ˆå¦‚æ—¥æœŸã€æ—¶é—´ã€æ•°å­¦å‡½æ•°ç­‰ï¼‰ã€‚</p><p>å­˜å‚¨å¼•æ“å±‚è´Ÿè´£æ•°æ®çš„å­˜å‚¨å’Œæå–ã€‚</p><p><code>from</code> -&gt; <code>where</code> -&gt; <code>group by</code> -&gt; <code>having</code> -&gt; <code>select</code> -&gt; <code>distinct</code> -&gt; <code>order by</code> -&gt; <code>limit</code></p><img src="/post/32511a71/1726212535664-4bb3f3ff-704a-4706-84c8-a046a8486657.webp" class="" title="img"><h3 id="EXPLAIN-å­—æ®µè¯´æ˜"><a href="#EXPLAIN-å­—æ®µè¯´æ˜" class="headerlink" title="EXPLAIN å­—æ®µè¯´æ˜"></a><code>EXPLAIN</code> å­—æ®µè¯´æ˜</h3><p>é€šå¸¸<code>EXPALIN</code>æŸ¥è¯¢è¯­å¥çš„è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;id&quot;: 1, // æ¯ä¸ªselectè¯­å¥å¯¹åº”ä¸€ä¸ªå”¯ä¸€çš„id</span><br><span class="line">    /**</span><br><span class="line">     * æŸ¥è¯¢ç±»å‹ï¼š</span><br><span class="line">     * SIMPLEï¼šä¸åŒ…å«UNIONæˆ–å­æŸ¥è¯¢çš„selectï¼ˆè¿æ¥æŸ¥è¯¢çš„æ¯ä¸ªæŸ¥è¯¢éƒ½æ˜¯simpleæŸ¥è¯¢ï¼‰</span><br><span class="line">     * PRIMARYï¼šæœ€å¤–å±‚æŸ¥è¯¢</span><br><span class="line">     * UNION</span><br><span class="line">     * ...</span><br><span class="line">     */</span><br><span class="line">    &quot;select_type&quot;: &quot;SIMPLE&quot;,</span><br><span class="line">    &quot;table&quot;: &quot;users&quot;, // è¦æŸ¥è¯¢çš„è¡¨</span><br><span class="line">    &quot;partitions&quot;: null, // åˆ†åŒºä¿¡æ¯</span><br><span class="line">    /**</span><br><span class="line">     * é’ˆå¯¹å•è¡¨çš„è®¿é—®æ–¹æ³•ï¼š</span><br><span class="line">     * systemï¼šå½“è¡¨ä¸­åªæœ‰ä¸€æ¡è®°å½•ï¼Œå¹¶ä¸”è¯¥è¡¨ä½¿ç”¨çš„å­˜å‚¨å¼•æ“çš„ç»Ÿè®¡æ•°æ®æ˜¯ç²¾ç¡®çš„ï¼Œè®¿é—®æ–¹æ³•å°±æ˜¯system</span><br><span class="line">     * constantï¼šæ ¹æ®ä¸»é”®æˆ–å”¯ä¸€ç´¢å¼•åˆ—ä¸å¸¸æ•°è¿›è¡Œç­‰å€¼åŒ¹é…æ—¶ï¼Œè®¿é—®æ–¹æ³•å°±æ˜¯const</span><br><span class="line">     * eq_refï¼šè¿æ¥æŸ¥è¯¢ä¸­å¯¹è¢«é©±åŠ¨è¡¨çš„ä¸»é”®æˆ–ä¸å…è®¸ä¸ºNULLçš„å”¯ä¸€ç´¢å¼•è¿›è¡Œç­‰å€¼æŸ¥è¯¢æ—¶ï¼Œè®¿é—®æ–¹æ³•å°±æ˜¯eq_ref</span><br><span class="line">     * refï¼šé€šè¿‡æ™®é€šäºŒçº§ç´¢å¼•åˆ—ä¸å¸¸é‡è¿›è¡Œç­‰å€¼åŒ¹é…æ—¶ï¼Œå¯¹è¯¥è¡¨çš„è®¿é—®æ–¹æ³•å°±æ˜¯ ref</span><br><span class="line">     * ref_or_nullï¼šselect * from single_table where key1 = &#x27;abc&#x27; or key1 is NULL;</span><br><span class="line">     * index_mergeï¼šä½¿ç”¨å¤šä¸ªç´¢å¼•è¿›è¡Œç­‰å€¼åŒ¹é…</span><br><span class="line">     * unique_subqueryï¼šåœ¨å­æŸ¥è¯¢ä¸­ä½¿ç”¨ä¸»é”®æˆ–ä¸å…è®¸å­˜å‚¨NULLå€¼çš„å”¯ä¸€äºŒçº§ç´¢å¼•è¿›è¡Œç­‰å€¼åŒ¹é…</span><br><span class="line">     * index_subqueryï¼šåœ¨å­æŸ¥è¯¢ä¸­ä½¿ç”¨æ™®é€šäºŒçº§ç´¢å¼•è¿›è¡Œç­‰å€¼åŒ¹</span><br><span class="line">     * rangeï¼šåˆ©ç”¨ç´¢å¼•è¿›è¡ŒèŒƒå›´æŸ¥è¯¢</span><br><span class="line">     * indexï¼šå½“å¯ä»¥ä½¿ç”¨ç´¢å¼•è¦†ç›–ï¼Œä½†éœ€è¦æ‰«æå…¨éƒ¨ç´¢å¼•è®°å½•</span><br><span class="line">     * allï¼šå…¨è¡¨æ‰«æ</span><br><span class="line">     * </span><br><span class="line">     */</span><br><span class="line">    &quot;type&quot;: &quot;ref&quot;, </span><br><span class="line">    &quot;possible_keys&quot;: &quot;idx_composite&quot;, // å¯èƒ½ä½¿ç”¨çš„ç´¢å¼•</span><br><span class="line">    &quot;key&quot;: &quot;idx_composite&quot;, // å®é™…ä½¿ç”¨çš„ç´¢å¼•</span><br><span class="line">    &quot;key_len&quot;: &quot;208&quot;, // å®é™…ä½¿ç”¨çš„ç´¢å¼•é•¿åº¦</span><br><span class="line">    &quot;ref&quot;: &quot;const&quot;, // ä½¿ç”¨ç´¢å¼•åˆ—ç­‰å€¼æŸ¥è¯¢æ—¶ï¼Œä¸ç´¢å¼•åˆ—è¿›è¡Œç­‰å€¼åŒ¹é…çš„å¯¹è±¡ä¿¡æ¯</span><br><span class="line">    &quot;rows&quot;: 1, // é¢„ä¼°éœ€è¦è¯»å–çš„è®°å½•è¡Œæ•°</span><br><span class="line">    &quot;filtered&quot;: 100.0, // è¿‡æ»¤åå‰©ä½™è®°å½•è¡Œæ•°ç™¾åˆ†æ¯”</span><br><span class="line">    /**</span><br><span class="line">     * é¢å¤–ä¿¡æ¯ï¼š</span><br><span class="line">     * Using indexï¼šä½¿ç”¨è¦†ç›–ç´¢å¼•</span><br><span class="line">     * Using index conditionï¼šä½¿ç”¨ç´¢å¼•æ¡ä»¶ä¸‹æ¨</span><br><span class="line">     * Using whereï¼šéœ€è¦åœ¨serverå±‚åˆ¤æ–­æ¡ä»¶æ˜¯å¦æˆç«‹</span><br><span class="line">     * Using join bufferï¼šæ‰§è¡Œè¿æ¥æŸ¥è¯¢æ—¶ï¼Œè¢«é©±åŠ¨è¡¨ä¸èƒ½æœ‰æ•ˆåˆ©ç”¨ç´¢å¼•åŠ å¿«è®¿é—®é€Ÿåº¦æ—¶ï¼Œä¼šåˆ†é…ä¸€å—å†…å­˜ç”¨æ¥ä¿å­˜è¢«é©±åŠ¨è¡¨çš„æŸ¥è¯¢ç»“æœï¼Œ</span><br><span class="line">       åˆ©ç”¨join bufferå¯ä»¥å‡å°‘è®¿é—®è¢«é©±åŠ¨è¡¨çš„æ¬¡æ•°</span><br><span class="line">     * Using filesortï¼š</span><br><span class="line">     * Using temporary</span><br><span class="line">     */</span><br><span class="line">    &quot;Extra&quot;: &quot;Using index&quot;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h3 id="ä¸€æ¡æŸ¥è¯¢è¯­å¥çš„æ‰§è¡Œæµç¨‹"><a href="#ä¸€æ¡æŸ¥è¯¢è¯­å¥çš„æ‰§è¡Œæµç¨‹" class="headerlink" title="ä¸€æ¡æŸ¥è¯¢è¯­å¥çš„æ‰§è¡Œæµç¨‹"></a>ä¸€æ¡æŸ¥è¯¢è¯­å¥çš„æ‰§è¡Œæµç¨‹</h3><h3 id="ä¸€æ¡æ›´æ–°è¯­å¥çš„æ‰§è¡Œæµç¨‹"><a href="#ä¸€æ¡æ›´æ–°è¯­å¥çš„æ‰§è¡Œæµç¨‹" class="headerlink" title="ä¸€æ¡æ›´æ–°è¯­å¥çš„æ‰§è¡Œæµç¨‹"></a>ä¸€æ¡æ›´æ–°è¯­å¥çš„æ‰§è¡Œæµç¨‹</h3><p>ä¸€æ¡ <code>UPDATE</code> è¯­å¥åœ¨ MySQLï¼ˆå°¤å…¶æ˜¯ InnoDB å­˜å‚¨å¼•æ“ï¼‰ä¸­çš„æ‰§è¡Œè¿‡ç¨‹æ˜¯ä¸€ä¸ªæ¶‰åŠå¤šä¸ªç»„ä»¶ï¼ˆè§£æå™¨ã€ä¼˜åŒ–å™¨ã€æ‰§è¡Œå¼•æ“ã€å­˜å‚¨å¼•æ“ã€ç¼“å†²æ± ã€æ—¥å¿—ç³»ç»Ÿã€é”æœºåˆ¶ç­‰ï¼‰ååŒå·¥ä½œçš„å¤æ‚è¿‡ç¨‹ã€‚ä¸‹é¢æ˜¯å…¶æ ¸å¿ƒæ­¥éª¤çš„è¯¦ç»†åˆ†è§£ï¼š</p><ol><li><strong>è¿æ¥ä¸è¯·æ±‚æ¥æ”¶</strong></li></ol><ul><li>å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºï¼ˆå¦‚ Java ç¨‹åºã€MySQL CLIï¼‰é€šè¿‡è¿æ¥å™¨å»ºç«‹ä¸ MySQL æœåŠ¡å™¨çš„è¿æ¥ã€‚</li><li>æœåŠ¡å™¨éªŒè¯ç”¨æˆ·èº«ä»½å’Œæƒé™ã€‚</li><li>å®¢æˆ·ç«¯å‘é€ <code>UPDATE</code> SQL è¯­å¥åˆ°æœåŠ¡å™¨ã€‚</li></ul><ol start="2"><li><strong>è§£æä¸ä¼˜åŒ–ï¼ˆServer å±‚ï¼‰</strong></li></ol><ul><li><strong>è§£æå™¨ï¼š</strong><ul><li>è¿›è¡Œè¯æ³•åˆ†æï¼šè¯†åˆ« <code>UPDATE</code>ã€è¡¨åã€<code>SET</code>ã€åˆ—åã€<code>=</code>ã€å€¼ã€<code>WHERE</code> ç­‰å…³é”®å­—å’Œæ ‡è¯†ç¬¦ã€‚</li><li>è¿›è¡Œè¯­æ³•åˆ†æï¼šæ£€æŸ¥è¯­å¥æ˜¯å¦ç¬¦åˆ SQL è¯­æ³•è§„åˆ™ï¼Œæ„å»ºæŠ½è±¡è¯­æ³•æ ‘ã€‚</li></ul></li><li><strong>é¢„å¤„ç†å™¨ï¼š</strong><ul><li>æ£€æŸ¥è¡¨å’Œåˆ—æ˜¯å¦å­˜åœ¨ã€‚</li><li>è§£æåç§°å’Œåˆ«åã€‚</li><li>æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æ‰§è¡Œ <code>UPDATE</code> çš„æƒé™ã€‚</li></ul></li><li><strong>ä¼˜åŒ–å™¨ï¼š</strong><ul><li><strong>å…³é”®æ­¥éª¤ï¼</strong> åŸºäºç»Ÿè®¡ä¿¡æ¯ï¼ˆè¡¨å¤§å°ã€ç´¢å¼•åˆ†å¸ƒã€åŸºæ•°ç­‰ï¼‰é€‰æ‹©å®ƒè®¤ä¸ºæœ€é«˜æ•ˆçš„æ‰§è¡Œè®¡åˆ’ã€‚</li><li>å†³å®šï¼š<ul><li>ä½¿ç”¨å“ªä¸ªç´¢å¼•ï¼ˆä¸»é”®ç´¢å¼•ã€äºŒçº§ç´¢å¼•ï¼‰æ¥å®šä½éœ€è¦æ›´æ–°çš„è¡Œã€‚è¿™æ˜¯å½±å“é€Ÿåº¦çš„å…³é”®å› ç´ ã€‚</li><li>æ˜¯å¦å¯ä»¥ä½¿ç”¨ç´¢å¼•æ¡ä»¶ä¸‹æ¨ã€‚</li><li>æ˜¯å¦éœ€è¦è¿›è¡Œå…¨è¡¨æ‰«æï¼ˆå¦‚æœ <code>WHERE</code> æ¡ä»¶æ— æ³•æœ‰æ•ˆåˆ©ç”¨ç´¢å¼•ï¼‰ã€‚</li></ul></li><li>ç”Ÿæˆå…·ä½“çš„æ‰§è¡Œè®¡åˆ’ã€‚</li></ul></li></ul><ol start="3"><li><strong>æ‰§è¡Œå¼•æ“è°ƒç”¨å­˜å‚¨å¼•æ“ï¼ˆServer å±‚ -&gt; å­˜å‚¨å¼•æ“å±‚ï¼‰</strong></li></ol><ul><li>æ‰§è¡Œå¼•æ“æ ¹æ®ä¼˜åŒ–å™¨é€‰æ‹©çš„æ‰§è¡Œè®¡åˆ’ï¼Œè°ƒç”¨å­˜å‚¨å¼•æ“ï¼ˆInnoDBï¼‰æä¾›çš„æ¥å£æ¥æ‰§è¡Œå®é™…çš„æ•°æ®æŸ¥æ‰¾å’Œä¿®æ”¹æ“ä½œã€‚</li></ul><ol start="4"><li><strong>InnoDB å­˜å‚¨å¼•æ“å†…éƒ¨å¤„ç†</strong></li></ol><ul><li><strong>ç¼“å†²æ± æŸ¥æ‰¾ï¼š</strong><ul><li>æ‰§è¡Œå¼•æ“å‘ŠçŸ¥ InnoDB è¦æ›´æ–°å“ªäº›è¡Œï¼ˆé€šè¿‡ <code>WHERE</code> æ¡ä»¶å®šä½ï¼‰ã€‚</li><li>InnoDB é¦–å…ˆåœ¨ <strong>Buffer Poolï¼ˆç¼“å†²æ± ï¼‰</strong> ä¸­æŸ¥æ‰¾è¿™äº›è¡Œæ‰€åœ¨çš„æ•°æ®é¡µã€‚</li><li>å¦‚æœæ•°æ®é¡µä¸åœ¨ Buffer Pool ä¸­ï¼Œåˆ™ä»ç£ç›˜ä¸Šçš„ <code>.ibd</code> æ•°æ®æ–‡ä»¶ä¸­å°†å…¶åŠ è½½åˆ° Buffer Poolã€‚</li></ul></li><li><strong>å†™ Undo Logï¼š</strong><ul><li><strong>å…³é”®æ­¥éª¤ï¼</strong> åœ¨ä¿®æ”¹ Buffer Pool ä¸­çš„æ•°æ®é¡µ<strong>ä¹‹å‰</strong>ï¼ŒInnoDB ä¼šå…ˆå°†è¿™è¡Œæ•°æ®çš„æ—§ç‰ˆæœ¬ï¼ˆä¿®æ”¹å‰çš„çŠ¶æ€ï¼‰å†™å…¥ <strong>Undo Logï¼ˆå›æ»šæ—¥å¿—ï¼‰</strong>ã€‚</li><li><strong>ç›®çš„ï¼š</strong><ul><li>æ”¯æŒäº‹åŠ¡å›æ»šï¼šå¦‚æœäº‹åŠ¡éœ€è¦å›æ»šï¼Œå¯ä»¥ç”¨ Undo Log ä¸­çš„æ—§æ•°æ®è¦†ç›–ä¿®æ”¹ã€‚</li><li>å®ç° MVCCï¼šå…¶ä»–å¹¶å‘äº‹åŠ¡å¦‚æœéœ€è¦è¯»å–è¿™è¡Œæ•°æ®çš„æ—§ç‰ˆæœ¬ï¼ˆåŸºäºå®ƒä»¬çš„ Read Viewï¼‰ï¼Œå¯ä»¥é€šè¿‡ Undo Log é“¾æ‰¾åˆ°ã€‚</li></ul></li><li>Undo Log å­˜å‚¨åœ¨ Undo Tablespaces ä¸­ã€‚</li></ul></li><li><strong>ä¿®æ”¹ Buffer Poolï¼š</strong><ul><li>å°† Buffer Pool ä¸­å¯¹åº”çš„æ•°æ®é¡µä¸­çš„è¡Œæ•°æ®æ›´æ–°ä¸ºæ–°å€¼ã€‚</li><li>æ­¤æ—¶æ•°æ®é¡µå˜æˆ<strong>è„é¡µ</strong>ï¼ˆå†…å­˜ä¸­çš„æ•°æ®ä¸ç£ç›˜æ•°æ®ä¸ä¸€è‡´ï¼‰ã€‚</li></ul></li><li><strong>å†™ Redo Log Bufferï¼š</strong><ul><li><strong>å…³é”®æ­¥éª¤ï¼</strong> åœ¨è„é¡µåˆ·ç›˜<strong>ä¹‹å‰</strong>ï¼ŒInnoDB ä¼šå…ˆæŠŠå¯¹æ•°æ®é¡µæ‰€åšçš„ç‰©ç†ä¿®æ”¹ï¼ˆå­—èŠ‚çº§åˆ«çš„å˜åŒ–ï¼‰è®°å½•åˆ°å†…å­˜ä¸­çš„ <strong>Redo Log Bufferï¼ˆé‡åšæ—¥å¿—ç¼“å†²åŒºï¼‰</strong>ã€‚</li><li><strong>ç›®çš„ï¼š</strong> ä¿è¯äº‹åŠ¡çš„æŒä¹…æ€§ã€‚å³ä½¿ç³»ç»Ÿå´©æºƒï¼Œé‡å¯åä¹Ÿèƒ½æ ¹æ® Redo Log é‡åšæœªæŒä¹…åŒ–çš„ä¿®æ”¹ã€‚</li></ul></li></ul><ol start="5"><li><strong>äº‹åŠ¡æäº¤ï¼ˆå…³é”®æ­¥éª¤ï¼ï¼‰</strong></li></ol><ul><li>å½“ç”¨æˆ·æ˜¾å¼æ‰§è¡Œ <code>COMMIT</code> æˆ–è‡ªåŠ¨æäº¤å¼€å¯æ—¶ï¼Œäº‹åŠ¡è¿›å…¥æäº¤é˜¶æ®µã€‚</li><li><strong>Write Redo Logï¼š</strong><ul><li><strong>ä¸¤é˜¶æ®µæäº¤çš„æ ¸å¿ƒç¬¬ä¸€æ­¥ï¼š</strong> å°† Redo Log Buffer ä¸­ä¸è¯¥äº‹åŠ¡ç›¸å…³çš„æ‰€æœ‰æ—¥å¿—è®°å½•<strong>é¡ºåºã€å¿«é€Ÿ</strong>åœ°å†™å…¥ç£ç›˜ä¸Šçš„ <strong>Redo Log Fileï¼ˆé€šå¸¸æ˜¯ <code>ib_logfile0</code>, <code>ib_logfile1</code>ï¼‰</strong>ã€‚</li><li><strong><code>fsync()</code>ï¼š</strong> ä¸ºäº†ç¡®ä¿æ—¥å¿—çœŸæ­£è½ç›˜ï¼ˆé˜²æ­¢æ“ä½œç³»ç»Ÿç¼“å­˜ä¸¢å¤±ï¼‰ï¼Œé€šå¸¸éœ€è¦è°ƒç”¨ <code>fsync()</code>ï¼ˆæˆ–é…ç½®å†³å®šçš„ç±»ä¼¼æœºåˆ¶ï¼‰å¼ºåˆ¶å°†æ–‡ä»¶ç³»ç»Ÿç¼“å­˜ä¸­çš„æ—¥å¿—æ•°æ®åˆ·åˆ°ç‰©ç†ç£ç›˜ã€‚<strong>è¿™æ˜¯ä¿è¯æŒä¹…æ€§ï¼ˆDï¼‰çš„å…³é”®ç‚¹ï¼Œä¹Ÿæ˜¯ç›¸å¯¹è€—æ—¶çš„æ“ä½œã€‚</strong></li></ul></li><li><strong>å†™ Binlogï¼ˆå¦‚æœå¯ç”¨ï¼‰ï¼š</strong><ul><li>åœ¨å†™å…¥ Redo Log <strong>ä¹‹å</strong>ï¼ŒServer å±‚ä¼šå°†æ›´æ–°æ“ä½œçš„é€»è¾‘è¯­å¥æˆ–è¡Œå˜æ›´å†™å…¥ <strong>Binlogï¼ˆäºŒè¿›åˆ¶æ—¥å¿—ï¼‰</strong>ã€‚Binlog ç”¨äºä¸»ä»å¤åˆ¶å’Œæ•°æ®æ¢å¤ã€‚</li><li>åŒæ ·éœ€è¦ <code>fsync()</code> ç¡®ä¿ Binlog è½ç›˜ï¼ˆå–å†³äº <code>sync_binlog</code> é…ç½®ï¼‰ã€‚</li></ul></li><li><strong>Redo Log Commitï¼š</strong><ul><li><strong>ä¸¤é˜¶æ®µæäº¤çš„æ ¸å¿ƒç¬¬äºŒæ­¥ï¼š</strong> åœ¨ Binlog æˆåŠŸå†™å…¥å¹¶ <code>fsync()</code> åï¼ŒInnoDB åœ¨ Redo Log ä¸­å†™å…¥ä¸€ä¸ªç‰¹æ®Šçš„ <strong>Commit Record</strong>ï¼Œæ ‡è®°è¯¥äº‹åŠ¡<strong>å·²æäº¤</strong>ã€‚</li><li>å†æ¬¡ <code>fsync()</code> Redo Logï¼ˆå¦‚æœé…ç½®éœ€è¦ï¼‰ã€‚</li></ul></li><li><strong>é‡Šæ”¾é”ï¼š</strong> äº‹åŠ¡æäº¤åï¼ŒInnoDB é‡Šæ”¾è¯¥äº‹åŠ¡æŒæœ‰çš„æ‰€æœ‰é”ï¼ˆè¡Œé”ã€é—´éš™é”ç­‰ï¼‰ã€‚</li><li><strong>è¿”å›æˆåŠŸï¼š</strong> å‘å®¢æˆ·ç«¯è¿”å›æ‰§è¡ŒæˆåŠŸçš„æ¶ˆæ¯ã€‚</li></ul><ol start="6"><li><strong>åå°åˆ·è„é¡µ</strong></li></ol><ul><li><strong>éåŒæ­¥æ“ä½œï¼</strong> æäº¤æˆåŠŸ<strong>å¹¶ä¸ä¿è¯</strong>è„é¡µç«‹å³å†™å…¥ç£ç›˜æ•°æ®æ–‡ä»¶ï¼ˆ<code>.ibd</code>ï¼‰ã€‚å†™å…¥ Redo Log å·²ç»ä¿è¯äº†æŒä¹…æ€§ã€‚</li><li>InnoDB æœ‰åå°çº¿ç¨‹ï¼ˆPage Cleaner Threadï¼‰è´Ÿè´£åœ¨ä»¥ä¸‹æ—¶æœºå°†è„é¡µå¼‚æ­¥åˆ·æ–°å›ç£ç›˜ï¼š<ul><li>å½“ Buffer Pool ä¸­è„é¡µæ¯”ä¾‹è¿‡é«˜æ—¶ï¼ˆç”± <code>innodb_max_dirty_pages_pct</code> ç­‰å‚æ•°æ§åˆ¶ï¼‰ã€‚</li><li>å½“ç³»ç»Ÿç©ºé—²æ—¶ã€‚</li><li>å½“ Redo Log ç©ºé—´å³å°†ç”¨å®Œæ—¶ï¼ˆéœ€è¦å›æ”¶æ—§çš„ Redo Log ç©ºé—´ï¼Œè¿™è¦æ±‚å¯¹åº”çš„è„é¡µå¿…é¡»å…ˆåˆ·ç›˜ï¼‰ã€‚</li><li>å…³é—­æ•°æ®åº“æ—¶ã€‚</li></ul></li></ul><p><strong>å…³é”®ç‚¹ä¸æ³¨æ„äº‹é¡¹</strong></p><ol><li><strong>Buffer Pool æ ¸å¿ƒä½œç”¨ï¼š</strong> æ‰€æœ‰æ•°æ®è¯»å†™éƒ½å‘ç”Ÿåœ¨å†…å­˜ï¼ˆBuffer Poolï¼‰ï¼Œæå¤§æå‡æ€§èƒ½ã€‚</li><li><strong>WAL æœºåˆ¶ï¼š</strong> Write-Ahead Logging (Redo Log) æ˜¯ä¿è¯æŒä¹…æ€§å’Œå´©æºƒæ¢å¤çš„æ ¸å¿ƒã€‚å…ˆå†™æ—¥å¿—ï¼ˆé¡ºåºå†™ï¼Œå¿«ï¼‰ï¼Œååˆ·è„é¡µï¼ˆéšæœºå†™ï¼Œæ…¢ï¼‰ã€‚</li><li><strong>ä¸¤é˜¶æ®µæäº¤ï¼š</strong> åè°ƒ Redo Log å’Œ Binlog çš„å†™å…¥ï¼Œä¿è¯è¿™ä¸¤ä¸ªå…³é”®æ—¥å¿—åœ¨å´©æºƒæ—¶çŠ¶æ€ä¸€è‡´ï¼Œæ˜¯æ•°æ®ä¸€è‡´æ€§å’Œä¸»ä»å¤åˆ¶çš„åŸºçŸ³ã€‚</li><li><strong>Undo Log ä¸ MVCCï¼š</strong> Undo Log æ”¯æŒå›æ»šå’Œå®ç°éé”å®šè¯»ï¼ˆMVCCï¼‰ï¼Œæ˜¯å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶çš„å…³é”®ã€‚</li><li><strong>å¼‚æ­¥åˆ·ç›˜ï¼š</strong> æ•°æ®æ–‡ä»¶ï¼ˆ.ibdï¼‰çš„å†™å…¥æ˜¯å¼‚æ­¥çš„ï¼Œä¾èµ–äº Redo Log ä¿è¯æŒä¹…æ€§ã€‚</li></ol><h3 id="count-ã€count-1-ã€count-id-ã€count-å­—æ®µ-æœ‰ä»€ä¹ˆåŒºåˆ«"><a href="#count-ã€count-1-ã€count-id-ã€count-å­—æ®µ-æœ‰ä»€ä¹ˆåŒºåˆ«" class="headerlink" title="count(*)ã€count(1)ã€count(id)ã€count(å­—æ®µ)æœ‰ä»€ä¹ˆåŒºåˆ«"></a><code>count(*)ã€count(1)ã€count(id)ã€count(å­—æ®µ)</code>æœ‰ä»€ä¹ˆåŒºåˆ«</h3><table><thead><tr><th><strong>è¯­æ³•</strong></th><th><strong>ç»Ÿè®¡é€»è¾‘</strong></th><th><strong>æ˜¯å¦åŒ…å« NULL</strong></th></tr></thead><tbody><tr><td><code>COUNT(*)</code></td><td>ç»Ÿè®¡æ‰€æœ‰è¡Œï¼ˆåŒ…æ‹¬æ‰€æœ‰åˆ—ï¼‰ï¼Œå³ä½¿æ‰€æœ‰å­—æ®µéƒ½ä¸º <code>NULL</code> ä¹Ÿä¼šè®¡æ•°</td><td><strong>åŒ…å«</strong></td></tr><tr><td><code>COUNT(1)</code></td><td>ç»Ÿè®¡æ‰€æœ‰è¡Œï¼ˆ<code>1</code> æ˜¯å¸¸é‡è¡¨è¾¾å¼ï¼Œä¸åˆ—æ— å…³ï¼‰</td><td><strong>åŒ…å«</strong></td></tr><tr><td><code>COUNT(id)</code></td><td>ç»Ÿè®¡ <code>id</code> åˆ—ä¸­ <strong>é NULL</strong> çš„è¡Œæ•°ï¼ˆ<code>id</code> æ˜¯ä¸»é”®æˆ–æ™®é€šåˆ—ï¼‰</td><td><strong>ä¸åŒ…å« NULL</strong></td></tr><tr><td><code>COUNT(æŸä¸ªå­—æ®µ)</code></td><td>ç»Ÿè®¡è¯¥å­—æ®µä¸­ <strong>é NULL</strong> çš„è¡Œæ•°ï¼ˆå¦‚æœå­—æ®µå…è®¸ <code>NULL</code>ï¼‰</td><td><strong>ä¸åŒ…å« NULL</strong></td></tr></tbody></table><p>æ€§èƒ½ï¼š<code>count(å­—æ®µ)</code> &lt; <code>count(ä¸»é”®)</code> &lt; <code>count(1)</code> â‰ˆ <code>count(*)</code></p><p><code>count(ä¸»é”®/å­—æ®µ)</code> çš„æ•ˆç‡æ›´ä½çš„åŸå› æ˜¯éœ€è¦è§£ææ•°æ®è¡Œï¼Œå¹¶æ‹·è´è¦è¿”å›çš„å­—æ®µå€¼ã€‚</p><h3 id="å½“OFFSETå€¼å¾ˆå¤§æ—¶ï¼ˆå¦‚LIMIT-100000-10ï¼‰ï¼Œä¸ºä»€ä¹ˆæŸ¥è¯¢ä¼šå˜æ…¢"><a href="#å½“OFFSETå€¼å¾ˆå¤§æ—¶ï¼ˆå¦‚LIMIT-100000-10ï¼‰ï¼Œä¸ºä»€ä¹ˆæŸ¥è¯¢ä¼šå˜æ…¢" class="headerlink" title="å½“OFFSETå€¼å¾ˆå¤§æ—¶ï¼ˆå¦‚LIMIT 100000, 10ï¼‰ï¼Œä¸ºä»€ä¹ˆæŸ¥è¯¢ä¼šå˜æ…¢"></a>å½“<code>OFFSET</code>å€¼å¾ˆå¤§æ—¶ï¼ˆå¦‚<code>LIMIT 100000, 10</code>ï¼‰ï¼Œä¸ºä»€ä¹ˆæŸ¥è¯¢ä¼šå˜æ…¢</h3><ul><li><p><strong>åŸå› </strong>ï¼šMySQLéœ€å…ˆæ‰«æå¹¶è·³è¿‡<code>offset + limit</code>è¡Œï¼Œå†è¿”å›ç»“æœã€‚</p></li><li><p><strong>ä¼˜åŒ–æ–¹æ¡ˆ</strong>ï¼š</p><ol><li><p><strong>è®°å½•ä¸Šä¸€é¡µæœ€åä¸€æ¡æ•°æ®çš„ID</strong>ï¼ˆæ¨èï¼‰ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders </span><br><span class="line"><span class="keyword">WHERE</span> id <span class="operator">&gt;</span> last_seen_id  <span class="comment">-- ä¸Šä¸€é¡µæœ€åä¸€æ¡è®°å½•çš„ID</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> id LIMIT <span class="number">10</span>;</span><br></pre></td></tr></table></figure></li><li><p><strong>å­æŸ¥è¯¢</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> </span><br><span class="line"><span class="keyword">FROM</span> orders </span><br><span class="line"><span class="keyword">WHERE</span> id <span class="operator">&gt;=</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> id <span class="keyword">FROM</span> orders <span class="keyword">ORDER</span> <span class="keyword">BY</span> id LIMIT <span class="number">10000</span>, <span class="number">1</span></span><br><span class="line">) </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> id </span><br><span class="line">LIMIT <span class="number">10</span>;</span><br></pre></td></tr></table></figure></li></ol></li></ul><h3 id="åˆ†é¡µæ—¶ä¸ºä»€ä¹ˆå¿…é¡»æ­é…ORDER-BY"><a href="#åˆ†é¡µæ—¶ä¸ºä»€ä¹ˆå¿…é¡»æ­é…ORDER-BY" class="headerlink" title="åˆ†é¡µæ—¶ä¸ºä»€ä¹ˆå¿…é¡»æ­é…ORDER BY"></a>åˆ†é¡µæ—¶ä¸ºä»€ä¹ˆå¿…é¡»æ­é…<code>ORDER BY</code></h3><ul><li><p>ç¼ºå°‘<code>ORDER BY</code>æ—¶ï¼ŒMySQLè¿”å›ç»“æœçš„é¡ºåºä¸ç¡®å®šï¼Œå¯¼è‡´åˆ†é¡µç»“æœæ··ä¹±ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> products <span class="keyword">ORDER</span> <span class="keyword">BY</span> price <span class="keyword">DESC</span> LIMIT <span class="number">0</span>, <span class="number">10</span>;</span><br></pre></td></tr></table></figure></li></ul><h3 id="IN-å’Œ-EXISTS-çš„åŒºåˆ«"><a href="#IN-å’Œ-EXISTS-çš„åŒºåˆ«" class="headerlink" title="IN å’Œ EXISTS çš„åŒºåˆ«"></a><code>IN</code> å’Œ <code>EXISTS</code> çš„åŒºåˆ«</h3><p>å½“ä½¿ç”¨ <code>IN</code> æ—¶ï¼ŒMySQL ä¼šé¦–å…ˆæ‰§è¡Œå­æŸ¥è¯¢ï¼Œç„¶åå°†å­æŸ¥è¯¢çš„ç»“æœé›†ç”¨äºå¤–éƒ¨æŸ¥è¯¢çš„æ¡ä»¶ã€‚è¿™æ„å‘³ç€å­æŸ¥è¯¢çš„ç»“æœé›†è¦å…¨éƒ¨åŠ è½½åˆ°å†…å­˜ã€‚</p><p>è€Œ <code>EXISTS</code> ä¼šå¯¹å¤–éƒ¨æŸ¥è¯¢çš„æ¯ä¸€è¡Œï¼Œæ‰§è¡Œä¸€æ¬¡å­æŸ¥è¯¢ã€‚å¦‚æœå­æŸ¥è¯¢è¿”å›ä»»ä½•è¡Œï¼Œåˆ™ <code>EXISTS</code> æ¡ä»¶ä¸ºçœŸã€‚<code>EXISTS</code> å…³æ³¨çš„æ˜¯å­æŸ¥è¯¢æ˜¯å¦è¿”å›è¡Œï¼Œè€Œä¸æ˜¯è¿”å›çš„å…·ä½“å€¼ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- IN çš„ä¸´æ—¶è¡¨å¯èƒ½æˆä¸ºæ€§èƒ½ç“¶é¢ˆ</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users </span><br><span class="line"><span class="keyword">WHERE</span> id <span class="keyword">IN</span> (<span class="keyword">SELECT</span> user_id <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> amount <span class="operator">&gt;</span> <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- EXISTS å¯ä»¥åˆ©ç”¨å…³è”ç´¢å¼•</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users u</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">EXISTS</span> (<span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">FROM</span> orders o </span><br><span class="line">            <span class="keyword">WHERE</span> o.user_id <span class="operator">=</span> u.id <span class="keyword">AND</span> o.amount <span class="operator">&gt;</span> <span class="number">100</span>);</span><br></pre></td></tr></table></figure><p><code>IN</code> é€‚ç”¨äºå­æŸ¥è¯¢ç»“æœé›†è¾ƒå°çš„æƒ…å†µã€‚å¦‚æœå­æŸ¥è¯¢è¿”å›å¤§é‡æ•°æ®ï¼Œ<code>IN</code> çš„æ€§èƒ½å¯èƒ½ä¼šä¸‹é™ï¼Œå› ä¸ºå®ƒéœ€è¦å°†æ•´ä¸ªç»“æœé›†åŠ è½½åˆ°å†…å­˜ã€‚</p><p>è€Œ EXISTS é€‚ç”¨äºå­æŸ¥è¯¢ç»“æœé›†å¯èƒ½å¾ˆå¤§çš„æƒ…å†µã€‚ç”±äº <code>EXISTS</code> åªéœ€è¦åˆ¤æ–­å­æŸ¥è¯¢æ˜¯å¦è¿”å›è¡Œï¼Œè€Œä¸éœ€è¦åŠ è½½æ•´ä¸ªç»“æœé›†ï¼Œå› æ­¤åœ¨æŸäº›æƒ…å†µä¸‹æ€§èƒ½æ›´å¥½ï¼Œç‰¹åˆ«æ˜¯å½“å­æŸ¥è¯¢å¯ä»¥ä½¿ç”¨ç´¢å¼•æ—¶ã€‚</p><h2 id="ç´¢å¼•"><a href="#ç´¢å¼•" class="headerlink" title="ç´¢å¼•"></a>ç´¢å¼•</h2><h3 id="ä»€ä¹ˆæ˜¯å›è¡¨ã€è¦†ç›–ç´¢å¼•ã€æœ€å·¦å‰ç¼€åŸåˆ™å’Œç´¢å¼•ä¸‹æ¨"><a href="#ä»€ä¹ˆæ˜¯å›è¡¨ã€è¦†ç›–ç´¢å¼•ã€æœ€å·¦å‰ç¼€åŸåˆ™å’Œç´¢å¼•ä¸‹æ¨" class="headerlink" title="ä»€ä¹ˆæ˜¯å›è¡¨ã€è¦†ç›–ç´¢å¼•ã€æœ€å·¦å‰ç¼€åŸåˆ™å’Œç´¢å¼•ä¸‹æ¨"></a>ä»€ä¹ˆæ˜¯å›è¡¨ã€è¦†ç›–ç´¢å¼•ã€æœ€å·¦å‰ç¼€åŸåˆ™å’Œç´¢å¼•ä¸‹æ¨</h3><p><strong>å›è¡¨</strong>ï¼šè¦æŸ¥è¯¢çš„å­—æ®µæ²¡æœ‰å…¨éƒ¨åŒ…å«åœ¨ç´¢å¼•ä¸­ï¼Œéœ€è¦æ ¹æ®ç´¢å¼•æ‰¾åˆ°ä¸»é”®ï¼Œå†ä»ä¸»é”®ç´¢å¼•ä¸­æ‰¾åˆ°æ‰€éœ€å­—æ®µ ã€‚</p><p><strong>è¦†ç›–ç´¢å¼•</strong>ï¼šæŸ¥è¯¢æ‰€éœ€çš„å­—æ®µéƒ½åŒ…å«åœ¨ç´¢å¼•ä¸­ï¼Œæ— éœ€å›è¡¨æ“ä½œã€‚</p><p><strong>æœ€å·¦å‰ç¼€åŸåˆ™</strong>ï¼šå¤åˆç´¢å¼• <code>(a, b, c)</code> çš„æŸ¥è¯¢æ¡ä»¶å¿…é¡»ä»æœ€å·¦åˆ—å¼€å§‹ï¼Œä¸”ä¸èƒ½è·³è¿‡ä¸­é—´åˆ—æ‰èƒ½å‘½ä¸­ç´¢å¼•ã€‚</p><p><strong>ç´¢å¼•ä¸‹æ¨</strong>ï¼šå°†WHEREæ¡ä»¶ä¸­çš„è¿‡æ»¤æ“ä½œâ€ä¸‹æ¨â€åˆ°å­˜å‚¨å¼•æ“å±‚æ‰§è¡Œï¼Œå‡å°‘ä¸å¿…è¦çš„å›è¡¨æ“ä½œã€‚</p><h3 id="InnoDBç´¢å¼•ç»“æ„"><a href="#InnoDBç´¢å¼•ç»“æ„" class="headerlink" title="InnoDBç´¢å¼•ç»“æ„"></a>InnoDBç´¢å¼•ç»“æ„</h3><p><strong>InnoDBé€‰æ‹©B+æ ‘çš„7å¤§å…³é”®åŸå› </strong></p><table><thead><tr><th align="left"><strong>å¯¹æ¯”ç»´åº¦</strong></th><th align="left"><strong>Bæ ‘</strong></th><th align="left"><strong>B+æ ‘</strong></th><th align="left"><strong>InnoDBä¼˜åŠ¿ä½“ç°</strong></th></tr></thead><tbody><tr><td align="left"><strong>æ•°æ®å­˜å‚¨ä½ç½®</strong></td><td align="left">æ‰€æœ‰èŠ‚ç‚¹å­˜å‚¨æ•°æ®</td><td align="left">ä»…å¶å­èŠ‚ç‚¹å­˜å‚¨æ•°æ®</td><td align="left">å‡å°‘ç£ç›˜IOæ¬¡æ•°</td></tr><tr><td align="left"><strong>æ ‘é«˜åº¦</strong></td><td align="left">è¾ƒé«˜ï¼ˆæ•°æ®åˆ†æ•£å­˜å‚¨ï¼‰</td><td align="left">è¾ƒä½ï¼ˆå†…éƒ¨èŠ‚ç‚¹çº¯ç´¢å¼•ï¼‰</td><td align="left">3å±‚B+æ ‘å¯æ”¯æ’‘åƒä¸‡çº§æ•°æ®</td></tr><tr><td align="left"><strong>èŒƒå›´æŸ¥è¯¢</strong></td><td align="left">éœ€è¦å›æº¯çˆ¶èŠ‚ç‚¹</td><td align="left">é€šè¿‡å¶å­é“¾è¡¨é¡ºåºæ‰«æ</td><td align="left"><code>WHERE id &gt; 100</code> æ•ˆç‡æå‡10å€+</td></tr><tr><td align="left"><strong>å…¨è¡¨æ‰«æ</strong></td><td align="left">éœ€éå†æ•´æ£µæ ‘</td><td align="left">ç›´æ¥é¡ºåºéå†å¶å­èŠ‚ç‚¹é“¾è¡¨</td><td align="left">å…¨è¡¨æ‰«æé€Ÿåº¦æ¥è¿‘é¡ºåºè¯»</td></tr><tr><td align="left"><strong>ç£ç›˜åˆ©ç”¨ç‡</strong></td><td align="left">èŠ‚ç‚¹åŒ…å«æ•°æ®å¯¼è‡´å­˜å‚¨é”®å€¼æ•°å°‘</td><td align="left">å•é¡µå¯å­˜å‚¨æ›´å¤šé”®å€¼ï¼ˆé«˜åˆ†æ”¯å› å­ï¼‰</td><td align="left">ç›¸åŒæ•°æ®é‡å‡å°‘30%-50%æ ‘é«˜åº¦</td></tr><tr><td align="left"><strong>æ•°æ®æ›´æ–°ä»£ä»·</strong></td><td align="left">å¯èƒ½å¼•èµ·å¤æ‚ç»“æ„è°ƒæ•´</td><td align="left">æ’å…¥åˆ é™¤å¤šæ•°æƒ…å†µåªéœ€å±€éƒ¨è°ƒæ•´</td><td align="left">æ”¯æŒæ›´é«˜å¹¶å‘å†™å…¥</td></tr><tr><td align="left"><strong>ç¼“å­˜å‘½ä¸­ç‡</strong></td><td align="left">çƒ­ç‚¹æ•°æ®åˆ†æ•£åœ¨ä¸åŒå±‚çº§</td><td align="left">å¶å­èŠ‚ç‚¹é›†ä¸­å­˜å‚¨æ‰€æœ‰æ•°æ®</td><td align="left">Buffer Poolåˆ©ç”¨ç‡æå‡40%+</td></tr></tbody></table><h3 id="ç´¢å¼•è®¾è®¡åŸåˆ™"><a href="#ç´¢å¼•è®¾è®¡åŸåˆ™" class="headerlink" title="ç´¢å¼•è®¾è®¡åŸåˆ™"></a>ç´¢å¼•è®¾è®¡åŸåˆ™</h3><h3 id="ä¸ºä»€ä¹ˆæœ‰æ—¶ç´¢å¼•ä¼šå¤±æ•ˆæˆ–é€‰é”™ç´¢å¼•"><a href="#ä¸ºä»€ä¹ˆæœ‰æ—¶ç´¢å¼•ä¼šå¤±æ•ˆæˆ–é€‰é”™ç´¢å¼•" class="headerlink" title="ä¸ºä»€ä¹ˆæœ‰æ—¶ç´¢å¼•ä¼šå¤±æ•ˆæˆ–é€‰é”™ç´¢å¼•"></a>ä¸ºä»€ä¹ˆæœ‰æ—¶ç´¢å¼•ä¼šå¤±æ•ˆæˆ–é€‰é”™ç´¢å¼•</h3><p>ç´¢å¼•å¤±æ•ˆçš„å¸¸è§åœºæ™¯ï¼š</p><ul><li>ç»Ÿè®¡ä¿¡æ¯ä¸å‡†ç¡®ï¼Œè¯¯åˆ¤ç´¢å¼•æ•ˆç‡ï¼ˆæ‰‹åŠ¨æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼š<code>ANALYZE TABLE users;</code> ï¼‰</li><li>éœ€è¦å¤§é‡å›è¡¨æ“ä½œ</li><li>è¿åæœ€å·¦å‰ç¼€åŸåˆ™</li><li>å¯¹ç´¢å¼•åˆ—è¿›è¡Œè¿ç®—æˆ–å‡½æ•°æ“ä½œ</li><li>ä½¿ç”¨ <code>or</code> è¿æ¥éç´¢å¼•åˆ—</li><li>ä½¿ç”¨ <code>like &#39;%åœ°å€&#39;</code></li></ul><h3 id="WHERE-b-1-AND-c-2-ORDER-BY-a-èƒ½å¦ç”¨ä¸Šç»„åˆç´¢å¼•-a-b-c"><a href="#WHERE-b-1-AND-c-2-ORDER-BY-a-èƒ½å¦ç”¨ä¸Šç»„åˆç´¢å¼•-a-b-c" class="headerlink" title="WHERE b=1 AND c=2 ORDER BY a èƒ½å¦ç”¨ä¸Šç»„åˆç´¢å¼• (a, b, c)"></a><code>WHERE b=1 AND c=2 ORDER BY a</code> èƒ½å¦ç”¨ä¸Šç»„åˆç´¢å¼• <code>(a, b, c)</code></h3><p><strong>å¯ä»¥ï¼Œä½†æ˜¯æ•ˆç‡ä¸é«˜ï¼Œéœ€è¦æ‰«æå…¨ç´¢å¼•</strong>ã€‚</p><p>ä½¿ç”¨ç´¢å¼• <code>(a, b, c)</code> çš„æ‰§è¡Œè¿‡ç¨‹ï¼š</p><ol><li><strong>ç´¢å¼•æ‰«æ</strong>ï¼šç”±äº <code>WHERE</code> æ¡ä»¶ç¼ºå°‘æœ€å·¦åˆ— <code>a</code>ï¼Œæ— æ³•ä½¿ç”¨ç´¢å¼•<strong>æŸ¥æ‰¾</strong>ï¼Œåªèƒ½è¿›è¡Œ<strong>ç´¢å¼•å…¨æ‰«æ</strong></li><li><strong>è¿‡æ»¤æ¡ä»¶</strong>ï¼šæ‰«æè¿‡ç¨‹ä¸­å¯¹æ¯è¡Œç´¢å¼•è®°å½•æ£€æŸ¥ <code>b=1 AND c=2</code></li><li><strong>æ’åºå¤©ç„¶æ»¡è¶³</strong>ï¼šç”±äºç´¢å¼•æœ¬èº«å°±æ˜¯æŒ‰ <code>a</code> æ’åºçš„ï¼Œæ‰€ä»¥ <code>ORDER BY a</code> å¤©ç„¶æ»¡è¶³ï¼Œæ— éœ€é¢å¤–æ’åº</li></ol><h2 id="é”"><a href="#é”" class="headerlink" title="é”"></a>é”</h2><h3 id="InnoDBæœ‰å“ªå‡ ç±»é”"><a href="#InnoDBæœ‰å“ªå‡ ç±»é”" class="headerlink" title="InnoDBæœ‰å“ªå‡ ç±»é”"></a>InnoDBæœ‰å“ªå‡ ç±»é”</h3><ul><li><p><strong>è®°å½•é”ï¼ˆRecord Lockï¼‰</strong>ï¼šå•è¡Œè®°å½•ä¸Šçš„é”ã€‚</p></li><li><p><strong>é—´éš™é”ï¼ˆGap Lockï¼‰</strong>ï¼šé”å®šè®°å½•ä¹‹é—´çš„é—´éš™ï¼Œä¸é”å®šè®°å½•æœ¬èº«ã€‚é˜²æ­¢å¹»è¯»ã€‚</p></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- è¡¨æ•°æ®ï¼š5, 10, 15</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> id <span class="operator">&gt;</span> <span class="number">10</span> <span class="keyword">AND</span> id <span class="operator">&lt;</span> <span class="number">20</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure><p>è¿™æ¡è¯­å¥ä¼šé”å®šåŒºé—´ <code>(10,15)</code>ã€<code>(15,+âˆ)</code>ï¼Œåœ¨äº‹åŠ¡æ‰§è¡ŒæœŸé—´ï¼Œå…¶ä»–äº‹åŠ¡æ— æ³•åœ¨è¿™ä¸¤ä¸ªåŒºé—´æ’å…¥æ•°æ®</p><ul><li><strong>ä¸´é”®é”ï¼ˆNext-Key Lockï¼‰</strong>ï¼šé”å®šè®°å½•æœ¬èº«åŠä¹‹å‰çš„é—´éš™ã€‚é˜²æ­¢å¹»è¯»å’Œä¸å¯é‡å¤è¯»ã€‚</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-- äº‹åŠ¡Aæ‰§è¡Œï¼š</span><br><span class="line">SELECT * FROM users WHERE id &gt; 15 AND id &lt; 25 FOR UPDATE;</span><br><span class="line">-- å‡è®¾å­˜åœ¨id=20çš„è®°å½•ï¼Œä¸´é”®é”ä¼šé”å®šï¼š(15,20],(20,+âˆ)</span><br></pre></td></tr></table></figure><h2 id="äº‹åŠ¡"><a href="#äº‹åŠ¡" class="headerlink" title="äº‹åŠ¡"></a>äº‹åŠ¡</h2><h3 id="äº‹åŠ¡çš„åŸºæœ¬ç‰¹æ€§å’Œéš”ç¦»çº§åˆ«"><a href="#äº‹åŠ¡çš„åŸºæœ¬ç‰¹æ€§å’Œéš”ç¦»çº§åˆ«" class="headerlink" title="äº‹åŠ¡çš„åŸºæœ¬ç‰¹æ€§å’Œéš”ç¦»çº§åˆ«"></a>äº‹åŠ¡çš„åŸºæœ¬ç‰¹æ€§å’Œéš”ç¦»çº§åˆ«</h3><p>äº‹åŠ¡ä¿è¯ä¸€ç»„æ“ä½œè¦ä¹ˆå…¨éƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œã€‚åœ¨ MySQL ä¸­ï¼Œäº‹åŠ¡æ”¯æŒæ˜¯åœ¨å¼•æ“å±‚å®ç°çš„ã€‚</p><table><thead><tr><th>åŸºæœ¬ç‰¹æ€§</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>åŸå­æ€§ï¼ˆ<code>atomicity</code>ï¼‰</td><td>äº‹åŠ¡ä¸­çš„æ“ä½œè¦ä¹ˆå…¨éƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œ</td></tr><tr><td>ä¸€è‡´æ€§ï¼ˆ<code>consistency</code>ï¼‰</td><td>äº‹åŠ¡çš„æ‰§è¡Œè¦ä¿è¯æ•°æ®çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§</td></tr><tr><td>éš”ç¦»æ€§ï¼ˆ<code>isolation</code>ï¼‰</td><td>äº‹åŠ¡çš„æ‰§è¡Œäº’ä¸å¹²æ‰°</td></tr><tr><td>æŒä¹…æ€§ï¼ˆ<code>durability</code>ï¼‰</td><td>äº‹åŠ¡ä¸€æ—¦æäº¤ï¼Œå¯¹æ•°æ®çš„ä¿®æ”¹å°±æ°¸ä¹…ä¿å­˜åˆ°æ•°æ®åº“ä¸­ï¼Œä¸å¯æ’¤é”€</td></tr></tbody></table><table><thead><tr><th>äº‹åŠ¡å¯èƒ½å¼•å‘çš„é—®é¢˜</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>è„è¯»</td><td>A äº‹åŠ¡è¯»å– B äº‹åŠ¡å°šæœªæäº¤çš„ä¿®æ”¹</td></tr><tr><td>ä¸å¯é‡å¤è¯»</td><td>A äº‹åŠ¡å¤šæ¬¡è¯»å–åŒä¸€æ•°æ®ï¼Œç»“æœå‰åä¸ä¸€è‡´</td></tr><tr><td>å¹»è¯»</td><td>A äº‹åŠ¡å¤šæ¬¡è¯»å–ï¼Œæ•°æ®æ€»é‡å‰åä¸ä¸€è‡´</td></tr></tbody></table><table><thead><tr><th>éš”ç¦»çº§åˆ«</th><th>è¯´æ˜</th><th>è„è¯»</th><th>ä¸å¯é‡å¤è¯»</th><th>å¹»è¯»</th></tr></thead><tbody><tr><td><code>read uncommitted</code></td><td>ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œèƒ½çœ‹åˆ°å…¶ä»–æœªæäº¤äº‹åŠ¡åšçš„ä¿®æ”¹</td><td>âœ“</td><td>âœ“</td><td>âœ“</td></tr><tr><td><code>read committed</code></td><td>ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œèƒ½çœ‹åˆ°å…¶ä»–å·²æäº¤äº‹åŠ¡åšçš„ä¿®æ”¹ï¼ˆMySQL ä¼šåœ¨æ¯ä¸ª SQL è¯­å¥å¼€å§‹æ‰§è¡Œæ—¶åˆ›å»ºä¸€ä¸ªè§†å›¾ï¼‰</td><td></td><td>âœ“</td><td>âœ“</td></tr><tr><td><code>repeatable read</code></td><td>ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå…¶ä»–äº‹åŠ¡çš„ä¿®æ”¹å¯¹å®ƒä¸å¯è§ï¼ˆMySQL ä¼šåœ¨äº‹åŠ¡å¯åŠ¨æ—¶åˆ›å»ºä¸€ä¸ªè§†å›¾ï¼Œæ•´ä¸ªäº‹åŠ¡æ‰§è¡ŒæœŸé—´éƒ½ä½¿ç”¨è¿™ä¸ªè§†å›¾ï¼‰</td><td></td><td></td><td>âœ“</td></tr><tr><td><code>serializable</code></td><td>äº‹åŠ¡ä¸²è¡Œæ‰§è¡Œï¼Œéš”ç¦»çº§åˆ«æœ€é«˜ï¼Œä¸ä¼šå‡ºç°ä¸Šé¢æ‰€è¯´çš„é—®é¢˜ï¼Œä½†ç›¸åº”çš„æ•ˆç‡ä¹Ÿæœ€ä½</td><td></td><td></td><td></td></tr></tbody></table><h3 id="å¿«ç…§è¯»å’Œå½“å‰è¯»"><a href="#å¿«ç…§è¯»å’Œå½“å‰è¯»" class="headerlink" title="å¿«ç…§è¯»å’Œå½“å‰è¯»"></a>å¿«ç…§è¯»å’Œå½“å‰è¯»</h3><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">å¿«ç…§è¯»</th><th align="left">å½“å‰è¯»</th></tr></thead><tbody><tr><td align="left"><strong>æ•°æ®ç‰ˆæœ¬</strong></td><td align="left">å†å²å¿«ç…§ç‰ˆæœ¬</td><td align="left">æœ€æ–°æäº¤ç‰ˆæœ¬</td></tr><tr><td align="left"><strong>åŠ é”</strong></td><td align="left">ä¸åŠ é”</td><td align="left">åŠ é”ï¼ˆå…±äº«é”&#x2F;æ’ä»–é”ï¼‰</td></tr><tr><td align="left"><strong>ä¸€è‡´æ€§</strong></td><td align="left">ä¸€è‡´æ€§éé”å®šè¯»</td><td align="left">å½“å‰æ•°æ®ä¸€è‡´æ€§</td></tr><tr><td align="left"><strong>å¹¶å‘æ€§</strong></td><td align="left">é«˜ï¼Œè¯»å†™ä¸å†²çª</td><td align="left">ä½ï¼Œå¯èƒ½é˜»å¡å†™æ“ä½œ</td></tr><tr><td align="left"><strong>è§¦å‘è¯­å¥</strong></td><td align="left">æ™®é€šSELECT</td><td align="left">SELECT FOR UPDATE, UPDATE, DELETEç­‰</td></tr><tr><td align="left"><strong>éš”ç¦»çº§åˆ«</strong></td><td align="left">RC, RR</td><td align="left">æ‰€æœ‰çº§åˆ«ï¼Œç‰¹åˆ«æ˜¯SERIALIZABLE</td></tr></tbody></table><h3 id="MVCCå®ç°åŸç†"><a href="#MVCCå®ç°åŸç†" class="headerlink" title="MVCCå®ç°åŸç†"></a><code>MVCC</code>å®ç°åŸç†</h3><ul><li><code>Undo log</code>ï¼šæ¯æ¡æ•°æ®ç»´æŠ¤å¤šä¸ªå†å²ç‰ˆæœ¬</li><li><code>ReadView</code>ï¼šå¿«ç…§</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ReadViewç»“æ„ï¼š</span><br><span class="line">&#123;</span><br><span class="line">  creator_trx_id: 150,      -- å½“å‰äº‹åŠ¡ID</span><br><span class="line">  m_ids: [100, 120, 140],   -- æ´»è·ƒäº‹åŠ¡IDåˆ—è¡¨</span><br><span class="line">  min_trx_id: 100,          -- æœ€å°æ´»è·ƒäº‹åŠ¡ID</span><br><span class="line">  max_trx_id: 150           -- é¢„åˆ†é…æœ€å¤§äº‹åŠ¡ID</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å¯è§æ€§åˆ¤æ–­è§„åˆ™</strong>ï¼š</p><ol><li>æ•°æ®ç‰ˆæœ¬<code>trx_id</code> &lt; <code>min_trx_id</code> â†’ å¯è§</li><li><code>trx_id</code>åœ¨<code>m_ids</code>ä¸­ â†’ ä¸å¯è§</li><li><code>trx_id</code> &gt;&#x3D; <code>max_trx_id</code> â†’ ä¸å¯è§</li></ol><p>InnoDBé»˜è®¤ä¼šä¸ºæ¯è¡Œæ•°æ®ç”Ÿæˆä¸¤ä¸ªéšè—åˆ—ï¼š</p><ul><li><code>DB_TRX_ID</code>ï¼šæœ€åä¿®æ”¹è¯¥è¡Œçš„äº‹åŠ¡ID</li><li><code>DB_ROLL_PTR</code>ï¼šæŒ‡å‘<code>Undo Log</code>çš„å›æ»šæŒ‡é’ˆ</li></ul><p>ä¸åŒéš”ç¦»çº§åˆ«ä¸‹<code>ReadView</code>çš„ç”Ÿæˆæ—¶æœºï¼š</p><ul><li><code>READ COMMITTED(RC)</code>ï¼šæ¯æ¬¡<code>SELECT</code>éƒ½ä¼šåˆ›å»ºæ–°çš„<code>ReadView</code></li><li><code>REPEATABLE READ(RR)</code>ï¼šäº‹åŠ¡ä¸­ç¬¬ä¸€æ¬¡<code>SELECT</code>æ—¶åˆ›å»º<code>ReadView</code></li></ul><h2 id="æ—¥å¿—"><a href="#æ—¥å¿—" class="headerlink" title="æ—¥å¿—"></a>æ—¥å¿—</h2><h3 id="ä»€ä¹ˆæ˜¯redo-log"><a href="#ä»€ä¹ˆæ˜¯redo-log" class="headerlink" title="ä»€ä¹ˆæ˜¯redo log"></a>ä»€ä¹ˆæ˜¯redo log</h3><p><strong>Redo Log (ç‰©ç†æ—¥å¿—):</strong> è®°å½•çš„æ˜¯ç‰©ç†çº§åˆ«çš„æ›´æ”¹ã€‚å®ƒæè¿°çš„æ˜¯â€œåœ¨æŸä¸ªæ•°æ®é¡µ (Page) ä¸Šçš„æŸä¸ªåç§»é‡å¤„åšäº†ä»€ä¹ˆä¿®æ”¹â€ã€‚ä¾‹å¦‚ï¼šâ€œåœ¨è¡¨ç©ºé—´ ID ä¸º Xï¼Œé¡µå· Y çš„æ•°æ®é¡µä¸Šï¼Œåç§»é‡ Z å¼€å§‹çš„ 4 ä¸ªå­—èŠ‚è¢«ä¿®æ”¹ä¸ºå€¼ 0x12345678â€ã€‚å®ƒä¸å…³å¿ƒå…·ä½“çš„ SQL è¯­å¥æ˜¯ä»€ä¹ˆï¼Œåªå…³å¿ƒæ•°æ®é¡µçš„ç‰©ç†å˜åŒ–ã€‚è¿™ç§æ—¥å¿—ä½“ç§¯é€šå¸¸è¾ƒå°ä¸”é«˜æ•ˆã€‚</p><h3 id="ä»€ä¹ˆæ˜¯binlog"><a href="#ä»€ä¹ˆæ˜¯binlog" class="headerlink" title="ä»€ä¹ˆæ˜¯binlog"></a>ä»€ä¹ˆæ˜¯binlog</h3><p><strong>Binlog (é€»è¾‘æ—¥å¿—):</strong> è®°å½•çš„æ˜¯é€»è¾‘çº§åˆ«çš„æ“ä½œã€‚æ ¹æ® binlog æ ¼å¼ (<code>STATEMENT</code>, <code>ROW</code>, <code>MIXED</code>) çš„ä¸åŒï¼Œå®ƒè®°å½•çš„å†…å®¹ä¹Ÿä¸åŒï¼š</p><ul><li><code>STATEMENT</code>: è®°å½•åŸå§‹çš„ SQL è¯­å¥æœ¬èº«ï¼ˆå¦‚ <code>UPDATE users SET balance=100 WHERE id=5;</code>ï¼‰ã€‚</li><li><code>ROW</code>: è®°å½•è¢«ä¿®æ”¹çš„è¡Œåœ¨ä¿®æ”¹å‰å’Œä¿®æ”¹åçš„æ•°æ®ï¼ˆæˆ–ä»…ä¿®æ”¹åçš„æ•°æ®ï¼Œå–å†³äºé…ç½®ï¼‰ã€‚ä¾‹å¦‚ï¼Œè®°å½• <code>id=5</code> çš„è¿™è¡Œæ•°æ®ï¼Œ<code>balance</code> å­—æ®µä» <code>50</code> æ”¹æˆäº† <code>100</code>ã€‚</li><li><code>MIXED</code>: æ··åˆæ¨¡å¼ï¼Œé»˜è®¤ä½¿ç”¨ <code>STATEMENT</code>ï¼Œä½†åœ¨æŸäº›å¯èƒ½å¼•èµ·ä¸»ä»ä¸ä¸€è‡´ï¼ˆå¦‚ä½¿ç”¨éç¡®å®šæ€§å‡½æ•° <code>UUID()</code>, <code>NOW()</code>ï¼‰çš„æƒ…å†µä¸‹è‡ªåŠ¨åˆ‡æ¢åˆ° <code>ROW</code>ã€‚é€»è¾‘æ—¥å¿—æ›´æ˜“äºäººç±»ç†è§£å’Œç”¨äºå¤åˆ¶ï¼Œä½† <code>ROW</code> æ¨¡å¼åœ¨æ‰¹é‡æ“ä½œæ—¶å¯èƒ½äº§ç”Ÿå¤§é‡æ—¥å¿—ã€‚</li></ul><h3 id="redo-log-vs-binlog"><a href="#redo-log-vs-binlog" class="headerlink" title="redo log vs binlog"></a>redo log vs binlog</h3><table><thead><tr><th align="left"><strong>ç‰¹æ€§</strong></th><th align="left"><strong>Redo Log (é‡åšæ—¥å¿—)</strong></th><th align="left"><strong>Binlog (äºŒè¿›åˆ¶æ—¥å¿—)</strong></th></tr></thead><tbody><tr><td align="left"><strong>æ‰€å±å±‚çº§</strong></td><td align="left"><strong>InnoDB å­˜å‚¨å¼•æ“å±‚</strong></td><td align="left"><strong>MySQL Server å±‚</strong></td></tr><tr><td align="left"><strong>ä¸»è¦ä½œç”¨</strong></td><td align="left"><strong>å´©æºƒæ¢å¤</strong>ï¼šç¡®ä¿äº‹åŠ¡çš„æŒä¹…æ€§ (Durability)</td><td align="left"><strong>æ•°æ®å¤‡ä»½ä¸æ¢å¤</strong>ï¼šä¸»ä»å¤åˆ¶ã€æ—¶é—´ç‚¹æ¢å¤</td></tr><tr><td align="left"><strong>æ—¥å¿—ç±»å‹</strong></td><td align="left"><strong>ç‰©ç†æ—¥å¿—</strong>ï¼šè®°å½•é¡µé¢çš„ç‰©ç†ä¿®æ”¹</td><td align="left"><strong>é€»è¾‘æ—¥å¿—</strong>ï¼šè®°å½•å¯¼è‡´æ•°æ®å˜åŒ–çš„ SQL è¯­å¥æˆ–è¡Œå˜åŒ–</td></tr><tr><td align="left"><strong>å†…å®¹</strong></td><td align="left">åœ¨æŸä¸ªæ•°æ®é¡µä¸Šåšäº†ä»€ä¹ˆä¿®æ”¹ (ç‰©ç†æ“ä½œ)</td><td align="left">æ‰§è¡Œäº†ä»€ä¹ˆ SQL è¯­å¥ (Statement) æˆ–å“ªäº›è¡Œè¢«ä¿®æ”¹ (Row)</td></tr><tr><td align="left"><strong>å†™å…¥æ—¶æœº</strong></td><td align="left"><strong>æŒç»­å†™å…¥</strong>ï¼šäº‹åŠ¡è¿›è¡Œä¸­</td><td align="left"><strong>äº‹åŠ¡æäº¤å</strong>ï¼šäº‹åŠ¡å®Œæˆæ—¶æ‰å†™å…¥</td></tr><tr><td align="left"><strong>å†™å…¥æ–¹å¼</strong></td><td align="left"><strong>é¡ºåºå†™å…¥</strong> (å¾ªç¯æ–‡ä»¶)</td><td align="left"><strong>è¿½åŠ å†™å…¥</strong> (æ–‡ä»¶åºåˆ—)</td></tr><tr><td align="left"><strong>ç”Ÿå‘½å‘¨æœŸ</strong></td><td align="left">æ•°æ®åˆ·ç›˜åå¯è¦†ç›– (å¾ªç¯ä½¿ç”¨)</td><td align="left">å¯é•¿æœŸä¿å­˜ (éœ€æ‰‹åŠ¨æˆ–ç­–ç•¥æ¸…ç†)</td></tr><tr><td align="left"><strong>åˆ·ç›˜ç­–ç•¥</strong></td><td align="left"><code>innodb_flush_log_at_trx_commit</code></td><td align="left"><code>sync_binlog</code></td></tr><tr><td align="left"><strong>æ ¼å¼</strong></td><td align="left">InnoDB ç§æœ‰æ ¼å¼</td><td align="left"><code>STATEMENT</code>, <code>ROW</code>, <code>MIXED</code></td></tr><tr><td align="left"><strong>ä½¿ç”¨åœºæ™¯</strong></td><td align="left">æ•°æ®åº“å´©æºƒåè‡ªåŠ¨æ¢å¤æœªåˆ·ç›˜çš„æ•°æ®</td><td align="left">ä¸»ä»å¤åˆ¶ã€å¢é‡å¤‡ä»½ã€æ—¶é—´ç‚¹æ¢å¤ã€æ•°æ®å®¡è®¡</td></tr></tbody></table><p><strong>å†™å…¥æ—¶æœºï¼š</strong></p><ul><li><strong>Redo Log:</strong> åœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ <strong>æŒç»­å†™å…¥</strong>ã€‚å½“äº‹åŠ¡ä¿®æ”¹æ•°æ®æ—¶ï¼Œé¦–å…ˆä¼šåœ¨å†…å­˜ä¸­çš„ Buffer Pool ä¿®æ”¹æ•°æ®é¡µï¼ˆäº§ç”Ÿè„é¡µï¼‰ï¼ŒåŒæ—¶ä¼šç”Ÿæˆå¯¹åº”çš„ redo log è®°å½•å¹¶ <strong>é¡ºåºã€è¿‘ä¹å®æ—¶åœ°å†™å…¥ redo log buffer</strong>ï¼Œç„¶åæ ¹æ®ç­–ç•¥ï¼ˆ<code>innodb_flush_log_at_trx_commit</code>ï¼‰åˆ·å†™åˆ°ç£ç›˜ä¸Šçš„ redo log æ–‡ä»¶ã€‚<strong>äº‹åŠ¡æäº¤æ—¶ï¼Œå¿…é¡»ç¡®ä¿å…¶å¯¹åº”çš„ redo log å·²æŒ‰ç­–ç•¥æŒä¹…åŒ–åˆ°ç£ç›˜</strong>ï¼Œè¿™æ˜¯ä¿è¯æŒä¹…æ€§çš„å…³é”®ã€‚</li><li><strong>Binlog:</strong> æ˜¯åœ¨äº‹åŠ¡ <strong>æäº¤å®Œæˆä¹‹å‰</strong>ï¼Œä½†åœ¨ç¡®ä¿ redo log å·²æŒä¹…åŒ–ä¹‹åï¼ˆè§ä¸¤é˜¶æ®µæäº¤ï¼‰<strong>ä¸€æ¬¡æ€§å†™å…¥</strong>ã€‚äº‹åŠ¡æäº¤æ—¶ï¼ŒMySQL Server å±‚å°†äº‹åŠ¡æ¶‰åŠçš„æ‰€æœ‰ binlog äº‹ä»¶æŒ‰é¡ºåºå†™å…¥ binlog cacheï¼Œç„¶åæ ¹æ®ç­–ç•¥ (<code>sync_binlog</code>) åˆ·å†™åˆ°ç£ç›˜ä¸Šçš„ binlog æ–‡ä»¶ã€‚<strong>åªæœ‰ binlog æˆåŠŸå†™å…¥å¹¶æŒä¹…åŒ–ï¼ˆæ ¹æ®ç­–ç•¥ï¼‰ï¼Œäº‹åŠ¡æ‰è¢«è®¤ä¸ºæœ€ç»ˆæäº¤æˆåŠŸ</strong>ã€‚</li></ul><p><strong>åˆ·ç›˜ç­–ç•¥</strong></p><ul><li><strong>Redo Log:</strong> ç”±å‚æ•° <code>innodb_flush_log_at_trx_commit</code> æ§åˆ¶ï¼š<ul><li><code>0</code>: æ¯ç§’å†™å…¥å¹¶åˆ·ç›˜ä¸€æ¬¡ï¼ˆå¯èƒ½ä¸¢å¤±æœ€å¤š1ç§’çš„äº‹åŠ¡ï¼‰ã€‚</li><li><code>1</code>: <strong>é»˜è®¤ä¸”æœ€å®‰å…¨</strong>ã€‚æ¯æ¬¡äº‹åŠ¡æäº¤æ—¶å†™å…¥å¹¶åˆ·ç›˜ï¼ˆä¿è¯å´©æºƒåä¸ä¸¢æ•°æ®ï¼‰ã€‚</li><li><code>2</code>: æ¯æ¬¡äº‹åŠ¡æäº¤æ—¶å†™å…¥ OS ç¼“å­˜ï¼Œæ¯ç§’åˆ·ç›˜ä¸€æ¬¡ï¼ˆMySQL è¿›ç¨‹å´©æºƒä¸ä¸¢æ•°æ®ï¼ŒOS å´©æºƒå¯èƒ½ä¸¢å¤±æœ€å¤š1ç§’çš„äº‹åŠ¡ï¼‰ã€‚</li></ul></li><li><strong>Binlog:</strong> ç”±å‚æ•° <code>sync_binlog</code> æ§åˆ¶ï¼š<ul><li><code>0</code>: ä¾èµ– OS åˆ·æ–°ï¼ŒMySQL ä¸ä¸»åŠ¨åˆ·ç›˜ï¼ˆæ€§èƒ½æœ€å¥½ï¼Œé£é™©æœ€é«˜ï¼‰ã€‚</li><li><code>1</code>: <strong>é»˜è®¤ä¸”å®‰å…¨</strong>ã€‚æ¯æ¬¡äº‹åŠ¡æäº¤åéƒ½åˆ·ç›˜ï¼ˆä¿è¯ binlog ä¸ä¸¢å¤±ï¼‰ã€‚</li><li><code>N</code> (N&gt;1): æ¯ N ä¸ªäº‹åŠ¡æäº¤ååˆ·ç›˜ä¸€æ¬¡ï¼ˆæŠ˜ä¸­æ–¹æ¡ˆï¼‰ã€‚</li></ul></li></ul><h3 id="ä»€ä¹ˆæ˜¯ä¸¤é˜¶æ®µæäº¤"><a href="#ä»€ä¹ˆæ˜¯ä¸¤é˜¶æ®µæäº¤" class="headerlink" title="ä»€ä¹ˆæ˜¯ä¸¤é˜¶æ®µæäº¤"></a>ä»€ä¹ˆæ˜¯ä¸¤é˜¶æ®µæäº¤</h3><p>ä¸¤é˜¶æ®µæäº¤çš„æ ¸å¿ƒç›®çš„ä¹‹ä¸€ï¼Œå°±æ˜¯ä¸ºäº†åè°ƒ <strong>redo log (InnoDB å¼•æ“å±‚)</strong> å’Œ <strong>binlog (Server å±‚)</strong> è¿™ä¸¤ç§ä½äºä¸åŒå±‚æ¬¡ã€æœ‰å„è‡ªå†…å­˜ buffer å’Œåˆ·ç›˜ç­–ç•¥çš„æ—¥å¿—ï¼Œåœ¨ <strong>åˆ·ç›˜æ—¶æœº</strong> ä¸Šä¿æŒä¸€è‡´ï¼Œç¡®ä¿å´©æºƒæ¢å¤åæ•°æ®çŠ¶æ€ä¸€è‡´ã€‚</p><ol><li><strong>Prepare é˜¶æ®µ (InnoDB):</strong> å°†äº‹åŠ¡çš„ redo log å†™å…¥ redo log buffer <strong>å¹¶åˆ·ç›˜</strong>ï¼ˆæ ¹æ® <code>innodb_flush_log_at_trx_commit</code>ï¼Œé€šå¸¸æ­¤æ—¶å·²å¼ºåˆ¶åˆ·ç›˜ï¼‰ï¼Œæ ‡è®°çŠ¶æ€ä¸º <code>PREPARE</code>ã€‚<strong>æ­¤æ—¶ redo log åœ¨ç£ç›˜ä¸ŠæŒä¹…åŒ–äº†â€œè¿™ä¸ªäº‹åŠ¡åœ¨å“ªäº›ä½ç½®ä¿®æ”¹äº†ä»€ä¹ˆâ€ã€‚</strong></li><li><strong>Write &amp; Sync Binlog é˜¶æ®µ (Server):</strong> å°†äº‹åŠ¡çš„ binlog äº‹ä»¶å†™å…¥ binlog cache <strong>å¹¶åˆ·ç›˜</strong>ï¼ˆæ ¹æ® <code>sync_binlog</code>ï¼Œé€šå¸¸æ­¤æ—¶ä¹Ÿå¼ºåˆ¶åˆ·ç›˜ï¼‰ã€‚<strong>æ­¤æ—¶ binlog åœ¨ç£ç›˜ä¸ŠæŒä¹…åŒ–äº†â€œè¿™ä¸ªäº‹åŠ¡æ‰§è¡Œäº†ä»€ä¹ˆæ“ä½œâ€ã€‚</strong></li><li><strong>Commit é˜¶æ®µ (InnoDB):</strong> åœ¨ redo log ä¸­å†™å…¥ä¸€ä¸ª <code>COMMIT</code> æ ‡è®°ï¼ˆé€šå¸¸åªéœ€å†™ redo log bufferï¼Œä¸ä¸€å®šç«‹åˆ»åˆ·ç›˜ï¼Œå› ä¸ºå‰ä¸¤æ­¥å·²ä¿è¯å…³é”®ä¿¡æ¯æŒä¹…åŒ–ï¼‰ã€‚<strong>æ ‡è®°äº‹åŠ¡åœ¨å¼•æ“å±‚æ­£å¼æäº¤ã€‚</strong></li></ol><h2 id="InnoDB"><a href="#InnoDB" class="headerlink" title="InnoDB"></a>InnoDB</h2><h3 id="InnoDBå’Œå…¶ä»–å­˜å‚¨å¼•æ“çš„æ¯”è¾ƒ"><a href="#InnoDBå’Œå…¶ä»–å­˜å‚¨å¼•æ“çš„æ¯”è¾ƒ" class="headerlink" title="InnoDBå’Œå…¶ä»–å­˜å‚¨å¼•æ“çš„æ¯”è¾ƒ"></a>InnoDBå’Œå…¶ä»–å­˜å‚¨å¼•æ“çš„æ¯”è¾ƒ</h3><table><thead><tr><th></th><th>MyISAM</th><th>InnoDB</th></tr></thead><tbody><tr><td>é”</td><td>è¡¨çº§é”</td><td>è¡Œçº§é”</td></tr><tr><td>äº‹åŠ¡æ”¯æŒ</td><td>ä¸æ”¯æŒ</td><td>æ”¯æŒ</td></tr><tr><td>ç´¢å¼•ç»“æ„</td><td>Bæ ‘</td><td>B+æ ‘</td></tr><tr><td>å…¨æ–‡æ£€ç´¢</td><td>æ”¯æŒ</td><td>5.5ç‰ˆæœ¬åæ”¯æŒ</td></tr></tbody></table><p>æ€»ä½“æ¥è¯´ï¼Œå¦‚æœéœ€è¦æ”¯æŒäº‹åŠ¡ã€å¤–é”®çº¦æŸå’Œé«˜å¹¶å‘è®¿é—®ï¼Œé‚£ä¹ˆInnoDBæ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚å¦‚æœéœ€è¦è¿›è¡Œå…¨æ–‡æ£€ç´¢ï¼Œé‚£ä¹ˆMyISAMæ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒMySQL 5.5ç‰ˆæœ¬ä¹‹åï¼ŒInnoDBå·²ç»æ”¯æŒäº†å…¨æ–‡æ£€ç´¢ã€‚</p><h3 id="ä»€ä¹ˆæ˜¯buffer-pool"><a href="#ä»€ä¹ˆæ˜¯buffer-pool" class="headerlink" title="ä»€ä¹ˆæ˜¯buffer pool"></a>ä»€ä¹ˆæ˜¯buffer pool</h3><p>åœ¨ MySQL çš„ InnoDB å­˜å‚¨å¼•æ“ä¸­ï¼Œ<strong>Change Buffer</strong> å’Œ <strong>Buffer Pool</strong> éƒ½æ˜¯æ ¸å¿ƒçš„å†…å­˜ç»“æ„ï¼Œç”¨äºä¼˜åŒ–æ€§èƒ½ï¼Œä½†å®ƒä»¬è§£å†³çš„é—®é¢˜å’Œè¿ä½œæ–¹å¼æˆªç„¶ä¸åŒï¼š</p><ul><li><strong>æœ¬è´¨ï¼š</strong> <strong>æ•°æ®åº“çš„å†…å­˜ç¼“å­˜åŒºåŸŸ</strong>ã€‚ç”¨äºç¼“å­˜ä»ç£ç›˜è¯»å–çš„<strong>æ•°æ®é¡µï¼ˆData Pagesï¼‰å’Œç´¢å¼•é¡µï¼ˆIndex Pagesï¼‰</strong>ã€‚</li><li><strong>ç›®çš„ï¼š</strong> <strong>å‡å°‘ç£ç›˜ I&#x2F;O</strong>ã€‚</li><li><strong>ä½œç”¨å¯¹è±¡ï¼š</strong> <strong>æ‰€æœ‰ç±»å‹çš„æ•°æ®é¡µ</strong>ã€‚åŒ…æ‹¬ï¼š<ul><li>åŒ…å«è¡¨è¡Œæ•°æ®çš„é¡µï¼ˆæ•°æ®é¡µï¼‰ã€‚</li><li>åŒ…å«ç´¢å¼•ï¼ˆä¸»é”®ç´¢å¼•ã€äºŒçº§ç´¢å¼•ï¼‰æ¡ç›®çš„é¡µï¼ˆç´¢å¼•é¡µï¼‰ã€‚</li><li>ç³»ç»Ÿé¡µã€Undo é¡µç­‰ã€‚</li></ul></li><li><strong>å·¥ä½œåŸç†ï¼š</strong><ul><li><strong>è¯»æ“ä½œï¼š</strong> ä¼˜å…ˆä» Buffer Pool è¯»å–ï¼Œæœªå‘½ä¸­åˆ™è¯»ç£ç›˜å¹¶åŠ è½½ã€‚</li><li><strong>å†™æ“ä½œ (DML: INSERT, UPDATE, DELETE)ï¼š</strong><ol><li>ä¿®æ”¹å‘ç”Ÿåœ¨ Buffer Pool ä¸­çš„<strong>è„é¡µï¼ˆDirty Pageï¼‰</strong>ï¼ˆå·²è¢«ä¿®æ”¹ä½†å°šæœªå†™å›ç£ç›˜çš„é¡µï¼‰ã€‚</li><li>ä¿®æ”¹ä¼šå†™å…¥ Redo Log ä»¥ä¿è¯æŒä¹…æ€§ã€‚</li><li><strong>ä¸æ˜¯ç«‹å³å†™å›ç£ç›˜ï¼</strong> Buffer Pool ä¸­çš„è„é¡µä¼šåœ¨åå°ç”±ä¸“é—¨çš„çº¿ç¨‹æˆ–æ ¹æ®ç‰¹å®šç­–ç•¥ï¼ˆå¦‚ LRU æ·˜æ±°ã€æ£€æŸ¥ç‚¹è§¦å‘ã€Buffer Pool ç©ºé—´ä¸è¶³æ—¶ï¼‰<strong>å¼‚æ­¥åˆ·æ–°ï¼ˆFlushï¼‰</strong> åˆ°ç£ç›˜çš„æ•°æ®æ–‡ä»¶ï¼ˆ.ibd æ–‡ä»¶ï¼‰ã€‚</li></ol></li></ul></li></ul><h3 id="ä»€ä¹ˆæ˜¯change-buffer"><a href="#ä»€ä¹ˆæ˜¯change-buffer" class="headerlink" title="ä»€ä¹ˆæ˜¯change buffer"></a>ä»€ä¹ˆæ˜¯change buffer</h3><ul><li><strong>æœ¬è´¨ï¼š</strong> <strong>ç”¨äºä¼˜åŒ–å¯¹éå”¯ä¸€äºŒçº§ç´¢å¼•çš„å†™æ“ä½œï¼ˆINSERT, UPDATE, DELETEï¼‰</strong>ã€‚ç‰©ç†ä¸Š<strong>æ˜¯ Buffer Pool çš„ä¸€éƒ¨åˆ†</strong>ï¼Œä½†é€»è¾‘åŠŸèƒ½ç‹¬ç«‹ã€‚</li><li><strong>ç›®çš„ï¼š</strong> <strong>å‡å°‘å¯¹éå”¯ä¸€äºŒçº§ç´¢å¼•çš„éšæœºç£ç›˜ I&#x2F;Oã€‚</strong> å½“ä¿®æ”¹æ“ä½œï¼ˆå°¤å…¶æ˜¯ INSERT å’Œ UPDATEï¼‰æ¶‰åŠåˆ°éå”¯ä¸€çš„äºŒçº§ç´¢å¼•æ—¶ï¼Œå¦‚æœå¯¹åº”çš„ç´¢å¼•é¡µ<strong>ä¸åœ¨ Buffer Pool</strong> ä¸­ï¼Œä¼ ç»Ÿçš„åšæ³•æ˜¯å¿…é¡»å…ˆå°†è¯¥ç´¢å¼•é¡µä»ç£ç›˜è¯»å…¥ Buffer Pool æ‰èƒ½ä¿®æ”¹ã€‚Change Buffer å…è®¸ InnoDB <strong>å°†è¿™æ¬¡ä¿®æ”¹â€œç¼“å†²â€ä¸‹æ¥</strong>ï¼Œè€Œä¸æ˜¯ç«‹å³å»ç£ç›˜åŠ è½½é‚£ä¸ªç´¢å¼•é¡µã€‚</li><li><strong>ä½œç”¨å¯¹è±¡ï¼š</strong> <strong>ä»…é™äºéå”¯ä¸€äºŒçº§ç´¢å¼•ï¼ˆNon-Unique Secondary Indexï¼‰</strong> çš„ä¿®æ”¹æ“ä½œã€‚å®ƒä¸å¤„ç†ï¼š<ul><li>ä¸»é”®ç´¢å¼•ï¼ˆèšç°‡ç´¢å¼•ï¼‰çš„ä¿®æ”¹ï¼ˆç›´æ¥åœ¨ Buffer Pool ä¸­çš„é¡µä¸Šä¿®æ”¹ï¼‰ã€‚</li><li>å”¯ä¸€ç´¢å¼•çš„ä¿®æ”¹ï¼ˆéœ€è¦ç«‹å³æ£€æŸ¥å”¯ä¸€æ€§çº¦æŸï¼Œå¿…é¡»åŠ è½½ç´¢å¼•é¡µï¼‰ã€‚</li><li>æ•°æ®é¡µæœ¬èº«çš„ä¿®æ”¹ï¼ˆåœ¨ Buffer Pool ä¸­è¿›è¡Œï¼‰ã€‚</li></ul></li><li><strong>å·¥ä½œåŸç†ï¼š</strong><ul><li>å½“å‘ç”Ÿå½±å“éå”¯ä¸€äºŒçº§ç´¢å¼•çš„ DML æ“ä½œæ—¶ï¼š<ol><li>æ£€æŸ¥ç›®æ ‡ç´¢å¼•é¡µæ˜¯å¦å·²åœ¨ Buffer Pool ä¸­ã€‚</li><li><strong>å¦‚æœåœ¨ï¼š</strong> ç›´æ¥åœ¨å†…å­˜ä¸­çš„ç´¢å¼•é¡µä¸Šè¿›è¡Œä¿®æ”¹ã€‚</li><li><strong>å¦‚æœä¸åœ¨ï¼š</strong> <strong>å°†è¿™æ¬¡ä¿®æ”¹æ“ä½œï¼ˆåŒ…å«ç´¢å¼•åˆ—å€¼ã€è¡Œæ ‡è¯†ç­‰ä¿¡æ¯ï¼‰è®°å½•åˆ° Change Buffer ä¸­</strong>ï¼Œè€Œä¸æ˜¯å»ç£ç›˜åŠ è½½ç´¢å¼•é¡µã€‚ä¿®æ”¹æ“ä½œæœ¬èº«ä¹Ÿä¼šè®°å½•åˆ° Redo Logã€‚</li></ol></li><li><strong>åç»­æ“ä½œï¼ˆMerge åˆå¹¶ï¼‰ï¼š</strong><ul><li>å½“<strong>ç¨å</strong>éœ€è¦è¯»å–è¿™ä¸ªè¢«ä¿®æ”¹çš„ç´¢å¼•é¡µï¼ˆä¾‹å¦‚é€šè¿‡ SELECT ä½¿ç”¨è¯¥ç´¢å¼•ã€åå° Purge çº¿ç¨‹ã€Checkpoint æ£€æŸ¥ç‚¹ã€Server ç©ºé—²ã€Change Buffer æ»¡ã€å…³é—­æ•°æ®åº“æ—¶ï¼‰ï¼ŒInnoDB ä¼šå…ˆå°†è¯¥ç´¢å¼•é¡µä»ç£ç›˜åŠ è½½åˆ° Buffer Poolã€‚</li><li>åŠ è½½å®Œæˆåï¼ŒInnoDB ä¼šæŸ¥æ‰¾ Change Buffer ä¸­æ‰€æœ‰é’ˆå¯¹è¿™ä¸ª<strong>å·²åŠ è½½é¡µ</strong>çš„å¾…å¤„ç†ä¿®æ”¹è®°å½•ã€‚</li><li>å°†è¿™äº›ä¿®æ”¹è®°å½•<strong>åº”ç”¨ï¼ˆMergeï¼‰</strong> åˆ°æ–°åŠ è½½åˆ°å†…å­˜çš„ç´¢å¼•é¡µä¸Šï¼Œä½¿è¯¥ç´¢å¼•é¡µåœ¨å†…å­˜ä¸­è¾¾åˆ°æœ€æ–°çŠ¶æ€ã€‚</li><li>æ­¤æ—¶ï¼Œè¢« Merge çš„ç´¢å¼•é¡µå˜æˆäº†è„é¡µï¼Œä¹‹åä¼šç”± Buffer Pool çš„åˆ·æ–°æœºåˆ¶å†™å›ç£ç›˜ã€‚</li></ul></li></ul></li></ul><h2 id="å­—æ®µç±»å‹"><a href="#å­—æ®µç±»å‹" class="headerlink" title="å­—æ®µç±»å‹"></a>å­—æ®µç±»å‹</h2><h3 id="char-100-å’Œ-varchar-100-çš„åŒºåˆ«"><a href="#char-100-å’Œ-varchar-100-çš„åŒºåˆ«" class="headerlink" title="char(100) å’Œ varchar(100) çš„åŒºåˆ«"></a>char(100) å’Œ varchar(100) çš„åŒºåˆ«</h3><p><strong>æ ¸å¿ƒåŒºåˆ«æ€»ç»“</strong></p><table><thead><tr><th align="left"><strong>ç‰¹æ€§</strong></th><th align="left"><code>CHAR(100)</code></th><th align="left"><code>VARCHAR(100)</code></th></tr></thead><tbody><tr><td align="left"><strong>ç±»å‹åç§°</strong></td><td align="left">å®šé•¿å­—ç¬¦ä¸²</td><td align="left">å˜é•¿å­—ç¬¦ä¸²</td></tr><tr><td align="left"><strong>å­˜å‚¨æ–¹å¼</strong></td><td align="left">å§‹ç»ˆå ç”¨ 100 å­—ç¬¦ç©ºé—´ï¼ˆä¸è¶³è¡¥ç©ºæ ¼ï¼‰</td><td align="left">æŒ‰å®é™…å­—ç¬¦æ•°å­˜å‚¨ + é¢å¤–é•¿åº¦å¼€é”€</td></tr><tr><td align="left"><strong>å­˜å‚¨ â€œabcâ€ çš„å ç”¨</strong></td><td align="left">100 å­—èŠ‚ï¼ˆå›ºå®šï¼‰</td><td align="left">3 å­—èŠ‚ + 1~2 å­—èŠ‚é•¿åº¦å¼€é”€ â‰ˆ 4 å­—èŠ‚</td></tr><tr><td align="left"><strong>ç©ºæ ¼å¤„ç†</strong></td><td align="left">æ’å…¥æ—¶ä¼šè‡ªåŠ¨è¡¥ç©ºæ ¼ï¼ŒæŸ¥è¯¢æ—¶è‡ªåŠ¨å»é™¤</td><td align="left">ä¿ç•™åŸå§‹ç©ºæ ¼ï¼Œä¸è‡ªåŠ¨è¡¥é½</td></tr><tr><td align="left"><strong>æŸ¥è¯¢é€Ÿåº¦</strong></td><td align="left">æ›´å¿«ï¼ˆå®šé•¿ï¼Œç›´æ¥å®šä½ï¼‰</td><td align="left">ç¨æ…¢ï¼ˆéœ€è®¡ç®—ä½ç½®ï¼‰</td></tr><tr><td align="left"><strong>é€‚ç”¨åœºæ™¯</strong></td><td align="left">é•¿åº¦å›ºå®šçš„æ•°æ®ï¼ˆå¦‚å›½å®¶ä»£ç ã€MD5ï¼‰</td><td align="left">é•¿åº¦ä¸å›ºå®šçš„æ•°æ®ï¼ˆå¦‚ç”¨æˆ·åã€åœ°å€ï¼‰</td></tr></tbody></table><h3 id="ä¸ºä»€ä¹ˆä¸å»ºè®®ä½¿ç”¨textç±»å‹"><a href="#ä¸ºä»€ä¹ˆä¸å»ºè®®ä½¿ç”¨textç±»å‹" class="headerlink" title="ä¸ºä»€ä¹ˆä¸å»ºè®®ä½¿ç”¨textç±»å‹"></a>ä¸ºä»€ä¹ˆä¸å»ºè®®ä½¿ç”¨<code>text</code>ç±»å‹</h3><p>åœ¨æ•°æ®åº“è®¾è®¡ä¸­ï¼Œæ–‡æœ¬ç±»å‹å­—æ®µï¼ˆå¦‚MySQLä¸­çš„TEXTï¼ŒPostgreSQLä¸­çš„TEXTç­‰ï¼‰é€šå¸¸ç”¨äºå­˜å‚¨å¤§é‡æ–‡æœ¬æ•°æ®ã€‚è™½ç„¶å®ƒä»¬å¯ä»¥å­˜å‚¨å¤§é‡æ•°æ®ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹ä¸å»ºè®®ä½¿ç”¨ï¼ŒåŸå› å¦‚ä¸‹ï¼š</p><ol><li><strong>æ€§èƒ½é—®é¢˜</strong>ï¼šåœ¨InnoDBä¸­ï¼ŒTEXTå’ŒBLOBç±»å‹åœ¨è®°å½•è¾ƒå¤§æ—¶å¯èƒ½å­˜å‚¨åœ¨æº¢å‡ºé¡µï¼Œè¿™å¯èƒ½å¯¼è‡´é¢å¤–çš„ç£ç›˜I&#x2F;Oã€‚</li><li><strong>å†…å­˜ä½¿ç”¨</strong>ï¼šåœ¨å¤„ç†æŸ¥è¯¢æ—¶ï¼Œæ•°æ®åº“å¯èƒ½ä¼šä¸ºTEXTå­—æ®µåˆ†é…å¤§é‡å†…å­˜ï¼Œè¿™å¯èƒ½å¯¼è‡´å†…å­˜ä½¿ç”¨è¿‡é«˜ï¼Œå½±å“æ•°æ®åº“æ€§èƒ½ã€‚</li><li><strong>ç´¢å¼•é™åˆ¶</strong>ï¼šåœ¨MySQLä¸­ï¼Œå¯¹TEXTåˆ—å»ºç«‹ç´¢å¼•å¿…é¡»æŒ‡å®šå‰ç¼€é•¿åº¦ï¼Œè¿™å¯èƒ½å¯¼è‡´ç´¢å¼•æ•ˆç‡ä¸é«˜ã€‚</li><li><strong>å¤åˆ¶å’Œæ¢å¤</strong>ï¼šç”±äºTEXTå­—æ®µå¯èƒ½åŒ…å«å¤§é‡æ•°æ®ï¼Œåœ¨æ•°æ®åº“å¤åˆ¶ï¼ˆå¦‚ä¸»ä»å¤åˆ¶ï¼‰å’Œå¤‡ä»½æ¢å¤è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šå¢åŠ ç½‘ç»œä¼ è¾“å’ŒI&#x2F;Oè´Ÿæ‹…ï¼Œå¯¼è‡´å»¶è¿Ÿã€‚</li><li><strong>æŸ¥è¯¢ä¼˜åŒ–</strong>ï¼šä¼˜åŒ–å™¨åœ¨å¤„ç†åŒ…å«TEXTå­—æ®µçš„æŸ¥è¯¢æ—¶å¯èƒ½ä¼šé€‰æ‹©æ•ˆç‡è¾ƒä½çš„æ‰§è¡Œè®¡åˆ’ï¼Œå› ä¸ºæ— æ³•å‡†ç¡®ä¼°è®¡TEXTå­—æ®µçš„å¤§å°ã€‚</li><li><strong>æ’åºå’Œåˆ†ç»„</strong>ï¼šå¦‚æœæŸ¥è¯¢éœ€è¦å¯¹TEXTå­—æ®µè¿›è¡Œæ’åºæˆ–åˆ†ç»„ï¼Œç”±äºæ•°æ®é‡å¤§ï¼Œå¯èƒ½ä¼šä½¿ç”¨ç£ç›˜ä¸´æ—¶è¡¨ï¼Œå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚</li></ol><p><strong>æ€»ç»“</strong>ï¼šåœ¨ä¸éœ€è¦å­˜å‚¨å¤§æ–‡æœ¬æ—¶ï¼Œä½¿ç”¨TEXTç±»å‹å¯èƒ½ä¼šå¸¦æ¥æ€§èƒ½ã€å­˜å‚¨å’ŒåŠŸèƒ½ä¸Šçš„é™åˆ¶ï¼Œå› æ­¤å»ºè®®ä»…åœ¨å¿…è¦æ—¶ä½¿ç”¨ã€‚</p><table><thead><tr><th align="left"><strong>åœºæ™¯</strong></th><th align="left"><strong>æ¨èç±»å‹</strong></th></tr></thead><tbody><tr><td align="left">çŸ­æ–‡æœ¬ï¼ˆ&lt; 255 å­—ç¬¦ï¼‰</td><td align="left"><code>VARCHAR(n)</code></td></tr><tr><td align="left">ä¸­ç­‰æ–‡æœ¬ï¼ˆ&lt; 64KBï¼‰</td><td align="left"><code>VARCHAR(65535)</code></td></tr><tr><td align="left">è¶…å¤§æ–‡æœ¬ï¼ˆ&gt; 64KBï¼‰</td><td align="left"><code>TEXT</code>ï¼ˆæˆ–åˆ†è¡¨å­˜å‚¨ï¼‰</td></tr></tbody></table><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      <categories>
          
          <category> MySQL </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>å­¦ä¹ &amp;é¢è¯•-Java</title>
      <link href="/post/7992e236.html"/>
      <url>/post/7992e236.html</url>
      
        <content type="html"><![CDATA[<h2 id="æ–°ç‰¹æ€§"><a href="#æ–°ç‰¹æ€§" class="headerlink" title="æ–°ç‰¹æ€§"></a>æ–°ç‰¹æ€§</h2><h3 id="Java-8"><a href="#Java-8" class="headerlink" title="Java 8"></a>Java 8</h3><h4 id="Lambda-è¡¨è¾¾å¼"><a href="#Lambda-è¡¨è¾¾å¼" class="headerlink" title="Lambda è¡¨è¾¾å¼"></a>Lambda è¡¨è¾¾å¼</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¼ ç»Ÿæ–¹å¼</span></span><br><span class="line"><span class="type">Runnable</span> <span class="variable">r1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Runnable 1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Lambda æ–¹å¼</span></span><br><span class="line"><span class="type">Runnable</span> <span class="variable">r2</span> <span class="operator">=</span> () -&gt; System.out.println(<span class="string">&quot;Runnable 2&quot;</span>);</span><br><span class="line"></span><br><span class="line">r1.run();  <span class="comment">// è¾“å‡º: Runnable 1</span></span><br><span class="line">r2.run();  <span class="comment">// è¾“å‡º: Runnable 2</span></span><br></pre></td></tr></table></figure><h4 id="å‡½æ•°å¼æ¥å£"><a href="#å‡½æ•°å¼æ¥å£" class="headerlink" title="å‡½æ•°å¼æ¥å£"></a>å‡½æ•°å¼æ¥å£</h4><p>åªæœ‰ä¸€ä¸ªæŠ½è±¡æ–¹æ³•çš„æ¥å£ï¼Œå¯ç”¨ <code>@FunctionalInterface</code> æ³¨è§£æ ‡è®°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">MathOperation</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">operate</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">MathOperation</span> <span class="variable">add</span> <span class="operator">=</span> (a, b) -&gt; a + b;</span><br><span class="line">        System.out.println(add.operate(<span class="number">5</span>, <span class="number">3</span>));  <span class="comment">// è¾“å‡º: 8</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ–¹æ³•å¼•ç”¨"><a href="#æ–¹æ³•å¼•ç”¨" class="headerlink" title="æ–¹æ³•å¼•ç”¨"></a>æ–¹æ³•å¼•ç”¨</h4><p>ç®€åŒ– Lambda è¡¨è¾¾å¼ï¼Œç›´æ¥å¼•ç”¨å·²æœ‰æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; names = Arrays.asList(<span class="string">&quot;Alice&quot;</span>, <span class="string">&quot;Bob&quot;</span>, <span class="string">&quot;Charlie&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Lambda è¡¨è¾¾å¼</span></span><br><span class="line">names.forEach(s -&gt; System.out.println(s));</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ–¹æ³•å¼•ç”¨</span></span><br><span class="line">names.forEach(System.out::println);  <span class="comment">// è¾“å‡ºæ‰€æœ‰å…ƒç´ </span></span><br></pre></td></tr></table></figure><h4 id="é»˜è®¤æ–¹æ³•"><a href="#é»˜è®¤æ–¹æ³•" class="headerlink" title="é»˜è®¤æ–¹æ³•"></a>é»˜è®¤æ–¹æ³•</h4><p>åœ¨æ¥å£ä¸­æä¾›é»˜è®¤å®ç°ï¼Œé¿å…ç ´åç°æœ‰å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Vehicle</span> &#123;</span><br><span class="line">    <span class="keyword">default</span> <span class="keyword">void</span> <span class="title function_">print</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æˆ‘æ˜¯ä¸€è¾†è½¦!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Car</span> <span class="keyword">implements</span> <span class="title class_">Vehicle</span> &#123;&#125;  <span class="comment">// æ— éœ€å®ç°printæ–¹æ³•</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Car</span>().print();  <span class="comment">// è¾“å‡º: æˆ‘æ˜¯ä¸€è¾†è½¦!</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Stream-API"><a href="#Stream-API" class="headerlink" title="Stream API"></a>Stream API</h4><p>å‡½æ•°å¼å¤„ç†é›†åˆæ•°æ®ï¼ˆè¿‡æ»¤ã€æ˜ å°„ã€å½’çº¦ç­‰ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Integer&gt; numbers = Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ±‚æ‰€æœ‰å¶æ•°çš„å¹³æ–¹å’Œ</span></span><br><span class="line"><span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> numbers.stream()</span><br><span class="line">        .filter(n -&gt; n % <span class="number">2</span> == <span class="number">0</span>)</span><br><span class="line">        .map(n -&gt; n * n)</span><br><span class="line">        .reduce(<span class="number">0</span>, Integer::sum);</span><br><span class="line"></span><br><span class="line">System.out.println(sum);  <span class="comment">// è¾“å‡º: 20 (2^2 + 4^2)</span></span><br></pre></td></tr></table></figure><h4 id="Optional-ç±»"><a href="#Optional-ç±»" class="headerlink" title="Optional ç±»"></a>Optional ç±»</h4><p>ä¼˜é›…å¤„ç† <code>null</code> å€¼ï¼Œé¿å… <code>NullPointerException</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Optional&lt;String&gt; name = Optional.ofNullable(getName());</span><br><span class="line"></span><br><span class="line"><span class="comment">// å­˜åœ¨æ—¶è¾“å‡ºï¼Œä¸å­˜åœ¨è¾“å‡ºé»˜è®¤å€¼</span></span><br><span class="line">System.out.println(name.orElse(<span class="string">&quot;Unknown&quot;</span>));  </span><br><span class="line"></span><br><span class="line"><span class="comment">// å®‰å…¨ä½¿ç”¨æ–¹æ³•å¼•ç”¨</span></span><br><span class="line">name.ifPresent(System.out::println);  </span><br><span class="line"></span><br><span class="line">String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Math.random() &gt; <span class="number">0.5</span> ? <span class="string">&quot;Alice&quot;</span> : <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ–°çš„æ—¥æœŸæ—¶é—´-API"><a href="#æ–°çš„æ—¥æœŸæ—¶é—´-API" class="headerlink" title="æ–°çš„æ—¥æœŸæ—¶é—´ API"></a>æ–°çš„æ—¥æœŸæ—¶é—´ API</h4><p>è§£å†³æ—§ <code>java.util.Date</code> çº¿ç¨‹å®‰å…¨é—®é¢˜</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–å½“å‰æ—¥æœŸå’Œæ—¶é—´</span></span><br><span class="line"><span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">System.out.println(<span class="string">&quot;å½“å‰æ—¶é—´: &quot;</span> + now);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ—¥æœŸæ“ä½œ</span></span><br><span class="line"><span class="type">LocalDate</span> <span class="variable">date</span> <span class="operator">=</span> LocalDate.of(<span class="number">2023</span>, Month.JANUARY, <span class="number">1</span>);</span><br><span class="line"><span class="type">LocalDate</span> <span class="variable">nextWeek</span> <span class="operator">=</span> date.plusWeeks(<span class="number">1</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;ä¸‹å‘¨æ—¥æœŸ: &quot;</span> + nextWeek);  <span class="comment">// 2023-01-08</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¡ç®—æ—¶é—´å·®</span></span><br><span class="line"><span class="type">Duration</span> <span class="variable">duration</span> <span class="operator">=</span> Duration.between(LocalTime.NOON, LocalTime.now());</span><br><span class="line">System.out.println(<span class="string">&quot;è·ä¸­åˆè¿‡å»ç§’æ•°: &quot;</span> + duration.getSeconds());</span><br></pre></td></tr></table></figure><h3 id="Java-11"><a href="#Java-11" class="headerlink" title="Java 11"></a>Java 11</h3><h4 id="å±€éƒ¨å˜é‡ç±»å‹æ¨æ–­å¢å¼º"><a href="#å±€éƒ¨å˜é‡ç±»å‹æ¨æ–­å¢å¼º" class="headerlink" title="å±€éƒ¨å˜é‡ç±»å‹æ¨æ–­å¢å¼º"></a>å±€éƒ¨å˜é‡ç±»å‹æ¨æ–­å¢å¼º</h4><p>å…è®¸åœ¨Lambdaè¡¨è¾¾å¼ä¸­ä½¿ç”¨<code>var</code>å£°æ˜å‚æ•°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LambdaVarExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        List&lt;String&gt; names = List.of(<span class="string">&quot;Alice&quot;</span>, <span class="string">&quot;Bob&quot;</span>, <span class="string">&quot;Charlie&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åœ¨Lambdaä¸­ä½¿ç”¨varå£°æ˜å‚æ•°</span></span><br><span class="line">        names.forEach((<span class="keyword">var</span> name) -&gt; System.out.println(name));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ–°çš„å­—ç¬¦ä¸²æ–¹æ³•"><a href="#æ–°çš„å­—ç¬¦ä¸²æ–¹æ³•" class="headerlink" title="æ–°çš„å­—ç¬¦ä¸²æ–¹æ³•"></a>æ–°çš„å­—ç¬¦ä¸²æ–¹æ³•</h4><p>æ–°å¢<code>isBlank()</code>ã€<code>lines()</code>ã€<code>strip()</code>ã€<code>repeat()</code>ç­‰æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StringMethodsDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// isBlank(): æ£€æŸ¥ç©ºæˆ–ç©ºç™½</span></span><br><span class="line">        System.out.println(<span class="string">&quot; &quot;</span>.isBlank()); <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// lines(): åˆ†å‰²ä¸ºè¡Œæµ</span></span><br><span class="line">        <span class="string">&quot;Line1\nLine2&quot;</span>.lines().forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// strip(): å»é™¤é¦–å°¾ç©ºç™½ï¼ˆæ¯”trim()æ›´æ™ºèƒ½ï¼‰</span></span><br><span class="line">        System.out.println(<span class="string">&quot;  Hello  &quot;</span>.strip()); <span class="comment">// &quot;Hello&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// repeat(): é‡å¤å­—ç¬¦ä¸²</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Java&quot;</span>.repeat(<span class="number">3</span>)); <span class="comment">// &quot;JavaJavaJava&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ ‡å‡†HTTPå®¢æˆ·ç«¯"><a href="#æ ‡å‡†HTTPå®¢æˆ·ç«¯" class="headerlink" title="æ ‡å‡†HTTPå®¢æˆ·ç«¯"></a>æ ‡å‡†HTTPå®¢æˆ·ç«¯</h4><p>æ›¿ä»£æ—§<code>HttpURLConnection</code>ï¼Œæ”¯æŒHTTP&#x2F;2å’ŒWebSocketã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.net.URI;</span><br><span class="line"><span class="keyword">import</span> java.net.http.HttpClient;</span><br><span class="line"><span class="keyword">import</span> java.net.http.HttpRequest;</span><br><span class="line"><span class="keyword">import</span> java.net.http.HttpResponse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpClientDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">HttpClient</span> <span class="variable">client</span> <span class="operator">=</span> HttpClient.newHttpClient();</span><br><span class="line">        <span class="type">HttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> HttpRequest.newBuilder()</span><br><span class="line">                .uri(URI.create(<span class="string">&quot;https://httpbin.org/get&quot;</span>))</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å‘é€åŒæ­¥è¯·æ±‚</span></span><br><span class="line">        HttpResponse&lt;String&gt; response = </span><br><span class="line">            client.send(request, HttpResponse.BodyHandlers.ofString());</span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">&quot;Status: &quot;</span> + response.statusCode());</span><br><span class="line">        System.out.println(<span class="string">&quot;Body: &quot;</span> + response.body());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ–‡ä»¶è¯»å†™ç®€åŒ–"><a href="#æ–‡ä»¶è¯»å†™ç®€åŒ–" class="headerlink" title="æ–‡ä»¶è¯»å†™ç®€åŒ–"></a>æ–‡ä»¶è¯»å†™ç®€åŒ–</h4><p>æ–°å¢<code>readString()</code>å’Œ<code>writeString()</code>æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.nio.file.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileReadWriteDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Path</span> <span class="variable">path</span> <span class="operator">=</span> Paths.get(<span class="string">&quot;test.txt&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å†™å…¥æ–‡ä»¶</span></span><br><span class="line">        Files.writeString(path, <span class="string">&quot;Hello Java 11!&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è¯»å–æ–‡ä»¶</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> Files.readString(path);</span><br><span class="line">        System.out.println(content); <span class="comment">// &quot;Hello Java 11!&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="é›†åˆè½¬æ•°ç»„çš„ä¾¿æ·æ–¹æ³•"><a href="#é›†åˆè½¬æ•°ç»„çš„ä¾¿æ·æ–¹æ³•" class="headerlink" title="é›†åˆè½¬æ•°ç»„çš„ä¾¿æ·æ–¹æ³•"></a>é›†åˆè½¬æ•°ç»„çš„ä¾¿æ·æ–¹æ³•</h4><p><code>Collection.toArray(IntFunction)</code>ç®€åŒ–æ•°ç»„è½¬æ¢ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CollectionToArrayDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        List&lt;String&gt; list = List.of(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;C&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ç›´æ¥ä¼ å…¥æ•°ç»„æ„é€ å‡½æ•°å¼•ç”¨</span></span><br><span class="line">        String[] array = list.toArray(String[]::<span class="keyword">new</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (String s : array) &#123;</span><br><span class="line">            System.out.println(s); <span class="comment">// è¾“å‡ºA, B, C</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Java-17"><a href="#Java-17" class="headerlink" title="Java 17"></a>Java 17</h3><h4 id="æ¨¡å¼åŒ¹é…-instanceof"><a href="#æ¨¡å¼åŒ¹é…-instanceof" class="headerlink" title="æ¨¡å¼åŒ¹é… instanceof"></a>æ¨¡å¼åŒ¹é… <code>instanceof</code></h4><p>ç®€åŒ–ç±»å‹æ£€æŸ¥å’Œè½¬æ¢</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="string">&quot;Hello Java 17&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ—§å†™æ³•</span></span><br><span class="line"><span class="keyword">if</span> (obj <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> (String) obj;</span><br><span class="line">    System.out.println(s.toLowerCase());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ–°å†™æ³•ï¼šè‡ªåŠ¨ç±»å‹è½¬æ¢</span></span><br><span class="line"><span class="keyword">if</span> (obj <span class="keyword">instanceof</span> String s) &#123;</span><br><span class="line">    System.out.println(s.toLowerCase()); <span class="comment">// ç›´æ¥ä½¿ç”¨å˜é‡ s</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ–‡æœ¬å—"><a href="#æ–‡æœ¬å—" class="headerlink" title="æ–‡æœ¬å—"></a>æ–‡æœ¬å—</h4><p>ç®€åŒ–å¤šè¡Œå­—ç¬¦ä¸²å¤„ç†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ—§å†™æ³•ï¼ˆéœ€æ‰‹åŠ¨æ¢è¡Œå’Œè½¬ä¹‰ï¼‰</span></span><br><span class="line"><span class="type">String</span> <span class="variable">oldHtml</span> <span class="operator">=</span> <span class="string">&quot;&lt;html&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  &lt;body&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;     &lt;p&gt;Hello&lt;/p&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  &lt;/body&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;/html&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ–°å†™æ³•ï¼šæ–‡æœ¬å—ï¼ˆè‡ªåŠ¨ä¿ç•™æ ¼å¼ï¼‰</span></span><br><span class="line"><span class="type">String</span> <span class="variable">newHtml</span> <span class="operator">=</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                &lt;html&gt;</span></span><br><span class="line"><span class="string">                  &lt;body&gt;</span></span><br><span class="line"><span class="string">                    &lt;p&gt;Hello Java 17&lt;/p&gt;</span></span><br><span class="line"><span class="string">                  &lt;/body&gt;</span></span><br><span class="line"><span class="string">                &lt;/html&gt;</span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span>;</span><br><span class="line">System.out.println(newHtml);</span><br></pre></td></tr></table></figure><h4 id="ä¼ªéšæœºæ•°ç”Ÿæˆå™¨-API"><a href="#ä¼ªéšæœºæ•°ç”Ÿæˆå™¨-API" class="headerlink" title="ä¼ªéšæœºæ•°ç”Ÿæˆå™¨ API"></a>ä¼ªéšæœºæ•°ç”Ÿæˆå™¨ API</h4><p>ç»Ÿä¸€éšæœºæ•°ç”Ÿæˆå™¨æ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.random.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RandomDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// é€‰æ‹©ç®—æ³•ï¼ˆå¦‚ L32X64MixRandomï¼‰</span></span><br><span class="line">        <span class="type">RandomGenerator</span> <span class="variable">generator</span> <span class="operator">=</span> RandomGeneratorFactory.of(<span class="string">&quot;L32X64MixRandom&quot;</span>).create();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ç”Ÿæˆéšæœºæ•°</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">randomNum</span> <span class="operator">=</span> generator.nextInt(<span class="number">100</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;Random: &quot;</span> + randomNum);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Java-21"><a href="#Java-21" class="headerlink" title="Java 21"></a>Java 21</h3><h4 id="è™šæ‹Ÿçº¿ç¨‹"><a href="#è™šæ‹Ÿçº¿ç¨‹" class="headerlink" title="è™šæ‹Ÿçº¿ç¨‹"></a>è™šæ‹Ÿçº¿ç¨‹</h4><p>è½»é‡çº§çº¿ç¨‹ï¼Œæ˜¾è‘—æå‡å¹¶å‘æ€§èƒ½</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> (<span class="type">var</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newVirtualThreadPerTaskExecutor()) &#123;</span><br><span class="line">    IntStream.range(<span class="number">0</span>, <span class="number">10_000</span>).forEach(i -&gt; </span><br><span class="line">        executor.submit(() -&gt; &#123;</span><br><span class="line">            Thread.sleep(Duration.ofSeconds(<span class="number">1</span>));</span><br><span class="line">            <span class="keyword">return</span> i;</span><br><span class="line">        &#125;)</span><br><span class="line">    );</span><br><span class="line">&#125; <span class="comment">// è‡ªåŠ¨ç­‰å¾…æ‰€æœ‰çº¿ç¨‹ç»“æŸ</span></span><br></pre></td></tr></table></figure><h4 id="ç»“æ„åŒ–å¹¶å‘"><a href="#ç»“æ„åŒ–å¹¶å‘" class="headerlink" title="ç»“æ„åŒ–å¹¶å‘"></a>ç»“æ„åŒ–å¹¶å‘</h4><p>ç®€åŒ–å¤šçº¿ç¨‹ä»»åŠ¡ç®¡ç†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> (<span class="type">var</span> <span class="variable">scope</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StructuredTaskScope</span>.ShutdownOnFailure()) &#123;</span><br><span class="line">    Future&lt;String&gt; user  = scope.fork(() -&gt; fetchUser());</span><br><span class="line">    Future&lt;Integer&gt; order = scope.fork(() -&gt; fetchOrder());</span><br><span class="line"></span><br><span class="line">    scope.join();          <span class="comment">// ç­‰å¾…æ‰€æœ‰ä»»åŠ¡</span></span><br><span class="line">    scope.throwIfFailed(); <span class="comment">// å¼‚å¸¸ä¼ æ’­</span></span><br><span class="line"></span><br><span class="line">    System.out.println(user.resultNow() + <span class="string">&quot;: &quot;</span> + order.resultNow());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="JavaåŸºç¡€"><a href="#JavaåŸºç¡€" class="headerlink" title="JavaåŸºç¡€"></a>JavaåŸºç¡€</h2><ul><li><strong>ç²¾é€š Java 8+ ç‰¹æ€§:</strong> Lambda è¡¨è¾¾å¼ã€Stream APIï¼ˆå¹¶è¡ŒæµåŸç†ä¸é™·é˜±ï¼‰ã€Optionalã€æ–°çš„æ—¥æœŸæ—¶é—´ APIã€æ¥å£é»˜è®¤&#x2F;é™æ€æ–¹æ³•ã€æ–¹æ³•å¼•ç”¨ç­‰ã€‚ç†è§£å…¶è®¾è®¡æ€æƒ³å’Œå†…éƒ¨æœºåˆ¶ã€‚</li></ul><h3 id="è¯­æ³•åŸºç¡€"><a href="#è¯­æ³•åŸºç¡€" class="headerlink" title="è¯­æ³•åŸºç¡€"></a>è¯­æ³•åŸºç¡€</h3><h4 id="equalså’ŒhashCodeä¸ºä»€ä¹ˆè¦åŒæ—¶é‡å†™"><a href="#equalså’ŒhashCodeä¸ºä»€ä¹ˆè¦åŒæ—¶é‡å†™" class="headerlink" title="equalså’ŒhashCodeä¸ºä»€ä¹ˆè¦åŒæ—¶é‡å†™"></a><code>equals</code>å’Œ<code>hashCode</code>ä¸ºä»€ä¹ˆè¦åŒæ—¶é‡å†™</h4><p><strong><code>Object</code>ç±»çš„è§„èŒƒ</strong>æ˜ç¡®è§„å®šï¼šå¦‚æœä¸¤ä¸ªå¯¹è±¡é€šè¿‡<code>equals()</code>æ–¹æ³•æ¯”è¾ƒæ˜¯ç›¸ç­‰çš„ï¼Œé‚£ä¹ˆå®ƒä»¬çš„<code>hashCode()</code><strong>å¿…é¡»</strong>è¿”å›ç›¸åŒçš„å€¼ã€‚</p><p>æœªé‡å†™çš„<code>hasoCode()</code>é»˜è®¤è¿”å›å†…å­˜åœ°å€ï¼Œå¦‚æœåªé‡å†™äº†<code>equals()</code>ï¼Œä¸¤ä¸ªå¯¹è±¡<code>a</code>å’Œ<code>b</code>æ»¡è¶³<code>a.equals(b) == true</code>ï¼Œä½†<code>a.hashCode() != b.hashCode()</code>ï¼ŒåŸºäºå“ˆå¸Œçš„é›†åˆå¦‚ï¼ˆ<code>HashMap</code>, <code>HashSet</code>ï¼‰ä¼šå­˜å‚¨å¤šä¸ªé€»è¾‘ç›¸ç­‰çš„å¯¹è±¡ã€‚</p><p>å› æ­¤é‡å†™<code>equals()</code>åŒæ—¶ä¹Ÿè¦é‡å†™<code>hashCode()</code>ï¼Œæ¨èå®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Objects.hash(name, age); <span class="comment">// åŒ…å«æ‰€æœ‰equalsä¸­ä½¿ç”¨çš„å­—æ®µ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å¼‚å¸¸çš„å±‚æ¬¡ç»“æ„"><a href="#å¼‚å¸¸çš„å±‚æ¬¡ç»“æ„" class="headerlink" title="å¼‚å¸¸çš„å±‚æ¬¡ç»“æ„"></a>å¼‚å¸¸çš„å±‚æ¬¡ç»“æ„</h4><p><code>Throwable</code>ï¼šæ‰€æœ‰å¼‚å¸¸å’Œé”™è¯¯çš„çˆ¶ç±»</p><p><code>Error</code>ï¼š<strong>ç³»ç»Ÿçº§ä¸¥é‡é—®é¢˜</strong>ï¼Œåº”ç”¨ç¨‹åºé€šå¸¸æ— æ³•æ¢å¤ã€‚å¦‚<code>OutOfMemoryError</code>ã€<code>StackOverflowError</code>ï¼šã€<code>VirtualMachineError</code></p><p><code>Exception</code>ï¼š<strong>ç¨‹åºå¯å¤„ç†çš„å¼‚å¸¸</strong>ï¼Œåˆ†ä¸ºä¸¤ç±»ï¼š</p><ul><li><p><strong>Checked Exceptionsï¼ˆå—æ£€å¼‚å¸¸ï¼‰</strong><br>ç¼–è¯‘å™¨å¼ºåˆ¶è¦æ±‚å¤„ç†ï¼ˆå¿…é¡»<code>try-catch</code>æˆ–<code>throws</code>ï¼‰<br>âœ… <strong>å…¸å‹ä»£è¡¨</strong>ï¼š<code>IOException</code>ã€<code>SQLException</code>ã€<code>ClassNotFoundException</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¿…é¡»å¤„ç†IOExceptionçš„ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  Files.readString(Path.of(<span class="string">&quot;file.txt&quot;</span>));</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123; <span class="comment">// å¿…é¡»æ•è·</span></span><br><span class="line">  e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong><code>RuntimeException</code>ï¼ˆè¿è¡Œæ—¶å¼‚å¸¸&#x2F;éå—æ£€å¼‚å¸¸ï¼‰</strong><br>ç¼–è¯‘å™¨ä¸å¼ºåˆ¶å¤„ç†ï¼Œé€šå¸¸ç”±<strong>ç¼–ç¨‹é€»è¾‘é”™è¯¯</strong>å¼•èµ·<br>âš ï¸ <strong>å…¸å‹ä»£è¡¨</strong>ï¼š<code>NullPointerException</code>ã€<code>IndexOutOfBoundsException</code>ã€<code>IllegalArgumentException</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯é€‰çš„è¿è¡Œæ—¶å¼‚å¸¸å¤„ç†</span></span><br><span class="line"><span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  System.out.println(str.length()); <span class="comment">// æŠ›å‡ºNullPointerException</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (RuntimeException e) &#123; <span class="comment">// éå¼ºåˆ¶æ•è·</span></span><br><span class="line">  System.out.println(<span class="string">&quot;é€»è¾‘é”™è¯¯ï¼&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><img src="/post/7992e236/image-20250720163023390.png" class="" title="image-20250720163023390"><h3 id="æ³›å‹"><a href="#æ³›å‹" class="headerlink" title="æ³›å‹"></a>æ³›å‹</h3><h4 id="ä¸ºä»€ä¹ˆéœ€è¦æ³›å‹"><a href="#ä¸ºä»€ä¹ˆéœ€è¦æ³›å‹" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦æ³›å‹"></a>ä¸ºä»€ä¹ˆéœ€è¦æ³›å‹</h4><p>æ³›å‹ï¼ˆGenericsï¼‰æ˜¯ç°ä»£ç¼–ç¨‹è¯­è¨€ä¸­ä¸€é¡¹æå…¶é‡è¦çš„ç‰¹æ€§ï¼Œå®ƒçš„å‡ºç°ä¸»è¦æ˜¯ä¸ºäº†è§£å†³<strong>ç±»å‹å®‰å…¨</strong>ã€<strong>ä»£ç å¤ç”¨</strong>ä¸¤å¤§é—®é¢˜ã€‚</p><p>ğŸ“ 1. <strong>ç±»å‹å®‰å…¨ï¼ˆType Safetyï¼‰</strong></p><ul><li><strong>é—®é¢˜ï¼š</strong> åœ¨æ²¡æœ‰æ³›å‹ä¹‹å‰ï¼Œå®¹å™¨ç±»å¯ä»¥å­˜æ”¾ä»»ä½•ç±»å‹çš„å¯¹è±¡ã€‚å½“ä½ ä»å®¹å™¨ä¸­å–å‡ºå¯¹è±¡æ—¶ï¼Œä½ éœ€è¦è¿›è¡Œå¼ºåˆ¶ç±»å‹è½¬æ¢ (<code>(String) myList.get(0)</code>)ã€‚</li><li><strong>é£é™©ï¼š</strong> å¦‚æœå®¹å™¨é‡Œä¸å°å¿ƒæ”¾å…¥äº†é”™è¯¯çš„ç±»å‹ï¼ˆæ¯”å¦‚ä½ æœŸæœ›æ˜¯ <code>String</code>ï¼Œä½†å®é™…æ”¾å…¥äº† <code>Integer</code>ï¼‰ï¼Œè¿™ä¸ªé”™è¯¯åœ¨<strong>ç¼–è¯‘æ—¶ä¸ä¼šè¢«å‘ç°</strong>ï¼Œåªæœ‰åœ¨<strong>è¿è¡Œæ—¶è¿›è¡Œå¼ºåˆ¶è½¬æ¢æ—¶</strong>æ‰ä¼šæŠ›å‡º <code>ClassCastException</code>ï¼Œå¯¼è‡´ç¨‹åºå´©æºƒã€‚</li><li><strong>æ³›å‹è§£å†³æ–¹æ¡ˆï¼š</strong> æ³›å‹å…è®¸ä½ åœ¨<strong>å£°æ˜</strong>å®¹å™¨æ—¶å°±æŒ‡å®šå®ƒåªèƒ½å­˜æ”¾ç‰¹å®šç±»å‹ï¼ˆå¦‚ <code>List&lt;String&gt;</code>ï¼‰ã€‚ç¼–è¯‘å™¨ä¼šåœ¨<strong>ç¼–è¯‘æ—¶</strong>ä¸¥æ ¼æ£€æŸ¥ä½ æ”¾å…¥å®¹å™¨çš„å¯¹è±¡ç±»å‹æ˜¯å¦åŒ¹é…ã€‚å¦‚æœå°è¯•æ”¾å…¥é”™è¯¯ç±»å‹ï¼Œç¼–è¯‘å™¨ä¼šç›´æ¥æŠ¥é”™ï¼Œé˜»æ­¢æ½œåœ¨çš„ç±»å‹é”™è¯¯è¿è¡Œåˆ°ç”Ÿäº§ç¯å¢ƒã€‚ä½¿ç”¨æ³›å‹å®¹å™¨ï¼ˆå¦‚ <code>List&lt;String&gt;</code>ï¼‰åï¼Œå½“ä½ ä»å®¹å™¨ä¸­è·å–å…ƒç´ æ—¶ï¼ˆå¦‚ <code>String s = myList.get(0);</code>ï¼‰ï¼Œ<strong>ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨çŸ¥é“è¿”å›çš„æ˜¯ <code>String</code> ç±»å‹ï¼Œä¸éœ€è¦ä»»ä½•å¼ºåˆ¶è½¬æ¢</strong>ã€‚ä»£ç æ›´ç®€æ´ï¼Œæ›´å®‰å…¨ã€‚</li></ul><p>â™» 2. <strong>ä»£ç å¤ç”¨ï¼ˆCode Reuseï¼‰</strong></p><ul><li><strong>é—®é¢˜ï¼š</strong> ç¼–å†™ä¸€ä¸ªç®—æ³•ï¼ˆæ¯”å¦‚æ’åºã€æœç´¢ã€æ¯”è¾ƒï¼‰ï¼Œä½ å¸Œæœ›å®ƒèƒ½ä½œç”¨äºå¤šç§ä¸åŒç±»å‹çš„å¯¹è±¡ï¼ˆæ•´æ•°ã€å­—ç¬¦ä¸²ã€è‡ªå®šä¹‰å¯¹è±¡ç­‰ï¼‰ã€‚æ²¡æœ‰æ³›å‹æ—¶ï¼Œä½ éœ€è¦ä¸ºæ¯ç§ç±»å‹é‡å†™ç®—æ³•ï¼Œæˆ–è€…ä½¿ç”¨ <code>Object</code> å¹¶ä¼´éšç±»å‹æ£€æŸ¥å’Œè½¬æ¢ã€‚</li><li><strong>æ³›å‹è§£å†³æ–¹æ¡ˆï¼š</strong> æ³›å‹å…è®¸ä½ ç¼–å†™<strong>ç±»å‹æ— å…³çš„ç®—æ³•</strong>ã€‚ä½ å¯ä»¥å®šä¹‰ä¸€ä¸ªæ“ä½œåœ¨ç±»å‹å‚æ•° <code>T</code> ä¸Šçš„æ–¹æ³•æˆ–ç±»ï¼ˆä¾‹å¦‚ <code>public static &lt;T&gt; void sort(List&lt;T&gt; list, Comparator&lt;? super T&gt; c)</code>ï¼‰ã€‚åªè¦ç±»å‹ <code>T</code> æ»¡è¶³ç®—æ³•æ‰€éœ€çš„åŸºæœ¬æ¡ä»¶ï¼ˆæ¯”å¦‚å®ç°äº† <code>Comparable</code> æ¥å£ï¼‰ï¼ŒåŒä¸€ä¸ªç®—æ³•ä»£ç å°±å¯ä»¥å®‰å…¨åœ°åº”ç”¨äºå„ç§ä¸åŒçš„æ•°æ®ç±»å‹ã€‚</li></ul><h4 id="ä»€ä¹ˆæ˜¯æ³›å‹æ“¦é™¤"><a href="#ä»€ä¹ˆæ˜¯æ³›å‹æ“¦é™¤" class="headerlink" title="ä»€ä¹ˆæ˜¯æ³›å‹æ“¦é™¤"></a>ä»€ä¹ˆæ˜¯æ³›å‹æ“¦é™¤</h4><p>æ³›å‹æ“¦é™¤ï¼ˆType Erasureï¼‰æ˜¯ <strong>Java æ³›å‹å®ç°çš„æ ¸å¿ƒæœºåˆ¶</strong>ï¼Œå®ƒæŒ‡ç¼–è¯‘å™¨åœ¨ç¼–è¯‘é˜¶æ®µ<strong>ç§»é™¤æ‰€æœ‰æ³›å‹ç±»å‹ä¿¡æ¯</strong>ï¼Œå°†å…¶æ›¿æ¢ä¸ºåŸå§‹ç±»å‹ï¼ˆRaw Typeï¼‰æˆ–è¾¹ç•Œç±»å‹ï¼ˆBound Typeï¼‰ï¼Œå¹¶åœ¨å¿…è¦æ—¶æ’å…¥å¼ºåˆ¶ç±»å‹è½¬æ¢ã€‚è¿™ä¸€è®¾è®¡ä¸»è¦æ˜¯ä¸ºäº†<strong>å…¼å®¹æ—§ç‰ˆæœ¬çš„ Javaï¼ˆJDK 5 ä¹‹å‰ï¼‰</strong>ï¼Œç¡®ä¿æ³›å‹ä»£ç èƒ½ä¸éæ³›å‹é—ç•™ä»£ç äº’æ“ä½œã€‚</p><p><strong>ä¸€ã€æ³›å‹æ“¦é™¤çš„æ ¸å¿ƒè§„åˆ™</strong></p><ol><li><p><strong>ç±»å‹å‚æ•°æ›¿æ¢ä¸ºè¾¹ç•Œç±»å‹</strong></p><ul><li>è‹¥ç±»å‹å‚æ•°æœ‰ä¸Šé™ï¼ˆå¦‚ <code>&lt;T extends Number&gt;</code>ï¼‰ï¼Œ<code>T</code> è¢«æ›¿æ¢ä¸º<strong>è¾¹ç•Œç±»å‹</strong>ï¼ˆ<code>Number</code>ï¼‰ã€‚</li><li>è‹¥æ— æ˜ç¡®ä¸Šé™ï¼ˆå¦‚ <code>&lt;T&gt;</code>ï¼‰ï¼Œ<code>T</code> è¢«æ›¿æ¢ä¸º <code>Object</code>ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¼–è¯‘å‰</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Box</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> T value;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(T value)</span> &#123; <span class="built_in">this</span>.value = value; &#125;</span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">get</span><span class="params">()</span> &#123; <span class="keyword">return</span> value; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¼–è¯‘åï¼ˆæ“¦é™¤åï¼‰</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Box</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Object value;         <span class="comment">// T â†’ Object</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(Object value)</span> &#123; <span class="built_in">this</span>.value = value; &#125;</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">()</span> &#123; <span class="keyword">return</span> value; &#125; <span class="comment">// è¿”å› Object</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong>åœ¨è°ƒç”¨å¤„æ’å…¥å¼ºåˆ¶ç±»å‹è½¬æ¢</strong><br>ç¼–è¯‘å™¨åœ¨<strong>ä½¿ç”¨æ³›å‹çš„åœ°æ–¹</strong>è‡ªåŠ¨æ·»åŠ ç±»å‹è½¬æ¢ä»£ç ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¼–è¯‘å‰</span></span><br><span class="line">Box&lt;String&gt; box = <span class="keyword">new</span> <span class="title class_">Box</span>&lt;&gt;();</span><br><span class="line">box.set(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> box.get(); <span class="comment">// æ— éœ€æ˜¾å¼è½¬æ¢</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¼–è¯‘åï¼ˆæ“¦é™¤åï¼‰</span></span><br><span class="line"><span class="type">Box</span> <span class="variable">box</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Box</span>();</span><br><span class="line">box.set(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> (String) box.get(); <span class="comment">// ç¼–è¯‘å™¨æ’å…¥ (String) å¼ºåˆ¶è½¬æ¢</span></span><br></pre></td></tr></table></figure></li><li><p><strong>ä¿è¯ç±»å‹å®‰å…¨çš„æ¡¥æ¥æ–¹æ³•ï¼ˆBridge Methodsï¼‰</strong><br>å½“æ³›å‹ç±»ç»§æ‰¿æˆ–å®ç°æ¥å£æ—¶ï¼Œç¼–è¯‘å™¨ä¼šç”Ÿæˆ<strong>åˆæˆæ–¹æ³•</strong>ç¡®ä¿å¤šæ€æ€§ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¼–è¯‘å‰</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Comparable</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">compareTo</span><span class="params">(T other)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">String</span> <span class="keyword">implements</span> <span class="title class_">Comparable</span>&lt;String&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compareTo</span><span class="params">(String other)</span> &#123; ... &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¼–è¯‘åï¼ˆæ“¦é™¤åï¼‰</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">String</span> <span class="keyword">implements</span> <span class="title class_">Comparable</span> &#123;</span><br><span class="line">    <span class="comment">// ç¼–è¯‘å™¨ç”Ÿæˆçš„æ¡¥æ¥æ–¹æ³•ï¼ˆä¿æŒå¤šæ€ï¼‰</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compareTo</span><span class="params">(Object other)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> compareTo((String) other); <span class="comment">// è°ƒç”¨å®é™…æ–¹æ³•</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®é™…ç¼–å†™çš„æ³›å‹æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compareTo</span><span class="params">(String other)</span> &#123; ... &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p><strong>äºŒã€æ³›å‹æ“¦é™¤å¯¼è‡´çš„å…³é”®é™åˆ¶</strong></p><ol><li><p><strong>æ— æ³•ä½¿ç”¨åŸºæœ¬ç±»å‹ä½œä¸ºç±»å‹å‚æ•°</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âŒ ç¼–è¯‘é”™è¯¯ï¼ä¸èƒ½ä½¿ç”¨ int</span></span><br><span class="line">List&lt;<span class="type">int</span>&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(); </span><br><span class="line"><span class="comment">// å¿…é¡»ä½¿ç”¨åŒ…è£…ç±»</span></span><br><span class="line">List&lt;Integer&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(); </span><br></pre></td></tr></table></figure></li><li><p><strong>æ— æ³•è·å–æ³›å‹å…·ä½“ç±»å‹çš„ <code>Class</code> å¯¹è±¡</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"><span class="comment">// âŒ ç¼–è¯‘é”™è¯¯ï¼List&lt;String&gt;.class ä¸å­˜åœ¨</span></span><br><span class="line">Class&lt;?&gt; clazz = list.getClass(); </span><br><span class="line"><span class="comment">// è¾“å‡ºï¼šjava.util.ArrayListï¼ˆæ— æ³•å¾—çŸ¥æ˜¯ List&lt;String&gt;</span></span><br></pre></td></tr></table></figure></li><li><p><strong>æ— æ³•åˆ›å»ºæ³›å‹æ•°ç»„</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âŒ ç¼–è¯‘é”™è¯¯ï¼</span></span><br><span class="line">T[] array = <span class="keyword">new</span> <span class="title class_">T</span>[<span class="number">10</span>]; </span><br><span class="line"><span class="comment">// æ›¿ä»£æ–¹æ¡ˆï¼šä½¿ç”¨åå°„æˆ– ArrayList</span></span><br></pre></td></tr></table></figure></li><li><p><strong>æ–¹æ³•ç­¾åå†²çªï¼ˆé‡è½½å¤±æ•ˆï¼‰</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âŒ ç¼–è¯‘é”™è¯¯ï¼æ“¦é™¤åéƒ½æ˜¯ void print(List list)</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">print</span><span class="params">(List&lt;String&gt; list)</span> &#123; ... &#125;</span><br><span class="line"><span class="keyword">void</span> <span class="title function_">print</span><span class="params">(List&lt;Integer&gt; list)</span> &#123; ... </span><br></pre></td></tr></table></figure></li></ol><p><strong>ä¸‰ã€å¦‚ä½•ç»•è¿‡æ“¦é™¤çš„é™åˆ¶ï¼Ÿ</strong></p><ol><li><p><strong>ç±»å‹ä»¤ç‰Œï¼ˆType Tokenï¼‰</strong><br>é€šè¿‡ä¼ é€’ <code>Class&lt;T&gt;</code> å¯¹è±¡ä¿ç•™ç±»å‹ä¿¡æ¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Box</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> Class&lt;T&gt; type;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Box</span><span class="params">(Class&lt;T&gt; type)</span> &#123; <span class="built_in">this</span>.type = type; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isInstance</span><span class="params">(Object obj)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> type.isInstance(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong>åå°„ APIï¼ˆReflectionï¼‰</strong><br>è¿è¡Œæ—¶è·å–æ³›å‹å‚æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Box</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> T value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(T value)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è·å–æ³›å‹ç±»çš„æ³›å‹ç±»å‹</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassGenericReflection</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºå…·æœ‰å…·ä½“ç±»å‹çš„Boxå®ä¾‹</span></span><br><span class="line">        Box&lt;String&gt; stringBox = <span class="keyword">new</span> <span class="title class_">Box</span>&lt;String&gt;() &#123;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–å®é™…æ³›å‹å‚æ•°</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Type</span> <span class="variable">genericSuperclass</span> <span class="operator">=</span> stringBox.getClass().getGenericSuperclass();</span><br><span class="line">        <span class="keyword">if</span> (genericSuperclass <span class="keyword">instanceof</span> ParameterizedType) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">ParameterizedType</span> <span class="variable">parameterizedType</span> <span class="operator">=</span> (ParameterizedType) genericSuperclass;</span><br><span class="line">            <span class="keyword">final</span> Type[] actualTypeArguments = parameterizedType.getActualTypeArguments();</span><br><span class="line">            <span class="keyword">if</span> (actualTypeArguments.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;æ³›å‹å‚æ•°: &quot;</span> + actualTypeArguments[<span class="number">0</span>]); <span class="comment">// è¾“å‡º: class java.lang.String</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è·å–æ³›å‹å­—æ®µçš„æ³›å‹ç±»å‹</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FieldGenericReflection</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Box&lt;String&gt; stringBox;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchFieldException &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> FieldGenericReflection.class.getDeclaredField(<span class="string">&quot;stringBox&quot;</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Type</span> <span class="variable">genericType</span> <span class="operator">=</span> field.getGenericType();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (genericType <span class="keyword">instanceof</span> ParameterizedType) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">ParameterizedType</span> <span class="variable">parameterizedType</span> <span class="operator">=</span> (ParameterizedType) genericType;</span><br><span class="line">            <span class="keyword">final</span> Type[] arguments = parameterizedType.getActualTypeArguments();</span><br><span class="line">            <span class="keyword">if</span> (arguments.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Boxçš„æ³›å‹å‚æ•°: &quot;</span> + arguments[<span class="number">0</span>]); <span class="comment">// class java.lang.String</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è·å–æ³›å‹æ–¹æ³•å½¢å‚çš„ç±»å‹å‚æ•°</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ParameterGenericReflection</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Processor</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(List&lt;Box&lt;String&gt;&gt; boxes)</span> &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchMethodException &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> Processor.class.getMethod(<span class="string">&quot;process&quot;</span>, List.class);</span><br><span class="line">        <span class="keyword">final</span> Type[] parameterTypes = method.getGenericParameterTypes();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Type parameterType : parameterTypes) &#123;</span><br><span class="line">            <span class="keyword">if</span> (parameterType <span class="keyword">instanceof</span> ParameterizedType) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">ParameterizedType</span> <span class="variable">pt</span> <span class="operator">=</span> (ParameterizedType) parameterType;</span><br><span class="line">                System.out.println(<span class="string">&quot;å‚æ•°ç±»å‹ï¼š&quot;</span> + pt.getRawType());</span><br><span class="line"></span><br><span class="line">                <span class="keyword">final</span> Type[] typeArguments = pt.getActualTypeArguments();</span><br><span class="line">                <span class="keyword">for</span> (Type typeArgument : typeArguments) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (typeArgument <span class="keyword">instanceof</span> ParameterizedType) &#123;</span><br><span class="line">                        <span class="keyword">final</span> <span class="type">ParameterizedType</span> <span class="variable">nestedPt</span> <span class="operator">=</span> (ParameterizedType) typeArgument;</span><br><span class="line">                        System.out.println(<span class="string">&quot;åµŒå¥—ç±»å‹ï¼š&quot;</span> + nestedPt.getRawType());</span><br><span class="line">                        <span class="keyword">final</span> Type[] nestedTypeArguments = nestedPt.getActualTypeArguments();</span><br><span class="line">                        <span class="keyword">if</span> (nestedTypeArguments.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            System.out.println(<span class="string">&quot;åµŒå¥—æ³›å‹å‚æ•°ï¼š&quot;</span> + nestedTypeArguments[<span class="number">0</span>]);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è·å–æ³›å‹æ–¹æ³•è¿”å›å€¼çš„ç±»å‹å‚æ•°</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReturnTypeGenericReflection</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Integer&gt; <span class="title function_">getMappings</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchMethodException &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> ReturnTypeGenericReflection.class.getMethod(<span class="string">&quot;getMappings&quot;</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Type</span> <span class="variable">returnType</span> <span class="operator">=</span> method.getGenericReturnType();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (returnType <span class="keyword">instanceof</span> ParameterizedType) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">ParameterizedType</span> <span class="variable">parameterizedType</span> <span class="operator">=</span> (ParameterizedType) returnType;</span><br><span class="line">            <span class="keyword">final</span> Type[] typeArguments = parameterizedType.getActualTypeArguments();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; typeArguments.length; i++) &#123;</span><br><span class="line">                System.out.println(String.format(<span class="string">&quot;ç¬¬%dä¸ªæ³›å‹å‚æ•°ï¼š%s&quot;</span>, i + <span class="number">1</span>, typeArguments[i]));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h4 id="æ³›å‹çš„ä¸Šä¸‹é™åŠåº”ç”¨åœºæ™¯"><a href="#æ³›å‹çš„ä¸Šä¸‹é™åŠåº”ç”¨åœºæ™¯" class="headerlink" title="æ³›å‹çš„ä¸Šä¸‹é™åŠåº”ç”¨åœºæ™¯"></a>æ³›å‹çš„ä¸Šä¸‹é™åŠåº”ç”¨åœºæ™¯</h4><p>æ³›å‹çš„<strong>ä¸Šé™ï¼ˆUpper Boundï¼‰</strong> å’Œ<strong>ä¸‹é™ï¼ˆLower Boundï¼‰</strong> æ˜¯ç”¨äº<strong>çº¦æŸç±»å‹å‚æ•°èŒƒå›´</strong>çš„å…³é”®æœºåˆ¶ï¼Œä¸»è¦è§£å†³æ³›å‹ä»£ç éœ€è¦<strong>é™åˆ¶å¯æ¥å—çš„ç±»å‹</strong>æˆ–<strong>æ”¯æŒæ›´çµæ´»çš„å­ç±»å‹å…³ç³»</strong>çš„é—®é¢˜ã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†è§£é‡Šï¼š</p><p><strong>ä¸€ã€æ³›å‹çš„ä¸Šé™ï¼ˆUpper Boundï¼‰</strong></p><p>å®šä¹‰ï¼šé™åˆ¶ç±»å‹å‚æ•°å¿…é¡»æ˜¯<strong>æŸä¸ªç±»&#x2F;æ¥å£æœ¬èº«æˆ–å…¶å­ç±»</strong>ã€‚<br>è¯­æ³•ï¼š<code>&lt;T extends ç±»/æ¥å£&gt;</code> æˆ– <code>&lt;? extends ç±»/æ¥å£&gt;</code>ï¼ˆé€šé…ç¬¦å½¢å¼ï¼‰ã€‚</p><p><strong>æ ¸å¿ƒä½œç”¨</strong></p><ol><li><p><strong>ç¡®ä¿ç±»å‹å…·å¤‡æŸäº›èƒ½åŠ›</strong><br>è¦æ±‚ç±»å‹ <code>T</code> å¿…é¡»å®ç°ç‰¹å®šæ¥å£ï¼ˆå¦‚ <code>Comparable</code>ï¼‰æˆ–ç»§æ‰¿ç‰¹å®šç±»ï¼Œä»è€Œåœ¨æ³›å‹ä»£ç ä¸­å®‰å…¨è°ƒç”¨å…¶æ–¹æ³•ã€‚<br><strong>ç¤ºä¾‹</strong>ï¼šè¦æ±‚ç±»å‹å¿…é¡»å¯æ¯”è¾ƒ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// T å¿…é¡»æ˜¯å®ç°äº† Comparable æ¥å£çš„ç±»å‹</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T <span class="keyword">extends</span> <span class="title class_">Comparable</span>&lt;T&gt;&gt; T <span class="title function_">max</span><span class="params">(T a, T b)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a.compareTo(b) &gt; <span class="number">0</span> ? a : b;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å¯å®‰å…¨è°ƒç”¨ a.compareTo(b)</span></span><br></pre></td></tr></table></figure></li><li><p><strong>å®‰å…¨è®¿é—®æ•°æ®ï¼ˆåªè¯»ä¸å†™ï¼‰</strong><br>åœ¨é€šé…ç¬¦ <code>? extends T</code> ä¸­ï¼Œè¡¨ç¤ºâ€œæŸä¸ª <code>T</code> çš„å­ç±»å‹â€ï¼Œæ­¤æ—¶å®¹å™¨<strong>åªèƒ½è¯»å–æ•°æ®</strong>ï¼ˆè¿”å› <code>T</code> ç±»å‹ï¼‰ï¼Œ<strong>ä¸èƒ½å†™å…¥æ•°æ®</strong>ï¼ˆé™¤ <code>null</code> å¤–ï¼‰ã€‚<br><strong>ç¤ºä¾‹</strong>ï¼šå®‰å…¨è¯»å–æ•°å­—é›†åˆ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">printNumbers</span><span class="params">(List&lt;? extends Number&gt; list)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (Number n : list) &#123;</span><br><span class="line">        System.out.println(n);  <span class="comment">// âœ… å¯è¯»</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// list.add(10); âŒ ç¼–è¯‘é”™è¯¯ï¼æ— æ³•å†™å…¥ï¼ˆé™¤ null å¤–ï¼‰</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p><strong>å…¸å‹åœºæ™¯</strong></p><ul><li>å®šä¹‰æ³›å‹ç±»&#x2F;æ–¹æ³•æ—¶ï¼Œçº¦æŸç±»å‹å‚æ•°çš„èƒ½åŠ›ï¼ˆå¦‚ <code>T extends Runnable</code>ï¼‰ã€‚</li><li>ä½œä¸ºæ–¹æ³•å‚æ•°æ—¶ï¼Œå®‰å…¨æ¥æ”¶<strong>æŸç§å­ç±»å‹çš„é›†åˆ</strong>ï¼ˆç”Ÿäº§è€…åœºæ™¯ï¼‰ã€‚</li></ul><p><strong>äºŒã€æ³›å‹çš„ä¸‹é™ï¼ˆLower Boundï¼‰</strong></p><p>å®šä¹‰ï¼šé™åˆ¶ç±»å‹å‚æ•°å¿…é¡»æ˜¯<strong>æŸä¸ªç±»&#x2F;æ¥å£æœ¬èº«æˆ–å…¶çˆ¶ç±»</strong>ã€‚<br>è¯­æ³•ï¼š<code>&lt;? super ç±»/æ¥å£&gt;</code>ï¼ˆä»…é€šé…ç¬¦å½¢å¼ï¼‰ã€‚</p><p><strong>æ ¸å¿ƒä½œç”¨</strong></p><ol><li><p><strong>æ”¯æŒå®‰å…¨å†™å…¥æ•°æ®</strong><br>è¡¨ç¤ºâ€œæŸä¸ª <code>T</code> çš„çˆ¶ç±»å‹â€ï¼Œæ­¤æ—¶å®¹å™¨<strong>å¯ä»¥å†™å…¥ <code>T</code> åŠå…¶å­ç±»å‹å¯¹è±¡</strong>ï¼Œä½†è¯»å–æ—¶åªèƒ½è§†ä¸º <code>Object</code>ã€‚<br><strong>ç¤ºä¾‹</strong>ï¼šå‘é›†åˆæ·»åŠ å…ƒç´ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">addNumbers</span><span class="params">(List&lt;? <span class="built_in">super</span> Integer&gt; list)</span> &#123;</span><br><span class="line">    list.add(<span class="number">10</span>);     <span class="comment">// âœ… å¯å†™å…¥ Integer</span></span><br><span class="line">    list.add(<span class="number">1000L</span>);  <span class="comment">// âŒ é”™è¯¯ï¼Long ä¸æ˜¯ Integer çš„å­ç±»</span></span><br><span class="line">    <span class="comment">// Object obj = list.get(0);  // è¯»å–æ—¶åªèƒ½è§†ä¸º Object</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong>å®ç°çµæ´»çš„å­ç±»å‹å…¼å®¹</strong><br>å…è®¸æ–¹æ³•æ¥æ”¶æ¯”é¢„æœŸæ›´å®½æ³›çš„å®¹å™¨ï¼ˆå¦‚éœ€è¦ <code>List&lt;Number&gt;</code> æ—¶ï¼Œä¹Ÿå¯ä¼ å…¥ <code>List&lt;Object&gt;</code>ï¼‰ã€‚</p></li></ol><p><strong>å…¸å‹åœºæ™¯</strong></p><ul><li><p>å‘æ³›å‹å®¹å™¨<strong>å†™å…¥æ•°æ®</strong>ï¼ˆæ¶ˆè´¹è€…åœºæ™¯ï¼‰ã€‚</p></li><li><p>é…åˆ <code>Comparator</code> ç­‰æ¥å£å®ç°ç±»å‹çµæ´»çš„APIï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯æ¥æ”¶ Person æˆ–å…¶çˆ¶ç±»çš„ Comparator</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">sort</span><span class="params">(List&lt;Person&gt; list, Comparator&lt;? <span class="built_in">super</span> Person&gt; comparator)</span> &#123;</span><br><span class="line">    Collections.sort(list, comparator);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p><strong>ä¸‰ã€å…³é”®å¯¹æ¯”ï¼š<code>extends</code> vs <code>super</code></strong></p><table><thead><tr><th align="left"><strong>ç‰¹æ€§</strong></th><th align="left"><strong>ä¸Šé™ (<code>? extends T</code>)</strong></th><th align="left"><strong>ä¸‹é™ (<code>? super T</code>)</strong></th></tr></thead><tbody><tr><td align="left"><strong>ç±»å‹èŒƒå›´</strong></td><td align="left"><code>T</code> æˆ–å…¶<strong>å­ç±»å‹</strong></td><td align="left"><code>T</code> æˆ–å…¶<strong>çˆ¶ç±»å‹</strong></td></tr><tr><td align="left"><strong>æ•°æ®è¯»å–</strong></td><td align="left">âœ… è¿”å› <code>T</code> ç±»å‹</td><td align="left">âŒ åªèƒ½è§†ä¸º <code>Object</code></td></tr><tr><td align="left"><strong>æ•°æ®å†™å…¥</strong></td><td align="left">âŒ ç¦æ­¢ï¼ˆé™¤ <code>null</code>ï¼‰</td><td align="left">âœ… å¯å†™å…¥ <code>T</code> <strong>åŠå…¶å­ç±»</strong></td></tr><tr><td align="left"><strong>è®¾è®¡æ„å›¾</strong></td><td align="left"><strong>ç”Ÿäº§è€…</strong>ï¼ˆProducerï¼‰åªæä¾›æ•°æ®</td><td align="left"><strong>æ¶ˆè´¹è€…</strong>ï¼ˆConsumerï¼‰åªæ¶ˆè´¹æ•°æ®</td></tr><tr><td align="left"><strong>ç»å…¸å£è¯€</strong></td><td align="left"><strong>PECS</strong> (Producer-Extends, Consumer-Super)</td><td align="left"></td></tr></tbody></table><p><strong>å››ã€å®é™…åº”ç”¨ï¼šPECS åŸåˆ™</strong></p><p>åœ¨æ³›å‹ç¼–ç¨‹ä¸­ï¼Œéµå¾ª <strong>PECSï¼ˆProducer-Extends, Consumer-Superï¼‰</strong> åŸåˆ™ï¼š</p><ul><li><strong>ç”Ÿäº§è€…ï¼ˆProducerï¼‰</strong>ï¼šäº§ç”Ÿ <code>T</code> çš„å¯¹è±¡ â†’ ç”¨ <code>&lt;? extends T&gt;</code></li><li><strong>æ¶ˆè´¹è€…ï¼ˆConsumerï¼‰</strong>ï¼šæ¶ˆè´¹ <code>T</code> çš„å¯¹è±¡ â†’ ç”¨ <code>&lt;? super T&gt;</code></li></ul><p><strong>ç¤ºä¾‹</strong>ï¼šJava é›†åˆå·¥å…·ç±» <code>Collections.copy()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">copy</span><span class="params">(</span></span><br><span class="line"><span class="params">    List&lt;? <span class="built_in">super</span> T&gt; dest,    // æ¶ˆè´¹è€…ï¼šå†™å…¥ç›®æ ‡é›†åˆ</span></span><br><span class="line"><span class="params">    List&lt;? extends T&gt; src    // ç”Ÿäº§è€…ï¼šè¯»å–æºé›†åˆ</span></span><br><span class="line"><span class="params">)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; src.size(); i++) &#123;</span><br><span class="line">        dest.set(i, src.get(i));  <span class="comment">// âœ… å®‰å…¨è¯»å†™</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åå°„"><a href="#åå°„" class="headerlink" title="åå°„"></a>åå°„</h3><h4 id="ä»€ä¹ˆæ˜¯åå°„"><a href="#ä»€ä¹ˆæ˜¯åå°„" class="headerlink" title="ä»€ä¹ˆæ˜¯åå°„"></a>ä»€ä¹ˆæ˜¯åå°„</h4><p>åœ¨ç¨‹åºè¿è¡ŒæœŸé—´åŠ¨æ€è·å–ç±»æˆ–å¯¹è±¡ä¿¡æ¯ä»¥åŠåŠ¨æ€è°ƒç”¨å¯¹è±¡æ–¹æ³•çš„åŠŸèƒ½ç§°ä¸º Java çš„åå°„æœºåˆ¶ã€‚</p><p><strong>ä¼˜ç‚¹ï¼š</strong>åŠ¨æ€ã€çµæ´»ã€‚IOCã€AOPè®¾è®¡çš„åŸºçŸ³ã€‚</p><p><strong>ç¼ºç‚¹ï¼š</strong>æ€§èƒ½å¼€é”€å¤§ã€ç ´åå°è£…ã€å®ç°å¤æ‚ã€‚</p><p><strong>åå°„çš„å®é™…åº”ç”¨åœºæ™¯</strong></p><ul><li><strong>æ¡†æ¶å¼€å‘ï¼š</strong> æ˜¯å‡ ä¹æ‰€æœ‰ Java æ¡†æ¶çš„æ ¸å¿ƒï¼ˆå¦‚ Spring, Hibernate, MyBatis, JUnitï¼‰ã€‚<ul><li><strong>Spring IOCï¼š</strong> é€šè¿‡åå°„è¯»å–é…ç½®ï¼ˆXML æˆ–æ³¨è§£ï¼‰ï¼ŒåŠ¨æ€åˆ›å»º Bean å®ä¾‹ï¼Œæ³¨å…¥ä¾èµ–ã€‚</li><li><strong>Spring AOPï¼š</strong> åŠ¨æ€ä»£ç†ï¼ˆJDK Proxy æˆ– CGLIBï¼‰åº•å±‚ä¾èµ–åå°„è°ƒç”¨ç›®æ ‡æ–¹æ³•ã€‚</li><li><strong>Hibernate&#x2F;MyBatisï¼š</strong> å°†æ•°æ®åº“ç»“æœé›†æ˜ å°„åˆ° Java å¯¹è±¡æ—¶ï¼Œé€šè¿‡åå°„è®¾ç½®å¯¹è±¡çš„å±æ€§å€¼ã€‚</li></ul></li><li><strong>æ³¨è§£å¤„ç†ï¼š</strong> åœ¨è¿è¡Œæ—¶é€šè¿‡åå°„è¯»å–ç±»ã€æ–¹æ³•ã€å­—æ®µä¸Šçš„æ³¨è§£ä¿¡æ¯ï¼Œå¹¶æ ¹æ®æ³¨è§£æ‰§è¡Œç‰¹å®šé€»è¾‘ï¼ˆå¦‚ JUnit æŸ¥æ‰¾ <code>@Test</code> æ–¹æ³•ï¼‰ã€‚</li><li><strong>åŠ¨æ€ä»£ç†ï¼š</strong> JDK åŠ¨æ€ä»£ç† (<code>java.lang.reflect.Proxy</code>) çš„æ ¸å¿ƒå°±æ˜¯åˆ©ç”¨åå°„è°ƒç”¨è¢«ä»£ç†å¯¹è±¡çš„æ–¹æ³•ã€‚</li><li><strong>é€šç”¨å·¥å…·åº“ï¼š</strong> å¦‚ Apache Commons BeanUtils, Jackson&#x2F;Gson (JSON åºåˆ—åŒ–&#x2F;ååºåˆ—åŒ–)ï¼Œé€šè¿‡åå°„æ“ä½œå¯¹è±¡çš„å±æ€§ã€‚</li><li><strong>IDE å’Œå¼€å‘å·¥å…·ï¼š</strong> ä»£ç æç¤ºã€è°ƒè¯•å™¨ã€åç¼–è¯‘å·¥å…·ç­‰åˆ©ç”¨åå°„è·å–ç±»çš„ç»“æ„ä¿¡æ¯ã€‚</li></ul><h4 id="å¦‚ä½•è·å–ä¸€ä¸ªç±»çš„-Class-å¯¹è±¡"><a href="#å¦‚ä½•è·å–ä¸€ä¸ªç±»çš„-Class-å¯¹è±¡" class="headerlink" title="å¦‚ä½•è·å–ä¸€ä¸ªç±»çš„ Class å¯¹è±¡"></a>å¦‚ä½•è·å–ä¸€ä¸ªç±»çš„ <code>Class</code> å¯¹è±¡</h4><ol><li><code>Class clazz = instance.getClass();</code> (é€šè¿‡å¯¹è±¡å®ä¾‹è·å–)</li><li><code>Class clazz = ClassName.class;</code> (é€šè¿‡ç±»å­—é¢å¸¸é‡ <code>.class</code> è·å–)</li><li><code>Class clazz = Class.forName(&quot;fully.qualified.ClassName&quot;);</code> (é€šè¿‡å®Œæ•´ç±»åå­—ç¬¦ä¸²è·å–ï¼Œå¸¸ç”¨ï¼Œå¯èƒ½æŠ›å‡º <code>ClassNotFoundException</code>)</li><li>(å¯¹äºåŸºæœ¬ç±»å‹å’Œæ•°ç»„) <code>Class clazz = int.class;</code> &#x2F; <code>Class clazz = String[].class;</code></li></ol><h4 id="å¦‚ä½•é€šè¿‡åå°„åˆ›å»ºä¸€ä¸ªç±»çš„å®ä¾‹"><a href="#å¦‚ä½•é€šè¿‡åå°„åˆ›å»ºä¸€ä¸ªç±»çš„å®ä¾‹" class="headerlink" title="å¦‚ä½•é€šè¿‡åå°„åˆ›å»ºä¸€ä¸ªç±»çš„å®ä¾‹"></a>å¦‚ä½•é€šè¿‡åå°„åˆ›å»ºä¸€ä¸ªç±»çš„å®ä¾‹</h4><p><strong>ä½¿ç”¨ <code>Class.newInstance()</code>ï¼ˆå·²è¿‡æ—¶ï¼‰ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.example.MyClass&quot;</span>);</span><br><span class="line"><span class="type">MyClass</span> <span class="variable">obj</span> <span class="operator">=</span> (MyClass) clazz.newInstance(); <span class="comment">// è°ƒç”¨æ— å‚æ„é€ å™¨</span></span><br></pre></td></tr></table></figure><p><strong>ä½¿ç”¨ <code>Constructor.newInstance()</code> (æ¨è)ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.example.MyClass&quot;</span>);</span><br><span class="line"><span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> clazz.getConstructor(String.class, <span class="type">int</span>.class); <span class="comment">// è·å–ç‰¹å®šå‚æ•°ç±»å‹çš„æ„é€ å™¨</span></span><br><span class="line"><span class="type">MyClass</span> <span class="variable">obj</span> <span class="operator">=</span> (MyClass) constructor.newInstance(<span class="string">&quot;arg1&quot;</span>, <span class="number">42</span>); <span class="comment">// ä¼ å…¥å‚æ•°åˆ›å»ºå®ä¾‹</span></span><br></pre></td></tr></table></figure><p><code>clazz.newInstance()</code>åªèƒ½è°ƒç”¨æ— å‚æ„é€ å™¨ï¼Œåœ¨ Java 9 å¼€å§‹è¢«æ ‡è®°ä¸º <code>@Deprecated(since=&quot;9&quot;)</code>ï¼Œæ¨èä½¿ç”¨ <code>Constructor.newInstance()</code>ã€‚</p><h4 id="Class-forName-å’Œ-ClassLoader-loadClass-çš„åŒºåˆ«"><a href="#Class-forName-å’Œ-ClassLoader-loadClass-çš„åŒºåˆ«" class="headerlink" title="Class.forName() å’Œ ClassLoader.loadClass() çš„åŒºåˆ«"></a><code>Class.forName()</code> å’Œ <code>ClassLoader.loadClass()</code> çš„åŒºåˆ«</h4><ul><li><code>Class.forName(String name)</code>ï¼š<ul><li>é»˜è®¤ä¼šè§¦å‘ç±»çš„<strong>åŠ è½½ã€é“¾æ¥ï¼ˆéªŒè¯ã€å‡†å¤‡ï¼‰ã€åˆå§‹åŒ–</strong>ï¼ˆæ‰§è¡Œ <code>&lt;clinit&gt;</code> é™æ€åˆå§‹åŒ–å—ï¼‰ã€‚</li><li>æœ‰ä¸€ä¸ªé‡è½½æ–¹æ³• <code>Class.forName(String name, boolean initialize, ClassLoader loader)</code> å¯ä»¥æ§åˆ¶æ˜¯å¦åˆå§‹åŒ– (<code>initialize</code>) å’ŒæŒ‡å®šç±»åŠ è½½å™¨ (<code>loader</code>)ã€‚</li></ul></li><li><code>ClassLoader.loadClass(String name)</code>ï¼š<ul><li>åªè§¦å‘ç±»çš„<strong>åŠ è½½</strong>å’Œ<strong>é“¾æ¥ï¼ˆéªŒè¯ã€å‡†å¤‡ï¼‰</strong> é˜¶æ®µï¼Œ<strong>ä¸ä¼šæ‰§è¡Œåˆå§‹åŒ–</strong> (<code>&lt;clinit&gt;</code>)ã€‚åªæœ‰é¦–æ¬¡ä¸»åŠ¨ä½¿ç”¨æ—¶ï¼ˆå¦‚åˆ›å»ºå®ä¾‹ã€è®¿é—®é™æ€å­—æ®µ&#x2F;æ–¹æ³•ï¼‰æ‰ä¼šåˆå§‹åŒ–ã€‚</li></ul></li></ul><h4 id="å¦‚ä½•é˜²æ­¢åå°„ç ´åå•ä¾‹æ¨¡å¼"><a href="#å¦‚ä½•é˜²æ­¢åå°„ç ´åå•ä¾‹æ¨¡å¼" class="headerlink" title="å¦‚ä½•é˜²æ­¢åå°„ç ´åå•ä¾‹æ¨¡å¼"></a><strong>å¦‚ä½•é˜²æ­¢åå°„ç ´åå•ä¾‹æ¨¡å¼</strong></h4><p><strong>ä½¿ç”¨æšä¸¾å®ç°å•ä¾‹ (æ¨è)ï¼š</strong> æšä¸¾çš„å•ä¾‹å®ç°æ˜¯ã€ŠEffective Javaã€‹ä½œè€… Josh Bloch å¼ºçƒˆæ¨èçš„æ–¹å¼ã€‚JVM ä»æ ¹æœ¬ä¸Šä¿è¯äº†æšä¸¾ç±»å‹çš„æ„é€ å™¨åªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ï¼Œä¸”åå°„ API è¢«è®¾è®¡ä¸º<strong>ä¸èƒ½é€šè¿‡åå°„åˆ›å»ºæšä¸¾å®ä¾‹</strong>ï¼ˆ<code>Constructor.newInstance()</code> æ–¹æ³•å†…éƒ¨ä¼šæ£€æŸ¥å¹¶é˜»æ­¢ï¼‰ã€‚è¿™æ˜¯æœ€å®‰å…¨ã€ç®€æ´çš„æ–¹å¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">Singleton</span> &#123;</span><br><span class="line">    INSTANCE; <span class="comment">// å”¯ä¸€çš„å•ä¾‹å®ä¾‹</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å•ä¾‹çš„ä¸šåŠ¡æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doSomething</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Singleton instance is working...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å•ä¾‹çš„ä¸šåŠ¡å±æ€§</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">counter</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">incrementAndGet</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ++counter;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–å•ä¾‹å®ä¾‹</span></span><br><span class="line">        <span class="type">Singleton</span> <span class="variable">singleton</span> <span class="operator">=</span> Singleton.INSTANCE;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è°ƒç”¨ä¸šåŠ¡æ–¹æ³•</span></span><br><span class="line">        singleton.doSomething();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ä½¿ç”¨ä¸šåŠ¡å±æ€§</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Counter: &quot;</span> + singleton.incrementAndGet());</span><br><span class="line">        System.out.println(<span class="string">&quot;Counter: &quot;</span> + singleton.incrementAndGet());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// éªŒè¯å•ä¾‹æ€§</span></span><br><span class="line">        <span class="type">Singleton</span> <span class="variable">anotherInstance</span> <span class="operator">=</span> Singleton.INSTANCE;</span><br><span class="line">        System.out.println(<span class="string">&quot;Same instance? &quot;</span> + (singleton == anotherInstance));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¾“å‡ºç»“æœ</span></span><br><span class="line">Singleton instance is working...</span><br><span class="line">Counter: <span class="number">1</span></span><br><span class="line">Counter: <span class="number">2</span></span><br><span class="line">Same instance? <span class="literal">true</span></span><br></pre></td></tr></table></figure><h4 id="åŠ¨æ€ä»£ç†"><a href="#åŠ¨æ€ä»£ç†" class="headerlink" title="åŠ¨æ€ä»£ç†"></a>åŠ¨æ€ä»£ç†</h4><p>åŠ¨æ€ä»£ç†æ˜¯ä¸€ç§åœ¨è¿è¡Œæ—¶ç”Ÿæˆä»£ç†å¯¹è±¡çš„æœºåˆ¶ï¼Œå®ƒåœ¨ä¸æ”¹å˜åŸæœ‰ä»£ç çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡ä»£ç†å¯¹è±¡å¯¹åŸæœ‰å¯¹è±¡è¿›è¡Œå¢å¼ºã€æ‰©å±•æˆ–é™åˆ¶ç­‰æ“ä½œã€‚</p><p>åœ¨ Java ä¸­ï¼ŒåŠ¨æ€ä»£ç†ä¸»è¦æœ‰ä¸¤ç§å®ç°æ–¹å¼ï¼š<strong>åŸºäºæ¥å£çš„åŠ¨æ€ä»£ç†</strong>å’Œ<strong>åŸºäºç±»çš„åŠ¨æ€ä»£ç†</strong>ã€‚å…¶ä¸­ï¼ŒåŸºäºæ¥å£çš„åŠ¨æ€ä»£ç†ä½¿ç”¨ Java è‡ªå¸¦çš„ java.lang.reflect.Proxy ç±»å®ç°ï¼Œè€ŒåŸºäºç±»çš„åŠ¨æ€ä»£ç†åˆ™éœ€è¦ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“ï¼Œå¦‚ CGLIB æˆ– ByteBuddy ç­‰ã€‚</p><p><strong>åŸºäºæ¥å£çš„åŠ¨æ€ä»£ç†</strong></p><p>åŸºäºæ¥å£çš„åŠ¨æ€ä»£ç†è¦æ±‚ç›®æ ‡å¯¹è±¡å¿…é¡»å®ç°ä¸€ä¸ªæˆ–å¤šä¸ªæ¥å£ï¼ŒåŠ¨æ€ä»£ç†å¯¹è±¡ä¼šå®ç°è¿™äº›æ¥å£ã€‚åœ¨åˆ›å»ºåŠ¨æ€ä»£ç†å¯¹è±¡æ—¶ï¼Œéœ€è¦æä¾›ä¸€ä¸ªå®ç°äº† InvocationHandler æ¥å£çš„ä»£ç†å¤„ç†å™¨å¯¹è±¡ï¼Œå®ƒä¼šåœ¨ä»£ç†å¯¹è±¡æ–¹æ³•è°ƒç”¨æ—¶è¢«å›è°ƒã€‚</p><p>ç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Hello</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">sayHello</span><span class="params">(String name)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloImpl</span> <span class="keyword">implements</span> <span class="title class_">Hello</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sayHello</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello, &quot;</span> + name + <span class="string">&quot;!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloHandler</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Object target;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">HelloHandler</span><span class="params">(Object target)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.target = target;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Before method invocation&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> method.invoke(target, args);</span><br><span class="line">        System.out.println(<span class="string">&quot;After method invocation&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Hello</span> <span class="variable">hello</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HelloImpl</span>();</span><br><span class="line">        <span class="type">Hello</span> <span class="variable">proxy</span> <span class="operator">=</span> (Hello) Proxy.newProxyInstance(</span><br><span class="line">            hello.getClass().getClassLoader(),</span><br><span class="line">            hello.getClass().getInterfaces(),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">HelloHandler</span>(hello)</span><br><span class="line">        );</span><br><span class="line">        proxy.sayHello(<span class="string">&quot;Alice&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>åŸºäºç±»çš„åŠ¨æ€ä»£ç†</strong></p><p>åŸºäºç±»çš„åŠ¨æ€ä»£ç†åˆ™ä¸è¦æ±‚ç›®æ ‡å¯¹è±¡å¿…é¡»å®ç°æ¥å£ï¼Œè€Œæ˜¯é€šè¿‡åˆ›å»ºç›®æ ‡å¯¹è±¡çš„å­ç±»æ¥å®ç°ä»£ç†ã€‚åœ¨åˆ›å»ºåŠ¨æ€ä»£ç†å¯¹è±¡æ—¶ï¼Œéœ€è¦æä¾›ä¸€ä¸ªå®ç°äº† MethodInterceptor æ¥å£çš„æ‹¦æˆªå™¨å¯¹è±¡ï¼Œå®ƒä¼šåœ¨ä»£ç†å¯¹è±¡æ–¹æ³•è°ƒç”¨æ—¶è¢«å›è°ƒã€‚</p><p>ç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hello</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sayHello</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello, &quot;</span> + name + <span class="string">&quot;!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloInterceptor</span> <span class="keyword">implements</span> <span class="title class_">MethodInterceptor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(Object obj, Method method, Object[] args, MethodProxy proxy)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Before method invocation&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> proxy.invokeSuper(obj, args);</span><br><span class="line">        System.out.println(<span class="string">&quot;After method invocation&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Enhancer</span> <span class="variable">enhancer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Enhancer</span>();</span><br><span class="line">        enhancer.setSuperclass(Hello.class);</span><br><span class="line">        enhancer.setCallback(<span class="keyword">new</span> <span class="title class_">HelloInterceptor</span>());</span><br><span class="line">        <span class="type">Hello</span> <span class="variable">proxy</span> <span class="operator">=</span> (Hello) enhancer.create();</span><br><span class="line">        proxy.sayHello(<span class="string">&quot;Alice&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Javaé›†åˆ"><a href="#Javaé›†åˆ" class="headerlink" title="Javaé›†åˆ"></a>Javaé›†åˆ</h2><p>Java é›†åˆæ¡†æ¶ä¸»è¦åŒ…æ‹¬ <code>Collection</code> å’Œ <code>Map</code> ä¸¤å¤§æ¥å£ä½“ç³»ã€‚<code>Collection</code> ä¸»è¦æœ‰ <code>List</code>ã€<code>Set</code>ã€<code>Queue</code> å‡ ä¸ªæ ¸å¿ƒå­æ¥å£ã€‚</p><h3 id="åŸºç¡€"><a href="#åŸºç¡€" class="headerlink" title="åŸºç¡€"></a>åŸºç¡€</h3><h4 id="ä»€ä¹ˆæ˜¯-fail-fast-æœºåˆ¶"><a href="#ä»€ä¹ˆæ˜¯-fail-fast-æœºåˆ¶" class="headerlink" title="ä»€ä¹ˆæ˜¯ fail-fast æœºåˆ¶"></a><strong>ä»€ä¹ˆæ˜¯ <code>fail-fast</code> æœºåˆ¶</strong></h4><ul><li>ä¸€ç§<strong>é”™è¯¯æ£€æµ‹æœºåˆ¶</strong>ã€‚å½“ä½¿ç”¨è¿­ä»£å™¨ (<code>Iterator</code>) éå†é›†åˆæ—¶ï¼Œå¦‚æœ<strong>åœ¨éå†è¿‡ç¨‹ä¸­ï¼ˆé™¤äº†é€šè¿‡è¿­ä»£å™¨è‡ªèº«çš„ <code>remove()</code> æ–¹æ³•å¤–ï¼‰é›†åˆç»“æ„è¢«ä¿®æ”¹</strong>ï¼ˆæ·»åŠ ã€åˆ é™¤å…ƒç´ ï¼‰ï¼Œä¼šç«‹å³æŠ›å‡º <code>ConcurrentModificationException</code>ã€‚</li><li><strong>å®ç°åŸç†</strong>ï¼šé›†åˆå†…éƒ¨ç»´æŠ¤ä¸€ä¸ª <code>modCount</code> (ä¿®æ”¹è®¡æ•°å™¨)ã€‚åˆ›å»ºè¿­ä»£å™¨æ—¶ï¼Œä¼šå°†å½“å‰çš„ <code>modCount</code> è®°å½•ä¸º <code>expectedModCount</code>ã€‚åœ¨è¿­ä»£è¿‡ç¨‹ä¸­ï¼Œæ¯æ¬¡è°ƒç”¨ <code>next()</code>ã€<code>remove()</code> ç­‰æ–¹æ³•å‰éƒ½ä¼šæ£€æŸ¥ <code>modCount == expectedModCount</code>ã€‚å¦‚æœä¸ç›¸ç­‰ï¼Œè¯´æ˜æœ‰å…¶ä»–çº¿ç¨‹æˆ–æœ¬çº¿ç¨‹å…¶ä»–æ“ä½œä¿®æ”¹äº†é›†åˆç»“æ„ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚</li><li><strong>ç›®çš„</strong>ï¼šå¿«é€Ÿå¤±è´¥ï¼Œé¿å…åœ¨ä¸ç¡®å®šçŠ¶æ€ä¸‹ç»§ç»­æ“ä½œå¯¼è‡´æ›´éš¾ä»¥é¢„æ–™çš„ç»“æœã€‚<strong>å®ƒä¸èƒ½ä¿è¯å¹¶å‘ä¿®æ”¹ä¸€å®šè¢«æ£€æµ‹åˆ°ï¼Œä¸»è¦ç”¨äºå•çº¿ç¨‹ç¯å¢ƒä¸‹çš„é”™è¯¯æ£€æµ‹</strong>ã€‚</li></ul><h4 id="fail-fast-å’Œ-fail-safe-çš„åŒºåˆ«"><a href="#fail-fast-å’Œ-fail-safe-çš„åŒºåˆ«" class="headerlink" title="fail-fast å’Œ fail-safe çš„åŒºåˆ«"></a><strong><code>fail-fast</code> å’Œ <code>fail-safe</code> çš„åŒºåˆ«</strong></h4><ul><li><strong><code>fail-fast</code><strong>ï¼šç›´æ¥åœ¨åŸé›†åˆä¸Šæ“ä½œã€‚è¿­ä»£æ—¶æ£€æµ‹åˆ°å¹¶å‘ä¿®æ”¹å°±</strong>ç«‹å³æŠ›å¼‚å¸¸</strong>ã€‚ä»£è¡¨ï¼š<code>ArrayList</code>, <code>HashMap</code> ç­‰éå¹¶å‘é›†åˆçš„è¿­ä»£å™¨ã€‚</li><li><strong><code>fail-safe</code> (Concurrent Modification Tolerance)<strong>ï¼š</strong>ä¸åœ¨åŸé›†åˆä¸Šæ“ä½œ</strong>ï¼Œè€Œæ˜¯åŸºäºåŸé›†åˆçš„<strong>å¿«ç…§ (snapshot)</strong> æˆ– <strong>åªè¯»è§†å›¾</strong> è¿›è¡Œè¿­ä»£ã€‚è¿­ä»£è¿‡ç¨‹ä¸­åŸé›†åˆçš„ä¿®æ”¹ä¸ä¼šå½±å“è¿­ä»£å™¨ï¼Œä¸ä¼šæŠ›å¼‚å¸¸ã€‚ä»£è¡¨ï¼š<code>ConcurrentHashMap</code>, <code>CopyOnWriteArrayList</code> çš„è¿­ä»£å™¨ã€‚</li></ul><h3 id="List"><a href="#List" class="headerlink" title="List"></a><code>List</code></h3><h4 id="ArrayListçš„æ‰©å®¹æœºåˆ¶"><a href="#ArrayListçš„æ‰©å®¹æœºåˆ¶" class="headerlink" title="ArrayListçš„æ‰©å®¹æœºåˆ¶"></a><code>ArrayList</code>çš„æ‰©å®¹æœºåˆ¶</h4><ul><li>ä½¿ç”¨ <code>Object[] elementData</code> å­˜å‚¨å…ƒç´ ã€‚</li><li>åˆ›å»ºæ—¶å¦‚æœæœªæŒ‡å®šå¤§å°ï¼Œåˆå§‹å®¹é‡ä¸º <strong>0</strong> (JDK 1.8+) æˆ– <strong>10</strong> (æ—§ç‰ˆæœ¬ï¼Œéœ€ç¡®è®¤å…·ä½“ç‰ˆæœ¬)ï¼Œç¬¬ä¸€æ¬¡æ·»åŠ å…ƒç´ æ—¶æ‰©å®¹åˆ° <strong>10</strong>ã€‚</li><li>å½“æ·»åŠ å…ƒç´ æ—¶å‘ç°å®¹é‡ä¸è¶³ï¼ˆ<code>size + 1 &gt; elementData.length</code>ï¼‰ï¼Œè§¦å‘æ‰©å®¹ï¼Œ <strong>æ–°å®¹é‡æ˜¯åŸå®¹é‡çš„1.5å€</strong>ã€‚</li><li>åˆ›å»ºä¸€ä¸ªæ–°çš„æ›´å¤§çš„æ•°ç»„ï¼Œå°†æ—§æ•°ç»„å…ƒç´ <strong>å¤åˆ¶</strong>åˆ°æ–°æ•°ç»„ã€‚</li></ul><h3 id="Set"><a href="#Set" class="headerlink" title="Set"></a><code>Set</code></h3><h3 id="Map"><a href="#Map" class="headerlink" title="Map"></a><code>Map</code></h3><h4 id="HashMap-çš„å®ç°åŸç†"><a href="#HashMap-çš„å®ç°åŸç†" class="headerlink" title="HashMap çš„å®ç°åŸç†"></a><code>HashMap</code> çš„å®ç°åŸç†</h4><p><strong>JDK7ï¼šæ•°ç»„ + é“¾è¡¨</strong></p><ul><li><strong>æ‰©å®¹</strong>ï¼šåˆ›å»ºæ–°æ•°ç»„ (é€šå¸¸æ˜¯åŸæ•°ç»„é•¿åº¦çš„ <strong>2å€</strong>)ï¼Œéå†æ‰€æœ‰å…ƒç´ ï¼Œ<strong>é‡æ–°è®¡ç®—æ¯ä¸ªå…ƒç´ åœ¨æ–°æ•°ç»„ä¸­çš„ä½ç½®</strong> (<code>rehash</code>)ï¼Œå°†å…ƒç´ è½¬ç§»åˆ°æ–°æ•°ç»„ã€‚<strong>å¤´æ’æ³•ä¼šå¯¼è‡´æ‰©å®¹æ—¶é“¾è¡¨å…ƒç´ é¡ºåºåè½¬</strong>ã€‚</li></ul><p><strong>JDK8ï¼šæ•°ç»„ + é“¾è¡¨ &#x2F; çº¢é»‘æ ‘</strong></p><p><strong>ä¸»è¦æ”¹è¿›</strong>ï¼š</p><ul><li><strong>å°¾æ’æ³•</strong>ï¼šè§£å†³ JDK7 å¤´æ’æ³•å¤šçº¿ç¨‹ä¸‹å¯èƒ½å¯¼è‡´æ­»å¾ªç¯çš„é—®é¢˜ï¼ˆæœªè§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼‰ã€‚</li><li><strong>é“¾è¡¨è½¬çº¢é»‘æ ‘</strong>ï¼šå½“é“¾è¡¨é•¿åº¦ <strong>&gt;&#x3D; 8 (TREEIFY_THRESHOLD)</strong> ä¸” <strong>æ•°ç»„é•¿åº¦ &gt;&#x3D; 64 (MIN_TREEIFY_CAPACITY)</strong> æ—¶ï¼Œé“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼Œæé«˜é•¿é“¾è¡¨çš„æŸ¥æ‰¾æ•ˆç‡ (O(n) -&gt; O(log n))ã€‚</li><li><strong>ä¼˜åŒ–å“ˆå¸Œç®—æ³•</strong>ï¼š<code>(key == null) ? 0 : (h = key.hashCode()) ^ (h &gt;&gt;&gt; 16)</code>ï¼Œé«˜ä½å‚ä¸è¿ç®—ï¼Œå‡å°‘å“ˆå¸Œå†²çªã€‚</li><li><strong>æ‰©å®¹</strong>ï¼šæ ¹æ® <code>(e.hash &amp; oldCap) == 0</code> å°†é“¾è¡¨æ‹†åˆ†æˆä¸¤ä¸ªå­é“¾è¡¨ï¼Œç»“æœä¸º 0 çš„èŠ‚ç‚¹ä¿æŒåŸç´¢å¼•ä½ç½® <code>i</code>ï¼Œç»“æœä¸ä¸º 0 çš„èŠ‚ç‚¹æ”¾åˆ°æ–°ä½ç½® <code>i + oldCap</code>ï¼Œé¿å…å…¨é‡ <code>rehash</code>ï¼Œæå‡äº†æ•ˆç‡ã€‚</li></ul><h2 id="Java-IO"><a href="#Java-IO" class="headerlink" title="Java IO"></a>Java IO</h2><h3 id="å­—èŠ‚æµä¸å­—ç¬¦æµçš„åŒºåˆ«"><a href="#å­—èŠ‚æµä¸å­—ç¬¦æµçš„åŒºåˆ«" class="headerlink" title="å­—èŠ‚æµä¸å­—ç¬¦æµçš„åŒºåˆ«"></a>å­—èŠ‚æµä¸å­—ç¬¦æµçš„åŒºåˆ«</h3><ul><li><strong>å­—èŠ‚æµ</strong>ï¼š<code>InputStream</code>&#x2F;<code>OutputStream</code>ï¼Œå¤„ç†äºŒè¿›åˆ¶æ•°æ®ï¼ˆå¦‚å›¾ç‰‡ã€è§†é¢‘ï¼‰ï¼Œæ ¸å¿ƒç±»å¦‚ <code>FileInputStream</code>ã€‚</li><li><strong>å­—ç¬¦æµ</strong>ï¼š<code>Reader</code>&#x2F;<code>Writer</code>ï¼Œå¤„ç†æ–‡æœ¬æ•°æ®ï¼ˆè‡ªåŠ¨å¤„ç†ç¼–ç ï¼‰ï¼Œæ ¸å¿ƒç±»å¦‚ <code>FileReader</code>ã€<code>InputStreamReader</code>ã€‚</li><li><strong>å…³é”®ç‚¹</strong>ï¼šå­—ç¬¦æµåº•å±‚ä¾èµ–å­—èŠ‚æµ + ç¼–ç è½¬æ¢ï¼ˆå¦‚ <code>InputStreamReader</code> æ˜¯å­—èŠ‚åˆ°å­—ç¬¦çš„æ¡¥æ¢ï¼‰ã€‚</li></ul><p><strong>ä¸ºä»€ä¹ˆè¦æœ‰å­—ç¬¦æµï¼Ÿ</strong></p><ul><li>ç›´æ¥æ“ä½œå­—ç¬¦æ›´é«˜æ•ˆï¼Œé¿å…æ‰‹åŠ¨å¤„ç†ç¼–ç ï¼ˆå¦‚ UTF-8 è½¬ç ï¼‰ï¼Œè§£å†³ä¹±ç é—®é¢˜ã€‚</li></ul><h3 id="BIOã€NIOã€AIOçš„åŒºåˆ«"><a href="#BIOã€NIOã€AIOçš„åŒºåˆ«" class="headerlink" title="BIOã€NIOã€AIOçš„åŒºåˆ«"></a>BIOã€NIOã€AIOçš„åŒºåˆ«</h3><table><thead><tr><th align="left"><strong>ç‰¹æ€§</strong></th><th align="left">ä¼ ç»Ÿ IO</th><th align="left">NIO</th></tr></thead><tbody><tr><td align="left"><strong>æ¨¡å‹</strong></td><td align="left">é˜»å¡å¼ï¼ˆBlockingï¼‰</td><td align="left">éé˜»å¡å¼ï¼ˆNon-blockingï¼‰</td></tr><tr><td align="left"><strong>æ•°æ®å•ä½</strong></td><td align="left">æµï¼ˆStreamï¼‰</td><td align="left">ç¼“å†²åŒºï¼ˆBufferï¼‰ + é€šé“ï¼ˆChannelï¼‰</td></tr><tr><td align="left"><strong>å¤šè·¯å¤ç”¨</strong></td><td align="left">ä¸æ”¯æŒ</td><td align="left">Selector è½®è¯¢æœºåˆ¶</td></tr></tbody></table><h3 id="NIO-ä¸‰å¤§æ ¸å¿ƒç»„ä»¶"><a href="#NIO-ä¸‰å¤§æ ¸å¿ƒç»„ä»¶" class="headerlink" title="NIO ä¸‰å¤§æ ¸å¿ƒç»„ä»¶"></a>NIO ä¸‰å¤§æ ¸å¿ƒç»„ä»¶</h3><ul><li><strong>Buffer</strong>ï¼šæ•°æ®å®¹å™¨ï¼ˆå¦‚ <code>ByteBuffer</code>ï¼‰ï¼Œæ”¯æŒ <code>flip()</code>ã€<code>clear()</code> ç­‰æ“ä½œã€‚</li><li><strong>Channel</strong>ï¼šåŒå‘æ•°æ®ä¼ è¾“é€šé“ï¼ˆå¦‚ <code>FileChannel</code>ã€<code>SocketChannel</code>ï¼‰ã€‚</li><li><strong>Selector</strong>ï¼šå•çº¿ç¨‹ç›‘å¬å¤šä¸ª Channel äº‹ä»¶ï¼ˆ<code>OP_READ</code>ã€<code>OP_WRITE</code>ï¼‰ã€‚</li></ul><h3 id="äº”å¤§IOæ¨¡å‹"><a href="#äº”å¤§IOæ¨¡å‹" class="headerlink" title="äº”å¤§IOæ¨¡å‹"></a>äº”å¤§IOæ¨¡å‹</h3><p><strong>1. é˜»å¡ I&#x2F;O æ¨¡å‹ (Blocking I&#x2F;O)</strong></p><p><strong>ç‰¹ç‚¹</strong>ï¼šçº¿ç¨‹å‘èµ· I&#x2F;O æ“ä½œåä¼šè¢«æŒ‚èµ·ï¼Œç›´åˆ°æ“ä½œå®Œæˆ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æœåŠ¡å™¨ç«¯</span></span><br><span class="line"><span class="keyword">try</span> (<span class="type">ServerSocket</span> <span class="variable">serverSocket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(<span class="number">8080</span>)) &#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="comment">// é˜»å¡ç›´åˆ°å®¢æˆ·ç«¯è¿æ¥</span></span><br><span class="line">        <span class="type">Socket</span> <span class="variable">clientSocket</span> <span class="operator">=</span> serverSocket.accept();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> clientSocket.getInputStream()) &#123;</span><br><span class="line">                <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                <span class="comment">// é˜»å¡ç›´åˆ°æ•°æ®åˆ°è¾¾</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">bytesRead</span> <span class="operator">=</span> in.read(buffer);</span><br><span class="line">                <span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(buffer, <span class="number">0</span>, bytesRead);</span><br><span class="line">                System.out.println(<span class="string">&quot;Received: &quot;</span> + data);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>2. éé˜»å¡ I&#x2F;O æ¨¡å‹ (Non-blocking I&#x2F;O)</strong></p><p><strong>ç‰¹ç‚¹</strong>ï¼šçº¿ç¨‹ç«‹å³è¿”å›ç»“æœï¼Œé€šè¿‡è½®è¯¢æ£€æŸ¥å°±ç»ªçŠ¶æ€</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æœåŠ¡å™¨ç«¯</span></span><br><span class="line"><span class="type">ServerSocketChannel</span> <span class="variable">serverChannel</span> <span class="operator">=</span> ServerSocketChannel.open();</span><br><span class="line">serverChannel.bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">8080</span>));</span><br><span class="line">serverChannel.configureBlocking(<span class="literal">false</span>); <span class="comment">// è®¾ç½®ä¸ºéé˜»å¡</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="comment">// ç«‹å³è¿”å›ï¼Œå¯èƒ½ä¸º null</span></span><br><span class="line">    <span class="type">SocketChannel</span> <span class="variable">clientChannel</span> <span class="operator">=</span> serverChannel.accept();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (clientChannel != <span class="literal">null</span>) &#123;</span><br><span class="line">        clientChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// éé˜»å¡è¯»å–</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">bytesRead</span> <span class="operator">=</span> clientChannel.read(buffer);</span><br><span class="line">        <span class="keyword">if</span> (bytesRead &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            buffer.flip();</span><br><span class="line">            <span class="type">byte</span>[] data = <span class="keyword">new</span> <span class="title class_">byte</span>[buffer.limit()];</span><br><span class="line">            buffer.get(data);</span><br><span class="line">            System.out.println(<span class="string">&quot;Received: &quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(data));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å¯æ‰§è¡Œå…¶ä»–ä»»åŠ¡</span></span><br><span class="line">        Thread.sleep(<span class="number">100</span>); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>3. I&#x2F;O å¤šè·¯å¤ç”¨æ¨¡å‹ (I&#x2F;O Multiplexing)</strong></p><p><strong>ç‰¹ç‚¹</strong>ï¼šä½¿ç”¨å•ä¸ªçº¿ç¨‹ç®¡ç†å¤šä¸ª I&#x2F;O é€šé“</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æœåŠ¡å™¨ç«¯</span></span><br><span class="line"><span class="type">Selector</span> <span class="variable">selector</span> <span class="operator">=</span> Selector.open();</span><br><span class="line"><span class="type">ServerSocketChannel</span> <span class="variable">serverChannel</span> <span class="operator">=</span> ServerSocketChannel.open();</span><br><span class="line">serverChannel.bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">8080</span>));</span><br><span class="line">serverChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">serverChannel.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="comment">// é˜»å¡ç›´åˆ°æœ‰å°±ç»ªäº‹ä»¶</span></span><br><span class="line">    selector.select();</span><br><span class="line">    </span><br><span class="line">    Set&lt;SelectionKey&gt; selectedKeys = selector.selectedKeys();</span><br><span class="line">    Iterator&lt;SelectionKey&gt; iter = selectedKeys.iterator();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">        <span class="type">SelectionKey</span> <span class="variable">key</span> <span class="operator">=</span> iter.next();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (key.isAcceptable()) &#123;</span><br><span class="line">            <span class="type">ServerSocketChannel</span> <span class="variable">server</span> <span class="operator">=</span> (ServerSocketChannel) key.channel();</span><br><span class="line">            <span class="type">SocketChannel</span> <span class="variable">client</span> <span class="operator">=</span> server.accept();</span><br><span class="line">            client.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">            client.register(selector, SelectionKey.OP_READ);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key.isReadable()) &#123;</span><br><span class="line">            <span class="type">SocketChannel</span> <span class="variable">client</span> <span class="operator">=</span> (SocketChannel) key.channel();</span><br><span class="line">            <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">            client.read(buffer);</span><br><span class="line">            buffer.flip();</span><br><span class="line">            <span class="comment">// å¤„ç†æ•°æ®...</span></span><br><span class="line">        &#125;</span><br><span class="line">        iter.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>4. ä¿¡å·é©±åŠ¨ I&#x2F;O æ¨¡å‹ (Signal-driven I&#x2F;O)</strong></p><p><strong>ç‰¹ç‚¹</strong>ï¼šé€šè¿‡ä¿¡å·é€šçŸ¥ I&#x2F;O å°±ç»ªçŠ¶æ€ï¼ˆJava ä¸ç›´æ¥æ”¯æŒï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Cè¯­è¨€ç¤ºä¾‹ï¼ˆJavaæ— ç›´æ¥å¯¹åº”APIï¼‰ */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">sigio_handler</span><span class="params">(<span class="type">int</span> signo)</span> &#123;</span><br><span class="line">    <span class="comment">// å¤„ç†I/Oå°±ç»ªäº‹ä»¶</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    signal(SIGIO, sigio_handler);</span><br><span class="line">    fcntl(sockfd, F_SETOWN, getpid());</span><br><span class="line">    fcntl(sockfd, F_SETFL, O_ASYNC | O_NONBLOCK);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>5. å¼‚æ­¥ I&#x2F;O æ¨¡å‹ (Asynchronous I&#x2F;O)</strong></p><p><strong>ç‰¹ç‚¹</strong>ï¼šI&#x2F;O æ“ä½œå®Œæˆåè‡ªåŠ¨é€šçŸ¥ï¼Œæ— éœ€ç­‰å¾…</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æœåŠ¡å™¨ç«¯</span></span><br><span class="line"><span class="type">AsynchronousServerSocketChannel</span> <span class="variable">server</span> <span class="operator">=</span> </span><br><span class="line">    AsynchronousServerSocketChannel.open().bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">8080</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¼‚æ­¥æ¥å—è¿æ¥</span></span><br><span class="line">server.accept(<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">CompletionHandler</span>&lt;AsynchronousSocketChannel, Void&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">completed</span><span class="params">(AsynchronousSocketChannel client, Void attachment)</span> &#123;</span><br><span class="line">        server.accept(<span class="literal">null</span>, <span class="built_in">this</span>); <span class="comment">// ç»§ç»­æ¥å—æ–°è¿æ¥</span></span><br><span class="line">        </span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">        <span class="comment">// å¼‚æ­¥è¯»å–æ•°æ®</span></span><br><span class="line">        client.read(buffer, <span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">CompletionHandler</span>&lt;Integer, Void&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">completed</span><span class="params">(Integer bytesRead, Void attachment)</span> &#123;</span><br><span class="line">                buffer.flip();</span><br><span class="line">                <span class="type">byte</span>[] data = <span class="keyword">new</span> <span class="title class_">byte</span>[buffer.limit()];</span><br><span class="line">                buffer.get(data);</span><br><span class="line">                System.out.println(<span class="string">&quot;Async received: &quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(data));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">failed</span><span class="params">(Throwable exc, Void attachment)</span> &#123;</span><br><span class="line">                exc.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">failed</span><span class="params">(Throwable exc, Void attachment)</span> &#123;</span><br><span class="line">        exc.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><strong>å„æ¨¡å‹å¯¹æ¯”æ€»ç»“</strong></p><table><thead><tr><th align="left">æ¨¡å‹</th><th align="left">é˜»å¡é˜¶æ®µ</th><th align="left">Java å®ç°</th><th align="left">ä¼˜ç‚¹</th><th align="left">ç¼ºç‚¹</th></tr></thead><tbody><tr><td align="left"><strong>é˜»å¡ I&#x2F;O</strong></td><td align="left">ç­‰å¾…æ•°æ®åˆ°è¾¾å’Œå¤åˆ¶</td><td align="left"><code>Socket</code>, <code>ServerSocket</code></td><td align="left">ç¼–ç¨‹ç®€å•</td><td align="left">çº¿ç¨‹èµ„æºæµªè´¹</td></tr><tr><td align="left"><strong>éé˜»å¡ I&#x2F;O</strong></td><td align="left">æ— ï¼ˆä½†éœ€è½®è¯¢ï¼‰</td><td align="left">NIO <code>configureBlocking(false)</code></td><td align="left">å•çº¿ç¨‹ç®¡ç†å¤šè¿æ¥</td><td align="left">è½®è¯¢æ¶ˆè€— CPU</td></tr><tr><td align="left"><strong>I&#x2F;O å¤šè·¯å¤ç”¨</strong></td><td align="left">ç­‰å¾…äº‹ä»¶é€šçŸ¥</td><td align="left">NIO <code>Selector</code></td><td align="left">é«˜æ•ˆç®¡ç†å¤§é‡è¿æ¥</td><td align="left">ç¼–ç¨‹è¾ƒå¤æ‚</td></tr><tr><td align="left"><strong>ä¿¡å·é©±åŠ¨ I&#x2F;O</strong></td><td align="left">æ— ï¼ˆä½†éœ€å¤„ç†ä¿¡å·ï¼‰</td><td align="left">Java ä¸æ”¯æŒ</td><td align="left">å‡å°‘è½®è¯¢å¼€é”€</td><td align="left">ç¼–ç¨‹å¤æ‚ï¼Œä¿¡å·é˜Ÿåˆ—æº¢å‡º</td></tr><tr><td align="left"><strong>å¼‚æ­¥ I&#x2F;O</strong></td><td align="left">æ— ï¼ˆå®Œå…¨å¼‚æ­¥ï¼‰</td><td align="left">NIO.2 <code>AsynchronousChannel</code></td><td align="left">çœŸæ­£éé˜»å¡ï¼Œèµ„æºåˆ©ç”¨ç‡é«˜</td><td align="left">ç¼–ç¨‹æ¨¡å‹å¤æ‚</td></tr></tbody></table><h3 id="Reactoræ¨¡å‹"><a href="#Reactoræ¨¡å‹" class="headerlink" title="Reactoræ¨¡å‹"></a>Reactoræ¨¡å‹</h3><ul><li>å•Reactorå•çº¿ç¨‹</li><li>å•Reactorå¤šçº¿ç¨‹</li><li>ä¸»ä»Reactorå¤šçº¿ç¨‹</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleReactor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Reactor</span>(<span class="number">8083</span>)).start();</span><br><span class="line">        System.out.println(<span class="string">&quot;ReactoræœåŠ¡å™¨å¯åŠ¨ï¼Œç›‘å¬ç«¯å£: 8083&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Reactor</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> Selector selector;</span><br><span class="line">        <span class="keyword">final</span> ServerSocketChannel serverSocket;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">workerPool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">        Reactor(<span class="type">int</span> port) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            selector = Selector.open();</span><br><span class="line">            serverSocket = ServerSocketChannel.open();</span><br><span class="line">            serverSocket.socket().bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(port));</span><br><span class="line">            serverSocket.configureBlocking(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ³¨å†ŒACCEPTäº‹ä»¶åˆ°Selector</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">SelectionKey</span> <span class="variable">sk</span> <span class="operator">=</span> serverSocket.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line">            sk.attach(<span class="keyword">new</span> <span class="title class_">Acceptor</span>());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">while</span> (!Thread.interrupted()) &#123;</span><br><span class="line">                    <span class="comment">// é˜»å¡ç­‰å¾…äº‹ä»¶</span></span><br><span class="line">                    selector.select();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">final</span> Set&lt;SelectionKey&gt; selectionKeys = selector.selectedKeys();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">final</span> Iterator&lt;SelectionKey&gt; it = selectionKeys.iterator();</span><br><span class="line">                    <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">                        <span class="comment">// åˆ†å‘äº‹ä»¶</span></span><br><span class="line">                        dispatch(it.next());</span><br><span class="line">                        it.remove();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">dispatch</span><span class="params">(SelectionKey key)</span> &#123;</span><br><span class="line">            <span class="type">Runnable</span> <span class="variable">handler</span> <span class="operator">=</span> (Runnable) key.attachment();</span><br><span class="line">            <span class="keyword">if</span> (handler != <span class="literal">null</span>) &#123;</span><br><span class="line">                handler.run();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Acceptor</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="type">SocketChannel</span> <span class="variable">client</span> <span class="operator">=</span> serverSocket.accept();</span><br><span class="line">                    <span class="keyword">if</span> (client != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// åˆ›å»ºä¸šåŠ¡å¤„ç†å™¨</span></span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Handler</span>(selector, client, workerPool);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Handler</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">        <span class="comment">// æœ€å¤§è¾“å…¥æ•°æ®</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX_IN</span> <span class="operator">=</span> <span class="number">1024</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> SocketChannel socket;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> SelectionKey sk;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> ExecutorService workerPool;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">ByteBuffer</span> <span class="variable">input</span> <span class="operator">=</span> ByteBuffer.allocate(MAX_IN);</span><br><span class="line">        <span class="keyword">private</span> <span class="type">ByteBuffer</span> <span class="variable">output</span> <span class="operator">=</span> ByteBuffer.allocate(MAX_IN);</span><br><span class="line"></span><br><span class="line">        Handler(Selector selector, SocketChannel socket, ExecutorService workerPool) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="built_in">this</span>.socket = socket;</span><br><span class="line">            <span class="built_in">this</span>.workerPool = workerPool;</span><br><span class="line">            socket.configureBlocking(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ³¨å†ŒREADäº‹ä»¶</span></span><br><span class="line">            sk = socket.register(selector, SelectionKey.OP_READ);</span><br><span class="line">            <span class="comment">// ç»‘å®šhandler</span></span><br><span class="line">            sk.attach(<span class="built_in">this</span>);</span><br><span class="line">            <span class="comment">// å”¤é†’selector</span></span><br><span class="line">            selector.wakeup();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (sk.isReadable()) &#123;</span><br><span class="line">                    read();</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sk.isWritable()) &#123;</span><br><span class="line">                    write();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                closeConnection();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">read</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            input.clear();</span><br><span class="line">            <span class="comment">// è¯»æ“ä½œä¾ç„¶åœ¨Reactorä¸»çº¿ç¨‹</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> socket.read(input);</span><br><span class="line">            <span class="keyword">if</span> (n &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// ä¸šåŠ¡å¤„ç†å¦èµ·çº¿ç¨‹</span></span><br><span class="line">                workerPool.execute(<span class="keyword">new</span> <span class="title class_">Processor</span>(<span class="keyword">new</span> <span class="title class_">String</span>(input.array(), <span class="number">0</span>, n)));</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (n &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                closeConnection();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            output.flip();</span><br><span class="line">            <span class="comment">// å†™æ“ä½œä¾ç„¶åœ¨Reactorä¸»çº¿</span></span><br><span class="line">            socket.write(output);</span><br><span class="line">            <span class="keyword">if</span> (!output.hasRemaining()) &#123;</span><br><span class="line">                <span class="comment">// å†™å®Œåé‡æ–°æ³¨å†Œè¯»äº‹ä»¶</span></span><br><span class="line">                sk.interestOps(SelectionKey.OP_READ);</span><br><span class="line">            &#125;</span><br><span class="line">            output.compact();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">closeConnection</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sk.cancel();</span><br><span class="line">                socket.close();</span><br><span class="line">                System.out.println(<span class="string">&quot;è¿æ¥å…³é—­ï¼š&quot;</span> + socket.getRemoteAddress());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Processor</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">final</span> String request;</span><br><span class="line"></span><br><span class="line">            Processor(String request) &#123;</span><br><span class="line">                <span class="built_in">this</span>.request = request;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="comment">// æ¨¡æ‹Ÿä¸šåŠ¡æ“ä½œ</span></span><br><span class="line">                <span class="keyword">final</span> <span class="type">String</span> <span class="variable">response</span> <span class="operator">=</span> request.toUpperCase(Locale.ROOT);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// æ³¨æ„ï¼šéReactorçº¿ç¨‹æ“ä½œï¼Œéœ€è¦åŒæ­¥</span></span><br><span class="line">                <span class="keyword">synchronized</span> (output) &#123;</span><br><span class="line">                    output.put(response.getBytes());</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// æ³¨å†Œå†™äº‹ä»¶</span></span><br><span class="line">                    sk.interestOps(SelectionKey.OP_WRITE);</span><br><span class="line">                &#125;</span><br><span class="line">                sk.selector().wakeup();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReactorClient</span> &#123;</span><br><span class="line">    <span class="comment">// å®¢æˆ·ç«¯æ•°é‡</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CLIENT_COUNT</span> <span class="operator">=</span> <span class="number">50</span>;</span><br><span class="line">    <span class="comment">// æ¯ä¸ªå®¢æˆ·ç«¯è¯·æ±‚æ¬¡æ•°</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">REQUEST_PER_CLIENT</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SERVER_HOST</span> <span class="operator">=</span> <span class="string">&quot;localhost&quot;</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SERVER_PORT</span> <span class="operator">=</span> <span class="number">8083</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">pool</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(CLIENT_COUNT);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; CLIENT_COUNT; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">clientId</span> <span class="operator">=</span> i;</span><br><span class="line">            pool.execute(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; REQUEST_PER_CLIENT; j++) &#123;</span><br><span class="line">                        sendRequest(clientId, j);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    latch.countDown();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        latch.await();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> <span class="variable">duration</span> <span class="operator">=</span> System.currentTimeMillis() - start;</span><br><span class="line">        System.out.printf(<span class="string">&quot;\næµ‹è¯•å®Œæˆ! æ€»è¯·æ±‚: %d, è€—æ—¶: %dms, QPS: %.1f\n&quot;</span>,</span><br><span class="line">            CLIENT_COUNT * REQUEST_PER_CLIENT,</span><br><span class="line">            duration,</span><br><span class="line">            CLIENT_COUNT * REQUEST_PER_CLIENT * <span class="number">1000.0</span> / duration);</span><br><span class="line">        pool.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sendRequest</span><span class="params">(<span class="type">int</span> clientId, <span class="type">int</span> requestId)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">SocketChannel</span> <span class="variable">socket</span> <span class="operator">=</span> SocketChannel.open()) &#123;</span><br><span class="line">            <span class="comment">// è¿æ¥æœåŠ¡å™¨</span></span><br><span class="line">            socket.connect(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(SERVER_HOST, SERVER_PORT));</span><br><span class="line">            <span class="keyword">final</span> <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> String.format(<span class="string">&quot;Client-%d_Req-%d&quot;</span>, clientId, requestId);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å‘é€è¯·æ±‚</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.wrap(message.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">            socket.write(buffer);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ¥æ”¶å“åº”</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">ByteBuffer</span> <span class="variable">response</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">            socket.read(response);</span><br><span class="line">            response.flip();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ‰“å°ç»“æœï¼ˆå®é™…å‹åŠ›æµ‹è¯•åº”æ³¨é‡Šæ‰ï¼‰</span></span><br><span class="line">            System.out.printf(<span class="string">&quot;Client-%d æ”¶åˆ°å“åº”: %s\n&quot;</span>,</span><br><span class="line">                clientId,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">String</span>(response.array(), <span class="number">0</span>, response.limit()));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ·»åŠ å»¶è¿Ÿæ¨¡æ‹ŸçœŸå®åœºæ™¯</span></span><br><span class="line">            Thread.sleep((<span class="type">long</span>) (Math.random() * <span class="number">10</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="selectã€pollã€epollçš„åŒºåˆ«"><a href="#selectã€pollã€epollçš„åŒºåˆ«" class="headerlink" title="selectã€pollã€epollçš„åŒºåˆ«"></a><code>select</code>ã€<code>poll</code>ã€<code>epoll</code>çš„åŒºåˆ«</h3><h2 id="Javaå¹¶å‘"><a href="#Javaå¹¶å‘" class="headerlink" title="Javaå¹¶å‘"></a>Javaå¹¶å‘</h2><ul><li><strong>æ·±å…¥å¹¶å‘ç¼–ç¨‹:</strong> å½»åº•æŒæ¡ <code>java.util.concurrent</code> åŒ… (<code>ExecutorService</code>, <code>ThreadPoolExecutor</code>, <code>Future</code>, <code>CompletableFuture</code>, <code>ConcurrentHashMap</code>, <code>ReentrantLock</code>, <code>StampedLock</code>, <code>Semaphore</code>, <code>CountDownLatch</code>, <code>CyclicBarrier</code>, <code>Phaser</code>)ã€‚ç†è§£ Java å†…å­˜æ¨¡å‹ï¼ˆJMMï¼‰ã€Happens-Before åŸåˆ™ã€volatileã€synchronized çš„åº•å±‚å®ç°ï¼ˆåå‘é”ã€è½»é‡çº§é”ã€é‡é‡çº§é”ã€é”å‡çº§è¿‡ç¨‹ï¼‰ã€CASã€AQS æ¡†æ¶ã€‚èƒ½è¯Šæ–­å’Œè§£å†³æ­»é”ã€æ´»é”ã€çº¿ç¨‹é¥¥é¥¿ã€ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€é«˜ç­‰å¤æ‚å¹¶å‘é—®é¢˜ã€‚</li></ul><h3 id="çº¿ç¨‹æ± "><a href="#çº¿ç¨‹æ± " class="headerlink" title="çº¿ç¨‹æ± "></a>çº¿ç¨‹æ± </h3><h4 id="çº¿ç¨‹æ± å…³é”®å‚æ•°"><a href="#çº¿ç¨‹æ± å…³é”®å‚æ•°" class="headerlink" title="çº¿ç¨‹æ± å…³é”®å‚æ•°"></a>çº¿ç¨‹æ± å…³é”®å‚æ•°</h4><ul><li><code>corePoolSize</code>ï¼šæ ¸å¿ƒçº¿ç¨‹æ•°ã€‚å³ä½¿çº¿ç¨‹ç©ºé—²ï¼Œä¹Ÿä¼šä¿ç•™åœ¨çº¿ç¨‹æ± ä¸­ï¼ˆé™¤éè®¾ç½® <code>allowCoreThreadTimeOut</code>ï¼‰ã€‚</li><li><code>maximumPoolSize</code>ï¼šçº¿ç¨‹æ± å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•°ã€‚</li><li><code>keepAliveTime</code>ï¼šå½“çº¿ç¨‹æ•°è¶…è¿‡ <code>corePoolSize</code> æ—¶ï¼Œå¤šä½™çš„ç©ºé—²çº¿ç¨‹åœ¨ç»ˆæ­¢å‰ç­‰å¾…æ–°ä»»åŠ¡çš„æœ€é•¿æ—¶é—´ã€‚</li><li><code>unit</code>ï¼š<code>keepAliveTime</code> çš„æ—¶é—´å•ä½ã€‚</li><li><code>workQueue</code>ï¼šç”¨äºä¿å­˜ç­‰å¾…æ‰§è¡Œä»»åŠ¡çš„é˜»å¡é˜Ÿåˆ—ï¼ˆå¦‚ <code>LinkedBlockingQueue</code>, <code>ArrayBlockingQueue</code>, <code>SynchronousQueue</code>ï¼‰ã€‚</li><li><code>threadFactory</code>ï¼šç”¨äºåˆ›å»ºæ–°çº¿ç¨‹çš„å·¥å‚ï¼ˆå¯å®šåˆ¶çº¿ç¨‹åã€ä¼˜å…ˆçº§ã€å®ˆæŠ¤çŠ¶æ€ç­‰ï¼‰ã€‚</li><li><code>handler</code>ï¼šå½“çº¿ç¨‹æ± å’Œé˜Ÿåˆ—éƒ½é¥±å’Œæ—¶ï¼Œæ–°æäº¤ä»»åŠ¡çš„æ‹’ç»ç­–ç•¥ï¼ˆ<code>RejectedExecutionHandler</code> çš„å®ç°ï¼‰ã€‚</li></ul><h4 id="å¸¸è§çš„æ‹’ç»ç­–ç•¥"><a href="#å¸¸è§çš„æ‹’ç»ç­–ç•¥" class="headerlink" title="å¸¸è§çš„æ‹’ç»ç­–ç•¥"></a>å¸¸è§çš„æ‹’ç»ç­–ç•¥</h4><ul><li><code>AbortPolicy</code>ï¼ˆé»˜è®¤ï¼‰ï¼šç›´æ¥æŠ›å‡º <code>RejectedExecutionException</code> å¼‚å¸¸ã€‚</li><li><code>CallerRunsPolicy</code>ï¼šç”±æäº¤ä»»åŠ¡çš„çº¿ç¨‹ï¼ˆè°ƒç”¨ <code>execute</code> æ–¹æ³•çš„çº¿ç¨‹ï¼‰è‡ªå·±æ‰§è¡Œè¯¥ä»»åŠ¡ã€‚</li><li><code>DiscardPolicy</code>ï¼šé™é»˜ä¸¢å¼ƒè¢«æ‹’ç»çš„ä»»åŠ¡ï¼Œä¸åšä»»ä½•å¤„ç†ã€‚</li><li><code>DiscardOldestPolicy</code>ï¼šä¸¢å¼ƒé˜Ÿåˆ—ä¸­æœ€å‰é¢çš„ä»»åŠ¡ï¼ˆç­‰å¾…æœ€ä¹…çš„ï¼‰ï¼Œç„¶åå°è¯•é‡æ–°æäº¤å½“å‰ä»»åŠ¡ã€‚</li><li>è‡ªå®šä¹‰ç­–ç•¥ï¼šå®ç° <code>RejectedExecutionHandler</code> æ¥å£å®šä¹‰è‡ªå·±çš„é€»è¾‘ï¼ˆå¦‚è®°å½•æ—¥å¿—ã€æŒä¹…åŒ–ä»»åŠ¡ç­‰ï¼‰ã€‚</li></ul><h4 id="ä»»åŠ¡æäº¤åˆ°çº¿ç¨‹æ± çš„å·¥ä½œæµç¨‹"><a href="#ä»»åŠ¡æäº¤åˆ°çº¿ç¨‹æ± çš„å·¥ä½œæµç¨‹" class="headerlink" title="ä»»åŠ¡æäº¤åˆ°çº¿ç¨‹æ± çš„å·¥ä½œæµç¨‹"></a>ä»»åŠ¡æäº¤åˆ°çº¿ç¨‹æ± çš„å·¥ä½œæµç¨‹</h4><ol><li>æäº¤ä¸€ä¸ªæ–°ä»»åŠ¡ã€‚</li><li>å½“å‰çº¿ç¨‹æ•° &lt; <code>corePoolSize</code>ï¼Œåˆ›å»ºæ–°çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼ˆå³ä½¿æœ‰ç©ºé—²æ ¸å¿ƒçº¿ç¨‹ï¼‰ã€‚</li><li>å½“å‰çº¿ç¨‹æ•° &gt;&#x3D; <code>corePoolSize</code>ï¼Œå°†ä»»åŠ¡æ”¾å…¥ <code>workQueue</code>ã€‚</li><li>é˜Ÿåˆ—å·²æ»¡ï¼Œä¸”å½“å‰çº¿ç¨‹æ•° &lt; <code>maximumPoolSize</code>ï¼Œåˆ›å»ºæ–°çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ã€‚</li><li>é˜Ÿåˆ—å·²æ»¡ï¼Œä¸”å½“å‰çº¿ç¨‹æ•° &gt;&#x3D; <code>maximumPoolSize</code>ï¼Œè§¦å‘æ‹’ç»ç­–ç•¥ (<code>handler</code>) å¤„ç†è¯¥ä»»åŠ¡ã€‚</li><li>å½“ä¸€ä¸ªçº¿ç¨‹ç©ºé—²æ—¶é—´è¶…è¿‡ <code>keepAliveTime</code>ï¼š<ul><li>å¤§äº <code>corePoolSize</code> çš„ç©ºé—²çº¿ç¨‹ä¼šè¢«ç»ˆæ­¢ã€‚</li><li>å¦‚æœ <code>allowCoreThreadTimeOut</code> ä¸º <code>true</code>ï¼Œæ ¸å¿ƒçº¿ç¨‹ç©ºé—²è¶…æ—¶ä¹Ÿä¼šè¢«ç»ˆæ­¢ã€‚</li></ul></li></ol><h4 id="shutdown-å’ŒshutdownNow-æœ‰ä»€ä¹ˆåŒºåˆ«"><a href="#shutdown-å’ŒshutdownNow-æœ‰ä»€ä¹ˆåŒºåˆ«" class="headerlink" title="shutdown()å’ŒshutdownNow()æœ‰ä»€ä¹ˆåŒºåˆ«"></a><code>shutdown()</code>å’Œ<code>shutdownNow()</code>æœ‰ä»€ä¹ˆåŒºåˆ«</h4><ul><li><code>shutdown()</code>ï¼šæ¸©å’Œå…³é—­ã€‚ä¸å†æ¥å—æ–°ä»»åŠ¡ï¼Œä½†ä¼šæ‰§è¡Œå®Œå·²æäº¤çš„ä»»åŠ¡ï¼ˆåŒ…æ‹¬é˜Ÿåˆ—ä¸­çš„ï¼‰ã€‚</li><li><code>shutdownNow()</code>ï¼šå°è¯•ç«‹å³åœæ­¢æ‰€æœ‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œæš‚åœå¤„ç†ç­‰å¾…çš„ä»»åŠ¡ï¼Œå¹¶è¿”å›ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡åˆ—è¡¨ã€‚é€šè¿‡è°ƒç”¨çº¿ç¨‹çš„ <code>interrupt()</code> æ–¹æ³•å°è¯•ä¸­æ–­ä»»åŠ¡ï¼ˆå¦‚æœä»»åŠ¡ä¸å“åº”ä¸­æ–­ï¼Œåˆ™æ— æ³•åœæ­¢ï¼‰ã€‚</li></ul><h4 id="çº¿ç¨‹æ± çš„execute-å’Œsubmitï¼ˆï¼‰æœ‰ä»€ä¹ˆåŒºåˆ«"><a href="#çº¿ç¨‹æ± çš„execute-å’Œsubmitï¼ˆï¼‰æœ‰ä»€ä¹ˆåŒºåˆ«" class="headerlink" title="çº¿ç¨‹æ± çš„execute()å’Œsubmitï¼ˆï¼‰æœ‰ä»€ä¹ˆåŒºåˆ«"></a>çº¿ç¨‹æ± çš„<code>execute()</code>å’Œ<code>submitï¼ˆï¼‰</code>æœ‰ä»€ä¹ˆåŒºåˆ«</h4><p><code>void execute(Runnable command)</code> ä¸»è¦ç”¨æ¥æäº¤ä¸éœ€è¦è¿”å›å€¼çš„å¼‚æ­¥ä»»åŠ¡ã€‚</p><p><code>submit</code> ä¸»è¦ç”¨æ¥æäº¤éœ€è¦è¿”å›å€¼çš„å¼‚æ­¥ä»»åŠ¡ã€‚</p><h4 id="çº¿ç¨‹æ± å¼‚å¸¸çš„å¤„ç†æ–¹æ³•"><a href="#çº¿ç¨‹æ± å¼‚å¸¸çš„å¤„ç†æ–¹æ³•" class="headerlink" title="çº¿ç¨‹æ± å¼‚å¸¸çš„å¤„ç†æ–¹æ³•"></a>çº¿ç¨‹æ± å¼‚å¸¸çš„å¤„ç†æ–¹æ³•</h4><ul><li><strong>ä½¿ç”¨Futureå¯¹è±¡æ•è·å¼‚å¸¸</strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolExceptionHandling</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">workerTask</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ä»»åŠ¡ &quot;</span> + n + <span class="string">&quot; å¼€å§‹æ‰§è¡Œ&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">400</span>) + <span class="number">100</span>); <span class="comment">// 100-500mséšæœºç¡çœ </span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// éšæœºæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">new</span> <span class="title class_">Random</span>().nextDouble() &lt; <span class="number">0.3</span>) &#123; <span class="comment">// 30%çš„æ¦‚ç‡æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;ä»»åŠ¡ &quot;</span> + n + <span class="string">&quot; æ‰§è¡Œå‡ºé”™&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ä»»åŠ¡ &quot;</span> + n + <span class="string">&quot; å®Œæˆ&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">3</span>);</span><br><span class="line">        List&lt;Future&lt;String&gt;&gt; futures = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æäº¤ä»»åŠ¡åˆ°çº¿ç¨‹æ± </span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">taskId</span> <span class="operator">=</span> i;</span><br><span class="line">            Future&lt;String&gt; future = executor.submit(() -&gt; workerTask(taskId));</span><br><span class="line">            futures.add(future);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¤„ç†å®Œæˆçš„ä»»åŠ¡</span></span><br><span class="line">        <span class="keyword">for</span> (Future&lt;String&gt; future : futures) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> future.get(); <span class="comment">// è·å–ç»“æœï¼Œå¦‚æœæœ‰å¼‚å¸¸ä¼šåœ¨è¿™é‡ŒæŠ›å‡º</span></span><br><span class="line">                System.out.println(<span class="string">&quot;æˆåŠŸ: &quot;</span> + result);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException | ExecutionException e) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;æ•è·åˆ°å¼‚å¸¸: &quot;</span> + e.getCause().getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        executor.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>ä½¿ç”¨UncaughtExceptionHandler</strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadExceptionHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ExceptionHandlingThreadFactory</span> <span class="keyword">implements</span> <span class="title class_">ThreadFactory</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ThreadFactory</span> <span class="variable">defaultFactory</span> <span class="operator">=</span> Executors.defaultThreadFactory();</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Thread <span class="title function_">newThread</span><span class="params">(Runnable r)</span> &#123;</span><br><span class="line">            <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> defaultFactory.newThread(r);</span><br><span class="line">            thread.setUncaughtExceptionHandler((t, e) -&gt; &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;çº¿ç¨‹ &quot;</span> + t.getName() + <span class="string">&quot; ä¸­æœªæ•è·çš„å¼‚å¸¸: &quot;</span> + e.getMessage());</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">return</span> thread;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">worker</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (n % <span class="number">3</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;ä»»åŠ¡ &quot;</span> + n + <span class="string">&quot; å‡ºé”™äº†&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ä»»åŠ¡ &quot;</span> + n + <span class="string">&quot; å®Œæˆ&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">2</span>, <span class="keyword">new</span> <span class="title class_">ExceptionHandlingThreadFactory</span>());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">taskId</span> <span class="operator">=</span> i;</span><br><span class="line">            executor.execute(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> worker(taskId);</span><br><span class="line">                    System.out.println(result);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    <span class="comment">// å¼‚å¸¸ä¼šè¢«UncaughtExceptionHandlerå¤„ç†</span></span><br><span class="line">                    <span class="keyword">throw</span> e;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        executor.shutdown();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            executor.awaitTermination(<span class="number">5</span>, TimeUnit.SECONDS);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">&quot;æ‰€æœ‰ä»»åŠ¡å¤„ç†å®Œæ¯•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="çº¿ç¨‹æ± ç¤ºä¾‹"><a href="#çº¿ç¨‹æ± ç¤ºä¾‹" class="headerlink" title="çº¿ç¨‹æ± ç¤ºä¾‹"></a>çº¿ç¨‹æ± ç¤ºä¾‹</h4><h5 id="æ‰¹é‡æ•°æ®å¤„ç†-å¯æ‰©å®¹çº¿ç¨‹æ± -æ— ç•Œ-æœ‰ç•Œé˜Ÿåˆ—"><a href="#æ‰¹é‡æ•°æ®å¤„ç†-å¯æ‰©å®¹çº¿ç¨‹æ± -æ— ç•Œ-æœ‰ç•Œé˜Ÿåˆ—" class="headerlink" title="æ‰¹é‡æ•°æ®å¤„ç† (å¯æ‰©å®¹çº¿ç¨‹æ±  + æ— ç•Œ&#x2F;æœ‰ç•Œé˜Ÿåˆ—)"></a>æ‰¹é‡æ•°æ®å¤„ç† (å¯æ‰©å®¹çº¿ç¨‹æ±  + æ— ç•Œ&#x2F;æœ‰ç•Œé˜Ÿåˆ—)</h5><ul><li><strong>åœºæ™¯æè¿°ï¼š</strong> éœ€è¦å¤„ç†ä¸€ä¸ªåŒ…å«å¤§é‡æ•°æ®ï¼ˆå¦‚ç™¾ä¸‡æ¡è®°å½•ï¼‰çš„æ–‡ä»¶æˆ–æ•°æ®åº“æŸ¥è¯¢ç»“æœé›†ã€‚å¯ä»¥å°†æ¯æ¡è®°å½•çš„å¤„ç†ä½œä¸ºä¸€ä¸ªä»»åŠ¡ã€‚</li><li><strong>çº¿ç¨‹æ± é€‰æ‹©ï¼š</strong> ä½¿ç”¨ <code>corePoolSize</code> è¾ƒå°ï¼Œ<code>maximumPoolSize</code> è¾ƒå¤§çš„çº¿ç¨‹æ± ï¼Œé…åˆæ— ç•Œé˜Ÿåˆ—ï¼ˆå¦‚æœå†…å­˜å……è¶³ä¸”ä»»åŠ¡é‡å¯æ§ï¼‰æˆ–æœ‰ç•Œé˜Ÿåˆ—ã€‚å…è®¸åœ¨ä»»åŠ¡çªå¢æ—¶åˆ›å»ºæ›´å¤šçº¿ç¨‹åŠ é€Ÿå¤„ç†ã€‚</li><li><strong>æ‹’ç»ç­–ç•¥ï¼š</strong> å¦‚æœä½¿ç”¨æœ‰ç•Œé˜Ÿåˆ—ï¼Œæ ¹æ®ä¸šåŠ¡é‡è¦æ€§é€‰æ‹©ï¼ˆå¦‚ <code>AbortPolicy</code> è®°å½•æ—¥å¿—åè·³è¿‡ï¼Œæˆ– <code>CallerRunsPolicy</code> è®©ä¸»çº¿ç¨‹å¤„ç†ï¼‰ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BatchDataProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CORE_POOL_SIZE</span> <span class="operator">=</span> Runtime.getRuntime().availableProcessors(); <span class="comment">// æ¯”å¦‚ç­‰äºCPUæ ¸å¿ƒæ•°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX_POOL_SIZE</span> <span class="operator">=</span> <span class="number">50</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">QUEUE_CAPACITY</span> <span class="operator">=</span> <span class="number">10000</span>; <span class="comment">// æœ‰ç•Œé˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">KEEP_ALIVE_TIME</span> <span class="operator">=</span> <span class="number">60L</span>; <span class="comment">// ç©ºé—²çº¿ç¨‹60ç§’åå›æ”¶</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ThreadPoolExecutor</span> <span class="variable">batchExecutor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">            CORE_POOL_SIZE,</span><br><span class="line">            MAX_POOL_SIZE,</span><br><span class="line">            KEEP_ALIVE_TIME,</span><br><span class="line">            TimeUnit.SECONDS,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;&gt;(QUEUE_CAPACITY),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">NamedThreadFactory</span>(<span class="string">&quot;BatchProcessor-&quot;</span>),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.AbortPolicy() <span class="comment">// é˜Ÿåˆ—æ»¡æ—¶æŠ›å‡ºå¼‚å¸¸ï¼Œå¤–å±‚éœ€è¦æ•è·å¤„ç†</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processLargeDataset</span><span class="params">(List&lt;DataRecord&gt; records)</span> &#123;</span><br><span class="line">        List&lt;Future&lt;?&gt;&gt; futures = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (DataRecord record : records) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// ä½¿ç”¨submitå¯ä»¥è·å–Futureï¼Œä¾¿äºåç»­æ£€æŸ¥å®ŒæˆçŠ¶æ€æˆ–å¼‚å¸¸</span></span><br><span class="line">                Future&lt;?&gt; future = batchExecutor.submit(() -&gt; processSingleRecord(record));</span><br><span class="line">                futures.add(future);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RejectedExecutionException e) &#123;</span><br><span class="line">                <span class="comment">// å¤„ç†è¢«æ‹’ç»çš„ä»»åŠ¡ (å¦‚è®°å½•æ—¥å¿—ã€æ”¾å…¥é‡è¯•é˜Ÿåˆ—ç­‰)</span></span><br><span class="line">                log.error(<span class="string">&quot;Task rejected for record: &quot;</span> + record.getId(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç­‰å¾…æ‰€æœ‰æäº¤çš„ä»»åŠ¡å®Œæˆ (ç®€å•ç­‰å¾…)</span></span><br><span class="line">        <span class="keyword">for</span> (Future&lt;?&gt; future : futures) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                future.get(); <span class="comment">// é˜»å¡ç­‰å¾…ä»»åŠ¡å®Œæˆï¼Œæ•è·å¯èƒ½çš„ExecutionException</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException | ExecutionException e) &#123;</span><br><span class="line">                <span class="comment">// å¤„ç†ä»»åŠ¡æ‰§è¡Œä¸­çš„å¼‚å¸¸</span></span><br><span class="line">                log.error(<span class="string">&quot;Error processing task&quot;</span>, e.getCause()); <span class="comment">// è·å–åŸå§‹å¼‚å¸¸</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processSingleRecord</span><span class="params">(DataRecord record)</span> &#123;</span><br><span class="line">        <span class="comment">// ... å¤„ç†å•æ¡è®°å½•çš„å¤æ‚é€»è¾‘ ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é”"><a href="#é”" class="headerlink" title="é”"></a>é”</h3><h4 id="synchronized-å®ç°åŸç†"><a href="#synchronized-å®ç°åŸç†" class="headerlink" title="synchronized å®ç°åŸç†"></a><code>synchronized</code> å®ç°åŸç†</h4><p><code>synchronized</code> å…³é”®å­—åœ¨ Java ä¸­çš„åº•å±‚å®ç°ä¾èµ–äº <strong>JVM å¯¹è±¡å¤´ã€Monitor ç›‘è§†å™¨é”ä»¥åŠé”å‡çº§æœºåˆ¶</strong>ã€‚</p><p><strong>å¯¹è±¡å¤´ä¸ Mark Word</strong></p><ul><li><p>æ¯ä¸ª Java å¯¹è±¡åœ¨å†…å­˜ä¸­åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š</p><ul><li><strong>å¯¹è±¡å¤´ï¼ˆHeaderï¼‰</strong>ï¼šå­˜å‚¨é”çŠ¶æ€ã€GC å¹´é¾„ç­‰å…ƒæ•°æ®ã€‚<ul><li><strong>Mark Word</strong>ï¼ˆå¯¹è±¡å¤´çš„æ ¸å¿ƒéƒ¨åˆ†ï¼‰ï¼š<strong>é”çŠ¶æ€çš„å˜åŒ–ç›´æ¥ä½“ç°åœ¨ Mark Word çš„æ¯”ç‰¹ä½ç»„åˆä¸Šã€‚</strong></li></ul></li><li>å®ä¾‹æ•°æ®ï¼ˆInstance Dataï¼‰ï¼šå¯¹è±¡å­—æ®µå€¼ã€‚</li></ul></li><li><p>å¯¹é½å¡«å……ï¼ˆPaddingï¼‰ï¼šä¿è¯å†…å­˜å¯¹é½ã€‚</p></li></ul><p><strong>Monitor çš„æ ¸å¿ƒç»“æ„</strong>ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ObjectMonitor</span> &#123;</span><br><span class="line">    <span class="type">void</span>*     _header;      <span class="comment">// å­˜å‚¨ Mark Word çš„å¤‡ä»½</span></span><br><span class="line">    <span class="type">void</span>*     _owner;       <span class="comment">// æŒæœ‰é”çš„çº¿ç¨‹ï¼ˆå¦‚ï¼šThread*ï¼‰</span></span><br><span class="line">    <span class="type">intptr_t</span>  _count;       <span class="comment">// é‡å…¥æ¬¡æ•°</span></span><br><span class="line">    ObjectWaiter* _WaitSet; <span class="comment">// è°ƒç”¨ wait() åè¿›å…¥ç­‰å¾…é˜Ÿåˆ—</span></span><br><span class="line">    ObjectWaiter* _EntryList; <span class="comment">// é˜»å¡ç­‰å¾…é”çš„çº¿ç¨‹é˜Ÿåˆ—</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>é”å‡çº§æœºåˆ¶</strong></p><p>ä¸ºæé«˜æ€§èƒ½ï¼Œä» java1.6 å¼€å§‹é‡‡ç”¨æ¸è¿›å¼é”å‡çº§ç­–ç•¥ï¼š</p><p><strong>åå‘é”ï¼ˆBiased Lockingï¼‰</strong></p><ul><li><strong>ç›®æ ‡</strong>ï¼šå‡å°‘æ— ç«äº‰æ—¶çš„å¼€é”€ã€‚</li><li><strong>æµç¨‹</strong>ï¼š<ul><li>é¦–æ¬¡åŠ é”æ—¶ï¼Œé€šè¿‡ CAS å°† Mark Word çš„é”æ ‡å¿—ç½®ä¸º <code>101</code>ï¼ˆåå‘é”ï¼‰ï¼Œå¹¶å†™å…¥å½“å‰çº¿ç¨‹ IDã€‚</li><li>åç»­åŒä¸€çº¿ç¨‹è¿›å…¥åŒæ­¥å—æ—¶ï¼Œåªéœ€æ£€æŸ¥çº¿ç¨‹ ID åŒ¹é…å³å¯ç›´æ¥æ‰§è¡Œï¼ˆé›¶å¼€é”€ï¼‰ã€‚</li></ul></li><li><strong>æ’¤é”€</strong>ï¼šå½“å…¶ä»–çº¿ç¨‹å°è¯•è·å–é”æ—¶ï¼Œæ’¤é”€åå‘é”ï¼ˆStop-The-World æ“ä½œï¼‰ã€‚</li></ul><p><strong>è½»é‡çº§é”ï¼ˆLightweight Lockingï¼‰</strong></p><ul><li><strong>ç›®æ ‡</strong>ï¼šé¿å…çŸ­æ—¶é˜»å¡çš„çº¿ç¨‹åˆ‡æ¢å¼€é”€ã€‚</li><li><strong>æµç¨‹</strong>ï¼š<ol><li>åœ¨æ ˆå¸§ä¸­åˆ›å»º <strong>é”è®°å½•ï¼ˆLock Recordï¼‰</strong>ã€‚</li><li>é€šè¿‡ CAS å°† Mark Word å¤åˆ¶åˆ°é”è®°å½•ï¼Œå¹¶å°è¯•å°† Mark Word æ›¿æ¢ä¸ºæŒ‡å‘é”è®°å½•çš„æŒ‡é’ˆã€‚</li><li>æˆåŠŸåˆ™è·å¾—é”ï¼›å¤±è´¥åˆ™è‡ªæ—‹ï¼ˆå¾ªç¯å°è¯•ï¼‰ä¸€å®šæ¬¡æ•°ã€‚</li></ol></li><li><strong>è‡ªæ—‹å¤±è´¥åå‡çº§ä¸ºé‡é‡çº§é”</strong>ã€‚</li></ul><p><strong>é‡é‡çº§é”ï¼ˆHeavyweight Lockingï¼‰</strong></p><ul><li>å½“ç«äº‰æ¿€çƒˆæ—¶ï¼Œæœ€ç»ˆå‡çº§ä¸ºé‡é‡çº§é”ã€‚</li><li>çº¿ç¨‹é€šè¿‡æ“ä½œç³»ç»Ÿäº’æ–¥é‡ï¼ˆmutexï¼‰é˜»å¡ï¼Œè¿›å…¥å†…æ ¸æ€ï¼Œæ€§èƒ½å¼€é”€æœ€å¤§ã€‚</li></ul><img src="/post/7992e236/image-20250725195316321.png" class="" title="image-20250725195316321"><h4 id="ReentrantLock-å®ç°åŸç†"><a href="#ReentrantLock-å®ç°åŸç†" class="headerlink" title="ReentrantLock å®ç°åŸç†"></a><code>ReentrantLock</code> å®ç°åŸç†</h4><p><code>ReentrantLock</code> åŸºäº **AbstractQueuedSynchronizer (AQS)**ã€‚AQS æä¾›äº†ä¸€ä¸ªæ¡†æ¶ï¼Œç”¨äºæ„å»ºä¾èµ–å…ˆè¿›å…ˆå‡º (FIFO) ç­‰å¾…é˜Ÿåˆ—çš„é˜»å¡é”å’Œç›¸å…³åŒæ­¥å™¨ï¼ˆå¦‚ä¿¡å·é‡ã€å€’è®¡æ—¶é—¨æ “ç­‰ï¼‰ã€‚</p><ol><li><strong>æ ¸å¿ƒç»„ä»¶ - AQSï¼š</strong><ul><li><code>state</code> (volatile int)ï¼š è¡¨ç¤ºé”çš„çŠ¶æ€ã€‚0 è¡¨ç¤ºé”ç©ºé—²ï¼Œ&gt;0 è¡¨ç¤ºè¢«æŒæœ‰ï¼ˆé€šå¸¸æ˜¯æŒæœ‰çº¿ç¨‹çš„é‡å…¥æ¬¡æ•°ï¼‰ã€‚</li><li><code>exclusiveOwnerThread</code> (Thread)ï¼š è®°å½•å½“å‰æŒæœ‰ç‹¬å é”ï¼ˆå¦‚ ReentrantLockï¼‰çš„çº¿ç¨‹ã€‚</li><li><strong>CLH é˜Ÿåˆ— (å˜ä½“çš„ FIFO é˜Ÿåˆ—)ï¼š</strong> ç”± <code>Node</code> èŠ‚ç‚¹æ„æˆçš„åŒå‘é“¾è¡¨ï¼Œç”¨äºç®¡ç†ç­‰å¾…è·å–é”çš„çº¿ç¨‹ã€‚æ¯ä¸ªèŠ‚ç‚¹ä»£è¡¨ä¸€ä¸ªç­‰å¾…çº¿ç¨‹ã€‚</li></ul></li><li><strong>è·å–é” (lock() &#x2F; tryLock())ï¼š</strong><ul><li><strong>éå…¬å¹³æ¨¡å¼ (é»˜è®¤)ï¼š</strong><ol><li>çº¿ç¨‹ç›´æ¥å°è¯•é€šè¿‡ CAS (Compare-And-Swap) æ“ä½œå°† <code>state</code> ä» 0 è®¾ç½®ä¸º 1ï¼ˆå°è¯•å¿«é€Ÿè·å–ï¼‰ã€‚</li><li>å¦‚æœæˆåŠŸï¼Œè®¾ç½® <code>exclusiveOwnerThread</code> ä¸ºå½“å‰çº¿ç¨‹ã€‚</li><li>å¦‚æœå¤±è´¥ï¼ˆé”å·²è¢«æŒæœ‰ï¼‰ï¼š<ul><li>å¦‚æœå½“å‰çº¿ç¨‹å°±æ˜¯æŒæœ‰é”çš„çº¿ç¨‹ï¼ˆé‡å…¥ï¼‰ï¼Œåˆ™ç›´æ¥å°† <code>state</code> åŠ  1ã€‚</li><li>å¦åˆ™ï¼Œåˆ›å»ºä¸€ä¸ªä»£è¡¨å½“å‰çº¿ç¨‹çš„ <code>Node</code> èŠ‚ç‚¹ï¼Œé€šè¿‡ CAS æ“ä½œå°†å…¶å®‰å…¨åœ°åŠ å…¥åˆ° CLH é˜Ÿåˆ—çš„å°¾éƒ¨ã€‚</li><li>è¿›å…¥è‡ªæ—‹æˆ–é˜»å¡çŠ¶æ€ï¼ˆé€šå¸¸é€šè¿‡ <code>LockSupport.park()</code>ï¼‰ï¼Œç­‰å¾…å‰é©±èŠ‚ç‚¹é‡Šæ”¾é”åå”¤é†’ã€‚</li></ul></li></ol></li><li><strong>å…¬å¹³æ¨¡å¼ï¼š</strong><ol><li>æ£€æŸ¥ CLH é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰ç­‰å¾…æ—¶é—´æ¯”è‡ªå·±é•¿çš„çº¿ç¨‹ã€‚</li><li>å¦‚æœæœ‰ï¼Œåˆ™ç›´æ¥å°†è‡ªå·±åŠ å…¥é˜Ÿåˆ—å°¾éƒ¨æ’é˜Ÿã€‚</li><li>å¦‚æœæ²¡æœ‰ï¼Œæ‰å°è¯•é€šè¿‡ CAS è·å–é”ï¼ˆåç»­æ­¥éª¤ä¸éå…¬å¹³æ¨¡å¼å¤±è´¥åçš„æ­¥éª¤ç›¸åŒï¼‰ã€‚</li><li>å…¬å¹³æ¨¡å¼ä¿è¯äº†ä¸¥æ ¼æŒ‰ç…§çº¿ç¨‹è¯·æ±‚é”çš„é¡ºåºï¼ˆFIFOï¼‰æ¥æˆäºˆé”ï¼Œé¿å…äº†çº¿ç¨‹é¥¥é¥¿ï¼Œä½†é€šå¸¸ååé‡ä½äºéå…¬å¹³æ¨¡å¼ã€‚</li></ol></li></ul></li><li><strong>é‡Šæ”¾é” (unlock())ï¼š</strong><ol><li>æ£€æŸ¥å½“å‰çº¿ç¨‹æ˜¯å¦æ˜¯é”çš„æŒæœ‰è€…ï¼ˆé˜²æ­¢éæ³•é‡Šæ”¾ï¼‰ã€‚</li><li>å°† <code>state</code> å‡ 1ï¼ˆå¯¹äºé‡å…¥é”ï¼Œéœ€è¦é‡Šæ”¾å¤šæ¬¡ç›´åˆ° <code>state</code> ä¸º 0ï¼‰ã€‚</li><li>å¦‚æœ <code>state</code> å‡åˆ° 0ï¼š<ul><li>è®¾ç½® <code>exclusiveOwnerThread</code> ä¸º <code>null</code>ã€‚</li><li>å”¤é†’ CLH é˜Ÿåˆ—ä¸­ä¸‹ä¸€ä¸ªç­‰å¾…çš„çº¿ç¨‹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ã€‚</li></ul></li></ol></li><li><strong>å¯é‡å…¥æ€§ï¼š</strong><ul><li>é€šè¿‡ <code>state</code> å˜é‡è®°å½•é‡å…¥æ¬¡æ•°ã€‚æ¯æ¬¡æŒæœ‰é”çš„çº¿ç¨‹å†æ¬¡è·å–é”ï¼Œ<code>state</code> å°±åŠ  1ã€‚æ¯æ¬¡é‡Šæ”¾é”ï¼Œ<code>state</code> å°±å‡ 1ã€‚åªæœ‰å‡åˆ° 0 æ—¶ï¼Œé”æ‰çœŸæ­£è¢«é‡Šæ”¾ã€‚</li></ul></li></ol><h4 id="ReentrantLock-ä¸-synchronized-çš„åŒºåˆ«"><a href="#ReentrantLock-ä¸-synchronized-çš„åŒºåˆ«" class="headerlink" title="ReentrantLock ä¸ synchronized çš„åŒºåˆ«"></a><code>ReentrantLock</code> ä¸ <code>synchronized</code> çš„åŒºåˆ«</h4><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left"><code>ReentrantLock</code></th><th align="left"><code>synchronized</code></th></tr></thead><tbody><tr><td align="left"><strong>çµæ´»æ€§</strong></td><td align="left"><strong>é«˜</strong>ï¼šæ”¯æŒå°è¯•è·å–é”(<code>tryLock</code>)ã€è¶…æ—¶è·å–(<code>tryLock(time)</code>)ã€å¯ä¸­æ–­è·å–(<code>lockInterruptibly</code>)ã€å…¬å¹³é”</td><td align="left"><strong>ä½</strong>ï¼šè·å–é”åªæœ‰é˜»å¡ä¸€ç§æ–¹å¼ï¼Œä¸æ”¯æŒè¶…æ—¶å’Œå…¬å¹³æ€§æ§åˆ¶</td></tr><tr><td align="left"><strong>å…¬å¹³æ€§</strong></td><td align="left"><strong>å¯é…ç½®</strong>ï¼šæ„é€ å‡½æ•°å¯æŒ‡å®šå…¬å¹³é”(<code>true</code>)æˆ–éå…¬å¹³é”(<code>false</code>)</td><td align="left"><strong>ä»…éå…¬å¹³é”</strong></td></tr><tr><td align="left"><strong>ç­‰å¾…æ¡ä»¶</strong></td><td align="left"><strong>æ”¯æŒå¤šä¸ªæ¡ä»¶é˜Ÿåˆ—</strong>ï¼šä¸€ä¸ªé”å¯å…³è”å¤šä¸ª <code>Condition</code> å¯¹è±¡ï¼Œå®ç°æ›´ç²¾ç»†çš„çº¿ç¨‹ç­‰å¾…&#x2F;å”¤é†’</td><td align="left"><strong>ä»…ä¸€ä¸ªéšå¼æ¡ä»¶é˜Ÿåˆ—</strong>ï¼šæ¯ä¸ªå¯¹è±¡å…³è”ä¸€ä¸ªå†…ç½®é”ï¼Œåªæœ‰ä¸€ä¸ª <code>wait()</code>&#x2F;<code>notify()</code>&#x2F;<code>notifyAll()</code> é˜Ÿåˆ—</td></tr><tr><td align="left"><strong>ä¸­æ–­å“åº”</strong></td><td align="left"><strong>æ”¯æŒ</strong>ï¼š<code>lockInterruptibly()</code> æ–¹æ³•å…è®¸åœ¨ç­‰å¾…é”æ—¶å“åº”ä¸­æ–­</td><td align="left"><strong>ä¸æ”¯æŒ</strong>ï¼šåœ¨ç­‰å¾…å†…ç½®é” (<code>synchronized</code> å—) æ—¶ï¼Œçº¿ç¨‹æ— æ³•å“åº”ä¸­æ–­</td></tr></tbody></table><p><strong>æ€»ç»“ä¸é€‰æ‹©å»ºè®®</strong></p><ul><li><strong>ä¼˜å…ˆè€ƒè™‘ <code>synchronized</code>ï¼š</strong> åœ¨å¤§å¤šæ•°ä¸éœ€è¦ <code>ReentrantLock</code> é«˜çº§ç‰¹æ€§çš„åœºæ™¯ä¸‹ï¼Œä¼˜å…ˆä½¿ç”¨ <code>synchronized</code>ã€‚ç†ç”±ï¼š<ul><li>è¯­æ³•ç®€æ´æ¸…æ™°ï¼Œä¸æ˜“å‡ºé”™ï¼ˆè‡ªåŠ¨é‡Šæ”¾é”ï¼‰ã€‚</li><li>JVM æŒç»­ä¼˜åŒ–ï¼Œæ€§èƒ½ä¼˜å¼‚ä¸”ç¨³å®šã€‚</li><li>æ˜¯ Java è¯­è¨€çš„æ ¸å¿ƒç‰¹æ€§ï¼Œä»£ç å¯è¯»æ€§æ›´é«˜ï¼Œå¼€å‘è€…æ›´ç†Ÿæ‚‰ã€‚</li></ul></li><li><strong>è€ƒè™‘ä½¿ç”¨ <code>ReentrantLock</code>ï¼š</strong> å½“ä½ çš„éœ€æ±‚è¶…å‡ºäº† <code>synchronized</code> çš„èƒ½åŠ›èŒƒå›´æ—¶ï¼š<ul><li><strong>éœ€è¦å°è¯•è·å–é” (<code>tryLock</code>) æˆ–è¶…æ—¶è·å–é”ã€‚</strong></li><li><strong>éœ€è¦å¯ä¸­æ–­åœ°ç­‰å¾…ä¸€ä¸ªé” (<code>lockInterruptibly</code>)ã€‚</strong></li><li><strong>éœ€è¦å®ç°å…¬å¹³é”ç­–ç•¥ (é¿å…çº¿ç¨‹é¥¥é¥¿)ã€‚</strong></li><li><strong>éœ€è¦å¤šä¸ªç­‰å¾…&#x2F;é€šçŸ¥æ¡ä»¶ (<code>Condition</code>)ã€‚</strong></li><li><strong>éœ€è¦åœ¨åŒä¸€ä¸ªé”ä¸Šè·¨è¶Šå¤šä¸ªæ–¹æ³•è¿›è¡ŒåŠ é”å’Œè§£é”æ“ä½œï¼ˆè™½ç„¶ <code>synchronized</code> é€šè¿‡åµŒå¥—æˆ–æ–¹æ³•è°ƒç”¨ä¹Ÿèƒ½å®ç°ï¼Œä½† <code>ReentrantLock</code> çš„æ§åˆ¶ç²’åº¦æ›´çµæ´»ï¼‰ã€‚</strong></li></ul></li></ul><h3 id="ThreadLocal"><a href="#ThreadLocal" class="headerlink" title="ThreadLocal"></a><code>ThreadLocal</code></h3><p>ThreadLocal æ˜¯ Java ä¸­ä¸€ä¸ªç”¨äºå®ç°<strong>çº¿ç¨‹å±€éƒ¨å˜é‡</strong>çš„å·¥å…·ç±»ã€‚å®ƒä¸ºæ¯ä¸ªä½¿ç”¨è¯¥å˜é‡çš„çº¿ç¨‹æä¾›äº†ä¸€ä¸ªç‹¬ç«‹çš„å˜é‡å‰¯æœ¬ï¼Œä»è€Œå®ç°äº†çº¿ç¨‹é—´çš„æ•°æ®éš”ç¦»ã€‚</p><p><strong>æ ¸å¿ƒåŸç†ï¼š</strong></p><ol><li><p><strong>Thread ç±»ä¸­çš„ ThreadLocalMapï¼š</strong></p><ul><li><code>Thread</code> æœ‰ä¸€ä¸ªç±»å‹ä¸º <code>ThreadLocal.ThreadLocalMap</code>çš„ç§æœ‰æˆå‘˜å˜é‡ <code>threadLocals</code>ã€‚</li><li><code>ThreadLocalMap</code> æ˜¯ä¸€ä¸ªå®šåˆ¶çš„ã€ç±»ä¼¼ <code>HashMap</code> çš„ç»“æ„ï¼Œä¸“é—¨ç”¨äºå­˜å‚¨çº¿ç¨‹å±€éƒ¨å˜é‡ã€‚é”®æ˜¯ <code>ThreadLocal</code> ï¼Œå€¼æ˜¯è¯¥çº¿ç¨‹å¯¹åº”çš„å˜é‡å‰¯æœ¬ã€‚</li></ul></li><li><p><strong>ThreadLocal çš„æ“ä½œæœºåˆ¶ï¼š</strong></p><ul><li><p><strong><code>set(T value)</code>ï¼š</strong> å½“è°ƒç”¨ <code>threadLocal.set(value)</code> æ—¶ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(T value)</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="type">ThreadLocalMap</span> <span class="variable">map</span> <span class="operator">=</span> getMap(t);</span><br><span class="line">    <span class="keyword">if</span> (map != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// ç”¨å½“å‰ThreadLocalä½œä¸ºkeyå­˜å‚¨å€¼</span></span><br><span class="line">        map.set(<span class="built_in">this</span>, value);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        createMap(t, value); <span class="comment">// é¦–æ¬¡ä½¿ç”¨åˆ›å»ºMap</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong><code>get()</code>ï¼š</strong> å½“è°ƒç”¨ <code>threadLocal.get()</code> æ—¶ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> T <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> Thread.currentThread(); <span class="comment">// 1. è·å–å½“å‰çº¿ç¨‹</span></span><br><span class="line">    <span class="type">ThreadLocalMap</span> <span class="variable">map</span> <span class="operator">=</span> getMap(t);    <span class="comment">// 2. è·å–çº¿ç¨‹çš„ThreadLocalMap</span></span><br><span class="line">    <span class="keyword">if</span> (map != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 3. ç”¨å½“å‰ThreadLocalå®ä¾‹ä½œä¸ºkeyæŸ¥æ‰¾Entry</span></span><br><span class="line">        ThreadLocalMap.<span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> map.getEntry(<span class="built_in">this</span>);</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> (T)e.value; <span class="comment">// 4. è¿”å›æ‰¾åˆ°çš„å€¼</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> setInitialValue(); <span class="comment">// 5. æ‰¾ä¸åˆ°æ—¶åˆå§‹åŒ–</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong><code>remove()</code>ï¼š</strong> å½“è°ƒç”¨ <code>threadLocal.remove()</code> æ—¶ï¼š</p><ol><li>è·å–å½“å‰çº¿ç¨‹çš„ <code>threadLocals</code>ã€‚</li><li>å¦‚æœ <code>threadLocals</code> ä¸ä¸º <code>null</code>ï¼Œåˆ™ä»ä¸­ç§»é™¤ä»¥å½“å‰ <code>ThreadLocal</code> å®ä¾‹ä¸ºé”®çš„æ¡ç›®ã€‚</li></ol></li></ul></li><li><p><strong>å…³é”®ç‚¹ï¼š</strong></p><ul><li><p><strong>æ•°æ®å­˜å‚¨ä½ç½®ï¼š</strong> å˜é‡å‰¯æœ¬å®é™…å­˜å‚¨åœ¨<strong>çº¿ç¨‹å¯¹è±¡</strong>å†…éƒ¨çš„ <code>ThreadLocalMap</code> é‡Œï¼Œè€Œä¸æ˜¯å­˜å‚¨åœ¨ <code>ThreadLocal</code> å¯¹è±¡æœ¬èº«ã€‚<code>ThreadLocal</code> åªæ˜¯ä¸€ä¸ªè®¿é—®è¿™äº›å‰¯æœ¬çš„å·¥å…·å’Œé”®ã€‚</p></li><li><p><strong>é”®çš„å¼•ç”¨ï¼š</strong> <code>ThreadLocalMap</code> ä¸­çš„é”® (<code>ThreadLocal</code> å¯¹è±¡) æ˜¯<strong>å¼±å¼•ç”¨</strong>ã€‚è¿™æ˜¯ä¸ºäº†åœ¨ <code>ThreadLocal</code> å®ä¾‹æœ¬èº«ä¸å†è¢«å¼ºå¼•ç”¨æ—¶ï¼ˆæ¯”å¦‚è¢« GC å›æ”¶äº†ï¼‰ï¼Œ<code>ThreadLocalMap</code> ä¸­çš„é”®èƒ½è‡ªåŠ¨è¢« GC å›æ”¶ï¼Œé¿å…å†…å­˜æ³„æ¼ï¼ˆé”®éƒ¨åˆ†ï¼‰ã€‚</p></li><li><p><strong>å€¼çš„å¼•ç”¨ï¼š</strong> <code>ThreadLocalMap</code> ä¸­çš„å€¼æ˜¯<strong>å¼ºå¼•ç”¨</strong>ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå¦‚æœ <code>ThreadLocal</code> è¢«å›æ”¶äº†ï¼ˆé”®å˜ <code>null</code>ï¼‰ï¼Œä½†çº¿ç¨‹ï¼ˆå°¤å…¶æ˜¯çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ï¼‰é•¿æœŸå­˜æ´»ï¼Œä¸”æ²¡æœ‰è°ƒç”¨ <code>remove()</code> æ–¹æ³•ï¼Œé‚£ä¹ˆå€¼å¯¹è±¡ä¼šä¸€ç›´è¢« <code>ThreadLocalMap</code> çš„æ¡ç›®å¼ºå¼•ç”¨ç€ï¼Œå¯¼è‡´å€¼å¯¹è±¡æ— æ³•è¢«å›æ”¶ï¼Œé€ æˆ<strong>å†…å­˜æ³„æ¼</strong>ï¼ˆå€¼éƒ¨åˆ†ï¼‰ã€‚</p></li><li><p><strong>å†…å­˜æ³„æ¼é£é™©ï¼š</strong> è¿™æ˜¯ä½¿ç”¨ <code>ThreadLocal</code> æœ€å¤§çš„éšæ‚£ã€‚ä¸»è¦å‘ç”Ÿåœ¨ï¼š</p><ul><li>ä½¿ç”¨äº†<strong>çº¿ç¨‹æ± </strong>ï¼ˆçº¿ç¨‹å¤ç”¨ï¼Œç”Ÿå‘½å‘¨æœŸé•¿ï¼‰ã€‚</li><li>åœ¨ <code>ThreadLocal</code> ä¸­å­˜å‚¨äº†<strong>å¤§å¯¹è±¡</strong>ã€‚</li><li>åœ¨ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œ<strong>æ²¡æœ‰è°ƒç”¨ <code>threadLocal.remove()</code></strong> æ¥æ¸…ç†å½“å‰çº¿ç¨‹çš„å‰¯æœ¬ã€‚</li></ul><img src="/post/7992e236/image-20250807001016383.png" class="" title="image-20250807001016383"></li><li><p><strong>ç»§æ‰¿æ€§ï¼š</strong> <code>ThreadLocal</code> æœ¬èº«ä¸æ”¯æŒå˜é‡ä»çˆ¶çº¿ç¨‹ä¼ é€’ç»™å­çº¿ç¨‹ã€‚å¦‚æœéœ€è¦è¿™ç§èƒ½åŠ›ï¼Œå¯ä»¥ä½¿ç”¨ <code>InheritableThreadLocal</code>ã€‚</p></li></ul></li></ol><img src="/post/7992e236/image-20250725210437363.png" class="" title="image-20250725210437363"><p><strong>ç¤ºä¾‹1ï¼šå­˜å‚¨ç”¨æˆ·ä¿¡æ¯</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserContextHolder</span> &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªThreadLocalå˜é‡ï¼Œç”¨äºå­˜å‚¨ç”¨æˆ·IDã€‚é€šå¸¸å£°æ˜ä¸ºprivate static final</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;String&gt; currentUser = ThreadLocal.withInitial(() -&gt; <span class="literal">null</span>);</span><br><span class="line">    <span class="comment">// è®¾ç½®å½“å‰çº¿ç¨‹çš„ç”¨æˆ·ID</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setCurrentUser</span><span class="params">(String userId)</span> &#123;</span><br><span class="line">        currentUser.set(userId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰çº¿ç¨‹çš„ç”¨æˆ·ID</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getCurrentUser</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> currentUser.get();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ¸…é™¤å½“å‰çº¿ç¨‹çš„ç”¨æˆ·IDï¼ˆé‡è¦ï¼é¿å…å†…å­˜æ³„æ¼ï¼‰</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">clear</span><span class="params">()</span> &#123;</span><br><span class="line">        currentUser.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨æ‹¦æˆªå™¨æˆ–è¿‡æ»¤å™¨ä¸­è®¾ç½®å’Œæ¸…é™¤</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> &#123;</span><br><span class="line">        <span class="comment">// ä»è¯·æ±‚ä¸­è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆæ¯”å¦‚tokenè§£æï¼‰</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> ...; </span><br><span class="line">        UserContextHolder.setCurrentUser(userId);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> &#123;</span><br><span class="line">        <span class="comment">// è¯·æ±‚å¤„ç†å®Œæˆåï¼Œæ¸…é™¤ThreadLocalï¼Œé˜²æ­¢å†…å­˜æ³„æ¼</span></span><br><span class="line">        UserContextHolder.clear();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç¤ºä¾‹2ï¼šäº‹åŠ¡ç®¡ç†</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransactionContextHolder</span> &#123;</span><br><span class="line">    <span class="comment">// å­˜å‚¨å½“å‰çº¿ç¨‹çš„äº‹åŠ¡è¿æ¥</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Connection&gt; currentConnection = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title function_">getConnection</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> currentConnection.get();</span><br><span class="line">        <span class="keyword">if</span> (conn == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœæ²¡æœ‰ï¼Œåˆ™ä»è¿æ¥æ± è·å–ä¸€ä¸ªæ–°çš„è¿æ¥ï¼Œå¹¶è®¾ç½®åˆ°ThreadLocal</span></span><br><span class="line">            conn = DataSourceUtils.getConnection(); <span class="comment">// å‡è®¾çš„å·¥å…·ç±»</span></span><br><span class="line">            currentConnection.set(conn);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> conn;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">bindConnection</span><span class="params">(Connection conn)</span> &#123;</span><br><span class="line">        currentConnection.set(conn);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unbindConnection</span><span class="params">()</span> &#123;</span><br><span class="line">        currentConnection.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransactionManager</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">begin</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> TransactionContextHolder.getConnection();</span><br><span class="line">        conn.setAutoCommit(<span class="literal">false</span>); <span class="comment">// å¼€å¯äº‹åŠ¡</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">commit</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> TransactionContextHolder.getConnection();</span><br><span class="line">        conn.commit();</span><br><span class="line">        TransactionContextHolder.unbindConnection(); <span class="comment">// æäº¤åç§»é™¤è¿æ¥ï¼Œå¹¶é‡Šæ”¾åˆ°è¿æ¥æ± </span></span><br><span class="line">        DataSourceUtils.releaseConnection(conn); <span class="comment">// å‡è®¾çš„å·¥å…·ç±»ï¼Œå°†è¿æ¥å½’è¿˜è¿æ¥æ± </span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">rollback</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// ...ç±»ä¼¼commitï¼Œå›æ»šäº‹åŠ¡å¹¶æ¸…ç†</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="JUCé›†åˆ"><a href="#JUCé›†åˆ" class="headerlink" title="JUCé›†åˆ"></a>JUCé›†åˆ</h3><h4 id="ConcurrentHashMap-çš„å®ç°åŸç†"><a href="#ConcurrentHashMap-çš„å®ç°åŸç†" class="headerlink" title="ConcurrentHashMap çš„å®ç°åŸç†"></a><code>ConcurrentHashMap</code> çš„å®ç°åŸç†</h4><p>ConcurrentHashMap æ˜¯ Java å¹¶å‘ç¼–ç¨‹ä¸­è‡³å…³é‡è¦çš„æ•°æ®ç»“æ„ã€‚å®ƒåœ¨ Java 7 å’Œ Java 8 ä¸­ç»å†äº†é‡å¤§çš„é‡æ„ï¼Œæ ¸å¿ƒç›®æ ‡éƒ½æ˜¯æé«˜å¹¶å‘æ€§èƒ½ã€å‡å°‘ç«äº‰ã€ä¼˜åŒ–å†…å­˜å’Œè®¡ç®—å¼€é”€ã€‚ä»¥ä¸‹æ˜¯å®ƒä»¬çš„å®ç°å·®å¼‚å’Œ Java 8 çš„ä¼˜åŒ–ï¼š</p><p><strong>Java 7 å®ç° (åŸºäºåˆ†æ®µé” - Segment Locking)</strong></p><ol><li><strong>æ ¸å¿ƒç»“æ„ï¼š</strong><ul><li><strong>Segment æ•°ç»„ï¼š</strong> <code>ConcurrentHashMap</code> å†…éƒ¨ç»´æŠ¤ä¸€ä¸ªå›ºå®šå¤§å°çš„ <code>Segment</code> æ•°ç»„ï¼ˆé»˜è®¤ä¸º 16ï¼‰ã€‚æ¯ä¸ª <code>Segment</code> æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ã€çº¿ç¨‹å®‰å…¨çš„å“ˆå¸Œè¡¨ï¼ˆç±»ä¼¼äºä¸€ä¸ªå°çš„ <code>ReentrantReadWriteLock</code> æˆ– <code>ReentrantLock</code> ä¿æŠ¤çš„ <code>HashMap</code>ï¼‰ã€‚</li><li><strong>Segment ç»§æ‰¿ ReentrantLockï¼š</strong> æ¯ä¸ª <code>Segment</code> ç±»ç»§æ‰¿è‡ª <code>ReentrantLock</code>ï¼Œè¿™æ„å‘³ç€æ¯ä¸ªæ®µæ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„é”ã€‚</li><li><strong>HashEntry æ•°ç»„ï¼š</strong> æ¯ä¸ª <code>Segment</code> å†…éƒ¨ç»´æŠ¤ä¸€ä¸ª <code>HashEntry</code> æ•°ç»„ï¼ˆæ¡¶æ•°ç»„ï¼‰ã€‚<code>HashEntry</code> æ˜¯é“¾è¡¨èŠ‚ç‚¹ï¼ŒåŒ…å« <code>final</code> çš„ <code>key</code>ã€<code>hash</code>ã€<code>volatile</code> çš„ <code>value</code> å’ŒæŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„ <code>next</code> æŒ‡é’ˆã€‚<code>value</code> çš„ <code>volatile</code> ä¿è¯äº†å¯è§æ€§ã€‚</li><li><strong>é”ç²’åº¦ï¼š</strong> é”çš„ç²’åº¦æ˜¯ <strong>æ®µï¼ˆSegmentï¼‰</strong>ã€‚å¯¹åŒä¸€ä¸ªæ®µçš„ä¿®æ”¹æ“ä½œï¼ˆå¦‚ <code>put</code>, <code>remove</code>ï¼‰éœ€è¦è·å–è¯¥æ®µçš„é”ã€‚ä¸åŒæ®µä¸Šçš„æ“ä½œå¯ä»¥å¹¶å‘æ‰§è¡Œã€‚</li></ul></li><li><strong>å…³é”®æ“ä½œåŸç†ï¼š</strong><ul><li><strong><code>put(key, value)</code>ï¼š</strong><ol><li>æ ¹æ® <code>key</code> çš„ <code>hash</code> è®¡ç®—å®ƒå±äºå“ªä¸ª <code>Segment</code> (é€šå¸¸ç”¨é«˜ä½å“ˆå¸Œä½)ã€‚</li><li>è·å–è¯¥ <code>Segment</code> çš„é”ã€‚</li><li>åœ¨ <code>Segment</code> å†…éƒ¨çš„ <code>HashEntry</code> æ•°ç»„ä¸­æ‰¾åˆ°å¯¹åº”çš„æ¡¶ï¼ˆé“¾è¡¨å¤´ï¼‰ã€‚</li><li>éå†é“¾è¡¨æŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨ç›¸åŒ <code>key</code>ï¼š<ul><li>å­˜åœ¨ï¼šæ›´æ–° <code>value</code> (åˆ©ç”¨ <code>volatile</code> å†™)ã€‚</li><li>ä¸å­˜åœ¨ï¼šå°†æ–° <code>HashEntry</code> èŠ‚ç‚¹æ’å…¥é“¾è¡¨å¤´éƒ¨ã€‚</li></ul></li><li>é‡Šæ”¾ <code>Segment</code> çš„é”ã€‚</li></ol></li><li><strong><code>get(key)</code>ï¼š</strong><ol><li>æ ¹æ® <code>key</code> çš„ <code>hash</code> è®¡ç®—å®ƒå±äºå“ªä¸ª <code>Segment</code>ã€‚</li><li><strong>ä¸éœ€è¦è·å–é”ï¼</strong></li><li>æ ¹æ® <code>hash</code> å®šä½åˆ°è¯¥ <code>Segment</code> å†…éƒ¨ <code>HashEntry</code> æ•°ç»„ä¸­çš„æ¡¶ã€‚</li><li>éå†é“¾è¡¨ï¼ˆ<code>HashEntry.next</code>ï¼‰æŸ¥æ‰¾åŒ¹é…çš„ <code>key</code>ã€‚</li><li>ä¾èµ– <code>HashEntry.value</code> çš„ <code>volatile</code> è¯»ä¿è¯çœ‹åˆ°æœ€æ–°å€¼ã€‚</li></ol></li><li><strong><code>size()</code>ï¼š</strong><ul><li>å®ç°ç›¸å¯¹ä½æ•ˆã€‚å°è¯•ä¸åŠ é”åœ°éå†æ‰€æœ‰ <code>Segment</code>ï¼Œç´¯åŠ å„ <code>Segment</code> çš„ <code>modCount</code> (ä¿®æ”¹è®¡æ•°å™¨) å’Œ <code>count</code> (å…ƒç´ æ•°é‡)ã€‚</li><li>å¦‚æœè¿ç»­ä¸¤æ¬¡ç´¯åŠ è¿‡ç¨‹ä¸­å‘ç°æ€»çš„ <code>modCount</code> æ²¡æœ‰å˜åŒ–ï¼Œè¯´æ˜æ²¡æœ‰å‘ç”Ÿå¹¶å‘ä¿®æ”¹ï¼Œè¿”å›ç´¯åŠ çš„ <code>size</code>ã€‚</li><li>å¦‚æœå¤šæ¬¡å°è¯•å <code>modCount</code> æ€»åœ¨å˜åŒ–ï¼ˆé«˜å¹¶å‘ï¼‰ï¼Œåˆ™æœ€ç»ˆä¼š<strong>å¼ºåˆ¶é”ä½æ‰€æœ‰ <code>Segment</code></strong> å†è¿›è¡Œç»Ÿè®¡ï¼Œæ€§èƒ½å¼€é”€å¾ˆå¤§ã€‚</li></ul></li><li><strong>æ‰©å®¹ (Rehashing)ï¼š</strong><ul><li>å‘ç”Ÿåœ¨ <code>Segment</code> å†…éƒ¨ã€‚å½“æŸä¸ª <code>Segment</code> çš„å…ƒç´ æ•°é‡è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œä»…å¯¹è¯¥ <code>Segment</code> å†…éƒ¨çš„ <code>HashEntry</code> æ•°ç»„è¿›è¡Œæ‰©å®¹ï¼ˆé€šå¸¸ç¿»å€ï¼‰ï¼Œå¹¶é‡æ–°åˆ†é…é“¾è¡¨å…ƒç´ ã€‚æ‰©å®¹æ—¶éœ€è¦æŒæœ‰è¯¥ <code>Segment</code> çš„é”ã€‚</li></ul></li></ul></li><li><strong>Java 7 å®ç°çš„ä¼˜ç¼ºç‚¹ï¼š</strong><ul><li><strong>ä¼˜ç‚¹ï¼š</strong> ç›¸æ¯”é”ä½æ•´ä¸ª <code>HashMap</code>ï¼Œåˆ†æ®µé”æ˜¾è‘—æé«˜äº†å¹¶å‘åº¦ï¼ˆæœ€å¤šå…è®¸ç­‰äº <code>Segment</code> æ•°é‡çš„çº¿ç¨‹å¹¶å‘å†™ï¼‰ã€‚è¯»æ“ä½œå®Œå…¨æ— é”ï¼Œéå¸¸å¿«ã€‚</li><li><strong>ç¼ºç‚¹ï¼š</strong><ul><li><strong>é”ç²’åº¦ä¸å¤Ÿç»†ï¼š</strong> å¦‚æœå¤§é‡å†™æ“ä½œæ°å¥½è½åœ¨åŒä¸€ä¸ª <code>Segment</code> ä¸Šï¼Œè¯¥æ®µä¼šæˆä¸ºç“¶é¢ˆã€‚<code>Segment</code> æ•°é‡åœ¨åˆ›å»ºåå›ºå®šï¼Œæ— æ³•åŠ¨æ€è°ƒæ•´ã€‚</li><li><strong><code>size()</code> å’Œ <code>containsValue()</code> ä½æ•ˆï¼š</strong> ç»Ÿè®¡å…¨è¡¨æˆ–å…¨å€¼æ“ä½œå¯èƒ½éœ€è¦å…¨å±€é”ï¼Œå¼€é”€å¤§ã€‚</li><li><strong>å†…å­˜å¼€é”€ï¼š</strong> <code>Segment</code> æ•°ç»„æœ¬èº«å’Œæ¯ä¸ª <code>Segment</code> çš„ç»“æ„ï¼ˆé”ã€è®¡æ•°ç­‰ï¼‰å¸¦æ¥é¢å¤–å†…å­˜æ¶ˆè€—ã€‚</li><li><strong>é“¾è¡¨æŸ¥è¯¢æ•ˆç‡ï¼š</strong> å†²çªä¸¥é‡æ—¶ï¼Œé•¿é“¾è¡¨éå†å½±å“ <code>get</code> æ€§èƒ½ã€‚</li></ul></li></ul></li></ol><p><strong>Java 8 å®ç° (åŸºäº CAS + <code>synchronized</code> + çº¢é»‘æ ‘)</strong></p><p>Java 8 å¯¹ <code>ConcurrentHashMap</code> è¿›è¡Œäº†å½»åº•é‡æ„ï¼Œæ‘’å¼ƒäº†åˆ†æ®µé”æ¨¡å‹ï¼Œé‡‡ç”¨äº†æ›´ç»†ç²’åº¦çš„é”å’Œç°ä»£å¹¶å‘æŠ€æœ¯ã€‚</p><ol><li><p><strong>æ ¸å¿ƒç»“æ„ï¼š</strong></p><ul><li><strong>Node æ•°ç»„ (Table)ï¼š</strong> åªæœ‰ä¸€ä¸ª <code>volatile Node[] table</code>ã€‚<code>Node</code> æ˜¯é“¾è¡¨èŠ‚ç‚¹æˆ–æ ‘èŠ‚ç‚¹ï¼ˆ<code>TreeNode</code>ï¼‰çš„åŸºç¡€ç±»ï¼ŒåŒ…å« <code>final</code> çš„ <code>key</code> å’Œ <code>hash</code>ï¼Œ<code>volatile</code> çš„ <code>value</code> å’Œ <code>volatile</code> çš„ <code>next</code> æŒ‡é’ˆï¼ˆç”¨äºé“¾è¡¨ï¼‰ã€‚</li><li><strong>é“¾è¡¨è½¬çº¢é»‘æ ‘ï¼š</strong> å½“å•ä¸ªæ¡¶ï¼ˆé“¾è¡¨ï¼‰ä¸­çš„å…ƒç´ æ•°é‡è¶…è¿‡é˜ˆå€¼ï¼ˆé»˜è®¤ä¸º 8ï¼‰<strong>ä¸”</strong> å½“å‰ <code>table</code> çš„é•¿åº¦å¤§äºç­‰äºæœ€å°æ ‘åŒ–å®¹é‡ï¼ˆ<code>MIN_TREEIFY_CAPACITY</code>ï¼Œé»˜è®¤ä¸º 64ï¼‰æ—¶ï¼Œè¯¥é“¾è¡¨ä¼šè¢«è½¬æ¢ä¸º <strong><code>TreeNode</code></strong> ç»„æˆçš„çº¢é»‘æ ‘ã€‚è¿™å¤§å¤§æé«˜äº†é«˜å†²çªæ¡¶çš„æŸ¥è¯¢æ•ˆç‡ï¼ˆO(n) -&gt; O(log n)ï¼‰ã€‚</li><li><strong>é”ç²’åº¦ï¼š</strong> é”çš„ç²’åº¦ç»†åŒ–åˆ° <strong>å•ä¸ªæ¡¶ï¼ˆæ¡¶çš„å¤´èŠ‚ç‚¹ï¼‰</strong>ã€‚ä½¿ç”¨ <code>synchronized</code> å—é”å®šæ¡¶çš„å¤´èŠ‚ç‚¹ã€‚</li><li><strong>CAS (Compare-And-Swap)ï¼š</strong> å¤§é‡ä½¿ç”¨ CAS æ“ä½œè¿›è¡Œæ— é”åŒ–çš„çŠ¶æ€æ›´æ–°ï¼ˆå¦‚ <code>tabAt</code>, <code>casTabAt</code> è®¿é—®å’Œä¿®æ”¹ <code>table</code> æ•°ç»„å…ƒç´ ï¼›<code>setTabAt</code> ä¿è¯ <code>volatile</code> å†™ï¼‰ï¼Œä»¥åŠ <code>sizeCtl</code> ç­‰æ§åˆ¶å˜é‡çš„æ›´æ–°ã€‚</li><li><strong>ForwardingNodeï¼š</strong> ä¸€ä¸ªç‰¹æ®Šçš„ <code>Node</code> å­ç±»ï¼Œåœ¨æ‰©å®¹ï¼ˆ<code>resize</code>ï¼‰è¿‡ç¨‹ä¸­ä½¿ç”¨ã€‚å½“æ¡¶è¢«è¿ç§»å®Œæ¯•ï¼Œä¼šæ”¾ç½®ä¸€ä¸ª <code>ForwardingNode</code> ä½œä¸ºæ ‡è®°ï¼Œå¹¶æŒ‡å‘æ–°è¡¨ã€‚å…¶ä»–çº¿ç¨‹é‡åˆ°è¿™ä¸ªèŠ‚ç‚¹æ—¶ï¼ŒçŸ¥é“æ­£åœ¨æ‰©å®¹ï¼Œä¼šååŠ©æ‰©å®¹æˆ–åœ¨æ–°è¡¨ä¸­æŸ¥æ‰¾ã€‚</li><li><strong>CounterCellï¼š</strong> ç”¨äºé«˜æ•ˆã€æ— ç«äº‰åœ°ç»Ÿè®¡å…ƒç´ æ€»æ•° (<code>size()</code>)ï¼Œé¿å…å…¨å±€é”ã€‚åŸºäºç±»ä¼¼ <code>LongAdder</code> çš„æ€æƒ³ã€‚</li></ul></li><li><p><strong>å…³é”®æ“ä½œåŸç† (ä½“ç°ä¼˜åŒ–)ï¼š</strong></p><ul><li><strong><code>put(key, value)</code>ï¼š</strong><ol><li>è®¡ç®— <code>key</code> çš„ <code>hash</code> (ä¼˜åŒ–äº†æ‰°åŠ¨å‡½æ•°)ã€‚</li><li>å¦‚æœ <code>table</code> æœªåˆå§‹åŒ–ï¼Œåˆ™åˆå§‹åŒ–ï¼ˆä½¿ç”¨ <code>sizeCtl</code> å’Œ CAS æ§åˆ¶å¹¶å‘åˆå§‹åŒ–ï¼‰ã€‚</li><li>æ ¹æ® <code>hash</code> å®šä½åˆ° <code>table</code> ä¸­çš„æ¡¶ <code>i</code>ã€‚</li><li><strong>æ— é”å°è¯• (CAS)ï¼š</strong> å¦‚æœæ¡¶ <code>i</code> ä¸ºç©º (<code>null</code>)ï¼Œå°è¯•ç”¨ CAS å°†æ–°èŠ‚ç‚¹æ”¾å…¥æ¡¶ <code>i</code>ã€‚æˆåŠŸåˆ™ç»“æŸã€‚</li><li><strong>ç‰¹æ®ŠçŠ¶æ€å¤„ç†ï¼š</strong> å¦‚æœæ¡¶ <code>i</code> çš„å¤´èŠ‚ç‚¹æ˜¯ <code>ForwardingNode</code>ï¼Œè¡¨ç¤ºæ­£åœ¨æ‰©å®¹ï¼Œå½“å‰çº¿ç¨‹ä¼š<strong>ååŠ©æ‰©å®¹</strong> (<code>helpTransfer</code>)ã€‚</li><li><strong>é”å®šå¤´èŠ‚ç‚¹ (<code>synchronized</code>)ï¼š</strong> å¦‚æœæ¡¶ <code>i</code> ä¸ä¸ºç©ºä¸”ä¸æ˜¯ <code>ForwardingNode</code>ï¼Œåˆ™ä½¿ç”¨ <code>synchronized</code> <strong>é”å®šè¯¥æ¡¶çš„å¤´èŠ‚ç‚¹</strong>ã€‚<ul><li>å¦‚æœå¤´èŠ‚ç‚¹æ˜¯é“¾è¡¨èŠ‚ç‚¹ï¼šéå†é“¾è¡¨æŸ¥æ‰¾ <code>key</code>ï¼Œå­˜åœ¨åˆ™æ›´æ–° <code>value</code>ï¼›ä¸å­˜åœ¨åˆ™æ·»åŠ åˆ°é“¾è¡¨å°¾éƒ¨ï¼ˆJava 8 æ”¹ä¸ºå°¾æ’æ³•ï¼Œé¿å…æ­»å¾ªç¯éšæ‚£ï¼‰ã€‚</li><li>å¦‚æœå¤´èŠ‚ç‚¹æ˜¯æ ‘èŠ‚ç‚¹ (<code>TreeNode</code>)ï¼šè°ƒç”¨çº¢é»‘æ ‘çš„æ’å…¥æ–¹æ³•ã€‚</li></ul></li><li>æ£€æŸ¥æ˜¯å¦éœ€è¦æ ‘åŒ–ï¼ˆé“¾è¡¨é•¿åº¦ &gt;&#x3D; 8ï¼‰æˆ–è§£æ ‘åŒ–ï¼ˆæ ‘èŠ‚ç‚¹æ•° &lt;&#x3D; 6ï¼‰ã€‚</li><li>é‡Šæ”¾ <code>synchronized</code> é”ã€‚</li><li>æ£€æŸ¥æ˜¯å¦éœ€è¦æ‰©å®¹ï¼ˆå…ƒç´ æ€»æ•°è¶…è¿‡é˜ˆå€¼ï¼‰ã€‚</li></ol></li><li><strong><code>get(key)</code>ï¼š</strong><ol><li>è®¡ç®— <code>key</code> çš„ <code>hash</code>ã€‚</li><li>æ ¹æ® <code>hash</code> å®šä½åˆ° <code>table</code> ä¸­çš„æ¡¶ã€‚</li><li><strong>å®Œå…¨æ— é”ï¼</strong></li><li>å¦‚æœæ¡¶çš„å¤´èŠ‚ç‚¹å°±æ˜¯åŒ¹é…é¡¹ï¼Œç›´æ¥è¿”å›ã€‚</li><li>å¦‚æœå¤´èŠ‚ç‚¹ <code>hash &lt; 0</code>ï¼Œè¯´æ˜æ˜¯ç‰¹æ®ŠèŠ‚ç‚¹ï¼š<ul><li>å¦‚æœæ˜¯ <code>ForwardingNode</code>ï¼Œåˆ™å»æ–°è¡¨ <code>nextTable</code> ä¸­æŸ¥æ‰¾ã€‚</li><li>å¦‚æœæ˜¯ <code>TreeBin</code> (çº¢é»‘æ ‘çš„åŒ…è£…èŠ‚ç‚¹ï¼Œ<code>hash</code> å›ºå®šä¸º <code>-2</code>)ï¼Œåˆ™è°ƒç”¨æ ‘èŠ‚ç‚¹çš„ <code>find</code> æ–¹æ³•æŸ¥æ‰¾ã€‚</li></ul></li><li>å¦åˆ™ï¼Œéå†é“¾è¡¨æŸ¥æ‰¾ã€‚</li><li>ä¾èµ– <code>Node.value</code> çš„ <code>volatile</code> è¯»ä¿è¯å¯è§æ€§ã€‚</li></ol></li><li><strong><code>size()</code>ï¼š</strong><ul><li><strong>ä¸å†éœ€è¦å…¨å±€é”ï¼</strong></li><li>å°è¯•ç›´æ¥è¯»å– <code>baseCount</code>ï¼ˆä¸€ä¸ªåŸºç¡€è®¡æ•°å™¨ï¼Œé€šè¿‡ CAS æ›´æ–°ï¼‰ã€‚</li><li>å¦‚æœå­˜åœ¨å¹¶å‘ç«äº‰ï¼ˆ<code>CounterCell</code> æ•°ç»„ä¸ä¸ºç©ºï¼‰ï¼Œåˆ™ç´¯åŠ  <code>baseCount</code> å’Œæ‰€æœ‰ <code>CounterCell</code> ä¸­çš„å€¼ã€‚<code>CounterCell</code> é€šè¿‡ <code>@sun.misc.Contended</code> é¿å…ä¼ªå…±äº«ã€‚</li><li>ç»“æœæ˜¯ä¸€ä¸ª<strong>ä¼°è®¡å€¼</strong>ï¼ˆ<code>sumCount()</code>ï¼‰ï¼Œå› ä¸ºåœ¨ç´¯åŠ è¿‡ç¨‹ä¸­å¯èƒ½æœ‰çº¿ç¨‹åœ¨æ›´æ–°ã€‚ä½†å¯¹äºå¤§å¤šæ•°å¹¶å‘åœºæ™¯ï¼Œè¿™ä¸ªä¼°è®¡å€¼è¶³å¤Ÿç²¾ç¡®ä¸”å¼€é”€æä½ã€‚</li></ul></li><li><strong>æ‰©å®¹ (Transfer)ï¼š</strong><ul><li><strong>å¤šçº¿ç¨‹ååŒæ‰©å®¹ï¼š</strong> è¿™æ˜¯ Java 8 <code>ConcurrentHashMap</code> æœ€ç²¾å¦™çš„ä¼˜åŒ–ä¹‹ä¸€ã€‚</li><li>å½“éœ€è¦æ‰©å®¹æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ–°è¡¨ <code>nextTable</code>ï¼ˆé€šå¸¸æ˜¯åŸè¡¨çš„ä¸¤å€ï¼‰ã€‚</li><li>ä¸æ˜¯ç”±ä¸€ä¸ªçº¿ç¨‹å®Œæˆæ‰€æœ‰è¿ç§»ï¼Œè€Œæ˜¯å°†è¿ç§»ä»»åŠ¡åˆ’åˆ†ä¸ºå¤šä¸ª**å°æ®µ (stride)**ã€‚</li><li>ç¬¬ä¸€ä¸ªè§¦å‘æ‰©å®¹çš„çº¿ç¨‹åˆå§‹åŒ–è¿ç§»å¹¶è®¾ç½® <code>transferIndex</code> æŒ‡å‘è¿ç§»èŒƒå›´çš„æœ«å°¾ã€‚</li><li>åç»­è¿›è¡Œå†™æ“ä½œçš„çº¿ç¨‹ï¼ˆ<code>put</code>, <code>remove</code>ï¼‰å¦‚æœå‘ç°æ­£åœ¨æ‰©å®¹ï¼ˆé‡åˆ° <code>ForwardingNode</code>ï¼‰ï¼Œä¼š<strong>ä¸»åŠ¨ååŠ©è¿ç§»</strong>ä¸€éƒ¨åˆ†æ¡¶ï¼ˆé¢†å–ä¸€æ®µ <code>stride</code> çš„ä»»åŠ¡ï¼‰ï¼Œç„¶åå†æ‰§è¡Œè‡ªå·±çš„æ“ä½œã€‚<code>get</code> æˆ–åªè¯»æ“ä½œä¸ä¼šååŠ©ã€‚</li><li>ä½¿ç”¨ <code>ForwardingNode</code> æ ‡è®°å·²è¿ç§»çš„æ¡¶ï¼Œå¼•å¯¼æŸ¥æ‰¾æ“ä½œåˆ°æ–°è¡¨ã€‚</li><li>è¿ç§»å®Œæˆä¸€ä¸ªæ¡¶åï¼Œç”¨ <code>ForwardingNode</code> æ›¿æ¢åŸæ¡¶ä¸­çš„èŠ‚ç‚¹ã€‚</li><li>æ‰€æœ‰æ¡¶è¿ç§»å®Œæˆåï¼Œç”¨ <code>nextTable</code> æ›¿æ¢ <code>table</code>ã€‚</li></ul></li></ul></li><li><p><strong>Java 8 çš„ä¸»è¦ä¼˜åŒ–æ€»ç»“ï¼š</strong></p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">Java 7</th><th align="left">Java 8</th><th align="left">ä¼˜åŒ–ç‚¹</th></tr></thead><tbody><tr><td align="left"><strong>é”æœºåˆ¶</strong></td><td align="left">åˆ†æ®µé” (<code>Segment</code>, ç»§æ‰¿ <code>ReentrantLock</code>)</td><td align="left"><strong>æ¡¶çº§åˆ«é” (<code>synchronized</code>)</strong> + <strong>CAS</strong></td><td align="left"><strong>é”ç²’åº¦æ›´ç»†</strong> (æ¡¶ vs æ®µ)ï¼Œ<strong>CAS æ— é”åŒ–</strong>åˆå§‹åŒ–ã€è®¡æ•°ç­‰ï¼Œ**<code>synchronized</code> åœ¨ JVM å±‚é¢æŒç»­ä¼˜åŒ–**</td></tr><tr><td align="left"><strong>æ•°æ®ç»“æ„</strong></td><td align="left"><strong>æ•°ç»„ + é“¾è¡¨</strong> (ä»… <code>HashEntry</code>)</td><td align="left"><strong>æ•°ç»„ + é“¾è¡¨ + çº¢é»‘æ ‘</strong> (<code>Node</code> &#x2F; <code>TreeNode</code>)</td><td align="left"><strong>æ ‘åŒ–å¤§å¹…æå‡é«˜å†²çªæ¡¶çš„æŸ¥è¯¢æ•ˆç‡</strong> (O(n) -&gt; O(log n))</td></tr><tr><td align="left"><strong><code>size()</code></strong></td><td align="left">å¯èƒ½é”å…¨è¡¨ï¼Œä½æ•ˆ</td><td align="left"><strong>æ— é” (<code>baseCount</code> + <code>CounterCell</code>)</strong>, <strong>é«˜å¹¶å‘ä¸‹é«˜æ€§èƒ½ã€è¿‘ä¼¼å€¼</strong></td><td align="left"><strong>é¿å…å…¨å±€é”ï¼ŒåŸºäºåˆ†ç‰‡è®¡æ•°</strong>ï¼Œè¯»æ€§èƒ½æå¤§æå‡</td></tr><tr><td align="left"><strong>æ‰©å®¹</strong></td><td align="left">æ®µå†…æ‰©å®¹ï¼Œç‹¬ç«‹è¿›è¡Œ</td><td align="left"><strong>å¤šçº¿ç¨‹ååŒæ‰©å®¹ (ååŠ©è¿ç§»)</strong></td><td align="left"><strong>åˆ©ç”¨å¹¶å‘åŠ é€Ÿæ‰©å®¹</strong>ï¼Œå‡å°‘æ‰©å®¹å¸¦æ¥çš„åœé¡¿</td></tr><tr><td align="left"><strong>å†…å­˜å¼€é”€</strong></td><td align="left">è¾ƒé«˜ (<code>Segment</code> æ•°ç»„åŠç»“æ„)</td><td align="left"><strong>æ›´ä½</strong> (å•ä¸€ <code>Node</code> æ•°ç»„ï¼Œæ ‘èŠ‚ç‚¹ä»…åœ¨éœ€è¦æ—¶åˆ›å»º)</td><td align="left">ç»“æ„æ›´ç²¾ç®€</td></tr><tr><td align="left"><strong>è¯»æ“ä½œ</strong></td><td align="left">æ— é” (<code>volatile</code> value)</td><td align="left"><strong>å®Œå…¨æ— é”</strong> (åˆ©ç”¨ <code>volatile</code> å’Œç‰¹æ®ŠèŠ‚ç‚¹ <code>find</code> æ–¹æ³•)</td><td align="left">è¯»æ€§èƒ½æé«˜ä¸”ç¨³å®š</td></tr><tr><td align="left"><strong>å“ˆå¸Œè®¡ç®—</strong></td><td align="left">å¤šæ¬¡å“ˆå¸Œ</td><td align="left"><strong>ä¼˜åŒ–æ‰°åŠ¨å‡½æ•° (ç®€åŒ–ä¸€æ¬¡ä½è¿ç®—)</strong></td><td align="left">è®¡ç®—å¼€é”€ç•¥é™</td></tr><tr><td align="left"><strong><code>ForwardingNode</code></strong></td><td align="left">æ— </td><td align="left"><strong>æœ‰</strong>ï¼Œç”¨äºæ ‡è®°è¿ç§»çŠ¶æ€å’Œå¼•å¯¼æŸ¥æ‰¾</td><td align="left"><strong>å®ç°æ— é”è¯»å’ŒååŠ©æ‰©å®¹çš„å…³é”®</strong></td></tr><tr><td align="left"><strong><code>CounterCell</code></strong></td><td align="left">æ— </td><td align="left"><strong>æœ‰</strong>ï¼Œç”¨äºåˆ†ç‰‡è®¡æ•°</td><td align="left"><strong>å®ç°é«˜æ•ˆæ— é” <code>size()</code> çš„æ ¸å¿ƒ</strong></td></tr></tbody></table></li></ol><p><strong>æ ¸å¿ƒä¼˜åŒ–æ€æƒ³ï¼š</strong></p><ol><li><strong>æ›´ç»†ç²’åº¦çš„é”ï¼š</strong> ä»æ®µé”åˆ°æ¡¶é”ï¼Œæ˜¾è‘—å‡å°‘é”ç«äº‰ã€‚</li><li><strong>æ— é”åŒ–ï¼š</strong> å¹¿æ³›ä½¿ç”¨ CAS è¿›è¡Œè½»é‡çº§çŠ¶æ€æ›´æ–°ï¼ˆåˆå§‹åŒ–ã€è®¡æ•°ï¼‰ï¼Œè¯»æ“ä½œå®Œå…¨æ— é”ã€‚</li><li><strong>æ•°æ®ç»“æ„å‡çº§ï¼š</strong> å¼•å…¥çº¢é»‘æ ‘è§£å†³å“ˆå¸Œå†²çªæ¶åŒ–å¯¼è‡´çš„æ€§èƒ½é—®é¢˜ã€‚</li><li><strong>æ“ä½œå¹¶è¡ŒåŒ–ï¼š</strong> å¤šçº¿ç¨‹ååŒæ‰©å®¹ï¼Œå°†æ‰©å®¹å‹åŠ›åˆ†æ‘Šï¼Œæå¤§ç¼©çŸ­æ‰©å®¹æ—¶é—´ã€‚</li><li><strong>åˆ†ç¦»è®¡æ•°ï¼š</strong> ä½¿ç”¨ <code>CounterCell</code> åˆ†ç‰‡è®¡æ•°æ¶ˆé™¤ <code>size()</code> çš„ç“¶é¢ˆã€‚</li><li><strong>åˆ©ç”¨ç°ä»£ JVM ä¼˜åŒ–ï¼š</strong> ä¾èµ– JVM å¯¹ <code>synchronized</code> çš„æŒç»­ä¼˜åŒ–ï¼ˆåå‘é”ã€è½»é‡çº§é”ã€é”æ¶ˆé™¤ã€é”è†¨èƒ€ï¼‰ï¼Œä½¿å…¶åœ¨ä½ç«äº‰åœºæ™¯ä¸‹æ€§èƒ½æ¥è¿‘ CASã€‚</li></ol><p><strong>ç»“è®ºï¼š</strong></p><p>Java 8 çš„ <code>ConcurrentHashMap</code> å®ç°æ˜¯ä¸€æ¬¡å·¨å¤§çš„é£è·ƒã€‚å®ƒé€šè¿‡é‡‡ç”¨æ¡¶çº§åˆ« <code>synchronized</code>ã€CASã€çº¢é»‘æ ‘ã€å¤šçº¿ç¨‹ååŒæ‰©å®¹ã€åˆ†ç‰‡è®¡æ•° (<code>CounterCell</code>) å’Œ <code>ForwardingNode</code> ç­‰å…³é”®æŠ€æœ¯ï¼Œåœ¨é”ç²’åº¦ã€å¹¶å‘åº¦ã€æŸ¥è¯¢æ•ˆç‡ï¼ˆå°¤å…¶æ˜¯é«˜å†²çªæ—¶ï¼‰ã€æ‰©å®¹é€Ÿåº¦ã€<code>size()</code> è®¡ç®—æ•ˆç‡å’Œå†…å­˜å¼€é”€ç­‰æ–¹é¢éƒ½å¸¦æ¥äº†æ˜¾è‘—çš„ä¼˜åŒ–ã€‚å®ƒæ›´å¥½åœ°é€‚åº”äº†ç°ä»£å¤šæ ¸å¤„ç†å™¨å’Œé«˜å¹¶å‘åœºæ™¯çš„éœ€æ±‚ï¼Œæ˜¯ Java å¹¶å‘å®¹å™¨åº“ä¸­çš„å…¸èŒƒä¹‹ä½œã€‚Java 7 çš„åˆ†æ®µé”å®ç°åœ¨å½“æ—¶æ˜¯å·¨å¤§çš„è¿›æ­¥ï¼Œä½†å·²è¢«æ›´å…ˆè¿›çš„è®¾è®¡æ‰€å–ä»£ã€‚</p><h4 id="ä¸ºä»€ä¹ˆ-ConcurrentHashMap-æ¯”-Hashtable-æ•ˆç‡é«˜"><a href="#ä¸ºä»€ä¹ˆ-ConcurrentHashMap-æ¯”-Hashtable-æ•ˆç‡é«˜" class="headerlink" title="ä¸ºä»€ä¹ˆ ConcurrentHashMap æ¯” Hashtable æ•ˆç‡é«˜"></a><strong>ä¸ºä»€ä¹ˆ <code>ConcurrentHashMap</code> æ¯” <code>Hashtable</code> æ•ˆç‡é«˜</strong></h4><ul><li><strong>é”ç²’åº¦</strong>ï¼š<ul><li><code>Hashtable</code>ï¼š<strong>å…¨å±€é”</strong>ã€‚é”ä½æ•´ä¸ªè¡¨ï¼Œä¸€æ¬¡åªå…è®¸ä¸€ä¸ªçº¿ç¨‹æ“ä½œã€‚</li><li><code>ConcurrentHashMap</code> (JDK7)ï¼šåˆ†æ®µé”ã€‚é”ä½ä¸€ä¸ªæ®µï¼Œä¸åŒæ®µæ“ä½œå¯å¹¶å‘ã€‚</li><li><code>ConcurrentHashMap</code> (JDK8)ï¼šæ¡¶é” (å¤´èŠ‚ç‚¹é”)ã€‚é”ç²’åº¦æ›´ç»†ï¼Œå†²çªæ¦‚ç‡æ›´ä½ï¼Œå¹¶å‘åº¦æ›´é«˜ã€‚</li></ul></li><li><strong>æ— é”è¯»</strong>ï¼š<ul><li><code>Hashtable</code>ï¼šè¯»æ“ä½œä¹Ÿéœ€è¦è·å–é”ã€‚</li><li><code>ConcurrentHashMap</code> (JDK7 &amp; JDK8)ï¼š<strong>è¯»æ“ä½œå®Œå…¨æ— é”</strong> (JDK7 åˆ©ç”¨ volatile valueï¼ŒJDK8 åˆ©ç”¨ volatile val&#x2F;next å’Œ Unsafe çš„åŸå­è¯»)ï¼Œæå¤§æå‡è¯»æ€§èƒ½ã€‚</li></ul></li></ul><h3 id="å¼‚æ­¥ç¼–ç¨‹"><a href="#å¼‚æ­¥ç¼–ç¨‹" class="headerlink" title="å¼‚æ­¥ç¼–ç¨‹"></a>å¼‚æ­¥ç¼–ç¨‹</h3><h4 id="CompletableFutureçš„åŸç†ä¸åº”ç”¨"><a href="#CompletableFutureçš„åŸç†ä¸åº”ç”¨" class="headerlink" title="CompletableFutureçš„åŸç†ä¸åº”ç”¨"></a><code>CompletableFuture</code>çš„åŸç†ä¸åº”ç”¨</h4><p><code>CompletableFuture</code> æ˜¯ Java 8 å¼•å…¥çš„æ ¸å¿ƒå¹¶å‘å·¥å…·ç±»ï¼ˆä½äº <code>java.util.concurrent</code> åŒ…ï¼‰ï¼Œå®ƒä»£è¡¨ä¸€ä¸ª<strong>å¼‚æ­¥è®¡ç®—çš„ç»“æœ</strong>ã€‚å®ƒä¸ä»…æ˜¯å¯¹ä¼ ç»Ÿ <code>Future</code> æ¥å£çš„å¢å¼ºï¼Œæ›´æ˜¯ä¸€ä¸ªå¼ºå¤§çš„<strong>å¼‚æ­¥ç¼–ç¨‹æ¡†æ¶</strong>ï¼Œæ”¯æŒæ˜¾å¼åœ°å®Œæˆè®¡ç®—ã€é“¾å¼ç»„åˆå¤šä¸ªå¼‚æ­¥ä»»åŠ¡ã€å¤„ç†ç»“æœå’Œå¼‚å¸¸ï¼Œæ˜¯å®ç°å“åº”å¼ã€éé˜»å¡ç¼–ç¨‹çš„å…³é”®ç»„ä»¶ã€‚</p><p><strong>ä¸€ã€æ ¸å¿ƒåŸç†</strong></p><ol><li><strong>å¼‚æ­¥æ‰§è¡Œä¸ç»“æœå®¹å™¨ï¼š</strong><ul><li>å®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª<strong>å®¹å™¨</strong>ï¼Œç”¨äºæ‰¿è½½å°†æ¥æŸä¸ªæ—¶åˆ»è®¡ç®—å®Œæˆçš„ç»“æœï¼ˆæˆ–å¼‚å¸¸ï¼‰ã€‚</li><li>è®¡ç®—ä»»åŠ¡é€šå¸¸è¢«æäº¤ç»™ <code>Executor</code>ï¼ˆçº¿ç¨‹æ± ï¼‰åœ¨åå°çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œé¿å…é˜»å¡è°ƒç”¨çº¿ç¨‹ã€‚</li><li>åˆ›å»ºæ—¶ç»“æœæœªçŸ¥ï¼Œè®¡ç®—å®Œæˆåç»“æœè¢«è®¾ç½®ï¼ˆ<code>complete(result)</code> æˆ– <code>completeExceptionally(throwable)</code>ï¼‰ã€‚</li></ul></li><li><strong>æ˜¾å¼å®Œæˆï¼š</strong><ul><li>ä¸ä¼ ç»Ÿ <code>Future</code> åªèƒ½è¢«åŠ¨ç­‰å¾…ä¸åŒï¼Œ<code>CompletableFuture</code> å¯ä»¥è¢«<strong>ä¸»åŠ¨å®Œæˆ</strong>ã€‚</li><li>ä»»ä½•æ‹¥æœ‰è¯¥å¯¹è±¡å¼•ç”¨çš„çº¿ç¨‹éƒ½å¯ä»¥è°ƒç”¨ <code>complete()</code> æˆ– <code>completeExceptionally()</code> æ‰‹åŠ¨è®¾ç½®ç»“æœæˆ–å¼‚å¸¸ã€‚è¿™æ˜¯å®ç°è¶…æ—¶æ§åˆ¶ã€å¤–éƒ¨äº‹ä»¶è§¦å‘å®Œæˆç­‰åœºæ™¯çš„åŸºç¡€ã€‚</li></ul></li><li><strong>é“¾å¼ç»„åˆä¸å›è°ƒ (CompletionStage)ï¼š</strong><ul><li><code>CompletableFuture</code> å®ç°äº† <code>CompletionStage</code> æ¥å£ï¼Œè¿™æ˜¯å…¶å¼ºå¤§èƒ½åŠ›çš„æ ¸å¿ƒã€‚</li><li><code>CompletionStage</code> å®šä¹‰äº†ä¸°å¯Œçš„é“¾å¼æ–¹æ³•ï¼ˆ<code>thenApply</code>, <code>thenAccept</code>, <code>thenRun</code>, <code>thenCompose</code>, <code>thenCombine</code>, <code>handle</code>, <code>whenComplete</code>, <code>exceptionally</code> ç­‰ï¼‰ã€‚</li><li>è¿™äº›æ–¹æ³•å…è®¸ä½ <strong>å£°æ˜å¼åœ°</strong>æè¿°ï¼šâ€œ<strong>å½“å½“å‰é˜¶æ®µå®Œæˆæ—¶ï¼Œæ¥ä¸‹æ¥åº”è¯¥åšä»€ä¹ˆ</strong>â€ã€‚å›è°ƒå‡½æ•°ï¼ˆlambda è¡¨è¾¾å¼æˆ–æ–¹æ³•å¼•ç”¨ï¼‰ä¼šè¢«æŒ‚æ¥åˆ°å½“å‰é˜¶æ®µçš„å®Œæˆäº‹ä»¶ä¸Šã€‚</li><li>æ¯ä¸ªé“¾å¼è°ƒç”¨éƒ½ä¼šè¿”å›ä¸€ä¸ª<strong>æ–°çš„ <code>CompletionStage</code>ï¼ˆé€šå¸¸æ˜¯å¦ä¸€ä¸ª <code>CompletableFuture</code>ï¼‰</strong>ï¼Œä»£è¡¨ä¸‹ä¸€ä¸ªå¼‚æ­¥æ­¥éª¤ã€‚è¿™å½¢æˆäº†<strong>å¼‚æ­¥ä»»åŠ¡æµæ°´çº¿</strong>ã€‚</li></ul></li><li><strong>ä¾èµ–å…³ç³»ä¸å†…éƒ¨çŠ¶æ€æœºï¼š</strong><ul><li>å½“å¤šä¸ª <code>CompletableFuture</code> é€šè¿‡ <code>thenXxx</code> æ–¹æ³•é“¾æ¥èµ·æ¥æ—¶ï¼Œåç»­é˜¶æ®µä¾èµ–äºå‰é©±é˜¶æ®µçš„å®Œæˆã€‚</li><li><code>CompletableFuture</code> å†…éƒ¨ç»´æŠ¤ä¸€ä¸ª<strong>çŠ¶æ€æœº</strong>ï¼ˆå¦‚ <code>NEW</code>, <code>COMPLETING</code>, <code>NORMAL</code>, <code>EXCEPTIONAL</code>, <code>CANCELLED</code>ï¼‰å’Œä¸€ä¸ª<strong>ä¾èµ–æ ˆ</strong>ï¼ˆæŒ‡å‘æ‰€æœ‰ä¾èµ–äºå®ƒå®Œæˆçš„åç»­é˜¶æ®µï¼‰ã€‚</li><li>å½“ä¸€ä¸ªé˜¶æ®µå®Œæˆæ—¶ï¼Œå®ƒä¼šéå†å…¶ä¾èµ–æ ˆï¼Œ<strong>å°è¯•è§¦å‘æ‰€æœ‰åç»­é˜¶æ®µ</strong>çš„æ‰§è¡Œï¼ˆå¯èƒ½ç«‹å³æ‰§è¡Œï¼Œä¹Ÿå¯èƒ½æäº¤åˆ°çº¿ç¨‹æ± ï¼‰ã€‚</li></ul></li><li><strong>éé˜»å¡ä¸äº‹ä»¶é©±åŠ¨ï¼š</strong><ul><li>æ•´ä¸ªæµç¨‹æ˜¯<strong>éé˜»å¡</strong>çš„ã€‚è°ƒç”¨ <code>thenXxx</code> åªæ˜¯æ³¨å†Œå›è°ƒï¼Œå¹¶ä¸ç­‰å¾…å‰é©±å®Œæˆã€‚ä¸»çº¿ç¨‹å¯ä»¥ç»§ç»­æ‰§è¡Œå…¶ä»–ä»»åŠ¡ã€‚</li><li>æ‰§è¡Œç”±<strong>å®Œæˆäº‹ä»¶é©±åŠ¨</strong>ï¼šå‰é©±å®Œæˆ -&gt; è§¦å‘å›è°ƒ -&gt; æ‰§è¡Œå›è°ƒé€»è¾‘ -&gt; å®Œæˆåç»§ -&gt; è§¦å‘åç»§çš„å›è°ƒâ€¦ã€‚</li></ul></li><li><strong>ç»„åˆå¤šä¸ª Futureï¼š</strong><ul><li>æä¾› <code>allOf()</code>, <code>anyOf()</code> ç­‰é™æ€æ–¹æ³•ï¼Œç”¨äºç»„åˆå¤šä¸ªç‹¬ç«‹çš„ <code>CompletableFuture</code>ï¼š<ul><li><code>allOf(futures...)</code>: åˆ›å»ºä¸€ä¸ªæ–°çš„ Futureï¼Œå½“<strong>æ‰€æœ‰</strong>è¾“å…¥ Future å®Œæˆæ—¶ï¼ˆæ— è®ºæˆåŠŸå¤±è´¥ï¼‰ï¼Œå®ƒæ‰å®Œæˆï¼ˆæœ¬èº«æ— ç»“æœï¼Œéœ€æ‰‹åŠ¨è·å–å„Futureç»“æœï¼‰ã€‚</li><li><code>anyOf(futures...)</code>: åˆ›å»ºä¸€ä¸ªæ–°çš„ Futureï¼Œå½“<strong>ä»»æ„ä¸€ä¸ª</strong>è¾“å…¥ Future å®Œæˆæ—¶ï¼ˆæ— è®ºæˆåŠŸå¤±è´¥ï¼‰ï¼Œå®ƒå°±å®Œæˆï¼ˆç»“æœæ˜¯æœ€å…ˆå®Œæˆçš„é‚£ä¸ªFutureçš„ç»“æœï¼‰ã€‚</li></ul></li></ul></li><li><strong>çº¿ç¨‹æ± æ§åˆ¶ï¼š</strong><ul><li>é»˜è®¤æƒ…å†µä¸‹ï¼Œé“¾å¼è°ƒç”¨ä¸­åç»­ä»»åŠ¡çš„æ‰§è¡Œçº¿ç¨‹ç”±å‰é©±ä»»åŠ¡çš„å®Œæˆçº¿ç¨‹æ‰§è¡Œï¼ˆé€šå¸¸æ˜¯æ‰§è¡Œå‰é©±ä»»åŠ¡çš„çº¿ç¨‹æˆ–è°ƒç”¨ <code>complete</code> çš„çº¿ç¨‹ï¼‰ã€‚</li><li>å¯ä»¥ä½¿ç”¨å¸¦æœ‰ <code>Executor</code> å‚æ•°çš„å˜ä½“æ–¹æ³•ï¼ˆå¦‚ <code>thenApplyAsync(func, executor)</code>ï¼‰<strong>æ˜¾å¼æŒ‡å®š</strong>åç»­ä»»åŠ¡åœ¨ç‰¹å®šçš„çº¿ç¨‹æ± ä¸­æ‰§è¡Œï¼Œé¿å…çº¿ç¨‹é¥¥é¥¿æˆ–æ§åˆ¶èµ„æºã€‚</li></ul></li></ol><p><strong>äºŒã€ä¸»è¦åº”ç”¨åœºæ™¯</strong></p><ol><li><p><strong>å¼‚æ­¥ä»»åŠ¡ç¼–æ’ä¸æµæ°´çº¿ï¼š</strong> å°†å¤æ‚çš„ä¸šåŠ¡é€»è¾‘æ‹†åˆ†æˆå¤šä¸ªå¼‚æ­¥æ­¥éª¤ï¼ŒæŒ‰é¡ºåºæˆ–æ¡ä»¶é“¾å¼æ‰§è¡Œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture.supplyAsync(() -&gt; fetchUserData(userId), ioPool) <span class="comment">// æ­¥éª¤1ï¼šIOæ“ä½œ</span></span><br><span class="line">    .thenApply(userData -&gt; processData(userData))              <span class="comment">// æ­¥éª¤2ï¼šCPUå¯†é›†å‹å¤„ç†ï¼ˆé»˜è®¤åŒçº¿ç¨‹æˆ–ForkJoinPoolï¼‰</span></span><br><span class="line">    .thenApplyAsync(processedData -&gt; saveToDB(processedData), dbPool) <span class="comment">// æ­¥éª¤3ï¼šå¦ä¸€ä¸ªIOæ“ä½œï¼ŒæŒ‡å®šDBçº¿ç¨‹æ± </span></span><br><span class="line">    .thenAccept(savedResult -&gt; sendNotification(savedResult))  <span class="comment">// æ­¥éª¤4ï¼šæœ€ç»ˆå¤„ç†</span></span><br><span class="line">    .exceptionally(ex -&gt; &#123;                                     <span class="comment">// ç»Ÿä¸€å¼‚å¸¸å¤„ç†</span></span><br><span class="line">        log.error(<span class="string">&quot;Pipeline failed&quot;</span>, ex);</span><br><span class="line">        <span class="keyword">return</span> handleFailure(ex);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure></li><li><p><strong>å¹¶è¡Œæ‰§è¡Œä¸ç»“æœèšåˆï¼š</strong> åŒæ—¶å‘èµ·å¤šä¸ªç‹¬ç«‹ä»»åŠ¡ï¼Œç­‰æ‰€æœ‰&#x2F;ä»»æ„ä¸€ä¸ªå®Œæˆåå†å¤„ç†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture&lt;ResultA&gt; futureA = CompletableFuture.supplyAsync(() -&gt; serviceA.call());</span><br><span class="line">CompletableFuture&lt;ResultB&gt; futureB = CompletableFuture.supplyAsync(() -&gt; serviceB.call());</span><br><span class="line">CompletableFuture&lt;ResultC&gt; futureC = CompletableFuture.supplyAsync(() -&gt; serviceC.call());</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç­‰æ‰€æœ‰ä»»åŠ¡å®Œæˆ</span></span><br><span class="line">CompletableFuture&lt;Void&gt; allFutures = CompletableFuture.allOf(futureA, futureB, futureC);</span><br><span class="line">allFutures.thenRun(() -&gt; &#123;</span><br><span class="line">    <span class="comment">// æ‰‹åŠ¨è·å–å„ä¸ªç»“æœï¼ˆæ­¤æ—¶è‚¯å®šå·²å®Œæˆï¼‰</span></span><br><span class="line">    <span class="type">ResultA</span> <span class="variable">a</span> <span class="operator">=</span> futureA.join(); <span class="comment">// æˆ– get() (éœ€å¤„ç†å¼‚å¸¸)</span></span><br><span class="line">    <span class="type">ResultB</span> <span class="variable">b</span> <span class="operator">=</span> futureB.join();</span><br><span class="line">    <span class="type">ResultC</span> <span class="variable">c</span> <span class="operator">=</span> futureC.join();</span><br><span class="line">    aggregateResults(a, b, c);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç­‰ä»»æ„ä¸€ä¸ªä»»åŠ¡å®Œæˆ</span></span><br><span class="line">CompletableFuture&lt;Object&gt; anyFuture = CompletableFuture.anyOf(futureA, futureB, futureC);</span><br><span class="line">anyFuture.thenAccept(result -&gt; handleFirstResult(result));</span><br></pre></td></tr></table></figure></li><li><p><strong>ç»“æœè½¬æ¢ä¸å¤„ç†ï¼š</strong> ä½¿ç”¨ <code>thenApply</code> å°†ä¸Šä¸€æ­¥çš„ç»“æœè½¬æ¢æˆå¦ä¸€ç§å½¢å¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture&lt;Integer&gt; future = CompletableFuture.supplyAsync(() -&gt; <span class="string">&quot;123&quot;</span>);</span><br><span class="line">CompletableFuture&lt;Integer&gt; intFuture = future.thenApply(Integer::parseInt);</span><br></pre></td></tr></table></figure></li><li><p><strong>å‰¯ä½œç”¨æ“ä½œï¼š</strong> ä½¿ç”¨ <code>thenAccept</code> æ¶ˆè´¹ç»“æœä½†ä¸äº§ç”Ÿæ–°ç»“æœï¼ˆå¦‚æ—¥å¿—ã€å‘é€æ¶ˆæ¯ï¼‰ï¼Œæˆ–ä½¿ç”¨ <code>thenRun</code> æ‰§è¡Œä¸ä¾èµ–ç»“æœçš„åŠ¨ä½œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">future.thenAccept(result -&gt; System.out.println(<span class="string">&quot;Result: &quot;</span> + result));</span><br><span class="line">future.thenRun(() -&gt; cleanupResources());</span><br></pre></td></tr></table></figure></li><li><p><strong>ç»„åˆå¼‚æ­¥ä»»åŠ¡ï¼š</strong></p><ul><li><code>thenCompose(Function&lt;T, CompletionStage&lt;U&gt;&gt;)</code>: <strong>æ‰å¹³åŒ–</strong>ç»„åˆã€‚å½“å‰ Future å®Œæˆåï¼Œç”¨å…¶ç»“æœä½œä¸ºè¾“å…¥ï¼Œ<strong>å¯åŠ¨å¹¶è¿”å›å¦ä¸€ä¸ª Future</strong> (é¿å…åµŒå¥— <code>CompletableFuture&lt;CompletableFuture&lt;U&gt;&gt;</code>)ã€‚</li><li><code>thenCombine(CompletionStage&lt;U&gt;, BiFunction&lt;T, U, V&gt;)</code>: ç­‰å¾…<strong>å½“å‰ Future å’Œå¦ä¸€ä¸ª Future</strong> éƒ½å®Œæˆï¼Œç„¶åç”¨ä¸¤è€…çš„ç»“æœæ‰§è¡Œä¸€ä¸ªå‡½æ•°ï¼Œè¿”å›æ–°çš„ Futureã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// thenCompose ç¤ºä¾‹ (è·å–ç”¨æˆ·åè·å–è®¢å•)</span></span><br><span class="line">CompletableFuture&lt;User&gt; userFuture = getUserAsync(userId);</span><br><span class="line">CompletableFuture&lt;Order&gt; orderFuture = userFuture.thenCompose(user -&gt; getOrdersAsync(user));</span><br><span class="line"></span><br><span class="line"><span class="comment">// thenCombine ç¤ºä¾‹ (å¹¶è¡Œè®¡ç®—ä»·æ ¼å’Œåº“å­˜ï¼Œç„¶åç»„åˆ)</span></span><br><span class="line">CompletableFuture&lt;Price&gt; priceFuture = getPriceAsync(productId);</span><br><span class="line">CompletableFuture&lt;Inventory&gt; inventoryFuture = getInventoryAsync(productId);</span><br><span class="line">CompletableFuture&lt;ProductInfo&gt; productInfoFuture = priceFuture.thenCombine(inventoryFuture,</span><br><span class="line">    (price, inventory) -&gt; <span class="keyword">new</span> <span class="title class_">ProductInfo</span>(price, inventory));</span><br></pre></td></tr></table></figure></li><li><p><strong>å¼‚å¸¸å¤„ç†ï¼š</strong></p><ul><li><code>exceptionally(Function&lt;Throwable, T&gt;)</code>: æ•è·å¼‚å¸¸å¹¶æä¾›ä¸€ä¸ª<strong>æ¢å¤å€¼</strong>ï¼Œè¿”å›ä¸€ä¸ªæ­£å¸¸å®Œæˆçš„ Futureã€‚</li><li><code>handle(BiFunction&lt;T, Throwable, U&gt;)</code>: æ— è®ºæ­£å¸¸å®Œæˆè¿˜æ˜¯å¼‚å¸¸ï¼Œéƒ½ä¼šè¢«è°ƒç”¨ã€‚å¯ä»¥æ£€æŸ¥ç»“æœæˆ–å¼‚å¸¸ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°ç»“æœï¼ˆæˆ–æŠ›å‡ºæ–°å¼‚å¸¸ï¼‰ã€‚</li><li><code>whenComplete(BiConsumer&lt;T, Throwable&gt;)</code>: ç±»ä¼¼ <code>handle</code>ï¼Œä½†å®ƒæ˜¯æ¶ˆè´¹è€…ï¼ˆä¸æ”¹å˜ç»“æœï¼‰ï¼Œç”¨äºè®°å½•æ—¥å¿—ã€æ¸…ç†ç­‰ï¼Œè¿”å›ä¸€ä¸ªç»“æœç±»å‹ç›¸åŒçš„ Futureï¼ˆå¼‚å¸¸ä¼šä¼ æ’­ï¼‰ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">future.exceptionally(ex -&gt; defaultValue) <span class="comment">// å¼‚å¸¸æ—¶æä¾›é»˜è®¤å€¼</span></span><br><span class="line">     .handle((result, ex) -&gt; &#123;</span><br><span class="line">         <span class="keyword">if</span> (ex != <span class="literal">null</span>) &#123; <span class="keyword">return</span> fallback; &#125;</span><br><span class="line">         <span class="keyword">else</span> &#123; <span class="keyword">return</span> transform(result); &#125;</span><br><span class="line">     &#125;)</span><br><span class="line">     .whenComplete((result, ex) -&gt; &#123;</span><br><span class="line">         <span class="keyword">if</span> (ex != <span class="literal">null</span>) log.error(<span class="string">&quot;Oops&quot;</span>, ex);</span><br><span class="line">         <span class="keyword">else</span> metrics.recordSuccess();</span><br><span class="line">     &#125;);</span><br></pre></td></tr></table></figure></li><li><p><strong>è¶…æ—¶æ§åˆ¶ (Java 9+):</strong> ä½¿ç”¨ <code>orTimeout(timeout, timeUnit)</code> æˆ– <code>completeOnTimeout(value, timeout, timeUnit)</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture&lt;String&gt; future = someLongRunningTask()</span><br><span class="line">    .orTimeout(<span class="number">5</span>, TimeUnit.SECONDS) <span class="comment">// è¶…æ—¶æŠ›å‡º TimeoutException</span></span><br><span class="line">    .exceptionally(ex -&gt; (ex <span class="keyword">instanceof</span> TimeoutException) ? <span class="string">&quot;Timed out&quot;</span> : <span class="string">&quot;Other error&quot;</span>);</span><br><span class="line"></span><br><span class="line">CompletableFuture&lt;String&gt; future = someLongRunningTask()</span><br><span class="line">    .completeOnTimeout(<span class="string">&quot;Fallback Value&quot;</span>, <span class="number">5</span>, TimeUnit.SECONDS); <span class="comment">// è¶…æ—¶æä¾›é»˜è®¤å€¼</span></span><br></pre></td></tr></table></figure></li></ol><p><strong>ä¸‰ã€å…³é”®ä¼˜åŠ¿</strong></p><ol><li><strong>éé˜»å¡å¼‚æ­¥ï¼š</strong> æé«˜ç³»ç»Ÿååé‡å’Œå“åº”æ€§ã€‚</li><li><strong>å£°æ˜å¼ &amp; é“¾å¼ç¼–ç¨‹ï¼š</strong> ä»£ç æ›´ç®€æ´ã€æ˜“è¯»ã€æ˜“ç»´æŠ¤ï¼Œæ¥è¿‘åŒæ­¥ä»£ç çš„é£æ ¼ï¼ˆé¿å…å›è°ƒåœ°ç‹±ï¼‰ã€‚</li><li><strong>å¼ºå¤§çš„ç»„åˆèƒ½åŠ›ï¼š</strong> è½»æ¾ç¼–æ’å¤æ‚å¼‚æ­¥å·¥ä½œæµï¼ˆé¡ºåºã€å¹¶è¡Œã€èšåˆã€æ¡ä»¶ï¼‰ã€‚</li><li><strong>çµæ´»çš„å¼‚å¸¸å¤„ç†ï¼š</strong> æä¾›å¤šç§æ–¹å¼å¤„ç†å¼‚æ­¥ç®¡é“ä¸­çš„é”™è¯¯ã€‚</li><li><strong>æ˜¾å¼å®Œæˆæ§åˆ¶ï¼š</strong> æ”¯æŒæ‰‹åŠ¨è®¾ç½®ç»“æœï¼Œé€‚åº”æ›´å¤šåœºæ™¯ï¼ˆå¦‚è¶…æ—¶ã€å¤–éƒ¨äº‹ä»¶ï¼‰ã€‚</li><li><strong>çº¿ç¨‹æ± é›†æˆï¼š</strong> å¯ç²¾ç»†æ§åˆ¶ä»»åŠ¡æ‰§è¡Œä½ç½®ã€‚</li></ol><p><strong>å››ã€æ³¨æ„äº‹é¡¹ä¸æœ€ä½³å®è·µ</strong></p><ol><li><strong>é¿å…é˜»å¡ï¼š</strong> ä¸è¦åœ¨ <code>CompletableFuture</code> çš„å›è°ƒæ–¹æ³•ï¼ˆå¦‚ <code>thenApply</code>, <code>thenAccept</code> å†…éƒ¨ï¼‰æ‰§è¡Œé•¿æ—¶é—´é˜»å¡æ“ä½œï¼Œè¿™ä¼šå¡ä½æ‰§è¡Œçº¿ç¨‹ï¼ˆå¯èƒ½æ˜¯å…¬å…±çš„ ForkJoinPool çº¿ç¨‹ï¼‰ã€‚ä½¿ç”¨ <code>thenApplyAsync</code> ç­‰å¸¦ <code>Executor</code> çš„æ–¹æ³•å°†é˜»å¡æ“ä½œæäº¤åˆ°ä¸“ç”¨çº¿ç¨‹æ± ã€‚</li><li><strong>çº¿ç¨‹æ± é€‰æ‹©ï¼š</strong><ul><li>CPU å¯†é›†å‹ä»»åŠ¡ï¼šè€ƒè™‘ä½¿ç”¨ <code>ForkJoinPool.commonPool()</code> (é»˜è®¤) æˆ–å›ºå®šå¤§å°çº¿ç¨‹æ± ï¼ˆçº¿ç¨‹æ•° â‰ˆ CPU æ ¸å¿ƒæ•°ï¼‰ã€‚</li><li>IO å¯†é›†å‹ä»»åŠ¡ï¼š<strong>åŠ¡å¿…ä½¿ç”¨</strong> è¶³å¤Ÿå¤§çš„ç¼“å­˜çº¿ç¨‹æ± ï¼ˆå¦‚ <code>Executors.newCachedThreadPool()</code>ï¼‰æˆ–ä¸“é—¨é…ç½®çš„çº¿ç¨‹æ± ï¼Œé¿å…çº¿ç¨‹é¥¥é¥¿ã€‚<strong>å¼ºçƒˆæ¨èä¸ºä¸åŒèµ„æºï¼ˆå¦‚DBã€HTTPï¼‰ä½¿ç”¨ç‹¬ç«‹çº¿ç¨‹æ± ã€‚</strong></li></ul></li><li><strong>å¼‚å¸¸ä¼ æ’­ï¼š</strong> ç†è§£å¼‚å¸¸åœ¨é“¾å¼è°ƒç”¨ä¸­çš„ä¼ æ’­æœºåˆ¶ã€‚å¦‚æœæŸä¸ªé˜¶æ®µæŠ›å‡ºå¼‚å¸¸ä¸”æœªè¢«æ•è·ï¼ˆå¦‚ <code>exceptionally</code>ï¼‰ï¼Œåç»­ä¾èµ–å®ƒçš„ <code>thenApply</code>&#x2F;<code>thenAccept</code> ç­‰<strong>ä¸ä¼šè¢«æ‰§è¡Œ</strong>ï¼Œå¼‚å¸¸ä¼šä¼ é€’åˆ°é“¾çš„æœ«ç«¯æˆ–ç­‰å¾… <code>get()</code>&#x2F;<code>join()</code> æ—¶æŠ›å‡ºã€‚ä½¿ç”¨ <code>handle</code>&#x2F;<code>whenComplete</code>&#x2F;<code>exceptionally</code> å¦¥å–„å¤„ç†ã€‚</li><li><strong>ç»“æœè·å–ï¼š</strong><ul><li><code>get()</code>: é˜»å¡ç­‰å¾…ç»“æœï¼Œéœ€å¤„ç† <code>InterruptedException</code> å’Œ <code>ExecutionException</code>ï¼ˆå°è£…äº†åŸå§‹å¼‚å¸¸ï¼‰ã€‚</li><li><code>join()</code>: ç±»ä¼¼ <code>get()</code>ï¼Œä½†æŠ›å‡ºæœªç»æ£€æŸ¥çš„ <code>CompletionException</code>ï¼ˆå…¶ <code>getCause()</code> æ˜¯åŸå§‹å¼‚å¸¸ï¼‰ã€‚é€šå¸¸åœ¨é“¾çš„æœ«ç«¯æˆ–æ˜ç¡®çŸ¥é“ä¼šå¾ˆå¿«å®Œæˆæ—¶ä½¿ç”¨ã€‚</li><li><strong>å°½é‡ä½¿ç”¨å›è°ƒ</strong>ï¼ˆ<code>thenAccept</code>, <code>thenApply</code>, <code>whenComplete</code>ï¼‰è€Œéé˜»å¡è·å–ï¼Œä»¥ä¿æŒéé˜»å¡æ€§ã€‚</li></ul></li><li><strong>èµ„æºæ¸…ç†ï¼š</strong> ä½¿ç”¨ <code>whenComplete</code> æˆ– <code>handle</code> ç¡®ä¿èµ„æºï¼ˆå¦‚æ–‡ä»¶å¥æŸ„ã€ç½‘ç»œè¿æ¥ï¼‰åœ¨ä»»åŠ¡å®Œæˆï¼ˆæ— è®ºæˆåŠŸå¤±è´¥ï¼‰åè¢«æ­£ç¡®å…³é—­ã€‚</li><li><strong>é¿å…è¿‡åº¦åµŒå¥—ï¼š</strong> è™½ç„¶é“¾å¼è°ƒç”¨é¿å…å›è°ƒåœ°ç‹±ï¼Œä½†æ·±åº¦åµŒå¥—ä»å¯èƒ½é™ä½å¯è¯»æ€§ã€‚è€ƒè™‘å°†å¤æ‚æ­¥éª¤æŠ½å–æˆç‹¬ç«‹æ–¹æ³•ã€‚</li><li><strong>å–æ¶ˆä¼ æ’­ï¼š</strong> <code>CompletableFuture.cancel(true)</code> ä¼šå°è¯•ä¸­æ–­å½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œä½†<strong>ä¸ä¼šè‡ªåŠ¨å–æ¶ˆå®ƒä¾èµ–çš„æˆ–ä¾èµ–å®ƒçš„å…¶ä»– Future</strong>ã€‚éœ€è¦æ‰‹åŠ¨è®¾è®¡å–æ¶ˆé€»è¾‘ã€‚</li></ol><p><strong>æ€»ç»“</strong></p><p><code>CompletableFuture</code> æ˜¯ Java ç°ä»£å¼‚æ­¥ç¼–ç¨‹çš„åŸºçŸ³ã€‚å®ƒé€šè¿‡<strong>é“¾å¼ç»„åˆ</strong>ã€<strong>éé˜»å¡å›è°ƒ</strong>å’Œ<strong>æ˜¾å¼å®Œæˆ</strong>æœºåˆ¶ï¼Œæä¾›äº†å¼ºå¤§è€Œä¼˜é›…çš„æ–¹å¼æ¥æ„å»ºå¤æ‚ã€é«˜æ•ˆçš„å¼‚æ­¥åº”ç”¨ç¨‹åºã€‚æ·±å…¥ç†è§£å…¶åŸç†ï¼ˆçŠ¶æ€æœºã€ä¾èµ–ç®¡ç†ï¼‰å’Œç†Ÿç»ƒæŒæ¡å…¶ APIï¼ˆ<code>supplyAsync</code>, <code>thenXxx</code>, <code>handle</code>, <code>allOf</code>, <code>anyOf</code>, <code>thenCompose</code>, <code>thenCombine</code>, å¼‚å¸¸å¤„ç†ï¼‰æ˜¯ç¼–å†™é«˜æ€§èƒ½ã€é«˜å“åº”æ€§ Java æœåŠ¡çš„å…³é”®ã€‚åˆç†ä½¿ç”¨çº¿ç¨‹æ± å’Œéµå¾ªæœ€ä½³å®è·µï¼ˆé¿å…é˜»å¡å›è°ƒã€å¦¥å–„å¤„ç†å¼‚å¸¸ã€ç®¡ç†èµ„æºï¼‰è‡³å…³é‡è¦ã€‚</p><h4 id="CompletableFuture-å’Œä¼ ç»Ÿçš„-Future-æœ‰ä»€ä¹ˆåŒºåˆ«"><a href="#CompletableFuture-å’Œä¼ ç»Ÿçš„-Future-æœ‰ä»€ä¹ˆåŒºåˆ«" class="headerlink" title="CompletableFuture å’Œä¼ ç»Ÿçš„ Future æœ‰ä»€ä¹ˆåŒºåˆ«"></a><strong><code>CompletableFuture</code> å’Œä¼ ç»Ÿçš„ <code>Future</code> æœ‰ä»€ä¹ˆåŒºåˆ«</strong></h4><ul><li>è€ƒå¯Ÿç‚¹ï¼šç†è§£å…¶æ ¸å¿ƒä¼˜åŠ¿ï¼ˆé“¾å¼ç¼–ç¨‹ã€ç»„åˆèƒ½åŠ›ã€æ‰‹åŠ¨å®Œæˆã€å¼‚å¸¸å¤„ç†ï¼‰ã€‚</li><li>æœŸæœ›å›ç­”ï¼š<code>Future</code> ä»…æ”¯æŒé˜»å¡è·å–ç»“æœæˆ–è½®è¯¢ï¼Œæ— æ³•ç»„åˆï¼›<code>CompletableFuture</code> å®ç°äº† <code>CompletionStage</code>ï¼Œæ”¯æŒéé˜»å¡å›è°ƒã€ä»»åŠ¡é“¾å¼ç»„åˆã€æ‰‹åŠ¨è®¾ç½®ç»“æœ&#x2F;å¼‚å¸¸ã€æ›´å¼ºå¤§çš„å¼‚å¸¸å¤„ç†ã€‚</li></ul><h2 id="JVM"><a href="#JVM" class="headerlink" title="JVM"></a>JVM</h2><h3 id="å†…å­˜åŒºåŸŸ"><a href="#å†…å­˜åŒºåŸŸ" class="headerlink" title="å†…å­˜åŒºåŸŸ"></a>å†…å­˜åŒºåŸŸ</h3><p>å†…å­˜åŒºåŸŸï¼ˆå †ã€æ ˆã€æ–¹æ³•åŒº&#x2F;å…ƒç©ºé—´ã€ç¨‹åºè®¡æ•°å™¨ã€æœ¬åœ°æ–¹æ³•æ ˆï¼‰åŠå…¶ä½œç”¨ã€‚</p><h4 id="JVMå†…å­˜ç»“æ„"><a href="#JVMå†…å­˜ç»“æ„" class="headerlink" title="JVMå†…å­˜ç»“æ„"></a>JVMå†…å­˜ç»“æ„</h4><table><thead><tr><th><strong>å†…å­˜åŒºåŸŸ</strong></th><th><strong>æè¿°</strong></th><th><strong>çº¿ç¨‹å…±äº«æ€§</strong></th><th><strong>å¼‚å¸¸è§¦å‘æ¡ä»¶</strong></th></tr></thead><tbody><tr><td><strong>ç¨‹åºè®¡æ•°å™¨ï¼ˆPCï¼‰</strong></td><td>è®°å½•å½“å‰çº¿ç¨‹æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤åœ°å€ï¼Œçº¿ç¨‹ç§æœ‰ï¼Œå”¯ä¸€æ— OOMçš„åŒºåŸŸã€‚</td><td>çº¿ç¨‹ç§æœ‰</td><td>æ— ï¼ˆä¸ä¼šæŠ›å‡ºå†…å­˜ç›¸å…³å¼‚å¸¸ï¼‰</td></tr><tr><td><strong>è™šæ‹Ÿæœºæ ˆï¼ˆJava Stackï¼‰</strong></td><td>å­˜å‚¨æ–¹æ³•è°ƒç”¨çš„æ ˆå¸§ï¼ˆå±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€åŠ¨æ€é“¾æ¥ã€æ–¹æ³•å‡ºå£ç­‰ï¼‰ï¼Œçº¿ç¨‹ç§æœ‰ã€‚</td><td>çº¿ç¨‹ç§æœ‰</td><td><code>StackOverflowError</code>ï¼ˆæ ˆæ·±åº¦æº¢å‡ºï¼‰ <code>OutOfMemoryError</code>ï¼ˆæ— æ³•æ‰©å±•æ ˆç©ºé—´ï¼‰</td></tr><tr><td><strong>æœ¬åœ°æ–¹æ³•æ ˆï¼ˆNative Stackï¼‰</strong></td><td>ä¸ºNativeæ–¹æ³•ï¼ˆå¦‚C&#x2F;C++å®ç°çš„æ–¹æ³•ï¼‰æä¾›æ ˆç©ºé—´ï¼Œçº¿ç¨‹ç§æœ‰ã€‚</td><td>çº¿ç¨‹ç§æœ‰</td><td>åŒè™šæ‹Ÿæœºæ ˆ</td></tr><tr><td><strong>å †ï¼ˆHeapï¼‰</strong></td><td>å­˜æ”¾å¯¹è±¡å®ä¾‹å’Œæ•°ç»„ï¼Œæ‰€æœ‰çº¿ç¨‹å…±äº«ï¼Œæ˜¯åƒåœ¾å›æ”¶çš„ä¸»è¦åŒºåŸŸã€‚</td><td>çº¿ç¨‹å…±äº«</td><td><code>OutOfMemoryError</code>ï¼ˆå †å†…å­˜ä¸è¶³ï¼‰</td></tr><tr><td><strong>æ–¹æ³•åŒºï¼ˆMethod Areaï¼‰</strong></td><td>å­˜å‚¨ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ã€å³æ—¶ç¼–è¯‘å™¨ä»£ç ç­‰æ•°æ®ã€‚JDK 8åç”±å…ƒç©ºé—´ï¼ˆMetaspaceï¼‰å®ç°ã€‚</td><td>çº¿ç¨‹å…±äº«</td><td><code>OutOfMemoryError</code>ï¼ˆå…ƒç©ºé—´&#x2F;æ–¹æ³•åŒºå†…å­˜ä¸è¶³ï¼‰</td></tr></tbody></table><h3 id="ç±»åŠ è½½æœºåˆ¶"><a href="#ç±»åŠ è½½æœºåˆ¶" class="headerlink" title="ç±»åŠ è½½æœºåˆ¶"></a>ç±»åŠ è½½æœºåˆ¶</h3><p>ç±»åŠ è½½æœºåˆ¶ï¼ˆåŠ è½½ã€éªŒè¯ã€å‡†å¤‡ã€è§£æã€åˆå§‹åŒ–ï¼‰ã€ç±»åŠ è½½å™¨ï¼ˆåŒäº²å§”æ´¾æ¨¡å‹åŠæ‰“ç ´åœºæ™¯ï¼‰ã€å­—èŠ‚ç æŒ‡ä»¤ã€‚</p><h3 id="åƒåœ¾æ”¶é›†ç®—æ³•"><a href="#åƒåœ¾æ”¶é›†ç®—æ³•" class="headerlink" title="åƒåœ¾æ”¶é›†ç®—æ³•"></a>åƒåœ¾æ”¶é›†ç®—æ³•</h3><p>åƒåœ¾æ”¶é›†ç®—æ³•ï¼ˆæ ‡è®°-æ¸…é™¤ã€æ ‡è®°-æ•´ç†ã€å¤åˆ¶ï¼‰å’Œä¸»æµåƒåœ¾æ”¶é›†å™¨ï¼ˆSerial, Parallel, CMS, G1, ZGC, Shenandoahï¼‰çš„å·¥ä½œåŸç†ã€ä¼˜ç¼ºç‚¹ã€é€‚ç”¨åœºæ™¯å’Œè°ƒä¼˜å‚æ•°ã€‚</p><table><thead><tr><th>ç®—æ³•</th><th>æ­¥éª¤</th><th>ç‰¹ç‚¹</th><th>é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td><strong>æ ‡è®°-æ¸…é™¤ï¼ˆMark-Sweepï¼‰</strong></td><td>1. <strong>æ ‡è®°</strong>ï¼šéå†æ‰€æœ‰å¯¹è±¡ï¼Œæ ‡è®°å­˜æ´»å¯¹è±¡ã€‚ 2. <strong>æ¸…é™¤</strong>ï¼šå›æ”¶æœªè¢«æ ‡è®°çš„å¯¹è±¡ï¼ˆåƒåœ¾ï¼‰ã€‚</td><td><strong>ä¼˜ç‚¹</strong>ï¼šå®ç°ç®€å•ï¼Œä¸éœ€è¦ç§»åŠ¨å¯¹è±¡ã€‚ <strong>ç¼ºç‚¹</strong>ï¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡ï¼Œå¯èƒ½è§¦å‘é¢‘ç¹çš„ Full GCã€‚</td><td>1. è€å¹´ä»£å›æ”¶ï¼ˆå¦‚ CMS æ”¶é›†å™¨çš„åˆå§‹é˜¶æ®µï¼‰ã€‚ 2. å¯¹å†…å­˜ç¢ç‰‡ä¸æ•æ„Ÿçš„åœºæ™¯ï¼Œæˆ–çŸ­æœŸè¿è¡Œçš„åº”ç”¨ç¨‹åºã€‚</td></tr><tr><td><strong>å¤åˆ¶ç®—æ³•ï¼ˆCopyingï¼‰</strong></td><td>1. å°†å†…å­˜åˆ†ä¸ºä¸¤å—ï¼ˆFrom å’Œ Toï¼‰ï¼Œå¯¹è±¡åˆ†é…åœ¨ From åŒºã€‚ 2. æ ‡è®°å­˜æ´»å¯¹è±¡ï¼Œå°†å…¶å¤åˆ¶åˆ° To åŒºã€‚ 3. æ¸…ç©º From åŒºï¼Œäº¤æ¢ From å’Œ To çš„è§’è‰²ã€‚</td><td><strong>ä¼˜ç‚¹</strong>ï¼šæ— å†…å­˜ç¢ç‰‡ï¼Œå›æ”¶é«˜æ•ˆã€‚ <strong>ç¼ºç‚¹</strong>ï¼šå†…å­˜åˆ©ç”¨ç‡ä½ï¼ˆéœ€é¢„ç•™ä¸€åŠç©ºé—´ï¼‰ã€‚</td><td>1. æ–°ç”Ÿä»£å›æ”¶ï¼ˆå¦‚ Serialã€ParNewã€Parallel Scavenge ç­‰æ”¶é›†å™¨ï¼‰ã€‚ 2. é€‚ç”¨äºå¯¹è±¡å­˜æ´»ç‡ä½çš„åœºæ™¯ï¼ˆå¦‚æ–°ç”Ÿä»£ Eden åŒºï¼‰ã€‚</td></tr><tr><td><strong>æ ‡è®°-æ•´ç†ï¼ˆMark-Compactï¼‰</strong></td><td><strong>æ ‡è®°</strong>ï¼šéå†æ‰€æœ‰å¯¹è±¡ï¼Œæ ‡è®°å­˜æ´»å¯¹è±¡ã€‚ <strong>æ•´ç†</strong>ï¼šå°†å­˜æ´»å¯¹è±¡å‘å†…å­˜ä¸€ç«¯ç§»åŠ¨ï¼Œæ¸…ç†è¾¹ç•Œå¤–çš„ç©ºé—´ã€‚</td><td><strong>ä¼˜ç‚¹</strong>ï¼šé¿å…å†…å­˜ç¢ç‰‡ï¼Œé€‚åˆé•¿æœŸè¿è¡Œçš„ç³»ç»Ÿã€‚ <strong>ç¼ºç‚¹</strong>ï¼šç§»åŠ¨å¯¹è±¡éœ€è¦æ—¶é—´ï¼Œå¯¼è‡´åœé¡¿è¾ƒé•¿ï¼ˆSTWï¼‰ã€‚</td><td>1. è€å¹´ä»£å›æ”¶ï¼ˆå¦‚ Serial Oldã€Parallel Old æ”¶é›†å™¨ï¼‰ã€‚ 2. å¯¹å†…å­˜æ•æ„Ÿä¸”éœ€è¦é¿å…ç¢ç‰‡çš„åœºæ™¯ï¼ˆå¦‚å¤§æ•°æ®åº”ç”¨ï¼‰ã€‚</td></tr></tbody></table><h3 id="æ€§èƒ½ç›‘æ§ä¸è°ƒä¼˜"><a href="#æ€§èƒ½ç›‘æ§ä¸è°ƒä¼˜" class="headerlink" title="æ€§èƒ½ç›‘æ§ä¸è°ƒä¼˜"></a>æ€§èƒ½ç›‘æ§ä¸è°ƒä¼˜</h3><p>ç†Ÿç»ƒä½¿ç”¨ <code>jps</code>, <code>jstat</code>, <code>jmap</code>, <code>jstack</code>, <code>jcmd</code>, <code>jconsole</code>, <code>VisualVM</code>, ä»¥åŠæ›´å¼ºå¤§çš„ <code>Java Flight Recorder</code> å’Œ <code>Mission Control</code>ã€‚ç†è§£ GC æ—¥å¿—åˆ†æã€‚æŒæ¡å¸¸è§æ€§èƒ½é—®é¢˜ï¼ˆå†…å­˜æ³„æ¼ã€OOMã€CPU é£™é«˜ã€çº¿ç¨‹é˜»å¡ï¼‰çš„è¯Šæ–­æ€è·¯å’Œå·¥å…·é“¾ã€‚</p><h3 id="ç±»åŠ è½½"><a href="#ç±»åŠ è½½" class="headerlink" title="ç±»åŠ è½½"></a>ç±»åŠ è½½</h3><p>ç±»åŠ è½½çš„è¿‡ç¨‹åŒ…æ‹¬äº†<strong>åŠ è½½ã€éªŒè¯ã€å‡†å¤‡ã€è§£æã€åˆå§‹åŒ–</strong>äº”ä¸ªé˜¶æ®µã€‚</p><h4 id="å“ªäº›åœºæ™¯ä¼šè§¦å‘ç±»çš„åŠ è½½"><a href="#å“ªäº›åœºæ™¯ä¼šè§¦å‘ç±»çš„åŠ è½½" class="headerlink" title="å“ªäº›åœºæ™¯ä¼šè§¦å‘ç±»çš„åŠ è½½"></a>å“ªäº›åœºæ™¯ä¼šè§¦å‘ç±»çš„åŠ è½½</h4><ul><li>ç±»çš„å®ä¾‹åŒ–</li><li>è®¿é—®ç±»çš„é™æ€æˆå‘˜</li><li>è°ƒç”¨ç±»çš„é™æ€æ–¹æ³•</li><li><code>Class.forName()</code>ã€<code>ClassLoader.loadClass()</code>ç­‰åå°„æ–¹æ³•</li><li>åŠ è½½å­ç±»æ—¶ä¼šåŠ è½½çˆ¶ç±»</li></ul><h4 id="Class-forName-å’ŒClassLoader-loadClass-æœ‰ä»€ä¹ˆåŒºåˆ«"><a href="#Class-forName-å’ŒClassLoader-loadClass-æœ‰ä»€ä¹ˆåŒºåˆ«" class="headerlink" title="Class.forName()å’ŒClassLoader.loadClass()æœ‰ä»€ä¹ˆåŒºåˆ«"></a><code>Class.forName()</code>å’Œ<code>ClassLoader.loadClass()</code>æœ‰ä»€ä¹ˆåŒºåˆ«</h4><ul><li><code>Class.forName()</code>: å°†ç±»çš„.classæ–‡ä»¶åŠ è½½åˆ°jvmä¸­ä¹‹å¤–ï¼Œè¿˜ä¼šå¯¹ç±»è¿›è¡Œè§£é‡Šï¼Œæ‰§è¡Œç±»ä¸­çš„staticå—ï¼›</li><li><code>ClassLoader.loadClass()</code>: åªå¹²ä¸€ä»¶äº‹æƒ…ï¼Œå°±æ˜¯å°†.classæ–‡ä»¶åŠ è½½åˆ°jvmä¸­ï¼Œä¸ä¼šæ‰§è¡Œstaticä¸­çš„å†…å®¹,åªæœ‰åœ¨newInstanceæ‰ä¼šå»æ‰§è¡Œstaticå—ã€‚</li><li><code>Class.forName(name, initialize, loader)</code>å¸¦å‚å‡½æ•°ä¹Ÿå¯æ§åˆ¶æ˜¯å¦åŠ è½½staticå—ã€‚å¹¶ä¸”åªæœ‰è°ƒç”¨äº†newInstance()æ–¹æ³•é‡‡ç”¨è°ƒç”¨æ„é€ å‡½æ•°ï¼Œåˆ›å»ºç±»çš„å¯¹è±¡ ã€‚</li></ul><h4 id="ç±»åŠ è½½å™¨çš„å±‚æ¬¡ç»“æ„"><a href="#ç±»åŠ è½½å™¨çš„å±‚æ¬¡ç»“æ„" class="headerlink" title="ç±»åŠ è½½å™¨çš„å±‚æ¬¡ç»“æ„"></a>ç±»åŠ è½½å™¨çš„å±‚æ¬¡ç»“æ„</h4><p>ç±»åŠ è½½å™¨å±‚çº§ç»“æ„ï¼š</p><table><thead><tr><th><strong>ç±»åŠ è½½å™¨</strong></th><th><strong>åŠ è½½è·¯å¾„</strong></th><th><strong>çˆ¶åŠ è½½å™¨</strong></th></tr></thead><tbody><tr><td><strong>Bootstrap ClassLoader</strong></td><td><code>JRE/lib/rt.jar</code>ç­‰æ ¸å¿ƒåº“</td><td>æ— ï¼ˆé¡¶çº§åŠ è½½å™¨ï¼‰</td></tr><tr><td><strong>Extension ClassLoader</strong></td><td><code>JRE/lib/ext</code>ç›®å½•ä¸‹æ‰©å±•åº“</td><td>Bootstrap</td></tr><tr><td><strong>Application ClassLoader</strong></td><td>åº”ç”¨ç±»è·¯å¾„ï¼ˆClassPathï¼‰</td><td>Extension</td></tr><tr><td><strong>è‡ªå®šä¹‰ClassLoader</strong></td><td>ç”¨æˆ·è‡ªå®šä¹‰è·¯å¾„</td><td>Application</td></tr></tbody></table><h4 id="ä»€ä¹ˆæ˜¯åŒäº²å§”æ´¾æ¨¡å‹"><a href="#ä»€ä¹ˆæ˜¯åŒäº²å§”æ´¾æ¨¡å‹" class="headerlink" title="ä»€ä¹ˆæ˜¯åŒäº²å§”æ´¾æ¨¡å‹"></a>ä»€ä¹ˆæ˜¯åŒäº²å§”æ´¾æ¨¡å‹</h4><p>åŒäº²å§”æ´¾æ¨¡å‹ï¼ˆParent Delegation Modelï¼‰æ˜¯Javaç±»åŠ è½½æœºåˆ¶ä¸­çš„ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œç”¨äºæ§åˆ¶ç±»çš„åŠ è½½é¡ºåºå’Œé¿å…ç±»çš„é‡å¤åŠ è½½ã€‚åœ¨åŒäº²å§”æ´¾æ¨¡å‹ä¸­ï¼Œç±»åŠ è½½å™¨ä¼šæŒ‰ç…§ä¸€å®šçš„é¡ºåºè¿›è¡Œç±»çš„åŠ è½½ï¼Œå¹¶å°†åŠ è½½è¯·æ±‚å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨ï¼Œåªæœ‰åœ¨çˆ¶ç±»åŠ è½½å™¨æ‰¾ä¸åˆ°ç±»çš„æƒ…å†µä¸‹ï¼Œæ‰ä¼šç”±å­ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½ã€‚</p><p><strong>åŒäº²å§”æ´¾æ¨¡å‹çš„ä¼˜ç‚¹</strong></p><ol><li>é¿å…ç±»çš„é‡å¤åŠ è½½ï¼šç”±äºç±»åŠ è½½å™¨ä¼šå…ˆå§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½ï¼Œæ‰€ä»¥å¯ä»¥é¿å…åŒä¸€ä¸ªç±»è¢«å¤šä¸ªç±»åŠ è½½å™¨é‡å¤åŠ è½½ï¼Œä»è€ŒèŠ‚çœå†…å­˜å’Œæé«˜æ€§èƒ½ã€‚</li><li>å®‰å…¨æ€§ï¼šæ ¸å¿ƒç±»åº“é€šå¸¸ç”±å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½ï¼Œè€Œè‡ªå®šä¹‰ç±»é€šå¸¸ç”±åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨åŠ è½½ï¼Œè¿™æ ·å¯ä»¥ä¿è¯æ ¸å¿ƒç±»åº“çš„å®‰å…¨æ€§ï¼Œé˜²æ­¢è¢«æ¶æ„ä»£ç æ›¿ä»£ã€‚</li><li>æ¨¡å—åŒ–ï¼šé€šè¿‡ä½¿ç”¨ä¸åŒçš„ç±»åŠ è½½å™¨ï¼Œå¯ä»¥å®ç°ç±»çš„æ¨¡å—åŒ–å’Œéš”ç¦»ï¼Œä»è€Œåœ¨å¤æ‚çš„åº”ç”¨ç¨‹åºä¸­å®ç°ç±»çš„å…±äº«å’Œå¤ç”¨ã€‚</li></ol><p><strong>åŒäº²å§”æ´¾æ¨¡å‹çš„ç¼ºç‚¹</strong></p><ol><li>çµæ´»æ€§å—é™ï¼šåŒäº²å§”æ´¾æ¨¡å‹é™åˆ¶äº†ç±»åŠ è½½å™¨çš„çµæ´»æ€§ï¼Œå¯èƒ½å¯¼è‡´åœ¨æŸäº›ç‰¹å®šçš„åœºæ™¯ä¸­æ— æ³•å®ç°è‡ªå®šä¹‰çš„ç±»åŠ è½½è¡Œä¸ºã€‚ä¾‹å¦‚ï¼Œåœ¨æŸäº›éœ€è¦åœ¨è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆç±»æˆ–åŠ è½½éæ ‡å‡†æ ¼å¼çš„ç±»æ–‡ä»¶çš„åœºæ™¯ä¸­ï¼ŒåŒäº²å§”æ´¾æ¨¡å‹å¯èƒ½ä¼šå—é™ã€‚</li><li>ä¸é€‚åˆæŸäº›ç±»åŠ è½½åœºæ™¯ï¼šåœ¨æŸäº›åœºæ™¯ä¸­ï¼ŒåŒäº²å§”æ´¾æ¨¡å‹å¯èƒ½å¹¶ä¸é€‚åˆï¼Œä¾‹å¦‚åœ¨OSGiï¼ˆOpen Service Gateway Initiativeï¼‰ç­‰åŠ¨æ€æ¨¡å—åŒ–ç³»ç»Ÿä¸­ï¼Œéœ€è¦å®ç°æ›´ä¸ºå¤æ‚çš„ç±»åŠ è½½ç­–ç•¥ï¼Œè€ŒåŒäº²å§”æ´¾æ¨¡å‹å¯èƒ½ä¸è¶³ä»¥æ»¡è¶³éœ€æ±‚ã€‚</li><li>ç±»å†²çªï¼šåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œç”±äºåŒäº²å§”æ´¾æ¨¡å‹çš„å­˜åœ¨ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç±»çš„å†²çªé—®é¢˜ã€‚ä¾‹å¦‚ï¼Œå¦‚æœåº”ç”¨ç¨‹åºä¸­å­˜åœ¨å¤šä¸ªç‰ˆæœ¬çš„åŒä¸€ä¸ªç±»ï¼Œå¹¶ä¸”ä½¿ç”¨äº†ä¸åŒçš„ç±»åŠ è½½å™¨åŠ è½½ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç±»åŠ è½½å†²çªï¼Œä»è€Œå¯¼è‡´ç¨‹åºå‡ºç°é”™è¯¯æˆ–å¼‚å¸¸ã€‚</li><li>æ€§èƒ½å¼€é”€ï¼šç”±äºæ¯æ¬¡ç±»åŠ è½½éƒ½ä¼šå§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨ï¼Œè¿™å¯èƒ½å¯¼è‡´å¤šå±‚çº§çš„ç±»åŠ è½½é“¾ï¼Œä»è€Œå¢åŠ äº†ç±»åŠ è½½çš„æ—¶é—´å’Œæ€§èƒ½å¼€é”€ã€‚ç‰¹åˆ«æ˜¯åœ¨æŸäº›å¤§å‹å¤æ‚çš„åº”ç”¨ç¨‹åºä¸­ï¼Œå¯èƒ½ä¼šå‡ºç°ç±»åŠ è½½æ€§èƒ½ç“¶é¢ˆã€‚</li></ol><p><strong>å¦‚ä½•æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹</strong></p><p>åœ¨Javaä¸­ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‡ ç§æ–¹å¼æ¥æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹ï¼Œå®ç°è‡ªå®šä¹‰çš„ç±»åŠ è½½è¡Œä¸ºï¼š</p><ol><li>è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼šå¯ä»¥ç»§æ‰¿java.lang.ClassLoaderç±»ï¼Œå¹¶å®ç°è‡ªå®šä¹‰çš„ç±»åŠ è½½é€»è¾‘ï¼Œä»è€Œç»•è¿‡åŒäº²å§”æ´¾æ¨¡å‹ã€‚<strong>é€šè¿‡é‡å†™ClassLoaderçš„loadClass()æ–¹æ³•ï¼Œå¯ä»¥åœ¨ç±»åŠ è½½è¿‡ç¨‹ä¸­è‡ªå®šä¹‰åŠ è½½è§„åˆ™</strong>ï¼Œä¾‹å¦‚å…ˆå°è¯•è‡ªå®šä¹‰åŠ è½½ï¼Œå¦‚æœå¤±è´¥å†å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨ã€‚</li><li>ä½¿ç”¨Javaçš„æ‰©å±•ç±»åŠ è½½å™¨ï¼š<strong>Javaçš„æ‰©å±•ç±»åŠ è½½å™¨ï¼ˆExtension ClassLoaderï¼‰å¹¶ä¸éµå¾ªåŒäº²å§”æ´¾æ¨¡å‹ï¼Œå®ƒåœ¨åŠ è½½Javaæ‰©å±•åº“æ—¶ä¸ä¼šå§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨</strong>ã€‚å› æ­¤ï¼Œå¯ä»¥å°†è‡ªå®šä¹‰çš„ç±»æ”¾ç½®åœ¨Javaæ‰©å±•åº“ä¸­ï¼Œå¹¶ä½¿ç”¨æ‰©å±•ç±»åŠ è½½å™¨åŠ è½½è¿™äº›ç±»ï¼Œä»è€Œå®ç°å¯¹åŒäº²å§”æ´¾æ¨¡å‹çš„ç»•è¿‡ã€‚</li><li>ä½¿ç”¨çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼šJavaä¸­çš„çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼ˆThread Context ClassLoaderï¼‰æ˜¯ä¸€ç§ç‰¹æ®Šçš„ç±»åŠ è½½å™¨ï¼Œå¯ä»¥åœ¨ç¨‹åºè¿è¡Œæ—¶åŠ¨æ€è®¾ç½®ï¼Œä»è€Œåœ¨æŸä¸ªç‰¹å®šçº¿ç¨‹ä¸­ç»•è¿‡åŒäº²å§”æ´¾æ¨¡å‹ã€‚é€šè¿‡è®¾ç½®çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼Œå¯ä»¥ä½¿ç‰¹å®šçº¿ç¨‹åŠ è½½æŒ‡å®šçš„ç±»ï¼Œè€Œä¸å—åŒäº²å§”æ´¾æ¨¡å‹çš„é™åˆ¶ã€‚</li></ol><h4 id="loadClass-å’Œ-findClass-æœ‰ä»€ä¹ˆåŒºåˆ«"><a href="#loadClass-å’Œ-findClass-æœ‰ä»€ä¹ˆåŒºåˆ«" class="headerlink" title="loadClass å’Œ findClass() æœ‰ä»€ä¹ˆåŒºåˆ«"></a><code>loadClass</code> å’Œ <code>findClass()</code> æœ‰ä»€ä¹ˆåŒºåˆ«</h4><table><thead><tr><th align="left"><strong>ç‰¹æ€§</strong></th><th align="left"><code>loadClass()</code></th><th align="left"><code>findClass()</code></th></tr></thead><tbody><tr><td align="left"><strong>èŒè´£</strong></td><td align="left">æ§åˆ¶åŠ è½½æµç¨‹ï¼ˆå§”æ´¾æœºåˆ¶ï¼‰</td><td align="left">å®ç°å…·ä½“åŠ è½½é€»è¾‘</td></tr><tr><td align="left"><strong>é‡å†™å¿…è¦æ€§</strong></td><td align="left">é€šå¸¸ä¸é‡å†™ï¼ˆä¿æŒå§”æ´¾æ¨¡å‹ï¼‰</td><td align="left">è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ—¶<strong>å¿…é¡»é‡å†™</strong></td></tr><tr><td align="left"><strong>åŒäº²å§”æ´¾è§’è‰²</strong></td><td align="left">å®ç°å§”æ´¾é€»è¾‘</td><td align="left">è¢«å§”æ´¾æœºåˆ¶è°ƒç”¨</td></tr><tr><td align="left"><strong>å…¸å‹ç”¨é€”</strong></td><td align="left">ç±»åŠ è½½å…¥å£ï¼ˆ<code>ClassLoader.loadClass()</code>ï¼‰</td><td align="left">è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ—¶æ‰©å±•èµ„æºè·å–æ–¹å¼</td></tr></tbody></table><p><strong>æœ€ä½³å®è·µ</strong></p><ol><li><p><strong>è‡ªå®šä¹‰ç±»åŠ è½½å™¨</strong>ï¼š<br>åªéœ€é‡å†™ <code>findClass()</code>ï¼ˆä¿æŒåŒäº²å§”æ´¾ï¼‰ï¼Œ<strong>æ— éœ€</strong>é‡å†™ <code>loadClass()</code>ã€‚</p><p>java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class CustomLoader extends ClassLoader &#123;</span><br><span class="line">    @Override</span><br><span class="line">    protected Class&lt;?&gt; findClass(String name) &#123;</span><br><span class="line">        // è‡ªå®šä¹‰åŠ è½½é€»è¾‘</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong>ç ´ååŒäº²å§”æ´¾</strong>ï¼š<br>éœ€é‡å†™ <code>loadClass()</code>ï¼ˆè°¨æ…ä½¿ç”¨ï¼Œå¦‚ JDBC&#x2F;JNDI ç­‰åœºæ™¯ï¼‰ã€‚</p></li></ol><img src="/post/7992e236/image-20250725203542235.png" class="" title="image-20250725203542235"><p><code>loadClass()</code> æ˜¯æ¡†æ¶æµç¨‹æ§åˆ¶è€…ï¼Œ<code>findClass()</code> æ˜¯å®é™…åŠ è½½é€»è¾‘çš„å®ç°è€…ã€‚è‡ªå®šä¹‰ç±»åŠ è½½ä¼˜å…ˆæ‰©å±• <code>findClass()</code>ã€‚</p><h3 id="å†…å­˜ç»“æ„"><a href="#å†…å­˜ç»“æ„" class="headerlink" title="å†…å­˜ç»“æ„"></a>å†…å­˜ç»“æ„</h3><h4 id="JVM-çš„æ–°ç”Ÿä»£åˆ’ä¸ºä»€ä¹ˆåˆ†ä¸ºä¸€ä¸ª-Eden-åŒºå’Œä¸¤ä¸ª-Survivor-åŒº"><a href="#JVM-çš„æ–°ç”Ÿä»£åˆ’ä¸ºä»€ä¹ˆåˆ†ä¸ºä¸€ä¸ª-Eden-åŒºå’Œä¸¤ä¸ª-Survivor-åŒº" class="headerlink" title="JVM çš„æ–°ç”Ÿä»£åˆ’ä¸ºä»€ä¹ˆåˆ†ä¸ºä¸€ä¸ª Eden åŒºå’Œä¸¤ä¸ª Survivor åŒº"></a>JVM çš„æ–°ç”Ÿä»£åˆ’ä¸ºä»€ä¹ˆåˆ†ä¸ºä¸€ä¸ª Eden åŒºå’Œä¸¤ä¸ª Survivor åŒº</h4><p>JVM çš„æ–°ç”Ÿä»£åˆ’åˆ†ä¸ºä¸€ä¸ª Eden åŒºå’Œä¸¤ä¸ª Survivor åŒºï¼ˆé€šå¸¸ç§°ä¸º S0 å’Œ S1ï¼Œæˆ–è€… From Survivor å’Œ To Survivorï¼‰ï¼Œä¸»è¦æ˜¯ä¸ºäº†<strong>é«˜æ•ˆåœ°ç®¡ç†çŸ­æš‚å­˜æ´»çš„å¯¹è±¡ï¼Œå¹¶ä¼˜åŒ–åƒåœ¾å›æ”¶ï¼ˆå°¤å…¶æ˜¯ Minor GCï¼‰çš„æ€§èƒ½</strong>ã€‚è¿™ç§è®¾è®¡æ ¸å¿ƒåœ¨äºåˆ©ç”¨äº†<strong>å¤åˆ¶ç®—æ³•</strong>çš„ä¼˜åŠ¿ï¼ŒåŒæ—¶è§£å†³äº†å¤åˆ¶ç®—æ³•åœ¨å•å— Survivor ç©ºé—´ä¸‹çš„ä¸»è¦é—®é¢˜ã€‚</p><p>ä»¥ä¸‹æ˜¯è¯¦ç»†çš„åŸå› åˆ†æï¼š</p><ol><li><strong>åˆ©ç”¨åˆ†ä»£å‡è¯´ï¼ˆGenerational Hypothesisï¼‰</strong>ï¼š<ul><li>ç»å¤§å¤šæ•°å¯¹è±¡éƒ½æ˜¯â€œæœç”Ÿå¤•æ­»â€çš„ï¼Œåœ¨åˆ†é…åå¾ˆå¿«å˜å¾—ä¸å¯è¾¾ã€‚</li><li>Eden åŒºæ˜¯å¯¹è±¡<strong>è¯ç”Ÿ</strong>çš„åœ°æ–¹ã€‚å‡ ä¹æ‰€æœ‰æ–°å¯¹è±¡éƒ½åœ¨ Eden åŒºåˆ†é…ã€‚</li><li>å°†æ–°ç”Ÿä»£çš„å¤§éƒ¨åˆ†ç©ºé—´åˆ†é…ç»™ Eden åŒºï¼ˆé»˜è®¤æ¯”ä¾‹é€šå¸¸æ˜¯ 8:1:1ï¼‰ï¼Œå¯ä»¥å®¹çº³å¤§é‡æ–°åˆ›å»ºçš„å¯¹è±¡ï¼Œå‡å°‘é¢‘ç¹è§¦å‘ Minor GCã€‚</li></ul></li><li><strong>é«˜æ•ˆå®æ–½å¤åˆ¶ç®—æ³•ï¼ˆCopying Algorithmï¼‰</strong>ï¼š<ul><li>æ–°ç”Ÿä»£åƒåœ¾å›æ”¶ï¼ˆMinor GCï¼‰ä¸»è¦ä½¿ç”¨<strong>å¤åˆ¶ç®—æ³•</strong>ã€‚è¯¥ç®—æ³•çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šå°†å­˜æ´»çš„å¯¹è±¡ä»ä¸€ä¸ªå†…å­˜åŒºåŸŸå¤åˆ¶åˆ°å¦ä¸€ä¸ªç©ºçš„å†…å­˜åŒºåŸŸï¼Œç„¶åä¸€æ¬¡æ€§æ¸…ç†æ‰åŸåŒºåŸŸçš„æ•´ä¸ªç©ºé—´ã€‚</li><li><strong>ä¼˜ç‚¹</strong>ï¼šç®€å•é«˜æ•ˆï¼Œæ²¡æœ‰å†…å­˜ç¢ç‰‡ï¼Œå›æ”¶é€Ÿåº¦å¿«ï¼ˆåªéœ€è¦ç§»åŠ¨å­˜æ´»å¯¹è±¡ï¼Œä¸éœ€è¦æ‰«æå’Œæ ‡è®°æ­»äº¡å¯¹è±¡ï¼‰ã€‚</li><li><strong>å…³é”®éœ€æ±‚</strong>ï¼šå¤åˆ¶ç®—æ³•éœ€è¦ä¸€ä¸ª<strong>å®Œå…¨ç©ºé—²çš„ç›®æ ‡åŒºåŸŸ</strong>æ¥æ¥æ”¶å­˜æ´»å¯¹è±¡ã€‚</li></ul></li><li><strong>è§£å†³å•å— Survivor ç©ºé—´çš„é—®é¢˜ï¼ˆæ ¸å¿ƒåŸå› ï¼‰</strong>ï¼š<ul><li>å‡è®¾åªæœ‰ä¸€ä¸ª Survivor åŒºï¼ˆSï¼‰ã€‚ä¸€æ¬¡ Minor GC åï¼š<ol><li>Eden åŒºå­˜æ´»çš„å¯¹è±¡éœ€è¦å¤åˆ¶åˆ° S åŒºã€‚</li><li>æ­¤æ—¶ S åŒºå¯èƒ½å·²ç»å­˜æ”¾äº†ä¸Šæ¬¡ GC å­˜æ´»ä¸‹æ¥çš„å¯¹è±¡ï¼ˆå¹´é¾„å°äºæ™‹å‡é˜ˆå€¼çš„ï¼‰ã€‚</li><li>ç°åœ¨éœ€è¦å°† Eden + S åŒºçš„æ‰€æœ‰å­˜æ´»å¯¹è±¡éƒ½å¤åˆ¶åˆ°ä¸€ä¸ªåœ°æ–¹ã€‚å¦‚æœåªæœ‰ä¸€ä¸ª S åŒºï¼Œé‚£ä¹ˆ<strong>è¿™ä¸ª S åŒºæ—¢æ˜¯æºåˆæ˜¯ç›®æ ‡</strong>ï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸å¯èƒ½çš„ï¼ˆæºæ•°æ®ä¼šè¢«è¦†ç›–ï¼‰ã€‚</li></ol></li><li>å³ä½¿å¿½ç•¥ä¸Šé¢çš„é€»è¾‘çŸ›ç›¾ï¼Œå¦‚æœåªæœ‰ä¸€ä¸ªè¾ƒå¤§çš„ Survivor åŒºï¼Œæ¯æ¬¡ GC æ—¶éƒ½éœ€è¦å°†å…¶ä¸­çš„å­˜æ´»å¯¹è±¡å’Œ Eden çš„å­˜æ´»å¯¹è±¡ä¸€èµ·å¤åˆ¶åˆ°å¦ä¸€ä¸ªåœ°æ–¹ï¼ˆæ¯”å¦‚è€å¹´ä»£ï¼‰ï¼Œè¿™ä¼šï¼š<ul><li><strong>å¯¼è‡´å¯¹è±¡è¿‡æ—©æ™‹å‡</strong>ï¼šå¾ˆå¤šæœ¬åº”åœ¨æ–°ç”Ÿä»£ç»å†å‡ æ¬¡ GC æ‰æ­»äº¡çš„å¯¹è±¡ï¼Œå› ä¸º Survivor ç©ºé—´ä¸è¶³ï¼ˆæˆ–è®¾è®¡é™åˆ¶ï¼‰è¢«ç›´æ¥æå‡åˆ°è€å¹´ä»£ï¼Œå¢åŠ äº†è€å¹´ä»£ GC çš„å‹åŠ›ã€‚</li><li><strong>é™ä½å¤åˆ¶ç®—æ³•æ•ˆç‡</strong>ï¼šæ— æ³•åˆ©ç”¨ Survivor åŒºæ¥æš‚å­˜å­˜æ´»å¯¹è±¡è¿›è¡Œå¤šæ¬¡ç­›é€‰ã€‚</li><li><strong>å¢åŠ å†…å­˜ç¢ç‰‡</strong>ï¼šå¦‚æœå¤åˆ¶åˆ°è€å¹´ä»£ï¼Œè€å¹´ä»£ä½¿ç”¨çš„é€šå¸¸æ˜¯æ ‡è®°-æ¸…é™¤æˆ–æ ‡è®°-æ•´ç†ç®—æ³•ï¼Œæ›´å®¹æ˜“äº§ç”Ÿç¢ç‰‡ã€‚</li></ul></li></ul></li><li><strong>åŒ Survivor åŒºçš„è§£å†³æ–¹æ¡ˆï¼ˆè½®è½¬å¤åˆ¶ï¼‰</strong>ï¼š<ul><li>è®¾è®¡ä¸¤ä¸ªè¾ƒå°çš„ Survivor åŒºï¼ˆS0 å’Œ S1ï¼Œé€šå¸¸å„å æ–°ç”Ÿä»£çš„ 10%ï¼Œä¸ Eden çš„ 80% æ„æˆ 8:1:1ï¼‰ã€‚</li><li>åœ¨ä»»ä½•æ—¶å€™ï¼Œ<strong>æ€»æœ‰ä¸€ä¸ª Survivor åŒºæ˜¯ç©ºçš„ï¼ˆTo Survivorï¼‰</strong>ã€‚</li><li><strong>Minor GC è¿‡ç¨‹</strong>ï¼š<ol><li><strong>æ ‡è®°</strong>ï¼šæ ‡è®° Eden åŒºå’Œå½“å‰éç©ºçš„ Survivor åŒºï¼ˆFrom Survivorï¼Œå‡è®¾æ˜¯ S0ï¼‰ä¸­æ‰€æœ‰å­˜æ´»çš„å¯¹è±¡ã€‚</li><li><strong>å¤åˆ¶</strong>ï¼šå°†æ‰€æœ‰å­˜æ´»çš„å¯¹è±¡<strong>å¤åˆ¶</strong>åˆ°ç©ºçš„ Survivor åŒºï¼ˆTo Survivorï¼Œå‡è®¾æ˜¯ S1ï¼‰ã€‚åœ¨å¤åˆ¶è¿‡ç¨‹ä¸­ï¼š<ul><li>å¯¹è±¡çš„<strong>å¹´é¾„ï¼ˆAgeï¼‰</strong> ä¼šå¢åŠ  1ã€‚</li><li>å¦‚æœæŸä¸ªå¯¹è±¡çš„å¹´é¾„è¾¾åˆ°äº†è®¾å®šçš„é˜ˆå€¼ï¼ˆé»˜è®¤ä¸º 15ï¼Œå¯é€šè¿‡ <code>-XX:MaxTenuringThreshold</code> è°ƒæ•´ï¼‰ï¼Œæˆ–è€… To Survivor åŒºç©ºé—´ä¸è¶³ä»¥å®¹çº³æ‰€æœ‰å­˜æ´»å¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡ä¼šè¢«ç›´æ¥<strong>æ™‹å‡ï¼ˆPromoteï¼‰</strong> åˆ°è€å¹´ä»£ã€‚</li></ul></li><li><strong>æ¸…ç©º</strong>ï¼šä¸€æ¬¡æ€§æ¸…ç©º Eden åŒºå’Œåˆšåˆšä½œä¸ºæ¥æºçš„ Survivor åŒºï¼ˆS0ï¼‰ã€‚</li><li><strong>è§’è‰²äº’æ¢</strong>ï¼šç°åœ¨ S1 æˆä¸ºäº†å­˜æ”¾å­˜æ´»å¯¹è±¡çš„ From Survivorï¼Œè€Œæ¸…ç©ºçš„ S0 åˆ™æˆä¸ºä¸‹ä¸€æ¬¡ GC çš„ To Survivorï¼ˆå³ç©ºçš„ Survivorï¼‰ã€‚</li></ol></li><li><strong>å…³é”®ä¼˜åŠ¿</strong>ï¼š<ul><li><strong>å§‹ç»ˆæœ‰ç©ºçš„ To Survivor</strong>ï¼šä¸ºå¤åˆ¶ç®—æ³•æä¾›äº†å¿…éœ€çš„ç›®æ ‡ç©ºé—´ã€‚</li><li><strong>å¯¹è±¡å¹´é¾„å¢é•¿</strong>ï¼šåœ¨ä¸¤ä¸ª Survivor åŒºä¹‹é—´å¤šæ¬¡å¤åˆ¶ï¼ˆMinor GCï¼‰çš„è¿‡ç¨‹ï¼Œè‡ªç„¶åœ°å®ç°äº†å¯¹è±¡å¹´é¾„çš„å¢é•¿ï¼Œä¸ºåŸºäºå¹´é¾„çš„æ™‹å‡ç­–ç•¥æä¾›äº†åŸºç¡€ã€‚</li><li><strong>å»¶è¿Ÿæ™‹å‡</strong>ï¼šå¤§éƒ¨åˆ†å¯¹è±¡ä¼šåœ¨ Eden å’Œ Survivor åŒºä¹‹é—´ç»å†å‡ æ¬¡ GC åè¢«å›æ”¶æ‰ï¼Œåªæœ‰çœŸæ­£â€œé•¿å¯¿â€çš„å¯¹è±¡æ‰ä¼šæ™‹å‡åˆ°è€å¹´ä»£ï¼Œå‡å°‘äº†è€å¹´ä»£ GC çš„å‹åŠ›ã€‚</li><li><strong>é¿å…ç¢ç‰‡</strong>ï¼šå¤åˆ¶ç®—æ³•ä¿è¯äº† Survivor åŒºå†…æ€»æ˜¯ç´§å‡‘æ’åˆ—çš„å­˜æ´»å¯¹è±¡ï¼Œæ²¡æœ‰å†…å­˜ç¢ç‰‡ã€‚</li><li><strong>é«˜æ•ˆå›æ”¶ Eden</strong>ï¼šåªéœ€ç®€å•åœ°æ¸…ç©ºæ•´ä¸ª Eden åŒºï¼Œå›æ”¶é€Ÿåº¦æå¿«ã€‚</li></ul></li></ul></li><li><strong>ç©ºé—´åˆ©ç”¨ç‡ä¸æƒè¡¡</strong>ï¼š<ul><li>ä¸¤ä¸ªè¾ƒå°çš„ Survivor åŒºï¼ˆå„ 10%ï¼‰ç›¸æ¯”ä¸€ä¸ªè¾ƒå¤§çš„ Survivor åŒºï¼ˆæ¯”å¦‚ 20%ï¼‰ï¼Œåœ¨ç©ºé—´åˆ©ç”¨ç‡ä¸Šä¼¼ä¹æœ‰æŸå¤±ï¼ˆæ€»æœ‰ 10% æ˜¯ç©ºçš„ï¼‰ã€‚</li><li>ä½†è¿™ç§ç‰ºç‰²æ˜¯å€¼å¾—çš„ï¼š<ul><li>å®ƒæ¢æ¥äº†å¤åˆ¶ç®—æ³•çš„æ ¸å¿ƒä¼˜åŠ¿ï¼ˆæ— ç¢ç‰‡ã€é«˜æ•ˆå›æ”¶ Edenï¼‰ã€‚</li><li>å®ƒæœ‰æ•ˆå®ç°äº†åŸºäºå¹´é¾„çš„å¯¹è±¡ç­›é€‰ï¼Œå¤§å¤§å‡å°‘äº†ä¸å¿…è¦çš„æ™‹å‡ã€‚</li><li>ç©ºç€çš„é‚£ä¸ª Survivor åŒºæ˜¯ç®—æ³•è¿è¡Œçš„å¿…è¦æ¡ä»¶ï¼Œä¸èƒ½ç®—æµªè´¹ã€‚</li></ul></li></ul></li></ol><p><strong>æ€»ç»“ï¼š</strong></p><p>å°†æ–°ç”Ÿä»£åˆ’åˆ†ä¸ºä¸€ä¸ªè¾ƒå¤§çš„ Eden åŒºå’Œä¸¤ä¸ªè¾ƒå°çš„ Survivor åŒºï¼ˆS0 å’Œ S1ï¼‰ï¼Œæ˜¯ä¸ºäº†å®Œç¾é€‚é…<strong>å¤åˆ¶ç®—æ³•</strong>è¿›è¡Œé«˜æ•ˆçš„ Minor GCï¼š</p><ol><li><strong>Eden åŒº</strong>ï¼šå®¹çº³å¤§é‡æ–°åˆ›å»ºçš„å¯¹è±¡ï¼Œåˆ©ç”¨â€œå¯¹è±¡æœç”Ÿå¤•æ­»â€çš„ç‰¹æ€§ã€‚</li><li><strong>åŒ Survivor åŒºï¼ˆS0 &amp; S1ï¼‰</strong>ï¼šæä¾›è½®è½¬æœºåˆ¶ã€‚<ul><li>ç¡®ä¿<strong>å§‹ç»ˆæœ‰ä¸€ä¸ªç©ºçš„ Survivorï¼ˆToï¼‰</strong> ä½œä¸ºå¤åˆ¶ç®—æ³•çš„ç›®æ ‡åŒºåŸŸã€‚</li><li>åœ¨ Eden å’Œ From Survivor çš„å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ° To Survivor çš„è¿‡ç¨‹ä¸­ï¼š<ul><li>å®ç°<strong>å¯¹è±¡å¹´é¾„å¢é•¿</strong>ã€‚</li><li>ç­›é€‰å‡ºè¾¾åˆ°å¹´é¾„é˜ˆå€¼æˆ–ç©ºé—´ä¸è¶³çš„å¯¹è±¡<strong>æ™‹å‡åˆ°è€å¹´ä»£</strong>ã€‚</li></ul></li><li>å¤åˆ¶å®Œæˆåï¼Œä¸€æ¬¡æ€§æ¸…ç©º Eden å’Œ From Survivorï¼Œäº¤æ¢ From&#x2F;To è§’è‰²ã€‚</li><li>é¿å…äº†å• Survivor åŒºçš„é€»è¾‘çŸ›ç›¾ã€è¿‡æ—©æ™‹å‡å’Œç¢ç‰‡é—®é¢˜ã€‚</li></ul></li></ol><p>è¿™ç§è®¾è®¡æ˜¯ HotSpot JVMï¼ˆä»¥åŠå…¶ä»–è®¸å¤š JVMï¼‰å®ç°é«˜æ•ˆæ–°ç”Ÿä»£åƒåœ¾å›æ”¶çš„åŸºçŸ³ã€‚è™½ç„¶ç°ä»£åƒåœ¾æ”¶é›†å™¨ï¼ˆå¦‚ G1, ZGC, Shenandoahï¼‰åœ¨å†…å­˜å¸ƒå±€ä¸Šæœ‰æ‰€ä¸åŒï¼Œä½†å®ƒä»¬è§£å†³æ–°ç”Ÿä»£å¯¹è±¡ç®¡ç†çš„æ ¸å¿ƒæ€æƒ³ï¼ˆå¿«é€Ÿåˆ†é…ã€é«˜æ•ˆå›æ”¶çŸ­æš‚å¯¹è±¡ã€å»¶è¿Ÿæ™‹å‡ï¼‰ä»ç„¶æ˜¯ç›¸é€šçš„ï¼ŒåŒ Survivor åŒºçš„è®¾è®¡å¾ˆå¥½åœ°ä½“ç°äº†è¿™äº›åŸåˆ™ã€‚</p><h4 id="è¿è¡Œæ—¶å¸¸é‡æ± å’Œå­—ç¬¦ä¸²å¸¸é‡æ± æœ‰ä»€ä¹ˆåŒºåˆ«"><a href="#è¿è¡Œæ—¶å¸¸é‡æ± å’Œå­—ç¬¦ä¸²å¸¸é‡æ± æœ‰ä»€ä¹ˆåŒºåˆ«" class="headerlink" title="è¿è¡Œæ—¶å¸¸é‡æ± å’Œå­—ç¬¦ä¸²å¸¸é‡æ± æœ‰ä»€ä¹ˆåŒºåˆ«"></a>è¿è¡Œæ—¶å¸¸é‡æ± å’Œå­—ç¬¦ä¸²å¸¸é‡æ± æœ‰ä»€ä¹ˆåŒºåˆ«</h4><p>åœ¨JVMä¸­ï¼Œå¸¸é‡æ± åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š<strong>è¿è¡Œæ—¶å¸¸é‡æ± </strong>å’Œ<strong>å­—ç¬¦ä¸²å¸¸é‡æ± </strong>ï¼ˆString Poolï¼Œä¹Ÿç§°ä¸ºString Tableï¼‰ã€‚</p><ul><li><p><strong>è¿è¡Œæ—¶å¸¸é‡æ± </strong>ï¼šå±äºæ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†ã€‚åœ¨JDK1.7ä¹‹å‰ï¼Œæ–¹æ³•åŒºä½äºæ°¸ä¹…ä»£ï¼ˆPermGenï¼‰ä¸­ï¼›ä»JDK1.7å¼€å§‹ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± è¢«ç§»åŠ¨åˆ°å †ä¸­ï¼›è€Œåˆ°äº†JDK1.8ï¼Œæ°¸ä¹…ä»£è¢«å…ƒç©ºé—´ï¼ˆMetaspaceï¼‰å–ä»£ï¼Œè¿è¡Œæ—¶å¸¸é‡æ± ä¹Ÿéšä¹‹ç§»åˆ°äº†å…ƒç©ºé—´ã€‚ä½†æ˜¯ï¼Œå…ƒç©ºé—´å¹¶ä¸åœ¨è™šæ‹Ÿæœºå†…å­˜ä¸­ï¼Œè€Œæ˜¯ä½¿ç”¨æœ¬åœ°å†…å­˜ã€‚</p></li><li><p><strong>å­—ç¬¦ä¸²å¸¸é‡æ± </strong>ï¼šåœ¨JDK1.7ä¹‹å‰ä½äºæ–¹æ³•åŒºï¼ˆæ°¸ä¹…ä»£ï¼‰ï¼Œä»JDK1.7å¼€å§‹è¢«ç§»åŠ¨åˆ°å †ä¸­ï¼ˆHeapï¼‰ã€‚æ‰€ä»¥ï¼Œåœ¨JDK1.7åŠä¹‹åçš„ç‰ˆæœ¬ä¸­ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± ä½äºå †å†…å­˜ä¸­ã€‚</p></li></ul><p>å› æ­¤ï¼Œé’ˆå¯¹ä¸åŒç‰ˆæœ¬çš„JDKï¼Œå¸¸é‡æ± çš„ä½ç½®æœ‰æ‰€ä¸åŒï¼š</p><ul><li><p>JDK1.6åŠä¹‹å‰ï¼šè¿è¡Œæ—¶å¸¸é‡æ± ï¼ˆåŒ…æ‹¬å­—ç¬¦ä¸²å¸¸é‡æ± ï¼‰åœ¨æ–¹æ³•åŒºï¼ˆæ°¸ä¹…ä»£ï¼‰ã€‚</p></li><li><p>JDK1.7ï¼šè¿è¡Œæ—¶å¸¸é‡æ± ä»åœ¨æ–¹æ³•åŒºï¼ˆä½†æ–¹æ³•åŒºå¼€å§‹é€æ­¥ç§»é™¤æ°¸ä¹…ä»£ï¼Œä½¿ç”¨å…ƒç©ºé—´çš„å‰èº«ï¼‰ï¼Œè€Œå­—ç¬¦ä¸²å¸¸é‡æ± è¢«ç§»åŠ¨åˆ°å †ä¸­ã€‚</p></li><li><p>JDK1.8åŠä¹‹åï¼šè¿è¡Œæ—¶å¸¸é‡æ± åœ¨å…ƒç©ºé—´ï¼ˆMetaspaceï¼Œä½¿ç”¨æœ¬åœ°å†…å­˜ï¼‰ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± åœ¨å †ä¸­ã€‚</p></li></ul><p>StringTable åœ¨ jdk1.6 ä¹‹å‰ï¼Œæ˜¯æ–¹æ³•åŒºä¸­è¿è¡Œæ—¶å¸¸é‡æ± çš„ä¸€éƒ¨åˆ†ï¼Œ jdk1.7 ä¹‹åç§»åˆ°äº†å †ä¸­ã€‚</p><p>åœ¨ jdk1.6 ä¹‹å‰ï¼Œfull GC æ‰ä¼šè§¦å‘æ°¸ä¹…ä»£çš„åƒåœ¾å›æ”¶ï¼Œå›æ”¶æ•ˆç‡å¾ˆä½ï¼Œå¦‚æœæœ‰å¤§é‡å­—ç¬¦ä¸²æ”¾å…¥ StringTableï¼Œå®¹æ˜“å¯¼è‡´æ°¸ä¹…ä»£å†…å­˜æº¢å‡ºã€‚</p><p>StringTable æ”¾å…¥å †ä¸­ä¹‹åï¼Œåªè¦æœ‰ minor GCï¼Œå°±ä¼šè§¦å‘ StringTable çš„åƒåœ¾å›æ”¶ï¼Œå‡å°‘äº†æ— ç”¨å­—ç¬¦ä¸²å¸¸é‡å¯¹å†…å­˜çš„å ç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// jdk8</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StringPool</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">s1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;a&quot;</span>) + <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;b&quot;</span>); <span class="comment">// s1 æŒ‡å‘å †ä¸­çš„ &quot;ab&quot;</span></span><br><span class="line">        s1.intern(); <span class="comment">// åœ¨ StringTable ä¸­æ”¾å…¥å †ä¸­ &quot;ab&quot; çš„åœ°å€</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">s2</span> <span class="operator">=</span> <span class="string">&quot;ab&quot;</span>; <span class="comment">// s2 å­˜çš„åœ°å€å°±æ˜¯ StringTable ä¸­æŒ‡å‘å †ä¸­ &quot;ab&quot; çš„åœ°å€ï¼Œå³ s2 ä¹ŸæŒ‡å‘å †ä¸­çš„ &quot;ab&quot;</span></span><br><span class="line">        System.out.println(s1 == s2); <span class="comment">// true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// jdk6</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StringPool</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">s1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;a&quot;</span>) + <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;b&quot;</span>); <span class="comment">// s1 æŒ‡å‘å †ä¸­çš„ &quot;ab&quot;</span></span><br><span class="line">        s1.intern(); <span class="comment">// åœ¨ StringTable åˆ›å»º &quot;ab&quot;</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">s2</span> <span class="operator">=</span> <span class="string">&quot;ab&quot;</span>; <span class="comment">// s2 æŒ‡å‘ StringTable ä¸­çš„ &quot;ab&quot;</span></span><br><span class="line">        System.out.println(s1 == s2); <span class="comment">// false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="String-s-new-String-a-new-String-a-ä¸€å…±åˆ›å»ºå‡ ä¸ªå¯¹è±¡"><a href="#String-s-new-String-a-new-String-a-ä¸€å…±åˆ›å»ºå‡ ä¸ªå¯¹è±¡" class="headerlink" title="String s = new String(&quot;a&quot;) + new String(&quot;a&quot;) ä¸€å…±åˆ›å»ºå‡ ä¸ªå¯¹è±¡"></a><code>String s = new String(&quot;a&quot;) + new String(&quot;a&quot;)</code> ä¸€å…±åˆ›å»ºå‡ ä¸ªå¯¹è±¡</h4><h4 id="ä»€ä¹ˆæƒ…å†µä¸‹ä¼šè§¦å‘StackOverflowErrorå’ŒOutOfMemoryError"><a href="#ä»€ä¹ˆæƒ…å†µä¸‹ä¼šè§¦å‘StackOverflowErrorå’ŒOutOfMemoryError" class="headerlink" title="ä»€ä¹ˆæƒ…å†µä¸‹ä¼šè§¦å‘StackOverflowErrorå’ŒOutOfMemoryError"></a>ä»€ä¹ˆæƒ…å†µä¸‹ä¼šè§¦å‘StackOverflowErrorå’ŒOutOfMemoryError</h4><p><strong>è§¦å‘StackOverflowError</strong></p><ul><li><p><strong>æ— é™é€’å½’</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public class StackOverflowExample &#123;</span><br><span class="line">    public static void recursiveMethod() &#123;</span><br><span class="line">        recursiveMethod(); // æ— é™é€’å½’è°ƒç”¨</span><br><span class="line">    &#125;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        recursiveMethod(); // è§¦å‘StackOverflowError</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯æ¬¡æ–¹æ³•è°ƒç”¨éƒ½ä¼šåœ¨è™šæ‹Ÿæœºæ ˆä¸­å‹å…¥æ–°æ ˆå¸§ï¼Œè¶…å‡ºæ ˆçš„æœ€å¤§æ·±åº¦é™åˆ¶ï¼ˆé»˜è®¤1MBï¼Œå¯é€šè¿‡<code>-Xss</code>è°ƒæ•´ï¼‰ã€‚</p></li><li><p>æ ˆå¸§è¿‡å¤§ï¼ˆå±€éƒ¨å˜é‡è¿‡å¤šæˆ–æ–¹æ³•æ“ä½œæ•°æ ˆè¿‡æ·±ï¼‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public void largeMethod() &#123;</span><br><span class="line">    int a1, a2, a3, ..., a10000; // å¤§é‡å±€éƒ¨å˜é‡å ç”¨æ ˆç©ºé—´</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å•ä¸ªæ ˆå¸§å ç”¨çš„å†…å­˜è¶…è¿‡æ ˆå®¹é‡ã€‚</p></li></ul><p><strong>è§¦å‘OutOfMemoryError</strong></p><ul><li><p><strong>å †å†…å­˜æº¢å‡º</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// ä¸æ–­åˆ›å»ºå¤§å¯¹è±¡ï¼Œè€—å°½å †å†…å­˜</span><br><span class="line">List&lt;byte[]&gt; list = new ArrayList&lt;&gt;();</span><br><span class="line">while (true) &#123;</span><br><span class="line">    list.add(new byte[1024 * 1024]); // æ¯æ¬¡åˆ†é…1MB</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>åŸå› </strong>ï¼šå¯¹è±¡æ•°é‡è¶…è¿‡å †å®¹é‡ï¼ˆå¯é€šè¿‡<code>-Xmx</code>å’Œ<code>-Xms</code>è°ƒæ•´å †å¤§å°ï¼‰ã€‚</p><p><strong>å…¸å‹åœºæ™¯</strong>ï¼šå†…å­˜æ³„æ¼ï¼ˆå¦‚é™æ€é›†åˆæœªé‡Šæ”¾å¯¹è±¡ï¼‰æˆ–åˆç†å†…å­˜ä¸è¶³ã€‚</p></li><li><p><strong>æ–¹æ³•åŒº&#x2F;å…ƒç©ºé—´æº¢å‡º</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// åŠ¨æ€ç”Ÿæˆå¤§é‡ç±»ï¼ˆå¦‚ä½¿ç”¨CGLIBï¼‰</span><br><span class="line">public class MetaspaceOOM &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        Enhancer enhancer = new Enhancer();</span><br><span class="line">        enhancer.setSuperclass(OOMObject.class);</span><br><span class="line">        enhancer.setCallback((MethodInterceptor) (obj, method, args1, proxy) -&gt; proxy.invokeSuper(obj, args1));</span><br><span class="line">        while (true) &#123;</span><br><span class="line">            enhancer.create(); // æŒç»­ç”Ÿæˆä»£ç†ç±»</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    static class OOMObject &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>åŸå› </strong>ï¼šåŠ è½½çš„ç±»æ•°é‡æˆ–å…ƒæ•°æ®é‡è¶…è¿‡å…ƒç©ºé—´å®¹é‡ï¼ˆé€šè¿‡<code>-XX:MaxMetaspaceSize</code>è®¾ç½®ä¸Šé™ï¼‰ã€‚</p><p><strong>å…¸å‹åœºæ™¯</strong>ï¼šåŠ¨æ€ä»£ç†æ¡†æ¶ï¼ˆå¦‚Spring AOPï¼‰ã€åå°„æ»¥ç”¨ã€‚</p></li><li><p><strong>è™šæ‹Ÿæœºæ ˆæˆ–æœ¬åœ°æ–¹æ³•æ ˆæ— æ³•æ‰©å±•</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// å¯åŠ¨å¤§é‡çº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹çš„æ ˆç©ºé—´æ— æ³•åˆ†é…</span><br><span class="line">public class ThreadOOM &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        while (true) &#123;</span><br><span class="line">            new Thread(() -&gt; &#123;</span><br><span class="line">                try &#123; Thread.sleep(1000000); &#125; catch (InterruptedException e) &#123;&#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>åŸå› </strong>ï¼šçº¿ç¨‹æ•°é‡è¿‡å¤šå¯¼è‡´æ ˆæ€»å†…å­˜è¶…è¿‡ç³»ç»Ÿé™åˆ¶ï¼ˆé€šè¿‡<code>-Xss</code>å‡å°‘å•ä¸ªçº¿ç¨‹æ ˆå¤§å°ï¼‰ã€‚</p></li></ul><p><strong>æ€»ç»“</strong></p><table><thead><tr><th><strong>é”™è¯¯ç±»å‹</strong></th><th><strong>è§¦å‘åœºæ™¯</strong></th><th><strong>å…¸å‹åŸå› </strong></th><th><strong>è§£å†³æ–¹æ¡ˆ</strong></th></tr></thead><tbody><tr><td><strong>StackOverflowError</strong></td><td>é€’å½’è°ƒç”¨æœªç»ˆæ­¢ã€æ ˆå¸§è¿‡å¤§</td><td>ä»£ç é€»è¾‘é”™è¯¯</td><td>ä¿®å¤é€’å½’ç»ˆæ­¢æ¡ä»¶ï¼Œå‡å°‘å±€éƒ¨å˜é‡æ•°é‡</td></tr><tr><td><strong>OutOfMemoryError</strong></td><td>å †å†…å­˜ä¸è¶³ã€å…ƒç©ºé—´æº¢å‡ºã€çº¿ç¨‹æ•°è¿‡å¤š</td><td>å†…å­˜æ³„æ¼ã€é…ç½®ä¸å½“ã€èµ„æºè€—å°½</td><td>è°ƒæ•´JVMå‚æ•°ï¼Œä¼˜åŒ–ä»£ç ï¼Œå¢åŠ ç‰©ç†å†…å­˜</td></tr></tbody></table><h4 id="æ°¸ä¹…ä»£å’Œå…ƒç©ºé—´çš„åŒºåˆ«"><a href="#æ°¸ä¹…ä»£å’Œå…ƒç©ºé—´çš„åŒºåˆ«" class="headerlink" title="æ°¸ä¹…ä»£å’Œå…ƒç©ºé—´çš„åŒºåˆ«"></a>æ°¸ä¹…ä»£å’Œå…ƒç©ºé—´çš„åŒºåˆ«</h4><h4 id="å †å†…å­˜æ˜¯æ€ä¹ˆç»†åˆ†çš„"><a href="#å †å†…å­˜æ˜¯æ€ä¹ˆç»†åˆ†çš„" class="headerlink" title="å †å†…å­˜æ˜¯æ€ä¹ˆç»†åˆ†çš„"></a>å †å†…å­˜æ˜¯æ€ä¹ˆç»†åˆ†çš„</h4><h3 id="å†…å­˜æº¢å‡º"><a href="#å†…å­˜æº¢å‡º" class="headerlink" title="å†…å­˜æº¢å‡º"></a>å†…å­˜æº¢å‡º</h3><h4 id="å¦‚ä½•å®šä½å†…å­˜æº¢å‡ºé—®é¢˜"><a href="#å¦‚ä½•å®šä½å†…å­˜æº¢å‡ºé—®é¢˜" class="headerlink" title="å¦‚ä½•å®šä½å†…å­˜æº¢å‡ºé—®é¢˜"></a>å¦‚ä½•å®šä½å†…å­˜æº¢å‡ºé—®é¢˜</h4><p><strong>å¿«é€Ÿè¯†åˆ«ç—‡çŠ¶</strong></p><ol><li><strong>ç›‘æ§å‘Šè­¦</strong>ï¼š<ul><li>JVMï¼š<code>Heap usage &gt; 90%</code>ï¼Œé¢‘ç¹Full GCä½†å›æ”¶æ•ˆæœå·®ã€‚</li><li>ç³»ç»Ÿçº§ï¼š<code>top</code>&#x2F;<code>htop</code> æ˜¾ç¤ºè¿›ç¨‹å†…å­˜æŒç»­å¢é•¿ä¸é‡Šæ”¾ã€‚</li></ul></li><li><strong>é”™è¯¯æ—¥å¿—</strong>ï¼š<ul><li><code>java.lang.OutOfMemoryError: Java heap space</code>ï¼ˆå †æº¢å‡ºï¼‰</li><li><code>java.lang.OutOfMemoryError: Metaspace</code>ï¼ˆå…ƒç©ºé—´æº¢å‡ºï¼‰</li><li><code>java.lang.OutOfMemoryError: Unable to create new native thread</code>ï¼ˆçº¿ç¨‹æ•°è¶…é™ï¼‰</li></ul></li></ol><p><strong>è·å–å†…å­˜å¿«ç…§ï¼ˆHeap Dumpï¼‰</strong></p><blockquote><p><strong>å…³é”®åŠ¨ä½œï¼šåœ¨OOMå‘ç”Ÿæ—¶è‡ªåŠ¨ä¿å­˜Dumpï¼Œé¿å…é‡å¯åä¸¢å¤±ç°åœº</strong></p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># JVMå¯åŠ¨å‚æ•°æ·»åŠ </span></span><br><span class="line">-XX:+HeapDumpOnOutOfMemoryError </span><br><span class="line">-XX:HeapDumpPath=/path/to/dump.hprof</span><br></pre></td></tr></table></figure><p><strong>åˆ†æå †è½¬å‚¨æ–‡ä»¶ï¼ˆå…³é”®æ­¥éª¤ï¼‰</strong></p><ol><li><p><strong>Eclipse MAT (Memory Analyzer Tool)</strong></p><ul><li>ä¼˜åŠ¿ï¼šå¯è§†åŒ–åˆ†æï¼Œè‡ªåŠ¨æ£€æµ‹æ³„æ¼ç–‘ç‚¹ã€‚</li><li>æ­¥éª¤ï¼š<ul><li>æ‰“å¼€ <code>dump.hprof</code> æ–‡ä»¶ã€‚</li><li>æŸ¥çœ‹ <strong>Leak Suspects Report</strong>ï¼ˆæ³„æ¼å«Œç–‘å¯¹è±¡ï¼‰ã€‚</li><li>åˆ†æ <strong>Dominator Tree</strong> æ‰¾åˆ°å ç”¨æœ€å¤§çš„å¯¹è±¡ã€‚</li><li>æ£€æŸ¥ <strong>Path to GC Roots</strong> æŸ¥çœ‹å¼•ç”¨é“¾ã€‚</li></ul></li></ul></li><li><p><strong>VisualVM</strong></p><ul><li>é€‚ç”¨åœºæ™¯ï¼šå®æ—¶ç›‘æ§+ç¦»çº¿åˆ†æã€‚</li><li>åŠŸèƒ½ï¼šå †è½¬å‚¨çš„ <strong>Classes</strong> è§†å›¾æŒ‰å®ä¾‹æ•°æ’åºï¼Œå®šä½å¼‚å¸¸ç±»ã€‚</li></ul></li><li><p><strong>å‘½ä»¤è¡Œå·¥å…·ï¼ˆå¿«é€Ÿæ’æŸ¥ï¼‰</strong>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. æ£€æŸ¥å †å†…å¯¹è±¡ç»Ÿè®¡</span></span><br><span class="line">jmap -histo:live &lt;pid&gt; | <span class="built_in">head</span> -n 20</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. åˆ†æå †è½¬å‚¨ï¼ˆæ–‡æœ¬æ¨¡å¼ï¼‰</span></span><br><span class="line">jhat dump.hprof  <span class="comment"># è®¿é—® http://localhost:7000</span></span><br></pre></td></tr></table></figure></li></ol><p><strong>æ’æŸ¥å¸¸è§å†…å­˜æ³„æ¼åœºæ™¯</strong></p><table><thead><tr><th align="left"><strong>æ³„æ¼ç±»å‹</strong></th><th align="left"><strong>å…¸å‹ä»£ç æ¡ˆä¾‹</strong></th><th align="left"><strong>åˆ†æçº¿ç´¢</strong></th></tr></thead><tbody><tr><td align="left"><strong>é›†åˆç±»æ³„æ¼</strong></td><td align="left"><code>static Map</code> ç¼“å­˜æ— æ¸…ç†é€»è¾‘</td><td align="left">HashMap&#x2F;ArrayList å ä¸»å¯¼</td></tr><tr><td align="left"><strong>æœªå…³é—­èµ„æº</strong></td><td align="left">æœªå…³é—­çš„ <code>FileInputStream</code>ã€<code>Connection</code></td><td align="left">Finalizer é˜Ÿåˆ—å †ç§¯</td></tr><tr><td align="left"><strong>çº¿ç¨‹å±€éƒ¨å˜é‡</strong></td><td align="left"><code>ThreadLocal</code> æœªè°ƒç”¨ <code>remove()</code></td><td align="left">çº¿ç¨‹æ± ä¸­ThreadLocalå¯¹è±¡ç´¯ç§¯</td></tr><tr><td align="left"><strong>ç›‘å¬å™¨æœªæ³¨é”€</strong></td><td align="left">æ³¨å†Œåæœªç§»é™¤çš„äº‹ä»¶ç›‘å¬å™¨</td><td align="left">ç›‘å¬å™¨å¯¹è±¡æŒæœ‰å¤–éƒ¨å¼•ç”¨</td></tr><tr><td align="left"><strong>å…ƒç©ºé—´æº¢å‡º</strong></td><td align="left">åŠ¨æ€ç”Ÿæˆç±»ï¼ˆå¦‚CGLibï¼‰</td><td align="left">Metaspace ä½¿ç”¨é‡æŒç»­å¢é•¿</td></tr></tbody></table><p><strong>æ¡ˆä¾‹</strong></p><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªé«˜åº¦çœŸå®çš„å†…å­˜æº¢å‡ºæ¡ˆä¾‹ï¼Œæ¨¡æ‹Ÿäº†å¸¸è§çš„<strong>ç¼“å­˜æ— é™å¢é•¿</strong>åœºæ™¯ã€‚è¯¥æ¡ˆä¾‹é€šè¿‡é™æ€Mapå­˜å‚¨ç”¨æˆ·æ•°æ®ï¼Œå¹¶é…åˆåå°çº¿ç¨‹æŒç»­åŠ è½½ï¼ŒåŒæ—¶ç¼ºä¹è¿‡æœŸæœºåˆ¶ï¼Œæœ€ç»ˆå¯¼è‡´å †å†…å­˜æº¢å‡ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MemoryLeakSimulator</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é™æ€ç¼“å­˜Map - å…¸å‹çš„å†…å­˜æ³„æ¼æ ¹æº</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Long, UserProfile&gt; USER_CACHE = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¨¡æ‹Ÿåå°ç¼“å­˜åŠ è½½çº¿ç¨‹æ± </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ScheduledExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;===== å†…å­˜æ³„æ¼æ¨¡æ‹Ÿç¨‹åºå¯åŠ¨ =====&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. åˆå§‹åŒ–å®šæ—¶ä»»åŠ¡ï¼šæ¯ç§’æ·»åŠ 100ä¸ªç”¨æˆ·åˆ°ç¼“å­˜</span></span><br><span class="line">        executor.scheduleAtFixedRate(() -&gt; loadUsersToCache(), <span class="number">0</span>, <span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. æ¨¡æ‹Ÿè®¿é—®ç¼“å­˜ï¼ˆåŠ é€Ÿå†…å­˜å¢é•¿ï¼‰</span></span><br><span class="line">        executor.scheduleAtFixedRate(() -&gt; accessCache(), <span class="number">0</span>, <span class="number">300</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. æ·»åŠ JVMå…³é—­é’©å­ï¼ˆç”¨äºèµ„æºæ¸…ç†ï¼‰</span></span><br><span class="line">        Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            executor.shutdown();</span><br><span class="line">            System.out.println(<span class="string">&quot;===== ç¨‹åºå…³é—­ =====&quot;</span>);</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¨¡æ‹Ÿç”¨æˆ·æ•°æ®åŠ è½½åˆ°ç¼“å­˜</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">loadUsersToCache</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">userId</span> <span class="operator">=</span> System.nanoTime(); <span class="comment">// ä½¿ç”¨æ—¶é—´æˆ³æ¨¡æ‹Ÿç”¨æˆ·ID</span></span><br><span class="line">            USER_CACHE.put(userId, <span class="keyword">new</span> <span class="title class_">UserProfile</span>(</span><br><span class="line">                userId,</span><br><span class="line">                <span class="string">&quot;user-&quot;</span> + UUID.randomUUID(),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span> * <span class="number">50</span>] <span class="comment">// æ¯ä¸ªç”¨æˆ·åˆ†é…50KBæ•°æ®ï¼ˆæ¨¡æ‹Ÿç”¨æˆ·ä¿¡æ¯ï¼‰</span></span><br><span class="line">            ));</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.printf(<span class="string">&quot;ã€ç¼“å­˜åŠ è½½ã€‘å½“å‰ç¼“å­˜ç”¨æˆ·æ•°: %,d å ç”¨å†…å­˜: â‰ˆ%,dMB\n&quot;</span>,</span><br><span class="line">            USER_CACHE.size(),</span><br><span class="line">            (USER_CACHE.size() * <span class="number">50</span>) / <span class="number">1024</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¨¡æ‹Ÿç¼“å­˜è®¿é—®ï¼ˆå¢åŠ å¯¹è±¡å¼•ç”¨å¤æ‚åº¦ï¼‰</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">accessCache</span><span class="params">()</span> &#123;</span><br><span class="line">        USER_CACHE.forEach((id, profile) -&gt; &#123;</span><br><span class="line">            <span class="comment">// æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç†ï¼ˆå®é™…ä¸­å¯èƒ½åŒ…å«å¤æ‚é€»è¾‘ï¼‰</span></span><br><span class="line">            <span class="keyword">if</span> (id % <span class="number">100</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                profile.updateLastAccessTime();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”¨æˆ·ä¿¡æ¯ç±»ï¼ˆåŒ…å«å¤§å¯¹è±¡ï¼‰</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">UserProfile</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">long</span> userId;</span><br><span class="line">        <span class="keyword">private</span> String userName;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">byte</span>[] userData; <span class="comment">// å¤§å¯¹è±¡</span></span><br><span class="line">        <span class="keyword">private</span> <span class="type">long</span> lastAccessTime;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">UserProfile</span><span class="params">(<span class="type">long</span> userId, String userName, <span class="type">byte</span>[] userData)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.userId = userId;</span><br><span class="line">            <span class="built_in">this</span>.userName = userName;</span><br><span class="line">            <span class="built_in">this</span>.userData = userData;</span><br><span class="line">            <span class="built_in">this</span>.lastAccessTime = System.currentTimeMillis();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateLastAccessTime</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.lastAccessTime = System.currentTimeMillis();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å…³é”®è®¾è®¡è¯´æ˜ï¼ˆçœŸå®æ¼æ´ç‚¹ï¼‰</strong>ï¼š</p><ol><li><strong>é™æ€Mapç¼“å­˜</strong>ï¼ˆ<code>USER_CACHE</code>ï¼‰<ul><li>ç”Ÿå‘½å‘¨æœŸä¸JVMç›¸åŒï¼Œæ°¸è¿œä¸ä¼šè¢«å›æ”¶</li><li>ä½¿ç”¨<code>ConcurrentHashMap</code>æ¨¡æ‹ŸçœŸå®é«˜å¹¶å‘åœºæ™¯</li></ul></li><li><strong>å®šæ—¶åŠ è½½çº¿ç¨‹</strong><ul><li>æ¯ç§’æ·»åŠ 100ä¸ªæ–°ç”¨æˆ·ï¼ˆçº¦5MB&#x2F;ç§’ï¼‰</li><li>æ¯ä¸ªç”¨æˆ·å¯¹è±¡åŒ…å«50KBæ•°æ®ï¼ˆæ¨¡æ‹Ÿç”¨æˆ·ä¿¡æ¯ã€å›¾ç‰‡ç­‰ï¼‰</li></ul></li><li><strong>ç¼“å­˜è®¿é—®æ¨¡å¼</strong><ul><li>é«˜é¢‘è®¿é—®ç¼“å­˜ï¼ˆæ¯300mséå†ä¸€æ¬¡ï¼‰</li><li>æ›´æ–°å¯¹è±¡å­—æ®µï¼ˆå¢åŠ GC Rootså¼•ç”¨é“¾å¤æ‚åº¦ï¼‰</li></ul></li><li><strong>å¤§å¯¹è±¡è®¾è®¡</strong><ul><li><code>byte[1024 * 50]</code> æ¨¡æ‹Ÿç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶&#x2F;å›¾ç‰‡æ•°æ®</li><li>å¯¹è±¡å¤§å°å¯æ§ï¼ˆè°ƒæ•´æ•°ç»„é•¿åº¦å¯æ”¹å˜OOMé€Ÿåº¦ï¼‰</li></ul></li></ol><p><strong>è¿è¡Œå‚æ•°é…ç½®ï¼ˆåŠ é€ŸOOMå‡ºç°ï¼‰</strong>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®¾ç½®å°å †å†…å­˜ + OOMæ—¶è‡ªåŠ¨dump</span></span><br><span class="line">java -Xms128m -Xmx128m -XX:+HeapDumpOnOutOfMemoryError -jar MemoryLeakSimulator.jar</span><br></pre></td></tr></table></figure><p><strong>é¢„æœŸç»“æœ</strong>ï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">===== å†…å­˜æ³„æ¼æ¨¡æ‹Ÿç¨‹åºå¯åŠ¨ =====</span><br><span class="line">ã€ç¼“å­˜åŠ è½½ã€‘å½“å‰ç¼“å­˜ç”¨æˆ·æ•°: 100 å ç”¨å†…å­˜: â‰ˆ4MB</span><br><span class="line">ã€ç¼“å­˜åŠ è½½ã€‘å½“å‰ç¼“å­˜ç”¨æˆ·æ•°: 200 å ç”¨å†…å­˜: â‰ˆ9MB</span><br><span class="line">...</span><br><span class="line">ã€ç¼“å­˜åŠ è½½ã€‘å½“å‰ç¼“å­˜ç”¨æˆ·æ•°: 2,500 å ç”¨å†…å­˜: â‰ˆ122MB</span><br><span class="line">java.lang.OutOfMemoryError: Java heap space</span><br><span class="line">Dumping heap to java_pid12345.hprof ...</span><br></pre></td></tr></table></figure><p><strong>æ¼æ´åˆ†æï¼ˆMATå·¥å…·éªŒè¯ï¼‰</strong>ï¼š</p><ol><li>æ‰“å¼€ç”Ÿæˆçš„<code>java_pid12345.hprof</code>æ–‡ä»¶</li><li>æ‰§è¡Œ <strong>Leak Suspects Report</strong>ï¼š<ul><li>å°†æ˜¾ç¤º<code>ConcurrentHashMap</code>å ç”¨ &gt;90% å†…å­˜</li></ul></li><li>æŸ¥çœ‹ <strong>Dominator Tree</strong>ï¼š<ul><li>æ’åç¬¬ä¸€çš„æ˜¯<code>java.util.concurrent.ConcurrentHashMap$Node[]</code></li><li>ä¿ç•™å †æ ˆæŒ‡å‘<code>USER_CACHE</code></li></ul></li><li>è¿½è¸ª <strong>Path to GC Roots</strong>ï¼š<ul><li>æ˜¾ç¤º<code>USER_CACHE</code>è¢«<code>static</code>å˜é‡æŒæœ‰</li></ul></li></ol><p><strong>çœŸå®åœºæ™¯å¯¹åº”</strong>ï¼š</p><p>æ­¤æ¡ˆä¾‹æ¨¡æ‹Ÿäº†ï¼š</p><ul><li>ç”¨æˆ·ä¼šè¯ç¼“å­˜æœªè®¾ç½®TTL</li><li>ä¸Šä¼ æ–‡ä»¶ç¼“å­˜æœªæ¸…ç†</li><li>é™æ€é…ç½®ä¸­å¿ƒæ•°æ®æ— é™ç´¯ç§¯</li><li>ç¬¬ä¸‰æ–¹APIå“åº”ç¼“å­˜æœªè¿‡æœŸ</li></ul><p><strong>ä¿®å¤æ–¹æ¡ˆ</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨å¼±å¼•ç”¨ç¼“å­˜ï¼ˆè‡ªåŠ¨å›æ”¶ï¼‰</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Long, WeakReference&lt;UserProfile&gt;&gt; USER_CACHE = </span><br><span class="line">    Collections.synchronizedMap(<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;());</span><br><span class="line"></span><br><span class="line"><span class="comment">// æˆ–ä½¿ç”¨Guava Cacheï¼ˆå¸¦è¿‡æœŸç­–ç•¥ï¼‰</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Cache&lt;Long, UserProfile&gt; cache = CacheBuilder.newBuilder()</span><br><span class="line">    .maximumSize(<span class="number">1000</span>)</span><br><span class="line">    .expireAfterAccess(<span class="number">10</span>, TimeUnit.MINUTES)</span><br><span class="line">    .build();</span><br></pre></td></tr></table></figure><blockquote><p><strong>é‡è¦æç¤º</strong>ï¼šåœ¨æœ¬åœ°è¿è¡Œæ­¤ä»£ç å‰ï¼Œè¯·ç¡®ä¿å…³é—­å…¶ä»–é‡è¦åº”ç”¨ï¼å¯é€šè¿‡è°ƒæ•´<code>byte[1024 * 50]</code>ä¸­çš„ä¹˜æ•°æ§åˆ¶OOMé€Ÿåº¦ï¼ˆä¾‹å¦‚æ”¹ä¸º<code>*5</code>å¯é™ä½å†…å­˜å ç”¨ï¼‰ã€‚</p></blockquote><h3 id="åƒåœ¾å›æ”¶"><a href="#åƒåœ¾å›æ”¶" class="headerlink" title="åƒåœ¾å›æ”¶"></a>åƒåœ¾å›æ”¶</h3><h4 id="å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦å¯å›æ”¶"><a href="#å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦å¯å›æ”¶" class="headerlink" title="å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦å¯å›æ”¶"></a>å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦å¯å›æ”¶</h4><p><strong>å¼•ç”¨è®¡æ•°æ³•</strong></p><p><strong>å¯è¾¾æ€§åˆ†ææ³•</strong></p><p>åœ¨ Java ä¸­ ä»¥ä¸‹å¯¹è±¡å¯ä½œä¸º GC Rootsï¼š</p><ul><li>è™šæ‹Ÿæœºæ ˆä¸­å¼•ç”¨çš„å¯¹è±¡</li><li>æœ¬åœ°æ–¹æ³•æ ˆä¸­å¼•ç”¨çš„å¯¹è±¡</li><li>æ–¹æ³•åŒºä¸­ç±»é™æ€å±æ€§å¼•ç”¨çš„å¯¹è±¡</li><li>æ–¹æ³•åŒºä¸­çš„å¸¸é‡å¼•ç”¨çš„å¯¹è±¡</li></ul><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¦å®£å‘Šä¸€ä¸ªå¯¹è±¡çš„çœŸæ­£æ­»äº¡ï¼Œéœ€è¦ç»è¿‡ä¸¤æ¬¡æ ‡è®°ã€‚</p><ol><li><p>ä» GC roots å‡ºå‘ï¼Œæ ‡è®°ä¸å¯è¾¾çš„å¯¹è±¡</p></li><li><p>å¯¹ F-Queue å¯¹åˆ—ä¸­çš„å¯¹è±¡è¿›è¡ŒäºŒæ¬¡æ ‡è®°</p><p>ä¸å¯è¾¾å¯¹è±¡å¦‚æœé‡å†™ä¸”è¿˜æœªæ‰§è¡Œ finalize æ–¹æ³•ï¼Œä¼šè¢«åŠ å…¥åˆ°ä¸€ä¸ªåä¸º F-Queue çš„é˜Ÿåˆ—ä¸­ã€‚åœ¨ F-Queue é˜Ÿåˆ—ä¸­çš„å¯¹è±¡å¯ä»¥é‡æ–°è¢«èµ‹å€¼ç»™æŸä¸ªå¼•ç”¨ï¼Œè¿™æ ·äºŒæ¬¡æ ‡è®°æ—¶ï¼Œè¿™äº›å¯¹è±¡å°†è¢«ç§»å‡º F-Queue é˜Ÿåˆ—ï¼Œä»è€Œå®ç°è‡ªæ•‘ã€‚</p></li></ol><h4 id="4ç§å¼•ç”¨ç±»å‹"><a href="#4ç§å¼•ç”¨ç±»å‹" class="headerlink" title="4ç§å¼•ç”¨ç±»å‹"></a>4ç§å¼•ç”¨ç±»å‹</h4><p>JVM çš„å››ç§å¼•ç”¨ç±»å‹ï¼ˆå¼ºå¼•ç”¨ã€è½¯å¼•ç”¨ã€å¼±å¼•ç”¨ã€è™šå¼•ç”¨ï¼‰å†³å®šäº†å¯¹è±¡å¦‚ä½•è¢«åƒåœ¾å›æ”¶å™¨ï¼ˆGCï¼‰å¯¹å¾…ï¼Œä¸»è¦æœåŠ¡äº<strong>æ›´ç²¾ç»†åœ°æ§åˆ¶å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ</strong>å’Œ<strong>ç®¡ç†å†…å­˜</strong>çš„ç›®çš„ã€‚å®ƒä»¬çš„ä½¿ç”¨åœºæ™¯å„æœ‰ä¾§é‡ï¼š</p><ol><li><p><strong>å¼ºå¼•ç”¨ (Strong Reference)</strong></p><ul><li><strong>å®šä¹‰ï¼š</strong> æœ€å¸¸è§çš„å¼•ç”¨ç±»å‹ã€‚é€šè¿‡ <code>new</code> å…³é”®å­—åˆ›å»ºçš„å¯¹è±¡é»˜è®¤å°±æ˜¯å¼ºå¼•ç”¨ã€‚åªè¦å¼ºå¼•ç”¨å­˜åœ¨ï¼Œåƒåœ¾å›æ”¶å™¨å°±<strong>ç»å¯¹ä¸ä¼š</strong>å›æ”¶è¯¥å¯¹è±¡ï¼Œå³ä½¿é¢ä¸´å†…å­˜ä¸è¶³ï¼ˆOOMï¼‰çš„é£é™©ã€‚</li><li><strong>è¯­æ³•ï¼š</strong> <code>Object obj = new Object(); // obj å°±æ˜¯ä¸€ä¸ªæŒ‡å‘æ–° Object å®ä¾‹çš„å¼ºå¼•ç”¨</code></li></ul></li><li><p><strong>è½¯å¼•ç”¨ (SoftReference)</strong></p><ul><li><p><strong>å®šä¹‰ï¼š</strong> ç”¨æ¥æè¿°ä¸€äº›<strong>æœ‰ç”¨ä½†éå¿…éœ€</strong>çš„å¯¹è±¡ã€‚å½“å†…å­˜å……è¶³æ—¶ï¼Œè½¯å¼•ç”¨å…³è”çš„å¯¹è±¡ä¸ä¼šè¢«å›æ”¶ï¼›å½“<strong>å†…å­˜ä¸è¶³ï¼ˆå³å°†å‘ç”Ÿ OOM ä¹‹å‰ï¼‰</strong>ï¼Œåƒåœ¾å›æ”¶å™¨ä¼šå°è¯•å›æ”¶è¿™äº›è½¯å¼•ç”¨æŒ‡å‘çš„å¯¹è±¡ã€‚å¦‚æœå›æ”¶äº†è½¯å¼•ç”¨å¯¹è±¡åå†…å­˜ä»ç„¶ä¸è¶³ï¼Œæ‰ä¼šæŠ›å‡º <code>OutOfMemoryError</code>ã€‚</p></li><li><p><strong>è¯­æ³•ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">importantObj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>(); <span class="comment">// åŸå§‹å¼ºå¼•ç”¨</span></span><br><span class="line">SoftReference&lt;Object&gt; softRef = <span class="keyword">new</span> <span class="title class_">SoftReference</span>&lt;&gt;(importantObj);</span><br><span class="line">importantObj = <span class="literal">null</span>; <span class="comment">// è§£é™¤å¼ºå¼•ç”¨ï¼Œåªå‰©ä¸‹è½¯å¼•ç”¨</span></span><br><span class="line"><span class="comment">// ç¨åå°è¯•è·å–</span></span><br><span class="line"><span class="type">Object</span> <span class="variable">retrieved</span> <span class="operator">=</span> softRef.get(); <span class="comment">// å¦‚æœæœªè¢«å›æ”¶ï¼Œretrieved != null; å¦‚æœè¢«å›æ”¶ï¼Œretrieved == null</span></span><br></pre></td></tr></table></figure></li><li><p><strong>ä½¿ç”¨åœºæ™¯ï¼š</strong></p><ul><li><strong>å†…å­˜æ•æ„Ÿçš„é«˜é€Ÿç¼“å­˜ (Memory-Sensitive Caches)ï¼š</strong> è½¯å¼•ç”¨èƒ½ä¿è¯åœ¨å†…å­˜åƒç´§æ—¶è‡ªåŠ¨é‡Šæ”¾ç¼“å­˜ï¼Œé¿å… OOMï¼ŒåŒæ—¶å°½å¯èƒ½åˆ©ç”¨å†…å­˜æé«˜ç¼“å­˜å‘½ä¸­ç‡ã€‚</li></ul></li></ul></li><li><p><strong>å¼±å¼•ç”¨ (WeakReference)</strong></p><ul><li><p><strong>å®šä¹‰ï¼š</strong> ç”¨æ¥æè¿°<strong>éå¿…éœ€</strong>å¯¹è±¡ï¼Œæ¯”è½¯å¼•ç”¨æ›´å¼±ã€‚æ— è®ºå½“å‰å†…å­˜æ˜¯å¦å……è¶³ï¼Œåªè¦åƒåœ¾å›æ”¶å™¨å¼€å§‹å·¥ä½œï¼ˆå¹¶ä¸”æ‰«æåˆ°è¿™ä¸ªå¯¹è±¡ï¼‰ï¼Œå°±ä¼šå›æ”¶æ‰<strong>ä»…è¢«å¼±å¼•ç”¨æŒ‡å‘</strong>çš„å¯¹è±¡ã€‚</p></li><li><p><strong>è¯­æ³•ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">tempObj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>(); <span class="comment">// åŸå§‹å¼ºå¼•ç”¨</span></span><br><span class="line">WeakReference&lt;Object&gt; weakRef = <span class="keyword">new</span> <span class="title class_">WeakReference</span>&lt;&gt;(tempObj);</span><br><span class="line">tempObj = <span class="literal">null</span>; <span class="comment">// è§£é™¤å¼ºå¼•ç”¨ï¼Œåªå‰©ä¸‹å¼±å¼•ç”¨</span></span><br><span class="line"><span class="comment">// å¼ºåˆ¶è§¦å‘ä¸€æ¬¡ GC (ä»…ç¤ºä¾‹ï¼Œç”Ÿäº§ç¯å¢ƒæ…ç”¨ System.gc())</span></span><br><span class="line">System.gc();</span><br><span class="line"><span class="comment">// å°è¯•è·å–</span></span><br><span class="line"><span class="type">Object</span> <span class="variable">retrieved</span> <span class="operator">=</span> weakRef.get(); <span class="comment">// å¾ˆå¤§æ¦‚ç‡ retrieved == nullï¼Œå› ä¸ºå¯¹è±¡å·²è¢«å›æ”¶</span></span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>è™šå¼•ç”¨ (PhantomReference)</strong></p><ul><li><p><strong>å®šä¹‰ï¼š</strong> æœ€å¼±çš„ä¸€ç§å¼•ç”¨ã€‚<strong>æ— æ³•é€šè¿‡è™šå¼•ç”¨è·å–å¯¹è±¡å®ä¾‹</strong>ï¼ˆå…¶ <code>get()</code> æ–¹æ³•æ€»æ˜¯è¿”å› <code>null</code>ï¼‰ã€‚è™šå¼•ç”¨<strong>å¿…é¡»</strong>ä¸ <code>ReferenceQueue</code> è”åˆä½¿ç”¨ã€‚è®¾ç½®è™šå¼•ç”¨çš„<strong>å”¯ä¸€ç›®çš„</strong>æ˜¯<strong>è·Ÿè¸ªå¯¹è±¡è¢«åƒåœ¾å›æ”¶çš„æ—¶æœº</strong>ã€‚å½“åƒåœ¾å›æ”¶å™¨å‡†å¤‡å›æ”¶ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œå¦‚æœå‘ç°å®ƒè¿˜æœ‰è™šå¼•ç”¨ï¼Œå°±ä¼šåœ¨å›æ”¶å¯¹è±¡<strong>ä¹‹å</strong>ï¼ˆæ­¤æ—¶å¯¹è±¡å†…å­˜å·²è¢«é‡Šæ”¾æˆ–å³å°†è¢«é‡Šæ”¾ï¼‰ï¼Œå°†è¿™ä¸ªè™šå¼•ç”¨åŠ å…¥ä¸ä¹‹å…³è”çš„ <code>ReferenceQueue</code> ä¸­ã€‚</p></li><li><p><strong>è¯­æ³•ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ReferenceQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">ReferenceQueue</span>&lt;&gt;();</span><br><span class="line"><span class="type">Object</span> <span class="variable">phantomObj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>(); <span class="comment">// åŸå§‹å¼ºå¼•ç”¨</span></span><br><span class="line">PhantomReference&lt;Object&gt; phantomRef = <span class="keyword">new</span> <span class="title class_">PhantomReference</span>&lt;&gt;(phantomObj, queue);</span><br><span class="line">phantomObj = <span class="literal">null</span>; <span class="comment">// è§£é™¤å¼ºå¼•ç”¨</span></span><br><span class="line"><span class="comment">// ... å¼ºåˆ¶ GC æˆ–ç­‰å¾… GC å‘ç”Ÿ ...</span></span><br><span class="line"><span class="comment">// æ£€æŸ¥é˜Ÿåˆ—</span></span><br><span class="line">Reference&lt;?&gt; refFromQueue = queue.poll();</span><br><span class="line"><span class="keyword">if</span> (refFromQueue != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// æ­¤æ—¶ refFromQueue å°±æ˜¯ phantomRefï¼Œè¡¨ç¤º phantomObj å·²è¢«å›æ”¶æˆ–å¤„äº finalization çŠ¶æ€</span></span><br><span class="line">    <span class="comment">// å¯ä»¥åœ¨è¿™é‡Œæ‰§è¡Œä¸€äº›èµ„æºæ¸…ç†åŠ¨ä½œï¼ˆå¦‚å…³é—­å…³è”çš„æ–‡ä»¶æè¿°ç¬¦ã€é‡Šæ”¾å †å¤–å†…å­˜ç­‰ï¼‰</span></span><br><span class="line">    <span class="comment">// æ³¨æ„ï¼šæ­¤æ—¶åŸå¯¹è±¡ phantomObj å·²ç»ä¸å¯è¾¾ä¸”å†…å­˜å¯èƒ½å·²è¢«å›æ”¶</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong>ä½¿ç”¨åœºæ™¯ï¼š</strong></p><ul><li><strong>ç®¡ç†å †å¤–å†…å­˜ (Off-Heap Memory)ï¼š</strong> è¿™æ˜¯æœ€ä¸»è¦çš„åº”ç”¨åœºæ™¯ã€‚Java NIO çš„ <code>DirectByteBuffer</code> åˆ†é…å †å¤–å†…å­˜ã€‚<code>DirectByteBuffer</code> å¯¹è±¡æœ¬èº«å¾ˆå°ï¼ˆåœ¨å †ä¸Šï¼‰ï¼Œä½†å®ƒå…³è”ç€ä¸€å—è¾ƒå¤§çš„å †å¤–å†…å­˜ã€‚å½“ <code>DirectByteBuffer</code> å¯¹è±¡è¢«å›æ”¶æ—¶ï¼Œéœ€è¦é‡Šæ”¾å…¶å…³è”çš„å †å¤–å†…å­˜ã€‚JVM ä½¿ç”¨ <code>Cleaner</code> ç±»ï¼ˆå†…éƒ¨åŸºäº <code>PhantomReference</code>ï¼‰æ¥ç›‘æ§ <code>DirectByteBuffer</code> å¯¹è±¡ã€‚å½“ <code>DirectByteBuffer</code> å¯¹è±¡è¢« GC å›æ”¶åï¼Œ<code>Cleaner</code> çš„è™šå¼•ç”¨ä¼šè¢«æ”¾å…¥é˜Ÿåˆ—ï¼Œè§¦å‘ä¸€ä¸ªæ¸…ç†çº¿ç¨‹è°ƒç”¨ <code>unsafe.freeMemory</code> æ¥é‡Šæ”¾å †å¤–å†…å­˜ã€‚</li></ul></li></ul></li></ol><h4 id="CMSæ”¶é›†å™¨å·¥ä½œåŸç†"><a href="#CMSæ”¶é›†å™¨å·¥ä½œåŸç†" class="headerlink" title="CMSæ”¶é›†å™¨å·¥ä½œåŸç†"></a>CMSæ”¶é›†å™¨å·¥ä½œåŸç†</h4><h4 id="G1æ”¶é›†å™¨å·¥ä½œåŸç†"><a href="#G1æ”¶é›†å™¨å·¥ä½œåŸç†" class="headerlink" title="G1æ”¶é›†å™¨å·¥ä½œåŸç†"></a>G1æ”¶é›†å™¨å·¥ä½œåŸç†</h4><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      <categories>
          
          <category> é¢è¯• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é—®é¢˜åº“</title>
      <link href="/post/7c4f87d.html"/>
      <url>/post/7c4f87d.html</url>
      
        <content type="html"><![CDATA[<h2 id="jpa"><a href="#jpa" class="headerlink" title="jpa"></a>jpa</h2><h3 id="jpa-æ•°ç»„è¶Šç•Œå¼‚å¸¸"><a href="#jpa-æ•°ç»„è¶Šç•Œå¼‚å¸¸" class="headerlink" title="jpa æ•°ç»„è¶Šç•Œå¼‚å¸¸"></a>jpa æ•°ç»„è¶Šç•Œå¼‚å¸¸</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">Type</span> &#123;</span><br><span class="line">    A,</span><br><span class="line">    B</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="meta">@Enumerated</span></span><br><span class="line">    <span class="keyword">private</span> Type type;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡è®¾è¡¨é‡Œå­˜åœ¨ä¸€æ¡æ•°æ®ï¼Œ<code>type</code> åˆ—çš„å€¼ä¸º2ï¼Œåœ¨ä½¿ç”¨JPAæŸ¥è¯¢æ•°æ®è¿™æ¡æ•°æ®æ—¶ä¼šæŠ¥æ•°ç»„è¶Šç•Œå¼‚å¸¸ï¼Œå…·ä½“æŠ¥é”™å¦‚ï¼š<code>nested exception is java.lang.ArrayIndexOutOfBoundsException: Index 2 out of bounds for length 2</code></p><p>æŠ¥é”™çš„åŸå› æ˜¯ <code>Type</code> çš„ <code>ordinal</code> èŒƒå›´æ˜¯[0, 1]ï¼Œ2ä¸åœ¨èŒƒå›´å†…ã€‚</p><h3 id="jpa-ç¼“å­˜é—®é¢˜"><a href="#jpa-ç¼“å­˜é—®é¢˜" class="headerlink" title="jpa ç¼“å­˜é—®é¢˜"></a>jpa ç¼“å­˜é—®é¢˜</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CanvasInstanceDataObject</span> &#123;</span><br><span class="line">    <span class="comment">// å…¶ä»–å­—æ®µ</span></span><br><span class="line">    </span><br><span class="line">    <span class="meta">@CreatedDate</span></span><br><span class="line">    <span class="meta">@Column(updatable = false)</span></span><br><span class="line">    <span class="meta">@JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;, timezone = &quot;GMT+8&quot;)</span></span><br><span class="line">    <span class="keyword">protected</span> Date createdAt;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@LastModifiedDate</span></span><br><span class="line">    <span class="meta">@JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;, timezone = &quot;GMT+8&quot;)</span></span><br><span class="line">    <span class="keyword">protected</span> Date updatedAt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `t_canvas_instance` (</span><br><span class="line">  `created_at` datetime(<span class="number">6</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `updated_at` datetime(<span class="number">6</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>é—®é¢˜èƒŒæ™¯ï¼šæŸå¼ è¡¨åŠå…¶å¯¹åº”çš„å®ä½“ç±»å®šä¹‰å¦‚ä¸Šï¼Œä»£ç ä¸­æ‰§è¡Œè¯­å¥ <code>DataObject dataObject = canvasInstanceGateway.save(dataObject);</code> ï¼Œ<code>dataObject</code> çš„ <code>createdAt</code> å­—æ®µæ ¼å¼ä¸º <code>2025-01-03 16:46:51.876</code>ï¼Œè€Œ <code>updatedAt</code> ä¸º <code>Mon Jan 06 19:55:43 CST 2025</code> ã€‚</p><p>ç»æŸ¥èµ„æ–™å‘ç° JPA åœ¨è°ƒç”¨ <code>save</code> æ–¹æ³•ä¿å­˜å¯¹è±¡æ—¶ä¼šå°†å¯¹è±¡ç¼“å­˜åœ¨ä¸€çº§ç¼“å­˜ä¸­ï¼Œå¦‚æœä¿å­˜ä¹‹åç«‹å³æŸ¥è¯¢è¯¥å¯¹è±¡ï¼Œä¼šä»ç¼“å­˜ä¸­è·å–æ•°æ®ï¼Œè€Œä¸æ˜¯ä»æ•°æ®åº“ä¸­é‡æ–°æŸ¥è¯¢ã€‚è€Œå†…å­˜ä¸­çš„ <code>dataObject</code> çš„ <code>updatedAt</code> å­—æ®µæ˜¯ <code>Date</code> ç±»å‹ï¼Œåªæœ‰åœ¨çœŸæ­£ä¿å­˜åˆ°æ•°æ®åº“ä¸­ï¼Œæ‰ä¼šåºåˆ—åŒ–ä¸ºæ—¶é—´æˆ³ç±»å‹ã€‚ä¸ºäº†ç¡®ä¿ä»æ•°æ®åº“ä¸­é‡æ–°æŸ¥è¯¢æ•°æ®ï¼Œéœ€ä½¿ç”¨ <code>EntityManager</code> çš„ <code>clear</code> æ–¹æ³•æ¥æ¸…ç©ºä¸€çº§ç¼“å­˜ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CanvasInstanceService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CanvasInstanceRepository repository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PersistenceContext</span></span><br><span class="line">    <span class="keyword">private</span> EntityManager entityManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> CanvasInstanceDataObject <span class="title function_">saveAndFindById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="type">CanvasInstanceDataObject</span> <span class="variable">model</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CanvasInstanceDataObject</span>();</span><br><span class="line">        <span class="comment">// è®¾ç½® model çš„å±æ€§</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä¿å­˜åˆ°æ•°æ®åº“</span></span><br><span class="line">        <span class="type">CanvasInstanceDataObject</span> <span class="variable">savedModel</span> <span class="operator">=</span> repository.save(model);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ¸…ç©ºå®ä½“ç®¡ç†å™¨çš„ç¼“å­˜</span></span><br><span class="line">        entityManager.clear();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä»æ•°æ®åº“ä¸­é‡æ–°æŸ¥è¯¢</span></span><br><span class="line">        <span class="type">CanvasInstanceDataObject</span> <span class="variable">foundModel</span> <span class="operator">=</span> repository.findById(id).orElse(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> foundModel;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="jackson"><a href="#jackson" class="headerlink" title="jackson"></a>jackson</h2><h3 id="jackson-åºåˆ—åŒ–ç©ºæŒ‡é’ˆå¼‚å¸¸"><a href="#jackson-åºåˆ—åŒ–ç©ºæŒ‡é’ˆå¼‚å¸¸" class="headerlink" title="jackson åºåˆ—åŒ–ç©ºæŒ‡é’ˆå¼‚å¸¸"></a>jackson åºåˆ—åŒ–ç©ºæŒ‡é’ˆå¼‚å¸¸</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Storage</span> &#123;</span><br><span class="line">    </span><br><span class="line">    String endpoint;</span><br><span class="line"></span><br><span class="line">    String storagePath;</span><br><span class="line"></span><br><span class="line">    String schema;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getRegion</span><span class="params">()</span> &#123;</span><br><span class="line">        String[] parts = endpoint.split(<span class="string">&quot;\\.&quot;</span>);</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä½¿ç”¨<code>Jackson</code>åºåˆ—åŒ–<code>Storage</code>å¯¹è±¡æ—¶ï¼Œå¦‚æœ<code>endpoint</code>ä¸º<code>null</code>ï¼Œä¼šæŠ¥ç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚</p><p>è§£å†³æ–¹æ³•ï¼šä¿®æ”¹å‡½æ•°åï¼Œå¦‚å°†<code>getRegion</code>æ”¹ä¸º<code>resolveRegion</code>ã€‚</p><h3 id="é…ç½®ååºåˆ—åŒ–æ„é€ å‡½æ•°"><a href="#é…ç½®ååºåˆ—åŒ–æ„é€ å‡½æ•°" class="headerlink" title="é…ç½®ååºåˆ—åŒ–æ„é€ å‡½æ•°"></a>é…ç½®ååºåˆ—åŒ–æ„é€ å‡½æ•°</h3><p><code>Jackson</code>ååºåˆ—åŒ–é»˜è®¤éœ€è¦ä¸€ä¸ªæ— å‚æ„é€ å™¨æ¥åˆ›å»ºå¯¹è±¡ï¼Œä¹‹åå†é€šè¿‡<code>setter</code>æ–¹æ³•è®¾ç½®å¯¹è±¡çš„å±æ€§å€¼ã€‚å¦‚æœç±»æ²¡æœ‰æ— å‚æ„é€ å™¨ï¼Œååºåˆ—åŒ–ä¼šå¤±è´¥ï¼Œå¦‚æœä¸æƒ³æ·»åŠ æ— å‚æ„é€ å™¨ï¼Œå¯ä»¥é€šè¿‡é…ç½®è®©<code>Jackson</code>ç”¨å…¶ä»–æ„é€ å™¨æ¥ååºåˆ—åŒ–ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonCreator</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(<span class="meta">@JsonProperty(&quot;name&quot;)</span> String name, </span></span><br><span class="line"><span class="params">                  <span class="meta">@JsonProperty(&quot;age&quot;)</span> Integer age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="spring"><a href="#spring" class="headerlink" title="spring"></a>spring</h2><h3 id="ä¾èµ–æ³¨å…¥"><a href="#ä¾èµ–æ³¨å…¥" class="headerlink" title="ä¾èµ–æ³¨å…¥"></a>ä¾èµ–æ³¨å…¥</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MvcConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> <span class="title class_">LoginInterceptor</span>(redisTemplate))</span><br><span class="line">            .addPathPatterns(<span class="string">&quot;/**&quot;</span>)</span><br><span class="line">            .excludePathPatterns(</span><br><span class="line">                <span class="string">&quot;/user/code&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/user/login&quot;</span></span><br><span class="line">            );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯åŠ¨ç¨‹åºä¼šæŠ›å‡ºå¦‚ä¸‹å¼‚å¸¸ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Caused by: org.springframework.beans.factory.BeanNotOfRequiredTypeException: Bean named <span class="string">&#x27;redisTemplate&#x27;</span> is expected to be of <span class="built_in">type</span> <span class="string">&#x27;org.springframework.data.redis.core.StringRedisTemplate&#x27;</span> but was actually of <span class="built_in">type</span> <span class="string">&#x27;org.springframework.data.redis.core.RedisTemplate&#x27;</span></span><br></pre></td></tr></table></figure><p>åŸå› æ˜¯<code>@Resource</code>æ³¨è§£é»˜è®¤æŒ‰åç§°æ³¨å…¥ä¾èµ–å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MvcConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate redisTemplate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="java-stream"><a href="#java-stream" class="headerlink" title="java stream"></a>java stream</h2><h3 id="Collectors-toMap"><a href="#Collectors-toMap" class="headerlink" title="Collectors.toMap()"></a><code>Collectors.toMap()</code></h3><p>JDK 8 å¼•å…¥äº† <code>stream</code>ï¼Œæå¤§åœ°ç®€åŒ–äº†æ—¥å¸¸å¼€å‘ä¸­çš„é›†åˆå¤„ç†ï¼Œä½†æ˜¯å¦‚æœä½¿ç”¨ä¸å½“ï¼Œä¹Ÿä¼šå¸¦æ¥ä¸€äº›é—®é¢˜ï¼Œå…¶ä¸­ <code>Collectors.toMap()</code> å°±éœ€è¦è°¨æ…ä½¿ç”¨ã€‚ä¸‹é¢ç®€å•è®°å½•ä¸€ä¸‹ä½¿ç”¨ <code>Collectors.toMap()</code> è¿‡ç¨‹ä¸­é‡åˆ°çš„ä¸¤ä¸ªé—®é¢˜ã€‚</p><p>å…ˆå‡†å¤‡ä¸€ä¸ªå®ä½“ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="é—®é¢˜1ï¼škeyé‡å¤"><a href="#é—®é¢˜1ï¼škeyé‡å¤" class="headerlink" title="é—®é¢˜1ï¼škeyé‡å¤"></a>é—®é¢˜1ï¼š<code>key</code>é‡å¤</h4><p>å•å…ƒæµ‹è¯•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testToMapWithDuplicateKey</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;User&gt; users = Arrays.asList(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">User</span>(<span class="number">1L</span>, <span class="string">&quot;Tom&quot;</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">User</span>(<span class="number">1L</span>, <span class="string">&quot;Jerry&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Map&lt;Long, String&gt; map = users.stream().collect(Collectors.toMap(User::getId, User::getName));</span><br><span class="line">    System.out.println(map);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œæµ‹è¯•æ–¹æ³•ä¼šçœ‹åˆ°å¦‚ä¸‹æŠ¥é”™ï¼š</p><img src="/post/7c4f87d/image-20241015001026308.png" class="" title="image-20241015001026308"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T, K, V&gt;</span><br><span class="line">BiConsumer&lt;Map&lt;K, V&gt;, T&gt; <span class="title function_">uniqKeysMapAccumulator</span><span class="params">(Function&lt;? <span class="built_in">super</span> T, ? extends K&gt; keyMapper,</span></span><br><span class="line"><span class="params">                                                Function&lt;? <span class="built_in">super</span> T, ? extends V&gt; valueMapper)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (map, element) -&gt; &#123;</span><br><span class="line">        <span class="type">K</span> <span class="variable">k</span> <span class="operator">=</span> keyMapper.apply(element);</span><br><span class="line">        <span class="type">V</span> <span class="variable">v</span> <span class="operator">=</span> Objects.requireNonNull(valueMapper.apply(element));</span><br><span class="line">        <span class="type">V</span> <span class="variable">u</span> <span class="operator">=</span> map.putIfAbsent(k, v);</span><br><span class="line">        <span class="keyword">if</span> (u != <span class="literal">null</span>) <span class="keyword">throw</span> duplicateKeyException(k, u, v);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç‚¹å‡»è¿›å…¥æŠ¥é”™çš„æºç ï¼Œå¯ä»¥çœ‹åˆ°å¦‚æœ <code>key</code> é‡å¤ï¼Œjdk é»˜è®¤çš„å¤„ç†æ–¹å¼æ˜¯æŠ›å‡ºå¼‚å¸¸ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œéœ€è¦ç”¨æˆ·è‡ªå®šä¹‰å¤„ç† <code>key</code> é‡å¤çš„ç­–ç•¥ï¼Œæ¯”å¦‚ç”¨æ–°å€¼è¦†ç›–æ—§å€¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testToMapWithDuplicateKey</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;User&gt; users = Arrays.asList(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">User</span>(<span class="number">1L</span>, <span class="string">&quot;Tom&quot;</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">User</span>(<span class="number">1L</span>, <span class="string">&quot;Jerry&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Map&lt;Long, String&gt; map = users.stream().collect(Collectors.toMap(User::getId, User::getName, (oldVal, newVal) -&gt; newVal));</span><br><span class="line">    System.out.println(map);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="é—®é¢˜2ï¼švalueä¸ºnull"><a href="#é—®é¢˜2ï¼švalueä¸ºnull" class="headerlink" title="é—®é¢˜2ï¼švalueä¸ºnull"></a>é—®é¢˜2ï¼š<code>value</code>ä¸º<code>null</code></h4><p>å•å…ƒæµ‹è¯•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testToMapWithNullValue</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;User&gt; users = Arrays.asList(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">User</span>(<span class="number">1L</span>, <span class="string">&quot;Tom&quot;</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">User</span>(<span class="number">1L</span>, <span class="literal">null</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Map&lt;Long, String&gt; map = users.stream().collect(Collectors.toMap(User::getId, User::getName, (oldVal, newVal) -&gt; newVal));</span><br><span class="line">    System.out.println(map);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œæµ‹è¯•æ–¹æ³•å¯ä»¥çœ‹åˆ°å¦‚ä¸‹æŠ¥é”™ï¼š</p><img src="/post/7c4f87d/image-20241015001918076.png" class="" title="image-20241015001918076"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> V <span class="title function_">merge</span><span class="params">(K key, V value,</span></span><br><span class="line"><span class="params">               BiFunction&lt;? <span class="built_in">super</span> V, ? <span class="built_in">super</span> V, ? extends V&gt; remappingFunction)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (value == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿›å…¥æºç ï¼Œå¯ä»¥çœ‹åˆ° jdk åœ¨åˆå¹¶ <code>key</code> ç›¸åŒçš„å…ƒç´ æ—¶ï¼Œå¦‚æœ <code>value</code> ä¸º <code>null</code>ï¼Œä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚å¤„ç†è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥å…ˆè¿‡æ»¤æ‰ <code>value</code> å¯èƒ½ä¸º <code>null</code> çš„æ•°æ®ï¼Œæˆ–è¿”å›é»˜è®¤å€¼ã€‚</p><p>è¿‡æ»¤æ‰ <code>name</code> ä¸º <code>null</code> çš„æ•°æ®ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testToMapWithNullValue</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;User&gt; users = Arrays.asList(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">User</span>(<span class="number">1L</span>, <span class="string">&quot;Tom&quot;</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">User</span>(<span class="number">1L</span>, <span class="literal">null</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Map&lt;Long, String&gt; map = users.stream()</span><br><span class="line">        .filter(user -&gt; user.getName() != <span class="literal">null</span>)</span><br><span class="line">        .collect(Collectors.toMap(User::getId, User::getName, (oldVal, newVal) -&gt; newVal));</span><br><span class="line">    System.out.println(map);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœ <code>name</code> ä¸º <code>null</code>ï¼Œé»˜è®¤è¿”å›ç©ºå­—ç¬¦ä¸²ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testToMapWithNullValue</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;User&gt; users = Arrays.asList(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">User</span>(<span class="number">1L</span>, <span class="string">&quot;Tom&quot;</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">User</span>(<span class="number">1L</span>, <span class="literal">null</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Map&lt;Long, String&gt; map = users.stream()</span><br><span class="line">        .collect(Collectors.toMap(User::getId, it -&gt; Optional.ofNullable(it.getName()).orElse(<span class="string">&quot;&quot;</span>), (oldVal, newVal) -&gt; newVal));</span><br><span class="line">    System.out.println(map);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="rabbitmq"><a href="#rabbitmq" class="headerlink" title="rabbitmq"></a>rabbitmq</h2><h3 id="rabbitmq-å¯åŠ¨å¼‚å¸¸"><a href="#rabbitmq-å¯åŠ¨å¼‚å¸¸" class="headerlink" title="rabbitmq å¯åŠ¨å¼‚å¸¸"></a>rabbitmq å¯åŠ¨å¼‚å¸¸</h3><p>é”™è¯¯ä¿¡æ¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">BOOT FAILED</span><br><span class="line">2024-12-08 23:37:59.182161+08:00 [error] &lt;0.215.0&gt;</span><br><span class="line">2024-12-08 23:37:59.182161+08:00 [error] &lt;0.215.0&gt; BOOT FAILED</span><br><span class="line">2024-12-08 23:37:59.182161+08:00 [error] &lt;0.215.0&gt; ===========</span><br><span class="line">2024-12-08 23:37:59.182161+08:00 [error] &lt;0.215.0&gt; Error during startup: &#123;error,failed_to_initialize_feature_flags_registry&#125;</span><br><span class="line">2024-12-08 23:37:59.182161+08:00 [error] &lt;0.215.0&gt;</span><br><span class="line">===========</span><br><span class="line">Error during startup: &#123;error,failed_to_initialize_feature_flags_registry&#125;</span><br><span class="line"></span><br><span class="line">2024-12-08 23:38:00.183638+08:00 [notice] &lt;0.45.0&gt; Application rabbit exited with reason: &#123;failed_to_initialize_feature_flags_registry,&#123;rabbit,start,[normal,[]]&#125;&#125;</span><br><span class="line">&#123;<span class="built_in">exit</span>,terminating,[&#123;application_controller,call,2,[&#123;file,<span class="string">&quot;application_controller.erl&quot;</span>&#125;,&#123;line,511&#125;]&#125;,&#123;application,<span class="string">&#x27;-ensure_all_started/3-lc$^0/1-0-&#x27;</span>,1,[&#123;file,<span class="string">&quot;application.erl&quot;</span>&#125;,&#123;line,367&#125;]&#125;,&#123;application,ensure_all_started,3,[&#123;file,<span class="string">&quot;application.erl&quot;</span>&#125;,&#123;line,367&#125;]&#125;,&#123;rabbit,<span class="string">&#x27;-start_it/1-fun-0-&#x27;</span>,1,[&#123;file,<span class="string">&quot;rabbit.erl&quot;</span>&#125;,&#123;line,430&#125;]&#125;,&#123;timer,tc,2,[&#123;file,<span class="string">&quot;timer.erl&quot;</span>&#125;,&#123;line,590&#125;]&#125;,&#123;rabbit,start_it,1,[&#123;file,<span class="string">&quot;rabbit.erl&quot;</span>&#125;,&#123;line,426&#125;]&#125;,&#123;init,start_it,1,[]&#125;,&#123;init,start_em,1,[]&#125;]&#125;</span><br><span class="line">Runtime terminating during boot (terminating)</span><br></pre></td></tr></table></figure><p>é”™è¯¯åŸå› ï¼šRabbitMQ çš„æ•°æ®ç›®å½•å¯èƒ½å·²ç»æŸåæˆ–è€…ä¸ä¸€è‡´</p><p>è§£å†³æ–¹å¼ï¼šåˆ é™¤ RabbitMQ çš„æ•°æ®ç›®å½•å¹¶é‡å¯æœåŠ¡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> -rf /usr/local/var/lib/rabbitmq/mnesia</span><br><span class="line">brew services start rabbitmq</span><br></pre></td></tr></table></figure><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>ä»£ç åº“</title>
      <link href="/post/5cb37524.html"/>
      <url>/post/5cb37524.html</url>
      
        <content type="html"><![CDATA[<h1 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h1><h2 id="è·å–è¯·æ±‚è·¯å¾„ä¸Šçš„å‚æ•°"><a href="#è·å–è¯·æ±‚è·¯å¾„ä¸Šçš„å‚æ•°" class="headerlink" title="è·å–è¯·æ±‚è·¯å¾„ä¸Šçš„å‚æ•°"></a>è·å–è¯·æ±‚è·¯å¾„ä¸Šçš„å‚æ•°</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserContextInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> Map&lt;String, String&gt; pathVariables = (Map&lt;String, String&gt;) request.getAttribute(</span><br><span class="line">                HandlerMapping.URI_TEMPLATE_VARIABLES_ATTRIBUTE);</span><br><span class="line">        <span class="type">var</span> <span class="variable">projectId</span> <span class="operator">=</span> pathVariables.get(<span class="string">&quot;project_id&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ— servletæƒ…å†µä¸‹è·å–è¯·æ±‚å¤´"><a href="#æ— servletæƒ…å†µä¸‹è·å–è¯·æ±‚å¤´" class="headerlink" title="æ— servletæƒ…å†µä¸‹è·å–è¯·æ±‚å¤´"></a>æ— servletæƒ…å†µä¸‹è·å–è¯·æ±‚å¤´</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();</span><br><span class="line">request.getHeader(<span class="string">&quot;project_id&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id="streamæ“ä½œ"><a href="#streamæ“ä½œ" class="headerlink" title="streamæ“ä½œ"></a><code>stream</code>æ“ä½œ</h2><ul><li><code>List&lt;String&gt;</code>è½¬<code>Map&lt;String, List&lt;String&gt;&gt;</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Map&lt;String, List&lt;String&gt;&gt; <span class="title function_">list2Map</span><span class="params">(List&lt;String&gt; locations)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> locations.stream()</span><br><span class="line">        .map(s -&gt; s.split(<span class="string">&quot;:&quot;</span>))</span><br><span class="line">        .collect(Collectors.groupingBy(a -&gt; a[<span class="number">0</span>],</span><br><span class="line">            Collectors.mapping(a -&gt; a[<span class="number">1</span>], Collectors.toList())));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>åˆ†å‰²å­—ç¬¦ä¸²å¹¶å–å…¶ä¸­æŸä¸ªå­å­—ç¬¦ä¸²</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ¯”å¦‚è¦è·å–packageTypeï¼ˆå¦‚ï¼šcodearts.xxx.freeï¼‰ä¸­çš„æœåŠ¡å</span></span><br><span class="line"><span class="type">String</span> <span class="variable">service</span> <span class="operator">=</span> Optional.ofNullable(packageType)</span><br><span class="line">                .filter(StringUtils::isNoneBlank)</span><br><span class="line">                .map(it -&gt; it.split(<span class="string">&quot;\\.&quot;</span>))</span><br><span class="line">                .filter(it -&gt; it.length &gt; <span class="number">1</span>)</span><br><span class="line">                .map(it -&gt; it[<span class="number">1</span>])</span><br><span class="line">                .orElse(<span class="string">&quot;&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id="æ—¥æœŸæ“ä½œ"><a href="#æ—¥æœŸæ“ä½œ" class="headerlink" title="æ—¥æœŸæ“ä½œ"></a>æ—¥æœŸæ“ä½œ</h2><ul><li><code>Date</code>è½¬<code>LocalDateTime</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> LocalDateTime <span class="title function_">asLocalDateTime</span><span class="params">(Date date)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> date.toInstant().atZone(ZoneId.systemDefault()).toLocalDateTime();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å«è¯­å¥"><a href="#å«è¯­å¥" class="headerlink" title="å«è¯­å¥"></a>å«è¯­å¥</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å«è¯­å¥ç”¨äºæ£€æŸ¥æŸäº›å‰ç½®æ¡ä»¶ï¼Œå¦‚æœæ¡ä»¶ä¸æ»¡è¶³ï¼Œç›´æ¥è¿”å›æˆ–æŠ›å‡ºå¼‚å¸¸ï¼Œé¿å…ç»§ç»­æ‰§è¡Œåç»­çš„ä»£ç å—ã€‚</span></span><br><span class="line"><span class="comment"> * é€šè¿‡ä½¿ç”¨å«è¯­å¥ï¼Œå¯ä»¥å‡å°‘ä»£ç çš„åµŒå¥—ç¨‹åº¦ï¼Œæé«˜ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> str</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processOrder</span><span class="params">(String str)</span> &#123;</span><br><span class="line">    <span class="comment">// æ£€æŸ¥è®¢å•æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">    <span class="keyword">if</span> (str == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>; <span class="comment">// ä½¿ç”¨å«è¯­å¥ç›´æ¥è¿”å›</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ£€æŸ¥è®¢å•çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">if</span> (str.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span>; <span class="comment">// ä½¿ç”¨å«è¯­å¥ç›´æ¥è¿”å›</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰§è¡Œè®¢å•å¤„ç†é€»è¾‘</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ç»Ÿä¸€è¿”å›ç»“æ„"><a href="#ç»Ÿä¸€è¿”å›ç»“æ„" class="headerlink" title="ç»Ÿä¸€è¿”å›ç»“æ„"></a>ç»Ÿä¸€è¿”å›ç»“æ„</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IResult</span> &#123;</span><br><span class="line"></span><br><span class="line">    Integer <span class="title function_">getCode</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">getMessage</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><span id="more"></span><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">ResultEnum</span> <span class="keyword">implements</span> <span class="title class_">IResult</span> &#123;</span><br><span class="line"></span><br><span class="line">    SUCCESS(<span class="number">2001</span>, <span class="string">&quot;æ¥å£è°ƒç”¨æˆåŠŸ&quot;</span>),</span><br><span class="line"></span><br><span class="line">    FAILED(<span class="number">2002</span>, <span class="string">&quot;æ¥å£è°ƒç”¨å¤±è´¥&quot;</span>),</span><br><span class="line"></span><br><span class="line">    VALIDATE_FAILED(<span class="number">2003</span>, <span class="string">&quot;å‚æ•°æ ¡éªŒå¤±è´¥&quot;</span>),</span><br><span class="line"></span><br><span class="line">    FORBIDDEN(<span class="number">2004</span>, <span class="string">&quot;ç¦æ­¢è®¿é—®&quot;</span>)</span><br><span class="line"></span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Integer code;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String message;</span><br><span class="line"></span><br><span class="line">    ResultEnum(Integer code, String message) &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">        <span class="built_in">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMessage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Result</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Result&lt;T&gt; <span class="title function_">success</span><span class="params">(T data)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>&lt;&gt;(ResultEnum.SUCCESS.getCode(), ResultEnum.SUCCESS.getMessage(), data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Result&lt;T&gt; <span class="title function_">success</span><span class="params">(String message, T data)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>&lt;&gt;(ResultEnum.SUCCESS.getCode(), message, data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Result&lt;?&gt; failed() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>&lt;&gt;(ResultEnum.FAILED.getCode(), ResultEnum.FAILED.getMessage(), <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Result&lt;?&gt; failed(String message) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>&lt;&gt;(ResultEnum.FAILED.getCode(), message, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Result&lt;?&gt; failed(IResult result) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>&lt;&gt;(result.getCode(), result.getMessage(), <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;hello&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;world&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;String&gt; <span class="title function_">helloWorld</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.success(<span class="string">&quot;Hello, World!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;java&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;String&gt; <span class="title function_">helloJava</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.success(<span class="string">&quot;Hello, Java!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç°åœ¨æ‰€æœ‰æ¥å£çš„è¿”å›ç»“æ„éƒ½ç»Ÿä¸€äº†ï¼Œä½†æ¯ä¸ªæ¥å£éƒ½è¦å†™ä¸Šå°è£…çš„é€»è¾‘ä¹Ÿæ˜¯ä¸€é¡¹å¾ˆé‡å¤çš„å·¥ä½œï¼Œå¯ä»¥é€šè¿‡å®ç°<code>ResponseBodyAdvice</code>å¯¹ç»“æœç»Ÿä¸€åŒ…è£…ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestControllerAdvice(basePackages = &quot;com.tw.codesnippet&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResponseAdvice</span> <span class="keyword">implements</span> <span class="title class_">ResponseBodyAdvice</span>&lt;Object&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">supports</span><span class="params">(MethodParameter returnType, Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt; converterType)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">beforeBodyWrite</span><span class="params">(Object body, MethodParameter returnType, MediaType selectedContentType, Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt; selectedConverterType, ServerHttpRequest request, ServerHttpResponse response)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (body <span class="keyword">instanceof</span> Result) &#123;</span><br><span class="line">            <span class="keyword">return</span> body;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Result.success(body);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶Controllerå±‚çš„ä»£ç å°±å¯ä»¥ç®€åŒ–å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;hello&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;world&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">helloWorld</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello, World!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;java&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">helloJava</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello, Python!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†å¦‚æœè°ƒç”¨ä¸Šé¢çš„æ¥å£ä¼šæŠ›å‡ºå¦‚ä¸‹å¼‚å¸¸<code>Result cannot be cast to class java.lang.String</code>ï¼Œdebugå¯ä»¥å‘ç°ï¼Œå¦‚æœæ¥å£çš„è¿”å›å€¼æ˜¯Stringç±»å‹ï¼Œ<code>beforeBodyWrite</code>çš„<code>selectedConverterType</code>ä½¿ç”¨çš„æ˜¯<code>StringHttpMessageConverter</code>ï¼Œè€Œæ¥å£æ˜¯å…¶ä»–ç±»å‹è¿”å›å€¼æ—¶<code>selectedConverterType</code>ä½¿ç”¨çš„åˆ™æ˜¯<code>MappingJackson2HttpMessageConverter</code>ã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œç½‘ä¸Šçš„è§£å†³åŠæ³•æ˜¯æ·»åŠ ä¸€ä¸ª<code>MappingJackson2HttpMessageConverter</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configureMessageConverters</span><span class="params">(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters)</span> &#123;</span><br><span class="line">        converters.add(<span class="number">0</span>, <span class="keyword">new</span> <span class="title class_">MappingJackson2HttpMessageConverter</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†å®é™…è¿è¡Œä¼šå‘ç°ï¼Œ<code>selectedConverterType</code>çš„ç±»å‹ä¾ç„¶æ˜¯<code>StringHttpMessageConverter</code>ï¼Œå…·ä½“åŸå› æ˜¯ï¼šå½“æ¥å£è¿”å›Stringæ—¶ï¼ŒSpringé»˜è®¤ä¼šä¼˜å…ˆä½¿ç”¨<code>StringHttpMessageConverter</code>æ¥å¤„ç†ï¼Œå³ä½¿åœ¨<code>WebConfig</code>é‡Œæ·»åŠ äº†<code>MappingJackson2HttpMessageConverter</code>ã€‚</p><p>è¦è®©Springä½¿ç”¨<code>MappingJackson2HttpMessageConverter</code>æ¥å¤„ç†Stringè¿”å›å€¼å¹¶ç”ŸæˆJSONï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‡ ç§æ–¹æ³•ï¼š</p><ol><li>åˆ é™¤<code>StringHttpMessageConverter</code>ï¼Œç¡®ä¿Springä½¿ç”¨<code>MappingJackson2HttpMessageConverter</code>ä½œä¸ºè½¬æ¢å™¨</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configureMessageConverters</span><span class="params">(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters)</span> &#123;</span><br><span class="line">        converters.removeIf(converter -&gt; converter <span class="keyword">instanceof</span> StringHttpMessageConverter);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>æ˜¾ç¤ºæŒ‡å®š <code>Content-Type</code> å’Œ <code>Accept</code> å¤´</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -H <span class="string">&quot;Accept: application/json&quot;</span> http://localhost:8080/hello/world</span><br></pre></td></tr></table></figure><p>åœ¨å®¢æˆ·ç«¯çš„è¯·æ±‚ä¸­æ˜ç¡®æŒ‡å®š <code>Accept: application/json</code>ï¼Œè¿™æ · Spring ä¼šæ ¹æ® <code>Accept</code> å¤´ä½¿ç”¨ <code>MappingJackson2HttpMessageConverter</code> æ¥ç”Ÿæˆ JSON å“åº”ã€‚</p><ol start="3"><li>å¯¹äºStringç±»å‹ï¼Œè®©æ¥å£è¿”å›<code>Result&lt;String&gt;</code></li></ol><h2 id="å­—æ®µæ ¡éªŒ"><a href="#å­—æ®µæ ¡éªŒ" class="headerlink" title="å­—æ®µæ ¡éªŒ"></a>å­—æ®µæ ¡éªŒ</h2><p>JSR303 å®šä¹‰äº† Bean æ ¡éªŒçš„æ ‡å‡† validation-apiï¼Œhibernate validation æ˜¯å¯¹è¿™ä¸ªæ ‡å‡†çš„å®ç°ï¼ŒSpring Validation åˆ™æ˜¯å¯¹ hibernate validation çš„äºŒæ¬¡å°è£…ã€‚</p><h3 id="åŸºç¡€"><a href="#åŸºç¡€" class="headerlink" title="åŸºç¡€"></a>åŸºç¡€</h3><h4 id="å¼•å…¥ä¾èµ–"><a href="#å¼•å…¥ä¾èµ–" class="headerlink" title="å¼•å…¥ä¾èµ–"></a>å¼•å…¥ä¾èµ–</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hibernate.validator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hibernate-validator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å¯¹äº web æœåŠ¡æ¥è¯´ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œè¯·æ±‚å‚æ•°åˆ†ä¸ºå¦‚ä¸‹ä¸¤ç§å½¢å¼ï¼š</p><ul><li>GET è¯·æ±‚ï¼Œä½¿ç”¨ <code>@RequestParam</code> å’Œ <code>@PathVariable</code> ä¼ é€’å‚æ•°</li><li>POST å’Œ PUT è¯·æ±‚ï¼Œä½¿ç”¨ <code>@RequestBody</code> ä¼ é€’å‚æ•°</li></ul><h4 id="GET-è¯·æ±‚å‚æ•°æ ¡éªŒ"><a href="#GET-è¯·æ±‚å‚æ•°æ ¡éªŒ" class="headerlink" title="GET è¯·æ±‚å‚æ•°æ ¡éªŒ"></a>GET è¯·æ±‚å‚æ•°æ ¡éªŒ</h4><p>GET è¯·æ±‚ä¸€èˆ¬ç”¨ <code>@RequestParam</code> æˆ– <code>@PathVariable</code>  ä¼ å‚ï¼Œéœ€åœ¨ Controller ä¸ŠåŠ  <code>@Validated</code> æ³¨è§£ï¼Œå¹¶åœ¨æ¥å£å‚æ•°åŠ çº¦æŸæ³¨è§£ï¼Œè‡ªåŠ¨å‚æ•°æ ¡éªŒæ‰èƒ½ç”Ÿæ•ˆã€‚æ ¡éªŒå¤±è´¥ä¼šæŠ›å‡º <code>javax.validation.ConstraintViolationException</code> å¼‚å¸¸ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;user&quot;)</span></span><br><span class="line"><span class="meta">@Validated</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="keyword">public</span> UserDTO <span class="title function_">getUser</span><span class="params">(<span class="meta">@RequestParam(&quot;userId&quot;)</span> <span class="meta">@NotBlank</span> String userId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">UserDTO</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="POST-PUT-è¯·æ±‚å‚æ•°æ ¡éªŒ"><a href="#POST-PUT-è¯·æ±‚å‚æ•°æ ¡éªŒ" class="headerlink" title="POST&#x2F;PUT è¯·æ±‚å‚æ•°æ ¡éªŒ"></a>POST&#x2F;PUT è¯·æ±‚å‚æ•°æ ¡éªŒ</h4><p>POST æˆ– PUT è¯·æ±‚ä¸€èˆ¬ç”¨ <code>@RequestBody</code> ä¼ å‚ï¼Œåç«¯ä½¿ç”¨ DTO å¯¹è±¡æ¥æ”¶å‚æ•°ï¼Œåªéœ€è¦åœ¨ DTO å¯¹è±¡å‰åŠ ä¸Š <code>@Valid</code> æˆ– <code>@Validated</code> æ³¨è§£å°±å¯ä»¥å®ç°è‡ªåŠ¨å‚æ•°æ ¡éªŒï¼Œæ ¡éªŒå¤±è´¥ä¼šæŠ›å‡º <code>org.springframework.web.bind.MethodArgumentNotValidException</code> å¼‚å¸¸ã€‚</p><p>æ¯”å¦‚æœ‰ä¸€ä¸ªä¿å­˜ <code>User</code> çš„æ¥å£ï¼Œè¦æ±‚ <code>username</code> é•¿åº¦æ˜¯ 2-10 ä¸ªå­—ç¬¦ï¼Œ<code>password</code> é•¿åº¦ä¸å°äº 6 ä¸ªå­—ç¬¦</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDTO</span> &#123;</span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="meta">@Length(min = 2, max = 10)</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="meta">@Length(min = 6, max = 10)</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;save&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> UserDTO <span class="title function_">saveUser</span><span class="params">(<span class="meta">@RequestBody</span> <span class="meta">@Validated</span> UserDTO userDTO)</span> &#123; <span class="comment">// ä¹Ÿå¯ä»¥ä½¿ç”¨ @Valid</span></span><br><span class="line">        <span class="keyword">return</span> userDTO;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ç»Ÿä¸€å¼‚å¸¸å¤„ç†"><a href="#ç»Ÿä¸€å¼‚å¸¸å¤„ç†" class="headerlink" title="ç»Ÿä¸€å¼‚å¸¸å¤„ç†"></a>ç»Ÿä¸€å¼‚å¸¸å¤„ç†</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestControllerAdvice(&quot;com.tw.codesnippet&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonExceptionAdvice</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler(MethodArgumentNotValidException.class)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.OK)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">handleMethodArgumentNotValidException</span><span class="params">(MethodArgumentNotValidException ex)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">BindingResult</span> <span class="variable">bindingResult</span> <span class="operator">=</span> ex.getBindingResult();</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> bindingResult.getFieldError().getField() + <span class="string">&quot;:&quot;</span> + bindingResult.getFieldError().getDefaultMessage();</span><br><span class="line">        <span class="keyword">return</span> Result.failed(ResultEnum.VALIDATE_FAILED.getCode(), msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler(ConstraintViolationException.class)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.OK)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">handleConstraintViolationException</span><span class="params">(ConstraintViolationException ex)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.failed(ResultEnum.VALIDATE_FAILED.getCode(), ex.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è¿›é˜¶"><a href="#è¿›é˜¶" class="headerlink" title="è¿›é˜¶"></a>è¿›é˜¶</h3><h4 id="åˆ†ç»„æ ¡éªŒ"><a href="#åˆ†ç»„æ ¡éªŒ" class="headerlink" title="åˆ†ç»„æ ¡éªŒ"></a>åˆ†ç»„æ ¡éªŒ</h4><p>åœ¨å®é™…å¼€å‘ä¸­ï¼Œå­˜åœ¨å¤šä¸ªæ¥å£ä½¿ç”¨åŒä¸€ä¸ªDTOæ¥æ¥å£å‚æ•°çš„æƒ…å†µï¼Œè€Œä¸åŒçš„æ¥å£éœ€è¦æ ¡éªŒçš„å­—æ®µä»¥åŠè§„åˆ™å¯èƒ½ä¸ä¸€æ ·ï¼Œè¿™æ—¶åœ¨DTOçš„å­—æ®µä¸Šç¬¼ç»Ÿåœ°åŠ ä¸Šçº¦æŸæ³¨è§£æ— æ³•è¾¾åˆ°è¿™ä¸ªç›®çš„ã€‚ä¸ºæ­¤ï¼ŒSpring Validationæä¾›äº†åˆ†ç»„æ ¡éªŒåŠŸèƒ½ã€‚</p><p>è¿˜æ˜¯ä¸Šé¢è¿™ä¸ªä¾‹å­ï¼Œä¿å­˜<code>User</code>æ—¶ï¼Œ<code>userId</code>å¯ä»¥ä¸ºç©ºï¼Œä½†æ˜¯æ›´æ–°æ—¶ï¼Œ<code>userId</code>ä¸å…è®¸ä¸ºç©ºã€‚</p><ul><li>DTOå­—æ®µä¸Šçš„çº¦æŸæ³¨è§£æŒ‡å®šåˆ†ç»„</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDTO</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotBlank(groups = Update.class)</span></span><br><span class="line">    <span class="keyword">private</span> String userId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotBlank(groups = &#123;Save.class, Update.class&#125;)</span></span><br><span class="line">    <span class="meta">@Length(min = 2, max = 10, groups = &#123;Save.class, Update.class&#125;)</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotBlank(groups = &#123;Save.class, Update.class&#125;)</span></span><br><span class="line">    <span class="meta">@Length(min = 6, max = 10, groups = &#123;Save.class, Update.class&#125;)</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Save</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Update</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æ¥å£å‚æ•°çš„<code>@Validated</code>æ³¨è§£æŒ‡å®šåˆ†ç»„</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;user&quot;)</span></span><br><span class="line"><span class="meta">@Validated</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;save&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> UserDTO <span class="title function_">saveUser</span><span class="params">(<span class="meta">@RequestBody</span> <span class="meta">@Validated(UserDTO.Save.class)</span> UserDTO userDTO)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userDTO;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PutMapping(&quot;update&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> UserDTO <span class="title function_">updateUser</span><span class="params">(<span class="meta">@RequestBody</span> <span class="meta">@Validated(UserDTO.Update.class)</span> UserDTO userDTO)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userDTO;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>PSï¼šæ­¤æ—¶ä¸èƒ½ä½¿ç”¨<code>@Valid</code>æ³¨è§£ï¼Œå› ä¸º<code>@Valid</code>ä¸å…·æœ‰åˆ†ç»„æ ¡éªŒåŠŸèƒ½</p><h4 id="åµŒå¥—æ ¡éªŒ"><a href="#åµŒå¥—æ ¡éªŒ" class="headerlink" title="åµŒå¥—æ ¡éªŒ"></a>åµŒå¥—æ ¡éªŒ</h4><p>å¦‚æœDTOçš„æŸä¸ªå­—æ®µæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œè¦è‡ªåŠ¨æ ¡éªŒè¿™ä¸ªå¯¹è±¡çš„å±æ€§ï¼Œå°±å¾—ç”¨åˆ°åµŒå¥—æ ¡éªŒã€‚</p><ul><li>åœ¨DTOå¯¹è±¡å­—æ®µåŠ ä¸Š<code>@Valid</code>æ³¨è§£</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDTO</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotBlank(groups = Update.class)</span></span><br><span class="line">    <span class="keyword">private</span> String userId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotBlank(groups = &#123;Save.class, Update.class&#125;)</span></span><br><span class="line">    <span class="meta">@Length(min = 2, max = 10, groups = &#123;Save.class, Update.class&#125;)</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotBlank(groups = &#123;Save.class, Update.class&#125;)</span></span><br><span class="line">    <span class="meta">@Length(min = 6, max = 10, groups = &#123;Save.class, Update.class&#125;)</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotNull(groups = &#123;Save.class, Update.class&#125;)</span></span><br><span class="line">    <span class="meta">@Valid</span></span><br><span class="line">    <span class="keyword">private</span> Address address;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Address</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@NotBlank(groups = &#123;Save.class, Update.class&#125;)</span></span><br><span class="line">        <span class="keyword">private</span> String country;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@NotBlank(groups = &#123;Save.class, Update.class&#125;)</span></span><br><span class="line">        <span class="keyword">private</span> String state;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@NotBlank(groups = &#123;Save.class, Update.class&#125;)</span></span><br><span class="line">        <span class="keyword">private</span> String city;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@NotBlank(groups = &#123;Save.class, Update.class&#125;)</span></span><br><span class="line">        <span class="keyword">private</span> String street;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Save</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Update</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="è‡ªå®šä¹‰æ ¡éªŒ"><a href="#è‡ªå®šä¹‰æ ¡éªŒ" class="headerlink" title="è‡ªå®šä¹‰æ ¡éªŒ"></a>è‡ªå®šä¹‰æ ¡éªŒ</h4><p>æœ‰æ—¶æ¡†æ¶æä¾›çš„æ ¡éªŒæ— æ³•æ»¡è¶³ä¸šåŠ¡å¤æ‚çš„æ ¡éªŒéœ€æ±‚ï¼Œæ­¤æ—¶å¯ä»¥è‡ªå®šä¹‰æ ¡éªŒæ³¨è§£ã€‚</p><ul><li>è‡ªå®šä¹‰æ³¨è§£</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.FIELD, ElementType.PARAMETER&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Constraint(validatedBy = PhoneValidator.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Phone &#123;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">message</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;æ— æ•ˆçš„æ‰‹æœºå·&quot;</span>;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt;[] groups() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    Class&lt;? <span class="keyword">extends</span> <span class="title class_">Payload</span>&gt;[] payload() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å®ç°è‡ªå®šä¹‰æ ¡éªŒå™¨</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PhoneValidator</span> <span class="keyword">implements</span> <span class="title class_">ConstraintValidator</span>&lt;Phone, String&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Pattern</span> <span class="variable">PHONE_PATTERN</span> <span class="operator">=</span> Pattern.compile(<span class="string">&quot;^1[3-9]\\d&#123;9&#125;$&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isValid</span><span class="params">(String value, ConstraintValidatorContext context)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isBlank(value)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> PHONE_PATTERN.matcher(value).matches();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h1><h2 id="æ‰¹é‡æ›´æ–°æ—¶é—´"><a href="#æ‰¹é‡æ›´æ–°æ—¶é—´" class="headerlink" title="æ‰¹é‡æ›´æ–°æ—¶é—´"></a>æ‰¹é‡æ›´æ–°æ—¶é—´</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UPDATE user_operate_record</span><br><span class="line">SET create_time = DATE_ADD(&#x27;2023-04-01 00:00:00&#x27;, INTERVAL FLOOR(RAND() * 31536000) SECOND);</span><br></pre></td></tr></table></figure><h2 id="æ‰¹é‡æ’å…¥æ•°æ®"><a href="#æ‰¹é‡æ’å…¥æ•°æ®" class="headerlink" title="æ‰¹é‡æ’å…¥æ•°æ®"></a>æ‰¹é‡æ’å…¥æ•°æ®</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">DROP PROCEDURE IF EXISTS BatchInsert;</span><br><span class="line">delimiter $$</span><br><span class="line">CREATE PROCEDURE BatchInsert(IN loop_counts INT)</span><br><span class="line">BEGIN</span><br><span class="line">DECLARE Var LONG;</span><br><span class="line">SET Var = 0;</span><br><span class="line">SET autocommit = 0;</span><br><span class="line">WHILE Var &lt; loop_counts DO</span><br><span class="line">INSERT INTO `user_operate_record` (`iam_id`, `tenant_id`, `region`, `operate_type`, `operate_module`, `module_id`, `input_param`, `output_param`, `create_time`, `is_system`)</span><br><span class="line">VALUES (&#x27;4b98e1d72c214f72af1fa55cfcb5ecf8&#x27;, &#x27;afc4784e64d146549764787876c60856&#x27;, &#x27;cn-north-7&#x27;, &#x27;read&#x27;, &#x27;template&#x27;, &#x27;cb1069e0278144d8f49976285e1efe68&#x27;, null, null, &#x27;2023-05-30 00:00:00&#x27;, 1);</span><br><span class="line">SET Var = Var + 1;</span><br><span class="line">END WHILE;</span><br><span class="line">COMMIT;</span><br><span class="line">END$$;</span><br><span class="line"></span><br><span class="line">delimiter ;</span><br><span class="line">CALL BatchInsert(200000);</span><br></pre></td></tr></table></figure><h1 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h1><h2 id="RedisTemplateåºåˆ—åŒ–"><a href="#RedisTemplateåºåˆ—åŒ–" class="headerlink" title="RedisTemplateåºåˆ—åŒ–"></a>RedisTemplateåºåˆ—åŒ–</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title function_">redisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span> &#123;</span><br><span class="line">    RedisTemplate&lt;String, Object&gt; redisTemplate = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>&lt;&gt;();</span><br><span class="line">    redisTemplate.setConnectionFactory(redisConnectionFactory);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">StringRedisSerializer</span> <span class="variable">stringRedisSerializer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>();</span><br><span class="line">    redisTemplate.setKeySerializer(stringRedisSerializer);</span><br><span class="line">    redisTemplate.setHashKeySerializer(stringRedisSerializer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Jackson2JsonRedisSerializer&lt;Object&gt; jackson2JsonRedisSerializer = <span class="keyword">new</span> <span class="title class_">Jackson2JsonRedisSerializer</span>&lt;&gt;(Object.class);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">    objectMapper.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);</span><br><span class="line">    objectMapper.activateDefaultTyping(LaissezFaireSubTypeValidator.instance, ObjectMapper.DefaultTyping.NON_FINAL, JsonTypeInfo.As.PROPERTY);</span><br><span class="line">    jackson2JsonRedisSerializer.setObjectMapper(objectMapper);</span><br><span class="line"></span><br><span class="line">    redisTemplate.setValueSerializer(jackson2JsonRedisSerializer);</span><br><span class="line">    redisTemplate.setHashValueSerializer(jackson2JsonRedisSerializer);</span><br><span class="line"></span><br><span class="line">    redisTemplate.afterPropertiesSet();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> redisTemplate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Reidsé›†ç¾¤æ­å»º</title>
      <link href="/post/75b7478e.html"/>
      <url>/post/75b7478e.html</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸»ä»é›†ç¾¤"><a href="#ä¸»ä»é›†ç¾¤" class="headerlink" title="ä¸»ä»é›†ç¾¤"></a>ä¸»ä»é›†ç¾¤</h2><h3 id="ä¸»ä»åŒæ­¥åŸç†"><a href="#ä¸»ä»åŒæ­¥åŸç†" class="headerlink" title="ä¸»ä»åŒæ­¥åŸç†"></a>ä¸»ä»åŒæ­¥åŸç†</h3><p>ä¸»ä»åŒæ­¥æµç¨‹å¦‚å›¾ï¼š</p><img src="/post/75b7478e/image-20250219200529477.png" class="" title="image-20250219200529477"><p>ä¸»ä»åŒæ­¥ä¼˜åŒ–ï¼š</p><ul><li>åœ¨masterä¸­é…ç½®<code>repl-diskless-sync yes</code>å¯ç”¨æ— ç£ç›˜å¤åˆ¶ï¼Œé¿å…å…¨é‡å¤åˆ¶æ—¶çš„ç£ç›˜IO</li><li>å•èŠ‚ç‚¹ä¸ŠRediså ç”¨å†…å­˜ä¸è¦å¤ªå¤§ï¼Œå‡å°‘RDBæ–‡ä»¶çš„å¤§å°</li><li>é€‚å½“æé«˜<code>repl_log</code>çš„å¤§å°ï¼Œå‘ç°slaveå®•æœºæ—¶å°½å¿«å®ç°æ•…éšœæ¢å¤ï¼Œé¿å…å…¨é‡å¤åˆ¶</li></ul><h3 id="é›†ç¾¤æ­å»ºæµ‹è¯•"><a href="#é›†ç¾¤æ­å»ºæµ‹è¯•" class="headerlink" title="é›†ç¾¤æ­å»ºæµ‹è¯•"></a>é›†ç¾¤æ­å»ºæµ‹è¯•</h3><p>ä¸‹å›¾å°±æ˜¯ä¸€ä¸ªç®€å•çš„ä¸»ä»é›†ç¾¤ï¼Œå¦‚å›¾æ‰€ç¤ºï¼Œé›†ç¾¤åŒ…å«ä¸€ä¸ªä¸»èŠ‚ç‚¹ï¼Œä¸¤ä¸ªä»èŠ‚ç‚¹ã€‚ä¸»èŠ‚ç‚¹è´Ÿè´£å†™æ“ä½œï¼Œä»èŠ‚ç‚¹è´Ÿè´£è¯»æ“ä½œ</p><img src="/post/75b7478e/image-20250217231959576.png" class="" title="image-20250217231959576"><p>ä¸‹é¢åœ¨è™šæ‹Ÿæœºä¸­åˆ©ç”¨dockerå®¹å™¨æ­å»ºè¿™æ ·ä¸€ä¸ªä¸»ä»é›†ç¾¤ï¼Œé¦–å…ˆç¡®ä¿å®¹å™¨ä¸­æœ‰redisé•œåƒï¼Œå¦‚æœæ²¡æœ‰ï¼Œå¯ä»¥é€šè¿‡ <code>docker pull</code> å‘½ä»¤æ‹‰å–ã€‚</p><p>æ¥ç€é€šè¿‡<code>docker-compose.yaml</code>æ–‡ä»¶æ„å»ºé›†ç¾¤ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.2&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">r1:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">r1</span></span><br><span class="line">    <span class="attr">network_mode:</span> <span class="string">&quot;host&quot;</span></span><br><span class="line">    <span class="attr">entrypoint:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;--port&quot;</span>, <span class="string">&quot;7001&quot;</span>]</span><br><span class="line">  <span class="attr">r2:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">r2</span></span><br><span class="line">    <span class="attr">network_mode:</span> <span class="string">&quot;host&quot;</span></span><br><span class="line">    <span class="attr">entrypoint:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;--port&quot;</span>, <span class="string">&quot;7002&quot;</span>]</span><br><span class="line">  <span class="attr">r3:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">r3</span></span><br><span class="line">    <span class="attr">network_mode:</span> <span class="string">&quot;host&quot;</span></span><br><span class="line">    <span class="attr">entrypoint:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;--port&quot;</span>, <span class="string">&quot;7003&quot;</span>]</span><br></pre></td></tr></table></figure><p>åœ¨<code>docker-compose.yaml</code>æ–‡ä»¶æ‰€åœ¨ç›®å½•æ‰§è¡Œ<code>docker compose up -d</code>å‘½ä»¤å¯åŠ¨å®¹å™¨ï¼š</p><img src="/post/75b7478e/image-20250217233502378.png" class="" title="image-20250217233502378"><p>é€šè¿‡<code>docker compse</code>å‘½ä»¤å¯åŠ¨äº†3ä¸ªrediså®ä¾‹ï¼Œä½†è¿™3ä¸ªå®ä¾‹è¿˜æœªç»„æˆé›†ç¾¤ï¼Œå› ä¸ºå®ƒä»¬ä¹‹é—´æ²¡æœ‰ä¸»ä»å…³ç³»ã€‚ä¸»ä»å…³ç³»å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤è¿›è¡Œé…ç½®ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># redis5.0ä»¥å‰</span></span><br><span class="line">$ slaveof &lt;masterip&gt; &lt;masterport&gt;</span><br><span class="line"><span class="comment"># redis5.0ä»¥å</span></span><br><span class="line">$ replicaof &lt;masterip&gt; &lt;masterport&gt;</span><br></pre></td></tr></table></figure><p>ä¸»ä»å…³ç³»çš„é…ç½®æœ‰ä¸¤ç§ç”Ÿæ•ˆæ–¹å¼ï¼š</p><ul><li>æ°¸ä¹…ç”Ÿæ•ˆï¼šåœ¨<code>redis.conf</code>æ–‡ä»¶ä¸­åˆ©ç”¨<code>slaveof</code>åˆ¶å®š<code>master</code>èŠ‚ç‚¹</li><li>ä¸´æ—¶ç”Ÿæ•ˆï¼šé€šè¿‡<code>redis-cli</code>è¿æ¥åˆ°rediså®ä¾‹ï¼Œå¹¶æ‰§è¡Œ<code>slaveof</code>å‘½ä»¤æŒ‡å®š<code>master</code>èŠ‚ç‚¹</li></ul><p>ä¸‹é¢æ¼”ç¤ºä¸´æ—¶ç”Ÿæ•ˆæ–¹å¼é…ç½®ä¸»ä»å…³ç³»ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿æ¥r2</span></span><br><span class="line">$ docker <span class="built_in">exec</span> -it r2 redis-cli -p 7002</span><br><span class="line">127.0.0.1:7002&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:758df4b32faf526a279240093645cc45984d0502</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:0</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:0</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:0</span><br><span class="line">repl_backlog_histlen:0</span><br><span class="line">127.0.0.1:7002&gt; slaveof 192.168.33.11 7001</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:7002&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:slave</span><br><span class="line">master_host:192.168.33.11</span><br><span class="line">master_port:7001</span><br><span class="line">master_link_status:up</span><br><span class="line">master_last_io_seconds_ago:3</span><br><span class="line">master_sync_in_progress:0</span><br><span class="line">slave_read_repl_offset:14</span><br><span class="line">slave_repl_offset:14</span><br><span class="line">slave_priority:100</span><br><span class="line">slave_read_only:1</span><br><span class="line">replica_announced:1</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:5519e1a0e085620420c0a7afa2ccc5bf71826a52</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:14</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1</span><br><span class="line">repl_backlog_histlen:14</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿æ¥r3ï¼Œå¹¶æ‰§è¡Œç›¸åŒæ“ä½œ</span></span><br></pre></td></tr></table></figure><p>æ¥ç€è¿æ¥r1å¹¶é€šè¿‡<code>info replication</code>æŸ¥çœ‹èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹ä¿¡æ¯ï¼Œå¯ä»¥å‘ç°r1æ˜¯<code>master</code>èŠ‚ç‚¹ï¼Œå¹¶ä¸”æœ‰ä¸¤ä¸ªä»èŠ‚ç‚¹</p><img src="/post/75b7478e/image-20250217235009950.png" class="" title="image-20250217235009950"><p>æµ‹è¯•å†™æ“ä½œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># r1</span></span><br><span class="line">127.0.0.1:7001&gt; <span class="built_in">set</span> num 123</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:7001&gt; get num</span><br><span class="line"><span class="string">&quot;123&quot;</span></span><br><span class="line">127.0.0.1:7001&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># r2æˆ–r3</span></span><br><span class="line">127.0.0.1:7003&gt; <span class="built_in">set</span> num 456</span><br><span class="line">(error) READONLY You can<span class="string">&#x27;t write against a read only replica.</span></span><br><span class="line"><span class="string">127.0.0.1:7003&gt; get num</span></span><br><span class="line"><span class="string">&quot;123&quot;</span></span><br><span class="line"><span class="string">127.0.0.1:7003&gt;</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°ï¼Œä»èŠ‚ç‚¹åªèƒ½æ‰§è¡Œè¯»æ“ä½œã€‚</p><h2 id="å“¨å…µé›†ç¾¤"><a href="#å“¨å…µé›†ç¾¤" class="headerlink" title="å“¨å…µé›†ç¾¤"></a>å“¨å…µé›†ç¾¤</h2><p>ä¸»ä»é›†ç¾¤é™ä½äº†èŠ‚ç‚¹çš„è¯»å†™å‹åŠ›ï¼Œä½†æ˜¯å­˜åœ¨å•ç‚¹æ•…éšœçš„é£é™©ã€‚masterèŠ‚ç‚¹å¦‚æœå®•æœºï¼Œå°±ä¼šå¯¼è‡´æ•´ä¸ªé›†ç¾¤ä¸å¯ç”¨ã€‚Redisçš„å“¨å…µæœºåˆ¶å¯ä»¥é€šè¿‡å“¨å…µèŠ‚ç‚¹æ¥ç›‘æ§é›†ç¾¤çŠ¶æ€ï¼Œå½“æŸä¸ªèŠ‚ç‚¹å‡ºç°æ•…éšœï¼Œèƒ½åŠæ—¶åœ°è¿›è¡Œæ•…éšœè½¬ç§»ï¼Œä»è€Œä¿è¯é›†ç¾¤çš„é«˜å¯ç”¨æ€§ã€‚</p><h3 id="å“¨å…µå·¥ä½œåŸç†"><a href="#å“¨å…µå·¥ä½œåŸç†" class="headerlink" title="å“¨å…µå·¥ä½œåŸç†"></a>å“¨å…µå·¥ä½œåŸç†</h3><p>å“¨å…µé›†ç¾¤çš„ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p><img src="/post/75b7478e/image-20250219214812553.png" class="" title="image-20250219214812553"><p>å“¨å…µçš„ä½œç”¨åŒ…æ‹¬ï¼š</p><ul><li>ç›‘æ§é›†ç¾¤ä¸­redisèŠ‚ç‚¹çš„çŠ¶æ€</li><li>æ•…éšœæ¢å¤(failover)ï¼šå¦‚æœmasteræ•…éšœï¼Œå“¨å…µä¼šå°†å…¶ä¸­ä¸€ä¸ªslaveæå‡ä¸ºæ–°çš„masterï¼Œæ—§masteræ¢å¤åä¼šå˜ä¸ºæ–°masterçš„slave</li><li>çŠ¶æ€é€šçŸ¥ï¼šå½“é›†ç¾¤å‘ç”Ÿfailoveråï¼Œå“¨å…µä¼šå°†æœ€æ–°çš„é›†ç¾¤ä¿¡æ¯æ¨é€ç»™å®¢æˆ·ç«¯</li></ul><h4 id="çŠ¶æ€ç›‘æ§"><a href="#çŠ¶æ€ç›‘æ§" class="headerlink" title="çŠ¶æ€ç›‘æ§"></a>çŠ¶æ€ç›‘æ§</h4><h4 id="æ•…éšœæ¢å¤"><a href="#æ•…éšœæ¢å¤" class="headerlink" title="æ•…éšœæ¢å¤"></a>æ•…éšœæ¢å¤</h4><h2 id="åˆ†ç‰‡é›†ç¾¤"><a href="#åˆ†ç‰‡é›†ç¾¤" class="headerlink" title="åˆ†ç‰‡é›†ç¾¤"></a>åˆ†ç‰‡é›†ç¾¤</h2><h2 id="æºç ç¯å¢ƒæ­å»º"><a href="#æºç ç¯å¢ƒæ­å»º" class="headerlink" title="æºç ç¯å¢ƒæ­å»º"></a>æºç ç¯å¢ƒæ­å»º</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># clone æºç </span></span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/redis/redis.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿›å…¥redisç›®å½•</span></span><br><span class="line">$ <span class="built_in">cd</span> redis</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»åˆ¶å®štagåˆ›å»ºåˆ†æ”¯</span></span><br><span class="line">$ git checkout tags/7.0.5 -b 7.0.5</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ˜¯å¦å®‰è£…äº†gccç¼–è¯‘å™¨</span></span><br><span class="line">$ gcc -v</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¦‚æœæ²¡æœ‰åˆ¶å®šä»¥ä¸‹å‘½ä»¤å®‰è£…</span></span><br><span class="line">$ xcode-select --install</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨redisç›®å½•æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ç¼–è¯‘æºç </span></span><br><span class="line"><span class="comment"># -O0 è¡¨ç¤ºä¸è¦ä¼˜åŒ–ä»£ç ï¼Œé˜²æ­¢åœ¨Debugçš„æ—¶å€™ï¼Œ IDEé‡Œé¢çš„Redisæºç ä¸å®é™…è¿è¡Œçš„ä»£ç å¯¹åº”ä¸ä¸Š</span></span><br><span class="line">$ make CFLAGS=<span class="string">&quot;-g -O0&quot;</span> MALLOC=jemalloc</span><br></pre></td></tr></table></figure><p><code>CLion</code> å¯¼å…¥redisæºç å¹¶è¿›è¡Œå¦‚ä¸‹é…ç½®ï¼š</p><img src="/post/75b7478e/image-20250217230303910.png" class="" title="image-20250217230303910"><p>ç›´æ¥debugå¯åŠ¨ï¼Œç›¸å½“äºæ‰§è¡Œå‘½ä»¤ <code>/Users/tw/CLionProjects/redis/src/redis-server redis.conf</code>ï¼Œæ¥ä¸‹æ¥åœ¨<code>server.c</code>çš„<code>main()</code>ä¸­æ‰“æ–­ç‚¹ï¼Œå°±å¯ä»¥debugè°ƒè¯•æºç äº†ã€‚</p><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      <categories>
          
          <category> æ•°æ®å­˜å‚¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>shellç¼–ç¨‹</title>
      <link href="/post/6e95fc76.html"/>
      <url>/post/6e95fc76.html</url>
      
        <content type="html"><![CDATA[<h1 id="shellåŸºæœ¬å‘½ä»¤"><a href="#shellåŸºæœ¬å‘½ä»¤" class="headerlink" title="shellåŸºæœ¬å‘½ä»¤"></a>shellåŸºæœ¬å‘½ä»¤</h1><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>#!/bin/bash</code></td><td>è„šæœ¬å›ºå®šå¼€å¤´</td></tr><tr><td><code>$PATH</code></td><td>åœ¨è„šæœ¬ä¸­å¼•ç”¨ç¯å¢ƒå˜é‡</td></tr><tr><td>today&#x3D;`date`</td><td>æ›¿æ¢å‘½ä»¤ï¼Œå°† <code>date</code> çš„è¾“å‡ºèµ‹ç»™ <code>today</code></td></tr><tr><td><code>today=$(date)</code></td><td>åŒä¸Š</td></tr><tr><td><code>date +%y%m%d</code></td><td>å°†æ—¥æœŸæ˜¾ç¤ºä¸ºä¸¤ä½æ•°çš„å¹´æœˆæ—¥çš„ç»„åˆ ï¼Œå¦‚250108</td></tr><tr><td><code>$[3 * 5]</code></td><td>æ•°å­¦è¿ç®—</td></tr><tr><td><code>(( expression ))</code></td><td>ç”¨äºæ•°å­¦è¡¨è¾¾å¼</td></tr><tr><td><code>[[ expression ]]</code></td><td>ç”¨äºé«˜çº§å­—ç¬¦ä¸²å¤„ç†</td></tr><tr><td><code>IFS=$&#39;\n&#39;</code></td><td>ä¿®æ”¹å†…éƒ¨å­—æ®µåˆ†éš”ç¬¦</td></tr><tr><td><code>for file in /etc/*</code></td><td>éå†ç›®å½•</td></tr></tbody></table><p>æ¡ä»¶æµ‹è¯•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> [ condition ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line"> commands</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><ul><li>æ•°å€¼æ¯”è¾ƒ</li></ul><table><thead><tr><th>æ¯”è¾ƒ</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>n1 -eq n2</code></td><td>æ£€æŸ¥n1æ˜¯å¦ä¸n2ç›¸ç­‰</td></tr><tr><td><code>n1 -ge n2</code></td><td>æ£€æŸ¥n1æ˜¯å¦å¤§äºæˆ–ç­‰äºn2</td></tr><tr><td><code>n1 -gt n2</code></td><td>æ£€æŸ¥n1æ˜¯å¦å¤§äºn2</td></tr><tr><td><code>n1 -le n2</code></td><td>æ£€æŸ¥n1æ˜¯å¦å°äºæˆ–ç­‰äºn2</td></tr><tr><td><code>n1 -lt n2</code></td><td>æ£€æŸ¥n1æ˜¯å¦å°äºn2</td></tr><tr><td><code>n1 -ne n2</code></td><td>æ£€æŸ¥n1æ˜¯å¦ä¸ç­‰äºn2</td></tr></tbody></table><ul><li>å­—ç¬¦ä¸²æ¯”è¾ƒ</li></ul><table><thead><tr><th>æ¯”è¾ƒ</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>str1 = str2</code></td><td>æ£€æŸ¥str1æ˜¯å¦å’Œstr2ç›¸åŒ</td></tr><tr><td><code>str1 != str2</code></td><td>æ£€æŸ¥str1æ˜¯å¦å’Œstr2ä¸åŒ</td></tr><tr><td><code>str1 &lt; str2</code></td><td>æ£€æŸ¥str1æ˜¯å¦æ¯”str2å°</td></tr><tr><td><code>str1 &gt; str2</code></td><td>æ£€æŸ¥str1æ˜¯å¦æ¯”str2å¤§</td></tr><tr><td><code>-n str1</code></td><td>æ£€æŸ¥str1çš„é•¿åº¦æ˜¯å¦é0</td></tr><tr><td><code>-z str1</code></td><td>æ£€æŸ¥str1çš„é•¿åº¦æ˜¯å¦ä¸º0</td></tr></tbody></table><ul><li>æ–‡ä»¶æ¯”è¾ƒ</li></ul><table><thead><tr><th>æ¯”è¾ƒ</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>-d file</code></td><td>æ£€æŸ¥fileæ˜¯å¦å­˜åœ¨å¹¶æ˜¯ä¸€ä¸ªç›®å½•</td></tr><tr><td><code>-e file</code></td><td>æ£€æŸ¥fileæ˜¯å¦å­˜åœ¨</td></tr><tr><td><code>-f file</code></td><td>æ£€æŸ¥fileæ˜¯å¦å­˜åœ¨å¹¶æ˜¯ä¸€ä¸ªæ–‡ä»¶</td></tr><tr><td><code>-r file</code></td><td>æ£€æŸ¥fileæ˜¯å¦å­˜åœ¨å¹¶å¯è¯»</td></tr><tr><td><code>-s file</code></td><td>æ£€æŸ¥fileæ˜¯å¦å­˜åœ¨å¹¶éç©º</td></tr><tr><td><code>-w file</code></td><td>æ£€æŸ¥fileæ˜¯å¦å­˜åœ¨å¹¶å¯å†™</td></tr><tr><td><code>-x file</code></td><td>æ£€æŸ¥fileæ˜¯å¦å­˜åœ¨å¹¶å¯æ‰§è¡Œ</td></tr><tr><td><code>-O file</code></td><td>æ£€æŸ¥fileæ˜¯å¦å­˜åœ¨å¹¶å±å½“å‰ç”¨æˆ·æ‰€æœ‰</td></tr><tr><td><code>-G file</code></td><td>æ£€æŸ¥fileæ˜¯å¦å­˜åœ¨å¹¶ä¸”é»˜è®¤ç»„ä¸å½“å‰ç”¨æˆ·ç›¸åŒ</td></tr><tr><td><code>file1 -nt file2</code></td><td>æ£€æŸ¥file1æ˜¯å¦æ¯”file2æ–°</td></tr><tr><td><code>file1 -ot file2</code></td><td>æ£€æŸ¥file1æ˜¯å¦æ¯”file2æ—§</td></tr></tbody></table><h1 id="æ­£åˆ™è¡¨è¾¾å¼"><a href="#æ­£åˆ™è¡¨è¾¾å¼" class="headerlink" title="æ­£åˆ™è¡¨è¾¾å¼"></a>æ­£åˆ™è¡¨è¾¾å¼</h1><h1 id="grep"><a href="#grep" class="headerlink" title="grep"></a>grep</h1><h1 id="sed"><a href="#sed" class="headerlink" title="sed"></a>sed</h1><p><code>sed</code> ç¼–è¾‘å™¨å¯ä»¥æ ¹æ®å‘½ä»¤æ¥å¤„ç†æ•°æ®æµä¸­çš„æ•°æ®ï¼Œè¿™äº›å‘½ä»¤è¦ä¹ˆä»å‘½ä»¤è¡Œä¸­è¾“å…¥ï¼Œè¦ä¹ˆå­˜å‚¨åœ¨ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ä¸­ã€‚<code>sed</code> ç¼–è¾‘å™¨ä¼šæ‰§è¡Œä¸‹åˆ—æ“ä½œï¼š</p><ol><li>ä¸€æ¬¡ä»è¾“å…¥ä¸­è¯»å–ä¸€è¡Œæ•°æ®ã€‚</li><li>æ ¹æ®æ‰€æä¾›çš„ç¼–è¾‘å™¨å‘½ä»¤åŒ¹é…æ•°æ®ã€‚</li><li>æŒ‰ç…§å‘½ä»¤ä¿®æ”¹æµä¸­çš„æ•°æ®ã€‚</li><li>å°†æ–°çš„æ•°æ®è¾“å‡ºåˆ° <code>STDOUT</code> æˆ–æ–‡ä»¶ä¸­ã€‚</li></ol><h2 id="åŸºæœ¬æ¦‚å¿µ"><a href="#åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h2><h3 id="æ¨¡å¼ç©ºé—´å’Œä¿æŒç©ºé—´"><a href="#æ¨¡å¼ç©ºé—´å’Œä¿æŒç©ºé—´" class="headerlink" title="æ¨¡å¼ç©ºé—´å’Œä¿æŒç©ºé—´"></a>æ¨¡å¼ç©ºé—´å’Œä¿æŒç©ºé—´</h3><p>æ¨¡å¼ç©ºé—´ï¼ˆPattern Spaceï¼‰æ˜¯å½“å‰å·¥ä½œçš„ç©ºé—´ï¼Œsedç¼–è¾‘å™¨ä¼šå°†æ•°æ®æµä¸­æ–‡æœ¬è¡Œè¯»å…¥åˆ°æ¨¡å¼ç©ºé—´è¿›è¡Œå¤„ç†ã€‚ä¿æŒç©ºé—´ï¼ˆHold Spaceï¼‰å¯ä»¥çœ‹ä½œæ˜¯æ¨¡å¼ç©ºé—´çš„å¤‡ä»½ç©ºé—´ï¼Œå¯ä»¥å°†æ¨¡å¼ç©ºé—´çš„æŸäº›è¡Œä¸´æ—¶å­˜å‚¨åœ¨ä¿æŒç©ºé—´ï¼Œä¹‹åå†å°†è¿™äº›è¡Œä»ä¿æŒç©ºé—´ç§»å›æ¨¡å¼ç©ºé—´ã€‚</p><p>æ¨¡å¼ç©ºé—´å’Œä¿æŒç©ºé—´çš„äº¤äº’å‘½ä»¤å¦‚ä¸‹ï¼š</p><table><thead><tr><th>å‘½ä»¤</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>h</code></td><td>å°†æ¨¡å¼ç©ºé—´å¤åˆ¶åˆ°ä¿æŒç©ºé—´</td></tr><tr><td><code>H</code></td><td>å°†æ¨¡å¼ç©ºé—´é™„åŠ åˆ°ä¿æŒç©ºé—´</td></tr><tr><td><code>g</code></td><td>å°†ä¿æŒç©ºé—´å¤åˆ¶åˆ°æ¨¡å¼ç©ºé—´</td></tr><tr><td><code>G</code></td><td>å°†ä¿æŒç©ºé—´é™„åŠ åˆ°æ¨¡å¼ç©ºé—´</td></tr><tr><td><code>X</code></td><td>äº¤ä»˜ä¸¤ä¸ªç©ºé—´çš„å†…å®¹</td></tr></tbody></table><h3 id="åœ°å€"><a href="#åœ°å€" class="headerlink" title="åœ°å€"></a>åœ°å€</h3><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œåœ¨sedç¼–è¾‘å™¨ä¸­ä½¿ç”¨çš„å‘½ä»¤ä¼šä½œç”¨äºæ–‡æœ¬æ•°æ®çš„æ‰€æœ‰è¡Œã€‚å¦‚æœåªæƒ³å°†å‘½ä»¤ä½œç”¨äºç‰¹å®šè¡Œæˆ–æŸäº›è¡Œï¼Œåˆ™å¿…é¡»ç”¨è¡Œå¯»å€ï¼ˆline addressingï¼‰ã€‚åœ¨sedç¼–è¾‘å™¨ä¸­æœ‰ä¸¤ç§å½¢å¼çš„è¡Œå¯»å€ï¼š</p><ul><li>ä»¥æ•°å­—å½¢å¼è¡¨ç¤ºè¡ŒåŒºé—´</li><li>ç”¨æ–‡æœ¬æ¨¡å¼æ¥è¿‡æ»¤å‡ºè¡Œ</li></ul><h4 id="æ•°å­—å½¢å¼è¡Œå¯»å€"><a href="#æ•°å­—å½¢å¼è¡Œå¯»å€" class="headerlink" title="æ•°å­—å½¢å¼è¡Œå¯»å€"></a>æ•°å­—å½¢å¼è¡Œå¯»å€</h4><ul><li>æŒ‡å®šæŸè¡Œï¼š<code>sed &#39;2command&#39; file</code></li><li>æŒ‡å®šè¡ŒåŒºé—´ï¼š<code>sed &#39;2,3command&#39; file</code></li><li>ä»æŸè¡Œå¼€å§‹åˆ°ç»“å°¾ï¼š<code>sed &#39;2,$command&#39; file</code></li></ul><h4 id="æ–‡æœ¬æ¨¡å¼è¡Œå¯»å€"><a href="#æ–‡æœ¬æ¨¡å¼è¡Œå¯»å€" class="headerlink" title="æ–‡æœ¬æ¨¡å¼è¡Œå¯»å€"></a>æ–‡æœ¬æ¨¡å¼è¡Œå¯»å€</h4><ul><li>åŒ¹é…æŸè¡Œï¼š<code>sed &#39;/pattern/command&#39; file</code></li><li>åŒ¹é…è¡ŒåŒºé—´ï¼š<code>sed &#39;/start/[,/end/]command&#39; file</code></li></ul><h2 id="åŸºæœ¬å‘½ä»¤"><a href="#åŸºæœ¬å‘½ä»¤" class="headerlink" title="åŸºæœ¬å‘½ä»¤"></a>åŸºæœ¬å‘½ä»¤</h2><h3 id="æ›¿æ¢ï¼šs"><a href="#æ›¿æ¢ï¼šs" class="headerlink" title="æ›¿æ¢ï¼šs"></a>æ›¿æ¢ï¼šs</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># data1.txt</span></span><br><span class="line">$ <span class="built_in">cat</span> data1.txt</span><br><span class="line">The quick brown fox jumps over the lazy dog.</span><br><span class="line">The quick brown fox jumps over the lazy dog.</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å•ä¸ªç¼–è¾‘å™¨å‘½ä»¤ï¼Œå°†dogæ›¿æ¢æˆcat</span></span><br><span class="line">$ sed <span class="string">&quot;s/dog/cat/&quot;</span> data1.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤šä¸ªç¼–è¾‘å™¨å‘½ä»¤ï¼Œå°†brownæ›¿æ¢æˆgreenï¼ŒåŒæ—¶å°†dogæ›¿æ¢æˆcat</span></span><br><span class="line">$ sed <span class="string">&#x27;s/brown/green/; s/dog/cat/&#x27;</span> data1.txt</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> script1.sed</span><br><span class="line">s/brown/green/</span><br><span class="line">s/dog/cat/</span><br><span class="line"></span><br><span class="line"><span class="comment"># é€šè¿‡ -f é€‰é¡¹ä»æ–‡ä»¶ä¸­è¯»å–ç¼–è¾‘å™¨å‘½ä»¤</span></span><br><span class="line">$ sed -f script1.sed data1.txt</span><br></pre></td></tr></table></figure><p>æ›¿æ¢å‘½ä»¤é»˜è®¤åªæ›¿æ¢ç¬¬ä¸€å¤„åŒ¹é…çš„æ–‡æœ¬ï¼Œè¦æƒ³æ›¿æ¢å…¶ä»–ä½ç½®åŒ¹é…æ–‡æœ¬å¿…é¡»ä½¿ç”¨<strong>æ›¿æ¢æ ‡è®°</strong>ï¼Œä½¿ç”¨æ–¹å¼ï¼š<code>s/pattern/replacement/flags</code>ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># data2.txt</span></span><br><span class="line">$ <span class="built_in">cat</span> data2.txt</span><br><span class="line">This is a <span class="built_in">test</span> of the <span class="built_in">test</span> script.</span><br><span class="line">This is the second <span class="built_in">test</span> of the <span class="built_in">test</span> script.</span><br></pre></td></tr></table></figure><p>æ•°å­—ï¼šæŒ‡å®šæ›¿æ¢ç¬¬å‡ ä¸ªåŒ¹é…çš„æ–‡æœ¬</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŒ‡å®šæ›¿æ¢ç¬¬å‡ ä¸ªåŒ¹é…çš„æ–‡æœ¬</span></span><br><span class="line">$ sed <span class="string">&#x27;s/test/trial/2&#x27;</span> data2.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ›¿æ¢æ‰€æœ‰åŒ¹é…çš„æ–‡æœ¬</span></span><br><span class="line">$ sed <span class="string">&#x27;s/test/trial/g&#x27;</span> data2.txt</span><br></pre></td></tr></table></figure><h3 id="åˆ é™¤ï¼šd"><a href="#åˆ é™¤ï¼šd" class="headerlink" title="åˆ é™¤ï¼šd"></a>åˆ é™¤ï¼šd</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># data3.txt</span></span><br><span class="line">$ <span class="built_in">cat</span> data3.txt</span><br><span class="line">This is line number 1.</span><br><span class="line">This is line number 2.</span><br><span class="line">This is line number 3.</span><br><span class="line">This is line number 4.</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ é™¤ç¬¬3è¡Œ</span></span><br><span class="line">$ sed <span class="string">&#x27;3d&#x27;</span> data3.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤ç¬¬2ï½3è¡Œ</span></span><br><span class="line">$ sed <span class="string">&#x27;2,3d&#x27;</span> data3.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤ä»ç¬¬2è¡Œå¼€å§‹çš„æ‰€æœ‰è¡Œ</span></span><br><span class="line">$ sed <span class="string">&#x27;2,$d&#x27;</span> data3.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤åŒ¹é…åˆ°æ–‡æœ¬çš„è¡Œ</span></span><br><span class="line">$ sed <span class="string">&#x27;/number 1/d&#x27;</span> data3.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤æ–‡æœ¬ä¸­çš„ç©ºè¡Œ</span></span><br><span class="line">$ sed <span class="string">&#x27;/^$/d&#x27;</span> data4.txt</span><br></pre></td></tr></table></figure><h3 id="æ’å…¥ï¼ši"><a href="#æ’å…¥ï¼ši" class="headerlink" title="æ’å…¥ï¼ši"></a>æ’å…¥ï¼ši</h3><ul><li>æ’å…¥ä¸€è¡Œ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;Test Line 2&quot;</span> | sed <span class="string">&#x27;i Test Line 1&#x27;</span></span><br><span class="line">Test Line 1</span><br><span class="line">Test Line 2</span><br></pre></td></tr></table></figure><ul><li>æ’å…¥å¤šè¡Œ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;Test Line 2&quot;</span> | sed <span class="string">&#x27;i Test Line 1\</span></span><br><span class="line"><span class="string">&gt; Test Line 3&#x27;</span></span><br><span class="line">Test Line 1</span><br><span class="line">Test Line 3</span><br><span class="line">Test Line 2</span><br></pre></td></tr></table></figure><ul><li>åœ¨æ–‡ä»¶å¼€å¤´æ’å…¥</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ sed <span class="string">&#x27;1i This is one line of new Text.&#x27;</span> data3.txt</span><br><span class="line">This is one line of new Text.</span><br><span class="line">This is line number 1.</span><br><span class="line">This is line number 2.</span><br><span class="line">This is line number 3.</span><br><span class="line">This is line number 4.</span><br></pre></td></tr></table></figure><h3 id="è¿½åŠ ï¼ša"><a href="#è¿½åŠ ï¼ša" class="headerlink" title="è¿½åŠ ï¼ša"></a>è¿½åŠ ï¼ša</h3><ul><li>è¿½åŠ ä¸€è¡Œ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;Test Line 2&quot;</span> | sed <span class="string">&#x27;a Test Line 1&#x27;</span></span><br><span class="line">Test Line 2</span><br><span class="line">Test Line 1</span><br></pre></td></tr></table></figure><ul><li>è¿½åŠ å¤šè¡Œ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;Test Line 2&quot;</span> | sed <span class="string">&#x27;a Test Line 1\</span></span><br><span class="line"><span class="string">&gt; Test Line 3&#x27;</span></span><br><span class="line">Test Line 2</span><br><span class="line">Test Line 1</span><br><span class="line">Test Line 3</span><br></pre></td></tr></table></figure><ul><li>åœ¨æ–‡ä»¶æœ«å°¾è¿½åŠ </li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ sed <span class="string">&#x27;$a This is one line of new text.&#x27;</span> data3.txt</span><br><span class="line">This is line number 1.</span><br><span class="line">This is line number 2.</span><br><span class="line">This is line number 3.</span><br><span class="line">This is line number 4.</span><br><span class="line">This is one line of new text.</span><br></pre></td></tr></table></figure><h3 id="ä¿®æ”¹è¡Œï¼šc"><a href="#ä¿®æ”¹è¡Œï¼šc" class="headerlink" title="ä¿®æ”¹è¡Œï¼šc"></a>ä¿®æ”¹è¡Œï¼šc</h3><ul><li>ä¿®æ”¹æŒ‡å®šè¡Œ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sed <span class="string">&#x27;3c This is a changed line of text.&#x27;</span> data3.txt</span><br><span class="line">This is line number 1.</span><br><span class="line">This is line number 2.</span><br><span class="line">This is a changed line of text.</span><br><span class="line">This is line number 4.</span><br></pre></td></tr></table></figure><ul><li>ä¿®æ”¹åŒ¹é…åˆ°æ¨¡å¼çš„è¡Œ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sed <span class="string">&#x27;/number 3/c This is a changed line of text.&#x27;</span> data3.txt</span><br><span class="line">This is line number 1.</span><br><span class="line">This is line number 2.</span><br><span class="line">This is a changed line of text.</span><br><span class="line">This is line number 4.</span><br></pre></td></tr></table></figure><h3 id="è½¬æ¢ï¼šy"><a href="#è½¬æ¢ï¼šy" class="headerlink" title="è½¬æ¢ï¼šy"></a>è½¬æ¢ï¼šy</h3><p><code>sed &#39;[address]y/inchars/outchars/ file&#39;</code>ï¼šå¯¹ <code>inchars</code> å’Œ <code>outchars</code> çš„å€¼è¿›è¡Œä¸€å¯¹ä¸€æ˜ å°„</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sed <span class="string">&#x27;y/23/ab/&#x27;</span> data3.txt</span><br><span class="line">This is line number 1.</span><br><span class="line">This is line number a.</span><br><span class="line">This is line number b.</span><br><span class="line">This is line number 4.</span><br></pre></td></tr></table></figure><h3 id="æ‰“å°ï¼šp"><a href="#æ‰“å°ï¼šp" class="headerlink" title="æ‰“å°ï¼šp"></a>æ‰“å°ï¼šp</h3><ul><li>æ‰“å°ç¬¬2è¡Œ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sed -n <span class="string">&#x27;2p&#x27;</span> data3.txt</span><br><span class="line">This is line number 2.</span><br></pre></td></tr></table></figure><ul><li>æ‰“å°ç¬¬2ï½3è¡Œ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sed -n <span class="string">&#x27;2,3p&#x27;</span> data3.txt</span><br><span class="line">This is line number 2.</span><br><span class="line">This is line number 3.</span><br></pre></td></tr></table></figure><ul><li>æ‰“å°åŒ¹é…åˆ°çš„è¡Œ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sed -n <span class="string">&#x27;/number 3/p&#x27;</span> data3.txt</span><br><span class="line">This is line number 3.</span><br></pre></td></tr></table></figure><ul><li>åŒæ—¶æ‰“å°åŸæ¥çš„è¡Œå’Œä¿®æ”¹åçš„è¡Œ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ sed -n <span class="string">&#x27;/3/&#123;</span></span><br><span class="line"><span class="string">&gt; p</span></span><br><span class="line"><span class="string">&gt; s/line/test/p</span></span><br><span class="line"><span class="string">&gt; &#125;&#x27;</span> data3.txt</span><br><span class="line">This is line number 3.</span><br><span class="line">This is <span class="built_in">test</span> number 3.</span><br></pre></td></tr></table></figure><ul><li>åŒæ¨¡å¼åŒ¹é…ï¼Œå¯ä»¥ç”¨æ¥è¿‡æ»¤å‡ºæŸä¸ªæ—¶é—´æ®µå†…çš„æ—¥å¿—</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sed -n <span class="string">&#x27;/2/,/3/p&#x27;</span> data3.txt</span><br><span class="line">This is line number 2.</span><br><span class="line">This is line number 3.</span><br></pre></td></tr></table></figure><h3 id="å†™æ–‡ä»¶ï¼šw"><a href="#å†™æ–‡ä»¶ï¼šw" class="headerlink" title="å†™æ–‡ä»¶ï¼šw"></a>å†™æ–‡ä»¶ï¼šw</h3><ul><li>å°†æ•°æ®æ–‡ä»¶çš„ç¬¬1è¡Œå†™å…¥æ–°æ–‡ä»¶</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sed <span class="string">&#x27;1w data3_1.txt&#x27;</span> data3.txt</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> data3_1.txt</span><br><span class="line">This is line number 1.</span><br></pre></td></tr></table></figure><ul><li>å°†æ•°æ®æ–‡ä»¶çš„ç¬¬2ï½3è¡Œå†™å…¥æ–°æ–‡ä»¶</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sed <span class="string">&#x27;2,3w data3_23.txt&#x27;</span> data3.txt</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> data3_23.txt</span><br><span class="line">This is line number 2.</span><br><span class="line">This is line number 3.</span><br></pre></td></tr></table></figure><ul><li>å†™å…¥åŒ¹é…åˆ°çš„è¡Œ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sed <span class="string">&#x27;/4/w data3_4.txt&#x27;</span> data3.txt</span><br><span class="line"> </span><br><span class="line">$ <span class="built_in">cat</span> data3_4.txt</span><br><span class="line">This is line number 4.</span><br></pre></td></tr></table></figure><p>PSï¼šé™¤äº†å¯ä»¥é€šè¿‡wå‘½ä»¤å†™æ–‡ä»¶ï¼Œè¿˜å¯ä»¥é€šè¿‡ <code>-i</code> é€‰é¡¹ç›´æ¥ç¼–è¾‘åŸæ–‡ä»¶ã€‚</p><h3 id="ç§»åŠ¨åˆ°ä¸‹ä¸€è¡Œï¼šn"><a href="#ç§»åŠ¨åˆ°ä¸‹ä¸€è¡Œï¼šn" class="headerlink" title="ç§»åŠ¨åˆ°ä¸‹ä¸€è¡Œï¼šn"></a>ç§»åŠ¨åˆ°ä¸‹ä¸€è¡Œï¼šn</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># data5.txt</span></span><br><span class="line">$ <span class="built_in">cat</span> data5.txt</span><br><span class="line">This is the header line.</span><br><span class="line"></span><br><span class="line">This is a data line.</span><br><span class="line"></span><br><span class="line">This is the last line.</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ³¨æ„ï¼šæœ‰äº›ç³»ç»Ÿéœ€åœ¨dåé¢åŠ ä¸€ä¸ªåˆ†å·;</span></span><br><span class="line">$ sed <span class="string">&#x27;/header/&#123;n; d&#125;&#x27;</span> data5.txt</span><br><span class="line">This is the header line.</span><br><span class="line">This is a data line.</span><br><span class="line"></span><br><span class="line">This is the last line.</span><br></pre></td></tr></table></figure><p>å‘½ä»¤è§£é‡Šï¼šè¦åˆ é™¤ç¬¬1è¡Œå’Œç¬¬3è¡Œä¹‹é—´çš„ç©ºç™½è¡Œï¼Œéœ€å…ˆæ ¹æ®<code>/header/</code>åŒ¹é…åˆ°ç¬¬1è¡Œï¼Œå†ç”¨nå‘½ä»¤è®©sedç¼–è¾‘å™¨ç§»åŠ¨åˆ°ä¸‹ä¸€è¡Œï¼Œæœ€åç”¨då‘½ä»¤åˆ é™¤ç©ºç™½è¡Œã€‚</p><h3 id="è¿½åŠ ä¸‹ä¸€è¡Œï¼šN"><a href="#è¿½åŠ ä¸‹ä¸€è¡Œï¼šN" class="headerlink" title="è¿½åŠ ä¸‹ä¸€è¡Œï¼šN"></a>è¿½åŠ ä¸‹ä¸€è¡Œï¼šN</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># data6.txt</span></span><br><span class="line">$ <span class="built_in">cat</span> data6.txt</span><br><span class="line">This is the header line.</span><br><span class="line">This is the first data line.</span><br><span class="line">This is the second data line.</span><br><span class="line">This is the last line.</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sed <span class="string">&#x27;/first/&#123;N ; s/\n/ /&#125;&#x27;</span> data6.txt</span><br><span class="line">This is the header line.</span><br><span class="line">This is the first data line. This is the second data line.</span><br><span class="line">This is the last line.</span><br></pre></td></tr></table></figure><p>å‘½ä»¤è§£é‡Šï¼šå°å†™çš„nå‘½ä»¤è®©sedç¼–è¾‘å™¨ç§»åŠ¨åˆ°ä¸‹ä¸€è¡Œï¼Œå¤§å†™çš„Nå‘½ä»¤åˆ™æ˜¯è®©ç¼–è¾‘å™¨å°†ä¸‹ä¸€è¡Œè¿½åŠ åˆ°æ¨¡å¼ç©ºé—´ã€‚å› æ­¤å½“åŒ¹é…åˆ°<code>/first/</code>æ‰€åœ¨çš„è¡Œæ—¶ï¼ŒNå‘½ä»¤è®©sedç¼–è¾‘å™¨ç»§ç»­è¯»å…¥ä¸‹ä¸€è¡Œï¼Œæ­¤æ—¶æ¨¡å¼ç©ºé—´çš„æ–‡æœ¬å†…å®¹æ˜¯ <code>This is the first data line.\nThis is the second data line.</code>ï¼Œæœ€åé€šè¿‡<code>s/\n/ /</code>å‘½ä»¤å°†æ¢è¡Œç¬¦æ›¿æ¢æˆç©ºæ ¼ã€‚è¯¥å‘½ä»¤å‘ˆç°å‡ºæ¥çš„æ•ˆæœå°±æ˜¯åˆå¹¶ä¸¤è¡Œã€‚</p><p>Nå‘½ä»¤çš„ä¸€ç§ä½¿ç”¨åœºæ™¯æ˜¯æŸ¥æ‰¾å¹¶ç¼–è¾‘å¯èƒ½åˆ†æ•£åœ¨å¤šè¡Œçš„çŸ­è¯­ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># data7.txt</span></span><br><span class="line">$ <span class="built_in">cat</span> data7.txt</span><br><span class="line">On Tuesday, the Linux System</span><br><span class="line">Administrator<span class="string">&#x27;s group meeting will be held.</span></span><br><span class="line"><span class="string">All System Administrator should attend.</span></span><br><span class="line"><span class="string">Thank you for your attendance.</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ SED <span class="string">&#x27;N ; s/System.Administrator/Desktop user/&#x27;</span> data7.txt</span><br><span class="line">On Tuesday, the Linux Desktop user<span class="string">&#x27;s group meeting will be held.</span></span><br><span class="line"><span class="string">All Desktop users should attend.</span></span><br><span class="line"><span class="string">Thank you for your attendance.</span></span><br></pre></td></tr></table></figure><p>Nå‘½ä»¤ä¼šæŠŠä¸Šä¸‹ä¸¤è¡Œè¯»å…¥æ¨¡å¼ç©ºé—´ï¼Œå¹¶é€šè¿‡æ¢è¡Œç¬¦<code>\n</code>åˆå¹¶æˆå•è¡Œæ–‡æœ¬ï¼Œæ‰€ä»¥æ¨¡å¼<code>/System.Administrator/</code>å°±å¯ä»¥åŒ¹é…åˆ° <code>System\nAdministrator</code>ï¼Œæœ€åé€šè¿‡så‘½ä»¤æ›¿æ¢æˆ <code>Desktop user</code>ã€‚</p><p>ç”±è¾“å‡ºç»“æœå¯ä»¥çœ‹åˆ°ï¼Œä¸Šé¢è¿™æ¡å‘½ä»¤è™½ç„¶åŒ¹é…åˆ°äº†è·¨è¡Œçš„çŸ­è¯­ï¼Œä½†æ˜¯åœ¨æ›¿æ¢ä¹‹åä¼šåˆå¹¶ä¸¤è¡Œï¼Œæœ‰æ—¶è¿™å¯èƒ½ä¸ç¬¦åˆé¢„æœŸã€‚è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œéœ€è¦å¤šæ¡æ›¿æ¢å‘½ä»¤ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ sed <span class="string">&#x27;N</span></span><br><span class="line"><span class="string">&gt; s/System\nAdministrator/Desktop\nUser/</span></span><br><span class="line"><span class="string">&gt; s/System Administrator/Desktop User/</span></span><br><span class="line"><span class="string">&gt; &#x27;</span> data7.txt</span><br><span class="line">On Tuesday, the Linux Desktop</span><br><span class="line">User<span class="string">&#x27;s group meeting will be held.</span></span><br><span class="line"><span class="string">All Desktop Users should attend.</span></span><br><span class="line"><span class="string">Thank you for your attendance.</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¿™æ¡å‘½ä»¤æ—¢å®Œæˆäº†è·¨è¡ŒçŸ­è¯­çš„æ›¿æ¢ï¼Œåˆä¸ä¼šåˆå¹¶ä¸¤è¡Œï¼Œä½†æ˜¯è¿™æ¡å‘½ä»¤ä»ç„¶æœ‰ç‚¹é—®é¢˜ï¼Œå‡è®¾æ•°æ®æ–‡ä»¶å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># data8.txt</span></span><br><span class="line">$ <span class="built_in">cat</span> data8.txt</span><br><span class="line">On Tuesday, the Linux System</span><br><span class="line">Administrator<span class="string">&#x27;s group meeting will be held.</span></span><br><span class="line"><span class="string">All System Administrator should attend.</span></span><br></pre></td></tr></table></figure><p>æ­¤æ—¶æ‰§è¡Œä¸Šé¢è¿™æ¡å‘½ä»¤ä¼šå‘ç°ï¼Œæœ€åä¸€è¡Œçš„çš„<code>System Administrators</code>æ²¡æœ‰æ›¿æ¢æˆåŠŸã€‚è¿™æ˜¯å› ä¸ºè™½ç„¶åŒ¹é…åˆ°è¯¥è¡Œï¼Œä½†æ˜¯æ²¡æœ‰ä¸‹ä¸€è¡Œäº†ï¼ŒNå‘½ä»¤ä¼šç»ˆæ­¢åç»­å‘½ä»¤çš„æ‰§è¡Œã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ sed <span class="string">&#x27;N</span></span><br><span class="line"><span class="string">&gt; s/System\nAdministrator/Desktop\nUser/</span></span><br><span class="line"><span class="string">&gt; s/System Administrator/Desktop User/</span></span><br><span class="line"><span class="string">&gt; &#x27;</span> data8.txt</span><br><span class="line">On Tuesday, the Linux Desktop</span><br><span class="line">User<span class="string">&#x27;s group meeting will be held.</span></span><br><span class="line"><span class="string">All System Administrators should attend.</span></span><br></pre></td></tr></table></figure><p>è¦è§£å†³è¿™ä¸ªå‘½ä»¤ï¼Œéœ€è¦ç”¨åˆ°æ’é™¤å‘½ä»¤<code>!</code>ï¼Œå½“é‡åˆ°æ–‡ä»¶æœ€åä¸€è¡Œï¼Œç¦æ­¢Nå‘½ä»¤æ‰§è¡Œå³å¯ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ sed <span class="string">&#x27;$!N;</span></span><br><span class="line"><span class="string">&gt; s/System\nAdministrator/Desktop\nUser/</span></span><br><span class="line"><span class="string">&gt; s/System Administrator/Desktop User/</span></span><br><span class="line"><span class="string">&gt; &#x27;</span> data8.txt</span><br><span class="line">On Tuesday, the Linux Desktop</span><br><span class="line">User<span class="string">&#x27;s group meeting will be held.</span></span><br><span class="line"><span class="string">All Desktop Users should attend.</span></span><br></pre></td></tr></table></figure><h3 id="å¤šè¡Œåˆ é™¤ï¼šD"><a href="#å¤šè¡Œåˆ é™¤ï¼šD" class="headerlink" title="å¤šè¡Œåˆ é™¤ï¼šD"></a>å¤šè¡Œåˆ é™¤ï¼šD</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sed <span class="string">&#x27;N; /System\nAdministrator/d&#x27;</span> data8.txt</span><br><span class="line">All System Administrators should attend.</span><br></pre></td></tr></table></figure><p>å½“Nå‘½ä»¤å’Œdå‘½ä»¤ä¸€èµ·ä½¿ç”¨æ—¶ï¼Œä¼šæŠŠå½“å‰æ¨¡å¼ç©ºé—´ä¸­çš„å†…å®¹å…¨éƒ¨åˆ é™¤ï¼Œè¿™æœªå¿…ç¬¦åˆé¢„æœŸã€‚sedæä¾›äº†åªå¤§å†™çš„Då‘½ä»¤ï¼Œåªåˆ é™¤æ¨¡å¼ç©ºé—´ä¸­çš„ç¬¬ä¸€è¡Œã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sed <span class="string">&#x27;N; /System\nAdministrator/D&#x27;</span> data8.txt</span><br><span class="line">Administrator<span class="string">&#x27;s group meeting will be held.</span></span><br><span class="line"><span class="string">All System Administrators should attend.</span></span><br></pre></td></tr></table></figure><h3 id="æ’é™¤å‘½ä»¤ï¼š"><a href="#æ’é™¤å‘½ä»¤ï¼š" class="headerlink" title="æ’é™¤å‘½ä»¤ï¼š!"></a>æ’é™¤å‘½ä»¤ï¼š!</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¬¬ä¸€è¡Œä¸æ‰“å°</span></span><br><span class="line">$ sed -n <span class="string">&#x27;/header/!p&#x27;</span> data6.txt</span><br><span class="line">This is the first data line.</span><br><span class="line">This is the second data line.</span><br><span class="line">This is the last line.</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¬¬2ã€3è¡Œä¸æ‰“å°</span></span><br><span class="line">$ sed -n <span class="string">&#x27;2,3!p&#x27;</span> data6.txt</span><br><span class="line">This is the header line.</span><br><span class="line">This is the last line.</span><br></pre></td></tr></table></figure><h3 id="åˆ†æ”¯å‘½ä»¤ï¼šb"><a href="#åˆ†æ”¯å‘½ä»¤ï¼šb" class="headerlink" title="åˆ†æ”¯å‘½ä»¤ï¼šb"></a>åˆ†æ”¯å‘½ä»¤ï¼šb</h3><p>åˆ†æ”¯å‘½ä»¤æ ¼å¼ï¼š<code>[address]b [label]</code></p><p><code>address</code> å‚æ•°å†³å®šäº†å“ªäº›è¡Œçš„æ•°æ®ä¼šè§¦å‘åˆ†æ”¯å‘½ä»¤ã€‚<code>label</code> å‚æ•°å®šä¹‰äº†è¦è·³è½¬åˆ°çš„ä½ç½®ã€‚å¦‚æœæ²¡æœ‰åŠ  <code>label</code> å‚æ•°ï¼Œè·³è½¬å‘½ä»¤ä¼šè·³è½¬åˆ°è„šæœ¬çš„ç»“å°¾ã€‚</p><ul><li>ä¸å¸¦ <code>label</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è·³è¿‡ç¬¬2ï½3è¡Œï¼Œä¸æ‰§è¡Œåç»­å‘½ä»¤</span></span><br><span class="line">$ sed <span class="string">&#x27;2,3b</span></span><br><span class="line"><span class="string">&gt; s/This is/Is this/</span></span><br><span class="line"><span class="string">&gt; s/line./test?/</span></span><br><span class="line"><span class="string">&gt; &#x27;</span> data6.txt</span><br><span class="line">Is this the header <span class="built_in">test</span>?</span><br><span class="line">This is the first data line.</span><br><span class="line">This is the second data line.</span><br><span class="line">Is this the last <span class="built_in">test</span>?</span><br></pre></td></tr></table></figure><ul><li>å¸¦ <code>label</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è·³è½¬å‘½ä»¤æŒ‡å®šå¦‚æœæ–‡æœ¬è¡Œä¸­å‡ºç°äº†firstï¼Œç¨‹åºåº”è¯¥è·³åˆ°æ ‡ç­¾ä¸ºjump1çš„è„šæœ¬è¡Œã€‚</span></span><br><span class="line"><span class="comment"># å¦‚æœåˆ†æ”¯å‘½ä»¤çš„æ¨¡å¼æ²¡æœ‰åŒ¹é…ï¼Œsedç¼–è¾‘å™¨ä¼šç»§ç»­æ‰§è¡Œè„šæœ¬ä¸­çš„å‘½ä»¤ï¼ŒåŒ…æ‹¬åˆ†æ”¯æ ‡ç­¾åçš„å‘½ä»¤</span></span><br><span class="line">$ sed <span class="string">&#x27;/first/b jump1</span></span><br><span class="line"><span class="string">&gt; s/This is the/No jump on/</span></span><br><span class="line"><span class="string">&gt; :jump1</span></span><br><span class="line"><span class="string">&gt; s/This is the/Jump here on/</span></span><br><span class="line"><span class="string">&gt; &#x27;</span> data6.txt</span><br><span class="line">No jump on header line.</span><br><span class="line">Jump here on first data line.</span><br><span class="line">No jump on second data line.</span><br><span class="line">No jump on last line.</span><br></pre></td></tr></table></figure><p>å¾ªç¯åˆ é™¤æ–‡æœ¬ä¸­çš„é€—å·ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;This, is, a, test, to, remove, commas.&quot;</span> | sed -n <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">:start</span></span><br><span class="line"><span class="string">s/,//1p</span></span><br><span class="line"><span class="string">/,/b start</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br><span class="line">This is, a, <span class="built_in">test</span>, to, remove, commas.</span><br><span class="line">This is a, <span class="built_in">test</span>, to, remove, commas.</span><br><span class="line">This is a <span class="built_in">test</span>, to, remove, commas.</span><br><span class="line">This is a <span class="built_in">test</span> to, remove, commas.</span><br><span class="line">This is a <span class="built_in">test</span> to remove, commas.</span><br><span class="line">This is a <span class="built_in">test</span> to remove commas.</span><br></pre></td></tr></table></figure><p>ä¸ºäº†é˜²æ­¢æ— é™å¾ªç¯ï¼Œ<code>b start</code> å‰éœ€åŠ è¡Œæ¨¡å¼ <code>/,/</code>ï¼Œåªæœ‰æ–‡æœ¬ä¸­è¿˜å­˜åœ¨é€—å·æ—¶æ‰è·³è½¬ã€‚</p><h3 id="æµ‹è¯•å‘½ä»¤ï¼št"><a href="#æµ‹è¯•å‘½ä»¤ï¼št" class="headerlink" title="æµ‹è¯•å‘½ä»¤ï¼št"></a>æµ‹è¯•å‘½ä»¤ï¼št</h3><p>æµ‹è¯•å‘½ä»¤æ ¼å¼ï¼š<code>[address]t [label]</code></p><p>å¦‚æœæ›¿æ¢å‘½ä»¤æˆåŠŸåŒ¹é…å¹¶æ›¿æ¢äº†ä¸€ä¸ªæ¨¡å¼ï¼Œæµ‹è¯•å‘½ä»¤å°±ä¼šè·³è½¬åˆ°æŒ‡å®šçš„æ ‡ç­¾ã€‚å¦‚æœæ›¿æ¢å‘½ä»¤æœªèƒ½åŒ¹é…æŒ‡å®šçš„æ¨¡å¼ï¼Œæµ‹è¯•å‘½ä»¤å°±ä¸ä¼šè·³è½¬ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;This, is, a, test, to, remove, commas. &quot;</span> | sed -n <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">:start</span></span><br><span class="line"><span class="string">s/,//1p</span></span><br><span class="line"><span class="string">t start</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br><span class="line">This is, a, <span class="built_in">test</span>, to, remove, commas.</span><br><span class="line">This is a, <span class="built_in">test</span>, to, remove, commas.</span><br><span class="line">This is a <span class="built_in">test</span>, to, remove, commas.</span><br><span class="line">This is a <span class="built_in">test</span> to, remove, commas.</span><br><span class="line">This is a <span class="built_in">test</span> to remove, commas.</span><br><span class="line">This is a <span class="built_in">test</span> to remove commas.</span><br></pre></td></tr></table></figure><p><code>t start</code> åªæœ‰åœ¨å‰ä¸€ä¸ªæ›¿æ¢å‘½ä»¤æ‰§è¡ŒæˆåŠŸæ‰æ‰§è¡Œï¼ŒåŒæ ·é¿å…äº†æ— é™å¾ªç¯ã€‚</p><h1 id="awk"><a href="#awk" class="headerlink" title="awk"></a>awk</h1><p>gawkç¨‹åºæ˜¯Unixä¸­çš„åŸå§‹awkç¨‹åºçš„GNUç‰ˆæœ¬ï¼Œå…¶æŠ¥å‘Šç”Ÿæˆèƒ½åŠ›é€šå¸¸ç”¨æ¥ä»å¤§æ–‡æœ¬æ–‡ä»¶æ–‡ä»¶ä¸­æå–å…ƒç´ ï¼Œå¹¶å°†å®ƒä»¬æ ¼å¼åŒ–æˆå¯è¯»çš„æ ¼å¼ï¼Œå¦‚æ ¼å¼åŒ–æ—¥å¿—æ–‡ä»¶ã€‚</p><p>gawkçš„å‘½ä»¤æ ¼å¼ä¸ºï¼š<code>gawk options program file</code>ã€‚</p><p>å¸¸ç”¨çš„é€‰é¡¹å¦‚ä¸‹ï¼š</p><table><thead><tr><th>é€‰é¡¹</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>-F fs</code></td><td>æŒ‡å®šè¡Œä¸­åˆ’åˆ†æ•°æ®å­—æ®µçš„å­—æ®µåˆ†éš”ç¬¦</td></tr><tr><td><code>-f file</code></td><td>ä»æŒ‡å®šçš„æ–‡ä»¶ä¸­è¯»å–ç¨‹åº</td></tr><tr><td><code>-v var=value</code></td><td>å®šä¹‰gawkç¨‹åºä¸­çš„ä¸€ä¸ªå˜é‡åŠå…¶é»˜è®¤å€¼</td></tr><tr><td><code>-mf N</code></td><td>æŒ‡å®šè¦å¤„ç†çš„æ•°æ®æ–‡ä»¶ä¸­çš„æœ€å¤§å­—æ®µæ•°</td></tr><tr><td><code>-mr N</code></td><td>æŒ‡å®šæ•°æ®æ–‡ä»¶ä¸­çš„æœ€å¤§æ•°æ®è¡Œæ•°</td></tr><tr><td><code>-W keyword</code></td><td>æŒ‡å®šgawkçš„å…¼å®¹æ¨¡å¼æˆ–è­¦å‘Šç­‰çº§</td></tr></tbody></table><h2 id="å˜é‡"><a href="#å˜é‡" class="headerlink" title="å˜é‡"></a>å˜é‡</h2><p>æ‰€æœ‰ç¼–ç¨‹è¯­è¨€éƒ½å¯ä»¥ä½¿ç”¨å˜é‡æ¥å­˜å–å€¼ï¼Œgawkç¼–ç¨‹è¯­è¨€æ”¯æŒä¸¤ç§ç±»å‹å˜é‡ï¼š</p><ul><li>å†…å»ºå˜é‡</li><li>è‡ªå®šä¹‰å˜é‡</li></ul><h3 id="å†…å»ºå˜é‡"><a href="#å†…å»ºå˜é‡" class="headerlink" title="å†…å»ºå˜é‡"></a>å†…å»ºå˜é‡</h3><h4 id="æ•°æ®å­—æ®µå˜é‡"><a href="#æ•°æ®å­—æ®µå˜é‡" class="headerlink" title="æ•°æ®å­—æ®µå˜é‡"></a>æ•°æ®å­—æ®µå˜é‡</h4><p>åœ¨å¤„ç†æ–‡æœ¬æ—¶ï¼Œgawkä¼šç»™ä¸€è¡Œä¸­çš„æ¯ä¸ªæ•°æ®å…ƒç´ åˆ†é…ä¸€ä¸ªå˜é‡ï¼š</p><ul><li><code>$0</code>ï¼šè¡¨ç¤ºæ•´ä¸ªæ–‡æœ¬è¡Œ</li><li><code>$1</code>ï¼šè¡¨ç¤ºç¬¬1ä¸ªæ•°æ®å­—æ®µ</li><li><code>$n</code>ï¼šè¡¨ç¤ºç¬¬nä¸ªæ•°æ®å­—æ®µ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> data1.txt</span><br><span class="line">One line of <span class="built_in">test</span> text.</span><br><span class="line">Two lines of <span class="built_in">test</span> text.</span><br><span class="line">Three lines of <span class="built_in">test</span> text.</span><br><span class="line"></span><br><span class="line">$ gawk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> data1.txt</span><br><span class="line">One</span><br><span class="line">Two</span><br><span class="line">Three</span><br></pre></td></tr></table></figure><h4 id="åˆ†éš”ç¬¦å˜é‡"><a href="#åˆ†éš”ç¬¦å˜é‡" class="headerlink" title="åˆ†éš”ç¬¦å˜é‡"></a>åˆ†éš”ç¬¦å˜é‡</h4><p>gawké»˜è®¤é‡‡ç”¨ç©ºç™½å­—ç¬¦ä½œä¸ºè¾“å…¥å’Œè¾“å‡ºå­—æ®µåˆ†éš”ç¬¦ã€‚</p><table><thead><tr><th>å˜é‡</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>FIELDWIDTHS</code></td><td>ç”±ç©ºæ ¼åˆ†éš”çš„ä¸€åˆ—æ•°å­—ï¼Œå®šä¹‰äº†æ¯ä¸ªæ•°æ®å­—æ®µç¡®åˆ‡å®½åº¦</td></tr><tr><td><code>FS</code></td><td>è¾“å…¥å­—æ®µåˆ†éš”ç¬¦</td></tr><tr><td><code>RS</code></td><td>è¾“å…¥è®°å½•åˆ†éš”ç¬¦</td></tr><tr><td><code>OFS </code></td><td>è¾“å‡ºå­—æ®µåˆ†éš”ç¬¦</td></tr><tr><td><code>ORS</code></td><td>è¾“å‡ºè®°å½•åˆ†éš”ç¬¦</td></tr></tbody></table><ul><li>é€šè¿‡ <code>FS</code> æŒ‡å®šè¾“å…¥å­—æ®µåˆ†éš”ç¬¦</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># data2.txt</span></span><br><span class="line">$ <span class="built_in">cat</span> data2.txt</span><br><span class="line">data11,data12,data13,data14,data15</span><br><span class="line">data21,data22,data23,data24,data25</span><br><span class="line">data31,data32,data33,data34,data35</span><br><span class="line"></span><br><span class="line">$ gawk <span class="string">&#x27;BEGIN&#123;FS=&quot;,&quot;&#125; &#123;print $1, $2, $3&#125;&#x27;</span> data2.txt</span><br><span class="line">data11 data12 data13</span><br><span class="line">data21 data22 data23</span><br><span class="line">data31 data32 data33</span><br></pre></td></tr></table></figure><ul><li>é€šè¿‡ <code>OFS</code> æŒ‡å®šè¾“å‡ºå­—æ®µåˆ†éš”ç¬¦</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ gawk <span class="string">&#x27;BEGIN&#123;FS=&quot;,&quot;; OFS=&quot;-&quot;&#125; &#123;print $1, $2, $3&#125;&#x27;</span> data2.txt</span><br><span class="line">data11-data12-data13</span><br><span class="line">data21-data22-data23</span><br><span class="line">data31-data32-data33</span><br></pre></td></tr></table></figure><ul><li>é€šè¿‡ <code>FIELDWIDTHS</code> å˜é‡æ¥åŒ¹é…æ•°æ®åœ¨è®°å½•ä¸­çš„ä½ç½®</li></ul><p>åœ¨ä¸€äº›åº”ç”¨ç¨‹åºä¸­ï¼Œæ•°æ®å¹¶æ²¡æœ‰ä½¿ç”¨å­—æ®µåˆ†éš”ç¬¦ï¼Œè€Œæ˜¯è¢«æ”¾ç½®åœ¨äº†è®°å½•ä¸­çš„ç‰¹å®šåˆ—ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå¿…é¡»è®¾å®š <code>FIELDWIDTHS</code> å˜é‡æ¥åŒ¹é…æ•°æ®åœ¨è®°å½•ä¸­çš„ä½ç½®ã€‚ä¸€æ—¦è®¾ç½®äº† <code>FIELDWIDTH</code> å˜é‡ï¼Œgawkå°±ä¼šå¿½ç•¥ <code>FS</code> å˜é‡ï¼Œå¹¶æ ¹æ®æä¾›çš„å­—æ®µå®½åº¦æ¥è®¡ç®—å­—æ®µã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># data3.txt</span></span><br><span class="line">$ <span class="built_in">cat</span> data3.txt</span><br><span class="line">1005.3247596.37</span><br><span class="line">115-2.349194.00</span><br><span class="line">05810.1298100.1</span><br><span class="line"></span><br><span class="line">$ gawk <span class="string">&#x27;BEGIN&#123;FIELDWIDTHS=&quot;3 5 2 5&quot;&#125; &#123;print $1, $2, $3, $4&#125;&#x27;</span> data3.txt</span><br><span class="line">100 5.324 75 96.37</span><br><span class="line">115 -2.34 91 94.00</span><br><span class="line">058 10.12 98 100.1</span><br></pre></td></tr></table></figure><ul><li>é€šè¿‡ <code>RS</code> æŒ‡å®šè¾“å…¥è®°å½•åˆ†éš”ç¬¦</li></ul><p>gawké»˜è®¤æŠŠæ¢è¡Œç¬¦ä½œä¸ºè®°å½•åˆ†éš”ç¬¦ã€‚å½“é‡åˆ°è®°å½•è·¨è¡Œå­˜å‚¨ï¼Œä¸åŒè®°å½•ä»¥ç©ºç™½è¡Œåˆ†éš”çš„æ–‡æœ¬ï¼Œå°±éœ€è¦é€šè¿‡ <code>RS</code> æŒ‡å®šè®°å½•åˆ†éš”ç¬¦ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> data4.txt</span><br><span class="line">Riley Mullen</span><br><span class="line">123 Main Street</span><br><span class="line">Chicago, IL 60601</span><br><span class="line">(312)555-1234</span><br><span class="line"></span><br><span class="line">Frank Williams</span><br><span class="line">456 Oak Street</span><br><span class="line">Indianapolis, IN 46201</span><br><span class="line">(317)555-9876</span><br><span class="line"></span><br><span class="line">Haley Snell</span><br><span class="line">4231 Elm Street</span><br><span class="line">Detroit, MI 48201</span><br><span class="line">(313)555-4938</span><br><span class="line"></span><br><span class="line"><span class="comment"># FSï¼šæŒ‡å®šå­—æ®µåˆ†éš”ç¬¦ä¸º\n</span></span><br><span class="line"><span class="comment"># RSï¼šæŒ‡å®šè®°å½•åˆ†éš”ç¬¦ä¸ºç©ºå­—ç¬¦</span></span><br><span class="line">$ gawk <span class="string">&#x27;BEGIN&#123;FS=&quot;\n&quot;; RS=&quot;&quot;&#125; &#123;print $1, $4&#125;&#x27;</span> data4.txt</span><br><span class="line">Riley Mullen (312)555-1234</span><br><span class="line">Frank Williams (317)555-9876</span><br><span class="line">Haley Snell (313)555-4938</span><br></pre></td></tr></table></figure><h4 id="å…¶ä»–å†…å»ºå˜é‡"><a href="#å…¶ä»–å†…å»ºå˜é‡" class="headerlink" title="å…¶ä»–å†…å»ºå˜é‡"></a>å…¶ä»–å†…å»ºå˜é‡</h4><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>ARGC</code></td><td>å½“å‰å‘½ä»¤è¡Œå‚æ•°ä¸ªæ•°</td></tr><tr><td><code>ARGIND</code></td><td>å½“å‰æ–‡ä»¶åœ¨<code>ARGV</code>ä¸­çš„ä½ç½®</td></tr><tr><td><code>ARGV</code></td><td>åŒ…å«å‘½ä»¤è¡Œå‚æ•°çš„æ•°ç»„</td></tr><tr><td><code>CONVFMT</code></td><td>æ•°å­—çš„è½¬æ¢æ ¼å¼ï¼ˆå‚è§<code>printf</code>è¯­å¥ï¼‰ï¼Œé»˜è®¤å€¼ä¸º<code>%.6 g</code></td></tr><tr><td><code>ENVIRON</code></td><td>å½“å‰shellç¯å¢ƒå˜é‡åŠå…¶å€¼ç»„æˆçš„å…³è”æ•°ç»„</td></tr><tr><td><code>ERRNO</code></td><td>å½“è¯»å–æˆ–å…³é—­è¾“å…¥æ–‡ä»¶å‘ç”Ÿé”™è¯¯æ—¶çš„ç³»ç»Ÿé”™è¯¯å·</td></tr><tr><td><code>FILENAME</code></td><td>ç”¨ä½œgawkè¾“å…¥æ•°æ®çš„æ•°æ®æ–‡ä»¶çš„æ–‡ä»¶å</td></tr><tr><td><code>IGNORECASE</code></td><td>è®¾æˆéé›¶å€¼æ—¶ï¼Œå¿½ç•¥gawkå‘½ä»¤ä¸­å‡ºç°çš„å­—ç¬¦ä¸²çš„å­—ç¬¦å¤§å°å†™</td></tr><tr><td><code>NF</code></td><td>æ•°æ®æ–‡ä»¶ä¸­çš„å­—æ®µæ€»æ•°</td></tr><tr><td><code>NR</code></td><td>å·²å¤„ç†çš„è¾“å…¥è®°å½•æ•°</td></tr><tr><td><code>FNR</code></td><td>å½“å‰æ•°æ®æ–‡ä»¶ä¸­çš„æ•°æ®è¡Œæ•°</td></tr><tr><td><code>OFMT</code></td><td>æ•°å­—çš„è¾“å‡ºæ ¼å¼ï¼Œé»˜è®¤å€¼ä¸º<code>%.6 g</code></td></tr><tr><td><code>RLENGTH</code></td><td>ç”±<code>match</code>å‡½æ•°æ‰€åŒ¹é…çš„å­å­—ç¬¦ä¸²çš„é•¿åº¦</td></tr><tr><td><code>RSTART</code></td><td>ç”±<code>match</code>å‡½æ•°æ‰€åŒ¹é…çš„å­å­—ç¬¦ä¸²çš„èµ·å§‹ä½ç½®</td></tr></tbody></table><ul><li><code>ARGC</code> å’Œ <code>ARGV</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># gawkä¸æŠŠè„šæœ¬ç¨‹åºå½“ä½œå‘½ä»¤è¡Œå‚æ•°çš„ä¸€éƒ¨åˆ†</span></span><br><span class="line">$ gawk <span class="string">&#x27;BEGIN&#123;print ARGC, ARGV[0], ARGV[1]&#125;&#x27;</span> data1.txt</span><br><span class="line">2 gawk data1.txt</span><br></pre></td></tr></table></figure><ul><li><code>ENVIRON</code></li></ul><p>å¯ä»¥é€šè¿‡ <code>ENVIRON</code> æ¥è·å– shell ä¸­ä»»ä½•ç¯å¢ƒå˜é‡çš„å€¼ï¼Œä»¥ä¾› gawk ç¨‹åºä½¿ç”¨ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ gawk <span class="string">&#x27;</span></span><br><span class="line"><span class="string">&gt; BEGIN&#123;</span></span><br><span class="line"><span class="string">&gt; print ENVIRON[&quot;HOME&quot;]</span></span><br><span class="line"><span class="string">&gt; print ENVIRON[&quot;PATH&quot;]</span></span><br><span class="line"><span class="string">&gt; &#125;&#x27;</span></span><br><span class="line">/home/rich</span><br><span class="line">/usr/local/bin:/bin:/usr/bin:</span><br></pre></td></tr></table></figure><ul><li><code>NF</code></li></ul><p>å½“ä¸çŸ¥è®°å½•æœ‰å¤šå°‘ä¸ªå­—æ®µï¼Œ<code>NF</code> å˜é‡å¯ä»¥ç”¨æ¥æŒ‡å®šæœ€åä¸€ä¸ªæ•°æ®å­—æ®µã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ gawk <span class="string">&#x27;BEGIN&#123;FS=&quot;:&quot;; OFS=&quot;:&quot;&#125; &#123;print $1, $NF&#125;&#x27;</span> /etc/passwd</span><br><span class="line">nobody:/usr/bin/false</span><br><span class="line">root:/bin/sh</span><br><span class="line">daemon:/usr/bin/false</span><br></pre></td></tr></table></figure><ul><li><code>FNR</code> å’Œ <code>NR</code></li></ul><p><code>FNR</code> å˜é‡çš„å€¼åœ¨ gawk å¤„ç†ç¬¬äºŒä¸ªæ•°æ®æ–‡ä»¶æ—¶è¢«é‡ç½®äº†ï¼Œè€Œ <code>NR</code> å˜é‡åˆ™åœ¨å¤„ç†ç¬¬äºŒä¸ªæ•°æ®æ–‡ä»¶æ—¶ç»§ç»­è®¡æ•°ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ gawk <span class="string">&#x27;</span></span><br><span class="line"><span class="string">&gt; BEGIN &#123;FS=&quot;,&quot;&#125;</span></span><br><span class="line"><span class="string">&gt; &#123;print $1, &quot;FNR=&quot;FNR, &quot;NR=&quot;NR&#125;</span></span><br><span class="line"><span class="string">&gt; END &#123;print &quot;There were&quot;,NR,&quot;records processed&quot;&#125;&#x27;</span> data2.txt data2.txt</span><br><span class="line">data11 FNR=1 NR=1</span><br><span class="line">data21 FNR=2 NR=2</span><br><span class="line">data31 FNR=3 NR=3</span><br><span class="line">data11 FNR=1 NR=4</span><br><span class="line">data21 FNR=2 NR=5</span><br><span class="line">data31 FNR=3 NR=6</span><br><span class="line">There were 6 records processed</span><br></pre></td></tr></table></figure><h3 id="è‡ªå®šä¹‰å˜é‡"><a href="#è‡ªå®šä¹‰å˜é‡" class="headerlink" title="è‡ªå®šä¹‰å˜é‡"></a>è‡ªå®šä¹‰å˜é‡</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ gawk <span class="string">&#x27;BEGIN &#123;</span></span><br><span class="line"><span class="string">&gt; text=&quot;hello world&quot;</span></span><br><span class="line"><span class="string">&gt; print text</span></span><br><span class="line"><span class="string">&gt; &#125;&#x27;</span></span><br><span class="line">hello world</span><br></pre></td></tr></table></figure><ul><li>åœ¨å‘½ä»¤è¡Œä¸Šç»™è„šæœ¬ä¸­çš„å˜é‡èµ‹å€¼</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># script4.gawk</span></span><br><span class="line">$ <span class="built_in">cat</span> script4.gawk</span><br><span class="line">BEGIN &#123;FS=<span class="string">&quot;,&quot;</span>&#125;</span><br><span class="line">&#123;<span class="built_in">print</span> <span class="variable">$n</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨å‘½ä»¤è¡Œè®¾ç½®n</span></span><br><span class="line">$ gawk -f script4.gawk n=2 data2.txt</span><br><span class="line">data12</span><br><span class="line">data22</span><br><span class="line">data32</span><br></pre></td></tr></table></figure><p>ä¸€èˆ¬æƒ…å†µä¸‹ <code>BEGIN</code> å‘½ä»¤è·å–ä¸åˆ°å‘½ä»¤è¡Œè®¾ç½®çš„å˜é‡çš„å€¼ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> script5.gawk</span><br><span class="line">BEGIN&#123;<span class="built_in">print</span> <span class="string">&quot;The&quot;</span>, n<span class="string">&quot;th field is&quot;</span>; FS=<span class="string">&quot;,&quot;</span>&#125;</span><br><span class="line">&#123;<span class="built_in">print</span> <span class="variable">$n</span>&#125;</span><br><span class="line"></span><br><span class="line">$ gawk -f script5.gawk n=2 data2.txt</span><br><span class="line">The th field is</span><br><span class="line">data12</span><br><span class="line">data22</span><br><span class="line">data32</span><br></pre></td></tr></table></figure><p>è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œéœ€è¦åŠ ä¸Š <code>-v</code> å‘½ä»¤è¡Œå‚æ•°ï¼Œä¸” <code>-v n=2</code> å¿…é¡»è¦æ”¾åœ¨ <code>-f</code> å‚æ•°å‰ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ gawk -v n=2 -f script5.gawk data2.txt</span><br><span class="line">The 2th field is</span><br><span class="line">data12</span><br><span class="line">data22</span><br><span class="line">data32</span><br></pre></td></tr></table></figure><h2 id="æ•°ç»„"><a href="#æ•°ç»„" class="headerlink" title="æ•°ç»„"></a>æ•°ç»„</h2><p>gawkä½¿ç”¨å…³è”æ•°ç»„æä¾›æ•°ç»„åŠŸèƒ½ã€‚å…³è”æ•°ç»„è·Ÿæ™®é€šæ•°ç»„ä¸åŒä¹‹å¤„åœ¨äºå®ƒçš„ç´¢å¼•å€¼å¯ä»¥æ˜¯ä»»æ„æ–‡æœ¬å­—ç¬¦ä¸²ï¼Œç±»ä¼¼äºå­—å…¸ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$ gawk <span class="string">&#x27;BEGIN&#123;</span></span><br><span class="line"><span class="string">&gt; capital[&quot;China&quot;] = &quot;Beijing&quot;</span></span><br><span class="line"><span class="string">&gt; print capital[&quot;China&quot;]</span></span><br><span class="line"><span class="string">&gt; &#125;&#x27;</span></span><br><span class="line">Beijing</span><br><span class="line"></span><br><span class="line">$ gawk <span class="string">&#x27;BEGIN&#123;</span></span><br><span class="line"><span class="string">&gt; var[1] = 34</span></span><br><span class="line"><span class="string">&gt; var[2] = 3</span></span><br><span class="line"><span class="string">&gt; total = var[1] + var[2]</span></span><br><span class="line"><span class="string">&gt; print total</span></span><br><span class="line"><span class="string">&gt; &#125;&#x27;</span></span><br><span class="line">37</span><br><span class="line"></span><br><span class="line"><span class="comment"># éå†&amp;åˆ é™¤æ•°ç»„</span></span><br><span class="line">$ gawk <span class="string">&#x27;BEGIN&#123;</span></span><br><span class="line"><span class="string">&gt; var[&quot;a&quot;] = 1</span></span><br><span class="line"><span class="string">&gt; var[&quot;g&quot;] = 2</span></span><br><span class="line"><span class="string">&gt; for (test in var)</span></span><br><span class="line"><span class="string">&gt; &#123;</span></span><br><span class="line"><span class="string">&gt; print &quot;Index:&quot;,test,&quot;- Value:&quot;,var[test]</span></span><br><span class="line"><span class="string">&gt; &#125;</span></span><br><span class="line"><span class="string">&gt; delete var[&quot;g&quot;]</span></span><br><span class="line"><span class="string">&gt; print &quot;-----&quot;</span></span><br><span class="line"><span class="string">&gt; for (test in var)</span></span><br><span class="line"><span class="string">&gt; &#123;</span></span><br><span class="line"><span class="string">&gt; print &quot;Index:&quot;,test,&quot;- Value:&quot;,var[test]</span></span><br><span class="line"><span class="string">&gt; &#125;</span></span><br><span class="line"><span class="string">&gt; &#125;&#x27;</span></span><br><span class="line">Index: a - Value: 1</span><br><span class="line">Index: g - Value: 2</span><br><span class="line">-----</span><br><span class="line">Index: a - Value: 1</span><br></pre></td></tr></table></figure><h2 id="æ¨¡å¼"><a href="#æ¨¡å¼" class="headerlink" title="æ¨¡å¼"></a>æ¨¡å¼</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> data1</span><br><span class="line">data11,data12,data13,data14,data15</span><br><span class="line">data21,data22,data23,data24,data25</span><br><span class="line">data31,data32,data33,data34,data35</span><br></pre></td></tr></table></figure><ul><li>æ­£åˆ™è¡¨è¾¾å¼</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /11/åŒ¹é…äº†æ•°æ®å­—æ®µä¸­å«æœ‰å­—ç¬¦ä¸²11çš„è®°å½•</span></span><br><span class="line">$ gawk <span class="string">&#x27;BEGIN&#123;FS=&quot;,&quot;&#125; /11/&#123;print $0&#125;&#x27;</span> data1</span><br><span class="line">data11,data12,data13,data14,data15</span><br></pre></td></tr></table></figure><ul><li>åŒ¹é…æ“ä½œç¬¦</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># $1 ~ /^data2/åŒ¹é…ç¬¬ä¸€ä¸ªå­—æ®µä»¥data2å¼€å¤´çš„è®°å½•</span></span><br><span class="line">$ gawk <span class="string">&#x27;BEGIN&#123;FS=&quot;,&quot;&#125; $1 ~ /^data2/&#123;print $0&#125;&#x27;</span> data1</span><br><span class="line">data21,data22,data23,data24,data25</span><br><span class="line"></span><br><span class="line"><span class="comment"># $1 !~ /^data2/åŒ¹é…ç¬¬ä¸€ä¸ªå­—æ®µä¸ä»¥data2å¼€å¤´çš„è®°å½•</span></span><br><span class="line">$ gawk <span class="string">&#x27;BEGIN&#123;FS=&quot;,&quot;&#125; $1 !~ /^data2/&#123;print $0&#125;&#x27;</span> data1</span><br><span class="line">data11,data12,data13,data14,data15</span><br><span class="line">data31,data32,data33,data34,data35</span><br></pre></td></tr></table></figure><ul><li>æ•°å­¦è¡¨è¾¾å¼</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># $1 == &quot;data11&quot;åŒ¹é…ç¬¬ä¸€ä¸ªå­—æ®µç­‰äºdata11çš„è®°å½•</span></span><br><span class="line">$ gawk <span class="string">&#x27;BEGIN&#123;FS=&quot;,&quot;&#125; $1 == &quot;data11&quot;&#123;print $1&#125;&#x27;</span> data1</span><br><span class="line">data11,data12,data13,data14,data15</span><br></pre></td></tr></table></figure><h2 id="ç»“æ„åŒ–"><a href="#ç»“æ„åŒ–" class="headerlink" title="ç»“æ„åŒ–"></a>ç»“æ„åŒ–</h2><ul><li><code>if</code> è¯­å¥</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> data2</span><br><span class="line">10</span><br><span class="line">5</span><br><span class="line">13</span><br><span class="line">50</span><br><span class="line">34</span><br><span class="line"></span><br><span class="line">$ gawk <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">&gt; if ($1 &gt; 20) &#123;</span></span><br><span class="line"><span class="string">&gt; x = $1 / 2</span></span><br><span class="line"><span class="string">&gt; print x</span></span><br><span class="line"><span class="string">&gt; &#125; else &#123;</span></span><br><span class="line"><span class="string">&gt; x = $1 * 2</span></span><br><span class="line"><span class="string">&gt; print x</span></span><br><span class="line"><span class="string">&gt; &#125;</span></span><br><span class="line"><span class="string">&gt; &#125;&#x27;</span> data2</span><br><span class="line">20</span><br><span class="line">10</span><br><span class="line">26</span><br><span class="line">25</span><br><span class="line">17</span><br></pre></td></tr></table></figure><ul><li><code>while</code> è¯­å¥</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> data3</span><br><span class="line">130 120 135</span><br><span class="line">160 113 140</span><br><span class="line">145 170 215</span><br><span class="line"></span><br><span class="line">$ gawk <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">total = 0</span></span><br><span class="line"><span class="string">i = 1</span></span><br><span class="line"><span class="string">while (i &lt; 4) &#123;</span></span><br><span class="line"><span class="string">  total += $i</span></span><br><span class="line"><span class="string">  if (i == 2)</span></span><br><span class="line"><span class="string">    break</span></span><br><span class="line"><span class="string">  i++</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">avg = total / 2</span></span><br><span class="line"><span class="string">print &quot;Average:&quot;,avg</span></span><br><span class="line"><span class="string">&#125;&#x27;</span> data3</span><br><span class="line">Average: 125</span><br><span class="line">Average: 136.5</span><br><span class="line">Average: 157.5</span><br></pre></td></tr></table></figure><ul><li><code>do-while</code> è¯­å¥</li><li><code>for</code> è¯­å¥</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ gawk <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">&gt; total = 0</span></span><br><span class="line"><span class="string">&gt; i = 1</span></span><br><span class="line"><span class="string">&gt; for (i = 1; i &lt; 4; i++) &#123;</span></span><br><span class="line"><span class="string">&gt; total += $i</span></span><br><span class="line"><span class="string">&gt; &#125;</span></span><br><span class="line"><span class="string">&gt; avg = total / 3</span></span><br><span class="line"><span class="string">&gt; print &quot;Average:&quot;,avg</span></span><br><span class="line"><span class="string">&gt; &#125;&#x27;</span> data3</span><br><span class="line">Average: 128.333</span><br><span class="line">Average: 137.667</span><br><span class="line">Average: 176.667</span><br></pre></td></tr></table></figure><h2 id="æ ¼å¼åŒ–"><a href="#æ ¼å¼åŒ–" class="headerlink" title="æ ¼å¼åŒ–"></a>æ ¼å¼åŒ–</h2><p>gawkä½¿ç”¨ <code>printf</code> å‘½ä»¤å®ç°æ ¼å¼åŒ–ï¼Œå‘½ä»¤æ ¼å¼ï¼š<code>printf &quot;%[modifier]control-letter ...&quot;, var1, var2 ...</code></p><table><thead><tr><th>æ§åˆ¶å­—æ¯</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>c</code></td><td>å°†ä¸€ä¸ªæ•°ä½œä¸ºASCIIå­—ç¬¦æ˜¾ç¤º</td></tr><tr><td><code>d</code></td><td>æ˜¾ç¤ºä¸€ä¸ªæ•´æ•°å€¼</td></tr><tr><td><code>i</code></td><td>æ˜¾ç¤ºä¸€ä¸ªæ•´æ•°å€¼ï¼ˆè·Ÿdä¸€æ ·ï¼‰</td></tr><tr><td><code>e</code></td><td>ç”¨ç§‘å­¦è®¡æ•°æ³•æ˜¾ç¤ºä¸€ä¸ªæ•°</td></tr><tr><td><code>f</code></td><td>æ˜¾ç¤ºä¸€ä¸ªæµ®ç‚¹å€¼</td></tr><tr><td><code>g</code></td><td>ç”¨ç§‘å­¦è®¡æ•°æ³•æˆ–æµ®ç‚¹æ•°æ˜¾ç¤ºï¼ˆé€‰æ‹©è¾ƒçŸ­çš„æ ¼å¼ï¼‰</td></tr><tr><td><code>o</code></td><td>æ˜¾ç¤ºä¸€ä¸ªå…«è¿›åˆ¶å€¼</td></tr><tr><td><code>s</code></td><td>æ˜¾ç¤ºä¸€ä¸ªæ–‡æœ¬å­—ç¬¦ä¸²</td></tr><tr><td><code>x</code></td><td>æ˜¾ç¤ºä¸€ä¸ªåå…­è¿›åˆ¶å€¼</td></tr><tr><td><code>X</code></td><td>æ˜¾ç¤ºä¸€ä¸ªåå…­è¿›åˆ¶å€¼ï¼Œä½†ç”¨å¤§å†™å­—æ¯A~F</td></tr></tbody></table><p>é™¤äº†æ§åˆ¶å­—æ¯å¤–ï¼Œè¿˜æœ‰3ç§ä¿®é¥°ç¬¦å¯ä»¥ç”¨æ¥è¿›ä¸€æ­¥æ§åˆ¶è¾“å‡ºã€‚</p><ul><li><p>widthï¼šæŒ‡å®šäº†è¾“å‡ºå­—æ®µæœ€å°å®½åº¦çš„æ•°å­—å€¼ã€‚å¦‚æœè¾“å‡ºçŸ­äºè¿™ä¸ªå€¼ï¼Œprintfä¼šå°†æ–‡æœ¬å³å¯¹é½ï¼Œå¹¶ç”¨ç©ºæ ¼è¿›è¡Œå¡«å……ã€‚å¦‚æœè¾“å‡ºæ¯”æŒ‡å®šçš„å®½åº¦è¿˜è¦é•¿ï¼Œåˆ™æŒ‰ç…§å®é™…çš„é•¿åº¦è¾“å‡ºã€‚</p></li><li><p>precï¼šæŒ‡å®šäº†æµ®ç‚¹æ•°ä¸­å°æ•°ç‚¹åé¢ä½æ•°ï¼Œæˆ–è€…æ–‡æœ¬å­—ç¬¦ä¸²ä¸­æ˜¾ç¤ºçš„æœ€å¤§å­—ç¬¦æ•°ã€‚</p></li><li><p>-ï¼ˆå‡å·ï¼‰ï¼šé‡‡ç”¨å·¦å¯¹é½ï¼ˆé»˜è®¤å³å¯¹é½ï¼‰ã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> data4</span><br><span class="line">Riley Mullen</span><br><span class="line">123 Main Street</span><br><span class="line">Chicago, IL 60601</span><br><span class="line">(312)555-1234</span><br><span class="line"></span><br><span class="line">Frank Williams</span><br><span class="line">456 Oak Street</span><br><span class="line">Indianapolis, IN 46201</span><br><span class="line">(317)555-9876</span><br><span class="line"></span><br><span class="line">Haley Snell</span><br><span class="line">4231 Elm Street</span><br><span class="line">Detroit, MI 48201</span><br><span class="line">(313)555-4938</span><br><span class="line"></span><br><span class="line">$ gawk <span class="string">&#x27;BEGIN&#123;FS=&quot;\n&quot;; RS=&quot;&quot;&#125; &#123;printf &quot;%-14s  %s\n&quot;, $1, $4&#125;&#x27;</span> data4</span><br><span class="line">Riley Mullen    (312)555-1234</span><br><span class="line">Frank Williams  (317)555-9876</span><br><span class="line">Haley Snell     (313)555-4938</span><br><span class="line"></span><br><span class="line">$ gawk <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">&gt; total = 0</span></span><br><span class="line"><span class="string">&gt; for (i = 1; i &lt; 4; i++) &#123;</span></span><br><span class="line"><span class="string">&gt; total += $i</span></span><br><span class="line"><span class="string">&gt; &#125;</span></span><br><span class="line"><span class="string">&gt; avg = total / 3</span></span><br><span class="line"><span class="string">&gt; printf &quot;Average: %5.1f\n&quot;,avg</span></span><br><span class="line"><span class="string">&gt; &#125;&#x27;</span> data3</span><br><span class="line">Average: 128.3</span><br><span class="line">Average: 137.7</span><br><span class="line">Average: 176.7</span><br></pre></td></tr></table></figure><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      <categories>
          
          <category> DevOps </category>
          
      </categories>
      
      
        <tags>
            
            <tag> shell </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vimåŸºç¡€</title>
      <link href="/post/d16c64e7.html"/>
      <url>/post/d16c64e7.html</url>
      
        <content type="html"><![CDATA[<h2 id="åŸºæœ¬å‘½ä»¤"><a href="#åŸºæœ¬å‘½ä»¤" class="headerlink" title="åŸºæœ¬å‘½ä»¤"></a>åŸºæœ¬å‘½ä»¤</h2><h3 id="å¸¸ç”¨"><a href="#å¸¸ç”¨" class="headerlink" title="å¸¸ç”¨"></a>å¸¸ç”¨</h3><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>i</code></td><td>åœ¨å…‰æ ‡å‰æ’å…¥</td></tr><tr><td><code>a</code></td><td>åœ¨å…‰æ ‡åæ’å…¥</td></tr><tr><td><code>o</code></td><td>åœ¨å½“å‰è¡Œåæ’å…¥ä¸€è¡Œ</td></tr><tr><td><code>O</code></td><td>åœ¨å½“å‰è¡Œå‰æ’å…¥ä¸€è¡Œ</td></tr><tr><td><code>esc</code></td><td>è¿”å›Normalæ¨¡å¼ï¼ˆé€€å‡ºç¼–è¾‘ï¼‰</td></tr><tr><td><code>:q</code></td><td>é€€å‡º</td></tr><tr><td><code>:q!</code></td><td>å¼ºåˆ¶é€€å‡º</td></tr><tr><td><code>:wq</code></td><td>ä¿å­˜å¹¶é€€å‡º</td></tr><tr><td><code>hjkl</code></td><td>â†â†“â†‘â†’</td></tr><tr><td><code>u</code></td><td>æ’¤é”€ä¸Šä¸€æ­¥æ“ä½œ</td></tr><tr><td><code>ctrl+r</code></td><td>é‡æ”¾ä¸Šä¸€æ­¥æ“ä½œ</td></tr><tr><td><code>:set number</code></td><td>è®¾ç½®è¡Œå·</td></tr><tr><td><code>:set nonumber</code></td><td>å–æ¶ˆè¡Œå·</td></tr><tr><td><code>G</code></td><td>è·³è½¬åˆ°æœ€åä¸€è¡Œå¼€å¤´</td></tr><tr><td><code>gg</code></td><td>è·³è½¬åˆ°ç¬¬ä¸€è¡Œå¼€å¤´</td></tr><tr><td><code>:n + enter</code></td><td>è·³è½¬åˆ°æŒ‡å®šè¡Œ</td></tr><tr><td><code>n + G</code></td><td>è·³è½¬åˆ°æŒ‡å®šè¡Œ</td></tr></tbody></table><h3 id="å…‰æ ‡ç§»åŠ¨"><a href="#å…‰æ ‡ç§»åŠ¨" class="headerlink" title="å…‰æ ‡ç§»åŠ¨"></a>å…‰æ ‡ç§»åŠ¨</h3><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>0</code></td><td>ç§»åŠ¨å…‰æ ‡åˆ°è¡Œå¤´</td></tr><tr><td><code>$</code></td><td>ç§»åŠ¨å…‰æ ‡åˆ°è¡Œå°¾</td></tr><tr><td><code>^</code></td><td>ç§»åŠ¨å…‰æ ‡åˆ°ç¬¬ä¸€ä¸ªéç©ºå­—ç¬¦</td></tr><tr><td><code>g_</code></td><td>ç§»åŠ¨å…‰æ ‡åˆ°æœ€åä¸€ä¸ªéç©ºå­—ç¬¦</td></tr><tr><td><code>w</code></td><td>ç§»åŠ¨å…‰æ ‡åˆ°ä¸‹ä¸€ä¸ªå•è¯</td></tr><tr><td><code>W</code></td><td>ç§»åŠ¨å…‰æ ‡åˆ°ä¸‹ä¸€ä¸ªå•è¯ï¼Œè·³è¿‡æ ‡ç‚¹ç¬¦å·</td></tr><tr><td><code>b</code></td><td>ç§»åŠ¨å…‰æ ‡åˆ°å•è¯å¼€å¤´</td></tr><tr><td><code>B</code></td><td>ç§»åŠ¨å…‰æ ‡åˆ°å•è¯å¼€å¤´ï¼Œè·³è¿‡æ ‡ç‚¹ç¬¦å·</td></tr><tr><td><code>e</code></td><td>ç§»åŠ¨å…‰æ ‡åˆ°å•è¯ç»“å°¾</td></tr><tr><td><code>E</code></td><td>ç§»åŠ¨å…‰æ ‡åˆ°å•è¯ç»“å°¾ï¼Œè·³è¿‡æ ‡ç‚¹ç¬¦å·</td></tr></tbody></table><h3 id="é€‰æ‹©ã€å‰ªåˆ‡ã€æ‹·è´"><a href="#é€‰æ‹©ã€å‰ªåˆ‡ã€æ‹·è´" class="headerlink" title="é€‰æ‹©ã€å‰ªåˆ‡ã€æ‹·è´"></a>é€‰æ‹©ã€å‰ªåˆ‡ã€æ‹·è´</h3><table><thead><tr><th>å…‰æ ‡å‘½ä»¤</th><th>åˆ é™¤å‘½ä»¤</th><th>é€‰æ‹©å‘½ä»¤</th><th>å‰ªåˆ‡å‘½ä»¤</th><th>æ‹·è´å‘½ä»¤</th></tr></thead><tbody><tr><td></td><td></td><td></td><td><code>dd</code></td><td><code>yy</code></td></tr><tr><td><code>0</code></td><td><code>c0</code></td><td><code>v0</code></td><td><code>d0</code></td><td><code>y0</code></td></tr><tr><td><code>$</code></td><td><code>c$</code></td><td><code>v$</code></td><td><code>d$</code></td><td><code>y$</code></td></tr><tr><td><code>w</code></td><td><code>cw</code></td><td><code>vw</code></td><td><code>dw</code></td><td><code>yw</code></td></tr><tr><td><code>W</code></td><td><code>cW</code></td><td><code>vW</code></td><td><code>dW</code></td><td><code>yW</code></td></tr><tr><td><code>b</code></td><td><code>cb</code></td><td><code>vb</code></td><td><code>de</code></td><td><code>ye</code></td></tr><tr><td><code>B</code></td><td><code>cB</code></td><td><code>vB</code></td><td><code>dE</code></td><td><code>yE</code></td></tr><tr><td><code>e</code></td><td><code>ce</code></td><td><code>ve</code></td><td><code>db</code></td><td><code>yb</code></td></tr><tr><td><code>E</code></td><td><code>cE</code></td><td><code>vE</code></td><td><code>dB</code></td><td><code>yB</code></td></tr><tr><td><code>G</code></td><td><code>cG</code></td><td><code>vG</code></td><td><code>dG</code></td><td><code>yG</code></td></tr><tr><td><code>gg</code></td><td><code>cgg</code></td><td><code>vgg</code></td><td><code>dgg</code></td><td><code>ygg</code></td></tr></tbody></table><h3 id="åˆ é™¤å­—ç¬¦"><a href="#åˆ é™¤å­—ç¬¦" class="headerlink" title="åˆ é™¤å­—ç¬¦"></a>åˆ é™¤å­—ç¬¦</h3><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>x</code></td><td>åˆ é™¤å½“å‰å­—ç¬¦</td></tr><tr><td><code>X</code></td><td>åˆ é™¤å‰ä¸€ä¸ªå­—ç¬¦</td></tr></tbody></table><h3 id="å¤åˆ¶"><a href="#å¤åˆ¶" class="headerlink" title="å¤åˆ¶"></a>å¤åˆ¶</h3><table><thead><tr><th>å‘½ä»¤</th><th>ç»„åˆå‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>p</code></td><td><code>x/X</code> + <code>p</code></td><td>å°å†™pï¼Œå°†å‰ªåˆ‡ç‰ˆå†…å®¹å¤åˆ¶åˆ°å½“å‰å…‰æ ‡çš„åé¢</td></tr><tr><td></td><td><code>d./y.</code> + <code>p</code></td><td>å°å†™pï¼Œå°†å‰ªåˆ‡ç‰ˆå†…å®¹å¤åˆ¶åˆ°å½“å‰å…‰æ ‡çš„ä¸‹ä¸€è¡Œ</td></tr><tr><td><code>P</code></td><td><code>x/X</code> + <code>P</code></td><td>å¤§å†™Pï¼Œå°†å‰ªåˆ‡ç‰ˆå†…å®¹å¤åˆ¶åˆ°å½“å‰å…‰æ ‡çš„å‰é¢</td></tr><tr><td></td><td><code>d./y.</code> + <code>P</code></td><td>å¤§å†™Pï¼Œå°†å‰ªåˆ‡ç‰ˆå†…å®¹å¤åˆ¶åˆ°å½“å‰å…‰æ ‡çš„ä¸Šä¸€è¡Œ</td></tr></tbody></table><h3 id="æœç´¢"><a href="#æœç´¢" class="headerlink" title="æœç´¢"></a>æœç´¢</h3><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>/keyword</code> + <code>enter</code></td><td>å‘ä¸‹æœç´¢</td></tr><tr><td><code>?keyword</code> + <code>enter</code></td><td>å‘ä¸Šæœç´¢</td></tr><tr><td><code>n</code></td><td>ä¸‹ä¸€ä¸ªåŒ¹é…é¡¹</td></tr><tr><td><code>N</code></td><td>ä¸Šä¸€ä¸ªåŒ¹é…é¡¹</td></tr></tbody></table><h2 id="è¿›é˜¶å‘½ä»¤"><a href="#è¿›é˜¶å‘½ä»¤" class="headerlink" title="è¿›é˜¶å‘½ä»¤"></a>è¿›é˜¶å‘½ä»¤</h2><h3 id="é‡å¤"><a href="#é‡å¤" class="headerlink" title="é‡å¤"></a>é‡å¤</h3><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>.</code></td><td>é‡å¤ä¸Šä¸€æ¬¡å‘½ä»¤</td></tr><tr><td><code>n&lt;command&gt;</code></td><td>é‡å¤æŸä¸ªå‘½ä»¤næ¬¡</td></tr></tbody></table><h3 id="å…‰æ ‡ç§»åŠ¨-1"><a href="#å…‰æ ‡ç§»åŠ¨-1" class="headerlink" title="å…‰æ ‡ç§»åŠ¨"></a>å…‰æ ‡ç§»åŠ¨</h3><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>)</code></td><td>ç§»åŠ¨å…‰æ ‡åˆ°ä¸‹ä¸€ä¸ªå¥å­å¼€å¤´</td></tr><tr><td><code>(</code></td><td>ç§»åŠ¨å…‰æ ‡åˆ°ä¸Šä¸€ä¸ªå¥å­å¼€å¤´</td></tr><tr><td><code>&#125;</code></td><td>ç§»åŠ¨å…‰æ ‡åˆ°ä¸‹ä¸€æ®µè½å¼€å¤´</td></tr><tr><td><code>&#123;</code></td><td>ç§»åŠ¨å…‰æ ‡åˆ°ä¸Šä¸€æ®µè½å¼€å¤´</td></tr><tr><td><code>*</code></td><td>ç§»åŠ¨å…‰æ ‡åˆ°ä¸‹ä¸€ä¸ªåŒ¹é…å•è¯</td></tr><tr><td><code>#</code></td><td>ç§»åŠ¨å…‰æ ‡åˆ°ä¸Šä¸€ä¸ªåŒ¹é…å•è¯</td></tr><tr><td><code>f&lt;char&gt;</code></td><td>ç§»åŠ¨å…‰æ ‡åˆ°ä¸‹ä¸€ä¸ª<code>&lt;char&gt;</code></td></tr><tr><td><code>t&lt;char&gt;</code></td><td>ç§»åŠ¨å…‰æ ‡åˆ°ä¸‹ä¸€ä¸ª<code>&lt;char&gt;</code>çš„å‰ä¸€ä¸ªå­—ç¬¦</td></tr></tbody></table><h3 id="æœç´¢-1"><a href="#æœç´¢-1" class="headerlink" title="æœç´¢"></a>æœç´¢</h3><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>:set hlsearch</code></td><td>å¼€å¯é«˜äº®æ˜¾ç¤º</td></tr><tr><td><code>:nohlsearch</code></td><td>å…³é—­é«˜äº®æ˜¾ç¤º</td></tr><tr><td><code>/\&lt;keyword\&gt;</code></td><td>å…¨è¯åŒ¹é…æœç´¢</td></tr><tr><td><code>:set noignorecae</code></td><td>å¤§å°å†™æ•æ„Ÿï¼ˆé»˜è®¤ï¼‰</td></tr><tr><td><code>:set ignorecase</code></td><td>å¿½ç•¥å¤§å°å†™</td></tr><tr><td><code>/\d</code></td><td>æœç´¢åŒ…å«æ•°å­—çš„è¡Œ</td></tr><tr><td><code>/^keyword</code></td><td>æœç´¢ä»¥<code>keyword</code>å¼€å¤´çš„è¡Œ</td></tr></tbody></table><h3 id="æœç´¢å¹¶æ›¿æ¢"><a href="#æœç´¢å¹¶æ›¿æ¢" class="headerlink" title="æœç´¢å¹¶æ›¿æ¢"></a>æœç´¢å¹¶æ›¿æ¢</h3><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>:%s/foo/bar/g</code></td><td>å…¨æ–‡æ›¿æ¢</td></tr><tr><td><code>:%s/foo/bar/gc</code></td><td>æ›¿æ¢å‰ç¡®è®¤</td></tr><tr><td><code>:%s/foo/bar/gi</code></td><td>å¿½ç•¥å¤§å°å†™</td></tr><tr><td><code>:10,20s/foo/bar/g</code></td><td>æŒ‡å®šèŒƒå›´æ›¿æ¢</td></tr><tr><td><code>:.,$s/foo/bar/g</code></td><td>ä»å½“å‰è¡Œåˆ°æ–‡ä»¶æœ«å°¾æ›¿æ¢</td></tr><tr><td><code>:%s/foo//g</code></td><td>åˆ é™¤åŒ¹é…æ–‡æœ¬</td></tr></tbody></table><h3 id="å¤§å°å†™åˆ‡æ¢"><a href="#å¤§å°å†™åˆ‡æ¢" class="headerlink" title="å¤§å°å†™åˆ‡æ¢"></a>å¤§å°å†™åˆ‡æ¢</h3><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>gu</code>+<code>l(â†’)</code></td><td>å½“å‰å­—ç¬¦å˜å°å†™</td></tr><tr><td><code>gu</code>+<code>enter</code></td><td>å½“å‰è¡Œå˜å°å†™</td></tr><tr><td><code>gU</code>+<code>l(â†’)</code></td><td>å½“å‰å­—ç¬¦å˜å¤§å†™</td></tr><tr><td><code>gU</code>+<code>enter</code></td><td>å½“å‰è¡Œå˜å¤§å†™</td></tr></tbody></table><h2 id="å®ç”¨å‘½ä»¤"><a href="#å®ç”¨å‘½ä»¤" class="headerlink" title="å®ç”¨å‘½ä»¤"></a>å®ç”¨å‘½ä»¤</h2><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>:%</code></td><td>é€‰ä¸­å…¨æ–‡</td></tr><tr><td><code>:%d</code></td><td>åˆ é™¤å…¨æ–‡</td></tr><tr><td><code>:%y</code></td><td>æ‹·è´å…¨æ–‡åˆ°å¯„å­˜å™¨</td></tr><tr><td><code>:%y+</code></td><td>æ‹·è´å…¨æ–‡åˆ°ç³»ç»Ÿå‰ªåˆ‡æ¿</td></tr><tr><td><code>ggVGy</code></td><td>æ‹·è´å…¨æ–‡åˆ°å¯„å­˜å™¨</td></tr><tr><td><code>dt&quot;</code></td><td>åˆ é™¤æ‰€æœ‰çš„å†…å®¹ï¼Œç›´åˆ°é‡åˆ°åŒå¼•å·</td></tr><tr><td><code>y2/foo</code></td><td>æ‹·è´ä¸¤ä¸ª <code>foo</code> ä¹‹é—´çš„å†…å®¹</td></tr></tbody></table><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      <categories>
          
          <category> DevOps </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vim </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LinuxåŸºç¡€</title>
      <link href="/post/82734d8.html"/>
      <url>/post/82734d8.html</url>
      
        <content type="html"><![CDATA[<h2 id="æ–‡ä»¶ç³»ç»Ÿ"><a href="#æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="æ–‡ä»¶ç³»ç»Ÿ"></a>æ–‡ä»¶ç³»ç»Ÿ</h2><h3 id="ç›®å½•ç»“æ„"><a href="#ç›®å½•ç»“æ„" class="headerlink" title="ç›®å½•ç»“æ„"></a>ç›®å½•ç»“æ„</h3><p>Linuxæ–‡ä»¶ç³»ç»Ÿç›®å½•ç»“æ„é€šå¸¸å¦‚ä¸‹ï¼š</p><img src="/post/82734d8/image-20240917223411860.png" class="" title="image-20240917223411860"><span id="more"></span><p>ç›®å½•è¯´æ˜ï¼š</p><ul><li>&#x2F;binï¼šå­˜æ”¾åŸºæœ¬çš„ç”¨æˆ·å‘½ä»¤æ–‡ä»¶ï¼Œå¦‚lsã€cpç­‰</li><li>&#x2F;bootï¼šå­˜æ”¾å¯åŠ¨ç³»ç»Ÿæ‰€éœ€æ–‡ä»¶</li><li>&#x2F;devï¼šè®¾å¤‡æ–‡ä»¶</li><li><strong>&#x2F;etcï¼šå­˜æ”¾ç³»ç»Ÿå’Œåº”ç”¨ç¨‹åºçš„é…ç½®æ–‡ä»¶</strong></li><li>&#x2F;homeï¼šå­˜æ”¾ç”¨æˆ·çš„ä¸»ç›®å½•</li><li>&#x2F;libï¼šå­˜æ”¾ç³»ç»Ÿç¨‹åºå’Œå†…æ ¸æ‰€éœ€çš„å…±äº«åº“æ–‡ä»¶</li><li>&#x2F;optï¼šå­˜æ”¾å¯é€‰çš„ç¬¬ä¸‰æ–¹è½¯ä»¶åŒ…</li><li>&#x2F;procï¼šè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼Œæä¾›å…³äºå†…æ ¸å’Œè¿›ç¨‹çš„ä¿¡æ¯</li><li>&#x2F;rootï¼šè¶…çº§ç”¨æˆ·ï¼ˆrootï¼‰çš„ä¸»ç›®å½•</li><li>&#x2F;sbinï¼šå­˜æ”¾ç³»ç»Ÿç®¡ç†å‘½ä»¤å’Œå·¥å…·</li><li>&#x2F;tmpï¼šå­˜æ”¾ä¸´æ—¶æ–‡ä»¶</li><li><strong>&#x2F;usrï¼šå­˜æ”¾åº”ç”¨ç¨‹åºå’Œåº“ï¼ŒåŒ…æ‹¬å¤§å¤šæ•°ç³»ç»Ÿå·¥å…·å’Œåº”ç”¨ç¨‹åº</strong></li><li>&#x2F;varï¼šå­˜æ”¾åŠ¨æ€æ•°æ®ï¼Œå¦‚æ—¥å¿—ã€ç¼“å­˜ã€é‚®ä»¶ç­‰</li><li><strong>&#x2F;usr&#x2F;localï¼šå­˜æ”¾é€šè¿‡æºç å®‰è£…çš„è½¯ä»¶</strong></li></ul><h3 id="æ–‡ä»¶åŸºæœ¬å±æ€§"><a href="#æ–‡ä»¶åŸºæœ¬å±æ€§" class="headerlink" title="æ–‡ä»¶åŸºæœ¬å±æ€§"></a>æ–‡ä»¶åŸºæœ¬å±æ€§</h3><img src="/post/82734d8/image-20240916235314084.png" class="" title="image-20240916235314084"><ul><li>[d] ç›®å½•</li><li>[-] æ–‡ä»¶</li><li>[l] é“¾æ¥</li><li>[b] å­˜å‚¨è®¾å¤‡</li><li>[c] ä¸²è¡Œç«¯å£è®¾å¤‡ï¼Œå¦‚é¼ æ ‡ã€é”®ç›˜</li></ul><h2 id="å¸¸ç”¨å‘½ä»¤"><a href="#å¸¸ç”¨å‘½ä»¤" class="headerlink" title="å¸¸ç”¨å‘½ä»¤"></a>å¸¸ç”¨å‘½ä»¤</h2><h3 id="æ–‡ä»¶å’Œç›®å½•æ“ä½œ"><a href="#æ–‡ä»¶å’Œç›®å½•æ“ä½œ" class="headerlink" title="æ–‡ä»¶å’Œç›®å½•æ“ä½œ"></a>æ–‡ä»¶å’Œç›®å½•æ“ä½œ</h3><h4 id="cd"><a href="#cd" class="headerlink" title="cd"></a><code>cd</code></h4><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>cd -</code></td><td>è¿”å›ä¸Šæ¬¡æ‰€åœ¨çš„ç›®å½•</td></tr></tbody></table><h4 id="pwd"><a href="#pwd" class="headerlink" title="pwd"></a><code>pwd</code></h4><p>æ‰“å°å½“å‰å·¥ä½œç›®å½•</p><h4 id="mkdir"><a href="#mkdir" class="headerlink" title="mkdir"></a><code>mkdir</code></h4><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>mkdir -P dir1/dir2/dir3</code></td><td>é€’å½’åˆ›å»ºç›®å½•</td></tr></tbody></table><h4 id="rmdir"><a href="#rmdir" class="headerlink" title="rmdir"></a><code>rmdir</code></h4><h4 id="ls"><a href="#ls" class="headerlink" title="ls"></a><code>ls</code></h4><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>ls -al</code></td><td>æ˜¾ç¤ºæ‰€æœ‰æ–‡ä»¶ï¼ˆåŒ…æ‹¬éšè—æ–‡ä»¶ï¼‰çš„è¯¦ç»†ä¿¡æ¯</td></tr><tr><td><code>ls -F1R</code></td><td>é€’å½’åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶å’Œç›®å½•ï¼Œæ¯è¡Œæ˜¾ç¤ºä¸€ä¸ªï¼Œå¹¶åœ¨æ–‡ä»¶ååé™„åŠ ä¸€ä¸ªæŒ‡ç¤ºç¬¦æ¥æ ‡è¯†æ–‡ä»¶ç±»å‹</td></tr><tr><td><code>ls -tr</code></td><td>æŒ‰ä¿®æ”¹æ—¶é—´æ­£åºæ˜¾ç¤º</td></tr></tbody></table><h4 id="cp"><a href="#cp" class="headerlink" title="cp"></a><code>cp</code></h4><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>cp -r dir1 dir2</code></td><td>é€’å½’å¤åˆ¶ï¼ˆä¿ç•™åŸºæœ¬ç»“æ„ï¼‰</td></tr><tr><td><code>cp -a dir1 dir2</code></td><td>å½’æ¡£å¤åˆ¶ï¼ˆä¿ç•™å…ƒæ•°æ®ï¼‰</td></tr><tr><td><code>cp -u file1 file2</code></td><td>æœ‰æ›´æ–°æ‰å¤åˆ¶</td></tr></tbody></table><h4 id="mv"><a href="#mv" class="headerlink" title="mv"></a><code>mv</code></h4><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>mv -i</code></td><td>ç§»åŠ¨å‰æç¤ºç”¨æˆ·ç¡®è®¤</td></tr></tbody></table><h4 id="rm"><a href="#rm" class="headerlink" title="rm"></a><code>rm</code></h4><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>rm -i</code></td><td>åˆ é™¤å‰æç¤ºç”¨æˆ·ç¡®è®¤</td></tr><tr><td><code>rm -rf</code></td><td>ä¸æç¤ºï¼Œé€’å½’å¼ºåˆ¶åˆ é™¤ï¼ˆé«˜å±å‘½ä»¤ï¼‰</td></tr></tbody></table><h4 id="touch"><a href="#touch" class="headerlink" title="touch"></a><code>touch</code></h4><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>touch file</code></td><td>åˆ›å»ºç©ºæ–‡ä»¶</td></tr><tr><td><code>touch existed_file</code></td><td>æ›´æ–°æ–‡ä»¶çš„ä¿®æ”¹æ—¶é—´</td></tr><tr><td><code>touch -a existed_file</code></td><td>æ›´æ–°æ–‡ä»¶çš„è®¿é—®æ—¶é—´</td></tr></tbody></table><h4 id="ln"><a href="#ln" class="headerlink" title="ln"></a><code>ln</code></h4><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>ln file hard_link</code></td><td>åˆ›å»ºç¡¬é“¾æ¥</td></tr><tr><td><code>ln -s file soft_link</code></td><td>åˆ›å»ºè½¯é“¾æ¥</td></tr></tbody></table><h3 id="æ–‡ä»¶æœç´¢"><a href="#æ–‡ä»¶æœç´¢" class="headerlink" title="æ–‡ä»¶æœç´¢"></a>æ–‡ä»¶æœç´¢</h3><h4 id="find"><a href="#find" class="headerlink" title="find"></a><code>find</code></h4><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>find /path -name filename</code></td><td>æœç´¢å½“å‰ç›®å½•åŠå…¶å­ç›®å½•</td></tr><tr><td><code>find /path -maxdepth 1 -name filename</code></td><td>ä»…æœç´¢å½“å‰ç›®å½•</td></tr><tr><td><code>find /path -mindepth 2 -name filename</code></td><td>ä»æŒ‡å®šæ·±åº¦å¼€å§‹æœç´¢</td></tr><tr><td><code>find /path -type f </code></td><td>æœç´¢æ–‡ä»¶</td></tr><tr><td><code>find /path -iname filename</code></td><td>å¿½ç•¥å¤§å°å†™</td></tr></tbody></table><h4 id="locate"><a href="#locate" class="headerlink" title="locate"></a><code>locate</code></h4><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>locate -i filename</code></td><td>å¿½ç•¥å¤§å°å†™</td></tr><tr><td><code>locate -r pattern</code></td><td>æ­£åˆ™åŒ¹é…æŸ¥æ‰¾</td></tr></tbody></table><h4 id="which"><a href="#which" class="headerlink" title="which"></a><code>which</code></h4><p><code>which</code> ç”¨äºæ˜¾ç¤ºæŸä¸ªå‘½ä»¤æˆ–ç¨‹åºçš„ç»å¯¹è·¯å¾„ã€‚å®ƒä¼šæŸ¥æ‰¾ç³»ç»Ÿçš„ <code>$PATH</code> ç¯å¢ƒå˜é‡ä¸­åˆ—å‡ºçš„ç›®å½•ï¼Œå¹¶è¿”å›ç¬¬ä¸€ä¸ªåŒ¹é…çš„å‘½ä»¤æˆ–ç¨‹åºçš„è·¯å¾„ã€‚</p><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>which python</code></td><td>æ˜¾ç¤ºä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶æˆ–å¯æ‰§è¡Œæ–‡ä»¶çš„å®Œæ•´è·¯å¾„</td></tr></tbody></table><h4 id="whereis"><a href="#whereis" class="headerlink" title="whereis"></a><code>whereis</code></h4><p><code>whereis</code> æ˜¯ä¸€ä¸ªç±»ä¼¼äº <code>which</code> çš„å‘½ä»¤ï¼Œç”¨äºæŸ¥æ‰¾å‘½ä»¤ã€äºŒè¿›åˆ¶æ–‡ä»¶ã€æºä»£ç å’Œæ‰‹å†Œé¡µçš„æ‰€åœ¨ä½ç½®ã€‚ä¸ <code>which</code> åªæŸ¥æ‰¾ <code>$PATH</code> ç¯å¢ƒå˜é‡ä¸­çš„å¯æ‰§è¡Œæ–‡ä»¶ä¸åŒï¼Œ<code>whereis</code> ä¼šæœç´¢ç³»ç»Ÿä¸­æ›´å¤šçš„è·¯å¾„ï¼ŒåŒ…æ‹¬æ ‡å‡†äºŒè¿›åˆ¶æ–‡ä»¶è·¯å¾„ã€æºä»£ç ç›®å½•å’Œæ‰‹å†Œé¡µç›®å½•ã€‚</p><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>whereis python </code></td><td>è¾“å‡ºä¼šåŒ…æ‹¬å¤šä¸ªè·¯å¾„ï¼Œæ˜¾ç¤ºå‘½ä»¤ã€æºä»£ç å’Œæ‰‹å†Œé¡µçš„è·¯å¾„</td></tr><tr><td><code>whereis -b python</code></td><td>æŸ¥æ‰¾ <code>python</code> çš„äºŒè¿›åˆ¶æ–‡ä»¶</td></tr><tr><td><code>whereis -m python</code></td><td>æŸ¥æ‰¾ <code>python</code> çš„æ‰‹å†Œé¡µ</td></tr></tbody></table><h3 id="æ–‡ä»¶å†…å®¹æŸ¥çœ‹å’Œç¼–è¾‘"><a href="#æ–‡ä»¶å†…å®¹æŸ¥çœ‹å’Œç¼–è¾‘" class="headerlink" title="æ–‡ä»¶å†…å®¹æŸ¥çœ‹å’Œç¼–è¾‘"></a>æ–‡ä»¶å†…å®¹æŸ¥çœ‹å’Œç¼–è¾‘</h3><h4 id="wc"><a href="#wc" class="headerlink" title="wc"></a><code>wc</code></h4><p>ç»Ÿè®¡æ–‡æœ¬ï¼Œè¾“å‡º3ä¸ªå€¼ï¼šæ–‡æœ¬è¡Œæ•°ã€æ–‡æœ¬è¯æ•°ã€æ–‡æœ¬å­—èŠ‚æ•°</p><h4 id="cat"><a href="#cat" class="headerlink" title="cat"></a><code>cat</code></h4><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>cat -n file</code></td><td>æ˜¾ç¤ºæ—¶æ·»åŠ è¡Œå·</td></tr><tr><td><code>cat -b file</code></td><td>ç©ºè¡Œä¸æ·»åŠ è¡Œå·</td></tr><tr><td><code>cat /dev/null &gt; file</code></td><td>æ¸…ç©ºæ–‡ä»¶</td></tr></tbody></table><h4 id="more"><a href="#more" class="headerlink" title="more"></a><code>more</code></h4><h4 id="less"><a href="#less" class="headerlink" title="less"></a><code>less</code></h4><h4 id="head"><a href="#head" class="headerlink" title="head"></a><code>head</code></h4><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>head -n 5 file</code> &#x2F; <code>head -5 file</code></td><td>æ˜¾ç¤ºå¼€å¤´5è¡Œ</td></tr></tbody></table><h4 id="tail"><a href="#tail" class="headerlink" title="tail"></a><code>tail</code></h4><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>tail -n 5 file</code> &#x2F; <code>tail -5 file</code></td><td>æ˜¾ç¤ºæœ€å5è¡Œ</td></tr><tr><td><code>tail -f file</code></td><td>å®æ—¶ç›‘æ§æ–‡ä»¶æ›´æ–°</td></tr></tbody></table><h4 id="sort"><a href="#sort" class="headerlink" title="sort"></a><code>sort</code></h4><h4 id="grep"><a href="#grep" class="headerlink" title="grep"></a><code>grep</code></h4><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>grep &quot;keyword&quot; file</code></td><td>æŸ¥æ‰¾åŒ…å« <code>keyword</code> çš„è¡Œ</td></tr><tr><td><code>grep -i &quot;keyword&quot; file</code></td><td>å¿½ç•¥å¤§å°å†™</td></tr><tr><td><code>grep -n &quot;keyword&quot; file</code></td><td>æŸ¥æ‰¾åŒ…å« <code>keyword</code> çš„è¡Œå¹¶æ˜¾ç¤ºè¡Œå·</td></tr><tr><td><code>grep &quot;^keyword&quot; file</code></td><td>æŸ¥æ‰¾ä»¥ <code>keyword</code> å¼€å¤´çš„è¡Œ</td></tr><tr><td><code>grep &quot;keyword$&quot; file</code></td><td>æŸ¥æ‰¾ä»¥ <code>keyword</code> ç»“å°¾çš„è¡Œ</td></tr><tr><td><code>grep &quot;[0-9]&quot; file</code></td><td>æŸ¥æ‰¾åŒ…å«æ•°å­—çš„è¡Œ</td></tr><tr><td><code>grep -E</code></td><td>æ”¯æŒæ›´å¼ºå¤§çš„æ‰©å±•æ­£åˆ™è¡¨è¾¾å¼</td></tr><tr><td><code>grep -r &quot;keyword&quot; .</code></td><td>åœ¨å½“å‰ç›®å½•åŠå…¶å­ç›®å½•æŸ¥æ‰¾</td></tr><tr><td><code>grep -A 10 &quot;keyword&quot; file</code></td><td>æ˜¾ç¤ºåŒ¹é…è¡Œåé¢ <code>n</code> è¡Œ</td></tr><tr><td><code>grep -B 10 &quot;keyword&quot; file</code></td><td>æ˜¾ç¤ºåŒ¹é…è¡Œå‰é¢ <code>n</code> è¡Œ</td></tr><tr><td><code>grep -C 10 &quot;keyword&quot; file</code></td><td>æ˜¾ç¤ºåŒ¹é…è¡Œå‰åå„ <code>n</code> è¡Œ</td></tr></tbody></table><h3 id="æ–‡ä»¶æƒé™å’Œæ‰€æœ‰æƒ"><a href="#æ–‡ä»¶æƒé™å’Œæ‰€æœ‰æƒ" class="headerlink" title="æ–‡ä»¶æƒé™å’Œæ‰€æœ‰æƒ"></a>æ–‡ä»¶æƒé™å’Œæ‰€æœ‰æƒ</h3><h4 id="chmod"><a href="#chmod" class="headerlink" title="chmod"></a><code>chmod</code></h4><h4 id="chown"><a href="#chown" class="headerlink" title="chown"></a><code>chown</code></h4><h4 id="chgrp"><a href="#chgrp" class="headerlink" title="chgrp"></a><code>chgrp</code></h4><h3 id="ç³»ç»Ÿç›‘æ§å’Œç®¡ç†"><a href="#ç³»ç»Ÿç›‘æ§å’Œç®¡ç†" class="headerlink" title="ç³»ç»Ÿç›‘æ§å’Œç®¡ç†"></a>ç³»ç»Ÿç›‘æ§å’Œç®¡ç†</h3><h4 id="ps"><a href="#ps" class="headerlink" title="ps"></a><code>ps</code></h4><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>ps -aux</code></td><td><code>-a</code>ï¼šæ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·çš„è¿›ç¨‹</td></tr><tr><td></td><td><code>-u</code>ï¼šæ˜¾ç¤ºè¿›ç¨‹çš„è¯¦ç»†ä¿¡æ¯ï¼Œç‰¹åˆ«æ˜¯è¿›ç¨‹æ‰€å±çš„ç”¨æˆ·ï¼ˆUSERï¼‰ï¼ŒCPU å’Œå†…å­˜å ç”¨æƒ…å†µï¼ˆ%CPUã€%MEMï¼‰</td></tr><tr><td></td><td><code>-x</code>ï¼šåŒ…æ‹¬åå°è¿›ç¨‹</td></tr><tr><td><code>ps -ef</code></td><td><code>-e</code>ï¼šæ˜¾ç¤ºæ‰€æœ‰è¿›ç¨‹ï¼Œç­‰åŒäº <code>-A</code></td></tr><tr><td></td><td><code>-f</code>ï¼šä»¥æ ‘çŠ¶ç»“æ„æ˜¾ç¤ºè¿›ç¨‹ï¼Œæ˜¾ç¤ºè¿›ç¨‹çš„çˆ¶å­å…³ç³»ï¼Œå¹¶ä¸”åŒ…æ‹¬æ›´å¤šçš„è¯¦ç»†ä¿¡æ¯ï¼Œå¦‚çˆ¶è¿›ç¨‹ IDï¼ˆPPIDï¼‰ã€ç»ˆç«¯ï¼ˆTTYï¼‰ç­‰</td></tr></tbody></table><img src="/post/82734d8/image-20240917103223950.png" class="" title="image-20240917103223950"><img src="/post/82734d8/image-20240917103250778.png" class="" title="image-20240917103250778"><p>å°ç»“ï¼š</p><ul><li><p><code>ps -aux</code> æ˜¾ç¤ºè¯¦ç»†çš„è¿›ç¨‹ä¿¡æ¯ï¼ˆåŒ…æ‹¬èµ„æºå ç”¨ï¼‰ï¼Œæ²¡æœ‰çˆ¶å­è¿›ç¨‹å…³ç³»ã€‚</p></li><li><p><code>ps -ef</code> æ˜¾ç¤ºè¿›ç¨‹æ ‘ï¼Œé‡ç‚¹å±•ç¤ºè¿›ç¨‹é—´çš„å±‚æ¬¡ç»“æ„</p></li></ul><h4 id="top"><a href="#top" class="headerlink" title="top"></a><code>top</code></h4><p><code>top</code> ç”¨äºå®æ—¶æ˜¾ç¤ºç³»ç»Ÿçš„èµ„æºä½¿ç”¨æƒ…å†µï¼ŒåŒ…æ‹¬ CPUã€å†…å­˜ã€è¿›ç¨‹ç­‰ä¿¡æ¯ã€‚</p><h4 id="df"><a href="#df" class="headerlink" title="df"></a><code>df</code></h4><p><code>df</code> ç”¨äºæ˜¾ç¤ºæ–‡ä»¶ç³»ç»Ÿç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µï¼ŒåŒ…æ‹¬å·²ç”¨ç©ºé—´ã€å¯ç”¨ç©ºé—´å’Œæ–‡ä»¶ç³»ç»Ÿæ€»å®¹é‡ç­‰ä¿¡æ¯ã€‚</p><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>df -h</code></td><td>æ˜¾ç¤ºå¯è¯»æ€§æ›´å¥½çš„è¾“å‡º</td></tr></tbody></table><h4 id="du"><a href="#du" class="headerlink" title="du"></a><code>du</code></h4><p><code>du</code> ç”¨äºæ˜¾ç¤ºæ–‡ä»¶å’Œç›®å½•çš„ç£ç›˜ä½¿ç”¨æƒ…å†µï¼Œå¯ä»¥å¸®åŠ©æŸ¥çœ‹æ–‡ä»¶æˆ–ç›®å½•å ç”¨çš„ç£ç›˜ç©ºé—´ï¼Œä»¥ä¾¿æœ‰æ•ˆåœ°ç®¡ç†ç£ç›˜ç©ºé—´ã€‚</p><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>du -h /path</code></td><td>æŸ¥çœ‹ <code>/path</code> ç›®å½•çš„ç£ç›˜ä½¿ç”¨æƒ…å†µ</td></tr><tr><td><code>du -sh /path</code></td><td>æ˜¾ç¤ºç›®å½•çš„æ€»ç£ç›˜ä½¿ç”¨æƒ…å†µ</td></tr></tbody></table><h4 id="uptime"><a href="#uptime" class="headerlink" title="uptime"></a><code>uptime</code></h4><p>æ˜¾ç¤ºç³»ç»Ÿçš„è¿è¡Œæ—¶é—´å’Œè´Ÿè½½ã€‚</p><h3 id="ç½‘ç»œæ“ä½œ"><a href="#ç½‘ç»œæ“ä½œ" class="headerlink" title="ç½‘ç»œæ“ä½œ"></a>ç½‘ç»œæ“ä½œ</h3><h4 id="ping"><a href="#ping" class="headerlink" title="ping"></a><code>ping</code></h4><p><code>ping</code> æ˜¯ä¸€ä¸ªç½‘ç»œè¯Šæ–­å·¥å…·ï¼Œç”¨äºæµ‹è¯•ä¸»æœºä¹‹é—´çš„ç½‘ç»œè¿é€šæ€§ï¼Œä»¥åŠé€šä¿¡çš„å»¶è¿Ÿæƒ…å†µã€‚</p><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>ping -c 3 baidu.com</code></td><td>å‘é€æŒ‡å®šæ•°é‡çš„è¯·æ±‚</td></tr></tbody></table><h4 id="ifconfig-ip"><a href="#ifconfig-ip" class="headerlink" title="ifconfig/ip"></a><code>ifconfig/ip</code></h4><p><code>ifconfig</code>ï¼ˆInterface Configurationï¼‰ç”¨äºé…ç½®å’Œæ˜¾ç¤ºç½‘ç»œæ¥å£ä¿¡æ¯ã€‚åœ¨ç°ä»£Linuxç³»ç»Ÿä¸­ï¼Œ<code>ifconfig</code> é€æ¸è¢« <code>ip</code> å‘½ä»¤æ‰€å–ä»£ï¼Œä½†ä»ç„¶å¹¿æ³›ä½¿ç”¨ã€‚</p><h4 id="netstat-ss"><a href="#netstat-ss" class="headerlink" title="netstat/ss"></a><code>netstat/ss</code></h4><p><code>netstat</code>ï¼ˆnetwork statisticsï¼‰ç”¨äºæ˜¾ç¤ºç½‘ç»œè¿æ¥ã€è·¯ç”±è¡¨ã€æ¥å£ç»Ÿè®¡ã€ä¼ªè£…è¿æ¥å’Œå¤šæ’­æˆå‘˜çš„ä¿¡æ¯ã€‚å®ƒæä¾›äº†ä¸€ä¸ªæ¦‚è¿°å½“å‰ç³»ç»Ÿç½‘ç»œçŠ¶æ€çš„æ–¹å¼ï¼Œå¸®åŠ©ç”¨æˆ·äº†è§£å“ªäº›ç«¯å£æ­£åœ¨è¢«ä½¿ç”¨ã€è¿æ¥çš„çŠ¶æ€ä»¥åŠç½‘ç»œæ¥å£çš„ç»Ÿè®¡æ•°æ®ã€‚</p><p>å¸¸ç”¨é€‰é¡¹ï¼š</p><ul><li><code>-t</code>ï¼š ä»…æ˜¾ç¤º TCP è¿æ¥</li><li><code>-u</code>ï¼š ä»…æ˜¾ç¤º UDP è¿æ¥</li><li><code>-l</code>ï¼š ä»…æ˜¾ç¤º<strong>ç›‘å¬ï¼ˆLISTENï¼‰</strong> çŠ¶æ€çš„å¥—æ¥å­—ï¼ˆå³æœåŠ¡çš„ç«¯å£ï¼‰</li><li><code>-n</code>ï¼š ä»¥æ•°å­—å½¢å¼æ˜¾ç¤ºåœ°å€å’Œç«¯å£å·ï¼ˆ<strong>éå¸¸é‡è¦</strong>ï¼Œé¿å…è€—æ—¶ä¸”å¯èƒ½å¤±è´¥çš„åå‘åŸŸåè§£æï¼Œè®©è¾“å‡ºæ›´æ¸…æ™°å¿«é€Ÿï¼‰</li><li><code>-p</code> (Linux): æ˜¾ç¤ºè¿›ç¨‹IDå’Œç¨‹åºåç§°ï¼ˆéœ€è¦sudoæƒé™æ‰èƒ½æŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹ä¿¡æ¯ï¼‰</li></ul><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>netstat -tuln</code></td><td>æ˜¾ç¤ºæ‰€æœ‰TCPå’ŒUDPçš„ç›‘å¬ç«¯å£</td></tr></tbody></table><h4 id="curl"><a href="#curl" class="headerlink" title="curl"></a><code>curl</code></h4><p><strong>å¸¸ç”¨é€‰é¡¹ï¼š</strong></p><ul><li><code>-o</code> (å°å†™o)ï¼šå°†è¾“å‡ºä¿å­˜åˆ°æŒ‡å®šæ–‡ä»¶ï¼ˆè€Œéå±å¹•ï¼‰</li><li><code>-O</code> (å¤§å†™O)ï¼šä½¿ç”¨è¿œç¨‹æ–‡ä»¶çš„æ–‡ä»¶åä¿å­˜åˆ°æœ¬åœ°</li><li><code>-s</code> (Silent)ï¼šé™é»˜æ¨¡å¼ã€‚ä¸æ˜¾ç¤ºè¿›åº¦æ¡å’Œé”™è¯¯ä¿¡æ¯ï¼Œåªè¾“å‡ºçº¯æ•°æ®ã€‚å¸¸ä¸å…¶ä»–é€‰é¡¹ç»„åˆç”¨äºè„šæœ¬ä¸­ã€‚</li><li><code>-v</code> (Verbose)ï¼šè¯¦ç»†æ¨¡å¼ã€‚æ˜¾ç¤ºæ•´ä¸ªé€šä¿¡è¿‡ç¨‹çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬è¯·æ±‚å¤´å’Œå“åº”å¤´ï¼Œç”¨äºè°ƒè¯•ã€‚</li><li><code>-X</code> &#x2F; <code>--request</code>ï¼šæŒ‡å®šè‡ªå®šä¹‰çš„ HTTP æ–¹æ³•</li><li><code>-d</code> &#x2F; <code>--data</code>ï¼šå‘é€ POST è¯·æ±‚çš„è¡¨å•æ•°æ®ï¼ˆé»˜è®¤ <code>Content-Type: application/x-www-form-urlencoded</code>ï¼‰</li><li><code>-H</code> &#x2F; <code>--header</code>ï¼šè‡ªå®šä¹‰è¯·æ±‚å¤´ã€‚å‘é€ JSON æ•°æ®æˆ–è®¾ç½®è®¤è¯æ—¶å¿…é¡»ã€‚</li><li><code>-L</code> &#x2F; <code>--location</code>ï¼šè‡ªåŠ¨è·Ÿéšé‡å®šå‘ã€‚å¦‚æœæœåŠ¡å™¨è¿”å› 3xx çŠ¶æ€ç ï¼Œcurl ä¼šè‡ªåŠ¨è¯·æ±‚æ–°çš„ URLã€‚</li><li><code>-u</code> &#x2F; <code>--user</code>ï¼šæä¾›ç”¨æˆ·åå’Œå¯†ç è¿›è¡ŒåŸºç¡€è®¤è¯ (Basic Auth)</li><li><code>-i</code> &#x2F; <code>--include</code>ï¼šåœ¨è¾“å‡ºä¸­åŒ…å« HTTP å“åº”å¤´</li></ul><p><strong>å¸¸ç”¨åœºæ™¯å’Œå‘½ä»¤é€ŸæŸ¥è¡¨</strong></p><table><thead><tr><th align="left">åœºæ™¯</th><th align="left">å‘½ä»¤ç¤ºä¾‹</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left"><strong>ä¸‹è½½æ–‡ä»¶</strong></td><td align="left"><code>curl -O http://example.com/file.zip</code></td><td align="left">ä¿ç•™åŸæ–‡ä»¶åä¸‹è½½</td></tr><tr><td align="left"><strong>æµ‹è¯•API (GET)</strong></td><td align="left"><code>curl https://api.example.com/users</code></td><td align="left">æœ€ç®€å•çš„ GET è¯·æ±‚</td></tr><tr><td align="left"><strong>æµ‹è¯•API (POST JSON)</strong></td><td align="left"><code>curl -X POST -H &quot;Content-Type: application/json&quot; -d &#39;&#123;&quot;key&quot;:&quot;val&quot;&#125;&#39; https://api.example.com</code></td><td align="left"><strong>API è°ƒè¯•æ ¸å¿ƒç”¨æ³•</strong></td></tr><tr><td align="left"><strong>æäº¤è¡¨å•&#x2F;ç™»å½•</strong></td><td align="left"><code>curl -X POST -d &quot;user=alice&amp;pass=123&quot; https://login.com</code></td><td align="left">æ¨¡æ‹Ÿè¡¨å•æäº¤</td></tr><tr><td align="left"><strong>æ–‡ä»¶ä¸Šä¼ </strong></td><td align="left"><code>curl -F &quot;file=@localfile.jpg&quot; https://upload.com</code></td><td align="left">æ¨¡æ‹Ÿè¡¨å•æ–‡ä»¶ä¸Šä¼ </td></tr><tr><td align="left"><strong>å¸¦è®¤è¯çš„è¯·æ±‚</strong></td><td align="left"><code>curl -u user:pass https://api.com</code></td><td align="left">Basic è®¤è¯</td></tr><tr><td align="left"><strong>æŸ¥çœ‹å“åº”å¤´</strong></td><td align="left"><code>curl -I https://example.com</code></td><td align="left">æ£€æŸ¥çŠ¶æ€ç å’Œå¤´éƒ¨ä¿¡æ¯</td></tr><tr><td align="left"><strong>è‡ªåŠ¨è·Ÿéšè·³è½¬</strong></td><td align="left"><code>curl -L http://example.com</code></td><td align="left">å¤„ç† 301&#x2F;302 é‡å®šå‘</td></tr><tr><td align="left"><strong>é™é»˜ä¸‹è½½</strong></td><td align="left"><code>curl -s -o file.txt https://example.com</code></td><td align="left">é€‚åˆè„šæœ¬ä¸­ä½¿ç”¨</td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸€ä¸ªéå¸¸å¸¸è§çš„è°ƒè¯•å‘½ä»¤ï¼šé™é»˜æ¨¡å¼ã€æ˜¾ç¤ºå“åº”å¤´ã€è‡ªåŠ¨è·³è½¬ã€å‘é€ JSONã€å¸¦ä¸Šè®¤è¯</span></span><br><span class="line">$ curl -s -i -L -X POST \</span><br><span class="line">     -H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">     -H <span class="string">&quot;Authorization: Bearer tok123&quot;</span> \</span><br><span class="line">     -d <span class="string">&#x27;&#123;&quot;param&quot;: &quot;value&quot;&#125;&#x27;</span> \</span><br><span class="line">     https://api.example.com/endpoint</span><br></pre></td></tr></table></figure><h4 id="wget"><a href="#wget" class="headerlink" title="wget"></a><code>wget</code></h4><p>å¸¸ç”¨åœºæ™¯å’Œå‘½ä»¤é€ŸæŸ¥è¡¨</p><table><thead><tr><th align="left">åœºæ™¯</th><th align="left">å‘½ä»¤ç¤ºä¾‹</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left"><strong>ç®€å•ä¸‹è½½æ–‡ä»¶</strong></td><td align="left"><code>wget https://example.com/file.zip</code></td><td align="left">æœ€åŸºç¡€çš„ä¸‹è½½</td></tr><tr><td align="left"><strong>ä¸‹è½½å¹¶é‡å‘½å</strong></td><td align="left"><code>wget -O backup.zip https://ex.com/file.zip</code></td><td align="left">æŒ‡å®šè¾“å‡ºæ–‡ä»¶å</td></tr><tr><td align="left"><strong>æ–­ç‚¹ç»­ä¼ </strong></td><td align="left"><code>wget -c https://ex.com/big.iso</code></td><td align="left"><strong>ä¸‹è½½å¤§æ–‡ä»¶å¿…å¤‡</strong></td></tr><tr><td align="left"><strong>é™é€Ÿä¸‹è½½</strong></td><td align="left"><code>wget --limit-rate=1m https://ex.com/big.iso</code></td><td align="left">é¿å…å¸¦å®½å æ»¡</td></tr><tr><td align="left"><strong>åå°ä¸‹è½½</strong></td><td align="left"><code>wget -b https://ex.com/big.iso</code></td><td align="left">é€€å‡ºç»ˆç«¯ä¹Ÿä¸ä¸­æ–­</td></tr><tr><td align="left"><strong>ä¸‹è½½æ•´ä¸ªç½‘ç«™</strong></td><td align="left"><code>wget -r -l 5 -k -p -np https://ex.com/docs/</code></td><td align="left"><strong>é•œåƒ&#x2F;å¤‡ä»½ç½‘ç«™</strong></td></tr><tr><td align="left"><strong>åªä¸‹è½½ç‰¹å®šæ–‡ä»¶</strong></td><td align="left"><code>wget -r -A &quot;*.pdf&quot; https://ex.com/docs/</code></td><td align="left">åªæŠ“å–PDFæ–‡ä»¶</td></tr><tr><td align="left"><strong>å¸¦è®¤è¯çš„ä¸‹è½½</strong></td><td align="left"><code>wget --user=me --password=pass https://ex.com/private</code></td><td align="left">è®¿é—®éœ€è¦ç™»å½•çš„èµ„æº</td></tr></tbody></table><h3 id="å‹ç¼©å’Œè§£å‹ç¼©"><a href="#å‹ç¼©å’Œè§£å‹ç¼©" class="headerlink" title="å‹ç¼©å’Œè§£å‹ç¼©"></a>å‹ç¼©å’Œè§£å‹ç¼©</h3><h4 id="tar"><a href="#tar" class="headerlink" title="tar"></a><code>tar</code></h4><p>å¸¸ç”¨é€‰é¡¹ï¼š</p><ul><li><p><code>-c</code>ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å½’æ¡£æ–‡ä»¶ã€‚</p></li><li><p><code>-x</code>ï¼šè§£å‹å½’æ¡£æ–‡ä»¶ã€‚</p></li><li><p><code>-t</code>ï¼šæŸ¥çœ‹å½’æ¡£æ–‡ä»¶çš„å†…å®¹ã€‚</p></li><li><p><code>-v</code>ï¼šæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯</p></li><li><p><code>-f</code>ï¼šæŒ‡å®šå½’æ¡£æ–‡ä»¶åã€‚</p></li><li><p><code>-z</code>ï¼šä½¿ç”¨ gzip å‹ç¼©ã€‚</p></li><li><p><code>-C</code>ï¼šè§£å‹åˆ°æŒ‡å®šç›®å½•ã€‚</p></li></ul><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>tar -czvf archive.tar file1 file2 dir1</code></td><td>åˆ›å»ºå‹ç¼©å½’æ¡£æ–‡ä»¶</td></tr><tr><td><code>tar -xzvf arvhive.tar</code></td><td>è§£å‹å‹ç¼©å½’æ¡£æ–‡ä»¶</td></tr></tbody></table><h3 id="å…¶ä»–å‘½ä»¤"><a href="#å…¶ä»–å‘½ä»¤" class="headerlink" title="å…¶ä»–å‘½ä»¤"></a>å…¶ä»–å‘½ä»¤</h3><h4 id="history"><a href="#history" class="headerlink" title="history"></a><code>history</code></h4><p>å‘½ä»¤å†å²é€šå¸¸ä¿å­˜åœ¨ <code>~/.bash_history</code> æ–‡ä»¶ä¸­ã€‚</p><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>history -5</code></td><td>æ˜¾ç¤ºæœ€è¿‘5æ¡å‘½ä»¤</td></tr><tr><td><code>!10057</code></td><td>æ‰§è¡Œç¼–å·ä¸º10057çš„å‘½ä»¤</td></tr><tr><td><code>!man</code></td><td>è°ƒå‡ºæœ€è¿‘ä¸€æ¡ <code>man</code> å‘½ä»¤</td></tr><tr><td><code>!!</code></td><td>è°ƒå‡ºæœ€è¿‘ä¸€æ¡å‘½ä»¤</td></tr></tbody></table><p><code>history | grep man</code>ï¼šæŸ¥æ‰¾åŒ…å« <code>man</code> çš„å†å²å‘½ä»¤</p><h4 id="un-alias"><a href="#un-alias" class="headerlink" title="(un)alias"></a><code>(un)alias</code></h4><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>alias</code></td><td>æŸ¥çœ‹æ‰€æœ‰åˆ«å</td></tr><tr><td><code>unalias ll</code></td><td>åˆ é™¤åˆ«å</td></tr><tr><td><code>alias ll=&#39;ls -l&#39;</code></td><td>è®¾ç½®åˆ«å</td></tr></tbody></table><p>åœ¨å‘½ä»¤è¡Œé€šè¿‡ <code>alias</code> è®¾ç½®çš„åˆ«ååªåœ¨å½“å‰ shell æœ‰æ•ˆï¼Œè¦è®©åˆ«åæ°¸ä¹…ç”Ÿæ•ˆï¼Œéœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®ï¼Œç”¨æˆ·çš„ shell é…ç½®æ–‡ä»¶é€šå¸¸æ˜¯<code>~/.bashrc</code> æˆ– <code>~/.bash_profile</code>ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ vim ~/.bashrc</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨æ–‡ä»¶æœ«å°¾æ·»æ”¹è¡Œ</span></span><br><span class="line"><span class="built_in">alias</span> ll=<span class="string">&#x27;ls -l&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶ä½¿åˆ«åç”Ÿæ•ˆ</span></span><br><span class="line">$ <span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></table></figure><h4 id="echo"><a href="#echo" class="headerlink" title="echo"></a><code>echo</code></h4><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>echo -n &gt; file</code></td><td>æ¸…ç©ºæ–‡ä»¶</td></tr><tr><td><code>echo $?</code></td><td>æŸ¥çœ‹shellæ‰§è¡Œçš„æœ€åä¸€æ¡å‘½ä»¤çš„é€€å‡ºçŠ¶æ€ç </td></tr></tbody></table><h4 id="set"><a href="#set" class="headerlink" title="set"></a><code>set</code></h4><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>set</code></td><td>æ˜¾ç¤ºå½“å‰çš„å®Œæ•´ç¯å¢ƒå˜é‡åˆ—è¡¨</td></tr></tbody></table><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      <categories>
          
          <category> DevOps </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Gitå¸¸ç”¨å‘½ä»¤</title>
      <link href="/post/e8c9512e.html"/>
      <url>/post/e8c9512e.html</url>
      
        <content type="html"><![CDATA[<p>Git å¸¸ç”¨å‘½ä»¤ï¼š<a href="https://git-scm.com/docs">Reference</a></p><span id="more"></span><img src="/post/e8c9512e/git%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86.jpg" class=""><h2 id="å¸¸ç”¨å‘½ä»¤"><a href="#å¸¸ç”¨å‘½ä»¤" class="headerlink" title="å¸¸ç”¨å‘½ä»¤"></a>å¸¸ç”¨å‘½ä»¤</h2><h3 id="git-add"><a href="#git-add" class="headerlink" title="git add"></a><code>git add</code></h3><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>git add &lt;file&gt;...</code></td><td>è·Ÿè¸ª&#x2F;æš‚å­˜æ–‡ä»¶</td></tr></tbody></table><h3 id="git-branch"><a href="#git-branch" class="headerlink" title="git branch"></a><code>git branch</code></h3><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>git branch dev</code></td><td>åˆ›å»ºåˆ†æ”¯</td></tr><tr><td><code>git checkout dev</code></td><td>åˆ‡æ¢åˆ†æ”¯</td></tr><tr><td><code>git checkout -b dev</code></td><td>åˆ›å»ºå¹¶åˆ‡æ¢åˆ†æ”¯</td></tr><tr><td><code>git checkout -b dev origin/dev</code></td><td>ä»è¿œç¨‹åˆ†æ”¯åˆ›å»ºåˆ†æ”¯</td></tr><tr><td><code>git checkout --track origin/dev</code></td><td>ä»è¿œç¨‹åˆ†æ”¯åˆ›å»ºåˆ†æ”¯</td></tr><tr><td><code>git branch -u origin/dev</code></td><td>è®¾ç½®æœ¬åœ°åˆ†æ”¯è·Ÿè¸ªè¿œç¨‹åˆ†æ”¯</td></tr><tr><td><code>git branch -v</code></td><td>æŸ¥çœ‹æ¯ä¸€ä¸ªåˆ†æ”¯çš„æœ€åä¸€æ¬¡æäº¤</td></tr><tr><td><code>git branch -vv</code></td><td>æŸ¥çœ‹è®¾ç½®çš„æ‰€æœ‰è·Ÿè¸ªåˆ†æ”¯</td></tr><tr><td><code>git branch --merged</code></td><td>æŸ¥çœ‹å·²åˆå¹¶åˆ†æ”¯</td></tr><tr><td><code>git branch --no-merged</code></td><td>æŸ¥çœ‹æœªåˆå¹¶åˆ†æ”¯</td></tr><tr><td><code>git branch -d dev</code></td><td>åˆ é™¤åˆ†æ”¯</td></tr><tr><td><code>git branch -D dev</code></td><td>å¼ºåˆ¶åˆ é™¤åˆ†æ”¯</td></tr><tr><td><code>git push origin --delete dev</code></td><td>åˆ é™¤è¿œç¨‹åˆ†æ”¯</td></tr><tr><td><code>git branch --unset-upstream åˆ†å€¼å</code></td><td>å–æ¶ˆæœ¬åœ°åˆ†æ”¯ä¸è¿œç¨‹åˆ†æ”¯çš„å…³è”</td></tr></tbody></table><h3 id="git-status"><a href="#git-status" class="headerlink" title="git status"></a><code>git status</code></h3><p><code>git status</code>çš„ä½œç”¨æ˜¯æŸ¥çœ‹æ–‡ä»¶çš„çŠ¶æ€ï¼Œä½†è¯¥å‘½ä»¤çš„è¾“å‡ºè¾ƒä¸ºç¹çï¼Œå¯ä»¥åŠ ä¸Š<code>-s</code>é€‰é¡¹ç®€åŒ–è¾“å‡ºã€‚</p><p><code>git status -s</code>çš„è¾“å‡ºä¸­æœ‰ä¸¤æ è¡¨ç¤ºçŠ¶æ€ï¼Œå·¦ä¾§æ˜¯æš‚å­˜åŒºçŠ¶æ€ï¼Œå³ä¾§æ˜¯å·¥ä½œåŒºçŠ¶æ€ï¼š</p><ul><li><code>[?][?]</code>ï¼šæ–°æ–‡ä»¶ï¼Œæœªè·Ÿè¸ª</li><li><code>[A][ ] </code>ï¼šæ–°æ–‡ä»¶ï¼Œå·²è·Ÿè¸ª</li><li><code> [ ][M]</code>ï¼šæ—§æ–‡ä»¶ï¼Œå·²ä¿®æ”¹æœªæš‚å­˜</li><li><code>[M][ ] </code>ï¼šæ—§æ–‡ä»¶ï¼Œå·²ä¿®æ”¹å·²æš‚å­˜</li><li><code>MM</code>ï¼šæ—§æ–‡ä»¶ï¼Œä¿®æ”¹å¹¶æš‚å­˜åå†æ¬¡ä¿®æ”¹</li></ul><p>psï¼šçœŸå®è¾“å‡ºä¸­æ²¡æœ‰<code>[]</code></p><h3 id="git-log"><a href="#git-log" class="headerlink" title="git log"></a><code>git log</code></h3><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>git log -n</code></td><td>æŸ¥çœ‹æœ€è¿‘næ¬¡æäº¤å†å²</td></tr><tr><td><code>git log -p</code></td><td>æŸ¥çœ‹æ¯æ¬¡æäº¤å¼•å…¥çš„å·®å¼‚</td></tr><tr><td><code>git log --stat</code></td><td>æŸ¥çœ‹æäº¤çš„ç®€ç•¥ç»Ÿè®¡ä¿¡æ¯</td></tr><tr><td><code>git log --graph</code></td><td>å›¾å½¢æ˜¾ç¤ºåˆ†æ”¯åˆå¹¶å†å²</td></tr><tr><td><code>git log --since=&quot;2020-10-10&quot; --until=&quot;2024-10-10&quot;</code></td><td>æ˜¾ç¤ºæŒ‡å®šæ—¶é—´èŒƒå›´å†…çš„æäº¤</td></tr><tr><td><code>git log --grep=&#39;commit&#39;</code></td><td>æ ¹æ®å…³é”®å­—æœç´¢æäº¤</td></tr><tr><td><code>git log --name-only</code></td><td>æŸ¥çœ‹å·²ä¿®æ”¹çš„æ–‡ä»¶æ¸…å•</td></tr><tr><td><code>git log --author=&#39;zhang3&#39;</code></td><td>æŸ¥çœ‹æŒ‡å®šç”¨æˆ·çš„æäº¤</td></tr><tr><td><code>git log --pretty=formt:&quot;%h - %an, %cd: %s&quot; --date=short</code></td><td>è‡ªå®šä¹‰è¾“å‡ºæ ¼å¼</td></tr><tr><td><code>git log --oneline --decorate</code></td><td>æŸ¥çœ‹å½“å‰å„åˆ†æ”¯æ‰€æŒ‡çš„æäº¤å¯¹è±¡</td></tr><tr><td><code>git log --oneline --decorate --graph</code></td><td>æŸ¥çœ‹æäº¤å†å²ã€å„ä¸ªåˆ†æ”¯çš„æŒ‡å‘ä»¥åŠåˆ†æ”¯åˆ†å‰æƒ…å†µ</td></tr><tr><td><code>git log master..dev</code></td><td>æŸ¥çœ‹åœ¨devåˆ†æ”¯ä½†ä¸åœ¨masteråˆ†æ”¯çš„æäº¤</td></tr><tr><td><code>git log ^master dev test</code></td><td>æŸ¥çœ‹åœ¨devå’Œteståˆ†æ”¯ä½†ä¸åœ¨masteråˆ†æ”¯çš„æäº¤</td></tr><tr><td><code>git log dev test --not master</code></td><td>æŸ¥çœ‹åœ¨devå’Œteståˆ†æ”¯ä½†ä¸åœ¨masteråˆ†æ”¯çš„æäº¤</td></tr><tr><td><code>git log origin/master..HEAD</code></td><td>æŸ¥çœ‹å³å°†æ¨é€åˆ°è¿œç«¯çš„æäº¤</td></tr><tr><td><code>git log master...dev</code></td><td>æŸ¥çœ‹åªåœ¨å…¶ä¸­ä¸€ä¸ªåˆ†æ”¯ä¸Šçš„æäº¤</td></tr></tbody></table><h3 id="git-show"><a href="#git-show" class="headerlink" title="git show"></a><code>git show</code></h3><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>git show HEAD^</code></td><td>æŸ¥çœ‹<code>HEAD</code>çš„ç¬¬1ä¸ªçˆ¶æäº¤</td></tr><tr><td><code>git show HEAD~</code></td><td>æŸ¥çœ‹<code>HEAD</code>çš„ç¬¬1ä¸ªçˆ¶æäº¤</td></tr><tr><td><code>git show HEAD^2</code></td><td>æŸ¥çœ‹<code>HEAD</code>çš„ç¬¬2ä¸ªçˆ¶æäº¤</td></tr><tr><td><code>git show HEAD~2</code></td><td>æŸ¥çœ‹<code>HEAD</code>çš„ç¬¬1ä¸ªçˆ¶æäº¤çš„çˆ¶æäº¤</td></tr><tr><td><code>git show HEAD^2~</code></td><td>æŸ¥çœ‹<code>HEAD</code>çš„ç¬¬2ä¸ªçˆ¶æäº¤çš„çˆ¶æäº¤</td></tr></tbody></table><h3 id="git-merge"><a href="#git-merge" class="headerlink" title="git merge"></a><code>git merge</code></h3><p><code>fast-forward</code>ï¼šå½“å‰æ‰€åœ¨åˆ†æ”¯æŒ‡å‘çš„æäº¤æ˜¯è¢«åˆå¹¶åˆ†æ”¯æ‰€æŒ‡å‘çš„æäº¤çš„ç›´æ¥ä¸Šæ¸¸ï¼Œåˆå¹¶æ“ä½œåªç®€å•çš„å°†è®©å½“å‰åˆ†æ”¯æŒ‡å‘è¢«åˆå¹¶åˆ†æ”¯æ‰€æŒ‡å‘çš„æäº¤ï¼Œè¿™ç§åˆå¹¶å°±å«åš <code>fast-forward</code></p><h3 id="git-rebase"><a href="#git-rebase" class="headerlink" title="git rebase"></a><code>git rebase</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">git co dev</span><br><span class="line">git rebase master</span><br><span class="line">git co master</span><br><span class="line">git merge dev</span><br><span class="line"></span><br><span class="line">git rebase master devï¼ˆå¦‚æœå½“å‰åˆ†æ”¯ä¸æ˜¯devï¼Œæ­¤å‘½ä»¤ä¼šåˆ‡åˆ°devåˆ†æ”¯ï¼‰</span><br><span class="line">git co master</span><br><span class="line">git merge dev</span><br><span class="line"></span><br><span class="line">git rebase --onto master server clientï¼šé€‰ä¸­åœ¨clientåˆ†æ”¯ä½†ä¸åœ¨serveråˆ†æ”¯çš„ä¿®æ”¹ï¼Œå°†å®ƒä»¬åœ¨masteråˆ†æ”¯é‡æ”¾</span><br></pre></td></tr></table></figure><p>æœ€ä½³å®è·µï¼šåªæŠŠå˜åŸºå‘½ä»¤ç”¨äºæ¨é€å‰æ•´ç†æäº¤å†å²ï¼Œå¹¶ä¸”åªåœ¨ä»æœªæ¨é€è‡³å…¬å…±ä»“çš„æäº¤ä¸Šæ‰§è¡Œå˜åŸºå‘½ä»¤ã€‚</p><h3 id="git-reset"><a href="#git-reset" class="headerlink" title="git reset"></a><code>git reset</code></h3><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>git reset --soft HEAD~</code></td><td>å›é€€åˆ°ä¸Šä¸€ä¸ªæäº¤ï¼Œæš‚å­˜åŒºå’Œå·¥ä½œç›®å½•ä¸å˜</td></tr><tr><td><code>git reset [--mixed] HEAD~</code></td><td>é»˜è®¤æ¨¡å¼ï¼Œå›é€€åˆ°ä¸Šä¸€ä¸ªæäº¤ï¼Œå–æ¶ˆæš‚å­˜ï¼Œä¿ç•™å·¥ä½œç›®å½•çš„ä¿®æ”¹</td></tr><tr><td><code>git reset --hard HEAD~</code></td><td>å›é€€åˆ°ä¸Šä¸€ä¸ªæäº¤ï¼Œæ’¤é”€å·¥ä½œç›®å½•çš„æ‰€æœ‰ä¿®æ”¹</td></tr></tbody></table><p><code>git reset</code> ä¼šåŒæ—¶ç§»åŠ¨ <code>HEAD</code> å’Œåˆ†æ”¯çš„æŒ‡å‘ï¼Œ<code>git checkout</code> åªç§»åŠ¨ <code>HEAD</code></p><h3 id="git-restore"><a href="#git-restore" class="headerlink" title="git restore"></a><code>git restore</code></h3><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>git restore --staged &lt;file&gt;...</code></td><td>å–æ¶ˆæš‚å­˜</td></tr><tr><td><code>git restore &lt;file&gt;...</code></td><td>æ’¤é”€ä¿®æ”¹</td></tr></tbody></table><h3 id="git-diff"><a href="#git-diff" class="headerlink" title="git diff"></a><code>git diff</code></h3><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>git diff &lt;file&gt;...</code></td><td>æŸ¥çœ‹å·²ä¿®æ”¹æœªæš‚å­˜çš„æ”¹åŠ¨</td></tr><tr><td><code>git diff --staged &lt;file&gt;...</code></td><td>æŸ¥çœ‹å·²æš‚å­˜æœªæäº¤çš„æ”¹åŠ¨</td></tr></tbody></table><h3 id="git-remote"><a href="#git-remote" class="headerlink" title="git remote"></a><code>git remote</code></h3><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>git remote -v</code></td><td>æŸ¥çœ‹è¿œç¨‹ä»“åº“</td></tr><tr><td><code>git remote add &lt;remote-name&gt; &lt;url&gt;</code></td><td>å…³è”è¿œç¨‹ä»“åº“</td></tr><tr><td><code>git remote rename &lt;remote-name&gt; &lt;another-name&gt;</code></td><td>é‡å‘½åè¿œç¨‹ä»“åº“å</td></tr><tr><td><code>git remote rm &lt;remote-name&gt;</code></td><td>åˆ é™¤å…³è”</td></tr></tbody></table><h3 id="git-lfs"><a href="#git-lfs" class="headerlink" title="git lfs"></a><code>git lfs</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git lfs install (éœ€ç¡®ä¿æœ¬åœ°git lfså·²å®‰è£…)</span><br><span class="line">git lfs track &#123;file_path&#125;  ï¼ˆç›´æ¥trackç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶ï¼‰</span><br><span class="line">git add .</span><br><span class="line">git commit -m</span><br><span class="line">git push</span><br></pre></td></tr></table></figure><h3 id="git-help"><a href="#git-help" class="headerlink" title="git help"></a><code>git help</code></h3><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>git &lt;verb&gt; --help</code></td><td>æŸ¥çœ‹å¸®åŠ©æ–‡æ¡£</td></tr><tr><td><code>git &lt;verb&gt; -h</code></td><td>æŸ¥çœ‹å¿«é€Ÿå‚è€ƒ</td></tr></tbody></table><h3 id="git-config"><a href="#git-config" class="headerlink" title="git config"></a><code>git config</code></h3><p>æ ¹æ®ä½œç”¨èŒƒå›´ï¼Œgitæœ‰å¦‚ä¸‹ä¸‰ç§é…ç½®æ–‡ä»¶ï¼š</p><table><thead><tr><th>é…ç½®æ–‡ä»¶</th><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>/etc/gitconfig</code></td><td><code>git config --system</code></td><td>åŒ…å«ç³»ç»Ÿä¸Šæ‰€æœ‰ç”¨æˆ·çš„é…ç½®</td></tr><tr><td><code>~/.gitconfig</code></td><td><code>git config --global</code></td><td>åªåŒ…å«å½“å‰ç”¨æˆ·çš„é…ç½®</td></tr><tr><td><code>.git/config</code></td><td><code>git config --local</code></td><td>åªåŒ…å«å½“å‰ä»“åº“çš„é…ç½®</td></tr></tbody></table><p>å’Œé…ç½®æœ‰å…³çš„å¸¸ç”¨å‘½ä»¤ï¼š</p><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>git config user.name</code></td><td>æŸ¥çœ‹å•ä¸ªé…ç½®</td></tr><tr><td><code>git config --list </code></td><td>åˆ—å‡ºæ‰€æœ‰é…ç½®</td></tr><tr><td><code>git config --list --show-origin</code></td><td>åˆ—å‡ºæ‰€æœ‰é…ç½®åŠé…ç½®æ‰€åœ¨çš„æ–‡ä»¶</td></tr><tr><td><code>git config --global use.name &quot;zhang3&quot;</code></td><td>é…ç½®ç”¨æˆ·å</td></tr><tr><td><code>git config --global use.email &quot;xxx@xxx.com&quot;</code></td><td>é…ç½®é‚®ç®±</td></tr><tr><td><code>git config --global alias.co checkout</code></td><td>é…ç½®åˆ«å</td></tr></tbody></table><h2 id="å‡ ä¸ªå‘½ä»¤çš„åŸç†"><a href="#å‡ ä¸ªå‘½ä»¤çš„åŸç†" class="headerlink" title="å‡ ä¸ªå‘½ä»¤çš„åŸç†"></a>å‡ ä¸ªå‘½ä»¤çš„åŸç†</h2><h3 id="git-ç›®å½•"><a href="#git-ç›®å½•" class="headerlink" title=".git ç›®å½•"></a><code>.git</code> ç›®å½•</h3><p>å‡†å¤‡ä¸€ä¸ªç©ºç›®å½• <code>repo</code>ï¼Œ<code>cd</code> åˆ°è¿™ä¸ªç›®å½•æ‰§è¡Œ <code>git init</code> å‘½ä»¤ã€‚å½“åœ¨ä¸€ä¸ªç›®å½•æ‰§è¡Œ <code>git init</code> å‘½ä»¤æ—¶ï¼ŒGit ä¼šåˆ›å»ºä¸€ä¸ª <code>.git</code> ç›®å½•ï¼Œè¿™ä¸ªç›®å½•åŒ…å«äº†å‡ ä¹æ‰€æœ‰ Git å­˜å‚¨å’Œæ“ä½œçš„å¯¹è±¡ã€‚è¯¥ç›®å½•çš„ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">ls</span> -F1 .git <span class="comment"># -F1 æ ‡è¯†æ–‡ä»¶ç±»å‹å¹¶ä¸€è¡Œæ˜¾ç¤ºä¸€ä¸ª</span></span><br><span class="line">HEAD <span class="comment">#å­˜å‚¨ç›®å‰æ£€å‡ºçš„åˆ†æ”¯çš„æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">config</span><br><span class="line">description</span><br><span class="line">hooks/</span><br><span class="line">info/</span><br><span class="line">objects/ <span class="comment">#å­˜å‚¨å¯¹è±¡æ–‡ä»¶ï¼ŒåŒ…æ‹¬blobå¯¹è±¡ã€treeå¯¹è±¡ã€commitå¯¹è±¡</span></span><br><span class="line">refs/ <span class="comment">#refs/headsç›®å½•å­˜å‚¨åˆ†æ”¯æ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹æ˜¯åˆ†æ”¯å½“å‰æŒ‡å‘çš„æäº¤çš„æ ¡éªŒå’Œ</span></span><br></pre></td></tr></table></figure><p>æœ€åˆï¼Œ<code>.git/objects</code> ç›®å½•å’Œ <code>.git/refs/heads</code> ç›®å½•éƒ½æ˜¯ç©ºçš„ï¼Œæ‰§è¡Œå®Œç›¸åº”å‘½ä»¤åæ‰ä¼šåœ¨è¿™ä¸¤ä¸ªç›®å½•ä¸‹ç”Ÿæˆæ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ ll .git/objects</span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x  2 tw  staff    64B 12 29 18:49 info</span><br><span class="line">drwxr-xr-x  2 tw  staff    64B 12 29 18:49 pack</span><br><span class="line"></span><br><span class="line">$ ll .git/refs/heads</span><br><span class="line">total 0</span><br></pre></td></tr></table></figure><p><code>.git/HEAD</code> å­˜å‚¨å½“å‰åˆ†æ”¯çš„æ–‡ä»¶è·¯å¾„</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> .git/HEAD</span><br><span class="line">ref: refs/heads/main</span><br></pre></td></tr></table></figure><p>psï¼šå½“å‰ <code>.git/refs/heads</code> ç›®å½•ä¸‹å¹¶æ²¡æœ‰ <code>main</code> è¿™ä¸ªåˆ†æ”¯æ–‡ä»¶ï¼Œè¿™æ˜¯å› ä¸ºä»“åº“å½“å‰æ²¡æœ‰ä»»ä½•æäº¤ï¼Œåªæœ‰äº§ç”Ÿæäº¤æ‰ä¼šç”Ÿæˆè¿™ä¸ªæ–‡ä»¶ã€‚</p><h3 id="git-add-1"><a href="#git-add-1" class="headerlink" title="git add"></a><code>git add</code></h3><p>åœ¨ <code>repo</code> ç›®å½•ä¸­å‡†å¤‡ä¸‰ä¸ªæ–‡ä»¶ï¼Œ<code>file1</code>ã€<code>file2</code>ã€<code>dir/file3</code>ã€‚</p><p>æŸ¥çœ‹ä»“åº“çš„çŠ¶æ€ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ git status</span><br><span class="line">On branch main</span><br><span class="line"></span><br><span class="line">No commits yet</span><br><span class="line"></span><br><span class="line">Untracked files:</span><br><span class="line">  (use <span class="string">&quot;git add &lt;file&gt;...&quot;</span> to include <span class="keyword">in</span> what will be committed)</span><br><span class="line"><span class="built_in">dir</span>/</span><br><span class="line">file1</span><br><span class="line">file2</span><br><span class="line"></span><br><span class="line">nothing added to commit but untracked files present (use <span class="string">&quot;git add&quot;</span> to track)</span><br></pre></td></tr></table></figure><p>è·Ÿè¸ªæ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git add file1 file2 <span class="built_in">dir</span>/file3 <span class="comment"># ä¹Ÿå¯ä»¥ä½¿ç”¨ git add . è·Ÿè¸ªæ‰€æœ‰æ–‡ä»¶</span></span><br></pre></td></tr></table></figure><p>å½“æ‰§è¡Œ <code>git add</code> å‘½ä»¤æ—¶ï¼ŒGit ä¼šä¸ºæ¯ä¸€ä¸ªæ–‡ä»¶ç”Ÿæˆé•¿åº¦ä¸º40ä½çš„æ ¡éªŒå’Œï¼Œå¹¶ä»¥æ ¡éªŒå’Œçš„å‰2ä½ä¸ºç›®å½•åï¼Œå38ä½ä¸ºæ–‡ä»¶åæ¥å­˜å‚¨æ–‡ä»¶å¿«ç…§ï¼Œæ–‡ä»¶å¿«ç…§ä»¥ <code>blob</code> å¯¹è±¡å­˜å‚¨ï¼Œå­˜å‚¨ä½ç½®å°±æ˜¯ <code>.git/objects</code>ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">ls</span> -F1R .git/objects</span><br><span class="line">25/</span><br><span class="line">7d/</span><br><span class="line">b8/</span><br><span class="line"></span><br><span class="line">.git/objects/25:</span><br><span class="line">a8f74b822fb9b0efd64d7443c1c35f361bb7cc <span class="comment">#blob</span></span><br><span class="line"></span><br><span class="line">.git/objects/7d:</span><br><span class="line">2832ce3bae5b3b3f54731b4886947f977e2ac2 <span class="comment">#blob</span></span><br><span class="line"></span><br><span class="line">.git/objects/b8:</span><br><span class="line">914fa8629794ecb72cfc7fcdadbececeea0b4f <span class="comment">#blob</span></span><br></pre></td></tr></table></figure><img src="/post/e8c9512e/image-20241229115204753.png" class="" title="image-20241229115204753"><h3 id="git-commit"><a href="#git-commit" class="headerlink" title="git commit"></a><code>git commit</code></h3><p>é€šè¿‡ <code>git add</code> å‘½ä»¤è·Ÿè¸ªæ–‡ä»¶åå†æ¬¡æŸ¥çœ‹ä»“åº“çŠ¶æ€ï¼Œæ­¤æ—¶æ–‡ä»¶å·²è¢«æš‚å­˜ï¼Œç­‰å¾…æäº¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ git status</span><br><span class="line">On branch main</span><br><span class="line"></span><br><span class="line">No commits yet</span><br><span class="line"></span><br><span class="line">Changes to be committed:</span><br><span class="line">  (use <span class="string">&quot;git rm --cached &lt;file&gt;...&quot;</span> to unstage)</span><br><span class="line">new file:   <span class="built_in">dir</span>/file3.txt</span><br><span class="line">new file:   file1.txt</span><br><span class="line">new file:   file2.txt</span><br></pre></td></tr></table></figure><p>æäº¤æ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git commit -m <span class="string">&#x27;the initial commit of repo&#x27;</span></span><br></pre></td></tr></table></figure><p>æ‰§è¡Œ <code>git commit</code> å‘½ä»¤ï¼ŒGit ä¼šç”Ÿæˆæ‰§è¡Œå¦‚ä¸‹æ“ä½œï¼š</p><ul><li><p>ä¸ºæ¯ä¸€ä¸ªæœ‰æ–‡ä»¶å˜æ›´çš„ç›®å½•ç”Ÿæˆä¸€ä¸ª <code>tree</code> å¯¹è±¡</p></li><li><p>ç”Ÿæˆä¸€ä¸ª <code>commit</code> å¯¹è±¡ï¼Œä¿å­˜æ ¹ç›®å½• <code>tree</code> å¯¹è±¡çš„æ ¡éªŒå’Œï¼Œå¦‚æœæœ‰çˆ¶æäº¤ï¼Œè¿˜ä¼šä¿å­˜çˆ¶æäº¤å¯¹è±¡çš„æ ¡éªŒå’Œ</p></li><li><p>åœ¨ <code>.git/refs/heads</code> ç›®å½•ä¸­åˆ›å»ºåˆ†æ”¯æ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹å°±æ˜¯å½“å‰åˆ†æ”¯æœ€æ–°æäº¤çš„æ ¡éªŒå’Œ</p></li></ul><p>ä¸ <code>blob</code> å¯¹è±¡ç±»ä¼¼ï¼ŒGit ä¼šä¸ºæ¯ä¸€ä¸ª <code>tree</code> å¯¹è±¡å’Œ <code>commit</code> å¯¹è±¡è®¡ç®—æ ¡éªŒå’Œï¼ŒåŒæ ·ä»¥æ ¡éªŒå’Œçš„å‰2ä½ä¸ºç›®å½•åï¼Œå38ä½ä¸ºæ–‡ä»¶åæ¥å­˜å‚¨è¿™ä¸¤ç§å¯¹è±¡ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">ls</span> -F1R .git/objects</span><br><span class="line">25/</span><br><span class="line">54/</span><br><span class="line">7d/</span><br><span class="line">9f/</span><br><span class="line">b8/</span><br><span class="line"><span class="built_in">fc</span>/</span><br><span class="line"></span><br><span class="line">.git/objects/25:</span><br><span class="line">a8f74b822fb9b0efd64d7443c1c35f361bb7cc <span class="comment">#blob</span></span><br><span class="line"></span><br><span class="line">.git/objects/54:</span><br><span class="line">8f32fb2ee149dee0637bea72ef60963eca6b51 <span class="comment">#commit</span></span><br><span class="line"></span><br><span class="line">.git/objects/7d:</span><br><span class="line">2832ce3bae5b3b3f54731b4886947f977e2ac2 <span class="comment">#blob</span></span><br><span class="line"></span><br><span class="line">.git/objects/9f:</span><br><span class="line">a6bc0f50083bf5f7ec4bc14c4ea6f48cfe35eb <span class="comment">#tree</span></span><br><span class="line"></span><br><span class="line">.git/objects/b8:</span><br><span class="line">914fa8629794ecb72cfc7fcdadbececeea0b4f <span class="comment">#blob</span></span><br><span class="line"></span><br><span class="line">.git/objects/fc:</span><br><span class="line">41d977852fce6e0c8cce1632884b7efaca4a98 <span class="comment">#tree</span></span><br></pre></td></tr></table></figure><img src="/post/e8c9512e/image-20241229120752341.png" class="" title="image-20241229120752341"><p>å› ä¸ºæœ‰äº†æäº¤ï¼Œæ­¤æ—¶ <code>.git/refs/heads</code> ç›®å½•ä¸­å°±ä¼šç”Ÿæˆ <code>main</code> åˆ†æ”¯æ–‡ä»¶ï¼Œæ–‡ä»¶å­˜å‚¨å½“å‰åˆ†æ”¯çš„æœ€æ–°æäº¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ll .git/refs/heads</span><br><span class="line">total 8</span><br><span class="line">-rw-r--r--  1 tw  staff    41B 12 29 19:13 main</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> .git/refs/heads/main</span><br><span class="line">548f32fb2ee149dee0637bea72ef60963eca6b51</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ <code>file1</code> å’Œ <code>dir/file3</code>ï¼Œå¹¶ä½¿ç”¨ <code>git add</code> å‘½ä»¤æš‚å­˜æ–‡ä»¶ï¼ŒGit ä¼šä¸º <code>file1</code> å’Œ <code>dir/file3</code> é‡æ–°è®¡ç®—æ ¡éªŒå’Œï¼Œä¹Ÿå°±æ˜¯è¯´ <code>.git/objects</code> ç›®å½•ä¼šæ–°ç”Ÿæˆä¸¤ä¸ª <code>blob</code> å¯¹è±¡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ ll .git/objects</span><br><span class="line">drwxr-xr-x  3 tw  staff    96B 12 29 11:14 25</span><br><span class="line">drwxr-xr-x  3 tw  staff    96B 12 29 11:25 54</span><br><span class="line">drwxr-xr-x  3 tw  staff    96B 12 29 11:14 7d</span><br><span class="line">drwxr-xr-x  3 tw  staff    96B 12 29 11:25 9f</span><br><span class="line">drwxr-xr-x  3 tw  staff    96B 12 29 11:14 b8</span><br><span class="line">drwxr-xr-x  3 tw  staff    96B 12 29 11:25 <span class="built_in">fc</span></span><br><span class="line"></span><br><span class="line">$ git add file1 <span class="built_in">dir</span>/file3</span><br><span class="line"></span><br><span class="line">$ ll .git/objects</span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x  3 tw  staff    96B 12 29 11:14 25</span><br><span class="line">drwxr-xr-x  3 tw  staff    96B 12 29 11:25 54</span><br><span class="line">drwxr-xr-x  3 tw  staff    96B 12 29 11:14 7d</span><br><span class="line">drwxr-xr-x  3 tw  staff    96B 12 29 11:25 9f</span><br><span class="line">drwxr-xr-x  3 tw  staff    96B 12 29 11:14 b8</span><br><span class="line">drwxr-xr-x  3 tw  staff    96B 12 29 12:22 c0 <span class="comment">#new blob</span></span><br><span class="line">drwxr-xr-x  3 tw  staff    96B 12 29 12:22 c9 <span class="comment">#new blob</span></span><br><span class="line">drwxr-xr-x  3 tw  staff    96B 12 29 11:25 <span class="built_in">fc</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>git commit</code> å‘½ä»¤æäº¤ï¼Œå› ä¸º <code>dir</code> å’Œä»“åº“æ ¹ç›®å½•ä¸‹éƒ½æœ‰æ–‡ä»¶å˜æ›´ï¼Œå› æ­¤ä¼šæ–°ç”Ÿæˆä¸¤ä¸ª <code>tree</code> å¯¹è±¡ï¼Œå…¶ä¸­ä¸€ä¸ª <code>tree</code> å¯¹è±¡çš„æ ¡éªŒå’Œçš„å‰ä¸¤ä½å’Œä¹‹å‰çš„å¯¹è±¡é‡äº†ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ ll .git/objects</span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x  4 tw  staff   128B 12 29 12:26 25 </span><br><span class="line">drwxr-xr-x  3 tw  staff    96B 12 29 12:26 47 <span class="comment">#new tree</span></span><br><span class="line">drwxr-xr-x  3 tw  staff    96B 12 29 11:25 54</span><br><span class="line">drwxr-xr-x  3 tw  staff    96B 12 29 11:14 7d</span><br><span class="line">drwxr-xr-x  3 tw  staff    96B 12 29 12:26 81 <span class="comment">#new commit</span></span><br><span class="line">drwxr-xr-x  3 tw  staff    96B 12 29 11:25 9f</span><br><span class="line">drwxr-xr-x  3 tw  staff    96B 12 29 11:14 b8</span><br><span class="line">drwxr-xr-x  3 tw  staff    96B 12 29 12:22 c0</span><br><span class="line">drwxr-xr-x  3 tw  staff    96B 12 29 12:22 c9</span><br><span class="line">drwxr-xr-x  3 tw  staff    96B 12 29 11:25 <span class="built_in">fc</span></span><br><span class="line"></span><br><span class="line">$ ll .git/objects/25</span><br><span class="line">total 16</span><br><span class="line">-r--r--r--  1 tw  staff    33B 12 29 11:14 a8f74b822fb9b0efd64d7443c1c35f361bb7cc</span><br><span class="line">-r--r--r--  1 tw  staff    50B 12 29 12:26 b034b431c310c762aa9d7272ac847bf8b32dfa <span class="comment">#new tree</span></span><br></pre></td></tr></table></figure><img src="/post/e8c9512e/image-20241229124958332.png" class="" title="image-20241229124958332"><p>psï¼šè¦æŸ¥çœ‹ <code>.git/objects</code> ç›®å½•ä¸‹è¿™äº›æ–‡ä»¶çš„å†…å®¹ï¼Œå¯ä»¥ç”¨ä»¥ä¸‹å‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹å¯¹è±¡ç±»å‹</span></span><br><span class="line">$ git cat-file -t &lt;object-hash&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹å¯¹è±¡å†…å®¹</span></span><br><span class="line">$ git cat-file -p &lt;object-hash&gt;</span><br></pre></td></tr></table></figure><h3 id="git-checkout"><a href="#git-checkout" class="headerlink" title="git checkout"></a><code>git checkout</code></h3><p>Git åˆ†æ”¯ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯æŒ‡å‘æäº¤å¯¹è±¡çš„å¯å˜æŒ‡é’ˆã€‚åœ¨ <code>.git/refs/heads</code> ç›®å½•ä¸‹ï¼Œæ¯ä¸ªåˆ†æ”¯éƒ½æœ‰ä¸€ä¸ªå¯¹åº”æ–‡ä»¶ï¼Œå­˜å‚¨ç€å½“å‰åˆ†æ”¯æ‰€æŒ‡å‘çš„æœ€æ–°æäº¤çš„æ ¡éªŒå’Œã€‚</p><p>åˆ›å»ºåˆ†æ”¯ï¼Œå°±æ˜¯æ–°å»ºä¸€ä¸ªåˆ†æ”¯æ–‡ä»¶ï¼Œå†™å…¥æäº¤å¯¹è±¡çš„æ ¡éªŒå’Œï¼›åˆ é™¤åˆ†æ”¯ï¼Œå°±æ˜¯åˆ é™¤å¯¹åº”çš„åˆ†æ”¯æ–‡ä»¶ã€‚å› æ­¤ Git åˆ†æ”¯çš„åˆ›å»ºå’Œé”€æ¯éƒ½éå¸¸é«˜æ•ˆã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ git branch</span><br><span class="line">* main</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> .git/HEAD</span><br><span class="line">ref: refs/heads/main</span><br><span class="line"></span><br><span class="line">$ ll .git/refs/heads</span><br><span class="line">total 8</span><br><span class="line">-rw-r--r--  1 tw  staff    41B 12 29 12:26 main</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä»¥ä¸Šå‡ ä¸ªå‘½ä»¤å¯ä»¥çœ‹å‡ºï¼Œå½“å‰åªæœ‰ä¸€ä¸ªåˆ†æ”¯ <code>main</code>ï¼Œå¹¶ä¸”å½“å‰æ£€å‡ºåˆ†æ”¯å°±æ˜¯ <code>main</code>ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ git branch dev</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> .git/HEAD</span><br><span class="line">ref: refs/heads/main</span><br><span class="line"></span><br><span class="line">$ ll .git/refs/heads</span><br><span class="line">total 24</span><br><span class="line">-rw-r--r--  1 tw  staff    41B 12 29 20:07 dev</span><br><span class="line">-rw-r--r--  1 tw  staff    41B 12 29 12:26 main</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> .git/refs/heads/dev</span><br><span class="line">81306fe754dae188929a1e98c3a894a5641a3728</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>git branch</code> åˆ›å»ºæ–°çš„åˆ†æ”¯åï¼Œå¯ä»¥çœ‹å‡ºï¼Œå½“å‰æ£€å‡ºåˆ†æ”¯ä¾ç„¶æ˜¯ <code>main</code>ï¼Œä½† <code>.git/refs/heads</code> ç›®å½•ä¸‹å¤šä¸€ä¸ª <code>dev</code> åˆ†æ”¯æ–‡ä»¶ï¼Œåˆ†æ”¯å†…å®¹æ˜¯ <code>main</code> åˆ†æ”¯æœ€æ–°æäº¤çš„æ ¡éªŒå’Œã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ git checkout dev</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> .git/HEAD</span><br><span class="line">ref: refs/heads/dev</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>git checkout</code> å‘½ä»¤æ£€å‡ºåˆ° <code>dev</code> åˆ†æ”¯åï¼Œå¯ä»¥çœ‹åˆ° <code>HEAD</code> æ–‡ä»¶ç°åœ¨ä¿å­˜çš„æ˜¯ <code>dev</code> åˆ†æ”¯çš„æ–‡ä»¶è·¯å¾„ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ git checkout main</span><br><span class="line"></span><br><span class="line">$ git branch -d dev</span><br><span class="line"></span><br><span class="line">$ ll .git/refs/heads</span><br><span class="line">total 8</span><br><span class="line">-rw-r--r--  1 tw  staff    41B 12 29 12:26 main</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>git branch -d</code> åˆ é™¤åˆ†æ”¯åï¼ŒGit ä¼šåˆ é™¤ <code>.git/refs/heads</code> ç›®å½•ä¸‹å¯¹åº”çš„åˆ†æ”¯æ–‡ä»¶ã€‚</p><h3 id="git-merge-1"><a href="#git-merge-1" class="headerlink" title="git merge"></a><code>git merge</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ git checkout -b iss37</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;file2: version 2&quot;</span> &gt; file2</span><br><span class="line"></span><br><span class="line">$ git add file2</span><br><span class="line"></span><br><span class="line">$ git commit -m <span class="string">&#x27;iss37: made a achange to file2&#x27;</span></span><br><span class="line"></span><br><span class="line">$ git checkout main</span><br><span class="line"></span><br><span class="line">$ git checkout -b hotfix</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;file1: version 3&quot;</span> &gt; file1</span><br><span class="line"></span><br><span class="line">$ git add file1</span><br><span class="line"></span><br><span class="line">$ git commit -m <span class="string">&#x27;hotfix: made a change to file1&#x27;</span></span><br><span class="line"></span><br><span class="line">$ git checkout main</span><br><span class="line"></span><br><span class="line">$ git <span class="built_in">log</span> --oneline --decorate --graph --all</span><br><span class="line">* 9ba0744 (hotfix) hotfix: made a change to file1</span><br><span class="line">| * d222cd6 (iss37) iss37: made a achange to file2</span><br><span class="line">|/</span><br><span class="line">* 81306fe (HEAD -&gt; main) made changes to file1 and file3</span><br><span class="line">* 548f32f the initial commit of repo</span><br></pre></td></tr></table></figure><p>ä¾æ¬¡æ‰§è¡Œå¦‚ä¸Šå‘½ä»¤åï¼Œå½“å‰æ£€å‡ºåˆ†æ”¯ï¼Œä»¥åŠå„ä¸ªåˆ†æ”¯çš„æŒ‡å‘å¦‚ä¸‹å¦‚æ‰€ç¤ºï¼š</p><img src="/post/e8c9512e/image-20241229221518223.png" class="" title="image-20241229221518223"><p>å°† <code>hotfix</code> åˆ†æ”¯åˆå…¥ <code>main</code> åˆ†æ”¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ git merge hotfix</span><br><span class="line">Updating 81306fe..9ba0744</span><br><span class="line">Fast-forward</span><br><span class="line"> file1 | 2 +-</span><br><span class="line"> 1 file changed, 1 insertion(+), 1 deletion(-)</span><br><span class="line"> </span><br><span class="line">$ git <span class="built_in">log</span> --oneline --decorate --graph --all</span><br><span class="line">* 9ba0744 (HEAD -&gt; main, hotfix) hotfix: made a change to file1</span><br><span class="line">| * d222cd6 (iss37) iss37: made a achange to file2</span><br><span class="line">|/</span><br><span class="line">* 81306fe made changes to file1 and file3</span><br><span class="line">* 548f32f the initial commit of repo</span><br></pre></td></tr></table></figure><img src="/post/e8c9512e/image-20241229222153973.png" class="" title="image-20241229222153973"><p>æ³¨æ„ä¸Šè¿°çš„ <code>Fast-forward</code> ï¼š <code>main</code> åˆ†æ”¯æŒ‡å‘çš„æäº¤æ˜¯ <code>hotfix</code> åˆ†æ”¯æŒ‡å‘çš„æäº¤çš„ç›´æ¥ä¸Šæ¸¸ï¼Œ<code>git merge</code> åªæ˜¯ç®€å•çš„è®© <code>main</code> åˆ†æ”¯æŒ‡å‘ <code>hotfix</code> åˆ†æ”¯æ‰€æŒ‡å‘çš„æäº¤ï¼Œè¿™ç§åˆå¹¶å°±å«åš <code>fast-forward</code>ã€‚</p><p>ä¸ä¹‹ç›¸å¯¹åº”çš„ï¼Œåˆå¹¶å®Œ <code>hotfix</code> åˆ†æ”¯åï¼Œ<code>main</code> åˆ†æ”¯å½“å‰æŒ‡å‘çš„æäº¤ä¸æ˜¯ <code>iss37</code> æŒ‡å‘çš„æäº¤çš„ç›´æ¥ä¸Šæ¸¸ï¼Œæ­¤æ—¶å¦‚æœè¦åˆå¹¶ <code>iss37</code> åˆ†æ”¯ï¼Œå°±æ— æ³•é€šè¿‡ <code>Fast-forward</code> æ–¹å¼ç®€å•åœ°æ”¹å˜ <code>main</code> åˆ†æ”¯çš„æŒ‡å‘æ¥å®Œæˆäº†ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ git checkout main</span><br><span class="line"></span><br><span class="line">$ git merge iss37</span><br><span class="line">Merge made by the <span class="string">&#x27;ort&#x27;</span> strategy.</span><br><span class="line"> file2 | 2 +-</span><br><span class="line"> 1 file changed, 1 insertion(+), 1 deletion(-)</span><br><span class="line"> </span><br><span class="line">$ git <span class="built_in">log</span> --oneline --decorate --graph --all</span><br><span class="line">*   6d58973 (HEAD -&gt; main) Merge branch <span class="string">&#x27;iss37&#x27;</span></span><br><span class="line">|\</span><br><span class="line">| * d222cd6 (iss37) iss37: made a achange to file2</span><br><span class="line">* | 9ba0744 (hotfix) hotfix: made a change to file1</span><br><span class="line">|/</span><br><span class="line">* 81306fe made changes to file1 and file3</span><br><span class="line">* 548f32f the initial commit of repo</span><br></pre></td></tr></table></figure><img src="/post/e8c9512e/image-20241229224617129.png" class="" title="image-20241229224617129"><p>å¯ä»¥çœ‹åˆ°ï¼Œåˆå¹¶ <code>iss37</code> åˆ†æ”¯ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„æäº¤ï¼Œæ–°çš„æäº¤æœ‰ä¸¤ä¸ªçˆ¶æäº¤ã€‚</p><h3 id="git-rebase-1"><a href="#git-rebase-1" class="headerlink" title="git rebase"></a><code>git rebase</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ git checkout -b feature_a</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;file_a: version 1&quot;</span> &gt; file_a</span><br><span class="line"></span><br><span class="line">$ git add file_a</span><br><span class="line"></span><br><span class="line">$ git cm <span class="string">&#x27;feature_a: add a new file&#x27;</span></span><br><span class="line"></span><br><span class="line">$ git checkout main</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;file2: version 3&quot;</span> &gt; file2</span><br><span class="line"></span><br><span class="line">$ git add file2</span><br><span class="line"></span><br><span class="line">$ git cm <span class="string">&#x27;main: made a change to file2&#x27;</span></span><br><span class="line"></span><br><span class="line">$ git <span class="built_in">log</span> --oneline --decorate --graph --all</span><br><span class="line">* 594eabd (HEAD -&gt; main) main: made a change to file2</span><br><span class="line">| * 05cfcab (feature_a) feature_a: add a new file</span><br><span class="line">|/</span><br><span class="line">*   6d58973 Merge branch <span class="string">&#x27;iss37&#x27;</span></span><br><span class="line">|\</span><br><span class="line">| * d222cd6 (iss37) iss37: made a achange to file2</span><br><span class="line">* | 9ba0744 (hotfix) hotfix: made a change to file1</span><br><span class="line">|/</span><br><span class="line">* 81306fe made changes to file1 and file3</span><br><span class="line">* 548f32f the initial commit of repo</span><br></pre></td></tr></table></figure><img src="/post/e8c9512e/image-20241229225433535.png" class="" title="image-20241229225433535"><p>é€šè¿‡ <code>git rebase</code> åˆå¹¶ <code>feature_a</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ git rebase main feature_a</span><br><span class="line">Successfully rebased and updated refs/heads/feature_a.</span><br><span class="line"></span><br><span class="line">$ git <span class="built_in">log</span> --oneline --decorate --graph --all</span><br><span class="line">* ac7d58d (HEAD -&gt; feature_a) feature_a: add a new file</span><br><span class="line">* 594eabd (main) main: made a change to file2</span><br><span class="line">*   6d58973 Merge branch <span class="string">&#x27;iss37&#x27;</span></span><br><span class="line">|\</span><br><span class="line">| * d222cd6 (iss37) iss37: made a achange to file2</span><br><span class="line">* | 9ba0744 (hotfix) hotfix: made a change to file1</span><br><span class="line">|/</span><br><span class="line">* 81306fe made changes to file1 and file3</span><br><span class="line">* 548f32f the initial commit of repo</span><br></pre></td></tr></table></figure><img src="/post/e8c9512e/image-20241229225758134.png" class="" title="image-20241229225758134"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ git checkout main</span><br><span class="line"></span><br><span class="line">$ git merge feature_a</span><br><span class="line">Updating 594eabd..ac7d58d</span><br><span class="line">Fast-forward</span><br><span class="line"> file_a | 1 +</span><br><span class="line"> 1 file changed, 1 insertion(+)</span><br><span class="line"> create mode 100644 file_a</span><br><span class="line"> </span><br><span class="line">$ git <span class="built_in">log</span> --oneline --decorate --graph --all</span><br><span class="line">* ac7d58d (HEAD -&gt; main, feature_a) feature_a: add a new file</span><br><span class="line">* 594eabd main: made a change to file2</span><br><span class="line">*   6d58973 Merge branch <span class="string">&#x27;iss37&#x27;</span></span><br><span class="line">|\</span><br><span class="line">| * d222cd6 (iss37) iss37: made a achange to file2</span><br><span class="line">* | 9ba0744 (hotfix) hotfix: made a change to file1</span><br><span class="line">|/</span><br><span class="line">* 81306fe made changes to file1 and file3</span><br><span class="line">* 548f32f the initial commit of repo</span><br></pre></td></tr></table></figure><img src="/post/e8c9512e/image-20241229230127060.png" class="" title="image-20241229230127060"><p>ä»ç»“æœä¸Šæ¥çœ‹ï¼Œå°±å¥½å°† <code>feature_a</code> åˆ†æ”¯ä¸Šçš„æäº¤åœ¨ <code>main</code> åˆ†æ”¯ä¸Šé‡æ”¾äº†ä¸€éï¼Œç„¶åé€šè¿‡ <code>Fast-forward</code> æ–¹å¼è¿›è¡Œå¿«é€Ÿåˆå¹¶ã€‚</p><p><strong>æ€»ç»“</strong>ï¼š<code>git rebase</code> æ•´ç†äº†æäº¤å†å²ï¼Œä½¿æäº¤å†å²æ›´åŠ çº¿æ€§ï¼Œä½†æ˜¯ä¸¢å¤±äº†åŸæœ¬çš„æäº¤è®°å½•ã€‚å‡è®¾æŸä¸ªåˆ†æ”¯å·²ç»æ¨é€åˆ°è¿œç¨‹ä»“åº“ï¼Œå¹¶ä¸”æœ‰å…¶ä»–äººå·²ç»æ‹‰å–äº†è¯¥åˆ†æ”¯ï¼Œå¹¶åœ¨è¯¥åˆ†æ”¯ä¸Šæäº¤äº†å˜æ›´ï¼Œå¦‚æœå¯¹è¿™ç§åˆ†æ”¯çš„æäº¤è®°å½•æ‰§è¡Œ <code>git rebase</code>ï¼Œä¼šä½¿ç”¨æƒ…å†µå˜æ›´çš„å¤æ‚ã€‚å› æ­¤æœ€ä½³å®è·µå°±æ˜¯ï¼ŒåªæŠŠ <code>git rebase</code> å‘½ä»¤ç”¨äºæ¨é€å‰æ•´ç†æäº¤å†å²ï¼Œå¹¶ä¸”åªåœ¨ä»æœªæ¨é€è‡³å…¬å…±ä»“çš„æäº¤ä¸Šæ‰§è¡Œå˜åŸºå‘½ä»¤ã€‚</p><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      <categories>
          
          <category> å¼€å‘å·¥å…· </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IDEAå¸¸ç”¨å¿«æ·é”®</title>
      <link href="/post/566321e7.html"/>
      <url>/post/566321e7.html</url>
      
        <content type="html"><![CDATA[<h2 id="é€šç”¨æ“ä½œ"><a href="#é€šç”¨æ“ä½œ" class="headerlink" title="é€šç”¨æ“ä½œ"></a>é€šç”¨æ“ä½œ</h2><table><thead><tr><th>æ“ä½œ</th><th>Windows</th><th>Mac</th></tr></thead><tbody><tr><td>é‡å‘½å</td><td>Shift+F6</td><td>â‡§+Fn+F6</td></tr><tr><td>è·³è½¬åˆ°æŸè¡Œ</td><td>Ctrl+G</td><td>âŒ˜+L</td></tr><tr><td>æ–°å»º</td><td></td><td>âŒ˜+N</td></tr><tr><td>å…¨å±€æœç´¢&#x2F;æ›¿æ¢</td><td>Ctrl+Shift+F&#x2F;R</td><td>â‡§+âŒ˜+F&#x2F;R</td></tr><tr><td>æ ¼å¼åŒ–</td><td>Ctrl+Alt+L</td><td>âŒ˜+âŒ¥+L</td></tr><tr><td>importä¼˜åŒ–</td><td>Ctrl+Alt+O</td><td>âŒƒ+âŒ¥+O</td></tr><tr><td>å¤åˆ¶è¡Œ</td><td>Ctrl+D</td><td>âŒ˜+D</td></tr></tbody></table><span id="more"></span><h2 id="å…‰æ ‡ç§»åŠ¨"><a href="#å…‰æ ‡ç§»åŠ¨" class="headerlink" title="å…‰æ ‡ç§»åŠ¨"></a>å…‰æ ‡ç§»åŠ¨</h2><table><thead><tr><th>æ“ä½œ</th><th>Windows</th><th>Mac</th></tr></thead><tbody><tr><td>ç§»åŠ¨å…‰æ ‡åˆ°ä»£ç å—å¼€å§‹ä½ç½®</td><td>Ctrl+[</td><td>âŒ˜+âŒ¥+[</td></tr><tr><td>ç§»åŠ¨å…‰æ ‡åˆ°ä»£ç å—ç»“æŸä½ç½®</td><td>Ctrl+]</td><td>âŒ˜+âŒ¥+]</td></tr><tr><td>ç§»åŠ¨å…‰æ ‡åˆ°å½“å‰è¡Œçš„å¼€å§‹ä½ç½®</td><td>Home</td><td>âŒ˜+â†</td></tr><tr><td>ç§»åŠ¨å…‰æ ‡åˆ°å½“å‰è¡Œçš„ç»“æŸä½ç½®</td><td>End</td><td>âŒ˜+â†’</td></tr><tr><td>ç§»åŠ¨å…‰æ ‡åˆ°ä¸Šä¸€ä¸ªå•è¯</td><td>Ctrl+â†</td><td>âŒ¥+â†</td></tr><tr><td>ç§»åŠ¨å…‰æ ‡åˆ°ä¸‹ä¸€ä¸ªå•è¯</td><td>Ctrl+â†’</td><td>âŒ¥+â†’</td></tr></tbody></table><h2 id="ä»£ç å—æ“ä½œ"><a href="#ä»£ç å—æ“ä½œ" class="headerlink" title="ä»£ç å—æ“ä½œ"></a>ä»£ç å—æ“ä½œ</h2><table><thead><tr><th>æ“ä½œ</th><th>Windows</th><th>Mac</th></tr></thead><tbody><tr><td>å—æ³¨é‡Š</td><td>Ctrl+Shift+&#x2F;</td><td>âŒ˜+â‡§+&#x2F;</td></tr><tr><td>å±•å¼€&#x2F;æŠ˜å ä»£ç å—</td><td>Ctrl+åŠ å·&#x2F;å‡å·</td><td>âŒ˜+åŠ å·&#x2F;å‡å·</td></tr><tr><td>å±•å¼€&#x2F;æŠ˜å å…¨éƒ¨ä»£ç å—</td><td>Ctrl+Shift+åŠ å·&#x2F;å‡å·</td><td>âŒ˜+â‡§+åŠ å·&#x2F;å‡å·</td></tr></tbody></table><h2 id="ä»£ç ç¼–è¾‘"><a href="#ä»£ç ç¼–è¾‘" class="headerlink" title="ä»£ç ç¼–è¾‘"></a>ä»£ç ç¼–è¾‘</h2><table><thead><tr><th>æ“ä½œ</th><th>Windows</th><th>Mac</th></tr></thead><tbody><tr><td>å­—é¢é‡åˆ‡æ¢å¤§å°å†™</td><td>Ctrl+Shift+U</td><td>âŒ˜+â‡§+U</td></tr><tr><td>åˆ é™¤å…‰æ ‡åé¢çš„å•è¯</td><td>Ctrl+Delete</td><td>âŒ¥+Fn+âŒ«</td></tr><tr><td>åˆ é™¤å…‰æ ‡å‰é¢çš„å•è¯</td><td>Ctrl+BackSpace</td><td>âŒ¥+âŒ¦</td></tr><tr><td>åŒ…å›´ä»£ç </td><td>Ctrl+Alt+T</td><td>âŒ˜+âŒ¥+T</td></tr><tr><td>ç”Ÿæˆä»£ç </td><td>Alt+Insert</td><td>âŒƒ+Enter</td></tr><tr><td>è¦†ç›–æ–¹æ³•</td><td>Ctrl+O</td><td>âŒ˜+O</td></tr><tr><td>å®ç°æ–¹æ³•</td><td>Ctrl+I</td><td>âŒ˜+I</td></tr><tr><td>æ›´æ”¹ç­¾å</td><td>Ctrl+F6</td><td>âŒ˜+Fn+F6</td></tr><tr><td>æå–æ–¹æ³•</td><td>Ctrl+Alt+M</td><td>âŒ˜+âŒ¥+M</td></tr><tr><td>æå–å˜é‡</td><td>Ctrl+Alt+V</td><td>âŒ˜+âŒ¥+V</td></tr><tr><td>æå–å­—æ®µ</td><td>Ctrl+Alt+F</td><td>âŒ˜+âŒ¥+F</td></tr><tr><td>æå–å‚æ•°</td><td>Ctrl+Alt+P</td><td>âŒ˜+âŒ¥+P</td></tr><tr><td>å‘ä¸Šæ’å…¥ä¸€è¡Œ</td><td>Ctrl+Alt+Enter</td><td>âŒ˜+Enter</td></tr><tr><td>å‘ä¸‹æ’å…¥ä¸€è¡Œ</td><td>Shift+Enter</td><td>â‡§+Enter</td></tr></tbody></table><h2 id="ç±»å’Œæ–¹æ³•"><a href="#ç±»å’Œæ–¹æ³•" class="headerlink" title="ç±»å’Œæ–¹æ³•"></a>ç±»å’Œæ–¹æ³•</h2><table><thead><tr><th>æ“ä½œ</th><th>Windows</th><th>Mac</th></tr></thead><tbody><tr><td>å¼¹çª—æ˜¾ç¤ºå½“å‰ç±»ç»“æ„</td><td>Ctrl+F12</td><td>âŒ˜+Fn+F12</td></tr><tr><td>æŸ¥çœ‹ç»§æ‰¿æ ‘ç»“æ„</td><td>Ctrl+H</td><td>âŒƒ+H</td></tr><tr><td>ç±»çš„UMLå…³ç³»å›¾</td><td>Ctrl+Alt+U</td><td>âŒ¥+âŒ˜+U</td></tr><tr><td>å¼¹çª—æ˜¾ç¤ºæˆ–è·³è½¬åˆ°çˆ¶ç±»ï¼ˆæ¥å£ï¼‰</td><td>Ctrl+U</td><td>âŒ˜+U</td></tr><tr><td>å¼¹çª—æ˜¾ç¤ºæˆ–è·³è½¬åˆ°å­ç±»</td><td>Ctrl+Alt+B</td><td>âŒ¥+âŒ˜+B</td></tr><tr><td>è·³è½¬åˆ°é€‰æ‹©ç›®æ ‡çš„å®šä¹‰å¤„æˆ–ä½¿ç”¨å¤„</td><td>Ctrl+B</td><td>âŒ˜+B</td></tr><tr><td>æŸ¥çœ‹æ–¹æ³•è°ƒç”¨é“¾</td><td>Ctrl+Alt+H</td><td>âŒƒ+âŒ˜+H</td></tr><tr><td>å½¢å‚æç¤º</td><td>Ctrl+P</td><td>âŒ˜+P</td></tr><tr><td>æŸ¥çœ‹æ–‡æ¡£</td><td>Ctrl+Q</td><td>âŒƒ+J</td></tr></tbody></table><h2 id="ä»£ç è°ƒè¯•"><a href="#ä»£ç è°ƒè¯•" class="headerlink" title="ä»£ç è°ƒè¯•"></a>ä»£ç è°ƒè¯•</h2><table><thead><tr><th>æ“ä½œ</th><th><strong>Windows</strong></th><th><strong>Mac</strong></th></tr></thead><tbody><tr><td>Runå¯åŠ¨</td><td>Shift+F10</td><td>âŒƒ+R</td></tr><tr><td>Debugå¯åŠ¨</td><td>Shift+F9</td><td>âŒƒ+D</td></tr><tr><td>åœæ­¢</td><td>Ctrl+F2</td><td>âŒ˜+Fn+F2</td></tr><tr><td>ä¸‹ä¸€æ­¥ï¼ˆStep Overï¼‰</td><td>F8</td><td>Fn+F8</td></tr><tr><td>ä¸‹ä¸€æ­¥ï¼ˆStep Inï¼‰</td><td>F7</td><td>Fn+F7</td></tr><tr><td>é€‰æ‹©è¿›å…¥å“ªä¸ªæ–¹æ³•</td><td>Shift+F7</td><td>â‡§+Fn+F7</td></tr><tr><td>è·³å‡ºï¼ˆStep Outï¼‰</td><td>Shift+F8</td><td>â‡§+Fn+F8</td></tr><tr><td>æ¢å¤è¿è¡Œ</td><td>F9</td><td>âŒ¥+âŒ˜+R</td></tr><tr><td>è¿è¡Œåˆ°å…‰æ ‡å¤„</td><td>Alt+F9</td><td>âŒ¥+Fn+F9</td></tr><tr><td>åŠ ä¸Š&#x2F;å–æ¶ˆæ–­ç‚¹</td><td>Ctrl+F8</td><td>âŒ˜+Fn+F8</td></tr><tr><td>æŸ¥çœ‹æ‰€æœ‰æ–­ç‚¹</td><td>Ctrl+Shift+F8</td><td>âŒ˜+â‡§+Fn+F8</td></tr><tr><td>è®¡ç®—è¡¨è¾¾å¼</td><td>Alt+F8</td><td>âŒ¥+Fn+F8</td></tr></tbody></table><h2 id="Gitæ“ä½œ"><a href="#Gitæ“ä½œ" class="headerlink" title="Gitæ“ä½œ"></a>Gitæ“ä½œ</h2><table><thead><tr><th>æ“ä½œ</th><th>Windows</th><th>Mac</th></tr></thead><tbody><tr><td>æäº¤ä»£ç </td><td>Ctrl+K</td><td>âŒ˜+K</td></tr><tr><td>æ¨é€ä»£ç </td><td>Ctrl+Shift+K</td><td>â‡§+âŒ˜+K</td></tr><tr><td>æ‹‰å–ä»£ç </td><td>Ctrl+T</td><td>âŒ˜+T</td></tr><tr><td>å¼¹å‡ºgitæ“ä½œ</td><td>Alt+&#96;</td><td>âŒƒ+V</td></tr></tbody></table><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      <categories>
          
          <category> å¼€å‘å·¥å…· </category>
          
      </categories>
      
      
        <tags>
            
            <tag> IDEA </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MyBatis PlusåŸºç¡€</title>
      <link href="/post/e9be66b7.html"/>
      <url>/post/e9be66b7.html</url>
      
        <content type="html"><![CDATA[<p><a href="https://github.com/baomidou/mybatis-plus">MyBatis-Plus</a> æ˜¯ä¸€ä¸ª <a href="https://www.mybatis.org/mybatis-3/">MyBatis</a> çš„å¢å¼ºå·¥å…·ï¼Œåœ¨ MyBatis çš„åŸºç¡€ä¸Šåªåšå¢å¼ºä¸åšæ”¹å˜ï¼Œä¸ºç®€åŒ–å¼€å‘ã€æé«˜æ•ˆç‡è€Œç”Ÿã€‚</p><p>è¿™ç¯‡ç¬”è®°ä¸»è¦è®°å½•MyBatis-Plusçš„å…¥é—¨ä½¿ç”¨ï¼Œä¸»è¦åŒ…å«å¦‚ä¸‹å†…å®¹ï¼š</p><ul><li>ä½¿ç”¨MyBatis-Pluså®ç°åŸºæœ¬çš„CRUD</li><li>ä½¿ç”¨æ¡ä»¶æ„é€ å™¨æ„å»ºæŸ¥è¯¢å’Œæ›´æ–°è¯­å¥</li><li>ä½¿ç”¨MyBatis-Plusçš„åŸºæœ¬æ³¨è§£</li><li>ä½¿ç”¨MyBatis-Plusçš„æ‰©å±•åŠŸèƒ½</li></ul><h2 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h2><p>åˆ›å»ºè¡¨å¹¶æ’å…¥ä¸€äº›æ•°æ®</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DATABASE IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `mp`;</span><br><span class="line">USE `mp`;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `<span class="keyword">user</span>` (</span><br><span class="line">`id` <span class="type">BIGINT</span>(<span class="number">19</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;ç”¨æˆ·id&#x27;</span>,</span><br><span class="line">`username` <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;ç”¨æˆ·å&#x27;</span> <span class="keyword">COLLATE</span> <span class="string">&#x27;utf8_general_ci&#x27;</span>,</span><br><span class="line">`password` <span class="type">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;å¯†ç &#x27;</span> <span class="keyword">COLLATE</span> <span class="string">&#x27;utf8_general_ci&#x27;</span>,</span><br><span class="line">`phone` <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;æ³¨å†Œæ‰‹æœºå·&#x27;</span> <span class="keyword">COLLATE</span> <span class="string">&#x27;utf8_general_ci&#x27;</span>,</span><br><span class="line">`info` JSON <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;è¯¦ç»†ä¿¡æ¯&#x27;</span>,</span><br><span class="line">`status` <span class="type">INT</span>(<span class="number">10</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;1&#x27;</span> COMMENT <span class="string">&#x27;ä½¿ç”¨çŠ¶æ€ï¼ˆ1æ­£å¸¸ 2å†»ç»“ï¼‰&#x27;</span>,</span><br><span class="line">`balance` <span class="type">INT</span>(<span class="number">10</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;è´¦æˆ·ä½™é¢&#x27;</span>,</span><br><span class="line">`create_time` DATETIME <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;åˆ›å»ºæ—¶é—´&#x27;</span>,</span><br><span class="line">`update_time` DATETIME <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;æ›´æ–°æ—¶é—´&#x27;</span>,</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY (`id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line"><span class="keyword">UNIQUE</span> INDEX `username` (`username`) <span class="keyword">USING</span> BTREE</span><br><span class="line">)</span><br><span class="line">COMMENT<span class="operator">=</span><span class="string">&#x27;ç”¨æˆ·è¡¨&#x27;</span></span><br><span class="line"><span class="keyword">COLLATE</span><span class="operator">=</span><span class="string">&#x27;utf8_general_ci&#x27;</span></span><br><span class="line">ENGINE<span class="operator">=</span>InnoDB</span><br><span class="line">ROW_FORMAT<span class="operator">=</span>COMPACT</span><br><span class="line">AUTO_INCREMENT<span class="operator">=</span><span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `<span class="keyword">user</span>` (`id`, `username`, `password`, `phone`, `info`, `status`, `balance`, `create_time`, `update_time`) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="number">1</span>, <span class="string">&#x27;Jack&#x27;</span>, <span class="string">&#x27;123&#x27;</span>, <span class="string">&#x27;13900112224&#x27;</span>, <span class="string">&#x27;&#123;&quot;age&quot;: 20, &quot;gender&quot;: &quot;male&quot;&#125;&#x27;</span>, <span class="number">1</span>, <span class="number">1600</span>, <span class="string">&#x27;2023-05-19 20:50:21&#x27;</span>, <span class="string">&#x27;2023-06-19 20:50:21&#x27;</span>),</span><br><span class="line">(<span class="number">2</span>, <span class="string">&#x27;Rose&#x27;</span>, <span class="string">&#x27;123&#x27;</span>, <span class="string">&#x27;13900112223&#x27;</span>, <span class="string">&#x27;&#123;&quot;age&quot;: 19, &quot;gender&quot;: &quot;female&quot;&#125;&#x27;</span>, <span class="number">1</span>, <span class="number">600</span>, <span class="string">&#x27;2023-05-19 21:00:23&#x27;</span>, <span class="string">&#x27;2023-06-19 21:00:23&#x27;</span>),</span><br><span class="line">(<span class="number">3</span>, <span class="string">&#x27;Hope&#x27;</span>, <span class="string">&#x27;123&#x27;</span>, <span class="string">&#x27;13900112222&#x27;</span>, <span class="string">&#x27;&#123;&quot;age&quot;: 25, &quot;gender&quot;: &quot;male&quot;&#125;&#x27;</span>, <span class="number">1</span>, <span class="number">100000</span>, <span class="string">&#x27;2023-06-19 22:37:44&#x27;</span>, <span class="string">&#x27;2023-06-19 22:37:44&#x27;</span>),</span><br><span class="line">(<span class="number">4</span>, <span class="string">&#x27;Thomas&#x27;</span>, <span class="string">&#x27;123&#x27;</span>, <span class="string">&#x27;17701265258&#x27;</span>, <span class="string">&#x27;&#123;&quot;age&quot;: 29, &quot;gender&quot;: &quot;male&quot;&#125;&#x27;</span>, <span class="number">1</span>, <span class="number">800</span>, <span class="string">&#x27;2023-06-19 23:44:45&#x27;</span>, <span class="string">&#x27;2023-06-19 23:44:45&#x27;</span>);</span><br></pre></td></tr></table></figure><p>åˆ›å»ºå·¥ç¨‹ã€æ–°å»º<code>User</code>ã€<code>UserMapper</code></p><img src="/post/e9be66b7/image-20241102093153288.png" class="" title="image-20241102093153288"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String phone;</span><br><span class="line">    <span class="keyword">private</span> String info;</span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line">    <span class="keyword">private</span> Integer balance;</span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createTime;</span><br><span class="line">    <span class="keyword">private</span> LocalDateTime updateTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;User&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¼•å…¥ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mybatis-plus.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åŸºæœ¬é…ç½®</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/mp?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">xxx</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com.itheima:</span> <span class="string">debug</span></span><br><span class="line">  <span class="attr">pattern:</span></span><br><span class="line">    <span class="attr">dateformat:</span> <span class="string">HH:mm:ss</span></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">log-impl:</span> <span class="string">org.apache.ibatis.logging.stdout.StdOutImpl</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath*:/mapper/**/*.xml</span></span><br></pre></td></tr></table></figure><h2 id="åŸºæœ¬åŠŸèƒ½"><a href="#åŸºæœ¬åŠŸèƒ½" class="headerlink" title="åŸºæœ¬åŠŸèƒ½"></a>åŸºæœ¬åŠŸèƒ½</h2><h3 id="å•è¡¨CRUD"><a href="#å•è¡¨CRUD" class="headerlink" title="å•è¡¨CRUD"></a>å•è¡¨CRUD</h3><p>MyBatis Plusæä¾›äº†ä¸€ä¸ªåŸºç¡€çš„<code>BaseMapper</code>æ¥å£ï¼Œå®ç°äº†å•è¡¨çš„CRUDï¼Œè‡ªå®šä¹‰Mapperåªè¦ç»§æ‰¿äº†<code>BaseMapper</code>ï¼Œå°±æ— éœ€å®ç°å•è¡¨çš„CRUDäº†ã€‚</p><img src="/post/e9be66b7/image-20241102144540554.png" class="" title="image-20241102144540554"><p>åˆ›å»ºä¸€ä¸ªæµ‹è¯•ç±»ï¼Œæµ‹è¯•åŸºæœ¬çš„CRUDåŠŸèƒ½</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserMapperTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testInsert</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user.setId(<span class="number">5L</span>);</span><br><span class="line">        user.setUsername(<span class="string">&quot;Lucy&quot;</span>);</span><br><span class="line">        user.setPassword(<span class="string">&quot;123&quot;</span>);</span><br><span class="line">        user.setPhone(<span class="string">&quot;18688990011&quot;</span>);</span><br><span class="line">        user.setBalance(<span class="number">200</span>);</span><br><span class="line">        user.setInfo(<span class="string">&quot;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;è‹±æ–‡è€å¸ˆ\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&quot;</span>);</span><br><span class="line">        user.setCreateTime(LocalDateTime.now());</span><br><span class="line">        user.setUpdateTime(LocalDateTime.now());</span><br><span class="line">        userMapper.insert(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testSelectById</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.selectById(<span class="number">5L</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;user = &quot;</span> + user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testQueryByIds</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;User&gt; users = userMapper.selectBatchIds(Arrays.asList(<span class="number">1L</span>, <span class="number">2L</span>, <span class="number">3L</span>));</span><br><span class="line">        users.forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testUpdateById</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user.setId(<span class="number">5L</span>);</span><br><span class="line">        user.setBalance(<span class="number">20000</span>);</span><br><span class="line">        userMapper.updateById(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testDeleteUser</span><span class="params">()</span> &#123;</span><br><span class="line">        userMapper.deleteById(<span class="number">5L</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¸¸ç”¨æ³¨è§£"><a href="#å¸¸ç”¨æ³¨è§£" class="headerlink" title="å¸¸ç”¨æ³¨è§£"></a>å¸¸ç”¨æ³¨è§£</h3><p>MyBatis Plusé€šè¿‡æ‰«æå®ä½“ç±»ï¼ŒåŸºäºåå°„å°†å®ä½“ç±»æ˜ å°„åˆ°æ•°æ®åº“ä¸­çš„è¡¨ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ä½“ç±»çš„ç±»åå’Œå­—æ®µåä¸è¡¨ä¸­çš„åˆ—ååº”è¯¥ä¸€ä¸€å¯¹åº”ï¼Œå¦‚æœå‡ºç°ä¸ä¸€è‡´ï¼Œå°±éœ€è¦é€šè¿‡æ³¨è§£è¿›è¡ŒæŒ‡å®šã€‚</p><p>å¸¸ç”¨æ³¨è§£</p><ul><li><code>@TableName</code>ï¼šæŒ‡å®šè¡¨å</li><li><code>@TableId</code>ï¼šæŒ‡å®šä¸»é”®</li><li><code>@TableFiled</code>ï¼šæŒ‡å®šæ™®é€šå­—æ®µ</li></ul><p>å…¶ä¸­ <code>@TableField</code> çš„å¸¸è§ä½¿ç”¨åœºæ™¯å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@TableName(&quot;tb_user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœidæ˜¯è‡ªå¢é•¿ç±»å‹ï¼Œéœ€æ˜ç¡®æŒ‡å®šIdTypeä¸ºAUTO</span></span><br><span class="line">    <span class="meta">@TableId(type = IdType.AUTO)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="comment">// æˆå‘˜å˜é‡åä¸è¡¨å­—æ®µåä¸ä¸€è‡´</span></span><br><span class="line">    <span class="meta">@TableFiled(&quot;username&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">// ä»¥iså¼€å¤´çš„å¸ƒå°”ç±»å‹æˆå‘˜å˜é‡ï¼Œåºåˆ—åŒ–æ—¶ä¼šå°†iså»é™¤ï¼Œå¯¼è‡´æ— æ³•ä¸è¡¨ä¸­is_marriedåŒ¹é…ï¼Œéœ€æ‰‹åŠ¨æŒ‡å®š</span></span><br><span class="line">    <span class="meta">@TableField(&quot;is_married&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Boolean isMarried;</span><br><span class="line">    <span class="comment">// è¡¨å­—æ®µæ˜¯æ•°æ®åº“å…³é”®å­—</span></span><br><span class="line">    <span class="meta">@TableField(&quot;`order`&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer order;</span><br><span class="line">    <span class="comment">// æˆå‘˜å˜é‡ä¸æ˜¯æ•°æ®åº“å­—æ®µ</span></span><br><span class="line">    <span class="meta">@TableField(exist = false)</span></span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ¡ä»¶æ„é€ å™¨"><a href="#æ¡ä»¶æ„é€ å™¨" class="headerlink" title="æ¡ä»¶æ„é€ å™¨"></a>æ¡ä»¶æ„é€ å™¨</h2><p>MyBatis-Plusé™¤äº†æ”¯æŒä»¥<code>id</code>ä½œä¸ºåŸºæœ¬çš„æŸ¥è¯¢æ¡ä»¶ä¹‹å¤–ï¼Œè¿˜æ”¯æŒé€šè¿‡<code>Wrapper</code>æ„é€ å¤æ‚çš„æŸ¥è¯¢æ¡ä»¶ã€‚<code>Wrapper</code>çš„ç»§æ‰¿å…³ç³»å›¾å¦‚ä¸‹ï¼š</p><img src="/post/e9be66b7/image-20241102143801416.png" class="" title="image-20241102143801416"><p>å…¶ä¸­å­ç±»<code>AbstractWrapper</code>æä¾›äº†<code>where</code>å­å¥ä¸­ä¼šç”¨åˆ°çš„æ‰€æœ‰æ¡ä»¶æ„é€ æ–¹æ³•ï¼š</p><img src="/post/e9be66b7/image-20241102144423632.png" class="" title="image-20241102144423632"><h3 id="QueryWrapper"><a href="#QueryWrapper" class="headerlink" title="QueryWrapper"></a><code>QueryWrapper</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testQueryWrapper</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> QueryWrapper&lt;User&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;User&gt;()</span><br><span class="line">        .select(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;username&quot;</span>, <span class="string">&quot;balance&quot;</span>) <span class="comment">// ç¡¬ç¼–ç </span></span><br><span class="line">        .like(<span class="string">&quot;username&quot;</span>, <span class="string">&quot;ho&quot;</span>)</span><br><span class="line">        .ge(<span class="string">&quot;balance&quot;</span>, <span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">final</span> List&lt;User&gt; users = userMapper.selectList(queryWrapper);</span><br><span class="line">    users.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="UpdateWrapper"><a href="#UpdateWrapper" class="headerlink" title="UpdateWrapper"></a><code>UpdateWrapper</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testUpdateWrapper</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> UpdateWrapper&lt;User&gt; updateWrapper = <span class="keyword">new</span> <span class="title class_">UpdateWrapper</span>&lt;User&gt;()</span><br><span class="line">        .setSql(<span class="string">&quot;balance = balance + 1000&quot;</span>) </span><br><span class="line">        .in(<span class="string">&quot;id&quot;</span>, <span class="number">1L</span>, <span class="number">2L</span>); <span class="comment">// ç¡¬ç¼–ç </span></span><br><span class="line">    userMapper.update(updateWrapper);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="LambdaQueryWrapper"><a href="#LambdaQueryWrapper" class="headerlink" title="LambdaQueryWrapper"></a><code>LambdaQueryWrapper</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testLambdaQueryWrapper</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> LambdaQueryWrapper&lt;User&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;User&gt;()</span><br><span class="line">        .select(User::getId, User::getUsername, User::getBalance)</span><br><span class="line">        .like(User::getUsername, <span class="string">&quot;ho&quot;</span>)</span><br><span class="line">        .ge(User::getBalance, <span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">final</span> List&lt;User&gt; users = userMapper.selectList(queryWrapper);</span><br><span class="line">    users.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="LambdaUpdateWrapper"><a href="#LambdaUpdateWrapper" class="headerlink" title="LambdaUpdateWrapper"></a><code>LambdaUpdateWrapper</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testLambdaUpdateWrapper</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> LambdaUpdateWrapper&lt;User&gt; updateWrapper = <span class="keyword">new</span> <span class="title class_">LambdaUpdateWrapper</span>&lt;User&gt;()</span><br><span class="line">        .setSql(<span class="string">&quot;balance = balance - 500&quot;</span>)</span><br><span class="line">        .in(User::getId, <span class="number">1L</span>, <span class="number">2L</span>);</span><br><span class="line">    userMapper.update(updateWrapper);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="IServiceæ¥å£"><a href="#IServiceæ¥å£" class="headerlink" title="IServiceæ¥å£"></a>IServiceæ¥å£</h2><p><code>BaseMapper</code>æ¥å£æä¾›äº†åŸºæœ¬çš„å¢åˆ æ”¹æŸ¥æ¥å£ï¼Œä½†æ˜¯è¿™äº›æ¥å£åªèƒ½æ“ä½œå•ä¸ªå¯¹è±¡ã€‚å› æ­¤MyBatis-Pluså¦å¤–æä¾›äº†ä¸€ä¸ª<code>IService</code>æ¥å£ï¼Œæ¥å£åŒ…å«äº†ä¸€å †æ‰¹å¤„ç†æ¥å£ï¼Œå®ç°ç±»<code>ServiceImpl</code>æä¾›äº†åŸºæœ¬çš„å®ç°ã€‚</p><img src="/post/e9be66b7/image-20241102164213193.png" class="" title="image-20241102164213193"><h3 id="åŸºæœ¬ä½¿ç”¨"><a href="#åŸºæœ¬ä½¿ç”¨" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h3><p>å¯¼å…¥ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.xiaoymin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>knife4j-openapi2-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>swaggeré…ç½®</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">knife4j:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">openapi:</span></span><br><span class="line">    <span class="attr">title:</span> <span class="string">æ¥å£æ–‡æ¡£</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">&quot;æ¥å£æ–‡æ¡£&quot;</span></span><br><span class="line">    <span class="attr">group:</span></span><br><span class="line">      <span class="attr">default:</span></span><br><span class="line">        <span class="attr">group-name:</span> <span class="string">default</span></span><br><span class="line">        <span class="attr">api-rule:</span> <span class="string">package</span></span><br><span class="line">        <span class="attr">api-rule-resources:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">com.tw.mbp.controller</span></span><br></pre></td></tr></table></figure><p>mapper</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;User&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">updateBalanceByIds</span><span class="params">(<span class="meta">@Param(Constants.WRAPPER)</span> LambdaQueryWrapper&lt;User&gt; queryWrapper, <span class="meta">@Param(&quot;amount&quot;)</span> <span class="type">int</span> amount)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Update(&quot;update user set balance = balance - #&#123;amount&#125; where id = #&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">deductBalance</span><span class="params">(<span class="meta">@Param(&quot;id&quot;)</span> Long id, <span class="meta">@Param(&quot;amount&quot;)</span> Integer amount)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>service</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;UserMapper, User&gt; <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">   </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deductBalance</span><span class="params">(Long id, Integer amount)</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * ç®€å•CURDç›´æ¥ä½¿ç”¨IServiceä¸­å®šä¹‰å¥½çš„æ–¹æ³•ï¼Œå¦‚getById()æ–¹æ³•</span></span><br><span class="line"><span class="comment">         * ä¸šåŠ¡å¤„ç†åœ¨è‡ªå®šä¹‰serviceä¸­å®ç°ï¼Œå¦‚ç”¨æˆ·çŠ¶æ€æ ¡éªŒã€ä½™é¢æ ¡éªŒ</span></span><br><span class="line"><span class="comment">         * éœ€è¦ç¼–å†™é¢å¤–SQLåœ¨è‡ªå®šä¹‰Mapperä¸­å®ç°ï¼Œå¦‚deductBalance()æ–¹æ³•</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">// æŸ¥è¯¢ç”¨æˆ·</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> getById(id);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç”¨æˆ·çŠ¶æ€æ ¡éªŒ</span></span><br><span class="line">        <span class="keyword">if</span> (user == <span class="literal">null</span> || user.getStatus() == <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;ç”¨æˆ·ä¸å­˜åœ¨æˆ–å·²è¢«å†»ç»“&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä½™é¢æ ¡éªŒ</span></span><br><span class="line">        <span class="keyword">if</span> (user.getBalance() &lt; amount) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;ç”¨æˆ·ä½™é¢ä¸è¶³&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ›´æ–°ä½™é¢</span></span><br><span class="line">        <span class="built_in">this</span>.baseMapper.deductBalance(id, amount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>controller</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Api(tags = &quot;ç”¨æˆ·ç®¡ç†æ¥å£&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Springæ¨èä½¿ç”¨æ„é€ å‡½æ•°æ³¨å…¥ï¼Œå› æ­¤è¿™é‡Œä¸ä½¿ç”¨@Autowiredæ³¨è§£ï¼›</span></span><br><span class="line">    <span class="comment">// ä½†æ˜¯å¦‚æœç±»çš„å­—æ®µè¿‡å¤šï¼Œæ„é€ å‡½æ•°ä¼šæ˜¾å¾—è‡ƒè‚¿ï¼Œå¯ä»¥ç”¨finalä¿®é¥°ç¬¦åŠ @RequiredArgsConstructoræ³¨è§£å®ç°å­—æ®µæ³¨å…¥</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;æ‰£å‡ä½™é¢&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/&#123;id&#125;/deduct/&#123;amount&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deductBalance</span><span class="params">(<span class="meta">@PathVariable</span> Long id, <span class="meta">@PathVariable</span> Integer amount)</span> &#123;</span><br><span class="line">        userService.deductBalance(id, amount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="lambdaæ–¹æ³•"><a href="#lambdaæ–¹æ³•" class="headerlink" title="lambdaæ–¹æ³•"></a>lambdaæ–¹æ³•</h3><p><code>lambdaQuery()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;User&gt; <span class="title function_">queryUsers</span><span class="params">(UserQuery query)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> lambdaQuery()</span><br><span class="line">        .like(StrUtil.isNotBlank(query.getName()), User::getUsername, query.getName())</span><br><span class="line">        .eq(query.getStatus() != <span class="literal">null</span>, User::getStatus, query.getStatus())</span><br><span class="line">        .ge(query.getMinBalance() != <span class="literal">null</span>, User::getBalance, query.getMinBalance())</span><br><span class="line">        .le(query.getMaxBalance() != <span class="literal">null</span>, User::getBalance, query.getMaxBalance())</span><br><span class="line">        .list();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>lambdaUpdate</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deductBalance</span><span class="params">(Long id, Integer amount)</span> &#123;</span><br><span class="line">    <span class="comment">// æŸ¥è¯¢ç”¨æˆ·</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> getById(id);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¡éªŒç”¨æˆ·çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span> || user.getStatus() == <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;ç”¨æˆ·ä¸å­˜åœ¨æˆ–å·²è¢«å†»ç»“&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¡éªŒä½™é¢</span></span><br><span class="line">    <span class="keyword">if</span> (user.getBalance() &lt; amount) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;ç”¨æˆ·ä½™é¢ä¸è¶³&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ›´æ–°ä½™é¢</span></span><br><span class="line">    <span class="comment">// this.baseMapper.deductBalance(id, amount);</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">newBalance</span> <span class="operator">=</span> user.getBalance() - amount;</span><br><span class="line">    lambdaUpdate()</span><br><span class="line">        .set(User::getBalance, newBalance)</span><br><span class="line">        .set(newBalance &lt;= <span class="number">0</span>, User::getStatus, <span class="number">2</span>)</span><br><span class="line">        .eq(User::getId, id)</span><br><span class="line">        .update();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ‰¹å¤„ç†"><a href="#æ‰¹å¤„ç†" class="headerlink" title="æ‰¹å¤„ç†"></a>æ‰¹å¤„ç†</h3><p>å½“è¦æ’å…¥å¤šæ¡æ•°æ®æ—¶ï¼Œå¦‚æœé€æ¡æ’å…¥ï¼ˆè°ƒç”¨<code>save()</code>æ–¹æ³•ï¼‰ï¼Œæ•ˆç‡è¾ƒä½ï¼Œå› ä¸ºæ¯æ¬¡æ’å…¥éƒ½ä¼šè¯·æ±‚ç½‘ç»œï¼Œæ•°æ®åº“å±‚é¢çš„sqlä¹Ÿæ˜¯é€æ¡æ‰§è¡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testSaveOneByOne</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">5_0000</span>; i++) &#123;</span><br><span class="line">        userService.save(buildUser(i));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">endTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    System.out.println(<span class="string">&quot;è€—è´¹æ—¶é—´&quot;</span> + (endTime - startTime));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/post/e9be66b7/image-20241102213505591.png" class="" title="image-20241102213505591"><p>ä¸ºäº†æé«˜æ•ˆç‡ï¼Œå¯ä»¥æ”¹ç”¨æ‰¹é‡æ’å…¥ï¼ˆè°ƒç”¨<code>saveBatch()</code>æ–¹æ³•ï¼‰ï¼Œ<code>saveBatch()</code>åŸºäºé¢„ç¼–è¯‘å¤„ç†ï¼Œåªéœ€å‘èµ·å°‘é‡ç½‘ç»œè¯·æ±‚ï¼Œä½†æ•°æ®åº“å±‚é¢çš„sqlä¾ç„¶æ˜¯é€æ¡æ‰§è¡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testSaveBatch</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    List&lt;User&gt; users = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">5_0000</span>; i++) &#123;</span><br><span class="line">        users.add(buildUser(i));</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">1000</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            userService.saveBatch(users);</span><br><span class="line">            users.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">endTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    System.out.println(<span class="string">&quot;è€—è´¹æ—¶é—´&quot;</span> + (endTime - startTime));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/post/e9be66b7/image-20241102213654618.png" class="" title="image-20241102213654618"><p>ä¸ºäº†æ˜¯æ‰¹é‡æ’å…¥çš„æ•ˆç‡æœ€å¤§åŒ–ï¼Œéœ€å¼€å¯<code>rewriteBatchedStatements=true</code>ï¼Œå¼€å¯åæ•°æ®åº“ä¼šé‡å†™sqlï¼Œå¤šæ¡æ’å…¥è¯­å¥ä¼šåˆå¹¶æˆä¸€æ¡æ¥æ‰§è¡Œ</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/mp?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai&amp;rewriteBatchedStatements=true</span></span><br></pre></td></tr></table></figure><img src="/post/e9be66b7/image-20241102213940690.png" class="" title="image-20241102213940690"><h2 id="é«˜çº§åŠŸèƒ½"><a href="#é«˜çº§åŠŸèƒ½" class="headerlink" title="é«˜çº§åŠŸèƒ½"></a>é«˜çº§åŠŸèƒ½</h2><h3 id="é€»è¾‘åˆ é™¤"><a href="#é€»è¾‘åˆ é™¤" class="headerlink" title="é€»è¾‘åˆ é™¤"></a>é€»è¾‘åˆ é™¤</h3><p>æ·»åŠ é…ç½®</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">db-config:</span></span><br><span class="line">      <span class="attr">logic-delete-field:</span> <span class="string">deleted</span></span><br><span class="line">      <span class="attr">logic-delete-value:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">logic-not-delete-value:</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><p>æµ‹è¯•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testLogicDelete</span><span class="params">()</span> &#123;</span><br><span class="line">    userService.removeById(<span class="number">1L</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœ</p><img src="/post/e9be66b7/image-20241102231813017.png" class="" title="image-20241102231813017"><p>å¼€å¯é€»è¾‘åˆ é™¤åŠŸèƒ½åï¼ŒæŸ¥è¯¢æ“ä½œçš„è¿‡æ»¤æ¡ä»¶é»˜è®¤éƒ½ä¼šå¸¦ä¸Š <code>deleted = 0</code> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testQueryWithLogicDelete</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.getById(<span class="number">1L</span>);</span><br><span class="line">    System.out.println(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/post/e9be66b7/image-20241102232415756.png" class="" title="image-20241102232415756"><p>PSï¼šé€»è¾‘åˆ é™¤ä¼šå¯¼è‡´è¡¨ä¸­æ•°æ®è¶Šæ¥è¶Šå¤šï¼Œéšç€æ•°æ®çš„å †ç§¯ä¼šå½±å“æŸ¥è¯¢æ•ˆç‡ã€‚</p><h3 id="æšä¸¾æ˜ å°„"><a href="#æšä¸¾æ˜ å°„" class="headerlink" title="æšä¸¾æ˜ å°„"></a>æšä¸¾æ˜ å°„</h3><p>æšä¸¾</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">UserStatus</span> &#123;</span><br><span class="line"></span><br><span class="line">    NORMAL(<span class="number">1</span>, <span class="string">&quot;æ­£å¸¸&quot;</span>),</span><br><span class="line">    FREEZE(<span class="number">2</span>, <span class="string">&quot;å†»ç»“&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@EnumValue</span> <span class="comment">// æŒ‡å®šä¸è¡¨ä¸­å­—æ®µæ˜ å°„çš„æšä¸¾å­—æ®µ</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> value;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonValue</span> <span class="comment">// æŒ‡å®šåºåˆ—åŒ–è¿”å›ç»™å‰ç«¯çš„æšä¸¾å­—æ®µ</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String desc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é…ç½®</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">default-enum-type-handler:</span> <span class="string">com.baomidou.mybatisplus.core.handlers.MybatisEnumTypeHandler</span></span><br></pre></td></tr></table></figure><h3 id="JSONæ˜ å°„"><a href="#JSONæ˜ å°„" class="headerlink" title="JSONæ˜ å°„"></a>JSONæ˜ å°„</h3><p>å°†è¡¨ä¸­<code>json</code>ç±»å‹å­—æ®µè½¬æ¢æˆå®ä½“ç±»ä¸­å¯¹è±¡æˆå‘˜å˜é‡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@TableName(value = &quot;user&quot;, autoResultMap = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¯¦ç»†ä¿¡æ¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@TableField(typeHandler = JacksonTypeHandler.class)</span></span><br><span class="line">    <span class="keyword">private</span> ExtraInfo info;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor(staticName = &quot;of&quot;)</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExtraInfo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> String gender;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è‡ªåŠ¨å¡«å……å­—æ®µ"><a href="#è‡ªåŠ¨å¡«å……å­—æ®µ" class="headerlink" title="è‡ªåŠ¨å¡«å……å­—æ®µ"></a>è‡ªåŠ¨å¡«å……å­—æ®µ</h3><img src="/post/e9be66b7/image-20241103020436064.png" class="" title="image-20241103020436064"><p><code>user</code>è¡¨çš„æ—¶é—´å­—æ®µå®šä¹‰äº†é»˜è®¤å€¼ï¼Œå› æ­¤åœ¨æ’å…¥æ•°æ®æ—¶æ— éœ€æ‰‹åŠ¨å¡«å……è¿™ä¸¤ä¸ªå­—æ®µçš„å€¼ã€‚ä½†æ˜¯å¦‚æœå®šä¹‰è¡¨æ—¶æœªæŒ‡å®šå­—æ®µçš„é»˜è®¤å€¼ï¼Œå¯ä»¥ä½¿ç”¨MyBatis-Plusæä¾›çš„è‡ªåŠ¨å¡«å……å­—æ®µåŠŸèƒ½åœ¨æ’å…¥æ•°æ®æ—¶è‡ªåŠ¨å¡«å……æ•°æ®ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomMetaObjectHandler</span> <span class="keyword">implements</span> <span class="title class_">MetaObjectHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertFill</span><span class="params">(MetaObject metaObject)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.strictInsertFill(metaObject, <span class="string">&quot;createTime&quot;</span>, LocalDateTime::now, LocalDateTime.class);</span><br><span class="line">        <span class="built_in">this</span>.strictInsertFill(metaObject, <span class="string">&quot;updateTime&quot;</span>, LocalDateTime::now, LocalDateTime.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateFill</span><span class="params">(MetaObject metaObject)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.strictUpdateFill(metaObject, <span class="string">&quot;updateTime&quot;</span>, LocalDateTime::now, LocalDateTime.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@TableField(value = &quot;create_time&quot;, fill = FieldFill.INSERT)</span></span><br><span class="line"><span class="keyword">private</span> LocalDateTime createTime;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ›´æ–°æ—¶é—´</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@TableField(value = &quot;update_time&quot;, fill = FieldFill.INSERT_UPDATE)</span></span><br><span class="line"><span class="keyword">private</span> LocalDateTime updateTime;</span><br></pre></td></tr></table></figure><h3 id="åˆ†é¡µ"><a href="#åˆ†é¡µ" class="headerlink" title="åˆ†é¡µ"></a>åˆ†é¡µ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBatisConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MybatisPlusInterceptor <span class="title function_">mybatisPlusInterceptor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">MybatisPlusInterceptor</span> <span class="variable">mybatisPlusInterceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MybatisPlusInterceptor</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ†é¡µæ’ä»¶</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">PaginationInnerInterceptor</span> <span class="variable">paginationInnerInterceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PaginationInnerInterceptor</span>(DbType.MYSQL);</span><br><span class="line">        paginationInnerInterceptor.setMaxLimit(<span class="number">100L</span>);</span><br><span class="line">        mybatisPlusInterceptor.addInnerInterceptor(paginationInnerInterceptor);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> mybatisPlusInterceptor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testPaginationInnerInterceptor</span><span class="params">()</span> &#123;</span><br><span class="line">    Page&lt;User&gt; page = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(<span class="number">0</span>, <span class="number">10</span>);</span><br><span class="line">    page.setOrders(OrderItem.ascs(<span class="string">&quot;balance&quot;</span>));</span><br><span class="line">    page = userService.page(page);</span><br><span class="line">    page.getRecords().forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœ</p><img src="/post/e9be66b7/image-20241103005233009.png" class="" title="image-20241103005233009"><h3 id="ä¹è§‚é”"><a href="#ä¹è§‚é”" class="headerlink" title="ä¹è§‚é”"></a>ä¹è§‚é”</h3><p>æ›´æ–°æ—¶ä¼šå¢åŠ ä¸€ä¸ªversionæ¡ä»¶ï¼Œå¦‚æœversionå’Œä¹‹å‰æŸ¥å‡ºæ¥çš„ä¸ä¸€è‡´ï¼Œå°±åœæ­¢æ›´æ–°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBatisConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MybatisPlusInterceptor <span class="title function_">mybatisPlusInterceptor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">MybatisPlusInterceptor</span> <span class="variable">mybatisPlusInterceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MybatisPlusInterceptor</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä¹è§‚é”æ’ä»¶</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">OptimisticLockerInnerInterceptor</span> <span class="variable">optimisticLockerInnerInterceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OptimisticLockerInnerInterceptor</span>();</span><br><span class="line">        mybatisPlusInterceptor.addInnerInterceptor(optimisticLockerInnerInterceptor);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> mybatisPlusInterceptor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testOptimisticLockerInnerInterceptor</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.getById(<span class="number">2L</span>);</span><br><span class="line">    user.setBalance(<span class="number">999</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">User</span> <span class="variable">user1</span> <span class="operator">=</span> userService.getById(<span class="number">2L</span>);</span><br><span class="line">        user1.setBalance(<span class="number">888</span>);</span><br><span class="line">        userService.updateById(user1);</span><br><span class="line">    &#125;).start();</span><br><span class="line"></span><br><span class="line">    TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">updated</span> <span class="operator">=</span> userService.updateById(user);</span><br><span class="line">    Assertions.assertFalse(updated);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœ</p><img src="/post/e9be66b7/image-20241103015855684.png" class="" title="image-20241103015855684"><img src="/post/e9be66b7/image-20241103020004869.png" class="" title="image-20241103020004869"><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      <categories>
          
          <category> ORM </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MyBatis-Plus </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MyBatisåŸºç¡€</title>
      <link href="/post/4658a061.html"/>
      <url>/post/4658a061.html</url>
      
        <content type="html"><![CDATA[<h2 id="å¿«é€Ÿå…¥é—¨"><a href="#å¿«é€Ÿå…¥é—¨" class="headerlink" title="å¿«é€Ÿå…¥é—¨"></a>å¿«é€Ÿå…¥é—¨</h2><h3 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h3><p>åˆ›å»º<code>user</code>è¡¨</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `<span class="keyword">user</span>` (</span><br><span class="line">  `id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `pwd` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">6</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_0900_ai_ci;</span><br></pre></td></tr></table></figure><span id="more"></span><p>åˆ›å»ºmavenå·¥ç¨‹ï¼Œå¹¶å®šä¹‰<code>User</code>å®ä½“ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">(String name, String password)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¿«é€Ÿå¼€å§‹"><a href="#å¿«é€Ÿå¼€å§‹" class="headerlink" title="å¿«é€Ÿå¼€å§‹"></a>å¿«é€Ÿå¼€å§‹</h3><p>å®šä¹‰ <code>UserMapper</code>ï¼Œå¹¶å®šä¹‰ä¸€ä¸ªæŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·çš„æ–¹æ³•<code>listUsers</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserDao</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;User&gt; <span class="title function_">listUsers</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨resources&#x2F;mapperç›®å½•ä¸‹åˆ›å»º<code>UserMapper.xml</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;https://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.tw.mybatis.dao.UserMapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;listUsers&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.tw.mybatis.pojo.User&quot;</span>&gt;</span></span><br><span class="line">        select * from User</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åœ¨resourcesç›®å½•ä¸‹åˆ›å»º<code>mybatis-config.xml</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">configuration</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;https://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">&quot;mapUnderscoreToCamelCase&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">&quot;JDBC&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">&quot;POOLED&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driver&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;jdbc:mysql://localhost:3306/mybatis?useSSL=false<span class="symbol">&amp;amp;</span>useUnicode=true<span class="symbol">&amp;amp;</span>characterEncoding=UTF-8<span class="symbol">&amp;amp;</span>serverTimezone=Asia/Shanghai&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;root&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Time_Wait7&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">&quot;mapper/UserMapper.xml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å®šä¹‰<code>MyBatisUtil</code>ï¼Œç”¨äºè·å–<code>SqlSession</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBatisUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SqlSessionFactory sqlSessionFactory;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">resource</span> <span class="operator">=</span> <span class="string">&quot;mybatis-config.xml&quot;</span>;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> Resources.getResourceAsStream(resource);</span><br><span class="line">            sqlSessionFactory = <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBuilder</span>().build(inputStream);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SqlSession <span class="title function_">getSqlSession</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sqlSessionFactory.openSession();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SqlSession <span class="title function_">getSqlSession</span><span class="params">(<span class="type">boolean</span> autoCommit)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sqlSessionFactory.openSession(autoCommit);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserMapperTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testListUsers</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">SqlSession</span> <span class="variable">sqlSession</span> <span class="operator">=</span> MyBatisUtil.getSqlSession()) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">UserDao</span> <span class="variable">userDao</span> <span class="operator">=</span> sqlSession.getMapper(UserDao.class);</span><br><span class="line">            userDao.listUsers().forEach(System.out::println);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç®€å•CRUD"><a href="#ç®€å•CRUD" class="headerlink" title="ç®€å•CRUD"></a>ç®€å•CRUD</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserDao</span> &#123;</span><br><span class="line"></span><br><span class="line">    List&lt;User&gt; <span class="title function_">listUsers</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">addUser</span><span class="params">(User user)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">updateUser</span><span class="params">(User user)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">deleteUser</span><span class="params">(Long id)</span>;</span><br><span class="line">    </span><br><span class="line">    User <span class="title function_">getUserById</span><span class="params">(Long id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="xmlé…ç½®"><a href="#xmlé…ç½®" class="headerlink" title="xmlé…ç½®"></a>xmlé…ç½®</h4><p>åœ¨<code>UserMapper.xml</code>ç¼–å†™å¯¹åº”çš„sql</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;https://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.tw.mybatis.dao.UserMapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;addUser&quot;</span>&gt;</span></span><br><span class="line">        insert into User(name,pwd) values(#&#123;name&#125;,#&#123;pwd&#125;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;updateUser&quot;</span>&gt;</span></span><br><span class="line">        update User set name = #&#123;name&#125;,pwd = #&#123;pwd&#125; where id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">&quot;deleteUser&quot;</span>&gt;</span></span><br><span class="line">        delete from User where id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;listUsers&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.tw.mybatis.pojo.User&quot;</span>&gt;</span></span><br><span class="line">        select * from User</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getUserById&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.tw.mybatis.pojo.User&quot;</span>&gt;</span></span><br><span class="line">        select * from User where id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="æ³¨è§£"><a href="#æ³¨è§£" class="headerlink" title="æ³¨è§£"></a>æ³¨è§£</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tw.mybatis.dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.tw.mybatis.pojo.User;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Delete;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Insert;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Param;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Select;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Update;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserDao</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select(&quot;select * from user&quot;)</span></span><br><span class="line">    List&lt;User&gt; <span class="title function_">listUsers</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ³¨è§£æ–¹å¼ï¼Œæ ¹æ®idæŸ¥è¯¢ç”¨æˆ·</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Select(&quot;select * from user where id = #&#123;id&#125;&quot;)</span></span><br><span class="line">    User <span class="title function_">getUserById</span><span class="params">(Long id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ³¨è§£æ–¹å¼ï¼Œæ·»åŠ ç”¨æˆ·</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Insert(&quot;insert into user(name, pwd) values(#&#123;name&#125;, #&#123;password&#125;) &quot;)</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">addUser</span><span class="params">(User user)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ³¨è§£æ–¹å¼ï¼Œæ›´æ–°ç”¨æˆ·</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Update(&quot;update user set pwd = #&#123;password&#125; where name = #&#123;name&#125;&quot;)</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">updateUser</span><span class="params">(User user)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ³¨è§£æ–¹å¼ï¼Œåˆ é™¤ç”¨æˆ·</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Delete(&quot;delete from user where id = #&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">deleteUser</span><span class="params">(Long id)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="åˆ†é¡µæŸ¥è¯¢"><a href="#åˆ†é¡µæŸ¥è¯¢" class="headerlink" title="åˆ†é¡µæŸ¥è¯¢"></a>åˆ†é¡µæŸ¥è¯¢</h3><p>æ–¹å¼ä¸€ï¼šè‡ªå®šä¹‰sql</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> &#123;</span><br><span class="line">    List&lt;User&gt; <span class="title function_">listUsersByPage</span><span class="params">(<span class="meta">@Param(&quot;offset&quot;)</span> Integer offset, <span class="meta">@Param(&quot;limit&quot;)</span> Integer limit)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;https://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.tw.mybatis.dao.UserMapper&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;UserMap&quot;</span> <span class="attr">type</span>=<span class="string">&quot;user&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;name&quot;</span> <span class="attr">column</span>=<span class="string">&quot;name&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;password&quot;</span> <span class="attr">column</span>=<span class="string">&quot;pwd&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;listUsersByPage&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;UserMap&quot;</span>&gt;</span></span><br><span class="line">        select * from User limit #&#123;offset&#125;,#&#123;limit&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æ–¹å¼äºŒï¼š<code>RowBounds</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> &#123;</span><br><span class="line">    List&lt;User&gt; <span class="title function_">listUsersByRowBounds</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;https://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.tw.mybatis.dao.UserMapper&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;UserMap&quot;</span> <span class="attr">type</span>=<span class="string">&quot;user&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;name&quot;</span> <span class="attr">column</span>=<span class="string">&quot;name&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;password&quot;</span> <span class="attr">column</span>=<span class="string">&quot;pwd&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;listUsersByPage&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;UserMap&quot;</span>&gt;</span></span><br><span class="line">        select * from User</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testListUsersByRowBounds</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> (<span class="type">SqlSession</span> <span class="variable">sqlSession</span> <span class="operator">=</span> MyBatisUtil.getSqlSession()) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">UserDao</span> <span class="variable">userDao</span> <span class="operator">=</span> sqlSession.getMapper(UserDao.class);</span><br><span class="line">        <span class="keyword">final</span> List&lt;User&gt; users = sqlSession.selectList(<span class="string">&quot;com.tw.mybatis.dao.UserDao.listUsersByRowBounds&quot;</span>, <span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">RowBounds</span>(<span class="number">1</span>, <span class="number">2</span>));</span><br><span class="line">        users.forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h2><h3 id="å±æ€§"><a href="#å±æ€§" class="headerlink" title="å±æ€§"></a>å±æ€§</h3><p>ç›´æ¥å°†æ•°æ®åº“è¿æ¥ä¿¡æ¯ç¡¬ç¼–ç åœ¨<code>mybatis-config.xml</code>æ–‡ä»¶ä¸­ä¸å¤Ÿä¼˜é›…ï¼Œæ•°æ®åº“è¿æ¥å±æ€§å¯ä»¥åœ¨å¤–éƒ¨è¿›è¡Œé…ç½®ï¼Œå¹¶å¯ä»¥è¿›è¡ŒåŠ¨æ€æ›¿æ¢ã€‚</p><p>åˆ›å»º<code>db.properties</code>æ–‡ä»¶</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">driver</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="attr">url</span>=<span class="string">jdbc:mysql://localhost:3306/mybatis?useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line"><span class="attr">username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">password</span>=<span class="string">xxx</span></span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">configuration</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;https://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- é…ç½®æ•°æ®åº“è¿æ¥ä¿¡æ¯ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span> <span class="attr">resource</span>=<span class="string">&quot;db.properties&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">&quot;JDBC&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">&quot;POOLED&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driver&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;driver&#125;&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;url&#125;&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;username&#125;&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;password&#125;&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">&quot;mapper/UserMapper.xml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="ç±»å‹åˆ«å"><a href="#ç±»å‹åˆ«å" class="headerlink" title="ç±»å‹åˆ«å"></a>ç±»å‹åˆ«å</h3><p>åœ¨ä¸Šè¿°ä¾‹å­ä¸­å¯ä»¥çœ‹åˆ°ï¼Œ<code>resultType</code>å±æ€§éœ€è¦å†™ç±»çš„å…¨è·¯å¾„ï¼Œæœ‰ç‚¹ç¹çï¼Œå¯ä»¥é…ç½®åˆ«åç®€åŒ–ä¹¦å†™ã€‚é…ç½®åˆ«åæœ‰ä»¥ä¸‹ä¸¤ç§æ–¹å¼ï¼š</p><p>æ–¹å¼ä¸€ï¼šä¸ºæŒ‡å®šç±»é…ç½®åˆ«å</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">configuration</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;https://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- é…ç½®åˆ«å --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">type</span>=<span class="string">&quot;com.tw.mybatis.pojo.User&quot;</span> <span class="attr">alias</span>=<span class="string">&quot;user&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æ–¹å¼äºŒï¼šæŒ‡å®šåŒ…ä¸‹çš„å®ä½“ç±»é»˜è®¤ä»¥ç±»åå°å†™ä½œä¸ºåˆ«å</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">configuration</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;https://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- é…ç½®åˆ«å --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">&quot;com.tw.mybatis.pojo&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><p>é…ç½®åˆ«åä¹‹åï¼Œ<code>resultType</code>å°±å¯ä»¥ç®€å†™å¦‚ä¸‹ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;https://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.tw.mybatis.dao.UserMapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;listUsers&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;user&quot;</span>&gt;</span></span><br><span class="line">        select * from User</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getUserById&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;user&quot;</span>&gt;</span></span><br><span class="line">        select * from User where id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="æ˜ å°„"><a href="#æ˜ å°„" class="headerlink" title="æ˜ å°„"></a>æ˜ å°„</h2><h3 id="ç®€å•æ˜ å°„"><a href="#ç®€å•æ˜ å°„" class="headerlink" title="ç®€å•æ˜ å°„"></a>ç®€å•æ˜ å°„</h3><p>å¦‚æœå®ä½“ç±»å±æ€§å’Œè¡¨å­—æ®µä¸ä¸€è‡´ï¼Œå°±éœ€è¦æ‰‹åŠ¨æŒ‡å®šæ˜ å°„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¡¨å­—æ®µæ˜¯pwd</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;https://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.tw.mybatis.dao.UserMapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;UserMap&quot;</span> <span class="attr">type</span>=<span class="string">&quot;user&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;name&quot;</span> <span class="attr">column</span>=<span class="string">&quot;name&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- æŒ‡å®šå®ä½“ç±»å±æ€§ä¸è¡¨å­—æ®µçš„æ˜ å°„å…³ç³» --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;password&quot;</span> <span class="attr">column</span>=<span class="string">&quot;pwd&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;listUsers&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;UserMap&quot;</span>&gt;</span></span><br><span class="line">        select * from User</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="å¤æ‚æ˜ å°„"><a href="#å¤æ‚æ˜ å°„" class="headerlink" title="å¤æ‚æ˜ å°„"></a>å¤æ‚æ˜ å°„</h3><h4 id="ç¯å¢ƒå‡†å¤‡-1"><a href="#ç¯å¢ƒå‡†å¤‡-1" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h4><p>åˆ›å»º<code>student</code>å’Œ<code>teacher</code>è¡¨</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `student` (</span><br><span class="line">  `id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `tid` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  KEY `fk_tid` (`tid`),</span><br><span class="line">  <span class="keyword">CONSTRAINT</span> `fk_tid` <span class="keyword">FOREIGN</span> KEY (`tid`) <span class="keyword">REFERENCES</span> `teacher` (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">6</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb3;</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `teacher` (</span><br><span class="line">  `id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb3;</span><br></pre></td></tr></table></figure><p>å®šä¹‰<code>Student</code>å’Œ<code>Teacher</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Teacher</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Teacher teacher;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®šä¹‰<code>Mapper</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">StudentMapper</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">TeacherMapper</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ›å»º<code>Mapper.xml</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;https://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.tw.mybatis.dao.StudentMapper&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;https://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.tw.mybatis.dao.TeacherMapper&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure><p>é…ç½®æ˜ å°„æ–‡ä»¶</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">configuration</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;https://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">&quot;mapper/TeacherMapper.xml&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">&quot;mapper/StudentMapper.xml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="association"><a href="#association" class="headerlink" title="association"></a><code>association</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">StudentMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æŸ¥è¯¢å­¦ç”Ÿä¿¡æ¯ï¼ŒåŒæ—¶åŒ…å«è€å¸ˆä¿¡æ¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;Student&gt; <span class="title function_">listStudentsWithTeacher</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="å­æŸ¥è¯¢æ–¹å¼"><a href="#å­æŸ¥è¯¢æ–¹å¼" class="headerlink" title="å­æŸ¥è¯¢æ–¹å¼"></a>å­æŸ¥è¯¢æ–¹å¼</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;https://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.tw.mybatis.dao.StudentMapper&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;StudentWithTeacher&quot;</span> <span class="attr">type</span>=<span class="string">&quot;Student&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;name&quot;</span> <span class="attr">column</span>=<span class="string">&quot;name&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">association</span> <span class="attr">property</span>=<span class="string">&quot;teacher&quot;</span> <span class="attr">javaType</span>=<span class="string">&quot;Teacher&quot;</span> <span class="attr">column</span>=<span class="string">&quot;tid&quot;</span> <span class="attr">select</span>=<span class="string">&quot;getTeacher&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;listStudentsWithTeacher&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;StudentWithTeacher&quot;</span>&gt;</span></span><br><span class="line">        select * from student</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getTeacher&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;Teacher&quot;</span>&gt;</span></span><br><span class="line">        select * from teacher where id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure><h5 id="è¿è¡¨æŸ¥è¯¢æ–¹å¼"><a href="#è¿è¡¨æŸ¥è¯¢æ–¹å¼" class="headerlink" title="è¿è¡¨æŸ¥è¯¢æ–¹å¼"></a>è¿è¡¨æŸ¥è¯¢æ–¹å¼</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;https://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.tw.mybatis.dao.StudentMapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;StudentWithTeacher2&quot;</span> <span class="attr">type</span>=<span class="string">&quot;Student&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> <span class="attr">column</span>=<span class="string">&quot;sid&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;name&quot;</span> <span class="attr">column</span>=<span class="string">&quot;sname&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">association</span> <span class="attr">property</span>=<span class="string">&quot;teacher&quot;</span> <span class="attr">javaType</span>=<span class="string">&quot;Teacher&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> <span class="attr">column</span>=<span class="string">&quot;tid&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;name&quot;</span> <span class="attr">column</span>=<span class="string">&quot;tname&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">association</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;listStudentsWithTeacher2&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;StudentWithTeacher2&quot;</span>&gt;</span></span><br><span class="line">        select s.id sid, s.name sname, t.id tid, t.name tname</span><br><span class="line">        from student s left join teacher t</span><br><span class="line">        on s.tid = t.id</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="collection"><a href="#collection" class="headerlink" title="collection"></a><code>collection</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long tid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Teacher</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Student&gt; students;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">TeacherMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    List&lt;Teacher&gt; <span class="title function_">selectList</span><span class="params">(Object o)</span>;</span><br><span class="line"></span><br><span class="line">    Teacher <span class="title function_">getTeacherWithStudents</span><span class="params">(<span class="meta">@Param(&quot;tid&quot;)</span> Long id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="å­æŸ¥è¯¢æ–¹å¼-1"><a href="#å­æŸ¥è¯¢æ–¹å¼-1" class="headerlink" title="å­æŸ¥è¯¢æ–¹å¼"></a>å­æŸ¥è¯¢æ–¹å¼</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;https://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.tw.mybatis.dao.TeacherMapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;TeacherWithStudents&quot;</span> <span class="attr">type</span>=<span class="string">&quot;Teacher&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">&quot;students&quot;</span> <span class="attr">javaType</span>=<span class="string">&quot;ArrayList&quot;</span> <span class="attr">ofType</span>=<span class="string">&quot;Student&quot;</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span> <span class="attr">select</span>=<span class="string">&quot;listStudentByTid&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getTeacherWithStudents&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;TeacherWithStudents&quot;</span>&gt;</span></span><br><span class="line">        select * from teacher where id = #&#123;tid&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;listStudentByTid&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;Student&quot;</span>&gt;</span></span><br><span class="line">        select * from student where tid = #&#123;tid&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure><h5 id="è¿è¡¨æŸ¥è¯¢æ–¹å¼-1"><a href="#è¿è¡¨æŸ¥è¯¢æ–¹å¼-1" class="headerlink" title="è¿è¡¨æŸ¥è¯¢æ–¹å¼"></a>è¿è¡¨æŸ¥è¯¢æ–¹å¼</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;https://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.tw.mybatis.dao.TeacherMapper&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;TeacherWithStudents&quot;</span> <span class="attr">type</span>=<span class="string">&quot;Teacher&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> <span class="attr">column</span>=<span class="string">&quot;tid&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;name&quot;</span> <span class="attr">column</span>=<span class="string">&quot;tname&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">&quot;students&quot;</span> <span class="attr">ofType</span>=<span class="string">&quot;Student&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> <span class="attr">column</span>=<span class="string">&quot;sid&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;name&quot;</span> <span class="attr">column</span>=<span class="string">&quot;sname&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;tid&quot;</span> <span class="attr">column</span>=<span class="string">&quot;tid&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">collection</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getTeacherWithStudents&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;TeacherWithStudents&quot;</span>&gt;</span></span><br><span class="line">        select t.id tid, t.name tname, s.id sid, s.name sname</span><br><span class="line">        from teacher t left join student s</span><br><span class="line">        on t.id = s.tid</span><br><span class="line">        where t.id = #&#123;tid&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="åŠ¨æ€SQL"><a href="#åŠ¨æ€SQL" class="headerlink" title="åŠ¨æ€SQL"></a>åŠ¨æ€SQL</h2><h3 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h3><p>åˆ›å»º<code>blog</code>è¡¨</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `blog` (</span><br><span class="line">  `id` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;åšå®¢id&#x27;</span>,</span><br><span class="line">  `title` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;åšå®¢æ ‡é¢˜&#x27;</span>,</span><br><span class="line">  `author` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;ä½œè€…&#x27;</span>,</span><br><span class="line">  `create_time` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;åˆ›å»ºæ—¶é—´&#x27;</span>,</span><br><span class="line">  `views` <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;æµè§ˆé‡&#x27;</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb3;</span><br></pre></td></tr></table></figure><p>å®šä¹‰<code>Blog</code>å®ä½“ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Blog</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String author;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer views;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®šä¹‰<code>BlogMapper</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BlogMapper</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ›å»º<code>BlogMapper.xml</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;https://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.tw.mybatis.dao.BlogMapper&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åœ¨<code>mybatis-config.xml</code>æ·»åŠ æ˜ å°„</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">&quot;mapper/BlogMapper.xml&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="if"><a href="#if" class="headerlink" title="if"></a><code>if</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BlogMapper</span> &#123;</span><br><span class="line">List&lt;Blog&gt; <span class="title function_">listBlogs</span><span class="params">(Map&lt;String, Object&gt; params)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;listBlogs&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.tw.mybatis.pojo.Blog&quot;</span>&gt;</span></span><br><span class="line">    select * from Blog</span><br><span class="line">    where  1 = 1</span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;author != null&quot;</span>&gt;</span></span><br><span class="line">        and author like concat(&#x27;%&#x27;, #&#123;author&#125;, &#x27;%&#x27;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;title != null&quot;</span>&gt;</span></span><br><span class="line">        and title like concat(&#x27;%&#x27;, #&#123;title&#125;, &#x27;%&#x27;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;createTime != null&quot;</span>&gt;</span></span><br><span class="line">        and create_time &gt; #&#123;createTime&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;views != null&quot;</span>&gt;</span></span><br><span class="line">        and views &gt; #&#123;views&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testListBlogs</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> (<span class="type">SqlSession</span> <span class="variable">sqlSession</span> <span class="operator">=</span> MyBatisUtil.getSqlSession()) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">BlogMapper</span> <span class="variable">blogMapper</span> <span class="operator">=</span> sqlSession.getMapper(BlogMapper.class);</span><br><span class="line">        Map&lt;String, Object&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        params.put(<span class="string">&quot;title&quot;</span>, <span class="string">&quot;learning&quot;</span>);</span><br><span class="line">        <span class="keyword">final</span> List&lt;Blog&gt; blogs = blogMapper.listBlogs(params);</span><br><span class="line">        blogs.forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="where"><a href="#where" class="headerlink" title="where"></a><code>where</code></h3><p>å‰é¢çš„ä¾‹å­ä¸­ä¸ºäº†é¿å…æ‹¼æ¥å‡ºå¦‚ä¸‹é”™è¯¯sqlï¼Œæ‰‹åŠ¨åŠ äº†æ¡ä»¶<code>1 = 1</code>ï¼Œè¿™æ ·è™½ç„¶èƒ½è§£å†³é—®é¢˜ï¼Œä½†æ˜¾å¾—ä¸å¤Ÿä¼˜é›…ï¼Œä¸ºæ­¤MyBatisæä¾›äº†<code>&lt;where&gt;</code>æ ‡ç­¾ï¼Œå¯ä»¥æ›´å¥½åœ°è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> Blog</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> Blog</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line"><span class="keyword">and</span> title <span class="keyword">like</span></span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;listBlogs&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.tw.mybatis.pojo.Blog&quot;</span>&gt;</span></span><br><span class="line">    select * from Blog</span><br><span class="line">    <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;author != null&quot;</span>&gt;</span></span><br><span class="line">            and author like concat(&#x27;%&#x27;, #&#123;author&#125;, &#x27;%&#x27;)</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;title != null&quot;</span>&gt;</span></span><br><span class="line">            and title like concat(&#x27;%&#x27;, #&#123;title&#125;, &#x27;%&#x27;)</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;createTime != null&quot;</span>&gt;</span></span><br><span class="line">            and create_time &gt; #&#123;createTime&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;views != null&quot;</span>&gt;</span></span><br><span class="line">            and views &gt; #&#123;views&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="set"><a href="#set" class="headerlink" title="set"></a><code>set</code></h3><p>ä¸<code>where</code>æ ‡ç­¾ç±»ä¼¼ï¼Œ<code>set</code>æ ‡ç­¾å¯ä»¥å»é™¤å¯èƒ½å¤šä½™çš„å­—ç¬¦ï¼Œä¿è¯sqlæ‹¼æ¥æ­£ç¡®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BlogMapper</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">updateBlog</span><span class="params">(Map&lt;String, Object&gt; params)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;updateBlog&quot;</span>&gt;</span></span><br><span class="line">    update Blog</span><br><span class="line">    <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;title != null&quot;</span>&gt;</span></span><br><span class="line">            title = #&#123;title&#125;,</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;author != null&quot;</span>&gt;</span></span><br><span class="line">            author = #&#123;author&#125;,</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;createTime != null&quot;</span>&gt;</span></span><br><span class="line">            create_time = #&#123;createTime&#125;,</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;views != null&quot;</span>&gt;</span></span><br><span class="line">            views = #&#123;views&#125;,</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">    where id = #&#123;id&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>choose-when-otherwise</code></p><p>æœ‰ç‚¹ç±»ä¼¼<code>switch</code>è¯­å¥ï¼Œä¼ å…¥å“ªä¸ªæ¡ä»¶å°±ç”¨å“ªä¸ªæ¡ä»¶æŸ¥è¯¢</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BlogMapper</span> &#123;</span><br><span class="line">    List&lt;Blog&gt; <span class="title function_">listBlogsByChoose</span><span class="params">(Map&lt;String, Object&gt; params)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;listBlogsByChoose&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.tw.mybatis.pojo.Blog&quot;</span>&gt;</span></span><br><span class="line">    select * from Blog</span><br><span class="line">    <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">choose</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">when</span> <span class="attr">test</span>=<span class="string">&quot;title != null&quot;</span>&gt;</span></span><br><span class="line">                and title like concat(&#x27;%&#x27;, #&#123;title&#125;, &#x27;%&#x27;)</span><br><span class="line">            <span class="tag">&lt;/<span class="name">when</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">when</span> <span class="attr">test</span>=<span class="string">&quot;author != null&quot;</span>&gt;</span></span><br><span class="line">                and author like concat(&#x27;%&#x27;, #&#123;author&#125;, &#x27;%&#x27;)</span><br><span class="line">            <span class="tag">&lt;/<span class="name">when</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">otherwise</span>&gt;</span></span><br><span class="line">                and 1 = 1</span><br><span class="line">            <span class="tag">&lt;/<span class="name">otherwise</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">choose</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="foreach"><a href="#foreach" class="headerlink" title="foreach"></a><code>foreach</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BlogMapper</span> &#123;</span><br><span class="line">List&lt;Blog&gt; <span class="title function_">listBlogsByForEach</span><span class="params">(<span class="meta">@Param(&quot;ids&quot;)</span> List&lt;String&gt; ids)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;listBlogsByForEach&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.tw.mybatis.pojo.Blog&quot;</span>&gt;</span></span><br><span class="line">    select * from Blog</span><br><span class="line">    <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">&quot;ids&quot;</span> <span class="attr">item</span>=<span class="string">&quot;id&quot;</span> <span class="attr">open</span>=<span class="string">&quot;id in (&quot;</span> <span class="attr">close</span>=<span class="string">&quot;)&quot;</span> <span class="attr">separator</span>=<span class="string">&quot;,&quot;</span>&gt;</span></span><br><span class="line">            #&#123;id&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="sqlç‰‡æ®µ"><a href="#sqlç‰‡æ®µ" class="headerlink" title="sqlç‰‡æ®µ"></a>sqlç‰‡æ®µ</h3><h2 id="ç¼“å­˜"><a href="#ç¼“å­˜" class="headerlink" title="ç¼“å­˜"></a>ç¼“å­˜</h2><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      <categories>
          
          <category> ORM </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MyBatis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NginxåŸºç¡€</title>
      <link href="/post/33a007fa.html"/>
      <url>/post/33a007fa.html</url>
      
        <content type="html"><![CDATA[<h2 id="å®‰è£…Nginx"><a href="#å®‰è£…Nginx" class="headerlink" title="å®‰è£…Nginx"></a>å®‰è£…Nginx</h2><ul><li>å®‰è£…</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install nginx</span><br></pre></td></tr></table></figure><ul><li>æ£€æŸ¥æ˜¯å¦è£…æˆåŠŸ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nginx -v</span><br><span class="line"><span class="comment"># nginx version: nginx/1.21.2</span></span><br></pre></td></tr></table></figure><ul><li>å®‰è£…æˆåŠŸåçš„ç›¸å…³ç›®å½•</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># å®‰è£…æ–‡ä»¶ç›®å½•</span><br><span class="line">/usr/local/Cellar/nginx/1.21.2</span><br><span class="line"># é…ç½®æ–‡ä»¶ç›®å½•</span><br><span class="line">/usr/local/etc/nginx</span><br><span class="line"># htmlç›®å½•</span><br><span class="line">/usr/local/var/www</span><br></pre></td></tr></table></figure><span id="more"></span><h2 id="NginxåŸºæœ¬å‘½ä»¤"><a href="#NginxåŸºæœ¬å‘½ä»¤" class="headerlink" title="NginxåŸºæœ¬å‘½ä»¤"></a>NginxåŸºæœ¬å‘½ä»¤</h2><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>brew list nginx</code></td><td>æŸ¥çœ‹nginxçš„å®‰è£…ä¿¡æ¯</td></tr><tr><td><code>nginx</code></td><td>å¯åŠ¨</td></tr><tr><td><code>nginx -s stop</code></td><td>åœæ­¢</td></tr><tr><td><code>nginx -s reload</code></td><td>é‡å¯</td></tr><tr><td><code>nginx -t</code></td><td>æŸ¥çœ‹é…ç½®æ–‡ä»¶ä½ç½®</td></tr></tbody></table><h2 id="åå‘ä»£ç†ä¸è´Ÿè½½å‡è¡¡"><a href="#åå‘ä»£ç†ä¸è´Ÿè½½å‡è¡¡" class="headerlink" title="åå‘ä»£ç†ä¸è´Ÿè½½å‡è¡¡"></a>åå‘ä»£ç†ä¸è´Ÿè½½å‡è¡¡</h2><p>åˆ›å»ºä¸€ä¸ªdemoé¡¹ç›®ï¼Œå¹¶æ‰“åŒ…ï¼Œé€šè¿‡<code>java -jar</code>æ–¹å¼å¯åŠ¨ä¸¤ä¸ªå®ä¾‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">java -jar demo-0.0.1-SNAPSHOT.jar --server.port=8080</span><br><span class="line"></span><br><span class="line">java -jar demo-0.0.1-SNAPSHOT.jar --server.port=8081</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹nginx.confï¼Œé…ç½®åå‘ä»£ç†ä¸è´Ÿè½½å‡è¡¡</p><img src="/post/33a007fa/image-20240916203606556.png" class="" title="image-20240916203606556"><p>è®¿é—®æµ‹è¯•ï¼š<a href="http://localhost/hello%EF%BC%8C%E5%A4%9A%E6%AC%A1%E8%AE%BF%E9%97%AE%E8%BF%99%E4%B8%AA%E8%BF%9E%E6%8E%A5%EF%BC%8C%E8%AF%B7%E6%B1%82%E9%9A%8F%E6%9C%BA%E6%89%93%E5%88%B0%E4%B8%8D%E5%90%8C%E5%AE%9E%E4%BE%8B">http://localhost/helloï¼Œå¤šæ¬¡è®¿é—®è¿™ä¸ªè¿æ¥ï¼Œè¯·æ±‚éšæœºæ‰“åˆ°ä¸åŒå®ä¾‹</a></p><img src="/post/33a007fa/image-20240916203807897.png" class="" title="image-20240916203807897"><img src="/post/33a007fa/image-20240916203832170.png" class="" title="image-20240916203832170"><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      <categories>
          
          <category> ä¸­é—´ä»¶ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DockeråŸºç¡€</title>
      <link href="/post/89826705.html"/>
      <url>/post/89826705.html</url>
      
        <content type="html"><![CDATA[<h2 id="Dockeræ¶æ„å›¾"><a href="#Dockeræ¶æ„å›¾" class="headerlink" title="Dockeræ¶æ„å›¾"></a>Dockeræ¶æ„å›¾</h2><img src="/post/89826705/Docker%E6%9E%B6%E6%9E%84%E5%9B%BE.png" class=""><span id="more"></span><h2 id="Dockerä¸è™šæ‹Ÿæœº"><a href="#Dockerä¸è™šæ‹Ÿæœº" class="headerlink" title="Dockerä¸è™šæ‹Ÿæœº"></a>Dockerä¸è™šæ‹Ÿæœº</h2><img src="/post/89826705/Docker%E4%B8%8E%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%8A%BD%E8%B1%A1%E5%9B%BE.png" class=""><h2 id="å¸¸ç”¨å‘½ä»¤"><a href="#å¸¸ç”¨å‘½ä»¤" class="headerlink" title="å¸¸ç”¨å‘½ä»¤"></a>å¸¸ç”¨å‘½ä»¤</h2><img src="/post/89826705/image-20241027223956215.png" class="" title="image-20241027223956215"><h3 id="é•œåƒå‘½ä»¤"><a href="#é•œåƒå‘½ä»¤" class="headerlink" title="é•œåƒå‘½ä»¤"></a>é•œåƒå‘½ä»¤</h3><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>docker build</code></td><td>æ„å»ºé•œåƒ</td></tr><tr><td><code>docker images</code></td><td>æŸ¥çœ‹æœ¬åœ°é•œåƒ</td></tr><tr><td><code>docker images -q</code></td><td>åªæ˜¾ç¤ºé•œåƒID</td></tr><tr><td><code>docker search mysql</code></td><td>æŸ¥æ‰¾é•œåƒ</td></tr><tr><td><code>docker pull mysql</code></td><td>æ‹‰å–æœ€æ–°ç‰ˆæœ¬é•œåƒ</td></tr><tr><td><code>docker pull mysql:5.7</code></td><td>æ‹‰å–æŒ‡å®šç‰ˆæœ¬é•œåƒ</td></tr><tr><td><code>docker rmi é•œåƒå/é•œåƒID ...</code></td><td>åˆ é™¤é•œåƒ</td></tr><tr><td><code>docker rmi $(docker images -q)</code></td><td>æ‰¹é‡åˆ é™¤é•œåƒ</td></tr></tbody></table><h3 id="å®¹å™¨å‘½ä»¤"><a href="#å®¹å™¨å‘½ä»¤" class="headerlink" title="å®¹å™¨å‘½ä»¤"></a>å®¹å™¨å‘½ä»¤</h3><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>docker ps</code></td><td>æŸ¥çœ‹å®¹å™¨</td></tr><tr><td><code>docker ps -a</code></td><td>æŸ¥çœ‹æ‰€æœ‰å®¹å™¨</td></tr><tr><td><code>docker ps -a -n=1</code></td><td>æŸ¥çœ‹æœ€æ–°åˆ›å»ºçš„å®¹å™¨</td></tr><tr><td><code>docker run -d --name nginx -p 80:80 nginx</code></td><td>è¿è¡Œå®¹å™¨</td></tr><tr><td><code>docker stop</code></td><td>åœæ­¢å®¹å™¨</td></tr><tr><td><code>docker start</code></td><td>å¯åŠ¨å®¹å™¨</td></tr><tr><td><code>docker restart</code></td><td>é‡å¯å®¹å™¨</td></tr><tr><td><code>docker rm -f å®¹å™¨</code></td><td>åˆ é™¤å®¹å™¨</td></tr><tr><td><code>docker logs</code></td><td>æŸ¥çœ‹å®¹å™¨è¿è¡Œæ—¥å¿—</td></tr><tr><td><code>docker exec -it å®¹å™¨ /bin/bash</code></td><td>è¿›å…¥å®¹å™¨</td></tr><tr><td><code>docker inspect å®¹å™¨</code></td><td>æŸ¥çœ‹å®¹å™¨è¯¦ç»†ä¿¡æ¯</td></tr><tr><td><code>docker update --restart=always å®¹å™¨</code></td><td>è®¾ç½®å®¹å™¨å¼€æœºè‡ªå¯</td></tr><tr><td><code>docker ps --format &quot;table &#123;&#123;.ID&#125;&#125;\t&#123;&#123;.Image&#125;&#125;\t&#123;&#123;.Ports&#125;&#125;\t&#123;&#123;.Status&#125;&#125;\t&#123;&#123;.Names&#125;&#125;&quot;</code></td><td>æ ¼å¼åŒ–è¾“å‡º</td></tr><tr><td><code>docker save</code></td><td>ä¿å­˜é•œåƒ</td></tr><tr><td><code>docker load</code></td><td>åŠ è½½é•œåƒ</td></tr></tbody></table><p>psï¼šä¸Šé¢è¿™äº›å‘½ä»¤ä¸­çš„å®¹å™¨å³å¯ä»¥æ˜¯å®¹å™¨åä¹Ÿå¯ä»¥æ˜¯å®¹å™¨ID</p><h3 id="å…¶ä»–å‘½ä»¤"><a href="#å…¶ä»–å‘½ä»¤" class="headerlink" title="å…¶ä»–å‘½ä»¤"></a>å…¶ä»–å‘½ä»¤</h3><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>docker COMMAND --help</code></td><td>æŸ¥çœ‹å¸®åŠ©æ–‡æ¡£</td></tr><tr><td><code>systemctl enable docker</code></td><td>è®¾ç½®dockerå¼€æœºè‡ªå¯åŠ¨</td></tr></tbody></table><h3 id="å‘½ä»¤åˆ«å"><a href="#å‘½ä»¤åˆ«å" class="headerlink" title="å‘½ä»¤åˆ«å"></a>å‘½ä»¤åˆ«å</h3><p>ä¿®æ”¹ <code>/root/.bashrc</code> æ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># .bashrc</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># User specific aliases and functions</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">alias</span> <span class="built_in">rm</span>=<span class="string">&#x27;rm -i&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> <span class="built_in">cp</span>=<span class="string">&#x27;cp -i&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> <span class="built_in">mv</span>=<span class="string">&#x27;mv -i&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> psf=<span class="string">&#x27;ps --format &quot;table &#123;&#123;.ID&#125;&#125;\t&#123;&#123;.Image&#125;&#125;\t&#123;&#123;.Ports&#125;&#125;\t&#123;&#123;.Status&#125;&#125;\t&#123;&#123;.Names&#125;&#125;&quot;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Source global definitions</span></span><br><span class="line"><span class="keyword">if</span> [ -f /etc/bashrc ]; <span class="keyword">then</span></span><br><span class="line">        . /etc/bashrc</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><p>æ‰§è¡Œå‘½ä»¤è®©åˆ«åç”Ÿæ•ˆï¼š<code>source /root/.bashrc</code></p><h2 id="æ•°æ®å·"><a href="#æ•°æ®å·" class="headerlink" title="æ•°æ®å·"></a>æ•°æ®å·</h2><p>æ•°æ®å·ï¼ˆVolumeï¼‰æ˜¯å®¹å™¨æŠ€æœ¯ï¼ˆå¦‚ Dockerï¼‰ä¸­ä¸€ç§ç”¨äº<strong>æŒä¹…åŒ–æ•°æ®</strong>å’Œ<strong>å…±äº«æ•°æ®</strong>çš„æœºåˆ¶ã€‚å®ƒå…è®¸å®¹å™¨ä¹‹é—´ã€æˆ–è€…å®¹å™¨å’Œå®¿ä¸»æœºä¹‹é—´å…±äº«æ•°æ®ï¼ŒåŒæ—¶å®ç°æ•°æ®çš„æŒä¹…å­˜å‚¨ï¼Œå³ä½¿å®¹å™¨è¢«åˆ é™¤ï¼Œæ•°æ®ä¹Ÿä¸ä¼šä¸¢å¤±ã€‚</p><img src="/post/89826705/image-20241028233002568.png" class="" title="image-20241028233002568"><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>docker volume create</code></td><td>åˆ›å»ºæ•°æ®å·</td></tr><tr><td><code>docker volume ls</code></td><td>æŸ¥çœ‹æ•°æ®å·</td></tr><tr><td><code>docker volume rm</code></td><td>åˆ é™¤æ•°æ®å·</td></tr><tr><td><code>docker volume prune</code></td><td>æ¸…é™¤æ•°æ®å·</td></tr><tr><td><code>docker volume inspect</code></td><td>æŸ¥çœ‹æ•°æ®å·è¯¦æƒ…</td></tr></tbody></table><p>æ•°æ®å·æŒ‚è½½ï¼šåœ¨åˆ›å»ºå®¹å™¨æ—¶ç”¨ <code>-v å·å:å®¹å™¨ç›®å½•</code> è¿›è¡ŒæŒ‚è½½</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name nginx -p 80:80 -v html:/usr/share/nginx/html nginx</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹æ˜¯å¦æŒ‚è½½æˆåŠŸï¼š</p><img src="/post/89826705/image-20241029000212988.png" class="" title="image-20241029000212988"><p>æŸ¥çœ‹å…·ä½“çš„æŒ‚è½½è·¯å¾„ï¼š</p><img src="/post/89826705/image-20241028234315885.png" class="" title="image-20241028234315885"><p>è¿™æ ·å°±å®Œæˆäº†å®¿ä¸»æœºç›®å½• <code>/var/lib/docker/volumes/html/_data</code> å’Œå®¹å™¨ç›®å½• <code>/usr/share/nginx/html</code> çš„åŒå‘æ˜ å°„ã€‚</p><p>PSï¼šå¦‚æœåˆ›å»ºå®¹å™¨æ—¶æœªé€šè¿‡ <code>-v html:/usr/share/nginx/html</code> é€‰é¡¹æŒ‚è½½ï¼Œè™šæ‹Ÿæœºä¼šåˆ›å»ºä¸€ä¸ªåŒ¿åå·ï¼Œå¹¶å°† <code>/usr/share/nginx/html</code> æŒ‚è½½åˆ°è¿™ä¸ªåŒ¿åå·ä¸Šï¼ŒåŒ¿åå·çš„åç§°æ˜¯ä¸€ä¸²éšæœºå­—ç¬¦ä¸²ï¼Œå…·ä½“çš„æŒ‚è½½è·¯å¾„å°±æ˜¯ <code>/var/lib/docker/volumes/xxx/_data</code>ã€‚</p><p>é€šè¿‡æ•°æ®å·è¿›è¡ŒæŒ‚è½½ï¼Œå®¿ä¸»æœºä¸­çš„æŒ‚è½½ç›®å½•é»˜è®¤æ˜¯ï¼š<code>/var/lib/docker/volumes/å·å/_data</code>ï¼ŒæŒ‚è½½è·¯å¾„æœ‰ç‚¹å¤ªæ·±ï¼Œæ‰€ä»¥ docker ä¹Ÿæ”¯æŒç›´æ¥æŒ‡å®šå®¿ä¸»æœºç›®å½•è¿›è¡ŒæŒ‚è½½ï¼Œå¦‚ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">--name mysql \</span><br><span class="line">-p 3306:3306 \</span><br><span class="line">-e TZ=Asia/Shanghai \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=123456 \</span><br><span class="line">-v /root/mysql/data:/var/lib/mysql \</span><br><span class="line">-v /root/mysql/init:/docker-entrypoint-initdb.d \</span><br><span class="line">-v /root/mysql/conf:/etc/mysql/conf.d \</span><br><span class="line">mysql</span><br></pre></td></tr></table></figure><p>psï¼šæœ¬åœ°ç›®å½•æˆ–æ–‡ä»¶å¿…é¡»ä»¥ <code>/</code> æˆ– <code>./</code>å¼€å¤´ï¼Œå¦‚æœç›´æ¥ä»¥åå­—å¼€å¤´ï¼Œä¼šè¢«è¯†åˆ«ä¸ºæ•°æ®å·åã€‚</p><h2 id="é•œåƒ"><a href="#é•œåƒ" class="headerlink" title="é•œåƒ"></a>é•œåƒ</h2><h3 id="é•œåƒç»“æ„"><a href="#é•œåƒç»“æ„" class="headerlink" title="é•œåƒç»“æ„"></a>é•œåƒç»“æ„</h3><p>è”åˆæ–‡ä»¶ç³»ç»Ÿ</p><p>é•œåƒåˆ†å±‚</p><h3 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a><code>Dockerfile</code></h3><p><code>Dockerfile</code> å°±æ˜¯ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼ŒåŒ…å«ä¸€ç³»åˆ—æŒ‡ä»¤ï¼Œç”¨æ¥è¯´æ˜å¦‚ä½•æ„å»ºé•œåƒã€‚å¸¸è§æŒ‡ä»¤å¦‚ä¸‹ï¼š</p><table><thead><tr><th>æŒ‡ä»¤</th><th>è¯´æ˜</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td><code>FROM</code></td><td>æŒ‡å®šåŸºç¡€é•œåƒ</td><td><code>FROM centos:7</code></td></tr><tr><td><code>ENV</code></td><td>é…ç½®ç¯å¢ƒå˜é‡ï¼Œç”¨äºåç»­æŒ‡ä»¤</td><td><code>ENV key=value</code></td></tr><tr><td><code>COPY</code></td><td>æ‹·è´æœ¬åœ°æ–‡ä»¶åˆ°é•œåƒçš„æŒ‡å®šç›®å½•</td><td><code>COPY ./jre11.tar.gz /tmp</code></td></tr><tr><td><code>RUN</code></td><td>æ‰§è¡ŒLinuxçš„shellå‘½ä»¤</td><td><code>RUN tar -zxvf /tmp/jre11.tar.gz &amp;&amp; EXPORTS path=/tmp/jre11:$path</code></td></tr><tr><td><code>EXPOSE</code></td><td>æŒ‡å®šå®¹å™¨è¿è¡Œæ—¶ç›‘å¬çš„ç«¯å£</td><td><code>EXPOSE 8080</code></td></tr><tr><td><code>ENTRYPOINT</code></td><td>é•œåƒä¸­åº”ç”¨çš„å¯åŠ¨å‘½ä»¤ï¼Œå®¹å™¨è¿è¡Œæ—¶è°ƒç”¨</td><td><code>ENTRYPOINT java -jar xxx.jar</code></td></tr><tr><td><code>VOLUME</code></td><td>åˆ›å»ºä¸€ä¸ªæ•°æ®å·æŒ‚è½½ç‚¹</td><td></td></tr><tr><td><code>WORKDIR</code></td><td>é…ç½®å·¥ä½œç›®å½•</td><td></td></tr></tbody></table><p><code>Dockerfile</code> ç¤ºä¾‹ï¼š</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŒ‡å®šåŸºç¡€é•œåƒ</span></span><br><span class="line"><span class="keyword">FROM</span> centos:<span class="number">7</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®ç¯å¢ƒå˜é‡ï¼šjdkå®‰è£…ç›®å½•</span></span><br><span class="line"><span class="keyword">ENV</span> JAVA_DIR=/usr/local</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‹·è´æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./jdk8.tar.gz <span class="variable">$JAVA_DIR</span>/</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./docker-demo.jar /app.jar</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…jdk</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cd</span> <span class="variable">$JAVA_DIR</span> &amp;&amp; tar -xf ./jdk8.tar.gz &amp;&amp; <span class="built_in">mv</span> ./jdk1.8.0_144 ./jdk8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®ç¯å¢ƒå˜é‡</span></span><br><span class="line"><span class="keyword">ENV</span> JAVA_HOME=$JAVA_DIR/jdk8</span><br><span class="line"><span class="keyword">ENV</span> PATH=$PATH:$JAVA_HOME/bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…¥å£ï¼Œjavaé¡¹ç›®çš„å¯åŠ¨å‘½ä»¤</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;java&quot;</span>, <span class="string">&quot;-jar&quot;</span>, <span class="string">&quot;/app.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¿™ä¸ª <code>Dockerfile</code> ç­‰åŒäºï¼š</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åŸºç¡€é•œåƒ</span></span><br><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">11.0</span>-jre-buster</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‹·è´æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./docker-demo.jar /app.jar</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å…¥å£</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;java&quot;</span>, <span class="string">&quot;-jar&quot;</span>, <span class="string">&quot;/app.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure><p>æ„å»ºé•œåƒ</p><p>æœ‰äº† <code>Dockerfile</code> ä¹‹åï¼Œå°±å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æ„å»ºé•œåƒäº†ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># . è¡¨ç¤ºDockerfileæ‰€åœ¨ç›®å½•</span></span><br><span class="line">docker build -t é•œåƒåç§° .</span><br></pre></td></tr></table></figure><p>PSï¼šå¦‚æœæ„å»ºé•œåƒæ‰€ç”¨æ–‡ä»¶åç§°ä¸æ˜¯ <code>Dockerfile</code>ï¼Œéœ€é€šè¿‡ <code>-f dockerfileName</code> é€‰é¡¹æŒ‡å®šæ„å»ºé•œåƒæ‰€ç”¨æ–‡ä»¶</p><h2 id="ç½‘ç»œ"><a href="#ç½‘ç»œ" class="headerlink" title="ç½‘ç»œ"></a>ç½‘ç»œ</h2><p>åœ¨ Linux ç³»ç»Ÿä¸­ï¼Œç½‘ç»œé…ç½®æ–‡ä»¶ç›®å½•æ˜¯<code>/etc/sysconfig/network-scripts</code>ã€‚è™šæ‹Ÿæœºå’Œä¸»æœºå®¿ä¸»æœºçš„ç½‘ç»œè¿æ¥æ–¹å¼ä¸»è¦åˆ†ä¸ºå¦‚ä¸‹ä¸‰ç§ï¼š</p><ul><li>æ¡¥æ¥æ¨¡å¼ (Bridged)</li></ul><blockquote><p>æ¡¥æ¥æ¨¡å¼ä¸‹ï¼Œè™šæ‹Ÿæœºä¸å®¿ä¸»æœºä½äºåŒä¸€ä¸ªç‰©ç†ç½‘ç»œä¸­ã€‚è™šæ‹Ÿæœºé€šè¿‡å®¿ä¸»æœºçš„ç‰©ç†ç½‘å¡ç›´æ¥è¿æ¥åˆ°ç½‘ç»œï¼Œå¹¶è·å¾—ä¸å®¿ä¸»æœºç›¸åŒç½‘æ®µçš„IPåœ°å€ã€‚è¿™ä½¿å¾—è™šæ‹Ÿæœºä¸å…¶ä»–ç½‘ç»œè®¾å¤‡å¯ä»¥ç›´æ¥è¿›è¡Œé€šä¿¡ï¼Œç±»ä¼¼äºå®ƒè‡ªå·±æ˜¯ä¸€å°ç‰©ç†æœºã€‚</p><p>å¸¸ç”¨äºéœ€è¦è™šæ‹Ÿæœºåƒç‰©ç†æœºä¸€æ ·ç›´æ¥è®¿é—®å¤–éƒ¨ç½‘ç»œçš„æƒ…å†µï¼Œå¦‚æ–‡ä»¶æœåŠ¡å™¨ã€WebæœåŠ¡å™¨ç­‰ã€‚</p></blockquote><ul><li>ç½‘ç»œåœ°å€è½¬æ¢ (NAT)</li></ul><blockquote><p>NATæ¨¡å¼ä¸‹ï¼Œè™šæ‹Ÿæœºé€šè¿‡å®¿ä¸»æœºçš„ç½‘ç»œè¿æ¥è®¿é—®å¤–éƒ¨ç½‘ç»œã€‚å®¿ä¸»æœºä¸ºè™šæ‹Ÿæœºæä¾›ä¸€ä¸ªè™šæ‹Ÿç½‘å¡ï¼Œå¹¶å°†è™šæ‹Ÿæœºçš„ç½‘ç»œè¯·æ±‚è½¬æ¢ä¸ºå®¿ä¸»æœºçš„ç½‘ç»œè¯·æ±‚ã€‚è¿™ç§æ–¹å¼ç±»ä¼¼äºè·¯ç”±å™¨å·¥ä½œåŸç†ï¼Œè™šæ‹Ÿæœºè‡ªå·±ä¸èƒ½è¢«å¤–éƒ¨ç½‘ç»œç›´æ¥è®¿é—®ï¼Œä½†å¯ä»¥è®¿é—®å¤–éƒ¨èµ„æºã€‚</p><p>å¸¸ç”¨äºéœ€è¦è™šæ‹Ÿæœºè®¿é—®å¤–éƒ¨ç½‘ç»œä½†æ— éœ€è¢«å¤–éƒ¨è®¾å¤‡è®¿é—®çš„åœºæ™¯ï¼Œæ¯”å¦‚å¼€å‘å’Œæµ‹è¯•ç¯å¢ƒã€‚</p></blockquote><ul><li>ä»…ä¸»æœºæ¨¡å¼ (Host-only)</li></ul><blockquote><p>ä»…ä¸»æœºæ¨¡å¼ä¸‹ï¼Œè™šæ‹Ÿæœºåªèƒ½ä¸å®¿ä¸»æœºè¿›è¡Œç½‘ç»œé€šä¿¡ï¼Œæ— æ³•è®¿é—®å¤–éƒ¨ç½‘ç»œã€‚è¿™ç§æ¨¡å¼åˆ›å»ºäº†ä¸€ä¸ªè™šæ‹Ÿçš„ç½‘ç»œç¯å¢ƒï¼Œè™šæ‹Ÿæœºåªèƒ½å’Œå®¿ä¸»æœºæˆ–å…¶ä»–é…ç½®ä¸ºHost-onlyæ¨¡å¼çš„è™šæ‹Ÿæœºé€šä¿¡ã€‚</p><p>é€‚ç”¨äºéœ€è¦å®Œå…¨å°é—­çš„ç½‘ç»œç¯å¢ƒï¼Œå¦‚å±€åŸŸç½‘æµ‹è¯•æˆ–è°ƒè¯•ç­‰ã€‚</p></blockquote><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰å®¹å™¨éƒ½æ˜¯ä»¥ <code>bridge</code> æ–¹å¼è¿æ¥åˆ° Docker çš„ä¸€ä¸ªè™šæ‹Ÿç½‘æ¡¥ä¸Šï¼Œå¦‚ä¸‹å›¾ï¼š</p><img src="/post/89826705/image-20241030004706881.png" class="" title="image-20241030004706881"><p>é€šè¿‡é»˜è®¤ç½‘æ¡¥è¿æ¥çš„å®¹å™¨ä¹‹é—´åªèƒ½é€šè¿‡ipäº’ç›¸è®¿é—®ï¼Œä½†æ˜¯å¦‚æœå®¹å™¨é‡å¯ï¼Œipåœ°å€å˜äº†ï¼Œç›¸å…³çš„ipé…ç½®æœªåŒæ­¥ä¿®æ”¹ï¼Œå°±ä¼šå¯¼è‡´å®¹å™¨ä¹‹é—´ä¸é€šã€‚è§£å†³åŠæ³•æ˜¯åˆ›å»ºè‡ªå®šä¹‰ç½‘ç»œï¼Œå¹¶å°†éœ€è¦äº’ç›¸è®¿é—®çš„å®¹å™¨åŠ å…¥è¯¥ç½‘ç»œï¼Œè¿™æ ·å®¹å™¨ä¹‹é—´å°±å¯ä»¥é€šè¿‡å®¹å™¨åäº’ç›¸è®¿é—®ï¼Œä¸ä¼šå—ipåœ°å€å˜åŒ–çš„å½±å“ã€‚</p><p>Dockerå¸¸ç”¨ç½‘ç»œå‘½ä»¤ï¼š</p><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>docker network ls</code></td><td>æŸ¥çœ‹æ‰€æœ‰ç½‘ç»œ</td></tr><tr><td><code>docker network create</code></td><td>åˆ›å»ºç½‘ç»œ</td></tr><tr><td><code>docker network rm</code></td><td>åˆ é™¤æŒ‡å®šç½‘ç»œ</td></tr><tr><td><code>docker network prune</code></td><td>æ¸…é™¤æœªä½¿ç”¨ç½‘ç»œ</td></tr><tr><td><code>docker network connect</code></td><td>ä½¿æŒ‡å®šå®¹å™¨åŠ å…¥ç½‘ç»œ</td></tr><tr><td><code>docker network disconnect</code></td><td>ä½¿æŒ‡å®šå®¹å™¨ç¦»å¼€ç½‘ç»œ</td></tr><tr><td><code>docker network inspect</code></td><td>æŸ¥çœ‹ç½‘ç»œè¯¦ç»†ä¿¡æ¯</td></tr></tbody></table><p>PSï¼šå®¹å™¨å¯ä»¥å…ˆå¯åŠ¨å†é€šè¿‡å‘½ä»¤ <code>docker network connect</code> åŠ å…¥æŒ‡å®šç½‘ç»œï¼Œä¹Ÿå¯ä»¥åœ¨å¯åŠ¨å®¹å™¨æ—¶é€šè¿‡é€‰é¡¹ <code>--network ç½‘ç»œå</code> ç›´æ¥åŠ å…¥æŒ‡å®šç½‘ç»œã€‚ä¸¤è€…çš„åŒºåˆ«åœ¨äºï¼šæ–¹å¼ä¸€ä¼šåŒæ—¶åŠ å…¥é»˜è®¤ç½‘ç»œdocker0å’ŒæŒ‡å®šç½‘ç»œï¼Œæ–¹å¼äºŒåªä¼šåŠ å…¥æŒ‡å®šç½‘ç»œã€‚</p><h2 id="å®æˆ˜"><a href="#å®æˆ˜" class="headerlink" title="å®æˆ˜"></a>å®æˆ˜</h2><h3 id="åˆ¶ä½œTomcaté•œåƒ"><a href="#åˆ¶ä½œTomcaté•œåƒ" class="headerlink" title="åˆ¶ä½œTomcaté•œåƒ"></a>åˆ¶ä½œ<code>Tomcat</code>é•œåƒ</h3><ul><li>ç¼–å†™ <code>Dockerfile</code></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">FROM centos</span><br><span class="line"></span><br><span class="line">MAINTAINER timewait7&lt;1029776125@qq.com&gt;</span><br><span class="line"></span><br><span class="line">ADD jdk-8u202-linux-x64.tar.gz /usr/local</span><br><span class="line">ADD apache-tomcat-9.0.94.tar.gz /usr/local</span><br><span class="line"></span><br><span class="line">ENV MYPATH /usr/local</span><br><span class="line">WORKDIR $MYPATH</span><br><span class="line"></span><br><span class="line">ENV JAVA_HOME /usr/local/jdk1.8.0_202</span><br><span class="line">ENV CLASSPATH $JAVA_HOME/lib/dt/jar $JAVA_HOME/lib/tools.jar</span><br><span class="line">ENV CATALINA_HOME /usr/local/apache-tomcat-9.0.94</span><br><span class="line">ENV CATALINA_BASE /usr/local/apache-tomcat-9.0.94</span><br><span class="line">ENV PATH $PATH:$JAVA_HOME/bin:$CATALINA_HOME/lib:$CATALINA_HOME/bin</span><br><span class="line"></span><br><span class="line">EXPOSE 8080</span><br><span class="line"></span><br><span class="line">CMD /usr/local/apache-tomcat-9.0.94/bin/startup.sh &amp;&amp; tail -F /usr/local/apache-tomcat-9.0.94/bin/logs/catalina.out</span><br></pre></td></tr></table></figure><ul><li>æ„å»ºé•œåƒ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä»¥Dockerfileä½œä¸ºæ–‡ä»¶åï¼Œæ„å»ºæ—¶ä¸éœ€è¦é€šè¿‡ -f å‚æ•°æŒ‡å®šæ–‡ä»¶</span></span><br><span class="line">docker build -t diytomcat .</span><br></pre></td></tr></table></figure><img src="/post/89826705/%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F%E8%BF%87%E7%A8%8B.png" class=""><ul><li>å¯åŠ¨é•œåƒ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 8080:8080 --name diytomcat -v /home/mount/tomcat/test:/usr/local/apache-tomcat-9.0.94/webapps/test -v /home/mount/tomcat/logs:/usr/local/apache-tomcat-9.0.94/logs diytomcat</span><br></pre></td></tr></table></figure><ul><li>æµ‹è¯•tomcat</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¾æ¬¡æ‰§è¡Œä»¥ä¸‹æ­¥éª¤</span></span><br><span class="line"><span class="built_in">cd</span> /home/mount/tomcat/test</span><br><span class="line"><span class="built_in">mkdir</span> WEB-INF</span><br><span class="line"><span class="built_in">cd</span> WEB-INF</span><br><span class="line">vi web.xml</span><br><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line">vi index.jsp</span><br></pre></td></tr></table></figure><p><code>web.xml</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">version</span>=<span class="string">&quot;2.4&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns</span>=<span class="string">&quot;http://java.sun.com/xml/ns/j2ee&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://java.sun.com/xml/ns/j2ee</span></span></span><br><span class="line"><span class="string"><span class="tag">        http://java.sun.com/xml/ns/j2ee/web-app_2_4.xsd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>index.jsp</code></p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">    &lt;meta name=<span class="string">&quot;viewport&quot;</span> content=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span><br><span class="line">    &lt;title&gt;Hello World JSP&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;h1&gt;Hello, World!&lt;/h1&gt;</span><br><span class="line">&lt;% System.out.println(<span class="string">&quot;----------logs----------&quot;</span>); %&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><img src="/post/89826705/image-20240915230103023.png" class="" title="image-20240915230103023"><img src="/post/89826705/image-20240915230216263.png" class="" title="image-20240915230216263"><h3 id="éƒ¨ç½²å‰åç«¯é¡¹ç›®"><a href="#éƒ¨ç½²å‰åç«¯é¡¹ç›®" class="headerlink" title="éƒ¨ç½²å‰åç«¯é¡¹ç›®"></a>éƒ¨ç½²å‰åç«¯é¡¹ç›®</h3><h4 id="åˆ›å»ºç½‘ç»œ"><a href="#åˆ›å»ºç½‘ç»œ" class="headerlink" title="åˆ›å»ºç½‘ç»œ"></a>åˆ›å»ºç½‘ç»œ</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªåä¸ºtestçš„ç½‘ç»œ</span></span><br><span class="line">docker network create <span class="built_in">test</span></span><br></pre></td></tr></table></figure><h4 id="åˆ›å»ºæ•°æ®åº“å®¹å™¨"><a href="#åˆ›å»ºæ•°æ®åº“å®¹å™¨" class="headerlink" title="åˆ›å»ºæ•°æ®åº“å®¹å™¨"></a>åˆ›å»ºæ•°æ®åº“å®¹å™¨</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">--name mysql \</span><br><span class="line">-p 3306:3306 \</span><br><span class="line">-e TZ=Asia/Shanghai \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=123456 \</span><br><span class="line">-v /root/mysql/data:/var/lib/mysql \</span><br><span class="line">-v /root/mysql/init:/docker-entrypoint-initdb.d \</span><br><span class="line">-v /root/mysql/conf:/etc/mysql/conf.d \</span><br><span class="line">--network <span class="built_in">test</span> \</span><br><span class="line">mysql</span><br></pre></td></tr></table></figure><h4 id="éƒ¨ç½²åç«¯åº”ç”¨"><a href="#éƒ¨ç½²åç«¯åº”ç”¨" class="headerlink" title="éƒ¨ç½²åç«¯åº”ç”¨"></a>éƒ¨ç½²åç«¯åº”ç”¨</h4><ol><li><p>å‡†å¤‡ jar åŒ…å’Œ <code>Dockerfile</code> æ–‡ä»¶ï¼Œå‡è®¾æ”¾åœ¨è™šæ‹Ÿæœºçš„ &#x2F;root ç›®å½•ä¸‹</p></li><li><p>æ„å»ºé•œåƒ</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /root</span><br><span class="line">docker built -t appname .</span><br></pre></td></tr></table></figure><ol start="3"><li>åˆ›å»ºå®¹å™¨å¹¶è¿è¡Œ</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿è¡Œå®¹å™¨å¹¶è¿æ¥ç½‘ç»œtest</span></span><br><span class="line">docker run -d --name imagename -p 8080:8080 --network <span class="built_in">test</span> appname</span><br></pre></td></tr></table></figure><h4 id="éƒ¨ç½²å‰ç«¯åº”ç”¨"><a href="#éƒ¨ç½²å‰ç«¯åº”ç”¨" class="headerlink" title="éƒ¨ç½²å‰ç«¯åº”ç”¨"></a>éƒ¨ç½²å‰ç«¯åº”ç”¨</h4><ol><li>å°†å‰ç«¯é¡¹ç›®å’Œ nginx é…ç½®æ–‡ä»¶æ”¾åœ¨ &#x2F;root&#x2F;nginx ç›®å½•ä¸‹</li><li>åˆ›å»ºå®¹å™¨å¹¶è¿è¡Œ</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">--name nginx \</span><br><span class="line">-p 18080:18080 \</span><br><span class="line">-p 18081:18081 \</span><br><span class="line">-v /root/nginx/html:/usr/share/nginx/html \</span><br><span class="line">-v /root/nginx/nginx.conf:/etc/nginx/nginx.conf \</span><br><span class="line">--network <span class="built_in">test</span> \</span><br><span class="line">nginx</span><br></pre></td></tr></table></figure><h3 id="éƒ¨ç½²Redisé›†ç¾¤"><a href="#éƒ¨ç½²Redisé›†ç¾¤" class="headerlink" title="éƒ¨ç½²Redisé›†ç¾¤"></a>éƒ¨ç½²Redisé›†ç¾¤</h3><h4 id="æ–¹å¼ä¸€"><a href="#æ–¹å¼ä¸€" class="headerlink" title="æ–¹å¼ä¸€"></a>æ–¹å¼ä¸€</h4><ul><li>åˆ›å»ºredisç½‘ç»œ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create --driver bridge --subnet 172.38.0.0/16 --gateway 172.38.0.1 redis-net</span><br></pre></td></tr></table></figure><ul><li>é›†ç¾¤é…ç½®æ–‡ä»¶è„šæœ¬</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">for port in $(seq 1 6); \</span><br><span class="line">do \</span><br><span class="line">mkdir -p /mydata/redis/node-$&#123;port&#125;/conf</span><br><span class="line">touch /mydata/redis/node-$&#123;port&#125;/conf/redis.conf</span><br><span class="line">cat &lt;&lt; EOF &gt; /mydata/redis/node-$&#123;port&#125;/conf/redis.conf</span><br><span class="line">port 6379</span><br><span class="line">bind 0.0.0.0</span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes.conf</span><br><span class="line">cluster-node-timeout 5000</span><br><span class="line">cluster-announce-ip 172.38.0.1$&#123;port&#125;</span><br><span class="line">cluster-announce-port 6379</span><br><span class="line">cluster-announce-bus-port 16379</span><br><span class="line">appendonly yes</span><br><span class="line">EOF</span><br><span class="line">done</span><br></pre></td></tr></table></figure><ul><li>å¯åŠ¨å®¹å™¨ï¼Œåˆ›å»ºé›†ç¾¤èŠ‚ç‚¹</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># node-01</span></span><br><span class="line">docker run -d -p 6371:6379 -p 16371:16379 --name redis-01 \</span><br><span class="line">-v /mydata/redis/node-1/data:/data \</span><br><span class="line">-v /mydata/redis/node-1/conf/redis.conf:/etc/redis/redis.conf \</span><br><span class="line">--net redis-net --ip 172.38.0.11 redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># node-02</span></span><br><span class="line">docker run -d -p 6372:6379 -p 16372:16379 --name redis-02 \</span><br><span class="line">-v /mydata/redis/node-2/data:/data \</span><br><span class="line">-v /mydata/redis/node-2/conf/redis.conf:/etc/redis/redis.conf \</span><br><span class="line">--net redis-net --ip 172.38.0.12 redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…¶ä»–èŠ‚ç‚¹ç±»æ¨</span></span><br></pre></td></tr></table></figure><ul><li>åˆ›å»ºé›†ç¾¤</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster create 172.38.0.11:6379 172.38.0.12:6379 172.38.0.13:6379 172.38.0.14:6379 172.38.0.15:6379 172.38.0.16:6379 --cluster-replicas 1</span><br></pre></td></tr></table></figure><img src="/post/89826705/image-20240916133527083.png" class="" title="image-20240916133527083"><ul><li>ä»¥é›†ç¾¤æ–¹å¼åˆ›å»ºrediså®¢æˆ·ç«¯</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -c</span><br></pre></td></tr></table></figure><ul><li>æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cluster info</span><br></pre></td></tr></table></figure><img src="/post/89826705/image-20240916133836873.png" class="" title="image-20240916133836873"><ul><li>æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cluster nodes</span><br></pre></td></tr></table></figure><img src="/post/89826705/image-20240916133936635.png" class="" title="image-20240916133936635"><ul><li>æµ‹è¯•é›†ç¾¤é«˜å¯ç”¨</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®¾ç½®ä¸€ä¸ªé”®å€¼å¯¹</span></span><br><span class="line"><span class="built_in">set</span> hello world</span><br></pre></td></tr></table></figure><img src="/post/89826705/image-20240916134512178.png" class="" title="image-20240916134512178"><p>åœæ‰redis-01èŠ‚ç‚¹ï¼Œredis-05è‡ªåŠ¨å‡çº§ä¸ºmaster</p><img src="/post/89826705/image-20240916134700142.png" class="" title="image-20240916134700142"><p>æ­¤æ—¶ä¾ç„¶å¯ä»¥<code>get hello</code>ä¾ç„¶å¯ä»¥æˆåŠŸè¿”å›å€¼</p><img src="/post/89826705/image-20240916135154195.png" class="" title="image-20240916135154195"><h4 id="æ–¹å¼äºŒ"><a href="#æ–¹å¼äºŒ" class="headerlink" title="æ–¹å¼äºŒ"></a>æ–¹å¼äºŒ</h4><ul><li>ç¼–å†™<code>docker-compose.yaml</code>æ–‡ä»¶</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.2&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">r1:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">r1</span></span><br><span class="line">    <span class="attr">network_mode:</span> <span class="string">&quot;host&quot;</span></span><br><span class="line">    <span class="attr">entrypoint:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;--port&quot;</span>, <span class="string">&quot;7001&quot;</span>]</span><br><span class="line">  <span class="attr">r2:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">r2</span></span><br><span class="line">    <span class="attr">network_mode:</span> <span class="string">&quot;host&quot;</span></span><br><span class="line">    <span class="attr">entrypoint:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;--port&quot;</span>, <span class="string">&quot;7002&quot;</span>]</span><br><span class="line">  <span class="attr">r3:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">r3</span></span><br><span class="line">    <span class="attr">network_mode:</span> <span class="string">&quot;host&quot;</span></span><br><span class="line">    <span class="attr">entrypoint:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;--port&quot;</span>, <span class="string">&quot;7003&quot;</span>]</span><br></pre></td></tr></table></figure><ul><li>å¯åŠ¨å®¹å™¨</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker compose up -d</span><br></pre></td></tr></table></figure><ul><li>é…ç½®ä¸»ä»å…³ç³»</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ docker <span class="built_in">exec</span> -it r2 redis-cli -p 7002</span><br><span class="line">$ slaveof è™šæ‹Ÿæœºip 7001</span><br><span class="line"></span><br><span class="line">$ docker <span class="built_in">exec</span> -it r2 redis-cli -p 7003</span><br><span class="line">$ slaveof è™šæ‹Ÿæœºip 7001</span><br></pre></td></tr></table></figure><ul><li>æµ‹è¯•</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">$ docker <span class="built_in">exec</span> -it r1 redis-cli -p 7001</span><br><span class="line">$ info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:2</span><br><span class="line">slave0:ip=192.168.33.11,port=7002,state=online,offset=2165,lag=1</span><br><span class="line">slave1:ip=192.168.33.11,port=7003,state=online,offset=2165,lag=1</span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:f7b8c1f916ecc6e3ab6fcba7d73c1f115a880cb6</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:2165</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1</span><br><span class="line">repl_backlog_histlen:2165</span><br><span class="line">$ <span class="built_in">set</span> num 123</span><br><span class="line">$ get num</span><br><span class="line"><span class="string">&quot;123&quot;</span></span><br><span class="line"></span><br><span class="line">$ docker <span class="built_in">exec</span> -it r2 redis-cli -p 7002</span><br><span class="line">$ info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:slave</span><br><span class="line">master_host:192.168.33.11</span><br><span class="line">master_port:7001</span><br><span class="line">master_link_status:up</span><br><span class="line">master_last_io_seconds_ago:6</span><br><span class="line">master_sync_in_progress:0</span><br><span class="line">slave_read_repl_offset:2249</span><br><span class="line">slave_repl_offset:2249</span><br><span class="line">slave_priority:100</span><br><span class="line">slave_read_only:1</span><br><span class="line">replica_announced:1</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:f7b8c1f916ecc6e3ab6fcba7d73c1f115a880cb6</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:2249</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:15</span><br><span class="line">repl_backlog_histlen:2235</span><br><span class="line">$ <span class="built_in">set</span> num 456</span><br><span class="line">(error) READONLY You can<span class="string">&#x27;t write against a read only replica.</span></span><br><span class="line"><span class="string">$ get num</span></span><br><span class="line"><span class="string">&quot;123&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ docker exec -it r3 redis-cli -p 7003</span></span><br><span class="line"><span class="string"># Replication</span></span><br><span class="line"><span class="string">role:slave</span></span><br><span class="line"><span class="string">master_host:192.168.33.11</span></span><br><span class="line"><span class="string">master_port:7001</span></span><br><span class="line"><span class="string">master_link_status:up</span></span><br><span class="line"><span class="string">master_last_io_seconds_ago:1</span></span><br><span class="line"><span class="string">master_sync_in_progress:0</span></span><br><span class="line"><span class="string">slave_read_repl_offset:2417</span></span><br><span class="line"><span class="string">slave_repl_offset:2417</span></span><br><span class="line"><span class="string">slave_priority:100</span></span><br><span class="line"><span class="string">slave_read_only:1</span></span><br><span class="line"><span class="string">replica_announced:1</span></span><br><span class="line"><span class="string">connected_slaves:0</span></span><br><span class="line"><span class="string">master_failover_state:no-failover</span></span><br><span class="line"><span class="string">master_replid:f7b8c1f916ecc6e3ab6fcba7d73c1f115a880cb6</span></span><br><span class="line"><span class="string">master_replid2:0000000000000000000000000000000000000000</span></span><br><span class="line"><span class="string">master_repl_offset:2417</span></span><br><span class="line"><span class="string">second_repl_offset:-1</span></span><br><span class="line"><span class="string">repl_backlog_active:1</span></span><br><span class="line"><span class="string">repl_backlog_size:1048576</span></span><br><span class="line"><span class="string">repl_backlog_first_byte_offset:113</span></span><br><span class="line"><span class="string">repl_backlog_histlen:2305</span></span><br><span class="line"><span class="string">$ set num 789</span></span><br><span class="line"><span class="string">(error) READONLY You can&#x27;</span>t write against a <span class="built_in">read</span> only replica.</span><br><span class="line">$ get num</span><br><span class="line"><span class="string">&quot;123&quot;</span></span><br></pre></td></tr></table></figure><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      <categories>
          
          <category> DevOps </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Vagrantä½¿ç”¨å…¥é—¨</title>
      <link href="/post/f8d4142b.html"/>
      <url>/post/f8d4142b.html</url>
      
        <content type="html"><![CDATA[<h2 id="åˆ›å»ºè™šæ‹Ÿæœº"><a href="#åˆ›å»ºè™šæ‹Ÿæœº" class="headerlink" title="åˆ›å»ºè™šæ‹Ÿæœº"></a>åˆ›å»ºè™šæ‹Ÿæœº</h2><ul><li>å®‰è£…Vagrant</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">brew tap hashicorp/tap</span><br><span class="line">brew install hashicorp/tap/hashicorp-vagrant</span><br></pre></td></tr></table></figure><ul><li>åˆå§‹åŒ–è™šæ‹Ÿæœº</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä»…åˆ›å»ºä¸€ä¸ªVagrantfile</span></span><br><span class="line"><span class="built_in">mkdir</span> vm</span><br><span class="line"><span class="built_in">cd</span> vm</span><br><span class="line">vagrant init centos/7</span><br></pre></td></tr></table></figure><ul><li>å¯åŠ¨è™šæ‹Ÿæœº</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿™ä¸€æ­¥æ‰æ˜¯æ‹‰å–å¹¶å¯åŠ¨é•œåƒ</span></span><br><span class="line">vagrant up</span><br></pre></td></tr></table></figure><ul><li>è¿æ¥è™šæ‹Ÿæœº</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant ssh</span><br></pre></td></tr></table></figure><h2 id="å®‰è£…docker"><a href="#å®‰è£…docker" class="headerlink" title="å®‰è£…docker"></a>å®‰è£…docker</h2><ul><li>å¸è½½æ—§ç‰ˆdocker</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo yum remove docker \</span><br><span class="line">                  docker-client \</span><br><span class="line">                  docker-client-latest \</span><br><span class="line">                  docker-common \</span><br><span class="line">                  docker-latest \</span><br><span class="line">                  docker-latest-logrotate \</span><br><span class="line">                  docker-logrotate \</span><br><span class="line">                  docker-engine</span><br></pre></td></tr></table></figure><ul><li>å®‰è£…yum-utilså¹¶è®¾ç½®dockerä»“åº“</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y yum-utils</span><br><span class="line">sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure><ul><li><p>å®‰è£…docker</p><ul><li><p>å®‰è£…æœ€æ–°ç‰ˆ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</span><br></pre></td></tr></table></figure></li><li><p>å®‰è£…æŒ‡å®šç‰ˆæœ¬</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹dockerç‰ˆæœ¬</span></span><br><span class="line">yum list docker-ce --showduplicates | <span class="built_in">sort</span> -r</span><br><span class="line"></span><br><span class="line">docker-ce.x86_64    3:27.1.1-1.el9    docker-ce-stable</span><br><span class="line">docker-ce.x86_64    3:27.1.0-1.el9    docker-ce-stable</span><br><span class="line">&lt;...&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…æŒ‡å®šç‰ˆæœ¬</span></span><br><span class="line">sudo yum install docker-ce-&lt;VERSION_STRING&gt; docker-ce-cli-&lt;VERSION_STRING&gt; containerd.io docker-buildx-plugin docker-compose-plugin</span><br></pre></td></tr></table></figure></li></ul></li><li><p>å¯åŠ¨docker</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®å¼€æœºé»˜è®¤å¯åŠ¨</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®å®¹å™¨è‡ªåŠ¨å¯åŠ¨</span></span><br><span class="line">docker run -d --restart=always --name å®¹å™¨åç§° é•œåƒ</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹å®¹å™¨è‡ªåŠ¨å¯åŠ¨</span></span><br><span class="line">docker update --restart=always å®¹å™¨ID</span><br></pre></td></tr></table></figure><h2 id="ç«¯å£è½¬å‘"><a href="#ç«¯å£è½¬å‘" class="headerlink" title="ç«¯å£è½¬å‘"></a>ç«¯å£è½¬å‘</h2><p>å‡è®¾åœ¨è™šæ‹Ÿæœºä¸­å¯åŠ¨äº†ä¸€ä¸ªtomcaté•œåƒï¼Œè¦æƒ³åœ¨å®¿ä¸»æœºä¸­çš„è®¿é—®è¯¥tomcatï¼Œéœ€é…ç½®ç«¯å£è½¬å‘ã€‚æ‰“å¼€Vagrantfileï¼ŒæŒ‰å¦‚ä¸‹ä¿®æ”¹é…ç½®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config.vm.network &quot;forwarded_port&quot;, guest: 8080, host: 8080</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹å®ŒVagrantfileåï¼Œéœ€é‡å¯è™šæ‹Ÿæœº</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant reload</span><br></pre></td></tr></table></figure><h2 id="Tabbyè¿æ¥è™šæ‹Ÿæœº"><a href="#Tabbyè¿æ¥è™šæ‹Ÿæœº" class="headerlink" title="Tabbyè¿æ¥è™šæ‹Ÿæœº"></a>Tabbyè¿æ¥è™šæ‹Ÿæœº</h2><p>Tabbyæ˜¯ä¸€ä¸ªç±»ç»ˆç«¯çš„sshå®¢æˆ·ç«¯ï¼Œä½¿ç”¨Tabbyè¿æ¥åˆ°è™šæ‹Ÿæœºåï¼Œå¯ä»¥å‘è™šæ‹Ÿæœºä¸Šä¼ æ–‡ä»¶ã€‚æ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li>è·å–è™šæ‹Ÿæœºçš„SSHä¿¡æ¯</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿›å…¥Vagrantfileæ‰€åœ¨ç›®å½•</span></span><br><span class="line">vagrant ssh-config</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œä¸Šè¿°å‘½ä»¤ï¼Œå°†å¾—åˆ°è¿æ¥è™šæ‹Ÿæœºæ‰€éœ€çš„sshä¿¡æ¯ï¼š</span></span><br><span class="line">Host default</span><br><span class="line">  HostName 127.0.0.1</span><br><span class="line">  User vagrant</span><br><span class="line">  Port 2222</span><br><span class="line">  IdentityFile /path/to/private_key</span><br></pre></td></tr></table></figure><ol start="2"><li>é…ç½®Tabbyè¿æ¥</li></ol><blockquote><p>åœ¨ Tabby ä¸­ï¼Œç‚¹å‡» <code>Profiles</code> -&gt; <code>New Profile</code>ã€‚</p><p>åœ¨ <code>Connection</code> é€‰é¡¹å¡ä¸­è®¾ç½®ä»¥ä¸‹ä¿¡æ¯ï¼š</p><ul><li><strong>Host:</strong> <code>127.0.0.1</code> ï¼ˆä» <code>vagrant ssh-config</code> ä¸­è·å–çš„ <code>HostName</code>ï¼‰</li><li><strong>Port:</strong> <code>2222</code> ï¼ˆä» <code>vagrant ssh-config</code> ä¸­è·å–çš„ <code>Port</code>ï¼‰</li><li><strong>User:</strong> <code>vagrant</code> ï¼ˆä» <code>vagrant ssh-config</code> ä¸­è·å–çš„ <code>User</code>ï¼‰</li><li><strong>Private Key</strong>: é€‰æ‹© <code>IdentityFile</code> çš„è·¯å¾„ï¼ˆä» <code>vagrant ssh-config</code> ä¸­è·å–çš„ <code>/path/to/private_key</code>ï¼‰ã€‚</li></ul></blockquote><img src="/post/f8d4142b/Tabby%E8%BF%9E%E6%8E%A5%E8%99%9A%E6%8B%9F%E6%9C%BA.png" class=""><ol start="3"><li><p>ä¸Šä¼ æ–‡ä»¶</p><p>å¦‚æœä»¥ä¸‹ä¸¤ç§æ–¹å¼ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ³¨æ„vagrantå¯¹è™šæ‹Ÿæœºä¸­çš„ç›®çš„è·¯å¾„æ˜¯å¦æœ‰å†™æƒé™ï¼Œå¦‚æœæ²¡æœ‰ï¼Œéœ€è¦ç”¨chmodå’Œchownå‘½ä»¤ä¿®æ”¹æ–‡ä»¶çš„å±æ€§ä»¥è·å¾—å†™æƒé™ã€‚</p><ul><li><p>å›¾å½¢ç•Œé¢åŒ–æ–¹å¼</p><img src="/post/f8d4142b/Tabby%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6%E5%88%B0%E8%99%9A%E6%8B%9F%E6%9C%BA.png" class=""></li><li><p>å‘½ä»¤è¡Œæ–¹å¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /path/to/private_key è¿æ¥è™šæ‹Ÿæœºçš„sshä¿¡æ¯ä¸­çš„IdentityFile</span></span><br><span class="line"><span class="comment"># /Users/yourname/Documents/example.txt å®¿ä¸»æœºæ–‡ä»¶è·¯å¾„</span></span><br><span class="line">scp -i /path/to/private_key -P 2222 /Users/yourname/Documents/example.txt vagrant@127.0.0.1:/home/vagrant/</span><br></pre></td></tr></table></figure><p>PSï¼šè¯¥å‘½ä»¤åœ¨å®¿ä¸»æœºå‘½ä»¤è¡Œç»ˆç«¯ä¸­æ‰§è¡Œ</p></li></ul></li></ol><h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><h3 id="é—®é¢˜1"><a href="#é—®é¢˜1" class="headerlink" title="é—®é¢˜1"></a>é—®é¢˜1</h3><img src="/post/f8d4142b/image-20241027114900897.png" class="" title="image-20241027114900897"><p>è§£å†³æ–¹æ³•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">su root</span><br><span class="line">sed -i <span class="string">&#x27;s/mirrorlist/#mirrorlist/g&#x27;</span> /etc/yum.repos.d/CentOS-*</span><br><span class="line">sed -i <span class="string">&#x27;s|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g&#x27;</span> /etc/yum.repos.d/CentOS-*</span><br></pre></td></tr></table></figure><h3 id="é—®é¢˜2"><a href="#é—®é¢˜2" class="headerlink" title="é—®é¢˜2"></a>é—®é¢˜2</h3><img src="/post/f8d4142b/image-20241027115202371.png" class="" title="image-20241027115202371"><p>è§£å†³æ–¹æ³•ï¼šä½¿ç”¨é˜¿é‡Œäº‘é•œåƒ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure><h3 id="é—®é¢˜3"><a href="#é—®é¢˜3" class="headerlink" title="é—®é¢˜3"></a>é—®é¢˜3</h3><img src="/post/f8d4142b/image-20241027135816837.png" class="" title="image-20241027135816837"><p>è§£å†³æ–¹æ³•ï¼šæ·»åŠ é•œåƒ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;https://xxx.mirror.aliyuncs.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://docker.mirrors.ustc.edu.cn&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://docker.m.daocloud.io&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://dockerproxy.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://docker.nju.edu.cn&quot;</span>,</span><br><span class="line">        <span class="string">&quot;http://hammal.staronearth.win/&quot;</span>,</span><br><span class="line">        <span class="string">&quot;http://hub.staronearth.win/&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      <categories>
          
          <category> DevOps </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Vagrant </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>build you own X</title>
      <link href="/post/eb09633c.html"/>
      <url>/post/eb09633c.html</url>
      
        <content type="html"><![CDATA[<h2 id="ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼"><a href="#ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼" class="headerlink" title="ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼"></a>ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼</h2><h2 id="wait-notify"><a href="#wait-notify" class="headerlink" title="wait/notify"></a><code>wait/notify</code></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Buffer</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="type">int</span> data;</span><br><span class="line">  <span class="keyword">private</span> <span class="type">boolean</span> empty;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">Buffer</span><span class="params">()</span> &#123;</span><br><span class="line">      empty = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç”Ÿäº§æ•°æ®</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">produce</span><span class="params">(<span class="type">int</span> newData)</span> &#123;</span><br><span class="line">      <span class="keyword">while</span> (!empty) &#123; <span class="comment">// å¦‚æœç¼“å†²åŒºä¸ä¸ºç©ºï¼Œåˆ™ç­‰å¾…</span></span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              wait();</span><br><span class="line">          &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">              e.printStackTrace();</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      data = newData; <span class="comment">// æ”¾å…¥æ•°æ®</span></span><br><span class="line">      empty = <span class="literal">false</span>; <span class="comment">// æ ‡è®°ç¼“å†²åŒºä¸ä¸ºç©º</span></span><br><span class="line">      notify(); <span class="comment">// é€šçŸ¥æ¶ˆè´¹è€…å¯ä»¥æ¶ˆè´¹æ•°æ®</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ¶ˆè´¹æ•°æ®</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">int</span> <span class="title function_">consume</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">while</span> (empty) &#123; <span class="comment">// å¦‚æœç¼“å†²åŒºä¸ºç©ºï¼Œåˆ™ç­‰å¾…</span></span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              wait();</span><br><span class="line">          &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">              e.printStackTrace();</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="type">int</span> <span class="variable">consumedData</span> <span class="operator">=</span> data; <span class="comment">// å–å‡ºæ•°æ®</span></span><br><span class="line">      empty = <span class="literal">true</span>; <span class="comment">// æ ‡è®°ç¼“å†²åŒºä¸ºç©º</span></span><br><span class="line">      notify(); <span class="comment">// é€šçŸ¥ç”Ÿäº§è€…å¯ä»¥ç”Ÿäº§æ•°æ®</span></span><br><span class="line">      <span class="keyword">return</span> consumedData;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Producer</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> Buffer buffer;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">Producer</span><span class="params">(Buffer buffer)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.buffer = buffer;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">10</span>; i++) &#123;</span><br><span class="line">          buffer.produce(i);</span><br><span class="line">          System.out.println(<span class="string">&quot;ç”Ÿäº§è€…ç”Ÿäº§äº†æ•°æ®: &quot;</span> + i);</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              Thread.sleep(<span class="number">1000</span>); <span class="comment">// æ¨¡æ‹Ÿç”Ÿäº§è€…ç”Ÿäº§æ•°æ®çš„è€—æ—¶æ“ä½œ</span></span><br><span class="line">          &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">              e.printStackTrace();</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Consumer</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> Buffer buffer;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">Consumer</span><span class="params">(Buffer buffer)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.buffer = buffer;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">10</span>; i++) &#123;</span><br><span class="line">          <span class="type">int</span> <span class="variable">consumedData</span> <span class="operator">=</span> buffer.consume();</span><br><span class="line">          System.out.println(<span class="string">&quot;æ¶ˆè´¹è€…æ¶ˆè´¹äº†æ•°æ®: &quot;</span> + consumedData);</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              Thread.sleep(<span class="number">1500</span>); <span class="comment">// æ¨¡æ‹Ÿæ¶ˆè´¹è€…æ¶ˆè´¹æ•°æ®çš„è€—æ—¶æ“ä½œ</span></span><br><span class="line">          &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">              e.printStackTrace();</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">      <span class="type">Buffer</span> <span class="variable">buffer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Buffer</span>();</span><br><span class="line">      <span class="type">Producer</span> <span class="variable">producer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Producer</span>(buffer);</span><br><span class="line">      <span class="type">Consumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Consumer</span>(buffer);</span><br><span class="line"></span><br><span class="line">      <span class="type">Thread</span> <span class="variable">producerThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(producer);</span><br><span class="line">      <span class="type">Thread</span> <span class="variable">consumerThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(consumer);</span><br><span class="line"></span><br><span class="line">      producerThread.start();</span><br><span class="line">      consumerThread.start();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="await-signal"><a href="#await-signal" class="headerlink" title="await/signal"></a><code>await/signal</code></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.Queue;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Condition;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Buffer</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> Queue&lt;Integer&gt; queue = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">  <span class="keyword">private</span> <span class="type">int</span> <span class="variable">maxSize</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="type">Lock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">  <span class="keyword">private</span> <span class="type">Condition</span> <span class="variable">notEmpty</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line">  <span class="keyword">private</span> <span class="type">Condition</span> <span class="variable">notFull</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">produce</span><span class="params">(<span class="type">int</span> num)</span> &#123;</span><br><span class="line">      lock.lock();</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">while</span> (queue.size() == maxSize) &#123;</span><br><span class="line">              <span class="comment">// ç¼“å†²åŒºå·²æ»¡ï¼Œç”Ÿäº§è€…ç­‰å¾…</span></span><br><span class="line">              notFull.await();</span><br><span class="line">          &#125;</span><br><span class="line">          queue.add(num);</span><br><span class="line">          System.out.println(<span class="string">&quot;Produced: &quot;</span> + num);</span><br><span class="line">          notEmpty.signal(); <span class="comment">// é€šçŸ¥æ¶ˆè´¹è€…ç¼“å†²åŒºä¸ä¸ºç©º</span></span><br><span class="line">      &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">          e.printStackTrace();</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          lock.unlock();</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">consume</span><span class="params">()</span> &#123;</span><br><span class="line">      lock.lock();</span><br><span class="line">      <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">while</span> (queue.isEmpty()) &#123;</span><br><span class="line">              <span class="comment">// ç¼“å†²åŒºä¸ºç©ºï¼Œæ¶ˆè´¹è€…ç­‰å¾…</span></span><br><span class="line">              notEmpty.await();</span><br><span class="line">          &#125;</span><br><span class="line">          num = queue.poll();</span><br><span class="line">          System.out.println(<span class="string">&quot;Consumed: &quot;</span> + num);</span><br><span class="line">          notFull.signal(); <span class="comment">// é€šçŸ¥ç”Ÿäº§è€…ç¼“å†²åŒºä¸æ»¡</span></span><br><span class="line">      &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">          e.printStackTrace();</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          lock.unlock();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> num;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ç®¡é“"><a href="#ç®¡é“" class="headerlink" title="ç®¡é“"></a>ç®¡é“</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.PipedInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.PipedOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProducerConsumerExample</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">      <span class="type">PipedInputStream</span> <span class="variable">pipedInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PipedInputStream</span>();</span><br><span class="line">      <span class="type">PipedOutputStream</span> <span class="variable">pipedOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PipedOutputStream</span>();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å°†ç®¡é“è¾“å…¥æµå’Œç®¡é“è¾“å‡ºæµå…³è”èµ·æ¥</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          pipedInputStream.connect(pipedOutputStream);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">          e.printStackTrace();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// åˆ›å»ºç”Ÿäº§è€…çº¿ç¨‹å’Œæ¶ˆè´¹è€…çº¿ç¨‹</span></span><br><span class="line">      <span class="type">Thread</span> <span class="variable">producerThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Producer</span>(pipedOutputStream));</span><br><span class="line">      <span class="type">Thread</span> <span class="variable">consumerThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Consumer</span>(pipedInputStream));</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å¯åŠ¨ç”Ÿäº§è€…çº¿ç¨‹å’Œæ¶ˆè´¹è€…çº¿ç¨‹</span></span><br><span class="line">      producerThread.start();</span><br><span class="line">      consumerThread.start();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Producer</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">      <span class="keyword">private</span> PipedOutputStream pipedOutputStream;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">public</span> <span class="title function_">Producer</span><span class="params">(PipedOutputStream pipedOutputStream)</span> &#123;</span><br><span class="line">          <span class="built_in">this</span>.pipedOutputStream = pipedOutputStream;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="comment">// ç”Ÿäº§è€…å‘ç®¡é“å†™å…¥æ•°æ®</span></span><br><span class="line">              <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">10</span>; i++) &#123;</span><br><span class="line">                  <span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> <span class="string">&quot;Data &quot;</span> + i;</span><br><span class="line">                  pipedOutputStream.write(data.getBytes());</span><br><span class="line">                  System.out.println(<span class="string">&quot;Produced: &quot;</span> + data);</span><br><span class="line">              &#125;</span><br><span class="line">              pipedOutputStream.close();</span><br><span class="line">          &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">              e.printStackTrace();</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Consumer</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">      <span class="keyword">private</span> PipedInputStream pipedInputStream;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">public</span> <span class="title function_">Consumer</span><span class="params">(PipedInputStream pipedInputStream)</span> &#123;</span><br><span class="line">          <span class="built_in">this</span>.pipedInputStream = pipedInputStream;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="comment">// æ¶ˆè´¹è€…ä»ç®¡é“è¯»å–æ•°æ®</span></span><br><span class="line">              <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">              <span class="type">int</span> bytesRead;</span><br><span class="line">              <span class="keyword">while</span> ((bytesRead = pipedInputStream.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                  <span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(buffer, <span class="number">0</span>, bytesRead);</span><br><span class="line">                  System.out.println(<span class="string">&quot;Consumed: &quot;</span> + data);</span><br><span class="line">              &#125;</span><br><span class="line">              pipedInputStream.close();</span><br><span class="line">          &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">              e.printStackTrace();</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="é˜»å¡é˜Ÿåˆ—"><a href="#é˜»å¡é˜Ÿåˆ—" class="headerlink" title="é˜»å¡é˜Ÿåˆ—"></a>é˜»å¡é˜Ÿåˆ—</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.ArrayBlockingQueue;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.BlockingQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProducerConsumerExample</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">      <span class="comment">// åˆ›å»ºä¸€ä¸ªå®¹é‡ä¸º10çš„é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line">      BlockingQueue&lt;String&gt; blockingQueue = <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// åˆ›å»ºç”Ÿäº§è€…çº¿ç¨‹å’Œæ¶ˆè´¹è€…çº¿ç¨‹</span></span><br><span class="line">      <span class="type">Thread</span> <span class="variable">producerThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Producer</span>(blockingQueue));</span><br><span class="line">      <span class="type">Thread</span> <span class="variable">consumerThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Consumer</span>(blockingQueue));</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å¯åŠ¨ç”Ÿäº§è€…çº¿ç¨‹å’Œæ¶ˆè´¹è€…çº¿ç¨‹</span></span><br><span class="line">      producerThread.start();</span><br><span class="line">      consumerThread.start();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Producer</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">      <span class="keyword">private</span> BlockingQueue&lt;String&gt; blockingQueue;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">public</span> <span class="title function_">Producer</span><span class="params">(BlockingQueue&lt;String&gt; blockingQueue)</span> &#123;</span><br><span class="line">          <span class="built_in">this</span>.blockingQueue = blockingQueue;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="comment">// ç”Ÿäº§è€…å‘é˜»å¡é˜Ÿåˆ—æ·»åŠ æ•°æ®</span></span><br><span class="line">              <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">10</span>; i++) &#123;</span><br><span class="line">                  <span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> <span class="string">&quot;Data &quot;</span> + i;</span><br><span class="line">                  blockingQueue.put(data);</span><br><span class="line">                  System.out.println(<span class="string">&quot;Produced: &quot;</span> + data);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">              e.printStackTrace();</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Consumer</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">      <span class="keyword">private</span> BlockingQueue&lt;String&gt; blockingQueue;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">public</span> <span class="title function_">Consumer</span><span class="params">(BlockingQueue&lt;String&gt; blockingQueue)</span> &#123;</span><br><span class="line">          <span class="built_in">this</span>.blockingQueue = blockingQueue;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="comment">// æ¶ˆè´¹è€…ä»é˜»å¡é˜Ÿåˆ—å–å‡ºæ•°æ®</span></span><br><span class="line">              <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                  <span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> blockingQueue.take();</span><br><span class="line">                  System.out.println(<span class="string">&quot;Consumed: &quot;</span> + data);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">              e.printStackTrace();</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="semaphore"><a href="#semaphore" class="headerlink" title="semaphore"></a><code>semaphore</code></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.Semaphore;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProducerConsumerExample</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">      <span class="comment">// åˆ›å»ºä¸€ä¸ªåˆå§‹è®¡æ•°ä¸º0çš„ Semaphoreï¼Œç”¨äºæ§åˆ¶ç”Ÿäº§è€…çº¿ç¨‹çš„è®¿é—®</span></span><br><span class="line">      <span class="type">Semaphore</span> <span class="variable">producerSemaphore</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Semaphore</span>(<span class="number">0</span>);</span><br><span class="line">      <span class="comment">// åˆ›å»ºä¸€ä¸ªåˆå§‹è®¡æ•°ä¸º1çš„ Semaphoreï¼Œç”¨äºæ§åˆ¶æ¶ˆè´¹è€…çº¿ç¨‹çš„è®¿é—®</span></span><br><span class="line">      <span class="type">Semaphore</span> <span class="variable">consumerSemaphore</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Semaphore</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// åˆ›å»ºç”Ÿäº§è€…çº¿ç¨‹å’Œæ¶ˆè´¹è€…çº¿ç¨‹</span></span><br><span class="line">      <span class="type">Thread</span> <span class="variable">producerThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Producer</span>(producerSemaphore, consumerSemaphore));</span><br><span class="line">      <span class="type">Thread</span> <span class="variable">consumerThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Consumer</span>(producerSemaphore, consumerSemaphore));</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å¯åŠ¨ç”Ÿäº§è€…çº¿ç¨‹å’Œæ¶ˆè´¹è€…çº¿ç¨‹</span></span><br><span class="line">      producerThread.start();</span><br><span class="line">      consumerThread.start();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Producer</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">      <span class="keyword">private</span> Semaphore producerSemaphore;</span><br><span class="line">      <span class="keyword">private</span> Semaphore consumerSemaphore;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">public</span> <span class="title function_">Producer</span><span class="params">(Semaphore producerSemaphore, Semaphore consumerSemaphore)</span> &#123;</span><br><span class="line">          <span class="built_in">this</span>.producerSemaphore = producerSemaphore;</span><br><span class="line">          <span class="built_in">this</span>.consumerSemaphore = consumerSemaphore;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="comment">// ç”Ÿäº§è€…çº¿ç¨‹ç”Ÿäº§æ•°æ®</span></span><br><span class="line">              <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">10</span>; i++) &#123;</span><br><span class="line">                  Thread.sleep(<span class="number">1000</span>); <span class="comment">// æ¨¡æ‹Ÿç”Ÿäº§è€—æ—¶</span></span><br><span class="line">                  System.out.println(<span class="string">&quot;Produced: Data &quot;</span> + i);</span><br><span class="line">                  producerSemaphore.release(); <span class="comment">// å¢åŠ  producerSemaphore çš„è®¡æ•°</span></span><br><span class="line">                  consumerSemaphore.acquire(); <span class="comment">// è·å– consumerSemaphore çš„è®¸å¯</span></span><br><span class="line">              &#125;</span><br><span class="line">          &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">              e.printStackTrace();</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Consumer</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">      <span class="keyword">private</span> Semaphore producerSemaphore;</span><br><span class="line">      <span class="keyword">private</span> Semaphore consumerSemaphore;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">public</span> <span class="title function_">Consumer</span><span class="params">(Semaphore producerSemaphore, Semaphore consumerSemaphore)</span> &#123;</span><br><span class="line">          <span class="built_in">this</span>.producerSemaphore = producerSemaphore;</span><br><span class="line">          <span class="built_in">this</span>.consumerSemaphore = consumerSemaphore;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="comment">// æ¶ˆè´¹è€…çº¿ç¨‹æ¶ˆè´¹æ•°æ®</span></span><br><span class="line">              <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">10</span>; i++) &#123;</span><br><span class="line">                  consumerSemaphore.acquire(); <span class="comment">// è·å– consumerSemaphore çš„è®¸å¯</span></span><br><span class="line">                  Thread.sleep(<span class="number">1000</span>); <span class="comment">// æ¨¡æ‹Ÿæ¶ˆè´¹è€—æ—¶</span></span><br><span class="line">                  System.out.println(<span class="string">&quot;Consumed: Data &quot;</span> + i);</span><br><span class="line">                  producerSemaphore.release(); <span class="comment">// å¢åŠ  producerSemaphore çš„è®¡æ•°</span></span><br><span class="line">              &#125;</span><br><span class="line">          &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">              e.printStackTrace();</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
